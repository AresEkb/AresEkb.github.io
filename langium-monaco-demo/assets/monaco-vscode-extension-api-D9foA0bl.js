import{c as ee,S as q,l9 as el,an as gt,_ as L,o as E,ab as Qh,V as be,am as Ws,F as Hi,aj as on,aa as Pe,aT as Jh,aF as ud,aG as Xh,t as B,mM as fi,aP as re,vf as Yh,W as ai,l6 as ge,r$ as Zh,h as N,a5 as P,aX as tl,a_ as ef,vg as Fi,vh as tf,cr as mt,U as v,k as il,m as oa,m6 as hd,b as Te,l as J,bK as sl,aO as ue,o5 as _r,n3 as ze,b4 as sf,az as rf,aN as nf,n4 as of,nq as fd,d_ as af,cS as df,ak as aa,dV as cf,lV as Bs,kX as je,vi as lf,os as uf,M as rl,nl as b,dg as pd,lM as Vs,cY as hf,X as Ar,dZ as ff,cX as De,T as an,Z as xi,dp as Ft,D as X,ob as bi,vj as pf,cc as nl,vk as gf,vl as gd,nm as md,vm as mf,jE as di,bg as Qi,bs as vr,qW as ol,ec as it,kV as is,cT as _f,vn as vf,vo as Me,dX as da,vp as al,rB as yf,b7 as wf,lO as ca,vq as Rt,jL as zs,br as Ye,f3 as Li,aJ as qs,B as Ji,aZ as At,l5 as xe,C as he,ae as xf,o4 as dn,vr as cn,vs as we,A as _d,vt as bf,tj as Ef,pQ as Sf,a as js,cZ as Lt,vu as vd,cz as dl,a1 as Ks,E as Ee,sn as la,ny as Gs,bn as ua,oy as Cf,kW as ss,ox as ln,vv as Df,o7 as yd,I as ha,nJ as Ct,hN as cl,ac as We,bt as fa,vw as Qs,vx as un,be as si,aS as Js,n6 as te,oh as wd,vy as Pf,vz as Tf,o$ as ll,nH as kf,nG as If,vA as Rf,aU as hn,gf as Zt,aK as ul,gB as Af,i7 as xd,Q as $f,w as Re,ih as rs,vB as Mf,bG as fn,L as ki,cR as Hf,n8 as Ff,j as Lf,l1 as bd,n7 as pn,mK as Nf,hs as gn,df as Of,vC as Uf,aR as ut,oC as hl,ls as oe,lt as ae,vD as Wf,vE as Bf,cG as Ed,vF as Vf,vG as fl,vH as zf,p7 as pa,mh as qf,mj as jf,vI as Kf,bm as pl,kT as gl,ee as ht,tb as hs,sc as $r,sh as Mr,a6 as ml,vJ as Gf,bT as Qf,fi as Jf,bk as Xf,vK as Yf,vL as Zf,lv as _l,aQ as Hr,vM as ot,fC as ep,vN as tp,vO as ip,vP as mn,bI as sp,ap as at,vQ as rp,vR as qt,nw as np,u4 as Sd,dr as op,nh as Fr,oI as Cd,tS as Dd,vS as ap,c$ as Pd,hc as dp,bw as cp,vT as lp,mm as up,vU as Td,vV as kd,tA as Id,x as Rd,z as Ad,vW as $d,al as Md,bH as hp,aw as fp,vX as pp,jD as vl,vY as gp,lE as yl,vZ as Es,s6 as mp,J as _p,ff as vp,y as Ei,v_ as yp,gT as wp,sk as xp,dx as bp,q6 as Hd,ei as Ep,v$ as Sp,w0 as Cp}from"./monaco-vscode-base-service-override-BYqBQsid.js";import{I as j,M as k,F as ve,a as Se,O as Lr,E as Pt,G as Ss,r as Fd,T as _t,R as de,b as ga,D as V,c as _n,C as Cs,d as Dp,e as Pp,f as Tp,h as Ds,i as $,j as ma,k as kp,l as ns,m as ne,n as Xi,o as Ip,p as ce,U as vn,P as Fe,q as Z,S as ci,s as et,t as wl,u as _a,v as xl,x as Ni,y as bl,z as Rp,A as Ke,B as tt,L as li,N as yr,H as bt,J as Yi,K as Ap,V as ye,Q as El,W as $p,X as Mp,Y as Sl,Z as Ps,_ as Hp,$ as Xs,a0 as Fp,a1 as Ld,a2 as Lp,a3 as Np,a4 as Ts,a5 as va,a6 as Ys,a7 as Zs,a8 as Cl,a9 as Dl,aa as yn,ab as Op,ac as $t,ad as Oe,ae as Pl,af as er,ag as Tl,ah as kl,ai as Il,aj as ya,ak as wa,al as Rl,am as xa,an as Al,ao as ba,ap as Oi,aq as $l,ar as Nr,as as Je,at as Ml,au as Ea,av as Ui,aw as Hl,ax as Sa,ay as ks,az as Wi,aA as Up,aB as Jt,aC as fs,aD as Is,aE as Wp,aF as Bp,aG as Nd,aH as $e,aI as Or,aJ as wn,aK as Od,aL as Ca,aM as xn,aN as Vp,aO as zp,aP as Fl,aQ as qp,aR as Ur,aS as jp,aT as bn,aU as Kp,aV as Gp,aW as Qp,aX as Ii,aY as Ri,aZ as Ud,a_ as Ll,a$ as En,b0 as Jp,b1 as Xp,b2 as Yp,b3 as Nl,b4 as Ol,b5 as Ul,b6 as Sn,b7 as Wl,b8 as Wd,b9 as Et,ba as Zp,bb as Cn,bc as Bl,bd as ri,be as Vl,bf as zl,bg as eg,bh as ql,bi as Dn,bj as tg,bk as Pn,bl as ig,bm as sg,bn as Tt,bo as Wr,bp as rg,bq as ng,br as og,bs as ag,bt as jl,bu as qe,bv as Tn,bw as Kl,bx as kn,by as dg,bz as cg,bA as Le,bB as Bi,bC as In,bD as Bd,bE as tr,bF as ir,bG as lg,bH as Rn,bI as Gl,bJ as sr,bK as Ql,bL as Jl,bM as ug,bN as Xl,bO as Yl,bP as Zl,bQ as Br,bR as An,bS as eu,bT as tu,bU as iu,bV as Da,bW as Pa,bX as su,bY as hg,bZ as fg,b_ as Vd,b$ as zd,c0 as qd,c1 as ru,c2 as Vr,c3 as pg,c4 as gg,c5 as $n,c6 as nu,c7 as ou,c8 as jd,c9 as Kd,ca as Mn,cb as mg,cc as _g,cd as au,ce as Hn,cf as Fn,cg as Ln,ch as Nn,ci as On,cj as Un,ck as du,cl as cu,cm as Rs,cn as Vi,co as Gd,cp as Qd,cq as Wn,cr as Jd,cs as vg,ct as yg,cu as wg,cv as xg,cw as zr,cx as Xd,cy as bg,cz as lu,cA as Eg,cB as uu,cC as Sg,cD as hu,cE as Cg,cF as fu,cG as Dg,cH as Pg,cI as ui,cJ as Tg,cK as Bn,cL as kg,cM as Vn,cN as zn,cO as qn,cP as Ig,cQ as Rg,cR as pu,cS as gu,cT as rr,cU as Ai,cV as mu,cW as _u,cX as jn,cY as As,cZ as Ta,c_ as Kn,c$ as wr,d0 as vu,d1 as yu,d2 as Ag,d3 as $g,d4 as Mg,d5 as Hg,d6 as Fg,d7 as $s,d8 as wu,d9 as Gn,da as Lg,db as ps,dc as U,dd as Ng,de as Og,df as xu,dg as Qn,dh as Ug,di as Wg,dj as Bg,dk as Jn,dl as Vg,dm as zg,dn as nr,dp as qg,dq as Yd,dr as ka,ds as bu,dt as jg,du as Kg,dv as Gg,dw as Qg,dx as Jg,dy as Xg,dz as Yg,dA as Zg,dB as Zd,dC as Eu,dD as em,dE as Ms,dF as Ge,dG as or,dH as ec,dI as tm,dJ as Su,dK as im,dL as sm,dM as Cu,dN as rm,dO as nm,dP as jt,dQ as om,dR as am,dS as Du,dT as dm,dU as Xn,dV as gs,dW as tc,dX as cm,dY as Yn,dZ as lm,d_ as Pu,d$ as Tu,e0 as um,e1 as Zn,e2 as eo,e3 as Hs,e4 as to,e5 as ei,e6 as hm,e7 as ku,e8 as Fs,e9 as ic,ea as Xt,eb as Iu,ec as Yt,ed as Ru,ee as Au,ef as Qe,eg as fm,eh as pm,ei as R,ej as gm,ek as mm,el as _m,em as vm,en as sc,eo as ym,ep as wm,eq as xm,er as bm,es as Em,et as Sm,eu as Cm,ev as Dm,ew as Pm,ex as Tm,ey as km,ez as Im,eA as Rm,eB as Am,eC as $m,eD as Mm,eE as Hm,eF as Fm,eG as Lm,eH as Nm,eI as Om,eJ as Um,eK as Wm,eL as Bm,eM as Vm,eN as zm,eO as qm,eP as jm,eQ as Km,eR as Gm,eS as Qm,eT as Jm,eU as Xm,eV as Ym,eW as Zm,eX as e_,eY as t_,eZ as i_,e_ as s_,e$ as r_,f0 as n_,f1 as o_,f2 as a_,f3 as d_,f4 as c_,f5 as l_,f6 as u_,f7 as h_,f8 as f_,f9 as p_,fa as g_,fb as m_,fc as __,fd as v_,fe as $u,ff as y_,fg as w_,fh as x_,fi as b_,fj as E_,fk as S_,fl as C_,fm as D_,fn as P_,fo as T_,fp as k_,fq as I_,fr as R_,fs as A_,ft as $_,fu as M_,fv as H_,fw as F_,fx as L_,fy as N_,fz as O_,fA as U_,fB as W_,fC as B_,fD as V_,fE as z_,fF as q_,fG as j_,fH as K_,fI as G_,fJ as Q_,fK as J_,fL as X_,fM as Y_,fN as rc,fO as Z_,fP as ev,fQ as tv,fR as iv,fS as sv,fT as rv,fU as nv,fV as ov,fW as av,fX as dv,fY as cv,fZ as lv,f_ as uv,f$ as hv,g0 as fv,g1 as pv,g2 as gv,g3 as mv,g4 as _v,g5 as vv,g6 as yv,g7 as wv,g8 as xv,g9 as nc,ga as bv,gb as Ev,gc as Sv,gd as Cv,ge as Dv,gf as Pv,gg as Tv,gh as kv,gi as Iv,gj as Rv,gk as Av,gl as $v,gm as Mv,gn as Hv,go as Fv,gp as Lv,gq as Nv,gr as Ov,gs as Uv}from"./monaco-vscode-api-DkhVdw0_.js";import{aq as Wv}from"./monaco-vscode-editor-api-BYa5i2YN.js";import{ch as Bv,ci as Vv,cj as zv,ck as qv,cl as jv}from"./monaco-vscode-configuration-service-override-DGcvGpAH.js";var io;(function(a){a[a.Complete=100]="Complete",a[a.Partial=50]="Partial",a[a.None=0]="None"})(io||(io={}));class Kv{constructor(){this._systemSchemes=new Set(Object.keys(q)),this._providerInfo=new Map,this.extUri=new el(e=>{const t=this._providerInfo.get(e.scheme);return!(t===void 0||t&gt.PathCaseSensitive)})}$acceptProviderInfos(e,t){t===null?this._providerInfo.delete(e.scheme):this._providerInfo.set(e.scheme,t)}isFreeScheme(e){return!this._providerInfo.has(e)&&!this._systemSchemes.has(e)}getCapabilities(e){return this._providerInfo.get(e)}}const pi=ee("IExtHostFileSystemInfo");var Ve;let so=Ve=class{constructor(e,t){this._fileSystemProvider=new Map,this._writeQueue=new Qh,this._proxy=e.getProxy(k.MainThreadFileSystem);const i=this;this.value=Object.freeze({async stat(s){try{let r;const n=i._fileSystemProvider.get(s.scheme);return n?(await i._proxy.$ensureActivation(s.scheme),r=await n.impl.stat(s)):r=await i._proxy.$stat(s),{type:r.type,ctime:r.ctime,mtime:r.mtime,size:r.size,permissions:r.permissions===Ws.Readonly?1:void 0}}catch(r){Ve._handleError(r)}},async readDirectory(s){try{const r=i._fileSystemProvider.get(s.scheme);return r?(await i._proxy.$ensureActivation(s.scheme),(await r.impl.readDirectory(s)).slice()):await i._proxy.$readdir(s)}catch(r){return Ve._handleError(r)}},async createDirectory(s){try{const r=i._fileSystemProvider.get(s.scheme);return r&&!r.isReadonly?(await i._proxy.$ensureActivation(s.scheme),await i.mkdirp(r.impl,r.extUri,s)):await i._proxy.$mkdir(s)}catch(r){return Ve._handleError(r)}},async readFile(s){try{const r=i._fileSystemProvider.get(s.scheme);return r?(await i._proxy.$ensureActivation(s.scheme),(await r.impl.readFile(s)).slice()):(await i._proxy.$readFile(s)).buffer}catch(r){return Ve._handleError(r)}},async writeFile(s,r){try{const n=i._fileSystemProvider.get(s.scheme);return n&&!n.isReadonly?(await i._proxy.$ensureActivation(s.scheme),await i.mkdirp(n.impl,n.extUri,n.extUri.dirname(s)),await i._writeQueue.queueFor(s,()=>Promise.resolve(n.impl.writeFile(s,r,{create:!0,overwrite:!0})))):await i._proxy.$writeFile(s,be.wrap(r))}catch(n){return Ve._handleError(n)}},async delete(s,r){try{const n=i._fileSystemProvider.get(s.scheme);return n&&!n.isReadonly&&!r?.useTrash?(await i._proxy.$ensureActivation(s.scheme),await n.impl.delete(s,{recursive:!1,...r})):await i._proxy.$delete(s,{recursive:!1,useTrash:!1,atomic:!1,...r})}catch(n){return Ve._handleError(n)}},async rename(s,r,n){try{return await i._proxy.$rename(s,r,{overwrite:!1,...n})}catch(o){return Ve._handleError(o)}},async copy(s,r,n){try{return await i._proxy.$copy(s,r,{overwrite:!1,...n})}catch(o){return Ve._handleError(o)}},isWritableFileSystem(s){const r=t.getCapabilities(s);if(typeof r=="number")return!(r&gt.Readonly)}})}async mkdirp(e,t,i){const s=[];for(;!t.isEqual(i,t.dirname(i));)try{if(((await e.stat(i)).type&Hi.Directory)===0)throw ve.FileExists(`Unable to create folder '${i.scheme===q.file?i.fsPath:i.toString(!0)}' that already exists but is not a directory`);break}catch(r){if(on(r)!==Pe.FileNotFound)throw r;s.push(t.basename(i)),i=t.dirname(i)}for(let r=s.length-1;r>=0;r--){i=t.joinPath(i,s[r]);try{await e.createDirectory(i)}catch(n){if(on(n)!==Pe.FileExists)throw n}}}static _handleError(e){if(e instanceof ve)throw e;if(e instanceof Jh)switch(e.code){case Pe.FileExists:throw ve.FileExists(e.message);case Pe.FileNotFound:throw ve.FileNotFound(e.message);case Pe.FileNotADirectory:throw ve.FileNotADirectory(e.message);case Pe.FileIsADirectory:throw ve.FileIsADirectory(e.message);case Pe.NoPermissions:throw ve.NoPermissions(e.message);case Pe.Unavailable:throw ve.Unavailable(e.message);default:throw new ve(e.message,e.name)}if(!(e instanceof Error))throw new ve(String(e));if(e.name==="ENOPRO"||e.message.includes("ENOPRO"))throw ve.Unavailable(e.message);switch(e.name){case Pe.FileExists:throw ve.FileExists(e.message);case Pe.FileNotFound:throw ve.FileNotFound(e.message);case Pe.FileNotADirectory:throw ve.FileNotADirectory(e.message);case Pe.FileIsADirectory:throw ve.FileIsADirectory(e.message);case Pe.NoPermissions:throw ve.NoPermissions(e.message);case Pe.Unavailable:throw ve.Unavailable(e.message);default:throw new ve(e.message,e.name)}}addFileSystemProvider(e,t,i){return this._fileSystemProvider.set(e,{impl:t,extUri:i?.isCaseSensitive?ud:Xh,isReadonly:!!i?.isReadonly}),B(()=>this._fileSystemProvider.delete(e))}getFileSystemProviderExtUri(e){return this._fileSystemProvider.get(e)?.extUri??ud}};so=Ve=L([E(0,j),E(1,pi)],so);const xr=ee("IExtHostConsumerFileSystem");class Mu extends tl{constructor(e,t,i,s,r){super(),this.id=e,this.name=t,this.logger=i,this.proxy=s,this.extension=r,this.offset=0,this.visible=!1,this.setLevel(i.getLevel()),this._register(i.onDidChangeLogLevel(n=>this.setLevel(n))),this._register(B(()=>this.proxy.$dispose(this.id)))}get logLevel(){return this.getLevel()}appendLine(e){this.append(e+`
`)}append(e){this.info(e)}clear(){const e=this.offset;this.logger.flush(),this.proxy.$update(this.id,Lr.Clear,e)}replace(e){const t=this.offset;this.info(e),this.proxy.$update(this.id,Lr.Replace,t),this.visible&&this.logger.flush()}show(e,t){this.logger.flush(),this.proxy.$reveal(this.id,!!(typeof e=="boolean"?e:t))}hide(){this.proxy.$close(this.id)}log(e,t){this.offset+=be.fromString(t).byteLength,ef(this.logger,e,t),this.visible&&(this.logger.flush(),this.proxy.$update(this.id,Lr.Append))}}class Gv extends Mu{appendLine(e){this.append(e)}}let ro=class{constructor(e,t,i,s,r,n){this.initData=t,this.extHostFileSystem=i,this.extHostFileSystemInfo=s,this.loggerService=r,this.logService=n,this.extensionLogDirectoryPromise=new Map,this.namePool=1,this.channels=new Map,this.visibleChannelId=null,this.proxy=e.getProxy(k.MainThreadOutputService),this.outputsLocation=this.extHostFileSystemInfo.extUri.joinPath(t.logsLocation,`output_logging_${Yh(new Date).replace(/-|:|\.\d+Z$/g,"")}`)}$setVisibleChannel(e){this.visibleChannelId=e;for(const[t,i]of this.channels)i.visible=t===this.visibleChannelId}createOutputChannel(e,t,i){if(e=e.trim(),!e)throw new Error("illegal argument `name`. must not be falsy");const s=typeof t=="object"&&t.log,r=ai(t)?t:void 0;if(ai(r)&&!r.trim())throw new Error("illegal argument `languageId`. must not be empty");let n;const o=this.initData.environment.extensionLogLevel?.find(([h])=>ge.equals(i.identifier,h))?.[1];o&&(n=Zh(o));const d=new N,c=s?this.doCreateLogOutputChannel(e,n,i,d):this.doCreateOutputChannel(e,r,i,d);return c.then(h=>{this.channels.set(h.id,h),h.visible=h.id===this.visibleChannelId,d.add(B(()=>this.channels.delete(h.id)))}),s?this.createExtHostLogOutputChannel(e,n??this.logService.getLevel(),c,d):this.createExtHostOutputChannel(e,c,d)}async doCreateOutputChannel(e,t,i,s){this.outputDirectoryPromise||(this.outputDirectoryPromise=this.extHostFileSystem.value.createDirectory(this.outputsLocation).then(()=>this.outputsLocation));const r=await this.outputDirectoryPromise,n=this.extHostFileSystemInfo.extUri.joinPath(r,`${this.namePool++}-${e.replace(/[\\/:\*\?"<>\|]/g,"")}.log`),o=s.add(this.loggerService.createLogger(n,{logLevel:"always",donotRotate:!0,donotUseFormatters:!0,hidden:!0})),d=await this.proxy.$register(e,n,t,i.identifier.value);return s.add(B(()=>this.loggerService.deregisterLogger(n))),new Mu(d,e,o,this.proxy,i)}async doCreateLogOutputChannel(e,t,i,s){const r=await this.createExtensionLogDirectory(i),n=e.replace(/[\\/:\*\?"<>\|]/g,""),o=this.extHostFileSystemInfo.extUri.joinPath(r,`${n}.log`),d=`${i.identifier.value}.${n}`,c=s.add(this.loggerService.createLogger(o,{id:d,name:e,logLevel:t,extensionId:i.identifier.value}));return s.add(B(()=>this.loggerService.deregisterLogger(o))),new Gv(d,e,c,this.proxy,i)}createExtensionLogDirectory(e){let t=this.extensionLogDirectoryPromise.get(e.identifier.value);if(!t){const i=this.extHostFileSystemInfo.extUri.joinPath(this.initData.logsLocation,e.identifier.value);this.extensionLogDirectoryPromise.set(e.identifier.value,t=(async()=>{try{await this.extHostFileSystem.value.createDirectory(i)}catch(s){if(on(s)!==Pe.FileExists)throw s}return i})())}return t}createExtHostOutputChannel(e,t,i){const s=()=>{if(i.isDisposed)throw new Error("Channel has been closed")};return t.then(r=>i.add(r)),{get name(){return e},append(r){s(),t.then(n=>n.append(r))},appendLine(r){s(),t.then(n=>n.appendLine(r))},clear(){s(),t.then(r=>r.clear())},replace(r){s(),t.then(n=>n.replace(r))},show(r,n){s(),t.then(o=>o.show(r,n))},hide(){s(),t.then(r=>r.hide())},dispose(){i.dispose()}}}createExtHostLogOutputChannel(e,t,i,s){const r=()=>{if(s.isDisposed)throw new Error("Channel has been closed")},n=s.add(new P);function o(d){t=d,n.fire(d)}return i.then(d=>{d.logLevel!==t&&o(d.logLevel),s.add(d.onDidChangeLogLevel(c=>o(c)))}),{...this.createExtHostOutputChannel(e,i,s),get logLevel(){return t},onDidChangeLogLevel:n.event,trace(d,...c){r(),i.then(h=>h.trace(d,...c))},debug(d,...c){r(),i.then(h=>h.debug(d,...c))},info(d,...c){r(),i.then(h=>h.info(d,...c))},warn(d,...c){r(),i.then(h=>h.warn(d,...c))},error(d,...c){r(),i.then(h=>h.error(d,...c))}}}};ro=L([E(0,j),E(1,Se),E(2,xr),E(3,pi),E(4,fi),E(5,re)],ro);const Hu=ee("IExtHostOutputService"),br=ee("IURITransformerService");class Qv{constructor(e){e?(this.transformIncoming=e.transformIncoming.bind(e),this.transformOutgoing=e.transformOutgoing.bind(e),this.transformOutgoingURI=e.transformOutgoingURI.bind(e),this.transformOutgoingScheme=e.transformOutgoingScheme.bind(e)):(this.transformIncoming=t=>t,this.transformOutgoing=t=>t,this.transformOutgoingURI=t=>t,this.transformOutgoingScheme=t=>t)}}function Zi(a,e,t){return new el(i=>Ia(i,t)).isEqual(a,e)}function Jv(a,e,t){return Zi(a.uri,e.uri,t)?0:Bs(a.uri.toString(),e.uri.toString())}function Xv(a,e,t){return a.index!==e.index?a.index<e.index?-1:1:Zi(a.uri,e.uri,t)?Bs(a.name,e.name):Bs(a.uri.toString(),e.uri.toString())}function Fu(a,e,t,i){const s=a.slice(0).sort((n,o)=>t(n,o,i)),r=e.slice(0).sort((n,o)=>t(n,o,i));return cf(s,r,(n,o)=>t(n,o,i))}function Ia(a,e){const t=e.getCapabilities(a.scheme);return!(t&&t&gt.PathCaseSensitive)}class ni extends af{static toExtHostWorkspace(e,t,i,s){if(!e)return{workspace:null,added:[],removed:[]};const{id:r,name:n,folders:o,configuration:d,transient:c,isUntitled:h}=e,g=[],m=t;t?o.forEach((x,C)=>{const S=v.revive(x.uri),T=ni._findFolder(i||t,S,s);T?(T.name=x.name,T.index=x.index,g.push(T)):g.push({uri:S,name:x.name,index:C})}):g.push(...o.map(({uri:x,name:C,index:S})=>({uri:v.revive(x),name:C,index:S}))),g.sort((x,C)=>x.index<C.index?-1:1);const l=new ni(r,n,g,!!c,d?v.revive(d):null,!!h,x=>Ia(x,s)),{added:f,removed:_}=Fu(m?m.workspaceFolders:[],l.workspaceFolders,Jv,s);return{workspace:l,added:f,removed:_}}static _findFolder(e,t,i){for(let s=0;s<e.folders.length;s++){const r=e.workspaceFolders[s];if(Zi(r.uri,t,i))return r}}constructor(e,t,i,s,r,n,o){super(e,i.map(d=>new df(d)),s,r,o),this._name=t,this._isUntitled=n,this._workspaceFolders=[],this._structure=aa.forUris(o,()=>!0),i.forEach(d=>{this._workspaceFolders.push(d),this._structure.set(d.uri,d)})}get name(){return this._name}get isUntitled(){return this._isUntitled}get workspaceFolders(){return this._workspaceFolders.slice(0)}getWorkspaceFolder(e,t){return t&&this._structure.get(e)&&(e=oa(e)),this._structure.findSubstr(e)}resolveWorkspaceFolder(e){return this._structure.get(e)}}let no=class{constructor(e,t,i,s,r){this._onDidChangeWorkspace=new P,this.onDidChangeWorkspace=this._onDidChangeWorkspace.event,this._onDidGrantWorkspaceTrust=new P,this.onDidGrantWorkspaceTrust=this._onDidGrantWorkspaceTrust.event,this._activeSearchCallbacks=[],this._trusted=!1,this._editSessionIdentityProviders=new Map,this._providerHandlePool=0,this._onWillCreateEditSessionIdentityEvent=new Fi,this._canonicalUriProviders=new Map,this._logService=s,this._extHostFileSystemInfo=i,this._uriTransformerService=r,this._requestIdProvider=new tf,this._barrier=new mt,this._proxy=e.getProxy(k.MainThreadWorkspace),this._messageService=e.getProxy(k.MainThreadMessageService);const n=t.workspace;this._confirmedWorkspace=n?new ni(n.id,n.name,[],!!n.transient,n.configuration?v.revive(n.configuration):null,!!n.isUntitled,o=>Ia(o,i)):void 0}$initializeWorkspace(e,t){this._trusted=t,this.$acceptWorkspaceData(e),this._barrier.open()}waitForInitializeCall(){return this._barrier.wait()}get workspace(){return this._actualWorkspace}get name(){return this._actualWorkspace?this._actualWorkspace.name:void 0}get workspaceFile(){if(this._actualWorkspace&&this._actualWorkspace.configuration)return this._actualWorkspace.isUntitled?v.from({scheme:q.untitled,path:il(oa(this._actualWorkspace.configuration))}):this._actualWorkspace.configuration}get _actualWorkspace(){return this._unconfirmedWorkspace||this._confirmedWorkspace}getWorkspaceFolders(){if(this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}async getWorkspaceFolders2(){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}updateWorkspaceFolders(e,t,i,...s){const r=[];if(Array.isArray(s)&&s.forEach(h=>{v.isUri(h.uri)&&!r.some(g=>Zi(g.uri,h.uri,this._extHostFileSystemInfo))&&r.push({uri:h.uri,name:h.name||hd(h.uri)})}),this._unconfirmedWorkspace||[t,i].some(h=>typeof h!="number"||h<0)||i===0&&r.length===0)return!1;const n=this._actualWorkspace?this._actualWorkspace.workspaceFolders:[];if(t+i>n.length)return!1;const o=n.slice(0);o.splice(t,i,...r.map(h=>({uri:h.uri,name:h.name||hd(h.uri),index:void 0})));for(let h=0;h<o.length;h++){const g=o[h];if(o.some((m,l)=>l!==h&&Zi(g.uri,m.uri,this._extHostFileSystemInfo)))return!1}o.forEach((h,g)=>h.index=g);const{added:d,removed:c}=Fu(n,o,Xv,this._extHostFileSystemInfo);if(d.length===0&&c.length===0)return!1;if(this._proxy){const h=e.displayName||e.name;this._proxy.$updateWorkspaceFolders(h,t,i,r).then(void 0,g=>{this._unconfirmedWorkspace=void 0;const m={source:{identifier:e.identifier,label:e.displayName||e.name}};this._messageService.$showMessage(Te.Error,J(2573,"Extension '{0}' failed to update workspace folders: {1}",h,g.toString()),m,[])})}return this.trySetWorkspaceFolders(o),!0}getWorkspaceFolder(e,t){if(this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(e,t)}async getWorkspaceFolder2(e,t){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(e,t)}async resolveWorkspaceFolder(e){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.resolveWorkspaceFolder(e)}getPath(){if(!this._actualWorkspace)return;const{folders:e}=this._actualWorkspace;if(e.length!==0)return e[0].uri.fsPath}getRelativePath(e,t){let i,s="";if(typeof e=="string"?(i=v.file(e),s=e):typeof e<"u"&&(i=e,s=e.fsPath),!i)return s;const r=this.getWorkspaceFolder(i,!0);if(!r)return s;typeof t>"u"&&this._actualWorkspace&&(t=this._actualWorkspace.folders.length>1);let n=sl(r.uri,i);return t&&r.name&&(n=`${r.name}/${n}`),n}trySetWorkspaceFolders(e){this._actualWorkspace&&(this._unconfirmedWorkspace=ni.toExtHostWorkspace({id:this._actualWorkspace.id,name:this._actualWorkspace.name,configuration:this._actualWorkspace.configuration,folders:e,isUntitled:this._actualWorkspace.isUntitled},this._actualWorkspace,void 0,this._extHostFileSystemInfo).workspace||void 0)}$acceptWorkspaceData(e){const{workspace:t,added:i,removed:s}=ni.toExtHostWorkspace(e,this._confirmedWorkspace,this._unconfirmedWorkspace,this._extHostFileSystemInfo);this._confirmedWorkspace=t||void 0,this._unconfirmedWorkspace=void 0,this._onDidChangeWorkspace.fire(Object.freeze({added:i,removed:s}))}findFiles(e,t,i,s,r=ue.None){this._logService.trace(`extHostWorkspace#findFiles: fileSearch, extension: ${s.value}, entryPoint: findFiles`);let n="",o=!0;return t===null?o=!1:t!==void 0&&(typeof t=="string"?n=t:n=t.pattern),this._findFilesImpl({type:"include",value:e},{exclude:[n],maxResults:i,useExcludeSettings:o?Pt.FilesExclude:Pt.None,useIgnoreFiles:{local:!1}},r)}findFiles2(e,t={},i,s=ue.None){return this._logService.trace(`extHostWorkspace#findFiles2New: fileSearch, extension: ${i.value}, entryPoint: findFiles2New`),this._findFilesImpl({type:"filePatterns",value:e},t,s)}async _findFilesImpl(e,t,i){if(i.isCancellationRequested)return Promise.resolve([]);const s=e.type==="include"?[e.value]:e.value??[];if(!Array.isArray(s))throw console.error("Invalid file pattern provided",s),new Error(`Invalid file pattern provided ${JSON.stringify(s)}`);const r=s.map(n=>{const o=oc(t.exclude),d={ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles?.local=="boolean"?!t.useIgnoreFiles.local:void 0,disregardGlobalIgnoreFiles:typeof t.useIgnoreFiles?.global=="boolean"?!t.useIgnoreFiles.global:void 0,disregardParentIgnoreFiles:typeof t.useIgnoreFiles?.parent=="boolean"?!t.useIgnoreFiles.parent:void 0,disregardExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings===Pt.None,disregardSearchExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings!==Pt.SearchAndFilesExclude,maxResults:t.maxResults,excludePattern:o.length>0?o:void 0,_reason:"startFileSearch",shouldGlobSearch:e.type==="include"?void 0:!0},c=Ls(Ss.from(n)),h=c?.folder;return e.type==="include"?d.includePattern=c?.pattern:d.filePattern=c?.pattern,{folder:h,options:d}});return this._findFilesBase(r,i)}async _findFilesBase(e,t){return(await Promise.all(e?.map(s=>this._proxy.$startFileSearch(s.folder??null,s.options,t).then(r=>Array.isArray(r)?r.map(n=>v.revive(n)):[]))??[])).flat()}findTextInFiles2(e,t,i,s=ue.None){this._logService.trace(`extHostWorkspace#findTextInFiles2: textSearch, extension: ${i.value}, entryPoint: findTextInFiles2`);const r=m=>{if(!t)return{folder:void 0,options:{}};const l=m?Ls(Ss.from(m)):void 0,f=t.exclude?oc(t.exclude):void 0;return{options:{ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles=="boolean"?!t.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof t.useIgnoreFiles?.global=="boolean"?!t.useIgnoreFiles?.global:void 0,disregardParentIgnoreFiles:typeof t.useIgnoreFiles?.parent=="boolean"?!t.useIgnoreFiles?.parent:void 0,disregardExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings===Pt.None,disregardSearchExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings!==Pt.SearchAndFilesExclude,fileEncoding:t.encoding,maxResults:t.maxResults,previewOptions:t.previewOptions?{matchLines:t.previewOptions?.numMatchLines??100,charsPerLine:t.previewOptions?.charsPerLine??1e4}:void 0,surroundingContext:t.surroundingContext,includePattern:l?.pattern,excludePattern:f},folder:l?.folder}},o=(t?.include?.map(m=>r(m))??[r(void 0)]).filter(m=>!!m),d=new N,c=d.add(new P),h=this.findTextInFilesBase(e,o,(m,l)=>c.fire({result:m,uri:l}),s);return{results:new _r(async m=>{d.add(c.event(l=>{const f=l.result,_=l.uri;Fd(f)?m.emitOne(new _t(_,f.rangeLocations.map(x=>({previewRange:new de(x.preview.startLineNumber,x.preview.startColumn,x.preview.endLineNumber,x.preview.endColumn),sourceRange:new de(x.source.startLineNumber,x.source.startColumn,x.source.endLineNumber,x.source.endColumn)})),f.previewText)):m.emitOne(new ga(_,f.text,f.lineNumber))})),await h}),complete:h.then(m=>(d.dispose(),{limitHit:m?.limitHit??!1}))}}async findTextInFilesBase(e,t,i,s=ue.None){const r=this._requestIdProvider.getNext();let n=!1;if(s.onCancellationRequested(o=>{n=!0}),this._activeSearchCallbacks[r]=o=>{if(n)return;const d=v.revive(o.resource);o.results.forEach(c=>{const h=ze(c);i(h,d)})},s.isCancellationRequested)return{};try{const o=await Promise.all(t?.map(d=>this._proxy.$startTextSearch(e,d.folder??null,d.options,r,s)||{})??[]);return delete this._activeSearchCallbacks[r],o.reduce((d,c)=>({limitHit:d?.limitHit||(c?.limitHit??!1),message:[d?.message??[],c?.message??[]].flat()}),{})??{limitHit:!1}}catch(o){throw delete this._activeSearchCallbacks[r],o}}async findTextInFiles(e,t,i,s,r=ue.None){this._logService.trace(`extHostWorkspace#findTextInFiles: textSearch, extension: ${s.value}, entryPoint: findTextInFiles`);const n=typeof t.previewOptions>"u"?{matchLines:100,charsPerLine:1e4}:t.previewOptions,o=Ls(Ss.from(t.include)),d=typeof t.exclude=="string"?t.exclude:t.exclude?t.exclude.pattern:void 0,c={ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles=="boolean"?!t.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof t.useGlobalIgnoreFiles=="boolean"?!t.useGlobalIgnoreFiles:void 0,disregardParentIgnoreFiles:typeof t.useParentIgnoreFiles=="boolean"?!t.useParentIgnoreFiles:void 0,disregardExcludeSettings:typeof t.useDefaultExcludes=="boolean"?!t.useDefaultExcludes:!0,disregardSearchExcludeSettings:typeof t.useSearchExclude=="boolean"?!t.useSearchExclude:!0,fileEncoding:t.encoding,maxResults:t.maxResults,previewOptions:n,surroundingContext:t.afterContext,includePattern:o?.pattern,excludePattern:d?[{pattern:d}]:void 0},h=(g,m)=>{Fd(g)?i({uri:m,preview:{text:g.previewText,matches:fd(g.rangeLocations,l=>new de(l.preview.startLineNumber,l.preview.startColumn,l.preview.endLineNumber,l.preview.endColumn))},ranges:fd(g.rangeLocations,l=>new de(l.source.startLineNumber,l.source.startColumn,l.source.endLineNumber,l.source.endColumn))}):i({uri:m,text:g.text,lineNumber:g.lineNumber})};return this.findTextInFilesBase(e,[{options:c,folder:o?.folder}],h,r)}$handleTextSearchResult(e,t){this._activeSearchCallbacks[t]?.(e)}async save(e){const t=await this._proxy.$save(e,{saveAs:!1});return v.revive(t)}async saveAs(e){const t=await this._proxy.$save(e,{saveAs:!0});return v.revive(t)}saveAll(e){return this._proxy.$saveAll(e)}resolveProxy(e){return this._proxy.$resolveProxy(e)}lookupAuthorization(e){return this._proxy.$lookupAuthorization(e)}lookupKerberosAuthorization(e){return this._proxy.$lookupKerberosAuthorization(e)}loadCertificates(){return this._proxy.$loadCertificates()}get trusted(){return this._trusted}requestWorkspaceTrust(e){return this._proxy.$requestWorkspaceTrust(e)}$onDidGrantWorkspaceTrust(){this._trusted||(this._trusted=!0,this._onDidGrantWorkspaceTrust.fire())}registerEditSessionIdentityProvider(e,t){if(this._editSessionIdentityProviders.has(e))throw new Error(`A provider has already been registered for scheme ${e}`);this._editSessionIdentityProviders.set(e,t);const i=this._uriTransformerService.transformOutgoingScheme(e),s=this._providerHandlePool++;return this._proxy.$registerEditSessionIdentityProvider(s,i),B(()=>{this._editSessionIdentityProviders.delete(e),this._proxy.$unregisterEditSessionIdentityProvider(s)})}async $getEditSessionIdentifier(e,t){this._logService.info("Getting edit session identifier for workspaceFolder",e);const i=await this.resolveWorkspaceFolder(v.revive(e));if(!i){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",i);const s=this._editSessionIdentityProviders.get(i.uri.scheme);if(this._logService.info(`Provider for scheme ${i.uri.scheme} is defined: `,!!s),!s)return;const r=await s.provideEditSessionIdentity(i,t);if(this._logService.info("Provider returned edit session identifier: ",r),!!r)return r}async $provideEditSessionIdentityMatch(e,t,i,s){this._logService.info("Getting edit session identifier for workspaceFolder",e);const r=await this.resolveWorkspaceFolder(v.revive(e));if(!r){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",r);const n=this._editSessionIdentityProviders.get(r.uri.scheme);if(this._logService.info(`Provider for scheme ${r.uri.scheme} is defined: `,!!n),!n)return;const o=await n.provideEditSessionIdentityMatch?.(t,i,s);if(this._logService.info("Provider returned edit session identifier match result: ",o),!!o)return o}getOnWillCreateEditSessionIdentityEvent(e){return(t,i,s)=>{const r=function(o){t.call(i,o)};return r.extension=e,this._onWillCreateEditSessionIdentityEvent.event(r,void 0,s)}}async $onWillCreateEditSessionIdentity(e,t,i){const s=await this.resolveWorkspaceFolder(v.revive(e));if(s===void 0)throw new Error("Unable to resolve workspace folder");await this._onWillCreateEditSessionIdentityEvent.fireAsync({workspaceFolder:s},t,async(r,n)=>{const o=Date.now();await Promise.resolve(r),Date.now()-o>i&&this._logService.warn("SLOW edit session create-participant",n.extension.identifier)}),t.isCancellationRequested}registerCanonicalUriProvider(e,t){if(this._canonicalUriProviders.has(e))throw new Error(`A provider has already been registered for scheme ${e}`);this._canonicalUriProviders.set(e,t);const i=this._uriTransformerService.transformOutgoingScheme(e),s=this._providerHandlePool++;return this._proxy.$registerCanonicalUriProvider(s,i),B(()=>{this._canonicalUriProviders.delete(e),this._proxy.$unregisterCanonicalUriProvider(s)})}async provideCanonicalUri(e,t,i){const s=this._canonicalUriProviders.get(e.scheme);if(!s)return;const r=await s.provideCanonicalUri?.(v.revive(e),t,i);if(r)return r}async $provideCanonicalUri(e,t,i){return this.provideCanonicalUri(v.revive(e),{targetScheme:t},i)}async decode(e,t){const[i,s]=this.toEncodeDecodeParameters(t),r=await this._proxy.$resolveDecoding(i,s),n=(await Bv(sf(be.wrap(e)),{...r,acceptTextOnly:!0,overwriteEncoding:o=>o===null||o===r.preferredEncoding?Promise.resolve(r.preferredEncoding):this._proxy.$validateDetectedEncoding(i,o,s)})).stream;return rf(n,o=>o.join(""))}async encode(e,t){const[i,s]=this.toEncodeDecodeParameters(t),{encoding:r,addBOM:n}=await this._proxy.$resolveEncoding(i,s);if(r===Vv&&!n)return be.fromString(e).buffer;const o=await zv(qv(e),r,{addBOM:n});return nf(o).buffer}toEncodeDecodeParameters(e){const t=of(e?.uri)?e.uri:void 0,i=typeof e?.encoding=="string"?e.encoding:void 0;return[t,i?{encoding:i}:void 0]}};no=L([E(0,j),E(1,Se),E(2,pi),E(3,re),E(4,br)],no);const st=ee("IExtHostWorkspace");function Ls(a){let e,t;if(a)return typeof a=="string"?e=a:(e=a.pattern,t=v.revive(a.baseUri)),{pattern:e,folder:t}}function oc(a){return(a?.map(e=>{if(typeof e=="string")return e===""?void 0:{pattern:e,uri:void 0};{const t=Ls(e);return t?{pattern:t.pattern,uri:t.folder}:void 0}})??[]).filter(e=>!!e)}var $i;let oo=class{static{$i=this}static{this._handlePool=0}static{this._maxEventSize=250}constructor(e,t){this._logService=t,this._provider=new Map,this._proxy=e.getProxy(k.MainThreadDecorations)}registerFileDecorationProvider(e,t){const i=$i._handlePool++;this._provider.set(i,{provider:e,extensionDescription:t}),this._proxy.$registerDecorationProvider(i,t.identifier.value);const s=e.onDidChangeFileDecorations&&e.onDidChangeFileDecorations(r=>{if(!r){this._proxy.$onDidChange(i,null);return}const n=je(r);if(n.length<=$i._maxEventSize){this._proxy.$onDidChange(i,n);return}this._logService.warn("[Decorations] CAPPING events from decorations provider",t.identifier.value,n.length);const o=n.map(h=>({uri:h,rank:lf(h.path,"/")})),d=uf(o,(h,g)=>h.rank-g.rank||Bs(h.uri.path,g.uri.path)),c=[];e:for(const h of d){let g;for(const m of h){const l=rl(m.uri.path);if(g!==l&&(g=l,c.push(m.uri)>=$i._maxEventSize))break e}}this._proxy.$onDidChange(i,c)});return new V(()=>{s?.dispose(),this._proxy.$unregisterDecorationProvider(i),this._provider.delete(i)})}async $provideDecorations(e,t,i){if(!this._provider.has(e))return Object.create(null);const s=Object.create(null),{provider:r,extensionDescription:n}=this._provider.get(e);return await Promise.all(t.map(async o=>{try{const{uri:d,id:c}=o,h=await Promise.resolve(r.provideFileDecoration(v.revive(d),i));if(!h)return;try{_n.validate(h),h.badge&&typeof h.badge!="string"&&b(n,"codiconDecoration"),s[c]=[h.propagate,h.tooltip,h.badge,h.color]}catch(g){this._logService.warn(`INVALID decoration from extension '${n.identifier.value}': ${g}`)}}catch(d){this._logService.error(d)}})),s}};oo=$i=L([E(0,j),E(1,re)],oo);const Lu=ee("IExtHostDecorations");function ms(a,e){if(e){const t=e.split(".");let i=a;for(let s=0;i&&s<t.length;s++)i=i[t[s]];return i}}function Yv(a){return a instanceof v}function Zv(a){return a&&a.uri instanceof v&&a.languageId&&typeof a.languageId=="string"}function ey(a){return a&&!a.uri&&a.languageId&&typeof a.languageId=="string"}function ty(a){return a&&a.uri instanceof v&&(!a.name||typeof a.name=="string")&&(!a.index||typeof a.index=="number")}function ac(a){if(Yv(a))return{resource:a};if(Zv(a))return{resource:a.uri,overrideIdentifier:a.languageId};if(ey(a))return{overrideIdentifier:a.languageId};if(ty(a))return{resource:a.uri};if(a===null)return{resource:null}}let ao=class{constructor(e,t,i){this._proxy=e.getProxy(k.MainThreadConfiguration),this._extHostWorkspace=t,this._logService=i,this._barrier=new mt,this._actual=null}getConfigProvider(){return this._barrier.wait().then(e=>this._actual)}$initializeConfiguration(e){this._actual=new iy(this._proxy,this._extHostWorkspace,e,this._logService),this._barrier.open()}$acceptConfigurationChanged(e,t){this.getConfigProvider().then(i=>i.$acceptConfigurationChanged(e,t))}};ao=L([E(0,j),E(1,st),E(2,re)],ao);class iy{constructor(e,t,i,s){this._onDidChangeConfiguration=new P,this._proxy=e,this._logService=s,this._extHostWorkspace=t,this._configuration=pd.parse(i,s),this._configurationScopes=this._toMap(i.configurationScopes)}get onDidChangeConfiguration(){return this._onDidChangeConfiguration&&this._onDidChangeConfiguration.event}$acceptConfigurationChanged(e,t){const i={data:this._configuration.toData(),workspace:this._extHostWorkspace.workspace};this._configuration=pd.parse(e,this._logService),this._configurationScopes=this._toMap(e.configurationScopes),this._onDidChangeConfiguration.fire(this._toConfigurationChangeEvent(t,i))}getConfiguration(e,t,i){const s=ac(t)||{},r=this._toReadonlyValue(this._configuration.getValue(e,s,this._extHostWorkspace.workspace));e&&this._validateConfigurationAccess(e,s,i?.identifier);function n(d){if(d==null)return null;if(typeof d=="boolean")return d?xi.USER:xi.WORKSPACE;switch(d){case Cs.Global:return xi.USER;case Cs.Workspace:return xi.WORKSPACE;case Cs.WorkspaceFolder:return xi.WORKSPACE_FOLDER}}const o={has(d){return typeof ms(r,d)<"u"},get:(d,c)=>{this._validateConfigurationAccess(e?`${e}.${d}`:d,s,i?.identifier);let h=ms(r,d);if(typeof h>"u")h=c;else{let g;const m=(l,f)=>{if(an(l)){let _;const x=()=>{g=g||De(r),_=_||ms(g,f)};return new Proxy(l,{get:(C,S)=>{if(typeof S=="string"&&S.toLowerCase()==="tojson")return x(),()=>_;if(g)return _=_||ms(g,f),_[S];const T=C[S];return typeof S=="string"?m(T,`${f}.${S}`):T},set:(C,S,T)=>(x(),_&&(_[S]=T),!0),deleteProperty:(C,S)=>(x(),_&&delete _[S],!0),defineProperty:(C,S,T)=>(x(),_&&Object.defineProperty(_,S,T),!0)})}return Array.isArray(l)?De(l):l};h=m(h,d)}return h},update:(d,c,h,g)=>{d=e?`${e}.${d}`:d;const m=n(h);return c!==void 0?this._proxy.$updateConfigurationOption(m,d,c,s,g):this._proxy.$removeConfigurationOption(m,d,s,g)},inspect:d=>{d=e?`${e}.${d}`:d;const c=this._configuration.inspect(d,s,this._extHostWorkspace.workspace);if(c)return{key:d,defaultValue:De(c.policy?.value??c.default?.value),globalLocalValue:De(c.userLocal?.value),globalRemoteValue:De(c.userRemote?.value),globalValue:De(c.user?.value??c.application?.value),workspaceValue:De(c.workspace?.value),workspaceFolderValue:De(c.workspaceFolder?.value),defaultLanguageValue:De(c.default?.override),globalLocalLanguageValue:De(c.userLocal?.override),globalRemoteLanguageValue:De(c.userRemote?.override),globalLanguageValue:De(c.user?.override??c.application?.override),workspaceLanguageValue:De(c.workspace?.override),workspaceFolderLanguageValue:De(c.workspaceFolder?.override),languageIds:De(c.overrideIdentifiers)}}};return typeof r=="object"&&Vs(o,r,!1),Object.freeze(o)}_toReadonlyValue(e){const t=i=>an(i)?new Proxy(i,{get:(s,r)=>t(s[r]),set:(s,r,n)=>{throw new Error(`TypeError: Cannot assign to read only property '${String(r)}' of object`)},deleteProperty:(s,r)=>{throw new Error(`TypeError: Cannot delete read only property '${String(r)}' of object`)},defineProperty:(s,r)=>{throw new Error(`TypeError: Cannot define property '${String(r)}' for a readonly object`)},setPrototypeOf:s=>{throw new Error("TypeError: Cannot set prototype for a readonly object")},isExtensible:()=>!1,preventExtensions:()=>!0}):i;return t(e)}_validateConfigurationAccess(e,t,i){const s=hf.test(e)?Ar.RESOURCE:this._configurationScopes.get(e),r=i?`[${i.value}] `:"";if(Ar.RESOURCE===s){typeof t?.resource>"u"&&this._logService.warn(`${r}Accessing a resource scoped configuration without providing a resource is not expected. To get the effective value for '${e}', provide the URI of a resource or 'null' for any resource.`);return}if(Ar.WINDOW===s){t?.resource&&this._logService.warn(`${r}Accessing a window scoped configuration for a resource is not expected. To associate '${e}' to a resource, define its scope to 'resource' in configuration contributions in 'package.json'.`);return}}_toConfigurationChangeEvent(e,t){const i=new ff(e,t,this._configuration,this._extHostWorkspace.workspace,this._logService);return Object.freeze({affectsConfiguration:(s,r)=>i.affectsConfiguration(s,ac(r))})}_toMap(e){return e.reduce((t,i)=>(t.set(i[0],i[1]),t),new Map)}}const rt=ee("IExtHostConfiguration"),Dt=(a,e,t,i)=>{let s=e;return{enumerable:!0,configurable:!1,get(){return s},set(r){if(!t(s,r)){const n=s;s=r,a.listener?.(i(r,n))}}}},Kt=(a,e)=>a===e,dt={range:(a,e)=>a===e?!0:!a||!e?!1:a.isEqual(e),label:Kt,description:Kt,sortText:Kt,busy:Kt,error:Kt,canResolveChildren:Kt,tags:(a,e)=>!(a.length!==e.length||a.some(t=>!e.find(i=>t.id===i.id)))},Gt=a=>e=>({op:Ds.SetProp,update:a(e)}),sy=(a,e)=>({range:(()=>{let t;const i=Gt(s=>({range:Ft.lift($.from(s))}));return{enumerable:!0,configurable:!1,get(){return t},set(s){a.listener?.({op:Ds.DocumentSynced}),dt.range(t,s)||(t=s,a.listener?.(i(s)))}}})(),label:Dt(a,e,dt.label,Gt(t=>({label:t}))),description:Dt(a,void 0,dt.description,Gt(t=>({description:t}))),sortText:Dt(a,void 0,dt.sortText,Gt(t=>({sortText:t}))),canResolveChildren:Dt(a,!1,dt.canResolveChildren,t=>({op:Ds.UpdateCanResolveChildren,state:t})),busy:Dt(a,!1,dt.busy,Gt(t=>({busy:t}))),error:Dt(a,void 0,dt.error,Gt(t=>({error:ce.fromStrict(t)||null}))),tags:Dt(a,[],dt.tags,(t,i)=>({op:Ds.SetTags,new:t.map(Xi.from),old:i.map(Xi.from)}))}),ry=a=>{const e=ne.fromString(a.extId),t=new Ot(e.controllerId,e.localId,a.label,v.revive(a.uri)||void 0);return t.range=$.to(a.range||void 0),t.description=a.description||void 0,t.sortText=a.sortText||void 0,t.tags=a.tags.map(i=>Xi.to({id:Ip(i).tagId})),t},dc=a=>{let e;for(const t of a.tests){const i=ry(t.item);ma(i).parent=e,e=i}return e};class Ot{constructor(e,t,i,s){if(t.includes(Dp.Delimiter))throw new Error(`Test IDs may not include the ${JSON.stringify(t)} symbol`);const r=Pp(this,e);Object.defineProperties(this,{id:{value:t,enumerable:!0,writable:!1},uri:{value:s,enumerable:!0,writable:!1},parent:{enumerable:!1,get(){return r.parent instanceof Ra?void 0:r.parent}},children:{value:Tp(r,ma,Ot),enumerable:!0,writable:!1},...sy(r,i)})}}class Ra extends Ot{constructor(e,t){super(e,e,t,void 0),this._isRoot=!0}}class ny extends kp{constructor(e,t,i){super({controllerId:e,getDocumentVersion:s=>s&&i.getDocument(s)?.version,getApiFor:ma,getChildren:s=>s.children,root:new Ra(e,t),toITestItem:ns.from})}}let cc=class extends X{constructor(e,t,i){super(),this.initData=t,this._onDidChangeTelemetryEnabled=this._register(new P),this.onDidChangeTelemetryEnabled=this._onDidChangeTelemetryEnabled.event,this._onDidChangeTelemetryConfiguration=this._register(new P),this.onDidChangeTelemetryConfiguration=this._onDidChangeTelemetryConfiguration.event,this._productConfig={usage:!0,error:!0},this._level=bi.NONE,this._inLoggingOnlyMode=!1,this._telemetryLoggers=new Map,this._inLoggingOnlyMode=this.initData.environment.isExtensionTelemetryLoggingOnly;const s=t.remote.isRemote?"remoteExtHostTelemetry":e?"workerExtHostTelemetry":"extHostTelemetry";this._outputLogger=this._register(i.createLogger(s,{name:J(2568,"Extension Telemetry{0}",this._inLoggingOnlyMode?" (Not Sent)":""),hidden:!0,group:pf}))}getTelemetryConfiguration(){return this._level===bi.USAGE}getTelemetryDetails(){return{isCrashEnabled:this._level>=bi.CRASH,isErrorsEnabled:this._productConfig.error?this._level>=bi.ERROR:!1,isUsageEnabled:this._productConfig.usage?this._level>=bi.USAGE:!1}}instantiateLogger(e,t,i){const s=this.getTelemetryDetails(),r=new Nu(t,i,e,this._outputLogger,this._inLoggingOnlyMode,this.getBuiltInCommonProperties(e),{isUsageEnabled:s.isUsageEnabled,isErrorsEnabled:s.isErrorsEnabled}),n=this._telemetryLoggers.get(e.identifier.value)??[];return this._telemetryLoggers.set(e.identifier.value,[...n,r]),r.apiTelemetryLogger}$initializeTelemetryLevel(e,t,i){this._level=e,this._productConfig=i??{usage:!0,error:!0}}getBuiltInCommonProperties(e){const t=Object.create(null);switch(t["common.extname"]=`${e.publisher}.${e.name}`,t["common.extversion"]=e.version,t["common.vscodemachineid"]=this.initData.telemetryInfo.machineId,t["common.vscodesessionid"]=this.initData.telemetryInfo.sessionId,t["common.vscodecommithash"]=this.initData.commit,t["common.sqmid"]=this.initData.telemetryInfo.sqmId,t["common.devDeviceId"]=this.initData.telemetryInfo.devDeviceId,t["common.vscodeversion"]=this.initData.version,t["common.isnewappinstall"]=Ou(this.initData.telemetryInfo.firstSessionDate),t["common.product"]=this.initData.environment.appHost,this.initData.uiKind){case vn.Web:t["common.uikind"]="web";break;case vn.Desktop:t["common.uikind"]="desktop";break;default:t["common.uikind"]="unknown"}return t["common.remotename"]=nl(gf(this.initData.remote.authority)),t}$onDidChangeTelemetryLevel(e){this._oldTelemetryEnablement=this.getTelemetryConfiguration(),this._level=e;const t=this.getTelemetryDetails();this._telemetryLoggers.forEach((i,s)=>{const r=i.filter(n=>!n.isDisposed);r.length===0?this._telemetryLoggers.delete(s):this._telemetryLoggers.set(s,r)}),this._telemetryLoggers.forEach(i=>{for(const s of i)s.updateTelemetryEnablements(t.isUsageEnabled,t.isErrorsEnabled)}),this._oldTelemetryEnablement!==this.getTelemetryConfiguration()&&this._onDidChangeTelemetryEnabled.fire(this.getTelemetryConfiguration()),this._onDidChangeTelemetryConfiguration.fire(this.getTelemetryDetails())}onExtensionError(e,t){const s=this._telemetryLoggers.get(e.value)?.filter(n=>!n.isDisposed);if(!s)return this._telemetryLoggers.delete(e.value),!1;let r=!1;for(const n of s)n.ignoreUnhandledExtHostErrors||(n.logError(t),r=!0);return r}};cc=L([E(1,Se),E(2,fi)],cc);class Nu{static validateSender(e){if(typeof e!="object")throw new TypeError("TelemetrySender argument is invalid");if(typeof e.sendEventData!="function")throw new TypeError("TelemetrySender.sendEventData must be a function");if(typeof e.sendErrorData!="function")throw new TypeError("TelemetrySender.sendErrorData must be a function");if(typeof e.flush<"u"&&typeof e.flush!="function")throw new TypeError("TelemetrySender.flush must be a function or undefined")}constructor(e,t,i,s,r,n,o){this._extension=i,this._logger=s,this._inLoggingOnlyMode=r,this._commonProperties=n,this._onDidChangeEnableStates=new P,this.ignoreUnhandledExtHostErrors=t?.ignoreUnhandledErrors??!1,this._ignoreBuiltinCommonProperties=t?.ignoreBuiltInCommonProperties??!1,this._additionalCommonProperties=t?.additionalCommonProperties,this._sender=e,this._telemetryEnablements={isUsageEnabled:o.isUsageEnabled,isErrorsEnabled:o.isErrorsEnabled}}updateTelemetryEnablements(e,t){this._apiObject&&(this._telemetryEnablements={isUsageEnabled:e,isErrorsEnabled:t},this._onDidChangeEnableStates.fire(this._apiObject))}mixInCommonPropsAndCleanData(e){let t="properties"in e?e.properties??{}:e;return t=gd(t,[]),this._additionalCommonProperties&&(t=Vs(t,this._additionalCommonProperties)),this._ignoreBuiltinCommonProperties||(t=Vs(t,this._commonProperties)),"properties"in e?e.properties=t:e=t,e}logEvent(e,t){this._sender&&(this._extension.publisher==="vscode"?e=this._extension.name+"/"+e:e=this._extension.identifier.value+"/"+e,t=this.mixInCommonPropsAndCleanData(t||{}),this._inLoggingOnlyMode||this._sender?.sendEventData(e,t),this._logger.trace(e,t))}logUsage(e,t){this._telemetryEnablements.isUsageEnabled&&this.logEvent(e,t)}logError(e,t){if(!(!this._telemetryEnablements.isErrorsEnabled||!this._sender))if(typeof e=="string")this.logEvent(e,t);else{const i={name:e.name,message:e.message,stack:e.stack,cause:e.cause},s=gd(i,[]),r=new Error(s.message,{cause:s.cause});r.stack=s.stack,r.name=s.name,t=this.mixInCommonPropsAndCleanData(t||{}),this._inLoggingOnlyMode||this._sender.sendErrorData(r,t),this._logger.trace("exception",t)}}get apiTelemetryLogger(){if(!this._apiObject){const e=this,t={logUsage:e.logUsage.bind(e),get isUsageEnabled(){return e._telemetryEnablements.isUsageEnabled},get isErrorsEnabled(){return e._telemetryEnablements.isErrorsEnabled},logError:e.logError.bind(e),dispose:e.dispose.bind(e),onDidChangeEnableStates:e._onDidChangeEnableStates.event.bind(e)};this._apiObject=Object.freeze(t)}return this._apiObject}get isDisposed(){return!this._sender}dispose(){if(this._sender?.flush){let e=this._sender;this._sender=void 0,Promise.resolve(e.flush()).then(e=void 0),this._apiObject=void 0}else this._sender=void 0}}function Ou(a){const e=Date.now()-new Date(a).getTime();return isNaN(e)?!1:e<1e3*60*60*24}const Aa=ee("IExtHostTelemetry");let co=class{#e;#t;#i;constructor(e,t,i){this._commands=new Map,this._apiCommands=new Map,this.#e=e.getProxy(k.MainThreadCommands),this._logService=t,this.#i=i,this.#t=e.getProxy(k.MainThreadTelemetry),this.converter=new oy(this,s=>{const r=this._apiCommands.get(s);return r?.result===M.Void?r:void 0},t),this._argumentProcessors=[{processArgument(s){return ze(s)}},{processArgument(s){return md(s,function(r){if(Ft.isIRange(r))return $.to(r);if(_f.isIPosition(r))return Z.to(r);if(Ft.isIRange(r.range)&&v.isUri(r.uri))return tt.to(r);if(r instanceof be)return r.buffer.buffer;if(!Array.isArray(r))return r})}}]}registerArgumentProcessor(e){this._argumentProcessors.push(e)}registerApiCommand(e){const t=this.registerCommand(!1,e.id,async(...i)=>{const s=e.args.map((n,o)=>{if(!n.validate(i[o]))throw new Error(`Invalid argument '${n.name}' when running '${e.id}', received: ${typeof i[o]=="object"?JSON.stringify(i[o],null,"	"):i[o]} `);return n.convert(i[o])}),r=await this.executeCommand(e.internalId,...s);return e.result.convert(r,i,this.converter)},void 0,{description:e.description,args:e.args,returns:e.result.description});return this._apiCommands.set(e.id,e),new V(()=>{t.dispose(),this._apiCommands.delete(e.id)})}registerCommand(e,t,i,s,r,n){if(this._logService.trace("ExtHostCommands#registerCommand",t),!t.trim().length)throw new Error("invalid id");if(this._commands.has(t))throw new Error(`command '${t}' already exists`);return this._commands.set(t,{callback:i,thisArg:s,metadata:r,extension:n}),e&&this.#e.$registerCommand(t),new V(()=>{this._commands.delete(t)&&e&&this.#e.$unregisterCommand(t)})}executeCommand(e,...t){return this._logService.trace("ExtHostCommands#executeCommand",e),this._doExecuteCommand(e,t,!0)}async _doExecuteCommand(e,t,i){if(this._commands.has(e))return this.#e.$fireCommandActivationEvent(e),this._executeContributedCommand(e,t,!1);{let s=!1;const r=md(t,function(n){if(n instanceof Fe)return Z.from(n);if(n instanceof de)return $.from(n);if(n instanceof li)return tt.from(n);if(yr.isNotebookRange(n))return bt.from(n);if(n instanceof ArrayBuffer)return s=!0,be.wrap(new Uint8Array(n));if(n instanceof Uint8Array)return s=!0,be.wrap(n);if(n instanceof be)return s=!0,n;if(!Array.isArray(n))return n});try{const n=await this.#e.$executeCommand(e,s?new Ke(r):r,i);return ze(n)}catch(n){if(n instanceof Error&&n.message==="$executeCommand:retry")return this._doExecuteCommand(e,t,!1);throw n}}}async _executeContributedCommand(e,t,i){const s=this._commands.get(e);if(!s)throw new Error("Unknown command");const{callback:r,thisArg:n,metadata:o}=s;if(o?.args)for(let c=0;c<o.args.length;c++)try{mf(t[c],o.args[c].constraint)}catch{throw new Error(`Running the contributed command: '${e}' failed. Illegal argument '${o.args[c].name}' - ${o.args[c].description}`)}const d=di.create();try{return await r.apply(n,t)}catch(c){if(e===this.converter.delegatingCommandId){const h=this.converter.getActualCommand(...t);h&&(e=h.command)}if(Qi(c)||this._logService.error(c,e,s.extension?.identifier),!i)throw c;if(s.extension?.identifier){const h=this.#i.onExtensionError(s.extension.identifier,c);this._logService.trace("forwarded error to extension?",h,s.extension?.identifier)}throw new class extends Error{constructor(){super(vr(c)),this.id=e,this.source=s.extension?.displayName??s.extension?.name}}}finally{this._reportTelemetry(s,e,d.elapsed())}}_reportTelemetry(e,t,i){e.extension&&this.#t.$publicLog2("Extension:ActionExecuted",{extensionId:e.extension.identifier.value,id:new ol(t),duration:i})}$executeContributedCommand(e,...t){this._logService.trace("ExtHostCommands#$executeContributedCommand",e);const i=this._commands.get(e);return i?(t=t.map(s=>this._argumentProcessors.reduce((r,n)=>n.processArgument(r,i.extension),s)),this._executeContributedCommand(e,t,!0)):Promise.reject(new Error(`Contributed command '${e}' does not exist.`))}getCommands(e=!1){return this._logService.trace("ExtHostCommands#getCommands",e),this.#e.$getCommands().then(t=>(e&&(t=t.filter(i=>i[0]!=="_")),t))}$getContributedCommandMetadata(){const e=Object.create(null);for(const[t,i]of this._commands){const{metadata:s}=i;s&&(e[t]=s)}return Promise.resolve(e)}};co=L([E(0,j),E(1,re),E(2,Aa)],co);const Ut=ee("IExtHostCommands");class oy{constructor(e,t,i){this._commands=e,this._lookupApiCommand=t,this._logService=i,this.delegatingCommandId=`__vsc${it()}`,this._cache=new Map,this._cachIdPool=0,this._commands.registerCommand(!0,this.delegatingCommandId,this._executeConvertedCommand,this)}toInternal(e,t){if(!e)return;const i={$ident:void 0,id:e.command,title:e.title,tooltip:e.tooltip};if(!e.command)return i;const s=this._lookupApiCommand(e.command);if(s)i.id=s.internalId,i.arguments=s.args.map((r,n)=>r.convert(e.arguments&&e.arguments[n]));else if(is(e.arguments)){const r=`${e.command} /${++this._cachIdPool}`;this._cache.set(r,e),t.add(B(()=>{this._cache.delete(r),this._logService.trace("CommandsConverter#DISPOSE",r)})),i.$ident=r,i.id=this.delegatingCommandId,i.arguments=[r],this._logService.trace("CommandsConverter#CREATE",e.command,r)}return i}fromInternal(e){return typeof e.$ident=="string"?this._cache.get(e.$ident):{command:e.id,title:e.title,arguments:e.arguments}}getActualCommand(...e){return this._cache.get(e[0])}_executeConvertedCommand(...e){const t=this.getActualCommand(...e);return this._logService.trace("CommandsConverter#EXECUTE",e[0],t?t.command:"MISSING"),t?this._commands.executeCommand(t.command,...t.arguments||[]):Promise.reject(`Actual command not found, wanted to execute ${e[0]}`)}}class D{static{this.Uri=new D("uri","Uri of a text document",e=>v.isUri(e),e=>e)}static{this.Position=new D("position","A position in a text document",e=>Fe.isPosition(e),Z.from)}static{this.Range=new D("range","A range in a text document",e=>de.isRange(e),$.from)}static{this.Selection=new D("selection","A selection in a text document",e=>ci.isSelection(e),et.from)}static{this.Number=new D("number","",e=>typeof e=="number",e=>e)}static{this.String=new D("string","",e=>typeof e=="string",e=>e)}static Arr(e){return new D(`${e.name}_array`,`Array of ${e.name}, ${e.description}`,t=>Array.isArray(t)&&t.every(i=>e.validate(i)),t=>t.map(i=>e.convert(i)))}static{this.CallHierarchyItem=new D("item","A call hierarchy item",e=>e instanceof wl,_a.from)}static{this.TypeHierarchyItem=new D("item","A type hierarchy item",e=>e instanceof xl,Ni.from)}static{this.TestItem=new D("testItem","A VS Code TestItem",e=>e instanceof Ot,ns.from)}static{this.TestProfile=new D("testProfile","A VS Code test profile",e=>e instanceof bl,Rp.from)}constructor(e,t,i,s){this.name=e,this.description=t,this.validate=i,this.convert=s}optional(){return new D(this.name,`(optional) ${this.description}`,e=>e==null||this.validate(e),e=>e===void 0?void 0:e===null?null:this.convert(e))}with(e,t){return new D(e??this.name,t??this.description,this.validate,this.convert)}}class M{static{this.Void=new M("no result",e=>e)}constructor(e,t){this.description=e,this.convert=t}}class H{constructor(e,t,i,s,r){this.id=e,this.internalId=t,this.description=i,this.args=s,this.result=r}}const lo=new Map;function ay(a,e){e?lo.set(a,e):lo.delete(a)}function dy(a){return lo.get(a)}class cy extends vf{constructor(e,t,i,s,r,n,o,d){super(t,i,s,r),this._proxy=e,this._languageId=n,this._isDirty=o,this._encoding=d,this._isDisposed=!1}dispose(){Me(!this._isDisposed),this._isDisposed=!0,this._isDirty=!1}equalLines(e){return da(this._lines,e)}get document(){if(!this._document){const e=this;this._document={get uri(){return e._uri},get fileName(){return e._uri.fsPath},get isUntitled(){return e._uri.scheme===q.untitled},get languageId(){return e._languageId},get version(){return e._versionId},get isClosed(){return e._isDisposed},get isDirty(){return e._isDirty},get encoding(){return e._encoding},save(){return e._save()},getText(t){return t?e._getTextInRange(t):e.getText()},get eol(){return e._eol===`
`?Yi.LF:Yi.CRLF},get lineCount(){return e._lines.length},lineAt(t){return e._lineAt(t)},offsetAt(t){return e._offsetAt(t)},positionAt(t){return e._positionAt(t)},validateRange(t){return e._validateRange(t)},validatePosition(t){return e._validatePosition(t)},getWordRangeAtPosition(t,i){return e._getWordRangeAtPosition(t,i)},[Symbol.for("debug.description")](){return`TextDocument(${e._uri.toString()})`}}}return Object.freeze(this._document)}_acceptLanguageId(e){Me(!this._isDisposed),this._languageId=e}_acceptIsDirty(e){Me(!this._isDisposed),this._isDirty=e}_acceptEncoding(e){Me(!this._isDisposed),this._encoding=e}_save(){return this._isDisposed?Promise.reject(new Error("Document has been closed")):this._proxy.$trySaveDocument(this._uri)}_getTextInRange(e){const t=this._validateRange(e);if(t.isEmpty)return"";if(t.isSingleLine)return this._lines[t.start.line].substring(t.start.character,t.end.character);const i=this._eol,s=t.start.line,r=t.end.line,n=[];n.push(this._lines[s].substring(t.start.character));for(let o=s+1;o<r;o++)n.push(this._lines[o]);return n.push(this._lines[r].substring(0,t.end.character)),n.join(i)}_lineAt(e){let t;if(e instanceof Fe?t=e.line:typeof e=="number"&&(t=e),typeof t!="number"||t<0||t>=this._lines.length||Math.floor(t)!==t)throw new Error("Illegal value for `line`");return new ly(t,this._lines[t],t===this._lines.length-1)}_offsetAt(e){return e=this._validatePosition(e),this._ensureLineStarts(),this._lineStarts.getPrefixSum(e.line-1)+e.character}_positionAt(e){e=Math.floor(e),e=Math.max(0,e),this._ensureLineStarts();const t=this._lineStarts.getIndexOf(e),i=this._lines[t.index].length;return new Fe(t.index,Math.min(t.remainder,i))}_validateRange(e){if(!(e instanceof de))throw new Error("Invalid argument");const t=this._validatePosition(e.start),i=this._validatePosition(e.end);return t===e.start&&i===e.end?e:new de(t.line,t.character,i.line,i.character)}_validatePosition(e){if(!(e instanceof Fe))throw new Error("Invalid argument");if(this._lines.length===0)return e.with(0,0);let{line:t,character:i}=e,s=!1;if(t<0)t=0,i=0,s=!0;else if(t>=this._lines.length)t=this._lines.length-1,i=this._lines[t].length,s=!0;else{const r=this._lines[t].length;i<0?(i=0,s=!0):i>r&&(i=r,s=!0)}return s?new Fe(t,i):e}_getWordRangeAtPosition(e,t){const i=this._validatePosition(e);if(!t)t=dy(this._languageId);else if(al(t))throw new Error(`[getWordRangeAtPosition]: ignoring custom regexp '${t.source}' because it matches the empty string.`);const s=yf(i.character+1,wf(t),this._lines[i.line],0);if(s)return new de(i.line,s.startColumn-1,i.line,s.endColumn-1)}}class ly{constructor(e,t,i){this._line=e,this._text=t,this._isLastLine=i}get lineNumber(){return this._line}get text(){return this._text}get range(){return new de(this._line,0,this._line,this._text.length)}get rangeIncludingLineBreak(){return this._isLastLine?this.range:new de(this._line,0,this._line+1,0)}get firstNonWhitespaceCharacterIndex(){return/^(\s*)/.exec(this._text)[1].length}get isEmptyOrWhitespace(){return this.firstNonWhitespaceCharacterIndex===this._text.length}}class $a{static{this._Keys=new ca("TextEditorDecorationType")}constructor(e,t,i){const s=$a._Keys.nextId();e.$registerTextEditorDecorationType(t.identifier,s,Ap.from(i)),this.value=Object.freeze({key:s,dispose(){e.$removeTextEditorDecorationType(s)}})}}class uy{constructor(e,t){this._collectedEdits=[],this._setEndOfLine=void 0,this._finalized=!1,this._document=e,this._documentVersionId=e.version,this._undoStopBefore=t.undoStopBefore,this._undoStopAfter=t.undoStopAfter}finalize(){return this._finalized=!0,{documentVersionId:this._documentVersionId,edits:this._collectedEdits,setEndOfLine:this._setEndOfLine,undoStopBefore:this._undoStopBefore,undoStopAfter:this._undoStopAfter}}_throwIfFinalized(){if(this._finalized)throw new Error("Edit is only valid while callback runs")}replace(e,t){this._throwIfFinalized();let i=null;if(e instanceof Fe)i=new de(e,e);else if(e instanceof de)i=e;else throw new Error("Unrecognized location");this._pushEdit(i,t,!1)}insert(e,t){this._throwIfFinalized(),this._pushEdit(new de(e,e),t,!0)}delete(e){this._throwIfFinalized();let t=null;if(e instanceof de)t=e;else throw new Error("Unrecognized location");this._pushEdit(t,null,!0)}_pushEdit(e,t,i){const s=this._document.validateRange(e);this._collectedEdits.push({range:s,text:t,forceMoveMarkers:i})}setEndOfLine(e){if(this._throwIfFinalized(),e!==Yi.LF&&e!==Yi.CRLF)throw zs("endOfLine");this._setEndOfLine=e}}class hy{constructor(e,t,i,s){this._proxy=e,this._id=t,this._accept(i),this._logService=s;const r=this;this.value={get tabSize(){return r._tabSize},set tabSize(n){r._setTabSize(n)},get indentSize(){return r._indentSize},set indentSize(n){r._setIndentSize(n)},get insertSpaces(){return r._insertSpaces},set insertSpaces(n){r._setInsertSpaces(n)},get cursorStyle(){return r._cursorStyle},set cursorStyle(n){r._setCursorStyle(n)},get lineNumbers(){return r._lineNumbers},set lineNumbers(n){r._setLineNumbers(n)}}}_accept(e){this._tabSize=e.tabSize,this._indentSize=e.indentSize,this._originalIndentSize=e.originalIndentSize,this._insertSpaces=e.insertSpaces,this._cursorStyle=e.cursorStyle,this._lineNumbers=Ps.to(e.lineNumbers)}_validateTabSize(e){if(e==="auto")return"auto";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setTabSize(e){const t=this._validateTabSize(e);if(t!==null){if(typeof t=="number"){if(this._tabSize===t)return;this._tabSize=t}this._warnOnError("setTabSize",this._proxy.$trySetOptions(this._id,{tabSize:t}))}}_validateIndentSize(e){if(e==="tabSize")return"tabSize";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setIndentSize(e){const t=this._validateIndentSize(e);if(t!==null){if(typeof t=="number"){if(this._originalIndentSize===t)return;this._indentSize=t,this._originalIndentSize=t}this._warnOnError("setIndentSize",this._proxy.$trySetOptions(this._id,{indentSize:t}))}}_validateInsertSpaces(e){return e==="auto"?"auto":e==="false"?!1:!!e}_setInsertSpaces(e){const t=this._validateInsertSpaces(e);if(typeof t=="boolean"){if(this._insertSpaces===t)return;this._insertSpaces=t}this._warnOnError("setInsertSpaces",this._proxy.$trySetOptions(this._id,{insertSpaces:t}))}_setCursorStyle(e){this._cursorStyle!==e&&(this._cursorStyle=e,this._warnOnError("setCursorStyle",this._proxy.$trySetOptions(this._id,{cursorStyle:e})))}_setLineNumbers(e){this._lineNumbers!==e&&(this._lineNumbers=e,this._warnOnError("setLineNumbers",this._proxy.$trySetOptions(this._id,{lineNumbers:Ps.from(e)})))}assign(e){const t={};let i=!1;if(typeof e.tabSize<"u"){const s=this._validateTabSize(e.tabSize);s==="auto"?(i=!0,t.tabSize=s):typeof s=="number"&&this._tabSize!==s&&(this._tabSize=s,i=!0,t.tabSize=s)}if(typeof e.indentSize<"u"){const s=this._validateIndentSize(e.indentSize);s==="tabSize"?(i=!0,t.indentSize=s):typeof s=="number"&&this._originalIndentSize!==s&&(this._indentSize=s,this._originalIndentSize=s,i=!0,t.indentSize=s)}if(typeof e.insertSpaces<"u"){const s=this._validateInsertSpaces(e.insertSpaces);s==="auto"?(i=!0,t.insertSpaces=s):this._insertSpaces!==s&&(this._insertSpaces=s,i=!0,t.insertSpaces=s)}typeof e.cursorStyle<"u"&&this._cursorStyle!==e.cursorStyle&&(this._cursorStyle=e.cursorStyle,i=!0,t.cursorStyle=e.cursorStyle),typeof e.lineNumbers<"u"&&this._lineNumbers!==e.lineNumbers&&(this._lineNumbers=e.lineNumbers,i=!0,t.lineNumbers=Ps.from(e.lineNumbers)),i&&this._warnOnError("setOptions",this._proxy.$trySetOptions(this._id,t))}_warnOnError(e,t){t.catch(i=>{this._logService.warn(`ExtHostTextEditorOptions '${e}' failed:'`),this._logService.warn(i)})}}class fy{constructor(e,t,i,s,r,n,o,d){this.id=e,this._proxy=t,this._logService=i,this._disposed=!1,this._hasDecorationsForKey=new Set,this._selections=r,this._options=new hy(this._proxy,this.id,n,i),this._visibleRanges=o,this._viewColumn=d;const c=this;this.value=Object.freeze({get document(){return s.value},set document(h){throw new Rt("document")},get selection(){return c._selections&&c._selections[0]},set selection(h){if(!(h instanceof ci))throw zs("selection");c._selections=[h],c._trySetSelection()},get selections(){return c._selections},set selections(h){if(!Array.isArray(h)||h.some(g=>!(g instanceof ci)))throw zs("selections");c._selections=h,c._trySetSelection()},get visibleRanges(){return c._visibleRanges},set visibleRanges(h){throw new Rt("visibleRanges")},get diffInformation(){return c._diffInformation},get options(){return c._options.value},set options(h){c._disposed||c._options.assign(h)},get viewColumn(){return c._viewColumn},set viewColumn(h){throw new Rt("viewColumn")},edit(h,g={undoStopBefore:!0,undoStopAfter:!0}){if(c._disposed)return Promise.reject(new Error("TextEditor#edit not possible on closed editors"));const m=new uy(s.value,g);return h(m),c._applyEdit(m)},insertSnippet(h,g,m={undoStopBefore:!0,undoStopAfter:!0}){if(c._disposed)return Promise.reject(new Error("TextEditor#insertSnippet not possible on closed editors"));let l;if(!g||Array.isArray(g)&&g.length===0)l=c._selections.map(f=>$.from(f));else if(g instanceof Fe){const{lineNumber:f,column:_}=Z.from(g);l=[{startLineNumber:f,startColumn:_,endLineNumber:f,endColumn:_}]}else if(g instanceof de)l=[$.from(g)];else{l=[];for(const f of g)if(f instanceof de)l.push($.from(f));else{const{lineNumber:_,column:x}=Z.from(f);l.push({startLineNumber:_,startColumn:x,endLineNumber:_,endColumn:x})}}return m.keepWhitespace===void 0&&(m.keepWhitespace=!1),t.$tryInsertSnippet(e,s.value.version,h.value,l,m)},setDecorations(h,g){const m=g.length===0;m&&!c._hasDecorationsForKey.has(h.key)||(m?c._hasDecorationsForKey.delete(h.key):c._hasDecorationsForKey.add(h.key),c._runOnProxy(()=>{if($p(g))return t.$trySetDecorations(e,h.key,Mp(g));{const l=new Array(4*g.length);for(let f=0,_=g.length;f<_;f++){const x=g[f];l[4*f]=x.start.line+1,l[4*f+1]=x.start.character+1,l[4*f+2]=x.end.line+1,l[4*f+3]=x.end.character+1}return t.$trySetDecorationsFast(e,h.key,l)}}))},revealRange(h,g){c._runOnProxy(()=>t.$tryRevealRange(e,$.from(h),g||El.Default))},show(h){t.$tryShowEditor(e,ye.from(h))},hide(){t.$tryHideEditor(e)},[Symbol.for("debug.description")](){return`TextEditor(${this.document.uri.toString()})`}})}dispose(){Me(!this._disposed),this._disposed=!0}_acceptOptions(e){Me(!this._disposed),this._options._accept(e)}_acceptVisibleRanges(e){Me(!this._disposed),this._visibleRanges=e}_acceptViewColumn(e){Me(!this._disposed),this._viewColumn=e}_acceptSelections(e){Me(!this._disposed),this._selections=e}_acceptDiffInformation(e){Me(!this._disposed),this._diffInformation=e}async _trySetSelection(){const e=this._selections.map(et.from);return await this._runOnProxy(()=>this._proxy.$trySetSelections(this.id,e)),this.value}_applyEdit(e){const t=e.finalize();if(t.edits.length===0&&!t.setEndOfLine)return Promise.resolve(!0);const i=t.edits.map(r=>r.range);i.sort((r,n)=>r.end.line===n.end.line?r.end.character===n.end.character?r.start.line===n.start.line?r.start.character-n.start.character:r.start.line-n.start.line:r.end.character-n.end.character:r.end.line-n.end.line);for(let r=0,n=i.length-1;r<n;r++){const o=i[r].end;if(i[r+1].start.isBefore(o))return Promise.reject(new Error("Overlapping ranges are not allowed!"))}const s=t.edits.map(r=>({range:$.from(r.range),text:r.text,forceMoveMarkers:r.forceMoveMarkers}));return this._proxy.$tryApplyEdits(this.id,t.documentVersionId,s,{setEndOfLine:typeof t.setEndOfLine=="number"?Sl.from(t.setEndOfLine):void 0,undoStopBefore:t.undoStopBefore,undoStopAfter:t.undoStopAfter})}_runOnProxy(e){return this._disposed?(this._logService.warn("TextEditor is closed/disposed"),Promise.resolve(void 0)):e().then(()=>this,t=>(t instanceof Error&&t.name==="DISPOSED"||this._logService.warn(t),null))}}class py{constructor(e){this.value=e,this._count=0}ref(){this._count++}unref(){return--this._count===0}}let uo=class{constructor(e,t){this._extHostRpc=e,this._logService=t,this._activeEditorId=null,this._editors=new Map,this._documents=new Ye,this._onDidAddDocuments=new P,this._onDidRemoveDocuments=new P,this._onDidChangeVisibleTextEditors=new P,this._onDidChangeActiveTextEditor=new P,this.onDidAddDocuments=this._onDidAddDocuments.event,this.onDidRemoveDocuments=this._onDidRemoveDocuments.event,this.onDidChangeVisibleTextEditors=this._onDidChangeVisibleTextEditors.event,this.onDidChangeActiveTextEditor=this._onDidChangeActiveTextEditor.event}$acceptDocumentsAndEditorsDelta(e){this.acceptDocumentsAndEditorsDelta(e)}acceptDocumentsAndEditorsDelta(e){const t=[],i=[],s=[];if(e.removedDocuments)for(const r of e.removedDocuments){const n=v.revive(r),o=this._documents.get(n);o?.unref()&&(this._documents.delete(n),t.push(o.value))}if(e.addedDocuments)for(const r of e.addedDocuments){const n=v.revive(r.uri);let o=this._documents.get(n);if(o&&n.scheme!==q.vscodeNotebookCell&&n.scheme!==q.vscodeInteractiveInput)throw new Error(`document '${n} already exists!'`);o||(o=new py(new cy(this._extHostRpc.getProxy(k.MainThreadDocuments),n,r.lines,r.EOL,r.versionId,r.languageId,r.isDirty,r.encoding)),this._documents.set(n,o),i.push(o.value)),o.ref()}if(e.removedEditors)for(const r of e.removedEditors){const n=this._editors.get(r);this._editors.delete(r),n&&s.push(n)}if(e.addedEditors)for(const r of e.addedEditors){const n=v.revive(r.documentUri);Me(this._documents.has(n),`document '${n}' does not exist`),Me(!this._editors.has(r.id),`editor '${r.id}' already exists!`);const o=this._documents.get(n).value,d=new fy(r.id,this._extHostRpc.getProxy(k.MainThreadTextEditors),this._logService,new Li(()=>o.document),r.selections.map(et.to),r.options,r.visibleRanges.map(c=>$.to(c)),typeof r.editorPosition=="number"?ye.to(r.editorPosition):void 0);this._editors.set(r.id,d)}e.newActiveEditor!==void 0&&(Me(e.newActiveEditor===null||this._editors.has(e.newActiveEditor),`active editor '${e.newActiveEditor}' does not exist`),this._activeEditorId=e.newActiveEditor),qs(t),qs(s),e.removedDocuments&&this._onDidRemoveDocuments.fire(t),e.addedDocuments&&this._onDidAddDocuments.fire(i),(e.removedEditors||e.addedEditors)&&this._onDidChangeVisibleTextEditors.fire(this.allEditors().map(r=>r.value)),e.newActiveEditor!==void 0&&this._onDidChangeActiveTextEditor.fire(this.activeEditor())}getDocument(e){return this._documents.get(e)?.value}allDocuments(){return Ji.map(this._documents.values(),e=>e.value)}getEditor(e){return this._editors.get(e)}activeEditor(e){if(!this._activeEditorId)return;const t=this._editors.get(this._activeEditorId);return e?t:t?.value}allEditors(){return[...this._editors.values()]}};uo=L([E(0,j),E(1,re)],uo);const gi=ee("IExtHostDocumentsAndEditors"),mi=ee("IExtHostTerminalService");class lc extends X{constructor(e,t,i,s){super(),this._proxy=e,this._id=t,this._creationOptions=i,this._name=s,this._disposed=!1,this._state={isInteractedWith:!1,shell:void 0},this.isOpen=!1,this._onWillDispose=this._register(new P),this.onWillDispose=this._onWillDispose.event,this._creationOptions=Object.freeze(this._creationOptions),this._pidPromise=new Promise(n=>this._pidPromiseComplete=n);const r=this;this.value={get name(){return r._name||""},get processId(){return r._pidPromise},get creationOptions(){return r._creationOptions},get exitStatus(){return r._exitStatus},get state(){return r._state},get selection(){return r._selection},get shellIntegration(){return r.shellIntegration},sendText(n,o=!0){r._checkDisposed(),r._proxy.$sendText(r._id,n,o)},show(n){r._checkDisposed(),r._proxy.$show(r._id,n)},hide(){r._checkDisposed(),r._proxy.$hide(r._id)},dispose(){r._disposed||(r._disposed=!0,r._proxy.$dispose(r._id))},get dimensions(){if(!(r._cols===void 0||r._rows===void 0))return{columns:r._cols,rows:r._rows}}}}dispose(){this._onWillDispose.fire(),super.dispose()}async create(e,t){if(typeof this._id!="string")throw new Error("Terminal has already been created");await this._proxy.$createTerminal(this._id,{name:e.name,shellPath:e.shellPath??void 0,shellArgs:e.shellArgs??void 0,cwd:e.cwd??t?.cwd??void 0,env:e.env??void 0,icon:Uu(e.iconPath)??void 0,color:cn.isThemeColor(e.color)?e.color.id:void 0,initialText:e.message??void 0,strictEnv:e.strictEnv??void 0,hideFromUser:e.hideFromUser??void 0,forceShellIntegration:t?.forceShellIntegration??void 0,isFeatureTerminal:t?.isFeatureTerminal??void 0,isExtensionOwnedTerminal:!0,useShellEnvironment:t?.useShellEnvironment??void 0,location:t?.location||this._serializeParentTerminal(e.location,t?.resolvedExtHostIdentifier),isTransient:e.isTransient??void 0})}async createExtensionTerminal(e,t,i,s,r){if(typeof this._id!="string")throw new Error("Terminal has already been created");if(await this._proxy.$createTerminal(this._id,{name:this._name,isExtensionCustomPtyTerminal:!0,icon:s,color:cn.isThemeColor(r)?r.id:void 0,location:t?.location||this._serializeParentTerminal(e,i),isTransient:!0}),typeof this._id=="string")throw new Error("Terminal creation failed");return this._id}_serializeParentTerminal(e,t){return typeof e=="object"?"parentTerminal"in e&&e.parentTerminal&&t?{parentTerminal:t}:"viewColumn"in e?{viewColumn:ye.from(e.viewColumn),preserveFocus:e.preserveFocus}:void 0:e}_checkDisposed(){if(this._disposed)throw new Error("Terminal has already been disposed")}set name(e){this._name=e}setExitStatus(e,t){this._exitStatus=Object.freeze({code:e,reason:t})}setDimensions(e,t){return e===this._cols&&t===this._rows||e===0||t===0?!1:(this._cols=e,this._rows=t,!0)}setInteractedWith(){return this._state.isInteractedWith?!1:(this._state={...this._state,isInteractedWith:!0},!0)}setShellType(e){return this._state.shell!==e?(this._state={...this._state,shell:e},!0):!1}setSelection(e){this._selection=e}_setProcessId(e){this._pidPromiseComplete?(this._pidPromiseComplete(e),this._pidPromiseComplete=void 0):this._pidPromise.then(t=>{t!==e&&(this._pidPromise=Promise.resolve(e))})}}class qr{get onProcessReady(){return this._onProcessReady.event}constructor(e){this._pty=e,this.id=0,this.shouldPersist=!1,this._onProcessData=new P,this.onProcessData=this._onProcessData.event,this._onProcessReady=new P,this._onDidChangeProperty=new P,this.onDidChangeProperty=this._onDidChangeProperty.event,this._onProcessExit=new P,this.onProcessExit=this._onProcessExit.event}refreshProperty(e){throw new Error(`refreshProperty is not suppported in extension owned terminals. property: ${e}`)}updateProperty(e,t){throw new Error(`updateProperty is not suppported in extension owned terminals. property: ${e}, value: ${t}`)}async start(){}shutdown(){this._pty.close()}input(e){this._pty.handleInput?.(e)}resize(e,t){this._pty.setDimensions?.({columns:e,rows:t})}clearBuffer(){}async processBinary(e){}acknowledgeDataEvent(e){}async setUnicodeVersion(e){}getInitialCwd(){return Promise.resolve("")}getCwd(){return Promise.resolve("")}startSendingEvents(e){this._pty.onDidWrite(t=>this._onProcessData.fire(t)),this._pty.onDidClose?.((t=void 0)=>{this._onProcessExit.fire(t===void 0?void 0:t)}),this._pty.onDidOverrideDimensions?.(t=>{t&&this._onDidChangeProperty.fire({type:Xs.OverrideDimensions,value:{cols:t.columns,rows:t.rows}})}),this._pty.onDidChangeName?.(t=>{this._onDidChangeProperty.fire({type:Xs.Title,value:t})}),this._pty.open(e||void 0),e&&this._pty.setDimensions?.(e),this._onProcessReady.fire({pid:-1,cwd:"",windowsPty:void 0})}}let gy=1,ho=class extends X{get activeTerminal(){return this._activeTerminal?.value}get terminals(){return this._terminals.map(e=>e.value)}constructor(e,t,i){super(),this._extHostCommands=t,this._terminals=[],this._terminalProcesses=new Map,this._terminalProcessDisposables={},this._extensionTerminalAwaitingStart={},this._getTerminalPromises={},this._environmentVariableCollections=new Map,this._lastQuickFixCommands=this._register(new At),this._linkProviders=new Set,this._completionProviders=new Map,this._profileProviders=new Map,this._quickFixProviders=new Map,this._terminalLinkCache=new Map,this._terminalLinkCancellationSource=new Map,this._onDidCloseTerminal=new P,this.onDidCloseTerminal=this._onDidCloseTerminal.event,this._onDidOpenTerminal=new P,this.onDidOpenTerminal=this._onDidOpenTerminal.event,this._onDidChangeActiveTerminal=new P,this.onDidChangeActiveTerminal=this._onDidChangeActiveTerminal.event,this._onDidChangeTerminalDimensions=new P,this.onDidChangeTerminalDimensions=this._onDidChangeTerminalDimensions.event,this._onDidChangeTerminalState=new P,this.onDidChangeTerminalState=this._onDidChangeTerminalState.event,this._onDidChangeShell=new P,this.onDidChangeShell=this._onDidChangeShell.event,this._onDidWriteTerminalData=new P({onWillAddFirstListener:()=>this._proxy.$startSendingDataEvents(),onDidRemoveLastListener:()=>this._proxy.$stopSendingDataEvents()}),this.onDidWriteTerminalData=this._onDidWriteTerminalData.event,this._onDidExecuteCommand=new P({onWillAddFirstListener:()=>this._proxy.$startSendingCommandEvents(),onDidRemoveLastListener:()=>this._proxy.$stopSendingCommandEvents()}),this.onDidExecuteTerminalCommand=this._onDidExecuteCommand.event,this._proxy=i.getProxy(k.MainThreadTerminalService),this._bufferer=new Hp(this._proxy.$sendProcessData),this._proxy.$registerProcessSupport(e),this._extHostCommands.registerArgumentProcessor({processArgument:s=>{const r=n=>{const o=n;return this.getTerminalById(o.instanceId)?.value};switch(s?.$mid){case xe.TerminalContext:return r(s);default:{if(Array.isArray(s))for(let n=0;n<s.length&&s[n].$mid===xe.TerminalContext;n++)s[n]=r(s[n]);return s}}}}),this._register({dispose:()=>{for(const[s,r]of this._terminalProcesses)r.shutdown(!0)}})}getDefaultShell(e){return(e?this._defaultAutomationProfile:this._defaultProfile)?.path||""}getDefaultShellArgs(e){return(e?this._defaultAutomationProfile:this._defaultProfile)?.args||[]}createExtensionTerminal(e,t){const i=new lc(this._proxy,it(),e,e.name),s=new qr(e.pty);return i.createExtensionTerminal(e.location,t,this._serializeParentTerminal(e,t).resolvedExtHostIdentifier,Uu(e.iconPath),_y(e.color)).then(r=>{const n=this._setupExtHostProcessListeners(r,s);this._terminalProcessDisposables[r]=n}),this._terminals.push(i),i.value}_serializeParentTerminal(e,t){if(t=t||{},e.location&&typeof e.location=="object"&&"parentTerminal"in e.location){const i=e.location.parentTerminal;if(i){const s=this._terminals.find(r=>r.value===i);s&&(t.resolvedExtHostIdentifier=s._id)}}else e.location&&typeof e.location!="object"?t.location=e.location:t.location&&typeof t.location=="object"&&"splitActiveTerminal"in t.location&&(t.location={splitActiveTerminal:!0});return t}attachPtyToTerminal(e,t){if(!this.getTerminalById(e))throw new Error(`Cannot resolve terminal with id ${e} for virtual process`);const s=new qr(t),r=this._setupExtHostProcessListeners(e,s);this._terminalProcessDisposables[e]=r}async $acceptActiveTerminalChanged(e){const t=this._activeTerminal;if(e===null){this._activeTerminal=void 0,t!==this._activeTerminal&&this._onDidChangeActiveTerminal.fire(this._activeTerminal);return}const i=this.getTerminalById(e);i&&(this._activeTerminal=i,t!==this._activeTerminal&&this._onDidChangeActiveTerminal.fire(this._activeTerminal.value))}async $acceptTerminalProcessData(e,t){const i=this.getTerminalById(e);i&&this._onDidWriteTerminalData.fire({terminal:i.value,data:t})}async $acceptTerminalDimensions(e,t,i){const s=this.getTerminalById(e);s&&s.setDimensions(t,i)&&this._onDidChangeTerminalDimensions.fire({terminal:s.value,dimensions:s.value.dimensions})}async $acceptDidExecuteCommand(e,t){const i=this.getTerminalById(e);i&&this._onDidExecuteCommand.fire({terminal:i.value,...t})}async $acceptTerminalMaximumDimensions(e,t,i){this._terminalProcesses.get(e)?.resize(t,i)}async $acceptTerminalTitleChange(e,t){const i=this.getTerminalById(e);i&&(i.name=t)}async $acceptTerminalClosed(e,t,i){const s=this._getTerminalObjectIndexById(this._terminals,e);if(s!==null){const r=this._terminals.splice(s,1)[0];r.setExitStatus(t,i),this._onDidCloseTerminal.fire(r.value)}}$acceptTerminalOpened(e,t,i,s){if(t){const o=this._getTerminalObjectIndexById(this._terminals,t);if(o!==null){this._terminals[o]._id=e,this._onDidOpenTerminal.fire(this.terminals[o]),this._terminals[o].isOpen=!0;return}}const r={name:s.name,shellPath:s.executable,shellArgs:s.args,cwd:typeof s.cwd=="string"?s.cwd:v.revive(s.cwd),env:s.env,hideFromUser:s.hideFromUser},n=new lc(this._proxy,e,r,i);this._terminals.push(n),this._onDidOpenTerminal.fire(n.value),n.isOpen=!0}async $acceptTerminalProcessId(e,t){this.getTerminalById(e)?._setProcessId(t)}async $startExtensionTerminal(e,t){const i=this.getTerminalById(e);if(!i)return{message:J(2569,"Could not find the terminal with id {0} on the extension host",e)};i.isOpen||await new Promise(r=>{const n=this.onDidOpenTerminal(async o=>{o===i.value&&(n.dispose(),r())})});const s=this._terminalProcesses.get(e);s?s.startSendingEvents(t):this._extensionTerminalAwaitingStart[e]={initialDimensions:t}}_setupExtHostProcessListeners(e,t){const i=new N;i.add(t.onProcessReady(r=>this._proxy.$sendProcessReady(e,r.pid,r.cwd,r.windowsPty))),i.add(t.onDidChangeProperty(r=>this._proxy.$sendProcessProperty(e,r))),this._bufferer.startBuffering(e,t.onProcessData),i.add(t.onProcessExit(r=>this._onProcessExit(e,r))),this._terminalProcesses.set(e,t);const s=this._extensionTerminalAwaitingStart[e];return s&&t instanceof qr&&(t.startSendingEvents(s.initialDimensions),delete this._extensionTerminalAwaitingStart[e]),i}$acceptProcessAckDataEvent(e,t){this._terminalProcesses.get(e)?.acknowledgeDataEvent(t)}$acceptProcessInput(e,t){this._terminalProcesses.get(e)?.input(t)}$acceptTerminalInteraction(e){const t=this.getTerminalById(e);t?.setInteractedWith()&&this._onDidChangeTerminalState.fire(t.value)}$acceptTerminalSelection(e,t){this.getTerminalById(e)?.setSelection(t)}$acceptProcessResize(e,t,i){try{this._terminalProcesses.get(e)?.resize(t,i)}catch(s){if(s.code!=="EPIPE"&&s.code!=="ERR_IPC_CHANNEL_CLOSED")throw s}}$acceptProcessShutdown(e,t){this._terminalProcesses.get(e)?.shutdown(t)}$acceptProcessRequestInitialCwd(e){this._terminalProcesses.get(e)?.getInitialCwd().then(t=>this._proxy.$sendProcessProperty(e,{type:Xs.InitialCwd,value:t}))}$acceptProcessRequestCwd(e){this._terminalProcesses.get(e)?.getCwd().then(t=>this._proxy.$sendProcessProperty(e,{type:Xs.Cwd,value:t}))}$acceptProcessRequestLatency(e){return Promise.resolve(e)}registerProfileProvider(e,t,i){if(this._profileProviders.has(t))throw new Error(`Terminal profile provider "${t}" already registered`);return this._profileProviders.set(t,i),this._proxy.$registerProfileProvider(t,e.identifier.value),new V(()=>{this._profileProviders.delete(t),this._proxy.$unregisterProfileProvider(t)})}registerTerminalCompletionProvider(e,t,...i){if(this._completionProviders.has(t.id))throw new Error(`Terminal completion provider "${t.id}" already registered`);return this._completionProviders.set(t.id,t),this._proxy.$registerCompletionProvider(t.id,e.identifier.value,...i),new V(()=>{this._completionProviders.delete(t.id),this._proxy.$unregisterCompletionProvider(t.id)})}async $provideTerminalCompletions(e,t){const i=new he().token;if(i.isCancellationRequested||!this.activeTerminal)return;const s=this._completionProviders.get(e);if(!s)return;const r=await s.provideTerminalCompletions(this.activeTerminal,t,i);if(r!=null)return Fp.from(r)}$acceptTerminalShellType(e,t){const i=this.getTerminalById(e);i?.setShellType(t)&&this._onDidChangeTerminalState.fire(i.value)}registerTerminalQuickFixProvider(e,t,i){if(this._quickFixProviders.has(e))throw new Error(`Terminal quick fix provider "${e}" is already registered`);return this._quickFixProviders.set(e,i),this._proxy.$registerQuickFixProvider(e,t),new V(()=>{this._quickFixProviders.delete(e),this._proxy.$unregisterQuickFixProvider(e)})}async $provideTerminalQuickFixes(e,t){const i=new he().token;if(i.isCancellationRequested)return;const s=this._quickFixProviders.get(e);if(!s)return;const r=await s.provideTerminalQuickFixes(t,i);if(r===null||Array.isArray(r)&&r.length===0)return;const n=new N;if(this._lastQuickFixCommands.value=n,!Array.isArray(r))return r?Ld.from(r,this._extHostCommands.converter,n):void 0;const o=[];for(const d of r){const c=Ld.from(d,this._extHostCommands.converter,n);c&&o.push(c)}return o}async $createContributedProfileTerminal(e,t){const i=new he().token;let s=await this._profileProviders.get(e)?.provideTerminalProfile(i);if(!i.isCancellationRequested){if(s&&!("options"in s)&&(s={options:s}),!s||!("options"in s))throw new Error(`No terminal profile options provided for id "${e}"`);if("pty"in s.options){this.createExtensionTerminal(s.options,t);return}this.createTerminalFromOptions(s.options,t)}}registerLinkProvider(e){return this._linkProviders.add(e),this._linkProviders.size===1&&this._proxy.$startLinkProvider(),new V(()=>{this._linkProviders.delete(e),this._linkProviders.size===0&&this._proxy.$stopLinkProvider()})}async $provideLinks(e,t){const i=this.getTerminalById(e);if(!i)return[];this._terminalLinkCache.delete(e),this._terminalLinkCancellationSource.get(e)?.dispose(!0);const r=new he;this._terminalLinkCancellationSource.set(e,r);const n=[],o={terminal:i.value,line:t},d=[];for(const g of this._linkProviders)d.push(xf.withAsyncBody(async m=>{r.token.onCancellationRequested(()=>m({provider:g,links:[]}));const l=await g.provideTerminalLinks(o,r.token)||[];r.token.isCancellationRequested||m({provider:g,links:l})}));const c=await Promise.all(d);if(r.token.isCancellationRequested)return[];const h=new Map;for(const g of c)g&&g.links.length>0&&n.push(...g.links.map(m=>{const l={id:gy++,startIndex:m.startIndex,length:m.length,label:m.tooltip};return h.set(l.id,{provider:g.provider,link:m}),l}));return this._terminalLinkCache.set(e,h),n}$activateLink(e,t){const i=this._terminalLinkCache.get(e)?.get(t);i&&i.provider.handleTerminalLink(i.link)}_onProcessExit(e,t){this._bufferer.stopBuffering(e),this._terminalProcesses.delete(e),delete this._extensionTerminalAwaitingStart[e];const i=this._terminalProcessDisposables[e];i&&(i.dispose(),delete this._terminalProcessDisposables[e]),this._proxy.$sendProcessExit(e,t)}getTerminalById(e){return this._getTerminalObjectById(this._terminals,e)}getTerminalIdByApiObject(e){const t=this._terminals.findIndex(i=>i.value===e);return t>=0?t:null}_getTerminalObjectById(e,t){const i=this._getTerminalObjectIndexById(e,t);return i!==null?e[i]:null}_getTerminalObjectIndexById(e,t){const i=e.findIndex(s=>s._id===t);return i>=0?i:null}getEnvironmentVariableCollection(e){let t=this._environmentVariableCollections.get(e.identifier.value);return t||(t=this._register(new uc),this._setEnvironmentVariableCollection(e.identifier.value,t)),t.getScopedEnvironmentVariableCollection(void 0)}_syncEnvironmentVariableCollection(e,t){const i=Lp(t.map),s=Np(t.descriptionMap);this._proxy.$setEnvironmentVariableCollection(e,t.persistent,i.length===0?void 0:i,s)}$initEnvironmentVariableCollections(e){e.forEach(t=>{const i=t[0],s=this._register(new uc(t[1]));this._setEnvironmentVariableCollection(i,s)})}$acceptDefaultProfile(e,t){const i=this._defaultProfile;this._defaultProfile=e,this._defaultAutomationProfile=t,i?.path!==e.path&&this._onDidChangeShell.fire(e.path)}_setEnvironmentVariableCollection(e,t){this._environmentVariableCollections.set(e,t),this._register(t.onDidChangeCollection(()=>{this._syncEnvironmentVariableCollection(e,t)}))}};ho=L([E(1,Ut),E(2,j)],ho);class uc extends X{get persistent(){return this._persistent}set persistent(e){this._persistent=e,this._onDidChangeCollection.fire()}get onDidChangeCollection(){return this._onDidChangeCollection&&this._onDidChangeCollection.event}constructor(e){super(),this.map=new Map,this.scopedCollections=new Map,this.descriptionMap=new Map,this._persistent=!0,this._onDidChangeCollection=new P,this.map=new Map(e)}getScopedEnvironmentVariableCollection(e){const t=this.getScopeKey(e);let i=this.scopedCollections.get(t);return i||(i=new my(this,e),this.scopedCollections.set(t,i),this._register(i.onDidChangeCollection(()=>this._onDidChangeCollection.fire()))),i}replace(e,t,i,s){this._setIfDiffers(e,{value:t,type:Ts.Replace,options:i??{applyAtProcessCreation:!0},scope:s})}append(e,t,i,s){this._setIfDiffers(e,{value:t,type:Ts.Append,options:i??{applyAtProcessCreation:!0},scope:s})}prepend(e,t,i,s){this._setIfDiffers(e,{value:t,type:Ts.Prepend,options:i??{applyAtProcessCreation:!0},scope:s})}_setIfDiffers(e,t){if(t.options&&t.options.applyAtProcessCreation===!1&&!t.options.applyAtShellIntegration)throw new Error("EnvironmentVariableMutatorOptions must apply at either process creation or shell integration");const i=this.getKey(e,t.scope),s=this.map.get(i),r=t.options?{applyAtProcessCreation:t.options.applyAtProcessCreation??!1,applyAtShellIntegration:t.options.applyAtShellIntegration??!1}:{applyAtProcessCreation:!0};if(!s||s.value!==t.value||s.type!==t.type||s.options?.applyAtProcessCreation!==r.applyAtProcessCreation||s.options?.applyAtShellIntegration!==r.applyAtShellIntegration||s.scope?.workspaceFolder?.index!==t.scope?.workspaceFolder?.index){const n=this.getKey(e,t.scope),o={variable:e,...t,options:r};this.map.set(n,o),this._onDidChangeCollection.fire()}}get(e,t){const i=this.getKey(e,t),s=this.map.get(i);return s?hc(s):void 0}getKey(e,t){const i=this.getScopeKey(t);return i.length?`${e}:::${i}`:e}getScopeKey(e){return this.getWorkspaceKey(e?.workspaceFolder)??""}getWorkspaceKey(e){return e?e.uri.toString():void 0}getVariableMap(e){const t=new Map;for(const[i,s]of this.map)this.getScopeKey(s.scope)===this.getScopeKey(e)&&t.set(s.variable,hc(s));return t}delete(e,t){const i=this.getKey(e,t);this.map.delete(i),this._onDidChangeCollection.fire()}clear(e){if(e?.workspaceFolder){for(const[t,i]of this.map)i.scope?.workspaceFolder?.index===e.workspaceFolder.index&&this.map.delete(t);this.clearDescription(e)}else this.map.clear(),this.descriptionMap.clear();this._onDidChangeCollection.fire()}setDescription(e,t){const i=this.getScopeKey(t),s=this.descriptionMap.get(i);if(!s||s.description!==e){let r;typeof e=="string"?r=e:r=e?.value.split(`

`)[0];const n={description:r,scope:t};this.descriptionMap.set(i,n),this._onDidChangeCollection.fire()}}getDescription(e){const t=this.getScopeKey(e);return this.descriptionMap.get(t)?.description}clearDescription(e){const t=this.getScopeKey(e);this.descriptionMap.delete(t)}}class my{get persistent(){return this.collection.persistent}set persistent(e){this.collection.persistent=e}get onDidChangeCollection(){return this._onDidChangeCollection&&this._onDidChangeCollection.event}constructor(e,t){this.collection=e,this.scope=t,this._onDidChangeCollection=new P}getScoped(e){return this.collection.getScopedEnvironmentVariableCollection(e)}replace(e,t,i){this.collection.replace(e,t,i,this.scope)}append(e,t,i){this.collection.append(e,t,i,this.scope)}prepend(e,t,i){this.collection.prepend(e,t,i,this.scope)}get(e){return this.collection.get(e,this.scope)}forEach(e,t){this.collection.getVariableMap(this.scope).forEach((i,s)=>e.call(t,s,i,this),this.scope)}[Symbol.iterator](){return this.collection.getVariableMap(this.scope).entries()}delete(e){this.collection.delete(e,this.scope),this._onDidChangeCollection.fire(void 0)}clear(){this.collection.clear(this.scope)}set description(e){this.collection.setDescription(e,this.scope)}get description(){return this.collection.getDescription(this.scope)}}let fo=class extends ho{constructor(e,t){super(!1,e,t)}createTerminal(e,t,i){throw new dn}createTerminalFromOptions(e,t){throw new dn}};fo=L([E(0,Ut),E(1,j)],fo);function Uu(a){if(!(!a||typeof a=="string"))return"id"in a?{id:a.id,color:a.color}:a}function _y(a){return cn.isThemeColor(a)?a:void 0}function hc(a){const e={...a};return delete e.scope,e.options=e.options??void 0,delete e.variable,e}const Er=ee("IExtHostApiDeprecationService");let po=class{constructor(e,t){this._extHostLogService=t,this._reportedUsages=new Set,this._telemetryShape=e.getProxy(k.MainThreadTelemetry)}report(e,t,i){const s=this.getUsageKey(e,t);this._reportedUsages.has(s)||(this._reportedUsages.add(s),t.isUnderDevelopment&&this._extHostLogService.warn(`[Deprecation Warning] '${e}' is deprecated. ${i}`),this._telemetryShape.$publicLog2("extHostDeprecatedApiUsage",{extensionId:t.identifier.value,apiId:e}))}getUsageKey(e,t){return`${e}-${t.identifier.value}`}};po=L([E(0,j),E(1,re)],po);var ar;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(ar||(ar={}));var dr;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(dr||(dr={}));var go;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(go||(go={}));var zi;(function(a){function e(s){if(s){const r=s;return r&&!!r.process}else return!1}a.is=e;function t(s){if(s==null)return;const r={process:s.process,args:s.args};return s.options&&(r.options=go.from(s.options)),r}a.from=t;function i(s){if(s!=null)return new va(s.process,s.args,s.options)}a.to=i})(zi||(zi={}));var mo;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(mo||(mo={}));var qi;(function(a){function e(s){if(s){const r=s;return r&&(!!r.commandLine||!!r.command)}else return!1}a.is=e;function t(s){if(s==null)return;const r={};return s.commandLine!==void 0?r.commandLine=s.commandLine:(r.command=s.command,r.args=s.args),s.options&&(r.options=mo.from(s.options)),r}a.from=t;function i(s){if(!(s==null||s.command===void 0&&s.commandLine===void 0))return s.commandLine?new Ys(s.commandLine,s.options):new Ys(s.command,s.args?s.args:[],s.options)}a.to=i})(qi||(qi={}));var Ze;(function(a){function e(s){if(s){const r=s;return r&&r.customExecution==="customExecution"}else return!1}a.is=e;function t(s){return{customExecution:"customExecution"}}a.from=t;function i(s,r){return r.get(s)}a.to=i})(Ze||(Ze={}));var fc;(function(a){function e(t,i){let s;return t.scope!==void 0&&typeof t.scope!="number"?s=t.scope.uri:t.scope!==void 0&&typeof t.scope=="number"&&(t.scope===Zs.Workspace&&i&&i.workspaceFile?s=i.workspaceFile:s=Op),{id:t._id,workspaceFolder:s}}a.from=e})(fc||(fc={}));var _o;(function(a){function e(t){if(t!=null)return{_id:t.id,isDefault:t.isDefault}}a.from=e})(_o||(_o={}));var vt;(function(a){function e(s,r){if(s==null)return[];const n=[];for(const o of s){const d=t(o,r);d&&n.push(d)}return n}a.fromMany=e;function t(s,r){if(s==null)return;let n;s.execution instanceof va?n=zi.from(s.execution):s.execution instanceof Ys?n=qi.from(s.execution):s.execution&&s.execution instanceof Cl&&(n=Ze.from(s.execution));const o=ar.from(s.definition);let d;return s.scope?typeof s.scope=="number"?d=s.scope:d=s.scope.uri:d=Zs.Workspace,!o||!d?void 0:{_id:s._id,definition:o,name:s.name,source:{extensionId:r.identifier.value,label:s.source,scope:d},execution:n,isBackground:s.isBackground,group:_o.from(s.group),presentationOptions:dr.from(s.presentationOptions),problemMatchers:je(s.problemMatchers),hasDefinedMatchers:s.hasDefinedMatchers,runOptions:s.runOptions?s.runOptions:{reevaluateOnRerun:!0},detail:s.detail}}a.from=t;async function i(s,r,n){if(s==null)return;let o;zi.is(s.execution)?o=zi.to(s.execution):qi.is(s.execution)?o=qi.to(s.execution):Ze.is(s.execution)&&(o=Ze.to(s._id,n));const d=ar.to(s.definition);let c;if(s.source&&(s.source.scope!==void 0?typeof s.source.scope=="number"?c=s.source.scope:c=await r.resolveWorkspaceFolder(v.revive(s.source.scope)):c=Zs.Workspace),!d||!c)return;const h=new Dl(d,c,s.name,s.source.label,o,s.problemMatchers);return s.isBackground!==void 0&&(h.isBackground=s.isBackground),s.group!==void 0&&(h.group=yn.from(s.group._id),h.group&&s.group.isDefault&&(h.group=new yn(h.group.id,h.group.label),s.group.isDefault===!0&&(h.group.isDefault=s.group.isDefault))),s.presentationOptions&&(h.presentationOptions=dr.to(s.presentationOptions)),s._id&&(h._id=s._id),s.detail&&(h.detail=s.detail),h}a.to=i})(vt||(vt={}));var vo;(function(a){function e(i){return i}a.from=e;function t(i){if(i)return Object.assign(Object.create(null),i)}a.to=t})(vo||(vo={}));class jr{#e;constructor(e,t,i){this._id=t,this._task=i,this.#e=e}get task(){return this._task}terminate(){this.#e.terminateTask(this)}fireDidStartProcess(e){}fireDidEndProcess(e){}}let yo=class{constructor(e,t,i,s,r,n,o,d){this._onDidExecuteTask=new P,this._onDidTerminateTask=new P,this._onDidTaskProcessStarted=new P,this._onDidTaskProcessEnded=new P,this._onDidStartTaskProblemMatchers=new P,this._onDidEndTaskProblemMatchers=new P,this._proxy=e.getProxy(k.MainThreadTask),this._workspaceProvider=i,this._editorService=s,this._configurationService=r,this._terminalService=n,this._handleCounter=0,this._handlers=new Map,this._taskExecutions=new Map,this._taskExecutionPromises=new Map,this._providedCustomExecutions2=new Map,this._notProvidedCustomExecutions=new Set,this._activeCustomExecutions2=new Map,this._logService=o,this._deprecationService=d,this._proxy.$registerSupportedExecutions(!0)}registerTaskProvider(e,t,i){if(!i)return new V(()=>{});const s=this.nextHandle();return this._handlers.set(s,{type:t,provider:i,extension:e}),this._proxy.$registerTaskProvider(s,t),new V(()=>{this._handlers.delete(s),this._proxy.$unregisterTaskProvider(s)})}registerTaskSystem(e,t){this._proxy.$registerTaskSystem(e,t)}fetchTasks(e){return this._proxy.$fetchTasks(vo.from(e)).then(async t=>{const i=[];for(const s of t){const r=await vt.to(s,this._workspaceProvider,this._providedCustomExecutions2);r&&i.push(r)}return i})}get taskExecutions(){const e=[];return this._taskExecutions.forEach(t=>e.push(t)),e}terminateTask(e){if(!(e instanceof jr))throw new Error("No valid task execution provided");return this._proxy.$terminateTask(e._id)}get onDidStartTask(){return this._onDidExecuteTask.event}async $onDidStartTask(e,t,i){const s=this._providedCustomExecutions2.get(e.id);s&&(this._activeCustomExecutions2.set(e.id,s),this._terminalService.attachPtyToTerminal(t,await s.callback(i))),this._lastStartedTask=e.id,this._onDidExecuteTask.fire({execution:await this.getTaskExecution(e)})}get onDidEndTask(){return this._onDidTerminateTask.event}async $OnDidEndTask(e){if(!this._taskExecutionPromises.has(e.id))return;const t=await this.getTaskExecution(e);this._taskExecutionPromises.delete(e.id),this._taskExecutions.delete(e.id),this.customExecutionComplete(e),this._onDidTerminateTask.fire({execution:t})}get onDidStartTaskProcess(){return this._onDidTaskProcessStarted.event}async $onDidStartTaskProcess(e){const t=await this.getTaskExecution(e.id);this._onDidTaskProcessStarted.fire({execution:t,processId:e.processId})}get onDidEndTaskProcess(){return this._onDidTaskProcessEnded.event}async $onDidEndTaskProcess(e){const t=await this.getTaskExecution(e.id);this._onDidTaskProcessEnded.fire({execution:t,exitCode:e.exitCode})}get onDidStartTaskProblemMatchers(){return this._onDidStartTaskProblemMatchers.event}async $onDidStartTaskProblemMatchers(e){let t;try{t=await this.getTaskExecution(e.execution.id)}catch{return}this._onDidStartTaskProblemMatchers.fire({execution:t})}get onDidEndTaskProblemMatchers(){return this._onDidEndTaskProblemMatchers.event}async $onDidEndTaskProblemMatchers(e){let t;try{t=await this.getTaskExecution(e.execution.id)}catch{return}this._onDidEndTaskProblemMatchers.fire({execution:t,hasErrors:e.hasErrors})}$provideTasks(e,t){const i=this._handlers.get(e);if(!i)return Promise.reject(new Error("no handler found"));const s=[],r=we(()=>i.provider.provideTasks(ue.None)).then(n=>this.provideTasksInternal(t,s,i,n));return new Promise(n=>{r.then(o=>{Promise.all(s).then(()=>{n(o)})})})}async $resolveTask(e,t){const i=this._handlers.get(e);if(!i)return Promise.reject(new Error("no handler found"));if(t.definition.type!==i.type)throw new Error(`Unexpected: Task of type [${t.definition.type}] cannot be resolved by provider of type [${i.type}].`);const s=await vt.to(t,this._workspaceProvider,this._providedCustomExecutions2);if(!s)throw new Error("Unexpected: Task cannot be resolved.");const r=await i.provider.resolveTask(s,ue.None);if(!r)return;this.checkDeprecation(r,i);const n=vt.from(r,i.extension);if(!n)throw new Error("Unexpected: Task cannot be resolved.");if(r.definition!==s.definition)throw new Error("Unexpected: The resolved task definition must be the same object as the original task definition. The task definition cannot be changed.");return Ze.is(n.execution)&&await this.addCustomExecution(n,r,!0),await this.resolveTaskInternal(n)}nextHandle(){return this._handleCounter++}async addCustomExecution(e,t,i){const s=await this._proxy.$createTaskId(e);!i&&!this._providedCustomExecutions2.has(s)&&(this._notProvidedCustomExecutions.add(s),this._activeCustomExecutions2.set(s,t.execution)),this._providedCustomExecutions2.set(s,t.execution)}async getTaskExecution(e,t){if(typeof e=="string"){const r=this._taskExecutionPromises.get(e);if(!r)throw new _d("Unexpected: The specified task is missing an execution");return r}const i=this._taskExecutionPromises.get(e.id);if(i)return i;let s;return t?s=Promise.resolve(new jr(this,e.id,t)):s=vt.to(e.task,this._workspaceProvider,this._providedCustomExecutions2).then(r=>{if(!r)throw new _d("Unexpected: Task does not exist.");return new jr(this,e.id,r)}),this._taskExecutionPromises.set(e.id,s),s.then(r=>(this._taskExecutions.set(e.id,r),r))}checkDeprecation(e,t){e._deprecated&&this._deprecationService.report("Task.constructor",t.extension,"Use the Task constructor that takes a `scope` instead.")}customExecutionComplete(e){this._activeCustomExecutions2.get(e.id)&&this._activeCustomExecutions2.delete(e.id),this._notProvidedCustomExecutions.has(e.id)&&this._lastStartedTask!==e.id&&(this._providedCustomExecutions2.delete(e.id),this._notProvidedCustomExecutions.delete(e.id));const i=this._notProvidedCustomExecutions.values();let s=i.next();for(;!s.done;)!this._activeCustomExecutions2.has(s.value)&&this._lastStartedTask!==s.value&&(this._providedCustomExecutions2.delete(s.value),this._notProvidedCustomExecutions.delete(s.value)),s=i.next()}};yo=L([E(0,j),E(1,Se),E(2,st),E(3,gi),E(4,rt),E(5,mi),E(6,re),E(7,Er)],yo);let wo=class extends yo{constructor(e,t,i,s,r,n,o,d){super(e,t,i,s,r,n,o,d),this.registerTaskSystem(q.vscodeRemote,{scheme:q.vscodeRemote,authority:"",platform:bf(Ef.Web)})}async executeTask(e,t){if(!t.execution)throw new Error("Tasks to execute must include an execution");const i=vt.from(t,e);if(i===void 0)throw new Error("Task is not valid");if(Ze.is(i.execution))await this.addCustomExecution(i,t,!1);else throw new dn;const s=await this.getTaskExecution(await this._proxy.$getTaskExecution(i),t);return this._proxy.$executeTask(i).catch(r=>{throw new Error(r)}),s}provideTasksInternal(e,t,i,s){const r=[];if(s)for(const n of s){if(this.checkDeprecation(n,i),!n.definition||!e[n.definition.type]){const d=n.source?n.source:"No task source";this._logService.warn(`The task [${d}, ${n.name}] uses an undefined task type. The task will be ignored in the future.`)}const o=vt.from(n,i.extension);o&&Ze.is(o.execution)?(r.push(o),t.push(this.addCustomExecution(o,n,!0))):this._logService.warn("Only custom execution tasks supported.")}return{tasks:r,extension:i.extension}}async resolveTaskInternal(e){if(Ze.is(e.execution))return e;this._logService.warn("Only custom execution tasks supported.")}async $resolveVariables(e,t){return{process:void 0,variables:Object.create(null)}}async $jsonTasksSupported(){return!1}async $findExecutable(e,t,i){}};wo=L([E(0,j),E(1,Se),E(2,st),E(3,gi),E(4,rt),E(5,mi),E(6,re),E(7,Er)],wo);const Wu=ee("IExtHostTask"),os=ee("IExtHostEditorTabs");class pc{constructor(e,t,i){this._activeTabIdGetter=i,this._parentGroup=t,this.acceptDtoUpdate(e)}get apiObject(){if(!this._apiObject){const e=this,t={get isActive(){return e._dto.id===e._activeTabIdGetter()},get label(){return e._dto.label},get input(){return e._input},get isDirty(){return e._dto.isDirty},get isPinned(){return e._dto.isPinned},get isPreview(){return e._dto.isPreview},get group(){return e._parentGroup.apiObject}};this._apiObject=Object.freeze(t)}return this._apiObject}get tabId(){return this._dto.id}acceptDtoUpdate(e){this._dto=e,this._input=this._initInput()}_initInput(){switch(this._dto.input.kind){case Oe.TextInput:return new ba(v.revive(this._dto.input.uri));case Oe.TextDiffInput:return new er(v.revive(this._dto.input.original),v.revive(this._dto.input.modified));case Oe.TextMergeInput:return new Al(v.revive(this._dto.input.base),v.revive(this._dto.input.input1),v.revive(this._dto.input.input2),v.revive(this._dto.input.result));case Oe.CustomEditorInput:return new xa(v.revive(this._dto.input.uri),this._dto.input.viewType);case Oe.WebviewEditorInput:return new Rl(this._dto.input.viewType);case Oe.NotebookInput:return new wa(v.revive(this._dto.input.uri),this._dto.input.notebookType);case Oe.NotebookDiffInput:return new ya(v.revive(this._dto.input.original),v.revive(this._dto.input.modified),this._dto.input.notebookType);case Oe.TerminalEditorInput:return new Il;case Oe.InteractiveEditorInput:return new kl(v.revive(this._dto.input.uri),v.revive(this._dto.input.inputBoxUri));case Oe.ChatEditorInput:return new Tl;case Oe.MultiDiffEditorInput:return new Pl(this._dto.input.diffEditors.map(e=>new er(v.revive(e.original),v.revive(e.modified))));default:return}}}class vy{constructor(e,t){this._tabs=[],this._activeTabId="",this._dto=e,this._activeGroupIdGetter=t;for(const i of e.tabs)i.isActive&&(this._activeTabId=i.id),this._tabs.push(new pc(i,this,()=>this.activeTabId()))}get apiObject(){if(!this._apiObject){const e=this,t={get isActive(){return e._dto.groupId===e._activeGroupIdGetter()},get viewColumn(){return ye.to(e._dto.viewColumn)},get activeTab(){return e._tabs.find(i=>i.tabId===e._activeTabId)?.apiObject},get tabs(){return Object.freeze(e._tabs.map(i=>i.apiObject))}};this._apiObject=Object.freeze(t)}return this._apiObject}get groupId(){return this._dto.groupId}get tabs(){return this._tabs}acceptGroupDtoUpdate(e){this._dto=e}acceptTabOperation(e){if(e.kind===$t.TAB_OPEN){const i=new pc(e.tabDto,this,()=>this.activeTabId());return this._tabs.splice(e.index,0,i),e.tabDto.isActive&&(this._activeTabId=i.tabId),i}else if(e.kind===$t.TAB_CLOSE){const i=this._tabs.splice(e.index,1)[0];if(!i)throw new Error(`Tab close updated received for index ${e.index} which does not exist`);return i.tabId===this._activeTabId&&(this._activeTabId=""),i}else if(e.kind===$t.TAB_MOVE){if(e.oldIndex===void 0)throw new Error("Invalid old index on move IPC");const i=this._tabs.splice(e.oldIndex,1)[0];if(!i)throw new Error(`Tab move updated received for index ${e.oldIndex} which does not exist`);return this._tabs.splice(e.index,0,i),i}const t=this._tabs.find(i=>i.tabId===e.tabDto.id);if(!t)throw new Error("INVALID tab");return e.tabDto.isActive?this._activeTabId=e.tabDto.id:this._activeTabId===e.tabDto.id&&!e.tabDto.isActive&&(this._activeTabId=""),t.acceptDtoUpdate(e.tabDto),t}activeTabId(){return this._activeTabId}}let xo=class{constructor(e){this._onDidChangeTabs=new P,this._onDidChangeTabGroups=new P,this._extHostTabGroups=[],this._proxy=e.getProxy(k.MainThreadEditorTabs)}get tabGroups(){if(!this._apiObject){const e=this,t={onDidChangeTabGroups:e._onDidChangeTabGroups.event,onDidChangeTabs:e._onDidChangeTabs.event,get all(){return Object.freeze(e._extHostTabGroups.map(i=>i.apiObject))},get activeTabGroup(){const i=e._activeGroupId;return js(e._extHostTabGroups.find(r=>r.groupId===i)?.apiObject)},close:async(i,s)=>{const r=Array.isArray(i)?i:[i];return r.length?yy(r[0])?this._closeGroups(r,s):this._closeTabs(r,s):!0}};this._apiObject=Object.freeze(t)}return this._apiObject}$acceptEditorTabModel(e){const t=new Set(this._extHostTabGroups.map(c=>c.groupId)),i=new Set(e.map(c=>c.groupId)),s=Sf(t,i),r=this._extHostTabGroups.filter(c=>s.removed.includes(c.groupId)).map(c=>c.apiObject),n=[],o=[];this._extHostTabGroups=e.map(c=>{const h=new vy(c,()=>this._activeGroupId);return s.added.includes(h.groupId)?n.push(h.apiObject):o.push(h.apiObject),h});const d=js(e.find(c=>c.isActive===!0)?.groupId);d!==void 0&&this._activeGroupId!==d&&(this._activeGroupId=d),this._onDidChangeTabGroups.fire(Object.freeze({opened:n,closed:r,changed:o}))}$acceptTabGroupUpdate(e){const t=this._extHostTabGroups.find(i=>i.groupId===e.groupId);if(!t)throw new Error("Update Group IPC call received before group creation.");t.acceptGroupDtoUpdate(e),e.isActive&&(this._activeGroupId=e.groupId),this._onDidChangeTabGroups.fire(Object.freeze({changed:[t.apiObject],opened:[],closed:[]}))}$acceptTabOperation(e){const t=this._extHostTabGroups.find(s=>s.groupId===e.groupId);if(!t)throw new Error("Update Tabs IPC call received before group creation.");const i=t.acceptTabOperation(e);switch(e.kind){case $t.TAB_OPEN:this._onDidChangeTabs.fire(Object.freeze({opened:[i.apiObject],closed:[],changed:[]}));return;case $t.TAB_CLOSE:this._onDidChangeTabs.fire(Object.freeze({opened:[],closed:[i.apiObject],changed:[]}));return;case $t.TAB_MOVE:case $t.TAB_UPDATE:this._onDidChangeTabs.fire(Object.freeze({opened:[],closed:[],changed:[i.apiObject]}));return}}_findExtHostTabFromApi(e){for(const t of this._extHostTabGroups)for(const i of t.tabs)if(i.apiObject===e)return i}_findExtHostTabGroupFromApi(e){return this._extHostTabGroups.find(t=>t.apiObject===e)}async _closeTabs(e,t){const i=[];for(const s of e){const r=this._findExtHostTabFromApi(s);if(!r)throw new Error("Tab close: Invalid tab not found!");i.push(r.tabId)}return this._proxy.$closeTab(i,t)}async _closeGroups(e,t){const i=[];for(const s of e){const r=this._findExtHostTabGroupFromApi(s);if(!r)throw new Error("Group close: Invalid group not found!");i.push(r.groupId)}return this._proxy.$closeGroup(i,t)}};xo=L([E(0,j)],xo);function yy(a){return a.tabs!==void 0}class _i{static{this.NONE=new _i(!1,-1,-1,-1)}constructor(e,t,i,s){this.startup=e,this.codeLoadingTime=t,this.activateCallTime=i,this.activateResolvedTime=s}}class Kr{constructor(e){this._startup=e,this._codeLoadingStart=-1,this._codeLoadingStop=-1,this._activateCallStart=-1,this._activateCallStop=-1,this._activateResolveStart=-1,this._activateResolveStop=-1}_delta(e,t){return e===-1||t===-1?-1:t-e}build(){return new _i(this._startup,this._delta(this._codeLoadingStart,this._codeLoadingStop),this._delta(this._activateCallStart,this._activateCallStop),this._delta(this._activateResolveStart,this._activateResolveStop))}codeLoadingStart(){this._codeLoadingStart=Date.now()}codeLoadingStop(){this._codeLoadingStop=Date.now()}activateCallStart(){this._activateCallStart=Date.now()}activateCallStop(){this._activateCallStop=Date.now()}activateResolveStart(){this._activateResolveStart=Date.now()}activateResolveStop(){this._activateResolveStop=Date.now()}}class Sr{constructor(e,t,i,s,r,n){this.activationFailed=e,this.activationFailedError=t,this.activationTimes=i,this.module=s,this.exports=r,this.disposable=n}}class wy extends Sr{constructor(e){super(!1,null,e,{activate:void 0,deactivate:void 0},void 0,X.None)}}class xy extends Sr{constructor(){super(!1,null,_i.NONE,{activate:void 0,deactivate:void 0},void 0,X.None)}}class cr extends Sr{constructor(e){super(!0,e,_i.NONE,{activate:void 0,deactivate:void 0},void 0,X.None)}}let bo=class{constructor(e,t,i,s){this._logService=s,this._registry=e,this._globalRegistry=t,this._host=i,this._operations=new Lt,this._alreadyActivatedEvents=Object.create(null)}dispose(){for(const[e,t]of this._operations)t.dispose()}async waitForActivatingExtensions(){const e=[];for(const[t,i]of this._operations)e.push(i.wait());await Promise.all(e)}isActivated(e){const t=this._operations.get(e);return!!(t&&t.value)}getActivatedExtension(e){const t=this._operations.get(e);if(!t||!t.value)throw new Error(`Extension '${e.value}' is not known or not activated`);return t.value}async activateByEvent(e,t){if(this._alreadyActivatedEvents[e])return;const i=this._registry.getExtensionDescriptionsForActivationEvent(e);await this._activateExtensions(i.map(s=>({id:s.identifier,reason:{startup:t,extensionId:s.identifier,activationEvent:e}}))),this._alreadyActivatedEvents[e]=!0}activateById(e,t){const i=this._registry.getExtensionDescription(e);if(!i)throw new Error(`Extension '${e.value}' is not known`);return this._activateExtensions([{id:i.identifier,reason:t}])}async _activateExtensions(e){const t=e.filter(i=>!this.isActivated(i.id)).map(i=>this._handleActivationRequest(i));await Promise.all(t.map(i=>i.wait()))}_handleActivationRequest(e){if(this._operations.has(e.id))return this._operations.get(e.id);if(this._isHostExtension(e.id))return this._createAndSaveOperation(e,null,[],null);const t=this._registry.getExtensionDescription(e.id);if(!t){const r=new Error(`Cannot activate unknown extension '${e.id.value}'`),n=this._createAndSaveOperation(e,null,[],new cr(r));return this._host.onExtensionActivationError(e.id,r,new vd(e.id.value)),n}const i=[],s=typeof t.extensionDependencies>"u"?[]:t.extensionDependencies;for(const r of s){if(this._isResolvedExtension(r))continue;const n=this._operations.get(r);if(n){i.push(n);continue}if(this._isHostExtension(r)){i.push(this._handleActivationRequest({id:this._globalRegistry.getExtensionDescription(r).identifier,reason:e.reason}));continue}const o=this._registry.getExtensionDescription(r);if(o){if(!o.main&&!o.browser)continue;i.push(this._handleActivationRequest({id:o.identifier,reason:e.reason}));continue}const d=t.displayName||t.identifier.value,c=new Error(`Cannot activate the '${d}' extension because it depends on unknown extension '${r}'`),h=this._createAndSaveOperation(e,t.displayName,[],new cr(c));return this._host.onExtensionActivationError(t.identifier,c,new vd(r)),h}return this._createAndSaveOperation(e,t.displayName,i,null)}_createAndSaveOperation(e,t,i,s){const r=new Eo(e.id,t,e.reason,i,s,this._host,this._logService);return this._operations.set(e.id,r),r}_isHostExtension(e){return Oi.isHostExtension(e,this._registry,this._globalRegistry)}_isResolvedExtension(e){const t=this._globalRegistry.getExtensionDescription(e);return t?!t.main&&!t.browser:!1}};bo=L([E(3,re)],bo);let Eo=class{get value(){return this._value}get friendlyName(){return this._displayName||this._id.value}constructor(e,t,i,s,r,n,o){this._id=e,this._displayName=t,this._reason=i,this._deps=s,this._value=r,this._host=n,this._logService=o,this._barrier=new mt,this._isDisposed=!1,this._initialize()}dispose(){this._isDisposed=!0}wait(){return this._barrier.wait()}async _initialize(){await this._waitForDepsThenActivate(),this._barrier.open()}async _waitForDepsThenActivate(){if(!this._value){for(;this._deps.length>0;){for(let e=0;e<this._deps.length;e++){const t=this._deps[e];if(t.value&&!t.value.activationFailed){this._deps.splice(e,1),e--;continue}if(t.value&&t.value.activationFailed){const i=new Error(`Cannot activate the '${this.friendlyName}' extension because its dependency '${t.friendlyName}' failed to activate`);i.detail=t.value.activationFailedError,this._value=new cr(i),this._host.onExtensionActivationError(this._id,i,null);return}}this._deps.length>0&&await Promise.race(this._deps.map(e=>e.wait()))}await this._activate()}}async _activate(){try{this._value=await this._host.actualActivateExtension(this._id,this._reason)}catch(e){const t=new Error;if(e&&e.name&&(t.name=e.name),e&&e.message?t.message=`Activating extension '${this._id.value}' failed: ${e.message}.`:t.message=`Activating extension '${this._id.value}' failed: ${e}.`,e&&e.stack&&(t.stack=e.stack),this._value=new cr(t),this._isDisposed&&Qi(e))return;this._host.onExtensionActivationError(this._id,t,null),this._logService.error(`Activating extension ${this._id.value} failed due to an error:`),this._logService.error(e)}}};Eo=L([E(6,re)],Eo);class Bu{constructor(e,t){this._logService=t,this._onDidChangeStorage=new P,this.onDidChangeStorage=this._onDidChangeStorage.event,this._proxy=e.getProxy(k.MainThreadStorage)}registerExtensionStorageKeysToSync(e,t){this._proxy.$registerExtensionStorageKeysToSync(e,t)}async initializeExtensionStorage(e,t,i){const s=await this._proxy.$initializeExtensionStorage(e,t);let r;return s&&(r=this.safeParseValue(e,t,s)),r||i}setValue(e,t,i){return this._proxy.$setValue(e,t,i)}$acceptValue(e,t,i){const s=this.safeParseValue(e,t,i);s&&this._onDidChangeStorage.fire({shared:e,key:t,value:s})}safeParseValue(e,t,i){try{return JSON.parse(i)}catch(s){this._logService.error(`[extHostStorage] unexpected error parsing storage contents (extensionId: ${t}, global: ${e}): ${s}`)}}}const Ma=ee("IExtHostStorage");class Vu{constructor(e,t,i){this._deferredPromises=new Map,this._id=e,this._shared=t,this._storage=i,this._init=this._storage.initializeExtensionStorage(this._shared,this._id,Object.create(null)).then(s=>(this._value=s,this)),this._storageListener=this._storage.onDidChangeStorage(s=>{s.shared===this._shared&&s.key===this._id&&(this._value=s.value)}),this._scheduler=new dl(()=>{const s=this._deferredPromises;this._deferredPromises=new Map,(async()=>{try{await this._storage.setValue(this._shared,this._id,this._value);for(const r of s.values())r.complete()}catch(r){for(const n of s.values())n.error(r)}})()},0)}keys(){return Object.entries(this._value??{}).filter(([,e])=>e!==void 0).map(([e])=>e)}get whenReady(){return this._init}get(e,t){let i=this._value[e];return typeof i>"u"&&(i=t),i}update(e,t){t!==null&&typeof t=="object"?this._value[e]=JSON.parse(JSON.stringify(t)):this._value[e]=t;const i=this._deferredPromises.get(e);if(i!==void 0)return i.p;const s=new Ks;return this._deferredPromises.set(e,s),this._scheduler.isScheduled()||this._scheduler.schedule(),s.p}dispose(){this._storageListener.dispose()}}class by extends Vu{setKeysForSync(e){this._storage.registerExtensionStorageKeysToSync({id:this._id,version:this._extension.version},e)}constructor(e,t){super(e.identifier.value,!0,t),this._extension=e}}const zu=ee("IExtensionStoragePaths");let gc=class{constructor(e,t,i){this._logService=t,this._extHostFileSystem=i,this._workspace=e.workspace??void 0,this._environment=e.environment,this.whenReady=this._getOrCreateWorkspaceStoragePath().then(s=>this._value=s)}async _getWorkspaceStorageURI(e){return v.joinPath(this._environment.workspaceStorageHome,e)}async _getOrCreateWorkspaceStoragePath(){if(!this._workspace)return Promise.resolve(void 0);const e=this._workspace.id,t=await this._getWorkspaceStorageURI(e);try{return await this._extHostFileSystem.value.stat(t),this._logService.trace("[ExtHostStorage] storage dir already exists",t),t}catch{}try{return this._logService.trace("[ExtHostStorage] creating dir and metadata-file",t),await this._extHostFileSystem.value.createDirectory(t),await this._extHostFileSystem.value.writeFile(v.joinPath(t,"meta.json"),new TextEncoder().encode(JSON.stringify({id:this._workspace.id,configuration:v.revive(this._workspace.configuration)?.toString(),name:this._workspace.name},void 0,2))),t}catch(i){this._logService.error("[ExtHostStorage]",i);return}}workspaceValue(e){if(this._value)return v.joinPath(this._value,e.identifier.value)}globalValue(e){return v.joinPath(this._environment.globalStorageHome,e.identifier.value.toLowerCase())}onWillDeactivateAll(){}};gc=L([E(0,Se),E(1,re),E(2,xr)],gc);const Ha=ee("IExtHostAuthentication");let So=class{constructor(e){this._authenticationProviders=new Map,this._onDidChangeSessions=new P,this._getSessionTaskSingler=new Ey,this._proxy=e.getProxy(k.MainThreadAuthentication)}getExtensionScopedSessionsEvent(e){const t=e.toLowerCase();return Ee.chain(this._onDidChangeSessions.event,i=>i.filter(s=>!s.extensionIdFilter||s.extensionIdFilter.includes(t)).map(s=>({provider:s.provider})))}async getSession(e,t,i,s={}){const r=ge.toKey(e.identifier),n=[...i].sort().join(" "),d=Object.keys(s).sort().map(c=>`${c}:${!!s[c]}`).join(", ");return await this._getSessionTaskSingler.getOrCreate(`${r} ${t} ${n} ${d}`,async()=>{await this._proxy.$ensureProvider(t);const c=e.displayName||e.name;return this._proxy.$getSession(t,i,r,c,s)})}async getAccounts(e){return await this._proxy.$ensureProvider(e),await this._proxy.$getAccounts(e)}async removeSession(e,t){const i=this._authenticationProviders.get(e);return i?i.provider.removeSession(t):this._proxy.$removeSession(e,t)}registerAuthenticationProvider(e,t,i,s){if(this._authenticationProviders.get(e))throw new Error(`An authentication provider with id '${e}' is already registered.`);this._authenticationProviders.set(e,{label:t,provider:i,options:s??{supportsMultipleAccounts:!1}});const r=i.onDidChangeSessions(n=>this._proxy.$sendDidChangeSessions(e,n));return this._proxy.$registerAuthenticationProvider(e,t,s?.supportsMultipleAccounts??!1),new V(()=>{r.dispose(),this._authenticationProviders.delete(e),this._proxy.$unregisterAuthenticationProvider(e)})}async $createSession(e,t,i){const s=this._authenticationProviders.get(e);if(s)return await s.provider.createSession(t,i);throw new Error(`Unable to find authentication provider with handle: ${e}`)}async $removeSession(e,t){const i=this._authenticationProviders.get(e);if(i)return await i.provider.removeSession(t);throw new Error(`Unable to find authentication provider with handle: ${e}`)}async $getSessions(e,t,i){const s=this._authenticationProviders.get(e);if(s)return await s.provider.getSessions(t,i);throw new Error(`Unable to find authentication provider with handle: ${e}`)}$onDidChangeAuthenticationSessions(e,t,i){return e.startsWith($l)||this._onDidChangeSessions.fire({provider:{id:e,label:t},extensionIdFilter:i}),Promise.resolve()}};So=L([E(0,j)],So);class Ey{constructor(){this._inFlightPromises=new Map}getOrCreate(e,t){const i=this._inFlightPromises.get(e);if(i)return i;const s=t().finally(()=>this._inFlightPromises.delete(e));return this._inFlightPromises.set(e,s),s}}const Sy={label:J(5067,"Other Models"),order:Number.MAX_SAFE_INTEGER};var Ns;const Fa=ee("IExtHostLanguageModels");class mc{constructor(e,t){this.option=e,this.stream=new ln,this.stream=t??new ln}}class Cy{constructor(){this._responseStreams=new Map,this._defaultStream=new ln,this._isDone=!1;const e=this;this.apiObject={get stream(){return e._defaultStream.asyncIterable},get text(){return _r.map(e._defaultStream.asyncIterable,t=>{if(t instanceof Ui)return t.value}).coalesce()}}}*_streams(){if(this._responseStreams.size>0)for(const[,e]of this._responseStreams)yield e.stream;else yield this._defaultStream}handleFragment(e){if(this._isDone)return;let t=this._responseStreams.get(e.index);t||(this._responseStreams.size===0?t=new mc(e.index,this._defaultStream):t=new mc(e.index),this._responseStreams.set(e.index,t));let i;e.part.type==="text"?i=new Ui(e.part.value):e.part.type==="data"?i=new Ui(""):i=new Ea(e.part.toolCallId,e.part.name,e.part.parameters),t.stream.emitOne(i)}reject(e){this._isDone=!0;for(const t of this._streams())t.reject(e)}resolve(){this._isDone=!0;for(const e of this._streams())e.resolve()}}let Co=class{static{Ns=this}static{this._idPool=1}constructor(e,t,i){this._logService=t,this._extHostAuthentication=i,this._onDidChangeModelAccess=new P,this._onDidChangeProviders=new P,this.onDidChangeProviders=this._onDidChangeProviders.event,this._languageModels=new Map,this._allLanguageModelData=new Map,this._modelAccessList=new Lt,this._pendingRequest=new Map,this._ignoredFileProviders=new Map,this._languageAccessInformationExtensions=new Set,this._proxy=e.getProxy(k.MainThreadLanguageModels)}dispose(){this._onDidChangeModelAccess.dispose(),this._onDidChangeProviders.dispose()}registerLanguageModel(e,t,i,s){const r=Ns._idPool++;this._languageModels.set(r,{extension:e.identifier,provider:i,languageModelId:t});let n;s.auth&&(n={providerLabel:e.displayName||e.name,accountLabel:typeof s.auth=="object"?s.auth.label:void 0}),this._proxy.$registerLanguageModelProvider(r,`${ge.toKey(e.identifier)}/${t}`,{extension:e.identifier,id:t,vendor:s.vendor??ge.toKey(e.identifier),name:s.name??"",family:s.family??"",cost:s.cost,description:s.description,version:s.version,maxInputTokens:s.maxInputTokens,maxOutputTokens:s.maxOutputTokens,auth:n,targetExtensions:s.extensions,isDefault:s.isDefault,isUserSelectable:s.isUserSelectable,modelPickerCategory:s.category??Sy,capabilities:s.capabilities});const o=i.onDidReceiveLanguageModelResponse2?.(({extensionId:d,participant:c,tokenCount:h})=>{this._proxy.$whenLanguageModelChatRequestMade(t,new ge(d),c,h)});return B(()=>{this._languageModels.delete(r),this._proxy.$unregisterProvider(r),o?.dispose()})}async $startChatRequest(e,t,i,s,r,n){const o=this._languageModels.get(e);if(!o)throw new Error("Provider not found");const d=new la(async h=>{if(n.isCancellationRequested){this._logService.warn(`[CHAT](${o.extension.value}) CANNOT send progress because the REQUEST IS CANCELLED`);return}let g;if(h.part instanceof Ea?g={type:"tool_use",name:h.part.name,parameters:h.part.input,toolCallId:h.part.callId}:h.part instanceof Ui?g={type:"text",value:h.part.value}:h.part instanceof Hl&&(g={type:"data",value:{mimeType:h.part.mimeType,data:be.wrap(h.part.data)}}),!g){this._logService.warn(`[CHAT](${o.extension.value}) UNKNOWN part ${JSON.stringify(h)}`);return}this._proxy.$reportResponsePart(t,{index:h.index,part:g})});let c;try{c=o.provider.provideLanguageModelResponse(s.value.map(Nr.to),r,ge.toKey(i),d,n)}catch(h){throw h}Promise.resolve(c).then(()=>{this._proxy.$reportResponseDone(t,void 0)},h=>{this._proxy.$reportResponseDone(t,Gs(h))})}$provideTokenLength(e,t,i){const s=this._languageModels.get(e);return s?Promise.resolve(s.provider.provideTokenCount(t,i)):Promise.resolve(0)}$acceptChatModelMetadata(e){if(e.added)for(const{identifier:t,metadata:i}of e.added)this._allLanguageModelData.set(t,{metadata:i,apiObjects:new Lt});if(e.removed)for(const t of e.removed){this._allLanguageModelData.delete(t);for(const[i,s]of this._pendingRequest)s.languageModelId===t&&(s.res.reject(new ua),this._pendingRequest.delete(i))}e.added?.forEach(t=>this._fakeAuthPopulate(t.metadata)),this._onDidChangeProviders.fire(void 0)}async getDefaultLanguageModel(e){const t=Ji.find(this._allLanguageModelData.entries(),([,i])=>!!i.metadata.isDefault)?.[0];if(t)return this.getLanguageModelByIdentifier(e,t)}async getLanguageModelByIdentifier(e,t){const i=this._allLanguageModelData.get(t);if(!i)return;this._isUsingAuth(e.identifier,i.metadata)&&await this._fakeAuthPopulate(i.metadata);let s=i.apiObjects.get(e.identifier);if(!s){const r=this;s={id:i.metadata.id,vendor:i.metadata.vendor,family:i.metadata.family,version:i.metadata.version,name:i.metadata.name,capabilities:{supportsImageToText:i.metadata.capabilities?.vision??!1,supportsToolCalling:i.metadata.capabilities?.toolCalling??!1},maxInputTokens:i.metadata.maxInputTokens,countTokens(n,o){if(!r._allLanguageModelData.has(t))throw Je.NotFound(t);return r._computeTokenLength(t,n,o??ue.None)},sendRequest(n,o,d){if(!r._allLanguageModelData.has(t))throw Je.NotFound(t);return r._sendChatRequest(e,t,n,o??{},d??ue.None)}},i.apiObjects.set(e.identifier,s)}return s}async selectLanguageModels(e,t){const i=await this._proxy.$selectChatModels({...t,extension:e.identifier}),s=[];for(const r of i){const n=await this.getLanguageModelByIdentifier(e,r);n&&s.push(n)}return s}async _sendChatRequest(e,t,i,s,r){const n=this._convertMessages(e,i),o=e.identifier,d=this._allLanguageModelData.get(t)?.metadata;if(!d||!this._allLanguageModelData.has(t))throw Je.NotFound(`Language model '${t}' is unknown.`);if(this._isUsingAuth(o,d)&&(!await this._getAuthAccess(e,{identifier:d.extension,displayName:d.auth.providerLabel},s.justification,!1)||!this._modelAccessList.get(o)?.has(d.extension)))throw Je.NoPermissions(`Language model '${t}' cannot be used by '${o.value}'.`);const c=Math.random()*1e6|0,h=new Cy;this._pendingRequest.set(c,{languageModelId:t,res:h});try{await this._proxy.$tryStartChatRequest(o,t,c,new Ke(n),s,r)}catch(g){throw this._pendingRequest.delete(c),Je.tryDeserialize(g)??g}return h.apiObject}_convertMessages(e,t){const i=[];for(const s of t)s.role===Ml.System&&b(e,"languageModelSystem"),i.push(Nr.from(s));return i}async $acceptResponsePart(e,t){const i=this._pendingRequest.get(e);i&&i.res.handleFragment(t)}async $acceptResponseDone(e,t){const i=this._pendingRequest.get(e);i&&(this._pendingRequest.delete(e),t?i.res.reject(Je.tryDeserialize(t)??Cf(t)):i.res.resolve())}async _getAuthAccess(e,t,i,s){const r=$l+t.identifier.value;if(await this._extHostAuthentication.getSession(e,r,[],{silent:!0}))return this.$updateModelAccesslist([{from:e.identifier,to:t.identifier,enabled:!0}]),!0;if(s)return!1;try{const o=i?J(2560,"Justification: {1}",t.displayName,i):void 0;return await this._extHostAuthentication.getSession(e,r,[],{forceNewSession:{detail:o}}),this.$updateModelAccesslist([{from:e.identifier,to:t.identifier,enabled:!0}]),!0}catch{return!1}}_isUsingAuth(e,t){return!!t.auth&&!ge.equals(t.extension,e)}async _fakeAuthPopulate(e){if(e.auth)for(const t of this._languageAccessInformationExtensions)try{await this._getAuthAccess(t,{identifier:e.extension,displayName:""},void 0,!0)}catch(i){this._logService.error("Fake Auth request failed"),this._logService.error(i)}}async _computeTokenLength(e,t,i){if(!this._allLanguageModelData.get(e))throw Je.NotFound(`Language model '${e}' is unknown.`);const r=Ji.find(this._languageModels.values(),n=>n.languageModelId===e);return r?r.provider.provideTokenCount(t,i):this._proxy.$countTokens(e,typeof t=="string"?t:Nr.from(t),i)}$updateModelAccesslist(e){const t=new Array;for(const{from:i,to:s,enabled:r}of e){const n=this._modelAccessList.get(i)??new ss;if(n.has(s)!==r){r?n.add(s):n.delete(s),this._modelAccessList.set(i,n);const d={from:i,to:s};t.push(d),this._onDidChangeModelAccess.fire(d)}}}createLanguageModelAccessInformation(e){this._languageAccessInformationExtensions.add(e);const t=this,i=Ee.signal(Ee.filter(this._onDidChangeModelAccess.event,r=>ge.equals(r.from,e.identifier))),s=Ee.signal(this._onDidChangeProviders.event);return{get onDidChange(){return Ee.any(i,s)},canSendRequest(r){let n;e:for(const[d,c]of t._allLanguageModelData)for(const h of c.apiObjects.values())if(h===r){n=c.metadata;break e}if(!n)return;if(!t._isUsingAuth(e.identifier,n))return!0;const o=t._modelAccessList.get(e.identifier);if(o)return o.has(n.extension)}}}fileIsIgnored(e,t,i=ue.None){return b(e,"chatParticipantAdditions"),this._proxy.$fileIsIgnored(t,i)}async $isFileIgnored(e,t,i){const s=this._ignoredFileProviders.get(e);if(!s)throw new Error("Unknown LanguageModelIgnoredFileProvider");return await s.provideFileIgnored(v.revive(t),i)??!1}registerIgnoredFileProvider(e,t){b(e,"chatParticipantPrivate");const i=Ns._idPool++;return this._proxy.$registerFileIgnoreProvider(i),this._ignoredFileProviders.set(i,t),B(()=>{this._proxy.$unregisterFileIgnoreProvider(i),this._ignoredFileProviders.delete(i)})}};Co=Ns=L([E(0,j),E(1,re),E(2,Ha)],Co);class qu{constructor(e){this._onDidChangePassword=new P,this.onDidChangePassword=this._onDidChangePassword.event,this._proxy=e.getProxy(k.MainThreadSecretState)}async $onDidChangePassword(e){this._onDidChangePassword.fire(e)}get(e,t){return this._proxy.$getPassword(e,t)}store(e,t,i){return this._proxy.$setPassword(e,t,i)}delete(e,t){return this._proxy.$deletePassword(e,t)}}const La=ee("IExtHostSecretState");class Dy{#e;constructor(e,t){this.disposables=new N,this._id=ge.toKey(e.identifier),this.#e=t,this.onDidChange=Ee.map(Ee.filter(this.#e.onDidChangePassword,i=>i.extensionId===this._id),i=>({key:i.key}),this.disposables)}dispose(){this.disposables.dispose()}get(e){return this.#e.get(this._id,e)}store(e,t){return this.#e.store(this._id,e,t)}delete(e){return this.#e.delete(this._id,e)}}let Do=class{constructor(e,t,i){this.logService=i,this.bundleCache=new Map,this._proxy=t.getProxy(k.MainThreadLocalization),this.currentLanguage=e.environment.appLanguage,this.isDefaultLanguage=this.currentLanguage===Df}getMessage(e,t){const{message:i,args:s,comment:r}=t;if(this.isDefaultLanguage)return yd(i,s??{});let n=i;r&&r.length>0&&(n+=`/${Array.isArray(r)?r.join(""):r}`);const o=this.bundleCache.get(e)?.contents[n];return o||this.logService.warn(`Using default string since no string found in i18n bundle that has the key: ${n}`),yd(o??i,s??{})}getBundle(e){return this.bundleCache.get(e)?.contents}getBundleUri(e){return this.bundleCache.get(e)?.uri}async initializeLocalizedMessages(e){if(this.isDefaultLanguage||!e.l10n&&!e.isBuiltin||this.bundleCache.has(e.identifier.value))return;let t;const i=await this.getBundleLocation(e);if(!i){this.logService.error(`No bundle location found for extension ${e.identifier.value}`);return}try{const s=await this._proxy.$fetchBundleContents(i),r=JSON.parse(s);t=e.isBuiltin?r.contents?.bundle:r}catch(s){this.logService.error(`Failed to load translations for ${e.identifier.value} from ${i}: ${s.message}`);return}t&&this.bundleCache.set(e.identifier.value,{contents:t,uri:i})}async getBundleLocation(e){if(e.isBuiltin){const t=await this._proxy.$fetchBuiltInBundleUri(e.identifier.value,this.currentLanguage);return v.revive(t)}return e.l10n?v.joinPath(e.extensionLocation,e.l10n,`bundle.l10n.${this.currentLanguage}.json`):void 0}};Do=L([E(0,Se),E(1,j),E(2,re)],Do);const Na=ee("IExtHostLocalizationService"),Oa=ee("IExtHostManagedSockets");let Po=class{constructor(e){this._remoteSocketIdCounter=0,this._factory=null,this._managedRemoteSockets=new Map,this._proxy=e.getProxy(k.MainThreadManagedSockets)}setFactory(e,t){for(const i of this._managedRemoteSockets.values())i.dispose();this._factory&&this._proxy.$unregisterSocketFactory(this._factory.socketFactoryId),this._factory=new Py(e,t),this._proxy.$registerSocketFactory(this._factory.socketFactoryId)}async $openRemoteSocket(e){if(!this._factory||this._factory.socketFactoryId!==e)throw new Error(`No socket factory with id ${e}`);const t=++this._remoteSocketIdCounter,i=await this._factory.makeConnection(),s=new N;return this._managedRemoteSockets.set(t,new Ty(t,i,s)),s.add(B(()=>this._managedRemoteSockets.delete(t))),s.add(i.onDidEnd(()=>{this._proxy.$onDidManagedSocketEnd(t),s.dispose()})),s.add(i.onDidClose(r=>{this._proxy.$onDidManagedSocketClose(t,r?.stack??r?.message),s.dispose()})),s.add(i.onDidReceiveMessage(r=>this._proxy.$onDidManagedSocketHaveData(t,be.wrap(r)))),t}$remoteSocketWrite(e,t){this._managedRemoteSockets.get(e)?.actual.send(t.buffer)}$remoteSocketEnd(e){const t=this._managedRemoteSockets.get(e);t&&(t.actual.end(),t.dispose())}async $remoteSocketDrain(e){await this._managedRemoteSockets.get(e)?.actual.drain?.()}};Po=L([E(0,j)],Po);class Py{constructor(e,t){this.socketFactoryId=e,this.makeConnection=t}}class Ty extends X{constructor(e,t,i){super(),this.socketId=e,this.actual=t,this._register(i)}}var To;const ju=ee("IHostUtils");let ko=To=class extends X{constructor(e,t,i,s,r,n,o,d,c,h,g,m,l){super(),this._extHostManagedSockets=m,this._extHostLanguageModels=l,this._onDidChangeRemoteConnectionData=this._register(new P),this.onDidChangeRemoteConnectionData=this._onDidChangeRemoteConnectionData.event,this._realPathCache=new Map,this._isTerminating=!1,this._hostUtils=t,this._extHostContext=i,this._initData=o,this._extHostWorkspace=s,this._extHostConfiguration=r,this._logService=n,this._extHostTunnelService=c,this._extHostTerminalService=h,this._extHostLocalizationService=g,this._mainThreadWorkspaceProxy=this._extHostContext.getProxy(k.MainThreadWorkspace),this._mainThreadTelemetryProxy=this._extHostContext.getProxy(k.MainThreadTelemetry),this._mainThreadExtensionsProxy=this._extHostContext.getProxy(k.MainThreadExtensionService),this._almostReadyToRunExtensions=new mt,this._readyToStartExtensionHost=new mt,this._readyToRunExtensions=new mt,this._eagerExtensionsActivated=new mt,this._activationEventsReader=new Iy(this._initData.extensions.activationEvents),this._globalRegistry=new Oi(this._activationEventsReader,this._initData.extensions.allExtensions);const f=new ss(this._initData.extensions.myExtensions);this._myRegistry=new Oi(this._activationEventsReader,Ku(this._globalRegistry,f)),Ct&&(this._logService.info(`Creating extension host with the following global extensions: ${Qt(this._globalRegistry)}`),this._logService.info(`Creating extension host with the following local extensions: ${Qt(this._myRegistry)}`)),this._storage=new Bu(this._extHostContext,this._logService),this._secretState=new qu(this._extHostContext),this._storagePath=d,this._instaService=this._store.add(e.createChild(new cl([Ma,this._storage],[La,this._secretState]))),this._activator=this._register(new bo(this._myRegistry,this._globalRegistry,{onExtensionActivationError:(_,x,C)=>{this._mainThreadExtensionsProxy.$onExtensionActivationError(_,Gs(x),C)},actualActivateExtension:async(_,x)=>{if(Oi.isHostExtension(_,this._myRegistry,this._globalRegistry))return await this._mainThreadExtensionsProxy.$activateExtension(_,x),new xy;const C=this._myRegistry.getExtensionDescription(_);return this._activateExtension(C,x)}},this._logService)),this._extensionPathIndex=null,this._resolvers=Object.create(null),this._started=!1,this._remoteConnectionData=this._initData.remote.connectionData}getRemoteConnectionData(){return this._remoteConnectionData}async initialize(){try{await this._beforeAlmostReadyToRunExtensions(),this._almostReadyToRunExtensions.open(),await this._extHostWorkspace.waitForInitializeCall(),We("code/extHost/ready"),this._readyToStartExtensionHost.open(),this._initData.autoStart&&this._startExtensionHost()}catch(e){fa(e)}}async _deactivateAll(){this._storagePath.onWillDeactivateAll();let e=[];try{e=this._myRegistry.getAllExtensionDescriptions().map(r=>r.identifier).filter(r=>this.isActivated(r)).map(r=>this._deactivate(r))}catch{}await Promise.all(e)}terminate(e,t=0){if(this._isTerminating)return;this._isTerminating=!0,this._logService.info(`Extension host terminating: ${e}`),this._logService.flush(),this._extHostTerminalService.dispose(),this._activator.dispose(),Qs&&un(s=>{this._logService.error(s)}),this._extHostContext.dispose();const i=this._deactivateAll();Promise.race([si(5e3),i]).finally(()=>{this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} exiting with code ${t}`):this._logService.info(`Extension host exiting with code ${t}`),this._logService.flush(),this._logService.dispose(),this._hostUtils.exit(t)})}isActivated(e){return this._readyToRunExtensions.isOpen()?this._activator.isActivated(e):!1}async getExtension(e){const t=await this._mainThreadExtensionsProxy.$getExtension(e);return t&&{...t,identifier:new ge(t.identifier.value),extensionLocation:v.revive(t.extensionLocation)}}_activateByEvent(e,t){return this._activator.activateByEvent(e,t)}_activateById(e,t){return this._activator.activateById(e,t)}activateByIdWithErrors(e,t){return this._activateById(e,t).then(()=>{const i=this._activator.getActivatedExtension(e);if(i.activationFailed)return Promise.reject(i.activationFailedError)})}getExtensionRegistry(){return this._readyToRunExtensions.wait().then(e=>this._myRegistry)}getExtensionExports(e){if(this._readyToRunExtensions.isOpen())return this._activator.getActivatedExtension(e).exports;try{return this._activator.getActivatedExtension(e).exports}catch{return null}}async _realPathExtensionUri(e){if(e.scheme===q.file&&this._hostUtils.fsRealpath){const t=e.fsPath;this._realPathCache.has(t)||this._realPathCache.set(t,this._hostUtils.fsRealpath(t));const i=await this._realPathCache.get(t);return v.file(i)}return e}async getExtensionPathIndex(){return this._extensionPathIndex||(this._extensionPathIndex=this._createExtensionPathIndex(this._myRegistry.getAllExtensionDescriptions()).then(e=>new ky(e))),this._extensionPathIndex}async _createExtensionPathIndex(e){const t=aa.forUris(i=>Rf.ignorePathCasing(i));return await Promise.all(e.map(async i=>{if(this._getEntryPoint(i)){const s=await this._realPathExtensionUri(i.extensionLocation);t.set(s,i)}})),t}_deactivate(e){let t=Promise.resolve(void 0);if(!this._readyToRunExtensions.isOpen()||!this._activator.isActivated(e))return t;const i=this._activator.getActivatedExtension(e);if(!i)return t;try{typeof i.module.deactivate=="function"&&(t=Promise.resolve(i.module.deactivate()).then(void 0,s=>(this._logService.error(s),Promise.resolve(void 0))))}catch(s){this._logService.error(`An error occurred when deactivating the extension '${e.value}':`),this._logService.error(s)}try{i.disposable.dispose()}catch(s){this._logService.error(`An error occurred when disposing the subscriptions for extension '${e.value}':`),this._logService.error(s)}return t}async _activateExtension(e,t){return this._initData.remote.isRemote?this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier):await this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier),this._doActivateExtension(e,t).then(i=>{const s=i.activationTimes;return this._mainThreadExtensionsProxy.$onDidActivateExtension(e.identifier,s.codeLoadingTime,s.activateCallTime,s.activateResolvedTime,t),this._logExtensionActivationTimes(e,t,"success",s),i},i=>{throw this._logExtensionActivationTimes(e,t,"failure"),i})}_logExtensionActivationTimes(e,t,i,s){const r=vc(e,t);this._mainThreadTelemetryProxy.$publicLog2("extensionActivationTimes",{...r,...s||{},outcome:i})}_doActivateExtension(e,t){const i=vc(e,t);this._mainThreadTelemetryProxy.$publicLog2("activatePlugin",i);const s=this._getEntryPoint(e);if(!s)return Promise.resolve(new wy(_i.NONE));this._logService.info(`ExtensionService#_doActivateExtension ${e.identifier.value}, startup: ${t.startup}, activationEvent: '${t.activationEvent}'${e.identifier.value!==t.extensionId.value?`, root cause: ${t.extensionId.value}`:""}`),this._logService.flush();const r=this._isESM(e),n=new N,o=new Kr(t.startup);return Promise.all([r?this._loadESMModule(e,Js(e.extensionLocation,s),o):this._loadCommonJSModule(e,Js(e.extensionLocation,s),o),this._loadExtensionContext(e,n)]).then(d=>(We(`code/extHost/willActivateExtension/${e.identifier.value}`),To._callActivate(this._logService,e.identifier,d[0],d[1],n,o))).then(d=>(We(`code/extHost/didActivateExtension/${e.identifier.value}`),d))}_loadExtensionContext(e,t){const i=this._extHostLanguageModels.createLanguageModelAccessInformation(e),s=t.add(new by(e,this._storage)),r=t.add(new Vu(e.identifier.value,!1,this._storage)),n=t.add(new Dy(e,this._secretState)),o=e.isUnderDevelopment?this._initData.environment.extensionTestsLocationURI?ks.Test:ks.Development:ks.Production,d=this._initData.remote.isRemote?Wi.Workspace:Wi.UI;return this._logService.trace(`ExtensionService#loadExtensionContext ${e.identifier.value}`),Promise.all([s.whenReady,r.whenReady,this._storagePath.whenReady]).then(()=>{const c=this;let h,g;const m=te(e,"ipc")?this._initData.messagePorts?.get(ge.toKey(e.identifier)):void 0;return Object.freeze({globalState:s,workspaceState:r,secrets:n,subscriptions:[],get languageModelAccessInformation(){return i},get extensionUri(){return e.extensionLocation},get extensionPath(){return e.extensionLocation.fsPath},asAbsolutePath(l){return wd(e.extensionLocation.fsPath,l)},get storagePath(){return c._storagePath.workspaceValue(e)?.fsPath},get globalStoragePath(){return c._storagePath.globalValue(e).fsPath},get logPath(){return wd(c._initData.logsLocation.fsPath,e.identifier.value)},get logUri(){return v.joinPath(c._initData.logsLocation,e.identifier.value)},get storageUri(){return c._storagePath.workspaceValue(e)},get globalStorageUri(){return c._storagePath.globalValue(e)},get extensionMode(){return o},get extension(){return h===void 0&&(h=new Mi(c,e.identifier,e,d,!1)),h},get extensionRuntime(){return b(e,"extensionRuntime"),c.extensionRuntime},get environmentVariableCollection(){return c._extHostTerminalService.getEnvironmentVariableCollection(e)},get messagePassingProtocol(){if(!g){if(!m)return;const l=Ee.buffer(Ee.fromDOMEventEmitter(m,"message",f=>f.data));m.start(),g={onDidReceiveMessage:l,postMessage:m.postMessage.bind(m)}}return g}})})}static _callActivate(e,t,i,s,r,n){return i=i||{activate:void 0,deactivate:void 0},this._callActivateOptional(e,t,i,s,n).then(o=>new Sr(!1,null,n.build(),i,o,B(()=>{r.dispose(),qs(s.subscriptions)})))}static _callActivateOptional(e,t,i,s,r){if(typeof i.activate=="function")try{r.activateCallStart(),e.trace(`ExtensionService#_callActivateOptional ${t.value}`);const n=typeof global=="object"?global:self,o=i.activate.apply(n,[s]);return r.activateCallStop(),r.activateResolveStart(),Promise.resolve(o).then(d=>(r.activateResolveStop(),d))}catch(n){return Promise.reject(n)}else return Promise.resolve(i)}_activateOneStartupFinished(e,t){this._activateById(e.identifier,{startup:!1,extensionId:e.identifier,activationEvent:t}).then(void 0,i=>{this._logService.error(i)})}_activateAllStartupFinishedDeferred(e,t=0){const s=Date.now();Pf(()=>{for(let r=t;r<e.length;r+=1){const n=e[r];for(const o of n.activationEvents??[])if(o==="onStartupFinished")if(Date.now()-s>50){this._activateAllStartupFinishedDeferred(e,r);break}else this._activateOneStartupFinished(n,o)}})}_activateAllStartupFinished(){this._mainThreadExtensionsProxy.$setPerformanceMarks(Tf()),this._extHostConfiguration.getConfigProvider().then(e=>{const t=e.getConfiguration("extensions.experimental").get("deferredStartupFinishedActivation"),i=this._myRegistry.getAllExtensionDescriptions();if(t)this._activateAllStartupFinishedDeferred(i);else for(const s of i)if(s.activationEvents)for(const r of s.activationEvents)r==="onStartupFinished"&&this._activateOneStartupFinished(s,r)})}_handleEagerExtensions(){const e=this._activateByEvent("*",!0).then(void 0,n=>{this._logService.error(n)});this._register(this._extHostWorkspace.onDidChangeWorkspace(n=>this._handleWorkspaceContainsEagerExtensions(n.added)));const t=this._extHostWorkspace.workspace?this._extHostWorkspace.workspace.folders:[],i=this._handleWorkspaceContainsEagerExtensions(t),s=this._handleRemoteResolverEagerExtensions(),r=Promise.all([s,e,i]).then(()=>{});return Promise.race([r,si(1e4)]).then(()=>{this._activateAllStartupFinished()}),r}_handleWorkspaceContainsEagerExtensions(e){return e.length===0?Promise.resolve(void 0):Promise.all(this._myRegistry.getAllExtensionDescriptions().map(t=>this._handleWorkspaceContainsEagerExtension(e,t))).then(()=>{})}async _handleWorkspaceContainsEagerExtension(e,t){if(this.isActivated(t.identifier))return;const i=!this._initData.remote.isRemote&&!!this._initData.remote.authority,s={logService:this._logService,folders:e.map(n=>n.uri),forceUsingSearch:i||!this._hostUtils.fsExists,exists:n=>this._hostUtils.fsExists(n.fsPath),checkExists:(n,o,d)=>this._mainThreadWorkspaceProxy.$checkExists(n,o,d)},r=await Up(s,t);if(r)return this._activateById(t.identifier,{startup:!0,extensionId:t.identifier,activationEvent:r.activationEvent}).then(void 0,n=>this._logService.error(n))}async _handleRemoteResolverEagerExtensions(){if(this._initData.remote.authority)return this._activateByEvent(`onResolveRemoteAuthority:${this._initData.remote.authority}`,!1)}async $extensionTestsExecute(){await this._eagerExtensionsActivated.wait();try{return await this._doHandleExtensionTests()}catch(e){throw console.error(e),e}}async _doHandleExtensionTests(){const{extensionDevelopmentLocationURI:e,extensionTestsLocationURI:t}=this._initData.environment;if(!e||!t)throw new Error(J(2556,"Cannot load test runner."));const i=(await this.getExtensionPathIndex()).findSubstr(t),r=await(this._isESM(i,t.path)?this._loadESMModule(null,t,new Kr(!1)):this._loadCommonJSModule(null,t,new Kr(!1)));if(!r||typeof r.run!="function")throw new Error(J(2557,"Path {0} does not point to a valid extension test runner.",t.toString()));return new Promise((n,o)=>{const d=(g,m)=>{g?(Ct&&this._logService.error("Test runner called back with error",g),o(g)):(Ct&&(m?this._logService.info(`Test runner called back with ${m} failures.`):this._logService.info("Test runner called back with successful outcome.")),n(typeof m=="number"&&m>0?1:0))},c=ll(t),h=r.run(c,d);h&&h.then&&h.then(()=>{Ct&&this._logService.info("Test runner finished successfully."),n(0)}).catch(g=>{Ct&&this._logService.error("Test runner finished with error",g),o(g instanceof Error&&g.stack?g.stack:String(g))})})}_startExtensionHost(){if(this._started)throw new Error("Extension host is already started!");return this._started=!0,this._readyToStartExtensionHost.wait().then(()=>this._readyToRunExtensions.open()).then(()=>Promise.race([this._activator.waitForActivatingExtensions(),si(1e3)])).then(()=>this._handleEagerExtensions()).then(()=>{this._eagerExtensionsActivated.open(),this._logService.info("Eager extensions activated")})}registerRemoteAuthorityResolver(e,t){return this._resolvers[e]=t,B(()=>{delete this._resolvers[e]})}async getRemoteExecServer(e){const{resolver:t}=await this._activateAndGetResolver(e);return t?.resolveExecServer?.(e,{resolveAttempt:0})}async _activateAndGetResolver(e){const t=e.indexOf("+");if(t===-1)throw new Jt("Not an authority that can be resolved!",fs.InvalidAuthority);const i=e.substr(0,t);return await this._almostReadyToRunExtensions.wait(),await this._activateByEvent(`onResolveRemoteAuthority:${i}`,!1),{authorityPrefix:i,resolver:this._resolvers[i]}}async $resolveAuthority(e,t){const i=di.create(!1),s=()=>`[resolveAuthority(${Nd(e)},${t})][${i.elapsed()}ms] `,r=S=>this._logService.info(`${s()}${S}`),n=S=>this._logService.warn(`${s()}${S}`),o=(S,T=void 0)=>this._logService.error(`${s()}${S}`,T),d=S=>{if(S instanceof Jt)return{type:"error",error:{code:S._code,message:S._message,detail:S._detail}};throw S},c=async S=>{r(`activating resolver for ${S}...`);const{resolver:T,authorityPrefix:O}=await this._activateAndGetResolver(S);if(!T)throw o(`no resolver for ${O}`),new Jt(`No remote extension installed to resolve ${O}.`,fs.NoResolverFound);return{resolver:T,authorityPrefix:O,remoteAuthority:S}},h=e.split(/@|%40/g).reverse();r(`activating remote resolvers ${h.join(" -> ")}`);let g;try{g=await Promise.all(h.map(c)).catch(async S=>{if(!(S instanceof Jt)||S._code!==fs.InvalidAuthority)throw S;return n(`resolving nested authorities failed: ${S.message}`),[await c(e)]})}catch(S){return d(S)}const m=new kf;m.cancelAndSet(()=>r("waiting..."),1e3);let l,f;for(const[S,{authorityPrefix:T,resolver:O,remoteAuthority:I}]of g.entries())try{if(S===g.length-1)r("invoking final resolve()..."),We(`code/extHost/willResolveAuthority/${T}`),l=await O.resolve(I,{resolveAttempt:t,execServer:f}),We(`code/extHost/didResolveAuthorityOK/${T}`),r("setting tunnel factory..."),this._register(await this._extHostTunnelService.setTunnelFactory(O,Is.isManagedResolvedAuthority(l)?l:void 0));else{if(r(`invoking resolveExecServer() for ${I}`),We(`code/extHost/willResolveExecServer/${T}`),f=await O.resolveExecServer?.(I,{resolveAttempt:t,execServer:f}),!f)throw new Jt(`Exec server was not available for ${I}`,fs.NoResolverFound);We(`code/extHost/didResolveExecServerOK/${T}`)}}catch(K){return We(`code/extHost/didResolveAuthorityError/${T}`),o("returned an error",K),m.dispose(),d(K)}m.dispose();const _={environmentTunnels:l.environmentTunnels,features:l.tunnelFeatures?{elevation:l.tunnelFeatures.elevation,privacyOptions:l.tunnelFeatures.privacyOptions,protocol:l.tunnelFeatures.protocol===void 0?!0:l.tunnelFeatures.protocol}:void 0},x={extensionHostEnv:l.extensionHostEnv,isTrusted:l.isTrusted,authenticationSession:l.authenticationSessionForInitializingExtensions?{id:l.authenticationSessionForInitializingExtensions.id,providerId:l.authenticationSessionForInitializingExtensions.providerId}:void 0};r(`returned ${Is.isManagedResolvedAuthority(l)?"managed authority":`${l.host}:${l.port}`}`);let C;if(Is.isManagedResolvedAuthority(l)){const S=t;this._extHostManagedSockets.setFactory(S,l.makeConnection),C={authority:e,connectTo:new Wp(S),connectionToken:l.connectionToken}}else C={authority:e,connectTo:new Bp(l.host,l.port),connectionToken:l.connectionToken};return{type:"ok",value:{authority:C,options:x,tunnelInformation:_}}}async $getCanonicalURI(e,t){this._logService.info(`$getCanonicalURI invoked for authority (${Nd(e)})`);const{resolver:i}=await this._activateAndGetResolver(e);if(!i)return null;const s=v.revive(t);if(typeof i.getCanonicalURI>"u")return s;const r=await we(()=>i.getCanonicalURI(s));return r||s}async $startExtensionHost(e){e.toAdd.forEach(n=>n.extensionLocation=v.revive(n.extensionLocation));const{globalRegistry:t,myExtensions:i}=_c(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),s=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(s),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),Ct&&(this._logService.info(`$startExtensionHost: global extensions: ${Qt(this._globalRegistry)}`),this._logService.info(`$startExtensionHost: local extensions: ${Qt(this._myRegistry)}`)),this._startExtensionHost()}$activateByEvent(e,t){return t===If.Immediate?this._almostReadyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1)):this._readyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1))}async $activate(e,t){return await this._readyToRunExtensions.wait(),this._myRegistry.getExtensionDescription(e)?(await this._activateById(e,t),!0):!1}async $deltaExtensions(e){e.toAdd.forEach(n=>n.extensionLocation=v.revive(n.extensionLocation));const{globalRegistry:t,myExtensions:i}=_c(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),s=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(s),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),Ct&&(this._logService.info(`$deltaExtensions: global extensions: ${Qt(this._globalRegistry)}`),this._logService.info(`$deltaExtensions: local extensions: ${Qt(this._myRegistry)}`)),Promise.resolve(void 0)}async $test_latency(e){return e}async $test_up(e){return e.byteLength}async $test_down(e){const t=be.alloc(e),i=Math.random()%256;for(let s=0;s<e;s++)t.writeUInt8(i,s);return t}async $updateRemoteConnectionData(e){this._remoteConnectionData=e,this._onDidChangeRemoteConnectionData.fire()}_isESM(e,t){return t??=e?.main,t?.endsWith(".mjs")||e?.type==="module"&&!t?.endsWith(".cjs")}};ko=To=L([E(0,ha),E(1,ju),E(2,j),E(3,st),E(4,rt),E(5,re),E(6,Se),E(7,zu),E(8,Sa),E(9,mi),E(10,Na),E(11,Oa),E(12,Fa)],ko);function _c(a,e,t,i){a.addActivationEvents(i.addActivationEvents);const s=new Oi(a,e.getAllExtensionDescriptions());s.deltaExtensions(i.toAdd,i.toRemove);const r=new ss(t.getAllExtensionDescriptions().map(o=>o.identifier));for(const o of i.myToRemove)r.delete(o);for(const o of i.myToAdd)r.add(o);const n=Ku(s,r);return{globalRegistry:s,myExtensions:n}}function vc(a,e){return{id:a.identifier.value,name:a.name,extensionVersion:a.version,publisherDisplayName:a.publisher,activationEvents:a.activationEvents?a.activationEvents.join(","):null,isBuiltin:a.isBuiltin,reason:e.activationEvent,reasonId:e.extensionId.value}}function Qt(a){return a.getAllExtensionDescriptions().map(e=>e.identifier.value).join(",")}const Wt=ee("IExtHostExtensionService");class Mi{#e;#t;#i;constructor(e,t,i,s,r){this.#e=e,this.#t=t,this.#i=i.identifier,this.id=i.identifier.value,this.extensionUri=i.extensionLocation,this.extensionPath=hn(ll(i.extensionLocation)),this.packageJSON=i,this.extensionKind=s,this.isFromDifferentExtensionHost=r}get isActive(){return this.#e.isActivated(this.#i)}get exports(){if(!(this.packageJSON.api==="none"||this.isFromDifferentExtensionHost))return this.#e.getExtensionExports(this.#i)}async activate(){if(this.isFromDifferentExtensionHost)throw new Error("Cannot activate foreign extension");return await this.#e.activateByIdWithErrors(this.#i,{startup:!1,extensionId:this.#t,activationEvent:"api"}),this.exports}}function Ku(a,e){return a.getAllExtensionDescriptions().filter(t=>e.has(t.identifier))}class ky{constructor(e){this._searchTree=e}setSearchTree(e){this._searchTree=e}findSubstr(e){return this._searchTree.findSubstr(e)}forEach(e){return this._searchTree.forEach(e)}}class Iy{constructor(e){this._map=new Lt,this.addActivationEvents(e)}readActivationEvents(e){return this._map.get(e.identifier)??[]}addActivationEvents(e){for(const t of Object.keys(e))this._map.set(t,e[t])}}var yc;(function(a){a.ViewletId="workbench.view.extension.test",a.ExplorerViewId="workbench.view.testing",a.OutputPeekContributionId="editor.contrib.testingOutputPeek",a.DecorationsContributionId="editor.contrib.testingDecorations",a.CoverageDecorationsContributionId="editor.contrib.coverageDecorations",a.CoverageViewId="workbench.view.testCoverage",a.ResultsPanelId="workbench.panel.testResults",a.ResultsViewId="workbench.panel.testResults.view",a.MessageLanguageId="vscodeInternalTestMessage"})(yc||(yc={}));var wc;(function(a){a.List="list",a.Tree="true"})(wc||(wc={}));var xc;(function(a){a.ByLocation="location",a.ByStatus="status",a.ByDuration="duration"})(xc||(xc={}));$e.Errored+"",J(11044,"Errored"),$e.Failed+"",J(11045,"Failed"),$e.Passed+"",J(11046,"Passed"),$e.Queued+"",J(11047,"Queued"),$e.Running+"",J(11048,"Running"),$e.Skipped+"",J(11049,"Skipped"),$e.Unset+"",J(11050,"Not yet run");Or.Debug+"",J(11052,"Debug"),Or.Run+"",J(11053,"Run"),Or.Coverage+"",J(11054,"Coverage");var Io;(function(a){a.CancelTestRefreshAction="testing.cancelTestRefresh",a.CancelTestRunAction="testing.cancelRun",a.ClearTestResultsAction="testing.clearTestResults",a.CollapseAllAction="testing.collapseAll",a.ConfigureTestProfilesAction="testing.configureProfile",a.ContinousRunUsingForTest="testing.continuousRunUsingForTest",a.CoverageAtCursor="testing.coverageAtCursor",a.CoverageByUri="testing.coverage.uri",a.CoverageClear="testing.coverage.close",a.CoverageCurrentFile="testing.coverageCurrentFile",a.CoverageFilterToTest="testing.coverageFilterToTest",a.CoverageFilterToTestInEditor="testing.coverageFilterToTestInEditor",a.CoverageLastRun="testing.coverageLastRun",a.CoverageSelectedAction="testing.coverageSelected",a.CoverageToggleToolbar="testing.coverageToggleToolbar",a.CoverageViewChangeSorting="testing.coverageViewChangeSorting",a.DebugAction="testing.debug",a.DebugAllAction="testing.debugAll",a.DebugAtCursor="testing.debugAtCursor",a.DebugByUri="testing.debug.uri",a.DebugCurrentFile="testing.debugCurrentFile",a.DebugFailedTests="testing.debugFailTests",a.DebugLastRun="testing.debugLastRun",a.DebugSelectedAction="testing.debugSelected",a.FilterAction="workbench.actions.treeView.testExplorer.filter",a.GetExplorerSelection="_testing.getExplorerSelection",a.GetSelectedProfiles="testing.getSelectedProfiles",a.GoToTest="testing.editFocusedTest",a.GoToRelatedTest="testing.goToRelatedTest",a.PeekRelatedTest="testing.peekRelatedTest",a.GoToRelatedCode="testing.goToRelatedCode",a.PeekRelatedCode="testing.peekRelatedCode",a.HideTestAction="testing.hideTest",a.OpenCoverage="testing.openCoverage",a.OpenOutputPeek="testing.openOutputPeek",a.RefreshTestsAction="testing.refreshTests",a.ReRunFailedTests="testing.reRunFailTests",a.ReRunLastRun="testing.reRunLastRun",a.RunAction="testing.run",a.RunAllAction="testing.runAll",a.RunAllWithCoverageAction="testing.coverageAll",a.RunAtCursor="testing.runAtCursor",a.RunByUri="testing.run.uri",a.RunCurrentFile="testing.runCurrentFile",a.RunSelectedAction="testing.runSelected",a.RunUsingProfileAction="testing.runUsing",a.RunWithCoverageAction="testing.coverage",a.SearchForTestExtension="testing.searchForTestExtension",a.SelectDefaultTestProfiles="testing.selectDefaultTestProfiles",a.ShowMostRecentOutputAction="testing.showMostRecentOutput",a.StartContinousRun="testing.startContinuousRun",a.StartContinousRunFromExtension="testing.startContinuousRunFromExtension",a.StopContinousRunFromExtension="testing.stopContinuousRunFromExtension",a.StopContinousRun="testing.stopContinuousRun",a.TestingSortByDurationAction="testing.sortByDuration",a.TestingSortByLocationAction="testing.sortByLocation",a.TestingSortByStatusAction="testing.sortByStatus",a.TestingViewAsListAction="testing.viewAsList",a.TestingViewAsTreeAction="testing.viewAsTree",a.ToggleContinousRunForTest="testing.toggleContinuousRunForTest",a.ToggleInlineTestOutput="testing.toggleInlineTestOutput",a.UnhideAllTestsAction="testing.unhideAllTests",a.UnhideTestAction="testing.unhideTest"})(Io||(Io={}));let Ry=0;const bc=new WeakMap,Cr=ee("IExtHostTesting");let Ro=class extends X{constructor(e,t,i,s){super(),this.logService=t,this.commands=i,this.editors=s,this.resultsChangedEmitter=this._register(new P),this.controllers=new Map,this.defaultProfilesChangedEmitter=this._register(new P),this.followupProviders=new Set,this.testFollowups=new Map,this.onResultsChanged=this.resultsChangedEmitter.event,this.results=[],this.proxy=e.getProxy(k.MainThreadTesting),this.observer=new Ly(this.proxy),this.runTracker=new My(this.proxy,t),i.registerArgumentProcessor({processArgument:r=>{switch(r?.$mid){case xe.TestItemContext:{const n=r,o=n.tests[n.tests.length-1].item.extId;return this.controllers.get(ne.root(o))?.collection.tree.get(o)?.actual??dc(r)}case xe.TestMessageMenuArgs:{const{test:n,message:o}=r,d=n.item.extId;return{test:this.controllers.get(ne.root(d))?.collection.tree.get(d)?.actual??dc({tests:[n]}),message:wn.to(o)}}default:return r}}}),i.registerCommand(!1,"testing.getExplorerSelection",async()=>{const r=await i.executeCommand(Io.GetExplorerSelection),n=o=>{const d=this.controllers.get(ne.root(o));if(d)return ne.isRoot(o)?d.controller:d.collection.tree.get(o)?.actual};return{include:r?.include.map(n).filter(Zt)||[],exclude:r?.exclude.map(n).filter(Zt)||[]}})}createTestController(e,t,i,s){if(this.controllers.has(t))throw new Error(`Attempt to insert a duplicate controller with ID "${t}"`);const r=new N,n=r.add(new ny(t,i,this.editors));n.root.label=i;const o=new Map,d=new Set,c=this.proxy,h=()=>{let l=0;s&&(l|=Ur.Refresh);const f=m.relatedCodeProvider;return f&&(f?.provideRelatedTests&&(l|=Ur.TestRelatedToCode),f?.provideRelatedCode&&(l|=Ur.CodeRelatedToTest)),l},g={items:n.root.children,get label(){return i},set label(l){i=l,n.root.label=l,c.$updateController(t,{label:i})},get refreshHandler(){return s},set refreshHandler(l){s=l,c.$updateController(t,{capabilities:h()})},get id(){return t},get relatedCodeProvider(){return m.relatedCodeProvider},set relatedCodeProvider(l){b(e,"testRelatedCode"),m.relatedCodeProvider=l,c.$updateController(t,{capabilities:h()})},createRunProfile:(l,f,_,x,C,S)=>{let T=ul(l);for(;o.has(T);)T++;return new Qu(this.proxy,o,d,this.defaultProfilesChangedEmitter.event,t,T,l,f,_,x,C,S)},createTestItem(l,f,_){return new Ot(t,l,f,_)},createTestRun:(l,f,_=!0)=>this.runTracker.createTestRun(e,t,n,l,f,_),invalidateTestResults:l=>{if(l===void 0)this.proxy.$markTestRetired(void 0);else{const f=l instanceof Array?l:[l];this.proxy.$markTestRetired(f.map(_=>ne.fromExtHostTestItem(_,t).toString()))}},set resolveHandler(l){n.resolveHandler=l},get resolveHandler(){return n.resolveHandler},dispose:()=>{r.dispose()}},m={controller:g,collection:n,profiles:o,extension:e,activeProfiles:d};return c.$registerTestController(t,i,h()),r.add(B(()=>c.$unregisterTestController(t))),this.controllers.set(t,m),r.add(B(()=>this.controllers.delete(t))),r.add(n.onDidGenerateDiff(l=>c.$publishDiff(t,l.map(Od.serialize)))),g}createTestObserver(){return this.observer.checkout()}async runTests(e,t=ue.None){const i=Gu(e);if(!i)throw new Error("The request passed to `vscode.test.runTests` must include a profile");const s=this.controllers.get(i.controllerId);if(!s)throw new Error("Controller not found");await this.proxy.$runTests({preserveFocus:e.preserveFocus??!0,group:Ca.from(i.kind),targets:[{testIds:e.include?.map(r=>ne.fromExtHostTestItem(r,s.collection.root.id).toString())??[s.collection.root.id],profileId:i.profileId,controllerId:i.controllerId}],exclude:e.exclude?.map(r=>r.id)},t)}registerTestFollowupProvider(e){return this.followupProviders.add(e),{dispose:()=>{this.followupProviders.delete(e)}}}async $getTestsRelatedToCode(e,t,i){const s=this.editors.getDocument(v.revive(e));if(!s)return[];const r=Z.to(t),n=[];return await Promise.all([...this.controllers.values()].map(async o=>{let d;try{d=await o.relatedCodeProvider?.provideRelatedTests?.(s.document,r,i)}catch(c){i.isCancellationRequested||this.logService.warn(`Error thrown while providing related tests for ${o.controller.label}`,c)}if(d){for(const c of d)n.push(ne.fromExtHostTestItem(c,o.controller.id).toString());o.collection.flushDiff()}})),n}async $getCodeRelatedToTest(e,t){const i=this.controllers.get(ne.root(e));if(!i)return[];const s=i.collection.tree.get(e);return s?(await i.relatedCodeProvider?.provideRelatedCode?.(s.actual,t))?.map(tt.from)??[]:[]}$syncTests(){for(const{collection:e}of this.controllers.values())e.flushDiff();return Promise.resolve()}async $getCoverageDetails(e,t,i){return(await this.runTracker.getCoverageDetails(e,t,i))?.map(xn.fromDetails)}async $disposeRun(e){this.runTracker.disposeTestRun(e)}$configureRunProfile(e,t){this.controllers.get(e)?.profiles.get(t)?.configureHandler?.()}$setDefaultRunProfiles(e){const t=new Map;for(const[i,s]of Object.entries(e)){const r=this.controllers.get(i);if(!r)continue;const n=new Map,o=s.filter(c=>!r.activeProfiles.has(c)),d=[...r.activeProfiles].filter(c=>!s.includes(c));for(const c of o)n.set(c,!0),r.activeProfiles.add(c);for(const c of d)n.set(c,!1),r.activeProfiles.delete(c);n.size&&t.set(i,n)}this.defaultProfilesChangedEmitter.fire(t)}async $refreshTests(e,t){await this.controllers.get(e)?.controller.refreshHandler?.(t)}$publishTestResults(e){this.results=Object.freeze(e.map(t=>{const i=Vp.to(t),s=t.tasks.findIndex(r=>r.hasCoverage);return s!==-1&&(i.getDetailedCoverage=(r,n=ue.None)=>this.proxy.$getCoverageDetails(t.id,s,r,n).then(o=>o.map(xn.to))),bc.set(i,t.id),i}).concat(this.results).sort((t,i)=>i.completedAt-t.completedAt).slice(0,32)),this.resultsChangedEmitter.fire()}async $expandTest(e,t){const i=this.controllers.get(ne.fromString(e).controllerId)?.collection;i&&(await i.expand(e,t<0?1/0:t),i.flushDiff())}$acceptDiff(e){this.observer.applyDiff(e.map(t=>Od.deserialize({asCanonicalUri:i=>i},t)))}async $runControllerTests(e,t){return Promise.all(e.map(i=>this.runControllerTestRequest(i,!1,t)))}async $startContinuousRun(e,t){const i=new he(t),s=await Promise.all(e.map(r=>this.runControllerTestRequest(r,!0,i.token)));return!t.isCancellationRequested&&!s.some(r=>r.error)&&await new Promise(r=>t.onCancellationRequested(r)),i.dispose(!0),s}async $provideTestFollowups(e,t){const i=this.results.find(n=>bc.get(n)===e.resultId),s=i&&Ny(ne.fromString(e.extId),i?.results);if(!s)return[];let r=[];return await Promise.all([...this.followupProviders].map(async n=>{try{const o=await n.provideFollowup(i,s,e.taskIndex,e.messageIndex,t);o&&(r=r.concat(o))}catch(o){this.logService.error("Error thrown while providing followup for test message",o)}})),t.isCancellationRequested?[]:r.map(n=>{const o=Ry++;return this.testFollowups.set(o,n),{title:n.title,id:o}})}$disposeTestFollowups(e){for(const t of e)this.testFollowups.delete(t)}$executeTestFollowup(e){const t=this.testFollowups.get(e);return t?this.commands.executeCommand(t.command,...t.arguments||[]):Promise.resolve()}$cancelExtensionTestRun(e,t){e===void 0?this.runTracker.cancelAllRuns():this.runTracker.cancelRunById(e,t)}getMetadataForRun(e){for(const t of this.runTracker.trackers){const i=t.getTaskIdForRun(e);if(i)return{taskId:i,runId:t.id}}}async runControllerTestRequest(e,t,i){const s=this.controllers.get(e.controllerId);if(!s)return{};const{collection:r,profiles:n,extension:o}=s,d=n.get(e.profileId);if(!d)return{};const c=e.testIds.map(l=>r.tree.get(l)).filter(Zt),h=e.excludeExtIds.map(l=>s.collection.tree.get(l)).filter(Zt).filter(l=>c.some(f=>f.fullId.compare(l.fullId)===zp.IsChild));if(!c.length)return{};const g=new Fl(c.some(l=>l.actual instanceof Ra)?void 0:c.map(l=>l.actual),h.map(l=>l.actual),d,t),m=qp(e)&&this.runTracker.prepareForMainThreadTestRun(o,g,es.fromInternal(e,s.collection),d,i);try{return await d.runHandler(g,i),{}}catch(l){return{error:String(l)}}finally{m&&m.hasRunningTasks&&!i.isCancellationRequested&&await Ee.toPromise(m.onEnd)}}};Ro=L([E(0,j),E(1,re),E(2,Ut),E(3,gi)],Ro);const Ay=1e4;var ft;(function(a){a[a.Running=0]="Running",a[a.Cancelling=1]="Cancelling",a[a.Ended=2]="Ended"})(ft||(ft={}));class $y extends X{get hasRunningTasks(){return this.running>0}get id(){return this.dto.id}constructor(e,t,i,s,r,n){super(),this.dto=e,this.proxy=t,this.logService=i,this.profile=s,this.extension=r,this.state=ft.Running,this.running=0,this.tasks=new Map,this.sharedTestIds=new Set,this.endEmitter=this._register(new P),this.publishedCoverage=new Map,this.onEnd=this.endEmitter.event,this.cts=this._register(new he(n));const o=this._register(new dl(()=>this.forciblyEndTasks(),Ay));this._register(this.cts.token.onCancellationRequested(()=>o.schedule()));const d=new P;this.onDidDispose=d.event,this._register(B(()=>{d.fire(),d.dispose()}))}getTaskIdForRun(e){for(const[t,{run:i}]of this.tasks)if(i===e)return t}cancel(e){e?this.tasks.get(e)?.cts.cancel():this.state===ft.Running?(this.cts.cancel(),this.state=ft.Cancelling):this.state===ft.Cancelling&&this.forciblyEndTasks()}async getCoverageDetails(e,t,i){const[,s]=ne.fromString(e).path,r=this.publishedCoverage.get(e);if(!r)return[];const{report:n,extIds:o}=r,d=this.tasks.get(s);if(!d)throw new Error("unreachable: run task was not found");let c;if(t&&n instanceof bn){const g=o.indexOf(t);if(g===-1)return[];c=n.includesTests[g]}return await(c?this.profile?.loadDetailedCoverageForTest?.(d.run,n,c,i):this.profile?.loadDetailedCoverage?.(d.run,n,i))??[]}createRun(e){const t=this.dto.id,i=this.dto.controllerId,s=it(),r=h=>(g,...m)=>{if(o){this.logService.warn(`Setting the state of test "${g.id}" is a no-op after the run ends.`);return}this.ensureTestIsKnown(g),h(g,...m)},n=(h,g)=>{const m=g instanceof Array?g.map(wn.from):[wn.from(g)];if(h.uri&&h.range){const l={range:$.from(h.range),uri:h.uri};for(const f of m)f.location=f.location||l}this.proxy.$appendTestMessagesInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),m)};let o=!1;const d=this._register(new he(this.cts.token)),c={isPersisted:this.dto.isPersisted,token:d.token,name:e,onDidDispose:this.onDidDispose,addCoverage:h=>{if(o)return;const g=h instanceof bn?h.includesTests:[];if(g.length)for(const f of g)this.ensureTestIsKnown(f);const m=h.uri.toString(),l=new ne([t,s,m]).toString();this.publishedCoverage.set(l,{report:h,extIds:g.map(f=>ne.fromExtHostTestItem(f,i).toString())}),this.proxy.$appendCoverage(t,s,xn.fromFile(i,l,h))},enqueued:r(h=>{this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),$e.Queued)}),skipped:r(h=>{this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),$e.Skipped)}),started:r(h=>{this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),$e.Running)}),errored:r((h,g,m)=>{n(h,g),this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),$e.Errored,m)}),failed:r((h,g,m)=>{n(h,g),this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,i).toString(),$e.Failed,m)}),passed:r((h,g)=>{this.proxy.$updateTestStateInRun(t,s,ne.fromExtHostTestItem(h,this.dto.controllerId).toString(),$e.Passed,g)}),appendOutput:(h,g,m)=>{o||(m&&this.ensureTestIsKnown(m),this.proxy.$appendOutputToRun(t,s,be.fromString(h),g&&tt.from(g),m&&ne.fromExtHostTestItem(m,i).toString()))},end:()=>{o||(o=!0,this.proxy.$finishedTestRunTask(t,s),--this.running||this.markEnded())}};return this.running++,this.tasks.set(s,{run:c,cts:d}),this.proxy.$startedTestRunTask(t,{id:s,ctrlId:this.dto.controllerId,name:e||this.extension.displayName||this.extension.identifier.value,running:!0}),c}forciblyEndTasks(){for(const{run:e}of this.tasks.values())e.end()}markEnded(){this.state!==ft.Ended&&(this.state=ft.Ended,this.endEmitter.fire())}ensureTestIsKnown(e){if(!(e instanceof Ot))throw new Kp(e.id);if(this.sharedTestIds.has(ne.fromExtHostTestItem(e,this.dto.controllerId).toString()))return;const t=[],i=this.dto.colllection.root;for(;;){const s=ns.from(e);if(t.unshift(s),this.sharedTestIds.has(s.extId)||(this.sharedTestIds.add(s.extId),e===i))break;e=e.parent||i}this.proxy.$addTestsToRun(this.dto.controllerId,this.dto.id,t)}dispose(){this.markEnded(),super.dispose()}}class My{get trackers(){return this.tracked.values()}constructor(e,t){this.proxy=e,this.logService=t,this.tracked=new Map,this.trackedById=new Map}getCoverageDetails(e,t,i){const s=ne.root(e);return this.trackedById.get(s)?.getCoverageDetails(e,t,i)||[]}disposeTestRun(e){this.trackedById.get(e)?.dispose(),this.trackedById.delete(e);for(const[t,{id:i}]of this.tracked)i===e&&this.tracked.delete(t)}prepareForMainThreadTestRun(e,t,i,s,r){return this.getTracker(t,i,s,e,r)}cancelRunById(e,t){this.trackedById.get(e)?.cancel(t)}cancelAllRuns(){for(const e of this.tracked.values())e.cancel()}createTestRun(e,t,i,s,r,n){const o=this.tracked.get(s);if(o)return o.createRun(r);const d=es.fromPublic(t,i,s,n),c=Gu(s);this.proxy.$startedExtensionTestRun({controllerId:t,continuous:!!s.continuous,profile:c&&{group:Ca.from(c.kind),id:c.profileId},exclude:s.exclude?.map(g=>ne.fromExtHostTestItem(g,i.root.id).toString())??[],id:d.id,include:s.include?.map(g=>ne.fromExtHostTestItem(g,i.root.id).toString())??[i.root.id],preserveFocus:s.preserveFocus??!0,persist:n});const h=this.getTracker(s,d,s.profile,e);return Ee.once(h.onEnd)(()=>{this.proxy.$finishedExtensionTestRun(d.id)}),h.createRun(r)}getTracker(e,t,i,s,r){const n=new $y(t,this.proxy,this.logService,i,s,r);return this.tracked.set(e,n),this.trackedById.set(n.id,n),n}}const Gu=a=>{if(a.profile){if(!(a.profile instanceof Qu))throw new Error("TestRunRequest.profile is not an instance created from TestController.createRunProfile");return a.profile}};class es{static fromPublic(e,t,i,s){return new es(e,it(),s,t)}static fromInternal(e,t){return new es(e.controllerId,e.runId,!0,t)}constructor(e,t,i,s){this.controllerId=e,this.id=t,this.isPersisted=i,this.colllection=s}}class Hy{get isEmpty(){return this.added.size===0&&this.removed.size===0&&this.updated.size===0}constructor(e){this.emitter=e,this.added=new Set,this.updated=new Set,this.removed=new Set,this.alreadyRemoved=new Set}add(e){this.added.add(e)}update(e){Object.assign(e.revived,ns.toPlain(e.item)),this.added.has(e)||this.updated.add(e)}remove(e){if(this.added.has(e)){this.added.delete(e);return}this.updated.delete(e);const t=ne.parentId(e.item.extId);if(t&&this.alreadyRemoved.has(t.toString())){this.alreadyRemoved.add(e.item.extId);return}this.removed.add(e)}getChangeEvent(){const{added:e,updated:t,removed:i}=this;return{get added(){return[...e].map(s=>s.revived)},get updated(){return[...t].map(s=>s.revived)},get removed(){return[...i].map(s=>s.revived)}}}complete(){this.isEmpty||this.emitter.fire(this.getChangeEvent())}}class Fy extends jp{constructor(){super(...arguments),this.changeEmitter=new P,this.onDidChangeTests=this.changeEmitter.event}get rootTests(){return this.roots}getMirroredTestDataById(e){return this.items.get(e)}getMirroredTestDataByReference(e){return this.items.get(e.id)}createItem(e,t){return{...e,revived:ns.toPlain(e.item),depth:t?t.depth+1:0,children:new Set}}createChangeCollector(){return new Hy(this.changeEmitter)}}class Ly{constructor(e){this.proxy=e}checkout(){this.current||(this.current=this.createObserverData());const e=this.current;return e.observers++,{onDidChangeTest:e.tests.onDidChangeTests,get tests(){return[...e.tests.rootTests].map(t=>t.revived)},dispose:Af(()=>{--e.observers===0&&(this.proxy.$unsubscribeFromDiffs(),this.current=void 0)})}}getMirroredTestDataByReference(e){return this.current?.tests.getMirroredTestDataByReference(e)}applyDiff(e){this.current?.tests.apply(e)}createObserverData(){const e=new Fy({asCanonicalUri:t=>t});return this.proxy.$subscribeToDiffs(),{observers:0,tests:e}}}const Si=(a,e,t,i)=>{t?Object.assign(t,i):e.$updateTestRunConfig(a.controllerId,a.profileId,i)};class Qu extends bl{#e;#t;#i;#s;#n;get label(){return this._label}set label(e){e!==this._label&&(this._label=e,Si(this,this.#e,this.#s,{label:e}))}get supportsContinuousRun(){return this._supportsContinuousRun}set supportsContinuousRun(e){e!==this._supportsContinuousRun&&(this._supportsContinuousRun=e,Si(this,this.#e,this.#s,{supportsContinuousRun:e}))}get isDefault(){return this.#t.has(this.profileId)}set isDefault(e){e!==this.isDefault&&(e?this.#t.add(this.profileId):this.#t.delete(this.profileId),Si(this,this.#e,this.#s,{isDefault:e}))}get tag(){return this._tag}set tag(e){e?.id!==this._tag?.id&&(this._tag=e,Si(this,this.#e,this.#s,{tag:e?Xi.namespace(this.controllerId,e.id):null}))}get configureHandler(){return this._configureHandler}set configureHandler(e){e!==this._configureHandler&&(this._configureHandler=e,Si(this,this.#e,this.#s,{hasConfigurationHandler:!!e}))}get onDidChangeDefault(){return Ee.chain(this.#i,e=>e.map(t=>t.get(this.controllerId)?.get(this.profileId)).filter(Zt))}constructor(e,t,i,s,r,n,o,d,c,h=!1,g=void 0,m=!1){super(r,n,d),this._label=o,this.runHandler=c,this._tag=g,this._supportsContinuousRun=m,this.#e=e,this.#n=t,this.#t=i,this.#i=s,t.set(n,this);const l=Ca.from(d);h&&i.add(n),this.#s={profileId:n,controllerId:r,tag:g?Xi.namespace(this.controllerId,g.id):null,label:o,group:l,isDefault:h,hasConfigurationHandler:!1,supportsContinuousRun:m},queueMicrotask(()=>{this.#s&&(this.#e.$publishTestRunProfile(this.#s),this.#s=void 0)})}dispose(){this.#n?.delete(this.profileId)&&(this.#n=void 0,this.#e.$removeTestProfile(this.controllerId,this.profileId)),this.#s=void 0}}function Ny(a,e){for(let t=0;t<a.path.length;t++){const i=e.find(s=>s.id===a.path[t]);if(!i)return;if(t===a.path.length-1)return i;e=i.children}}const Ua=ee("IExtHostVariableResolverProvider");class Oy extends jv{constructor(e,t,i,s,r,n,o){function d(){if(i){const c=i.activeEditor();if(c)return c.document.uri;const h=s.tabGroups.all.find(g=>g.isActive)?.activeTab;if(h!==void 0){if(h.input instanceof er||h.input instanceof ya)return h.input.modified;if(h.input instanceof ba||h.input instanceof wa||h.input instanceof xa)return h.input.uri}}}super({getFolderUri:c=>{const h=n.folders.filter(g=>g.name===c);if(h&&h.length>0)return h[0].uri},getWorkspaceFolderCount:()=>n.folders.length,getConfigurationValue:(c,h)=>r.getConfiguration(void 0,c).get(h),getAppRoot:()=>$f(),getExecPath:()=>xd.VSCODE_EXEC_PATH,getFilePath:()=>{const c=d();if(c)return hn(c.fsPath)},getWorkspaceFolderPathForFile:()=>{if(t){const c=d();if(c){const h=t.getWorkspaceFolder(c);if(h)return hn(h.uri.fsPath)}}},getSelectedText:()=>{if(i){const c=i.activeEditor();if(c&&!c.selection.isEmpty)return c.document.getText(c.selection)}},getLineNumber:()=>{if(i){const c=i.activeEditor();if(c)return String(c.selection.end.line+1)}},getColumnNumber:()=>{if(i){const c=i.activeEditor();if(c)return String(c.selection.end.character+1)}},getExtension:c=>e.getExtension(c)},void 0,o?Promise.resolve(o):void 0,Promise.resolve(xd))}}let Ao=class extends X{constructor(e,t,i,s,r){super(),this.extensionService=e,this.workspaceService=t,this.editorService=i,this.configurationService=s,this.editorTabs=r,this._resolver=new Li(async()=>{const n=await this.configurationService.getConfigProvider(),d={folders:await this.workspaceService.getWorkspaceFolders2()||[]};return this._register(this.workspaceService.onDidChangeWorkspace(async c=>{d.folders=await this.workspaceService.getWorkspaceFolders2()||[]})),new Oy(this.extensionService,this.workspaceService,this.editorService,this.editorTabs,n,d,this.homeDir())})}getResolver(){return this._resolver.value}homeDir(){}};Ao=L([E(0,Wt),E(1,st),E(2,gi),E(3,rt),E(4,os)],Ao);const Ju=ee("IExtHostDebugService");let $o=class extends X{get onDidStartDebugSession(){return this._onDidStartDebugSession.event}get onDidTerminateDebugSession(){return this._onDidTerminateDebugSession.event}get onDidChangeActiveDebugSession(){return this._onDidChangeActiveDebugSession.event}get activeDebugSession(){return this._activeDebugSession?.api}get onDidReceiveDebugSessionCustomEvent(){return this._onDidReceiveDebugSessionCustomEvent.event}get activeDebugConsole(){return this._activeDebugConsole.value}constructor(e,t,i,s,r,n,o,d){super(),this._workspaceService=t,this._extensionService=i,this._configurationService=s,this._editorTabs=r,this._variableResolver=n,this._commands=o,this._testing=d,this._debugSessions=new Map,this._debugVisualizationTreeItemIdsCounter=0,this._debugVisualizationProviders=new Map,this._debugVisualizationTrees=new Map,this._debugVisualizationTreeItemIds=new WeakMap,this._debugVisualizationElements=new Map,this._visualizers=new Map,this._visualizerIdCounter=0,this._configProviderHandleCounter=0,this._configProviders=[],this._adapterFactoryHandleCounter=0,this._adapterFactories=[],this._trackerFactoryHandleCounter=0,this._trackerFactories=[],this._debugAdapters=new Map,this._debugAdaptersTrackers=new Map,this._onDidStartDebugSession=this._register(new P),this._onDidTerminateDebugSession=this._register(new P),this._onDidChangeActiveDebugSession=this._register(new P),this._onDidReceiveDebugSessionCustomEvent=this._register(new P),this._debugServiceProxy=e.getProxy(k.MainThreadDebugService),this._onDidChangeBreakpoints=this._register(new P),this._onDidChangeActiveStackItem=this._register(new P),this._activeDebugConsole=new Wy(this._debugServiceProxy),this._breakpoints=new Map,this._extensionService.getExtensionRegistry().then(c=>{this._register(c.onDidChange(h=>{this.registerAllDebugTypes(c)})),this.registerAllDebugTypes(c)}),this._telemetryProxy=e.getProxy(k.MainThreadTelemetry)}async $getVisualizerTreeItem(e,t){const i=this.hydrateVisualizationContext(t);if(!i)return;const s=await this._debugVisualizationTrees.get(e)?.getTreeItem?.(i);return s?this.convertVisualizerTreeItem(e,s):void 0}registerDebugVisualizationTree(e,t,i){const s=ge.toKey(e.identifier),r=this.extensionVisKey(s,t);if(this._debugVisualizationProviders.has(r))throw new Error(`A debug visualization provider with id '${t}' is already registered`);return this._debugVisualizationTrees.set(r,i),this._debugServiceProxy.$registerDebugVisualizerTree(r,!!i.editItem),B(()=>{this._debugServiceProxy.$unregisterDebugVisualizerTree(r),this._debugVisualizationTrees.delete(t)})}async $getVisualizerTreeItemChildren(e,t){const i=this._debugVisualizationElements.get(t)?.item;return i?(await this._debugVisualizationTrees.get(e)?.getChildren?.(i))?.map(r=>this.convertVisualizerTreeItem(e,r))||[]:[]}async $editVisualizerTreeItem(e,t){const i=this._debugVisualizationElements.get(e);if(!i)return;const s=await this._debugVisualizationTrees.get(i.provider)?.editItem?.(i.item,t);return this.convertVisualizerTreeItem(i.provider,s||i.item)}$disposeVisualizedTree(e){const t=this._debugVisualizationElements.get(e);if(!t)return;const i=[t.children];for(const s of i)if(s)for(const r of s)i.push(this._debugVisualizationElements.get(r)?.children),this._debugVisualizationElements.delete(r)}convertVisualizerTreeItem(e,t){let i=this._debugVisualizationTreeItemIds.get(t);return i||(i=this._debugVisualizationTreeItemIdsCounter++,this._debugVisualizationTreeItemIds.set(t,i),this._debugVisualizationElements.set(i,{provider:e,item:t})),Gp.from(t,i)}asDebugSourceUri(e,t){const i=e;if(typeof i.sourceReference=="number"&&i.sourceReference>0){let s=`debug:${encodeURIComponent(i.path||"")}`,r="?";return t&&(s+=`${r}session=${encodeURIComponent(t.id)}`,r="&"),s+=`${r}ref=${i.sourceReference}`,v.parse(s)}else{if(i.path)return v.file(i.path);throw new Error("cannot create uri from DAP 'source' object; properties 'path' and 'sourceReference' are both missing.")}}registerAllDebugTypes(e){const t=[];for(const i of e.getAllExtensionDescriptions())if(i.contributes){const s=i.contributes.debuggers;if(s&&s.length>0)for(const r of s)Qp(r)&&t.push(r.type)}this._debugServiceProxy.$registerDebugTypes(t)}get activeStackItem(){return this._activeStackItem}get onDidChangeActiveStackItem(){return this._onDidChangeActiveStackItem.event}get onDidChangeBreakpoints(){return this._onDidChangeBreakpoints.event}get breakpoints(){const e=[];return this._breakpoints.forEach(t=>e.push(t)),e}async $resolveDebugVisualizer(e,t){const i=this._visualizers.get(e);if(!i)throw new Error(`No debug visualizer found with id '${e}'`);let{v:s,provider:r,extensionId:n}=i;if(s.visualization||(s=await r.resolveDebugVisualization?.(s,t)||s,i.v=s),!s.visualization)throw new Error(`No visualization returned from resolveDebugVisualization in '${r}'`);return this.serializeVisualization(n,s.visualization)}async $executeDebugVisualizerCommand(e){const t=this._visualizers.get(e);if(!t)throw new Error(`No debug visualizer found with id '${e}'`);const i=t.v.visualization;i&&"command"in i&&this._commands.executeCommand(i.command,...i.arguments||[])}hydrateVisualizationContext(e){const t=this._debugSessions.get(e.sessionId);return t&&{session:t.api,variable:e.variable,containerId:e.containerId,frameId:e.frameId,threadId:e.threadId}}async $provideDebugVisualizers(e,t,i,s){const r=this.hydrateVisualizationContext(i),n=this.extensionVisKey(e,t),o=this._debugVisualizationProviders.get(n);if(!r||!o)return[];const d=await o.provideDebugVisualization(r,s);return d?d.map(c=>{const h=++this._visualizerIdCounter;this._visualizers.set(h,{v:c,provider:o,extensionId:e});const g=c.iconPath?this.getIconPathOrClass(c.iconPath):void 0;return{id:h,name:c.name,iconClass:g?.iconClass,iconPath:g?.iconPath,visualization:this.serializeVisualization(e,c.visualization)}}):[]}$disposeDebugVisualizers(e){for(const t of e)this._visualizers.delete(t)}registerDebugVisualizationProvider(e,t,i){if(!e.contributes?.debugVisualizers?.some(n=>n.id===t))throw new Error(`Extensions may only call registerDebugVisualizationProvider() for renderers they contribute (got ${t})`);const s=ge.toKey(e.identifier),r=this.extensionVisKey(s,t);if(this._debugVisualizationProviders.has(r))throw new Error(`A debug visualization provider with id '${t}' is already registered`);return this._debugVisualizationProviders.set(r,i),this._debugServiceProxy.$registerDebugVisualizer(s,t),B(()=>{this._debugServiceProxy.$unregisterDebugVisualizer(s,t),this._debugVisualizationProviders.delete(t)})}addBreakpoints(e){const t=e.filter(r=>{const n=r.id;return this._breakpoints.has(n)?!1:(this._breakpoints.set(n,r),!0)});this.fireBreakpointChanges(t,[],[]);const i=[],s=new Map;for(const r of t)if(r instanceof Ii){let n=s.get(r.location.uri.toString());n||(n={type:"sourceMulti",uri:r.location.uri,lines:[]},s.set(r.location.uri.toString(),n),i.push(n)),n.lines.push({id:r.id,enabled:r.enabled,condition:r.condition,hitCondition:r.hitCondition,logMessage:r.logMessage,line:r.location.range.start.line,character:r.location.range.start.character,mode:r.mode})}else r instanceof Ri&&i.push({type:"function",id:r.id,enabled:r.enabled,hitCondition:r.hitCondition,logMessage:r.logMessage,condition:r.condition,functionName:r.functionName,mode:r.mode});return this._debugServiceProxy.$registerBreakpoints(i)}removeBreakpoints(e){const t=e.filter(n=>this._breakpoints.delete(n.id));this.fireBreakpointChanges([],t,[]);const i=t.filter(n=>n instanceof Ii).map(n=>n.id),s=t.filter(n=>n instanceof Ri).map(n=>n.id),r=t.filter(n=>n instanceof Ud).map(n=>n.id);return this._debugServiceProxy.$unregisterBreakpoints(i,s,r)}startDebugging(e,t,i){const s=i.testRun&&this._testing.getMetadataForRun(i.testRun);return this._debugServiceProxy.$startDebugging(e?e.uri:void 0,t,{parentSessionID:i.parentSession?i.parentSession.id:void 0,lifecycleManagedByParent:i.lifecycleManagedByParent,repl:i.consoleMode===Ll.MergeWithParent?"mergeWithParent":"separate",noDebug:i.noDebug,compact:i.compact,suppressSaveBeforeStart:i.suppressSaveBeforeStart,testRun:s&&{runId:s.runId,taskId:s.taskId},suppressDebugStatusbar:i.suppressDebugStatusbar??i.debugUI?.simple,suppressDebugToolbar:i.suppressDebugToolbar??i.debugUI?.simple,suppressDebugView:i.suppressDebugView??i.debugUI?.simple})}stopDebugging(e){return this._debugServiceProxy.$stopDebugging(e?e.id:void 0)}registerDebugConfigurationProvider(e,t,i){if(!t)return new V(()=>{});const s=this._configProviderHandleCounter++;return this._configProviders.push({type:e,handle:s,provider:t}),this._debugServiceProxy.$registerDebugConfigurationProvider(e,i,!!t.provideDebugConfigurations,!!t.resolveDebugConfiguration,!!t.resolveDebugConfigurationWithSubstitutedVariables,s),new V(()=>{this._configProviders=this._configProviders.filter(r=>r.provider!==t),this._debugServiceProxy.$unregisterDebugConfigurationProvider(s)})}registerDebugAdapterDescriptorFactory(e,t,i){if(!i)return new V(()=>{});if(!this.definesDebugType(e,t))throw new Error(`a DebugAdapterDescriptorFactory can only be registered from the extension that defines the '${t}' debugger.`);if(this.getAdapterDescriptorFactoryByType(t))throw new Error("a DebugAdapterDescriptorFactory can only be registered once per a type.");const s=this._adapterFactoryHandleCounter++;return this._adapterFactories.push({type:t,handle:s,factory:i}),this._debugServiceProxy.$registerDebugAdapterDescriptorFactory(t,s),new V(()=>{this._adapterFactories=this._adapterFactories.filter(r=>r.factory!==i),this._debugServiceProxy.$unregisterDebugAdapterDescriptorFactory(s)})}registerDebugAdapterTrackerFactory(e,t){if(!t)return new V(()=>{});const i=this._trackerFactoryHandleCounter++;return this._trackerFactories.push({type:e,handle:i,factory:t}),new V(()=>{this._trackerFactories=this._trackerFactories.filter(s=>s.factory!==t)})}async $runInTerminal(e,t){return Promise.resolve(void 0)}async $substituteVariables(e,t){let i;const s=await this.getFolder(e);return s&&(i={uri:s.uri,name:s.name,index:s.index,toResource:()=>{throw new Error("Not implemented")}}),(await this._variableResolver.getResolver()).resolveAsync(i,t)}createDebugAdapter(e,t){if(e instanceof En)return new Vy(e.implementation)}createSignService(){}async $startDASession(e,t){const i=this,s=await this.getSession(t);return this.getAdapterDescriptor(this.getAdapterDescriptorFactoryByType(s.type),s).then(r=>{if(!r)throw new Error(`Couldn't find a debug adapter descriptor for debug type '${s.type}' (extension might have failed to activate)`);const n=this.createDebugAdapter(r,s);if(!n)throw new Error(`Couldn't create a debug adapter for type '${s.type}'.`);const o=n;return this._debugAdapters.set(e,o),this.getDebugAdapterTrackers(s).then(d=>(d&&this._debugAdaptersTrackers.set(e,d),o.onMessage(async c=>{if(c.type==="request"&&c.command==="handshake"){const h=c,g={type:"response",seq:0,command:h.command,request_seq:h.seq,success:!0};this._signService||(this._signService=this.createSignService());try{if(this._signService){const m=await this._signService.sign(h.arguments.value);g.body={signature:m},o.sendResponse(g)}else throw new Error("no signer")}catch(m){g.success=!1,g.message=m.message,o.sendResponse(g)}}else{d&&d.onDidSendMessage&&d.onDidSendMessage(c);try{c=Jp(c,!0)}catch(h){const g=c.type+"_"+(c.command??c.event??"");throw this._telemetryProxy.$publicLog2("debugProtocolMessageError",{type:g,from:s.type}),h}i._debugServiceProxy.$acceptDAMessage(e,c)}}),o.onError(c=>{d&&d.onError&&d.onError(c),this._debugServiceProxy.$acceptDAError(e,c.name,c.message,c.stack)}),o.onExit(c=>{d&&d.onExit&&d.onExit(c??void 0,void 0),this._debugServiceProxy.$acceptDAExit(e,c??void 0,void 0)}),d&&d.onWillStartSession&&d.onWillStartSession(),o.startSession()))})}$sendDAMessage(e,t){t=Xp(t,!1);const i=this._debugAdaptersTrackers.get(e);i&&i.onWillReceiveMessage&&i.onWillReceiveMessage(t),this._debugAdapters.get(e)?.sendMessage(t)}$stopDASession(e){const t=this._debugAdaptersTrackers.get(e);this._debugAdaptersTrackers.delete(e),t&&t.onWillStopSession&&t.onWillStopSession();const i=this._debugAdapters.get(e);return this._debugAdapters.delete(e),i?i.stopSession():Promise.resolve(void 0)}$acceptBreakpointsDelta(e){const t=[],i=[],s=[];if(e.added)for(const r of e.added){const n=r.id;if(n&&!this._breakpoints.has(n)){let o;if(r.type==="function")o=new Ri(r.functionName,r.enabled,r.condition,r.hitCondition,r.logMessage,r.mode);else if(r.type==="data")o=new Ud(r.label,r.dataId,r.canPersist,r.enabled,r.hitCondition,r.condition,r.logMessage,r.mode);else{const d=v.revive(r.uri);o=new Ii(new li(d,new Fe(r.line,r.character)),r.enabled,r.condition,r.hitCondition,r.logMessage,r.mode)}Yp(o,n),this._breakpoints.set(n,o),t.push(o)}}if(e.removed)for(const r of e.removed){const n=this._breakpoints.get(r);n&&(this._breakpoints.delete(r),i.push(n))}if(e.changed){for(const r of e.changed)if(r.id){const n=this._breakpoints.get(r.id);if(n){if(n instanceof Ri&&r.type==="function"){const o=n;o.enabled=r.enabled,o.condition=r.condition,o.hitCondition=r.hitCondition,o.logMessage=r.logMessage,o.functionName=r.functionName}else if(n instanceof Ii&&r.type==="source"){const o=n;o.enabled=r.enabled,o.condition=r.condition,o.hitCondition=r.hitCondition,o.logMessage=r.logMessage,o.location=new li(v.revive(r.uri),new Fe(r.line,r.character))}s.push(n)}}}this.fireBreakpointChanges(t,i,s)}async $acceptStackFrameFocus(e){let t;if(e){const i=await this.getSession(e.sessionId);e.kind==="thread"?t=new Nl(i.api,e.threadId):t=new Ol(i.api,e.threadId,e.frameId)}this._activeStackItem=t,this._onDidChangeActiveStackItem.fire(this._activeStackItem)}$provideDebugConfigurations(e,t,i){return we(async()=>{const s=this.getConfigProviderByHandle(e);if(!s)throw new Error("no DebugConfigurationProvider found");if(!s.provideDebugConfigurations)throw new Error("DebugConfigurationProvider has no method provideDebugConfigurations");const r=await this.getFolder(t);return s.provideDebugConfigurations(r,i)}).then(s=>{if(!s)throw new Error("nothing returned from DebugConfigurationProvider.provideDebugConfigurations");return s})}$resolveDebugConfiguration(e,t,i,s){return we(async()=>{const r=this.getConfigProviderByHandle(e);if(!r)throw new Error("no DebugConfigurationProvider found");if(!r.resolveDebugConfiguration)throw new Error("DebugConfigurationProvider has no method resolveDebugConfiguration");const n=await this.getFolder(t);return r.resolveDebugConfiguration(n,i,s)})}$resolveDebugConfigurationWithSubstitutedVariables(e,t,i,s){return we(async()=>{const r=this.getConfigProviderByHandle(e);if(!r)throw new Error("no DebugConfigurationProvider found");if(!r.resolveDebugConfigurationWithSubstitutedVariables)throw new Error("DebugConfigurationProvider has no method resolveDebugConfigurationWithSubstitutedVariables");const n=await this.getFolder(t);return r.resolveDebugConfigurationWithSubstitutedVariables(n,i,s)})}async $provideDebugAdapter(e,t){const i=this.getAdapterDescriptorFactoryByHandle(e);if(!i)return Promise.reject(new Error("no adapter descriptor factory found for handle"));const s=await this.getSession(t);return this.getAdapterDescriptor(i,s).then(r=>{if(!r)throw new Error(`Couldn't find a debug adapter descriptor for debug type '${s.type}'`);return this.convertToDto(r)})}async $acceptDebugSessionStarted(e){const t=await this.getSession(e);this._onDidStartDebugSession.fire(t.api)}async $acceptDebugSessionTerminated(e){const t=await this.getSession(e);t&&(this._onDidTerminateDebugSession.fire(t.api),this._debugSessions.delete(t.id))}async $acceptDebugSessionActiveChanged(e){this._activeDebugSession=e?await this.getSession(e):void 0,this._onDidChangeActiveDebugSession.fire(this._activeDebugSession?.api)}async $acceptDebugSessionNameChanged(e,t){(await this.getSession(e))?._acceptNameChanged(t)}async $acceptDebugSessionCustomEvent(e,t){const s={session:(await this.getSession(e)).api,event:t.event,body:t.body};this._onDidReceiveDebugSessionCustomEvent.fire(s)}convertToDto(e){if(e instanceof Ul)return this.convertExecutableToDto(e);if(e instanceof Sn)return this.convertServerToDto(e);if(e instanceof Wl)return this.convertPipeServerToDto(e);if(e instanceof En)return this.convertImplementationToDto(e);throw new Error("convertToDto unexpected type")}convertExecutableToDto(e){return{type:"executable",command:e.command,args:e.args,options:e.options}}convertServerToDto(e){return{type:"server",port:e.port,host:e.host}}convertPipeServerToDto(e){return{type:"pipeServer",path:e.path}}convertImplementationToDto(e){return{type:"implementation"}}getAdapterDescriptorFactoryByType(e){const t=this._adapterFactories.filter(i=>i.type===e);if(t.length>0)return t[0].factory}getAdapterDescriptorFactoryByHandle(e){const t=this._adapterFactories.filter(i=>i.handle===e);if(t.length>0)return t[0].factory}getConfigProviderByHandle(e){const t=this._configProviders.filter(i=>i.handle===e);if(t.length>0)return t[0].provider}definesDebugType(e,t){if(e.contributes){const i=e.contributes.debuggers;if(i&&i.length>0){for(const s of i)if(s.label&&s.type&&s.type===t)return!0}}return!1}getDebugAdapterTrackers(e){const i=e.configuration.type,s=this._trackerFactories.filter(r=>r.type===i||r.type==="*").map(r=>we(()=>r.factory.createDebugAdapterTracker(e.api)).then(n=>n,n=>null));return Promise.race([Promise.all(s).then(r=>{const n=Re(r);if(n.length>0)return new By(n)}),new Promise(r=>setTimeout(()=>r(void 0),1e3))]).catch(r=>{})}async getAdapterDescriptor(e,t){const i=t.configuration.debugServer;if(typeof i=="number")return Promise.resolve(new Sn(i));if(e){const r=await this._extensionService.getExtensionRegistry();return we(()=>e.createDebugAdapterDescriptor(t.api,this.daExecutableFromPackage(t,r))).then(n=>{if(n)return n})}const s=await this._extensionService.getExtensionRegistry();return Promise.resolve(this.daExecutableFromPackage(t,s))}daExecutableFromPackage(e,t){}fireBreakpointChanges(e,t,i){(e.length>0||t.length>0||i.length>0)&&this._onDidChangeBreakpoints.fire(Object.freeze({added:e,removed:t,changed:i}))}async getSession(e){if(e)if(typeof e=="string"){const t=this._debugSessions.get(e);if(t)return t}else{let t=this._debugSessions.get(e.id);if(!t){const i=await this.getFolder(e.folderUri),s=e.parent?this._debugSessions.get(e.parent):void 0;t=new Uy(this._debugServiceProxy,e.id,e.type,e.name,i,e.configuration,s?.api),this._debugSessions.set(t.id,t),this._debugServiceProxy.$sessionCached(t.id)}return t}throw new Error("cannot find session")}getFolder(e){if(e){const t=v.revive(e);return this._workspaceService.resolveWorkspaceFolder(t)}return Promise.resolve(void 0)}extensionVisKey(e,t){return`${e}\0${t}`}serializeVisualization(e,t){if(t){if("title"in t&&"command"in t)return{type:Wd.Command};if("treeId"in t)return{type:Wd.Tree,id:`${e}\0${t.treeId}`};throw new Error("Unsupported debug visualization type")}}getIconPathOrClass(e){const t=this.getIconUris(e);let i,s;return"id"in t?s=rs.asClassName(t):i=t,{iconPath:i,iconClass:s}}getIconUris(e){if(e instanceof Et)return{id:e.id};const t=typeof e=="object"&&"dark"in e?e.dark:e,i=typeof e=="object"&&"light"in e?e.light:e;return{dark:typeof t=="string"?v.file(t):t,light:typeof i=="string"?v.file(i):i}}};$o=L([E(0,j),E(1,st),E(2,Wt),E(3,rt),E(4,os),E(5,Ua),E(6,Ut),E(7,Cr)],$o);class Uy{constructor(e,t,i,s,r,n,o){this._debugServiceProxy=e,this._id=t,this._type=i,this._name=s,this._workspaceFolder=r,this._configuration=n,this._parentSession=o}get api(){const e=this;return this.apiSession??=Object.freeze({id:e._id,type:e._type,get name(){return e._name},set name(t){e._name=t,e._debugServiceProxy.$setDebugSessionName(e._id,t)},parentSession:e._parentSession,workspaceFolder:e._workspaceFolder,configuration:e._configuration,customRequest(t,i){return e._debugServiceProxy.$customDebugAdapterRequest(e._id,t,i)},getDebugProtocolBreakpoint(t){return e._debugServiceProxy.$getDebugProtocolBreakpoint(e._id,t.id)}})}get id(){return this._id}get type(){return this._type}_acceptNameChanged(e){this._name=e}get configuration(){return this._configuration}}class Wy{constructor(e){this.value=Object.freeze({append(t){e.$appendDebugConsole(t)},appendLine(t){this.append(t+`
`)}})}}class By{constructor(e){this.trackers=e}onWillStartSession(){this.trackers.forEach(e=>e.onWillStartSession?e.onWillStartSession():void 0)}onWillReceiveMessage(e){this.trackers.forEach(t=>t.onWillReceiveMessage?t.onWillReceiveMessage(e):void 0)}onDidSendMessage(e){this.trackers.forEach(t=>t.onDidSendMessage?t.onDidSendMessage(e):void 0)}onWillStopSession(){this.trackers.forEach(e=>e.onWillStopSession?e.onWillStopSession():void 0)}onError(e){this.trackers.forEach(t=>t.onError?t.onError(e):void 0)}onExit(e,t){this.trackers.forEach(i=>i.onExit?i.onExit(e,t):void 0)}}class Vy extends Zp{constructor(e){super(),this.implementation=e,e.onDidSendMessage(t=>{this.acceptMessage(t)})}startSession(){return Promise.resolve(void 0)}sendMessage(e){this.implementation.handleMessage(e)}stopSession(){return this.implementation.dispose(),Promise.resolve(void 0)}}let Mo=class extends $o{constructor(e,t,i,s,r,n,o,d){super(e,t,i,s,r,n,o,d)}};Mo=L([E(0,j),E(1,st),E(2,Wt),E(3,rt),E(4,os),E(5,Ua),E(6,Ut),E(7,Cr)],Mo);function zy(a){return"uri"in a&&"ranges"in a&&"preview"in a}function qy(a){return a.folderOptions.map(e=>({folder:e.folder,excludes:e.excludes.map(t=>typeof t=="string"?t:t.pattern),includes:e.includes,useGlobalIgnoreFiles:e.useIgnoreFiles.global,useIgnoreFiles:e.useIgnoreFiles.local,useParentIgnoreFiles:e.useIgnoreFiles.parent,followSymlinks:e.followSymlinks,maxResults:a.maxResults,session:a.session}))}class Xu{constructor(e){this.provider=e}provideFileSearchResults(e,t,i){return(async()=>{const r=qy(t);return Promise.all(r.map(n=>this.provider.provideFileSearchResults({pattern:e},n,i)))})().then(r=>Re(r).flat())}}function jy(a){return a.folderOptions.map(e=>({folder:e.folder,excludes:e.excludes.map(t=>typeof t=="string"?t:t.pattern),includes:e.includes,useGlobalIgnoreFiles:e.useIgnoreFiles.global,useIgnoreFiles:e.useIgnoreFiles.local,useParentIgnoreFiles:e.useIgnoreFiles.parent,followSymlinks:e.followSymlinks,maxResults:a.maxResults,previewOptions:Ky(a.previewOptions),maxFileSize:a.maxFileSize,encoding:e.encoding,afterContext:a.surroundingContext,beforeContext:a.surroundingContext}))}function Ky(a){return{matchLines:a?.matchLines??Cn.matchLines,charsPerLine:a?.charsPerLine??Cn.charsPerLine}}function Gy(a){if(zy(a)){const e=je(a.ranges).map((t,i)=>{const r=je(a.preview.matches)[i];return{sourceRange:t,previewRange:r}});return new _t(a.uri,e,a.preview.text)}else return new ga(a.uri,a.text,a.lineNumber)}class Qy{constructor(e){this.provider=e}provideTextSearchResults(e,t,i,s){const r=d=>{Jy(d)&&i.report(Gy(d))};return(async()=>Re(await Promise.all(jy(t).map(d=>this.provider.provideTextSearchResults(e,d,{report:c=>r(c)},s)))).reduce((d,c)=>({limitHit:d.limitHit||c.limitHit}),{limitHit:!1}))().then(d=>({limitHit:d.limitHit,message:Re(je(d.message))}))}}function Jy(a){if(Xy(a)){if(Array.isArray(a.ranges)){if(!Array.isArray(a.preview.matches))return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same type."),!1;if(a.preview.matches.length!==a.ranges.length)return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same length."),!1}else if(Array.isArray(a.preview.matches))return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same length."),!1}return!0}function Xy(a){return!!a.preview}class Yu extends aa{constructor(e,t,i=()=>!1){const s=new Mf(i,()=>!1);super(s);const r=new Ye;e.forEach((n,o)=>{const d=n.folder.with({query:"",fragment:""});r.has(d)?r.get(d).push({fq:n,i:o}):r.set(d,[{fq:n,i:o}])}),r.forEach((n,o)=>{const d=new Map;for(const c of n){const h=t(c.fq,c.i);d.set(this.encodeKey(c.fq.folder),h)}super.set(o,d)})}findQueryFragmentAwareSubstr(e){const t=super.findSubstr(e.with({query:"",fragment:""}));if(!t)return;const i=this.encodeKey(e);return t.get(i)}forEachFolderQueryInfo(e){return this.forEach(t=>t.forEach(i=>e(i)))}encodeKey(e){let t="";return e.query&&(t+=e.query),e.fragment&&(t+="#"+e.fragment),t}}class Yy{constructor(e,t,i){this.config=e,this.provider=t,this.sessionLifecycle=i,this.isLimitHit=!1,this.resultCount=0,this.isCanceled=!1,this.filePattern=e.filePattern,this.includePattern=e.includePattern&&fn(e.includePattern),this.maxResults=e.maxResults||void 0,this.exists=e.exists,this.activeCancellationTokens=new Set,this.globalExcludePattern=e.excludePattern&&fn(e.excludePattern)}cancel(){this.isCanceled=!0,this.activeCancellationTokens.forEach(e=>e.cancel()),this.activeCancellationTokens=new Set}search(e){const t=this.config.folderQueries||[];return new Promise((i,s)=>{const r=n=>{this.resultCount++,e(n)};if(this.isCanceled)return i({limitHit:this.isLimitHit});this.config.extraFileResources&&this.config.extraFileResources.forEach(n=>{const o=n.toString(),d=ki(o);this.globalExcludePattern&&this.globalExcludePattern(o,d)||this.matchFile(r,{base:n,basename:d})}),this.doSearch(t,r).then(n=>{i({limitHit:this.isLimitHit,stats:n||void 0})},n=>{s(new Error(vr(n)))})})}async doSearch(e,t){const i=new he,s=e.map(h=>this.getSearchOptionsForFolder(h)),r=this.provider instanceof Xu?this.sessionLifecycle?.tokenSource.token:this.sessionLifecycle?.obj,n={folderOptions:s,maxResults:this.config.maxResults??Bl,session:r},o=h=>{const g=new zl(this.config,h),m=!g.hasSiblingExcludeClauses();return{queryTester:g,noSiblingsClauses:m,folder:h.folder,tree:this.initDirectoryTree()}},d=new Yu(e,o);let c;try{this.activeCancellationTokens.add(i),c=di.create();const h=await this.provider.provideFileSearchResults(this.config.filePattern||"",n,i.token),g=c.elapsed(),m=di.create();return this.isCanceled&&!this.isLimitHit||(h&&h.forEach(l=>{const f=d.findQueryFragmentAwareSubstr(l),_=Hf.relative(f.folder.path,l.path);if(f.noSiblingsClauses){const x=ki(l.path);this.matchFile(t,{base:f.folder,relativePath:_,basename:x});return}this.addDirectoryEntries(f.tree,f.folder,_,t)}),this.isCanceled&&!this.isLimitHit)?null:(d.forEachFolderQueryInfo(l=>{this.matchDirectoryTree(l.tree,l.queryTester,t)}),{providerTime:g,postProcessTime:m.elapsed()})}finally{i.dispose(),this.activeCancellationTokens.delete(i)}}getSearchOptionsForFolder(e){const t=ri(this.config.includePattern,e.includePattern);let i=e.excludePattern?.map(r=>({folder:r.folder,patterns:ri(this.config.excludePattern,r.pattern)}));i?.length||(i=[{folder:void 0,patterns:ri(this.config.excludePattern,void 0)}]);const s=Vl(i);return{folder:e.folder,excludes:s,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks}}initDirectoryTree(){const e={rootEntries:[],pathToEntries:Object.create(null)};return e.pathToEntries["."]=e.rootEntries,e}addDirectoryEntries({pathToEntries:e},t,i,s){if(i===this.filePattern){const n=ki(this.filePattern);this.matchFile(s,{base:t,relativePath:this.filePattern,basename:n})}function r(n){const o=ki(n),d=rl(n);let c=e[d];c||(c=e[d]=[],r(d)),c.push({base:t,relativePath:n,basename:o})}r(i)}matchDirectoryTree({rootEntries:e,pathToEntries:t},i,s){const r=this,n=this.filePattern;function o(d){const c=eg(()=>d.map(h=>h.basename));for(let h=0,g=d.length;h<g;h++){const m=d[h],{relativePath:l,basename:f}=m;if(i.matchesExcludesSync(l,f,n!==f?c:void 0))continue;const _=t[l];if(_)o(_);else{if(l===n)continue;r.matchFile(s,m)}if(r.isLimitHit)break}}o(e)}matchFile(e,t){(!this.includePattern||t.relativePath&&this.includePattern(t.relativePath,t.basename))&&((this.exists||this.maxResults&&this.resultCount>=this.maxResults)&&(this.isLimitHit=!0,this.cancel()),this.isLimitHit||e(t))}}class Zy{constructor(){this._obj=new Object,this.tokenSource=new he}get obj(){if(this._obj)return this._obj;throw new Error("Session object has been dereferenced.")}cancel(){this.tokenSource.cancel(),this._obj=void 0}}class Wa{constructor(){this.sessions=new Map}static{this.BATCH_SIZE=512}fileSearch(e,t,i,s){const r=this.getSessionTokenSource(e.cacheKey),n=new Yy(e,t,r);let o=0;const d=c=>{o+=c.length,i(c.map(h=>this.rawMatchToSearchItem(h)))};return this.doSearch(n,Wa.BATCH_SIZE,d,s).then(c=>({limitHit:c.limitHit,stats:c.stats?{fromCache:!1,type:"fileSearchProvider",resultCount:o,detailStats:c.stats}:void 0,messages:[]}))}clearCache(e){this.sessions.get(e)?.cancel(),this.sessions.delete(e)}getSessionTokenSource(e){if(e)return this.sessions.has(e)||this.sessions.set(e,new Zy),this.sessions.get(e)}rawMatchToSearchItem(e){return e.relativePath?{resource:Js(e.base,e.relativePath)}:{resource:e.base}}doSearch(e,t,i,s){const r=s.onCancellationRequested(()=>{e.cancel()}),n=d=>{d&&(o.push(d),t>0&&o.length>=t&&(i(o),o=[]))};let o=[];return e.search(n).then(d=>(o.length&&i(o),r.dispose(),d),d=>(o.length&&i(o),r.dispose(),Promise.reject(d)))}}class Ec{constructor(e,t,i){this.queryProviderPair=e,this.fileUtils=t,this.processType=i,this.collector=null,this.isLimitHit=!1,this.resultCount=0}get query(){return this.queryProviderPair.query}search(e,t,i){const s=this.query.folderQueries||[],r=new he(t);return new Promise((n,o)=>{this.collector=new tw(e);let d=!1;const c=(h,g)=>{if(!(h instanceof Dn)&&!d&&!this.isLimitHit){const m=this.resultSize(h);h instanceof _t&&typeof this.query.maxResults=="number"&&this.resultCount+m>this.query.maxResults&&(this.isLimitHit=!0,d=!0,r.cancel(),h=this.trimResultToSize(h,this.query.maxResults-this.resultCount));const l=this.resultSize(h);this.resultCount+=l;const f=h instanceof _t;(l>0||!f)&&this.collector.add(h,g)}};this.doSearch(s,c,r.token,i).then(h=>{r.dispose(),this.collector.flush(),n({limitHit:this.isLimitHit||h?.limitHit,messages:this.getMessagesFromResults(h),stats:{type:this.processType}})},h=>{r.dispose();const g=vr(h);o(new Error(g))})})}getMessagesFromResults(e){return e?.message?Array.isArray(e.message)?e.message:[e.message]:[]}resultSize(e){return e instanceof _t?Array.isArray(e.ranges)?e.ranges.length:1:0}trimResultToSize(e,t){return new _t(e.uri,e.ranges.slice(0,t),e.previewText)}async doSearch(e,t,i,s){const r=new Yu(e,(g,m)=>({queryTester:new zl(this.query,g),folder:g.folder,folderIdx:m}),()=>!0),n=[],o={report:g=>{if(g instanceof Dn)s?.(g);else{if(g.uri===void 0)throw Error("Text search result URI is undefined. Please check provider implementation.");const m=r.findQueryFragmentAwareSubstr(g.uri),l=m.folder.scheme===q.file?tg(()=>this.fileUtils.readdir(oa(g.uri))):void 0,f=sl(m.folder,g.uri);if(f){const _=m.queryTester.includedInQuery(f,ki(f),l);Ff(_)?n.push(_.then(x=>{x&&t(g,m.folderIdx)})):_&&t(g,m.folderIdx)}}}},c={folderOptions:e.map(g=>this.getSearchOptionsForFolder(g)),maxFileSize:this.query.maxFileSize,maxResults:this.query.maxResults??Bl,previewOptions:this.query.previewOptions??Cn,surroundingContext:this.query.surroundingContext??0};"usePCRE2"in this.query&&(c.usePCRE2=this.query.usePCRE2);let h;return this.queryProviderPair.query.type===ql.aiText?h=await this.queryProviderPair.provider.provideAITextSearchResults(this.queryProviderPair.query.contentPattern,c,o,i):h=await this.queryProviderPair.provider.provideTextSearchResults(ew(this.queryProviderPair.query.contentPattern),c,o,i),n.length&&await Promise.all(n),h}getSearchOptionsForFolder(e){const t=ri(this.query.includePattern,e.includePattern);let i=e.excludePattern?.map(n=>({folder:n.folder,patterns:ri(this.query.excludePattern,n.pattern)}));(!i||i.length===0)&&(i=[{folder:void 0,patterns:ri(this.query.excludePattern,void 0)}]);const s=Vl(i);return{folder:v.from(e.folder),excludes:s,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks,encoding:(e.fileEncoding&&this.fileUtils.toCanonicalName(e.fileEncoding))??""}}}function ew(a){return{isCaseSensitive:a.isCaseSensitive||!1,isRegExp:a.isRegExp||!1,isWordMatch:a.isWordMatch||!1,isMultiline:a.isMultiline||!1,pattern:a.pattern}}class tw{constructor(e){this._onResult=e,this._currentFolderIdx=-1,this._currentFileMatch=null,this._batchedCollector=new lr(512,t=>this.sendItems(t))}add(e,t){this._currentFileMatch&&(this._currentFolderIdx!==t||!Lf(this._currentUri,e.uri))&&(this.pushToCollector(),this._currentFileMatch=null),this._currentFileMatch||(this._currentFolderIdx=t,this._currentFileMatch={resource:e.uri,results:[]}),this._currentFileMatch.results.push(iw(e))}pushToCollector(){const e=this._currentFileMatch&&this._currentFileMatch.results?this._currentFileMatch.results.length:0;this._batchedCollector.addItem(this._currentFileMatch,e)}flush(){this.pushToCollector(),this._batchedCollector.flush()}sendItems(e){this._onResult(e)}}function iw(a){return a instanceof _t?{previewText:a.previewText,rangeLocations:a.ranges.map(e=>({preview:{startLineNumber:e.previewRange.start.line,startColumn:e.previewRange.start.character,endLineNumber:e.previewRange.end.line,endColumn:e.previewRange.end.character},source:{startLineNumber:e.sourceRange.start.line,startColumn:e.sourceRange.start.character,endLineNumber:e.sourceRange.end.line,endColumn:e.sourceRange.end.character}}))}:{text:a.text,lineNumber:a.lineNumber}}class lr{static{this.TIMEOUT=4e3}static{this.START_BATCH_AFTER_COUNT=50}constructor(e,t){this.maxBatchSize=e,this.cb=t,this.totalNumberCompleted=0,this.batch=[],this.batchSize=0}addItem(e,t){e&&this.addItemToBatch(e,t)}addItems(e,t){e&&this.addItemsToBatch(e,t)}addItemToBatch(e,t){this.batch.push(e),this.batchSize+=t,this.onUpdate()}addItemsToBatch(e,t){this.batch=this.batch.concat(e),this.batchSize+=t,this.onUpdate()}onUpdate(){this.totalNumberCompleted<lr.START_BATCH_AFTER_COUNT?this.flush():this.batchSize>=this.maxBatchSize?this.flush():this.timeoutHandle||(this.timeoutHandle=setTimeout(()=>{this.flush()},lr.TIMEOUT))}flush(){this.batchSize&&(this.totalNumberCompleted+=this.batchSize,this.cb(this.batch),this.batch=[],this.batchSize=0,this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=0))}}const Zu=ee("IExtHostSearch");let Ho=class{constructor(e,t,i){this.extHostRpc=e,this._uriTransformer=t,this._logService=i,this._proxy=this.extHostRpc.getProxy(k.MainThreadSearch),this._handlePool=0,this._textSearchProvider=new Map,this._textSearchUsedSchemes=new Set,this._aiTextSearchProvider=new Map,this._aiTextSearchUsedSchemes=new Set,this._fileSearchProvider=new Map,this._fileSearchUsedSchemes=new Set,this._fileSearchManager=new Wa}_transformScheme(e){return this._uriTransformer.transformOutgoingScheme(e)}registerTextSearchProviderOld(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const i=this._handlePool++;return this._textSearchProvider.set(i,new Qy(t)),this._proxy.$registerTextSearchProvider(i,this._transformScheme(e)),B(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerTextSearchProvider(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const i=this._handlePool++;return this._textSearchProvider.set(i,t),this._proxy.$registerTextSearchProvider(i,this._transformScheme(e)),B(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerAITextSearchProvider(e,t){if(this._aiTextSearchUsedSchemes.has(e))throw new Error(`an AI text search provider for the scheme '${e}'is already registered`);this._aiTextSearchUsedSchemes.add(e);const i=this._handlePool++;return this._aiTextSearchProvider.set(i,t),this._proxy.$registerAITextSearchProvider(i,this._transformScheme(e)),B(()=>{this._aiTextSearchUsedSchemes.delete(e),this._aiTextSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerFileSearchProviderOld(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const i=this._handlePool++;return this._fileSearchProvider.set(i,new Xu(t)),this._proxy.$registerFileSearchProvider(i,this._transformScheme(e)),B(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerFileSearchProvider(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const i=this._handlePool++;return this._fileSearchProvider.set(i,t),this._proxy.$registerFileSearchProvider(i,this._transformScheme(e)),B(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}$provideFileSearchResults(e,t,i,s){const r=Gr(i),n=this._fileSearchProvider.get(e);if(n)return this._fileSearchManager.fileSearch(r,n,o=>{this._proxy.$handleFileMatch(e,t,o.map(d=>d.resource))},s);throw new Error("unknown provider: "+e)}async doInternalFileSearchWithCustomCallback(e,t,i){return{messages:[]}}$clearCache(e){return this._fileSearchManager.clearCache(e),Promise.resolve(void 0)}$provideTextSearchResults(e,t,i,s){const r=this._textSearchProvider.get(e);if(!r||!r.provideTextSearchResults)throw new Error(`Unknown Text Search Provider ${e}`);const n=Gr(i);return this.createTextSearchManager(n,r).search(d=>this._proxy.$handleTextMatch(e,t,d),s)}$provideAITextSearchResults(e,t,i,s){const r=this._aiTextSearchProvider.get(e);if(!r||!r.provideAITextSearchResults)throw new Error(`Unknown AI Text Search Provider ${e}`);const n=Gr(i);return this.createAITextSearchManager(n,r).search(d=>this._proxy.$handleTextMatch(e,t,d),s,d=>this._proxy.$handleKeywordResult(e,t,d))}$enableExtensionHostSearch(){}async $getAIName(e){const t=this._aiTextSearchProvider.get(e);if(!(!t||!t.provideAITextSearchResults))return t.name??"AI"}createTextSearchManager(e,t){return new Ec({query:e,provider:t},{readdir:i=>Promise.resolve([]),toCanonicalName:i=>i},"textSearchProvider")}createAITextSearchManager(e,t){return new Ec({query:e,provider:t},{readdir:i=>Promise.resolve([]),toCanonicalName:i=>i},"aiTextSearchProvider")}};Ho=L([E(0,j),E(1,br),E(2,re)],Ho);function Gr(a){return{...a,folderQueries:a.folderQueries&&a.folderQueries.map(sw),extraFileResources:a.extraFileResources&&a.extraFileResources.map(e=>v.revive(e))}}function sw(a){return ze(a)}var Fo;let Lo=class{static{Fo=this}static{this.InitialState={focused:!0,active:!0}}getState(){const e=this._state;return{get focused(){return e.focused},get active(){return e.active}}}constructor(e,t){this._onDidChangeWindowState=new P,this.onDidChangeWindowState=this._onDidChangeWindowState.event,this._state=Fo.InitialState,e.handle&&(this._nativeHandle=bd(e.handle).buffer),this._proxy=t.getProxy(k.MainThreadWindow),this._proxy.$getInitialState().then(({isFocused:i,isActive:s})=>{this.onDidChangeWindowProperty("focused",i),this.onDidChangeWindowProperty("active",s)})}get nativeHandle(){return this._nativeHandle}$onDidChangeActiveNativeWindowHandle(e){this._nativeHandle=e?bd(e).buffer:void 0}$onDidChangeWindowFocus(e){this.onDidChangeWindowProperty("focused",e)}$onDidChangeWindowActive(e){this.onDidChangeWindowProperty("active",e)}onDidChangeWindowProperty(e,t){t!==this._state[e]&&(this._state={...this._state,[e]:t},this._onDidChangeWindowState.fire(this._state))}openUri(e,t){let i;if(typeof e=="string"){i=e;try{e=v.parse(e)}catch{return Promise.reject(`Invalid uri - '${e}'`)}}return pn(e.scheme)?Promise.reject("Invalid scheme - cannot be empty"):e.scheme===q.command?Promise.reject(`Invalid scheme '${e.scheme}'`):this._proxy.$openUri(e,i,t)}async asExternalUri(e,t){if(pn(e.scheme))return Promise.reject("Invalid scheme - cannot be empty");const i=await this._proxy.$asExternalUri(e,t);return v.from(i)}};Lo=Fo=L([E(0,Se),E(1,j)],Lo);const eh=ee("IExtHostWindow");let ur=class extends Nf{constructor(e,t){super(t.logLevel,t.logsLocation,t.loggers.map(i=>ze(i))),this._proxy=e.getProxy(k.MainThreadLogger)}$setLogLevel(e,t){t?this.setLogLevel(v.revive(t),e):this.setLogLevel(e)}setVisibility(e,t){super.setVisibility(e,t),this._proxy.$setVisibility(e,t)}doCreateLogger(e,t,i){return new rw(this._proxy,e,t,i)}};ur=L([E(0,j),E(1,Se)],ur);class rw extends tl{constructor(e,t,i,s){super(s?.logLevel==="always"),this.proxy=e,this.file=t,this.isLoggerCreated=!1,this.buffer=[],this.setLevel(i),this.proxy.$createLogger(t,s).then(()=>{this.doLog(this.buffer),this.isLoggerCreated=!0})}log(e,t){const i=[[e,t]];this.isLoggerCreated?this.doLog(i):this.buffer.push(...i)}doLog(e){this.proxy.$log(this.file,e)}flush(){this.proxy.$flush(this.file)}}const th=ee("IExtHostTerminalShellIntegration");let No=class extends X{constructor(e,t){super(),this._extHostTerminalService=t,this._activeShellIntegrations=new Map,this._onDidChangeTerminalShellIntegration=new P,this.onDidChangeTerminalShellIntegration=this._onDidChangeTerminalShellIntegration.event,this._onDidStartTerminalShellExecution=new P,this.onDidStartTerminalShellExecution=this._onDidStartTerminalShellExecution.event,this._onDidEndTerminalShellExecution=new P,this.onDidEndTerminalShellExecution=this._onDidEndTerminalShellExecution.event,this._proxy=e.getProxy(k.MainThreadTerminalShellIntegration),this._register(B(()=>{for(const[i,s]of this._activeShellIntegrations)s.dispose();this._activeShellIntegrations.clear()}))}$shellIntegrationChange(e){const t=this._extHostTerminalService.getTerminalById(e);if(!t)return;const i=t.value;let s=this._activeShellIntegrations.get(e);s||(s=new nw(t.value,this._onDidStartTerminalShellExecution),this._activeShellIntegrations.set(e,s),s.store.add(t.onWillDispose(()=>this._activeShellIntegrations.get(e)?.dispose())),s.store.add(s.onDidRequestShellExecution(r=>this._proxy.$executeCommand(e,r))),s.store.add(s.onDidRequestEndExecution(r=>this._onDidEndTerminalShellExecution.fire(r))),s.store.add(s.onDidRequestChangeShellIntegration(r=>this._onDidChangeTerminalShellIntegration.fire(r))),t.shellIntegration=s.value),this._onDidChangeTerminalShellIntegration.fire({terminal:i,shellIntegration:s.value})}$shellExecutionStart(e,t,i,s,r){this._activeShellIntegrations.has(e)||this.$shellIntegrationChange(e);const n={value:t,confidence:i,isTrusted:s};this._activeShellIntegrations.get(e)?.startShellExecution(n,v.revive(r))}$shellExecutionEnd(e,t,i,s,r){const n={value:t,confidence:i,isTrusted:s};this._activeShellIntegrations.get(e)?.endShellExecution(n,r)}$shellExecutionData(e,t){this._activeShellIntegrations.get(e)?.emitData(t)}$shellEnvChange(e,t,i,s){this._activeShellIntegrations.get(e)?.setEnv(t,i,s)}$cwdChange(e,t){this._activeShellIntegrations.get(e)?.setCwd(v.revive(t))}$closeTerminal(e){this._activeShellIntegrations.get(e)?.dispose(),this._activeShellIntegrations.delete(e)}};No=L([E(0,j),E(1,mi)],No);class nw extends X{get currentExecution(){return this._currentExecution}constructor(e,t){super(),this._terminal=e,this._onDidStartTerminalShellExecution=t,this._pendingExecutions=[],this.store=this._register(new N),this._onDidRequestChangeShellIntegration=this._register(new P),this.onDidRequestChangeShellIntegration=this._onDidRequestChangeShellIntegration.event,this._onDidRequestShellExecution=this._register(new P),this.onDidRequestShellExecution=this._onDidRequestShellExecution.event,this._onDidRequestEndExecution=this._register(new P),this.onDidRequestEndExecution=this._onDidRequestEndExecution.event,this._onDidRequestNewExecution=this._register(new P),this.onDidRequestNewExecution=this._onDidRequestNewExecution.event;const i=this;this.value={get cwd(){return i._cwd},get env(){if(i._env)return Object.freeze({isTrusted:i._env.isTrusted,value:Object.freeze({...i._env.value})})},executeCommand(s,r){let n=s;if(r)for(const c of r)!c.match(/["'`]/)&&c.match(/\s/)?n+=` "${c}"`:n+=` ${c}`;i._onDidRequestShellExecution.fire(n);const o={value:n,confidence:Pn.High,isTrusted:!0};return i.requestNewShellExecution(o,i._cwd).value}}}requestNewShellExecution(e,t){const i=new Sc(e,t??this._cwd);return Os(e.value).length>1&&(this._currentExecutionProperties={isMultiLine:!0,unresolvedCommandLines:Os(e.value)}),this._pendingExecutions.push(i),this._onDidRequestNewExecution.fire(e.value),i}startShellExecution(e,t){if(this._pendingEndingExecution&&(this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._pendingEndingExecution.value,exitCode:void 0}),this._pendingEndingExecution=void 0),this._currentExecution){if(this._currentExecutionProperties?.isMultiLine&&this._currentExecutionProperties.unresolvedCommandLines){const s=Cc(this._currentExecutionProperties.unresolvedCommandLines,e);if(s){this._currentExecutionProperties.unresolvedCommandLines=s.unresolvedCommandLines;return}}this._currentExecution.endExecution(void 0),this._currentExecution.flush(),this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._currentExecution.value,exitCode:void 0})}let i;if(e.confidence===Pn.High)for(const[s,r]of this._pendingExecutions.entries())if(r.value.commandLine.value===e.value){i=r,this._currentExecutionProperties={isMultiLine:!1,unresolvedCommandLines:void 0},i=r,this._pendingExecutions.splice(s,1);break}else{const n=Cc(Os(r.value.commandLine.value),e);if(n){this._currentExecutionProperties={isMultiLine:!0,unresolvedCommandLines:n.unresolvedCommandLines},i=r,this._pendingExecutions.splice(s,1);break}}else i=this._pendingExecutions.shift();i||(i=new Sc(e,t??this._cwd)),this._currentExecution=i,this._onDidStartTerminalShellExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._currentExecution.value})}emitData(e){this.currentExecution?.emitData(e)}endShellExecution(e,t){if(!(this._currentExecutionProperties?.isMultiLine&&this._currentExecutionProperties.unresolvedCommandLines&&this._currentExecutionProperties.unresolvedCommandLines.length>0)&&this._currentExecution){const i=this._currentExecutionProperties?.isMultiLine?this._currentExecution.value.commandLine:e;this._currentExecution.endExecution(i);const s=this._currentExecution;this._pendingEndingExecution=s,this._currentExecution=void 0,s.flush().then(()=>{this._pendingEndingExecution===s&&(this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:s.value,exitCode:t}),this._pendingEndingExecution=void 0)})}}setEnv(e,t,i){const s={};for(let r=0;r<e.length;r++)s[e[r]]=t[r];this._env={value:s,isTrusted:i},this._fireChangeEvent()}setCwd(e){let t=!1;v.isUri(this._cwd)?t=!v.isUri(e)||this._cwd.toString()!==e.toString():this._cwd!==e&&(t=!0),t&&(this._cwd=e,this._fireChangeEvent())}_fireChangeEvent(){this._onDidRequestChangeShellIntegration.fire({terminal:this._terminal,shellIntegration:this.value})}}class Sc{constructor(e,t){this._commandLine=e,this.cwd=t,this._isEnded=!1;const i=this;this.value={get commandLine(){return i._commandLine},get cwd(){return i.cwd},read(){return i._createDataStream()}}}_createDataStream(){if(!this._dataStream){if(this._isEnded)return _r.EMPTY;this._dataStream=new ow}return this._dataStream.createIterable()}emitData(e){this._isEnded||this._dataStream?.emitData(e)}endExecution(e){e&&(this._commandLine=e),this._dataStream?.endExecution(),this._isEnded=!0}async flush(){this._dataStream&&(await this._dataStream.flush(),this._dataStream.dispose(),this._dataStream=void 0)}}class ow extends X{constructor(){super(...arguments),this._iterables=[],this._emitters=[]}createIterable(){this._barrier||(this._barrier=new mt);const e=this._barrier,t=new _r(async i=>{this._emitters.push(i),await e.wait()});return this._iterables.push(t),t}emitData(e){for(const t of this._emitters)t.emitOne(e)}endExecution(){this._barrier?.open()}async flush(){await Promise.all(this._iterables.map(e=>e.toPromise()))}}function Os(a){return a.split(`
`).map(e=>e.trim()).filter(e=>e.length>0)}function Cc(a,e){if(a.length===0)return!1;const t=[...a],i=Os(e.value);if(t&&t.length>0){for(;t.length>0&&t[0]===i[0];)t.shift(),i.shift();if(i.length===0)return{unresolvedCommandLines:t}}return!1}var pt;(function(a){a[a.CR=13]="CR",a[a.LF=10]="LF",a[a.COLON=58]="COLON",a[a.SPACE=32]="SPACE"})(pt||(pt={}));class Qr{constructor(e){this.dataBuffer="",this.eventTypeBuffer="",this.buffer=[],this.endedOnCR=!1,this.onEventHandler=e,this.decoder=new TextDecoder("utf-8")}getLastEventId(){return this.lastEventIdBuffer}getReconnectionTime(){return this.reconnectionTime}feed(e){if(e.length===0)return;let t=0;for(this.endedOnCR&&e[0]===pt.LF&&t++,this.endedOnCR=!1;t<e.length;){const i=e.indexOf(pt.CR,t),s=e.indexOf(pt.LF,t),r=i===-1?s:s===-1?i:Math.min(i,s);if(r===-1)break;let n="";for(const o of this.buffer)n+=this.decoder.decode(o,{stream:!0});n+=this.decoder.decode(e.subarray(t,r)),this.processLine(n),this.buffer.length=0,t=r+(e[r]===pt.CR&&e[r+1]===pt.LF?2:1)}t<e.length?this.buffer.push(e.subarray(t)):this.endedOnCR=e[e.length-1]===pt.CR}processLine(e){if(!e.length){this.dispatchEvent();return}if(e.startsWith(":"))return;let t,i;const s=e.indexOf(":");s===-1?(t=e,i=""):(t=e.substring(0,s),i=e.substring(s+1),i.startsWith(" ")&&(i=i.substring(1))),this.processField(t,i)}processField(e,t){switch(e){case"event":this.eventTypeBuffer=t;break;case"data":this.dataBuffer+=t,this.dataBuffer+=`
`;break;case"id":t.includes("\0")?this.currentEventId=void 0:this.currentEventId=this.lastEventIdBuffer=t;break;case"retry":/^\d+$/.test(t)&&(this.reconnectionTime=parseInt(t,10));break}}dispatchEvent(){if(this.dataBuffer===""){this.dataBuffer="",this.eventTypeBuffer="";return}this.dataBuffer.endsWith(`
`)&&(this.dataBuffer=this.dataBuffer.substring(0,this.dataBuffer.length-1));const e={type:this.eventTypeBuffer||"message",data:this.dataBuffer};this.currentEventId!==void 0&&(e.id=this.currentEventId),this.reconnectionTime!==void 0&&(e.retry=this.reconnectionTime),this.onEventHandler(e),this.reset()}reset(){this.dataBuffer="",this.eventTypeBuffer="",this.currentEventId=void 0}}const Oo=ee("IExtHostMpcService");let Uo=class extends X{constructor(e){super(),this._initialProviderPromises=new Set,this._sseEventSources=this._register(new gn),this._unresolvedMcpServers=new Map,this._proxy=e.getProxy(k.MainThreadMcp)}$startMcp(e,t){this._startMcp(e,ig.fromSerialized(t))}_startMcp(e,t){if(t.type===sg.HTTP){this._sseEventSources.set(e,new aw(e,t,this._proxy));return}throw new Error("not implemented")}$stopMcp(e){this._sseEventSources.has(e)&&(this._sseEventSources.deleteAndDispose(e),this._proxy.$onDidChangeState(e,{state:Tt.Kind.Stopped}))}$sendMessage(e,t){this._sseEventSources.get(e)?.send(t)}async $waitForInitialCollectionProviders(){await Promise.all(this._initialProviderPromises)}async $resolveMcpLaunch(e,t){const i=this._unresolvedMcpServers.get(e);if(!i)return;const s=i.servers.find(n=>n.label===t);if(!s)return;if(!i.provider.resolveMcpServerDefinition)return Wr.from(s);const r=await i.provider.resolveMcpServerDefinition(s,ue.None);return r?Wr.from(r):void 0}registerMcpConfigurationProvider(e,t,i){const s=new N,r=e.contributes?.modelContextServerCollections?.find(c=>c.id===t);if(!r)throw new Error(`MCP configuration providers must be registered in the contributes.modelContextServerCollections array within your package.json, but "${t}" was not`);const n={id:rg(e.identifier,t),isTrustedByDefault:!0,label:r?.label??e.displayName??e.name,scope:Of.WORKSPACE,canResolveLaunch:typeof i.resolveMcpServerDefinition=="function",extensionId:e.identifier.value},o=async()=>{const c=await i.provideMcpServerDefinitions(ue.None);this._unresolvedMcpServers.set(n.id,{servers:c??[],provider:i});const h=[];for(const g of c??[]){let m=ge.toKey(e.identifier)+"/"+g.label;if(h.some(l=>l.id===m)){let l=2;for(;h.some(f=>f.id===m+l);)l++;m=m+l}h.push({id:m,label:g.label,cacheNonce:g.version,launch:Wr.from(g)})}this._proxy.$upsertMcpCollection(n,h)};s.add(B(()=>{this._unresolvedMcpServers.delete(n.id),this._proxy.$deleteMcpCollection(n.id)})),i.onDidChangeServerDefinitions&&s.add(i.onDidChangeServerDefinitions(o)),i.onDidChange&&s.add(i.onDidChange(o));const d=new Promise(c=>{setTimeout(()=>o().finally(()=>{this._initialProviderPromises.delete(d),c()}),0)});return this._initialProviderPromises.add(d),s}};Uo=L([E(0,j)],Uo);var Ae;(function(a){a[a.Unknown=0]="Unknown",a[a.Http=1]="Http",a[a.SSE=2]="SSE"})(Ae||(Ae={}));class aw extends X{constructor(e,t,i){super(),this._id=e,this._launch=t,this._proxy=i,this._requestSequencer=new Uf,this._postEndpoint=new Ks,this._mode={value:Ae.Unknown},this._cts=new he,this._abortCtrl=new AbortController,this._register(B(()=>{this._abortCtrl.abort(),this._cts.dispose(!0)})),this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Running})}async send(e){try{await this._requestSequencer.queue(()=>this._mode.value===Ae.SSE?this._sendLegacySSE(this._mode.endpoint,e):this._sendStreamableHttp(e,this._mode.value===Ae.Http?this._mode.sessionId:void 0))}catch(t){const i=`Error sending message to ${this._launch.uri}: ${String(t)}`;this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Error,message:i})}}async _sendStreamableHttp(e,t){const i=new TextEncoder().encode(e),s={...Object.fromEntries(this._launch.headers),"Content-Type":"application/json","Content-Length":String(i.length),Accept:"text/event-stream, application/json"};t&&(s["Mcp-Session-Id"]=t);const r=await fetch(this._launch.uri.toString(!0),{method:"POST",signal:this._abortCtrl.signal,headers:s,body:i}),n=this._mode.value===Ae.Unknown,o=r.headers.get("Mcp-Session-Id");if(o&&(this._mode={value:Ae.Http,sessionId:o}),this._mode.value===Ae.Unknown&&r.status>=400&&r.status<500){this._log(ut.Info,`${r.status} status sending message to ${this._launch.uri}, will attempt to fall back to legacy SSE`);const d=await this._attachSSE();d&&(this._mode={value:Ae.SSE,endpoint:d},await this._sendLegacySSE(d,e));return}if(r.status>=300){const d=this._mode.value===Ae.Http&&!!this._mode.sessionId;this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Error,message:`${r.status} status sending message to ${this._launch.uri}: ${await this._getErrText(r)}`+d?"; will retry with new session ID":"",shouldRetry:d});return}this._mode.value===Ae.Unknown&&(this._mode={value:Ae.Http,sessionId:void 0}),n&&this._attachStreamableBackchannel(),this._handleSuccessfulStreamableHttp(r)}async _handleSuccessfulStreamableHttp(e){if(e.status!==202)switch(e.headers.get("Content-Type")?.toLowerCase()){case"text/event-stream":{const t=new Qr(i=>{i.type==="message"&&this._proxy.$onDidReceiveMessage(this._id,i.data)});try{await this._doSSE(t,e)}catch(i){this._log(ut.Warning,`Error reading SSE stream: ${String(i)}`)}break}case"application/json":this._proxy.$onDidReceiveMessage(this._id,await e.text());break;default:{const t=await e.text();dw(t)?this._proxy.$onDidReceiveMessage(this._id,t):this._log(ut.Warning,`Unexpected ${e.status} response for request: ${t}`)}}}async _attachStreamableBackchannel(){let e;for(let t=0;!this._store.isDisposed;t++){await si(Math.min(t*1e3,3e4),this._cts.token);let i;try{const r={...Object.fromEntries(this._launch.headers),Accept:"text/event-stream"};this._mode.value===Ae.Http&&this._mode.sessionId!==void 0&&(r["Mcp-Session-Id"]=this._mode.sessionId),e&&(r["Last-Event-ID"]=e),i=await fetch(this._launch.uri.toString(!0),{method:"GET",signal:this._abortCtrl.signal,headers:r})}catch{this._log(ut.Info,`Error connecting to ${this._launch.uri} for async notifications, will retry`);continue}if(i.status>=400){this._log(ut.Debug,`${i.status} status connecting to ${this._launch.uri} for async notifications; they will be disabled: ${await this._getErrText(i)}`);return}t=0;const s=new Qr(r=>{r.type==="message"&&this._proxy.$onDidReceiveMessage(this._id,r.data),r.id&&(e=r.id)});try{await this._doSSE(s,i)}catch(r){this._log(ut.Info,`Error reading from async stream, we will reconnect: ${r}`)}}}async _attachSSE(){const e=new Ks;let t;try{if(t=await fetch(this._launch.uri.toString(!0),{method:"GET",signal:this._abortCtrl.signal,headers:{...Object.fromEntries(this._launch.headers),Accept:"text/event-stream"}}),t.status>=300){this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Error,message:`${t.status} status connecting to ${this._launch.uri} as SSE: ${await this._getErrText(t)}`});return}}catch(s){this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Error,message:`Error connecting to ${this._launch.uri} as SSE: ${s}`});return}const i=new Qr(s=>{s.type==="message"?this._proxy.$onDidReceiveMessage(this._id,s.data):s.type==="endpoint"&&e.complete(new URL(s.data,this._launch.uri.toString(!0)).toString())});return this._register(B(()=>e.cancel())),this._doSSE(i,t).catch(s=>{this._proxy.$onDidChangeState(this._id,{state:Tt.Kind.Error,message:`Error reading SSE stream: ${String(s)}`})}),e.p}async _sendLegacySSE(e,t){const i=new TextEncoder().encode(t),s=await fetch(e,{method:"POST",signal:this._abortCtrl.signal,headers:{...Object.fromEntries(this._launch.headers),"Content-Type":"application/json","Content-Length":String(i.length)},body:i});s.status>=300&&this._log(ut.Warning,`${s.status} status sending message to ${this._postEndpoint}: ${await this._getErrText(s)}`)}async _doSSE(e,t){if(!t.body)return;const i=t.body.getReader();let s;do{try{s=await hl(i.read(),this._cts.token)}catch(r){if(i.cancel(),this._store.isDisposed)return;throw r}s.value&&e.feed(s.value)}while(!s.done)}_log(e,t){this._store.isDisposed||this._proxy.$onDidPublishLog(this._id,e,t)}async _getErrText(e){try{return await e.text()}catch{return e.statusText}}}function dw(a){try{return JSON.parse(a),!0}catch{return!1}}oe(Na,Do,ae.Delayed);oe(fi,ur,ae.Delayed);oe(Er,po,ae.Delayed);oe(Ut,co,ae.Eager);oe(Ha,So,ae.Eager);oe(Fa,Co,ae.Eager);oe(rt,ao,ae.Eager);oe(xr,so,ae.Eager);oe(Cr,Ro,ae.Eager);oe(Ju,Mo,ae.Eager);oe(Lu,oo,ae.Eager);oe(gi,uo,ae.Eager);oe(Oa,Po,ae.Eager);oe(pi,Kv,ae.Eager);oe(Hu,ro,ae.Delayed);oe(Zu,Ho,ae.Eager);oe(Ma,Bu,ae.Eager);oe(Wu,wo,ae.Eager);oe(mi,fo,ae.Eager);oe(th,No,ae.Eager);oe(Sa,ng,ae.Eager);oe(eh,Lo,ae.Eager);oe(st,no,ae.Eager);oe(La,qu,ae.Eager);oe(os,xo,ae.Eager);oe(Ua,Ao,ae.Eager);oe(Oo,Uo,ae.Eager);let Wo=class extends Wf{constructor(e,t,i){const s=i.remote.isRemote?"remoteexthost":e?"workerexthost":"exthost",r=i.remote.isRemote?J(2561,"Extension Host (Remote)"):e?J(2562,"Extension Host (Worker)"):J(2563,"Extension Host");super(t.createLogger(s,{name:r}))}};Wo=L([E(1,fi),E(2,Se)],Wo);class Dc{static async installEarlyHandler(e){Error.stackTraceLimit=100;const t=e.get(re),s=e.get(j).getProxy(k.MainThreadErrors);un(r=>{t.error(r);const n=Gs(r);s.$onUnexpectedError(n)})}static async installFullHandler(e){const t=e.get(re),i=e.get(j),s=e.get(Wt),r=e.get(Aa),n=i.getProxy(k.MainThreadExtensionService),o=i.getProxy(k.MainThreadErrors),d=await s.getExtensionPathIndex(),c=new WeakMap;function h(l,f){if(c.has(l))return c.get(l).stack;let _="",x,C;for(const T of f)_+=`
	at ${T.toString()}`,C=T.getFileName(),!x&&C&&(x=d.findSubstr(v.file(C)));const S=`${l.name||"Error"}: ${l.message||""}${_}`;return c.set(l,{extensionIdentifier:x?.identifier,stack:S}),S}const g=Symbol("prepareStackTrace wrapped");let m=h;Object.defineProperty(Error,"prepareStackTrace",{configurable:!1,get(){return m},set(l){if(l===h||!l||l[g]){m=l||h;return}m=function(f,_){return h(f,_),l.call(Error,f,_)},Object.assign(m,{[g]:!0})}}),un(l=>{t.error(l);const f=Gs(l);let _;if(l instanceof fl?_=l.extension:_=c.get(l)?.extensionIdentifier,_){n.$onExtensionRuntimeError(_,f);const x=r.onExtensionError(_,l);t.trace("forwarded error to extension?",x,_)}}),zf.addListener(l=>{o.$onUnexpectedError(l)})}}class ih{constructor(e,t,i,s,r){this._hostUtils=i,this._rpcProtocol=new og(e,null,s),t=ih._transform(t,this._rpcProtocol);const n=new cl(...Bf());n.set(Se,{_serviceBrand:void 0,...t,messagePorts:r}),n.set(j,new ag(this._rpcProtocol)),n.set(br,new Qv(s)),n.set(ju,i),n.set(re,new Ed(Wo,[!0],!0)),n.set(fi,new Ed(ur,[],!0));const o=new Vf(n,!0);Qs&&o.invokeFunction(Dc.installEarlyHandler),this._logService=o.invokeFunction(d=>d.get(re)),We("code/extHost/didCreateServices"),this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} started`):this._logService.info("Extension host started"),this._logService.trace("initData",t),this._extensionService=o.invokeFunction(d=>d.get(Wt)),this._extensionService.initialize(),Qs&&o.invokeFunction(Dc.installFullHandler)}async asBrowserUri(e){const t=this._rpcProtocol.getProxy(k.MainThreadExtensionService);return v.revive(await t.$asBrowserUri(e))}async getAllStaticBrowserUris(){return(await this._rpcProtocol.getProxy(k.MainThreadExtensionService).$getAllStaticBrowserUris()).map(([t,i])=>[v.revive(t),v.revive(i)])}terminate(e){this._extensionService.terminate(e)}getExtHostExtensionService(){return this._extensionService}static _transform(e,t){e.extensions.allExtensions.forEach(s=>{s.extensionLocation=v.revive(t.transformIncomingURIs(s.extensionLocation))}),e.environment.appRoot=v.revive(t.transformIncomingURIs(e.environment.appRoot));const i=e.environment.extensionDevelopmentLocationURI;return i&&(e.environment.extensionDevelopmentLocationURI=i.map(s=>v.revive(t.transformIncomingURIs(s)))),e.environment.extensionTestsLocationURI=v.revive(t.transformIncomingURIs(e.environment.extensionTestsLocationURI)),e.environment.globalStorageHome=v.revive(t.transformIncomingURIs(e.environment.globalStorageHome)),e.environment.workspaceStorageHome=v.revive(t.transformIncomingURIs(e.environment.workspaceStorageHome)),e.nlsBaseUrl=v.revive(t.transformIncomingURIs(e.nlsBaseUrl)),e.logsLocation=v.revive(t.transformIncomingURIs(e.logsLocation)),e.workspace=t.transformIncomingURIs(e.workspace),e}}class cw{constructor(e){this._relatedInformationProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiRelatedInformation)}async $provideAiRelatedInformation(e,t,i){if(this._relatedInformationProviders.size===0)throw new Error("No related information providers registered");const s=this._relatedInformationProviders.get(e);if(!s)throw new Error("related information provider not found");return await s.provideRelatedInformation(t,i)??[]}getRelatedInformation(e,t,i){return this._proxy.$getAiRelatedInformation(t,i)}registerRelatedInformationProvider(e,t,i){const s=this._nextHandle;return this._nextHandle++,this._relatedInformationProviders.set(s,i),this._proxy.$registerAiRelatedInformationProvider(s,t),new V(()=>{this._proxy.$unregisterAiRelatedInformationProvider(s),this._relatedInformationProviders.delete(s)})}}const lw=[new H("vscode.executeDocumentHighlights","_executeDocumentHighlights","Execute document highlight provider.",[D.Uri,D.Position],new M("A promise that resolves to an array of DocumentHighlight-instances.",Ue(jl.to))),new H("vscode.executeDocumentSymbolProvider","_executeDocumentSymbolProvider","Execute document symbol provider.",[D.Uri],new M("A promise that resolves to an array of SymbolInformation and DocumentSymbol instances.",(a,e)=>{if(pa(a))return;class t extends eu{static to(s){const r=new t(s.name,tu.to(s.kind),s.containerName||"",new li(e[0],$.to(s.range)));return r.detail=s.detail,r.range=r.location.range,r.selectionRange=$.to(s.selectionRange),r.children=s.children?s.children.map(t.to):[],r}}return a.map(t.to)})),new H("vscode.executeFormatDocumentProvider","_executeFormatDocumentProvider","Execute document format provider.",[D.Uri,new D("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(qe.to))),new H("vscode.executeFormatRangeProvider","_executeFormatRangeProvider","Execute range format provider.",[D.Uri,D.Range,new D("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(qe.to))),new H("vscode.executeFormatOnTypeProvider","_executeFormatOnTypeProvider","Execute format on type provider.",[D.Uri,D.Position,new D("ch","Trigger character",a=>typeof a=="string",a=>a),new D("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(qe.to))),new H("vscode.executeDefinitionProvider","_executeDefinitionProvider","Execute all definition providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.experimental.executeDefinitionProvider_recursive","_executeDefinitionProvider_recursive","Execute all definition providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.executeTypeDefinitionProvider","_executeTypeDefinitionProvider","Execute all type definition providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.experimental.executeTypeDefinitionProvider_recursive","_executeTypeDefinitionProvider_recursive","Execute all type definition providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.executeDeclarationProvider","_executeDeclarationProvider","Execute all declaration providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.experimental.executeDeclarationProvider_recursive","_executeDeclarationProvider_recursive","Execute all declaration providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.executeImplementationProvider","_executeImplementationProvider","Execute all implementation providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.experimental.executeImplementationProvider_recursive","_executeImplementationProvider_recursive","Execute all implementation providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",ct)),new H("vscode.executeReferenceProvider","_executeReferenceProvider","Execute all reference providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location-instances.",Ue(tt.to))),new H("vscode.experimental.executeReferenceProvider","_executeReferenceProvider_recursive","Execute all reference providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Location-instances.",Ue(tt.to))),new H("vscode.executeHoverProvider","_executeHoverProvider","Execute all hover providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Hover-instances.",Ue(Tn.to))),new H("vscode.experimental.executeHoverProvider_recursive","_executeHoverProvider_recursive","Execute all hover providers.",[D.Uri,D.Position],new M("A promise that resolves to an array of Hover-instances.",Ue(Tn.to))),new H("vscode.executeSelectionRangeProvider","_executeSelectionRangeProvider","Execute selection range provider.",[D.Uri,new D("position","A position in a text document",a=>Array.isArray(a)&&a.every(e=>Fe.isPosition(e)),a=>a.map(Z.from))],new M("A promise that resolves to an array of ranges.",a=>a.map(e=>{let t;for(const i of e.reverse())t=new Kl($.to(i),t);return t}))),new H("vscode.executeWorkspaceSymbolProvider","_executeWorkspaceSymbolProvider","Execute all workspace symbol providers.",[D.String.with("query","Search string")],new M("A promise that resolves to an array of SymbolInformation-instances.",a=>a.map(kn.to))),new H("vscode.prepareCallHierarchy","_executePrepareCallHierarchy","Prepare call hierarchy at a position inside a document",[D.Uri,D.Position],new M("A promise that resolves to an array of CallHierarchyItem-instances",a=>a.map(_a.to))),new H("vscode.provideIncomingCalls","_executeProvideIncomingCalls","Compute incoming calls for an item",[D.CallHierarchyItem],new M("A promise that resolves to an array of CallHierarchyIncomingCall-instances",a=>a.map(dg.to))),new H("vscode.provideOutgoingCalls","_executeProvideOutgoingCalls","Compute outgoing calls for an item",[D.CallHierarchyItem],new M("A promise that resolves to an array of CallHierarchyOutgoingCall-instances",a=>a.map(cg.to))),new H("vscode.prepareRename","_executePrepareRename","Execute the prepareRename of rename provider.",[D.Uri,D.Position],new M("A promise that resolves to a range and placeholder text.",a=>{if(a)return{range:$.to(a.range),placeholder:a.text}})),new H("vscode.executeDocumentRenameProvider","_executeDocumentRenameProvider","Execute rename provider.",[D.Uri,D.Position,D.String.with("newName","The new symbol name")],new M("A promise that resolves to a WorkspaceEdit.",a=>{if(a){if(a.rejectReason)throw new Error(a.rejectReason);return Le.to(a)}})),new H("vscode.executeLinkProvider","_executeLinkProvider","Execute document link provider.",[D.Uri,D.Number.with("linkResolveCount","Number of links that should be resolved, only when links are unresolved.").optional()],new M("A promise that resolves to an array of DocumentLink-instances.",a=>a.map(Bi.to))),new H("vscode.provideDocumentSemanticTokensLegend","_provideDocumentSemanticTokensLegend","Provide semantic tokens legend for a document",[D.Uri],new M("A promise that resolves to SemanticTokensLegend.",a=>{if(a)return new In(a.tokenTypes,a.tokenModifiers)})),new H("vscode.provideDocumentSemanticTokens","_provideDocumentSemanticTokens","Provide semantic tokens for a document",[D.Uri],new M("A promise that resolves to SemanticTokens.",a=>{if(!a)return;const e=Bd(a);if(e.type==="full")return new tr(e.data,void 0)})),new H("vscode.provideDocumentRangeSemanticTokensLegend","_provideDocumentRangeSemanticTokensLegend","Provide semantic tokens legend for a document range",[D.Uri,D.Range.optional()],new M("A promise that resolves to SemanticTokensLegend.",a=>{if(a)return new In(a.tokenTypes,a.tokenModifiers)})),new H("vscode.provideDocumentRangeSemanticTokens","_provideDocumentRangeSemanticTokens","Provide semantic tokens for a document range",[D.Uri,D.Range],new M("A promise that resolves to SemanticTokens.",a=>{if(!a)return;const e=Bd(a);if(e.type==="full")return new tr(e.data,void 0)})),new H("vscode.executeCompletionItemProvider","_executeCompletionItemProvider","Execute completion item provider.",[D.Uri,D.Position,D.String.with("triggerCharacter","Trigger completion when the user types the character, like `,` or `(`").optional(),D.Number.with("itemResolveCount","Number of completions to resolve (too large numbers slow down completions)").optional()],new M("A promise that resolves to a CompletionList-instance.",(a,e,t)=>{if(!a)return new ir([]);const i=a.suggestions.map(s=>lg.to(s,t));return new ir(i,a.incomplete)})),new H("vscode.executeSignatureHelpProvider","_executeSignatureHelpProvider","Execute signature help provider.",[D.Uri,D.Position,D.String.with("triggerCharacter","Trigger signature help when the user types the character, like `,` or `(`").optional()],new M("A promise that resolves to SignatureHelp.",a=>{if(a)return Rn.to(a)})),new H("vscode.executeCodeLensProvider","_executeCodeLensProvider","Execute code lens provider.",[D.Uri,D.Number.with("itemResolveCount","Number of lenses that should be resolved and returned. Will only return resolved lenses, will impact performance)").optional()],new M("A promise that resolves to an array of CodeLens-instances.",(a,e,t)=>Ue(i=>new iu($.to(i.range),i.command&&t.fromInternal(i.command)))(a))),new H("vscode.executeCodeActionProvider","_executeCodeActionProvider","Execute code action provider.",[D.Uri,new D("rangeOrSelection","Range in a text document. Some refactoring provider requires Selection object.",a=>de.isRange(a),a=>ci.isSelection(a)?et.from(a):$.from(a)),D.String.with("kind","Code action kind to return code actions for").optional(),D.Number.with("itemResolveCount","Number of code actions to resolve (too large numbers slow down code actions)").optional()],new M("A promise that resolves to an array of Command-instances.",(a,e,t)=>Ue(i=>{if(i._isSynthetic){if(!i.command)throw new Error("Synthetic code actions must have a command");return t.fromInternal(i.command)}else{const s=new Da(i.title,i.kind?new Pa(i.kind):void 0);return i.edit&&(s.edit=Le.to(i.edit)),i.command&&(s.command=t.fromInternal(i.command)),s.isPreferred=i.isPreferred,s}})(a))),new H("vscode.executeDocumentColorProvider","_executeDocumentColorProvider","Execute document color provider.",[D.Uri],new M("A promise that resolves to an array of ColorInformation objects.",a=>a?a.map(e=>new Gl($.to(e.range),sr.to(e.color))):[])),new H("vscode.executeColorPresentationProvider","_executeColorPresentationProvider","Execute color presentation provider.",[new D("color","The color to show and insert",a=>a instanceof Ql,sr.from),new D("context","Context object with uri and range",a=>!0,a=>({uri:a.uri,range:$.from(a.range)}))],new M("A promise that resolves to an array of ColorPresentation objects.",a=>a?a.map(Jl.to):[])),new H("vscode.executeInlayHintProvider","_executeInlayHintProvider","Execute inlay hints provider",[D.Uri,D.Range],new M("A promise that resolves to an array of Inlay objects",(a,e,t)=>a.map(ug.to.bind(void 0,t)))),new H("vscode.executeFoldingRangeProvider","_executeFoldingRangeProvider","Execute folding range provider",[D.Uri],new M("A promise that resolves to an array of FoldingRange objects",(a,e)=>{if(a)return a.map(Xl.to)})),new H("vscode.resolveNotebookContentProviders","_resolveNotebookContentProvider","Resolve Notebook Content Providers",[],new M("A promise that resolves to an array of NotebookContentProvider static info objects.",Ue(a=>({viewType:a.viewType,displayName:a.displayName,options:{transientOutputs:a.options.transientOutputs,transientCellMetadata:a.options.transientCellMetadata,transientDocumentMetadata:a.options.transientDocumentMetadata},filenamePattern:a.filenamePattern.map(e=>su.to(e))})))),new H("vscode.executeInlineValueProvider","_executeInlineValueProvider","Execute inline value provider",[D.Uri,D.Range,new D("context","An InlineValueContext",a=>a&&typeof a.frameId=="number"&&a.stoppedLocation instanceof de,a=>Yl.from(a))],new M("A promise that resolves to an array of InlineValue objects",a=>a.map(Zl.to))),new H("vscode.open","_workbench.open","Opens the provided resource in the editor. Can be a text or binary file, or an http(s) URL. If you need more control over the options for opening a text file, use vscode.window.showTextDocument instead.",[new D("uriOrString","Uri-instance or string (only http/https)",a=>v.isUri(a)||typeof a=="string"&&qf(a,q.http,q.https),a=>a),new D("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="number"||typeof a=="object",a=>a&&(typeof a=="number"?[ye.from(a),void 0]:[ye.from(a.viewColumn),Br.from(a)])).optional(),D.String.with("label","").optional()],M.Void),new H("vscode.openWith","_workbench.openWith","Opens the provided resource with a specific editor.",[D.Uri.with("resource","Resource to open"),D.String.with("viewId","Custom editor view id. This should be the viewType string for custom editors or the notebookType string for notebooks. Use 'default' to use VS Code's default text editor"),new D("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="number"||typeof a=="object",a=>a&&(typeof a=="number"?[ye.from(a),void 0]:[ye.from(a.viewColumn),Br.from(a)])).optional()],M.Void),new H("vscode.diff","_workbench.diff","Opens the provided resources in the diff editor to compare their contents.",[D.Uri.with("left","Left-hand side resource of the diff editor"),D.Uri.with("right","Right-hand side resource of the diff editor"),D.String.with("title","Human readable title for the diff editor").optional(),new D("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="object",a=>a&&[ye.from(a.viewColumn),Br.from(a)]).optional()],M.Void),new H("vscode.changes","_workbench.changes","Opens a list of resources in the changes editor to compare their contents.",[D.String.with("title","Human readable title for the changes editor"),new D("resourceList","List of resources to compare",a=>{for(const e of a){if(e.length!==3)return!1;const[t,i,s]=e;if(!v.isUri(t)||!v.isUri(i)&&i!==void 0&&i!==null||!v.isUri(s)&&s!==void 0&&s!==null)return!1}return!0},a=>a)],M.Void),new H("vscode.prepareTypeHierarchy","_executePrepareTypeHierarchy","Prepare type hierarchy at a position inside a document",[D.Uri,D.Position],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(Ni.to))),new H("vscode.provideSupertypes","_executeProvideSupertypes","Compute supertypes for an item",[D.TypeHierarchyItem],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(Ni.to))),new H("vscode.provideSubtypes","_executeProvideSubtypes","Compute subtypes for an item",[D.TypeHierarchyItem],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(Ni.to))),new H("vscode.revealTestInExplorer","_revealTestInExplorer","Reveals a test instance in the explorer",[D.TestItem],M.Void),new H("vscode.startContinuousTestRun","testing.startContinuousRunFromExtension","Starts running the given tests with continuous run mode.",[D.TestProfile,D.Arr(D.TestItem)],M.Void),new H("vscode.stopContinuousTestRun","testing.stopContinuousRunFromExtension","Stops running the given tests with continuous run mode.",[D.Arr(D.TestItem)],M.Void),new H("vscode.experimental.editSession.continue","_workbench.editSessions.actions.continueEditSession","Continue the current edit session in a different workspace",[D.Uri.with("workspaceUri","The target workspace to continue the current edit session in")],M.Void),new H("setContext","_setContext","Set a custom context key value that can be used in when clauses.",[D.String.with("name","The context key name"),new D("value","The context key value",()=>!0,a=>a)],M.Void),new H("vscode.editorChat.start","inlineChat.start","Invoke a new editor chat session",[new D("Run arguments","",a=>!0,a=>{if(a)return{initialRange:a.initialRange?$.from(a.initialRange):void 0,initialSelection:ci.isSelection(a.initialSelection)?et.from(a.initialSelection):void 0,message:a.message,attachments:a.attachments,autoSend:a.autoSend,position:a.position?Z.from(a.position):void 0}})],M.Void)];class uw{static register(e){lw.forEach(e.registerApiCommand,e),this._registerValidateWhenClausesCommand(e)}static _registerValidateWhenClausesCommand(e){e.registerCommand(!1,"_validateWhenClauses",Kf)}}function Ue(a){return e=>{if(Array.isArray(e))return e.map(a)}}function ct(a){if(!Array.isArray(a))return;const e=[];for(const t of a)jf(t)?e.push(An.to(t)):e.push(tt.to(t));return e}let Bo=class{constructor(e,t){this._proxy=e.getProxy(k.MainThreadBulkEdits),this._versionInformationProvider={getTextDocumentVersion:i=>t.getDocument(i)?.version,getNotebookDocumentVersion:()=>{}}}applyWorkspaceEdit(e,t,i){const s=new Ke(Le.from(e,this._versionInformationProvider));return this._proxy.$tryApplyWorkspaceEdit(s,void 0,i?.isRefactoring??!1)}};Bo=L([E(0,j)],Bo);class hw{constructor(e,t,i,s,r){this._extension=e,this._request=t,this._proxy=i,this._commandsConverter=s,this._sessionDisposables=r,this._stopWatch=di.create(!1),this._isClosed=!1}close(){this._isClosed=!0}get timings(){return{firstProgress:this._firstProgress,totalElapsed:this._stopWatch.elapsed()}}get apiObject(){if(!this._apiObject){let t=function(s){if(e._isClosed){const r=new Error("Response stream has been closed");throw Error.captureStackTrace(r,s),r}};const e=this;this._stopWatch.reset();const i=(s,r)=>{if(typeof this._firstProgress>"u"&&(s.kind==="markdownContent"||s.kind==="markdownVuln")&&(this._firstProgress=this._stopWatch.elapsed()),r){const n=this._proxy.$handleProgressChunk(this._request.requestId,s),o={report:d=>{n?.then(c=>{c&&(ui.isMarkdownString(d.value)?this._proxy.$handleProgressChunk(this._request.requestId,Xd.from(d),c):this._proxy.$handleProgressChunk(this._request.requestId,zr.from(d),c))})}};Promise.all([n,r?.(o)]).then(([d,c])=>{d!==void 0&&this._proxy.$handleProgressChunk(this._request.requestId,Pg.from(c),d)})}else this._proxy.$handleProgressChunk(this._request.requestId,s)};this._apiObject=Object.freeze({markdown(s){t(this.markdown);const r=new fu(s),n=Dg.from(r);return i(n),this},markdownWithVulnerabilities(s,r){t(this.markdown),r&&b(e._extension,"chatParticipantAdditions");const n=new Ln(s,r),o=Cg.from(n);return i(o),this},codeblockUri(s,r){t(this.codeblockUri),b(e._extension,"chatParticipantAdditions");const n=new hu(s,r),o=Sg.from(n);return i(o),this},filetree(s,r){t(this.filetree);const n=new uu(s,r),o=Eg.from(n);return i(o),this},anchor(s,r){const n=new Wn(s,r);return this.push(n)},button(s){t(this.anchor);const r=new lu(s),n=bg.from(r,e._commandsConverter,e._sessionDisposables);return i(n),this},progress(s,r){t(this.progress);const n=new Rs(s,r),o=r?Gd.from(n):Qd.from(n);return i(o,r),this},warning(s){t(this.progress),b(e._extension,"chatParticipantAdditions");const r=new Nn(s),n=Xd.from(r);return i(n),this},reference(s,r){return this.reference2(s,r)},reference2(s,r,n){if(t(this.reference),typeof s=="object"&&"variableName"in s&&b(e._extension,"chatParticipantAdditions"),typeof s=="object"&&"variableName"in s&&!s.value){const o=e._request.variables.variables.find(d=>d.name===s.variableName);if(o){let d;if(o.references?.length)d=o.references.map(c=>({kind:"reference",reference:{variableName:s.variableName,value:c.reference}}));else{const c=new Vi(s,r,n);d=[zr.from(c)]}return d.forEach(c=>i(c)),this}}else{const o=new Vi(s,r,n),d=zr.from(o);i(d)}return this},codeCitation(s,r,n){t(this.codeCitation),b(e._extension,"chatParticipantAdditions");const o=new Un(s,r,n),d=xg.from(o);i(d)},textEdit(s,r){t(this.textEdit),b(e._extension,"chatParticipantAdditions");const n=new Hn(s,r);n.isDone=r===!0?!0:void 0;const o=wg.from(n);return i(o),this},notebookEdit(s,r){t(this.notebookEdit),b(e._extension,"chatParticipantAdditions");const n=new Fn(s,r),o=yg.from(n);return i(o),this},confirmation(s,r,n,o){t(this.confirmation),b(e._extension,"chatParticipantAdditions");const d=new On(s,r,n,o),c=vg.from(d);return i(c),this},push(s){if(t(this.push),(s instanceof Hn||s instanceof Fn||s instanceof Ln||s instanceof Nn||s instanceof On||s instanceof Un||s instanceof du||s instanceof cu||s instanceof Rs)&&b(e._extension,"chatParticipantAdditions"),s instanceof Vi)this.reference2(s.value,s.iconPath,s.options);else if(s instanceof Rs){const r=s.task?Gd.from(s):Qd.from(s);i(r,s.task)}else if(s instanceof Wn){const r=Jd.from(s);if(s.resolve){b(e._extension,"chatParticipantAdditions"),r.resolveId=it();const n=new he;s.resolve(n.token).then(()=>{const o=Jd.from(s);e._proxy.$handleAnchorResolve(e._request.requestId,r.resolveId,o)}).then(()=>n.dispose(),()=>n.dispose()),e._sessionDisposables.add(B(()=>n.dispose(!0)))}i(r)}else{const r=nu.from(s,e._commandsConverter,e._sessionDisposables);i(r)}return this}})}return this._apiObject}}class ti extends X{static{this._idPool=0}static{this._participantDetectionProviderIdPool=0}static{this._relatedFilesProviderIdPool=0}constructor(e,t,i,s,r,n,o){super(),this._logService=t,this._commands=i,this._documents=s,this._languageModels=r,this._diagnostics=n,this._tools=o,this._agents=new Map,this._participantDetectionProviders=new Map,this._relatedFilesProviders=new Map,this._sessionDisposables=this._register(new gn),this._completionDisposables=this._register(new gn),this._inFlightRequests=new Set,this._onDidDisposeChatSession=this._register(new P),this.onDidDisposeChatSession=this._onDidDisposeChatSession.event,this._proxy=e.getProxy(k.MainThreadChatAgents2),i.registerArgumentProcessor({processArgument:d=>hg(d)?null:d})}transferActiveChat(e){this._proxy.$transferActiveChatSession(e)}createChatAgent(e,t,i){const s=ti._idPool++,r=new Pc(e,t,this._proxy,s,i);return this._agents.set(s,r),this._proxy.$registerAgent(s,e.identifier,t,{},void 0),r.apiAgent}createDynamicChatAgent(e,t,i,s){const r=ti._idPool++,n=new Pc(e,t,this._proxy,r,s);return this._agents.set(r,n),this._proxy.$registerAgent(r,e.identifier,t,{isSticky:!0},i),n.apiAgent}registerChatParticipantDetectionProvider(e,t){const i=ti._participantDetectionProviderIdPool++;return this._participantDetectionProviders.set(i,new fw(e,t)),this._proxy.$registerChatParticipantDetectionProvider(i),B(()=>{this._participantDetectionProviders.delete(i),this._proxy.$unregisterChatParticipantDetectionProvider(i)})}registerRelatedFilesProvider(e,t,i){const s=ti._relatedFilesProviderIdPool++;return this._relatedFilesProviders.set(s,new pw(e,t)),this._proxy.$registerRelatedFilesProvider(s,i),B(()=>{this._relatedFilesProviders.delete(s),this._proxy.$unregisterRelatedFilesProvider(s)})}async $provideRelatedFiles(e,t,i){const s=this._relatedFilesProviders.get(e);if(!s)return Promise.resolve([]);const r=fg.to(t);return await s.provider.provideRelatedFiles(r,i)??void 0}async $detectChatParticipant(e,t,i,s,r){const n=this._participantDetectionProviders.get(e);if(!n)return;const{request:o,location:d,history:c}=await this._createRequest(t,i,n.extension),h=await this.getModelForRequest(o,n.extension),g=Vd.to(o,d,h,this.getDiagnosticsWhenEnabled(n.extension),this.getToolsForRequest(n.extension,o),this.getTools2ForRequest(n.extension,o),n.extension,this._logService);return n.provider.provideParticipantDetection(g,{history:c},{participants:s.participants,location:zd.to(s.location)},r)}async _createRequest(e,t,i){const s=ze(e),r=await this.prepareHistoryTurns(i,s.agentId,t);let n;if(s.locationData?.type===qd.Editor){const o=this._documents.getDocument(s.locationData.document);n=new ru(o,et.to(s.locationData.selection),$.to(s.locationData.wholeRange))}else if(s.locationData?.type===qd.Notebook){const o=this._documents.getDocument(s.locationData.sessionInputUri);n=new au(o)}return{request:s,location:n,history:r}}async getModelForRequest(e,t){let i;if(e.userSelectedModelId&&(i=await this._languageModels.getLanguageModelByIdentifier(t,e.userSelectedModelId)),!i&&(i=await this._languageModels.getDefaultLanguageModel(t),!i))throw new Error("Language model unavailable");return i}async $setRequestPaused(e,t,i){const s=this._agents.get(e);if(!s)return;const r=Ji.find(this._inFlightRequests,n=>n.requestId===t);r&&s.setChatRequestPauseState({request:r.extRequest,isPaused:i})}async $invokeAgent(e,t,i,s){const r=this._agents.get(e);if(!r)throw new Error(`[CHAT](${e}) CANNOT invoke agent because the agent is not registered`);let n,o;try{const{request:d,location:c,history:h}=await this._createRequest(t,i,r.extension);let g=this._sessionDisposables.get(d.sessionId);g||(g=new N,this._sessionDisposables.set(d.sessionId,g)),n=new hw(r.extension,d,this._proxy,this._commands.converter,g);const m=await this.getModelForRequest(d,r.extension),l=Vd.to(d,c,m,this.getDiagnosticsWhenEnabled(r.extension),this.getToolsForRequest(r.extension,d),this.getTools2ForRequest(r.extension,d),r.extension,this._logService);o={requestId:t.requestId,extRequest:l},this._inFlightRequests.add(o);const f=r.invoke(l,{history:h},n.apiObject,s);return await pl(Promise.resolve(f).then(_=>{if(_?.metadata)try{JSON.stringify(_.metadata)}catch(C){const S=`result.metadata MUST be JSON.stringify-able. Got error: ${C.message}`;return this._logService.error(`[${r.extension.identifier.value}] [@${r.id}] ${S}`,r.extension),{errorDetails:{message:S},timings:n?.timings,nextQuestion:_.nextQuestion}}let x;return _?.errorDetails&&(x={..._.errorDetails,responseIsIncomplete:!0}),(x?.responseIsRedacted||x?.isQuotaExceeded)&&b(r.extension,"chatParticipantPrivate"),{errorDetails:x,timings:n?.timings,metadata:_?.metadata,nextQuestion:_?.nextQuestion}}),s)}catch(d){this._logService.error(d,r.extension),d instanceof Je&&d.cause&&(d=d.cause);const c=d instanceof Error&&d.name==="ChatQuotaExceeded";return{errorDetails:{message:vr(d),responseIsIncomplete:!0,isQuotaExceeded:c}}}finally{o&&this._inFlightRequests.delete(o),n?.close()}}getDiagnosticsWhenEnabled(e){return te(e,"chatReferenceDiagnostic")?this._diagnostics.getDiagnostics():[]}getTools2ForRequest(e,t){if(!t.userSelectedTools2)return new Map;const i=new Map;for(const s of this._tools.getTools(e))typeof t.userSelectedTools2[s.name]=="boolean"&&i.set(s.name,t.userSelectedTools2[s.name]);return i}getToolsForRequest(e,t){if(!is(t.userSelectedTools))return;const i=new Set(t.userSelectedTools);return{tools:this._tools.getTools(e).filter(r=>i.has(r.name)),isExclusive:t.toolSelectionIsExclusive}}async prepareHistoryTurns(e,t,i){const s=[];for(const r of i.history){const n=Vr.to(r.result),o=t===r.request.agentId?n:{...n,metadata:void 0},d=r.request.variables.variables.filter(l=>l.kind!=="tool").map(l=>pg.to(l,this.getDiagnosticsWhenEnabled(e),this._logService)).filter(Zt),c=r.request.variables.variables.filter(l=>l.kind==="tool").map(gg.to),h=te(e,"chatParticipantPrivate")?r.request.editedFileEvents:void 0,g=new $n(r.request.message,r.request.command,d,r.request.agentId,c,h);s.push(g);const m=Re(r.response.map(l=>nu.toContent(l,this._commands.converter)));s.push(new ou(m,o,r.request.agentId,r.request.command))}return s}$releaseSession(e){this._sessionDisposables.deleteAndDispose(e),this._onDidDisposeChatSession.fire(e)}async $provideFollowups(e,t,i,s,r){const n=this._agents.get(t);if(!n)return Promise.resolve([]);const o=ze(e),d=await this.prepareHistoryTurns(n.extension,n.id,s),c=Vr.to(i);return(await n.provideFollowups(c,{history:d},r)).filter(h=>{const g=!h.participant||Ji.some(this._agents.values(),m=>m.id===h.participant&&ge.equals(m.extension.identifier,n.extension.identifier));return g||this._logService.warn(`[@${n.id}] ChatFollowup refers to an unknown participant: ${h.participant}`),g}).map(h=>jd.from(h,o))}$acceptFeedback(e,t,i){const s=this._agents.get(e);if(!s)return;const r=Vr.to(t);let n;switch(i.direction){case Kd.Down:n=Mn.Unhelpful;break;case Kd.Up:n=Mn.Helpful;break}const o={result:r,kind:n,unhelpfulReason:te(s.extension,"chatParticipantAdditions")?i.reason:void 0};s.acceptFeedback(Object.freeze(o))}$acceptAction(e,t,i){const s=this._agents.get(e);if(!s||i.action.kind==="vote")return;const r=mg.to(t,i,this._commands.converter);r&&s.acceptAction(Object.freeze(r))}async $invokeCompletionProvider(e,t,i){const s=this._agents.get(e);if(!s)return[];let r=this._completionDisposables.get(e);return r?r.clear():(r=new N,this._completionDisposables.set(e,r)),(await s.invokeCompletionProvider(t,i)).map(o=>_g.from(o,this._commands.converter,r))}async $provideChatTitle(e,t,i){const s=this._agents.get(e);if(!s)return;const r=await this.prepareHistoryTurns(s.extension,s.id,{history:t});return await s.provideTitle({history:r},i)}async $provideSampleQuestions(e,t,i){const s=this._agents.get(e);if(s)return(await s.provideSampleQuestions(zd.to(t),i)).map(r=>jd.from(r,void 0))}}class fw{constructor(e,t){this.extension=e,this.provider=t}}class pw{constructor(e,t){this.extension=e,this.provider=t}}class Pc{constructor(e,t,i,s,r){this.extension=e,this.id=t,this._proxy=i,this._handle=s,this._requestHandler=r,this._onDidReceiveFeedback=new P,this._onDidPerformAction=new P,this._pauseStateEmitter=new P}acceptFeedback(e){this._onDidReceiveFeedback.fire(e)}acceptAction(e){this._onDidPerformAction.fire(e)}setChatRequestPauseState(e){this._pauseStateEmitter.fire(e)}async invokeCompletionProvider(e,t){return this._agentVariableProvider?await this._agentVariableProvider.provider.provideCompletionItems(e,t)??[]:[]}async provideFollowups(e,t,i){if(!this._followupProvider)return[];const s=await this._followupProvider.provideFollowups(e,t,i);return s?s.filter(r=>!(r&&"commandId"in r)).filter(r=>!(r&&"message"in r)):[]}async provideTitle(e,t){if(this._titleProvider)return await this._titleProvider.provideChatTitle(e,t)??void 0}async provideSampleQuestions(e,t){if(!this._welcomeMessageProvider||!this._welcomeMessageProvider.provideSampleQuestions)return[];const i=await this._welcomeMessageProvider.provideSampleQuestions(e,t);return i||[]}get apiAgent(){let e=!1,t=!1;const i=()=>{e||t||(t=!0,queueMicrotask(()=>{this._proxy.$updateAgent(this._handle,{icon:this._iconPath?this._iconPath instanceof v?this._iconPath:"light"in this._iconPath?this._iconPath.light:void 0:void 0,iconDark:this._iconPath&&"dark"in this._iconPath?this._iconPath.dark:void 0,themeIcon:this._iconPath instanceof Et?this._iconPath:void 0,hasFollowups:this._followupProvider!==void 0,helpTextPrefix:!this._helpTextPrefix||typeof this._helpTextPrefix=="string"?this._helpTextPrefix:ce.from(this._helpTextPrefix),helpTextVariablesPrefix:!this._helpTextVariablesPrefix||typeof this._helpTextVariablesPrefix=="string"?this._helpTextVariablesPrefix:ce.from(this._helpTextVariablesPrefix),helpTextPostfix:!this._helpTextPostfix||typeof this._helpTextPostfix=="string"?this._helpTextPostfix:ce.from(this._helpTextPostfix),supportIssueReporting:this._supportIssueReporting,requester:this._requester,additionalWelcomeMessage:!this._additionalWelcomeMessage||typeof this._additionalWelcomeMessage=="string"?this._additionalWelcomeMessage:ce.from(this._additionalWelcomeMessage)}),t=!1}))},s=this;return{get id(){return s.id},get iconPath(){return s._iconPath},set iconPath(r){s._iconPath=r,i()},get requestHandler(){return s._requestHandler},set requestHandler(r){gl(typeof r=="function","Invalid request handler"),s._requestHandler=r},get followupProvider(){return s._followupProvider},set followupProvider(r){s._followupProvider=r,i()},get helpTextPrefix(){return b(s.extension,"defaultChatParticipant"),s._helpTextPrefix},set helpTextPrefix(r){b(s.extension,"defaultChatParticipant"),s._helpTextPrefix=r,i()},get helpTextVariablesPrefix(){return b(s.extension,"defaultChatParticipant"),s._helpTextVariablesPrefix},set helpTextVariablesPrefix(r){b(s.extension,"defaultChatParticipant"),s._helpTextVariablesPrefix=r,i()},get helpTextPostfix(){return b(s.extension,"defaultChatParticipant"),s._helpTextPostfix},set helpTextPostfix(r){b(s.extension,"defaultChatParticipant"),s._helpTextPostfix=r,i()},get supportIssueReporting(){return b(s.extension,"chatParticipantPrivate"),s._supportIssueReporting},set supportIssueReporting(r){b(s.extension,"chatParticipantPrivate"),s._supportIssueReporting=r,i()},get onDidReceiveFeedback(){return s._onDidReceiveFeedback.event},set participantVariableProvider(r){if(b(s.extension,"chatParticipantAdditions"),s._agentVariableProvider=r,r){if(!r.triggerCharacters.length)throw new Error("triggerCharacters are required");s._proxy.$registerAgentCompletionsProvider(s._handle,s.id,r.triggerCharacters)}else s._proxy.$unregisterAgentCompletionsProvider(s._handle,s.id)},get participantVariableProvider(){return b(s.extension,"chatParticipantAdditions"),s._agentVariableProvider},set welcomeMessageProvider(r){b(s.extension,"defaultChatParticipant"),s._welcomeMessageProvider=r,i()},get welcomeMessageProvider(){return b(s.extension,"defaultChatParticipant"),s._welcomeMessageProvider},set additionalWelcomeMessage(r){b(s.extension,"defaultChatParticipant"),s._additionalWelcomeMessage=r,i()},get additionalWelcomeMessage(){return b(s.extension,"defaultChatParticipant"),s._additionalWelcomeMessage},set titleProvider(r){b(s.extension,"defaultChatParticipant"),s._titleProvider=r,i()},get titleProvider(){return b(s.extension,"defaultChatParticipant"),s._titleProvider},get onDidChangePauseState(){return b(s.extension,"chatParticipantAdditions"),s._pauseStateEmitter.event},onDidPerformAction:te(this.extension,"chatParticipantAdditions")?this._onDidPerformAction.event:void 0,set requester(r){s._requester=r,i()},get requester(){return s._requester},dispose(){e=!0,s._followupProvider=void 0,s._onDidReceiveFeedback.dispose(),s._proxy.$unregisterAgent(s._handle)}}}invoke(e,t,i,s){return this._requestHandler(e,t,i,s)}}class gw{constructor(e){this._items=new Map,this._proxy=e.getProxy(k.MainThreadChatStatus)}createChatStatusItem(e,t){const i=mw(e.identifier,t);if(this._items.has(i))throw new Error(`Chat status item '${t}' already exists`);const s={id:i,title:"",description:"",detail:""};let r=!1,n=!1;const o=()=>{if(r)throw new Error("Chat status item is disposed");n&&this._proxy.$setEntry(t,s)},d=Object.freeze({id:t,get title(){return s.title},set title(c){s.title=c,o()},get description(){return s.description},set description(c){s.description=c,o()},get detail(){return s.detail},set detail(c){s.detail=c,o()},show:()=>{n=!0,o()},hide:()=>{n=!1,this._proxy.$disposeEntry(t)},dispose:()=>{r=!0,this._proxy.$disposeEntry(t),this._items.delete(i)}});return this._items.set(i,d),d}}function mw(a,e){return`${ge.toKey(a)}.${e}`}class _w{constructor(e){const t=e.getProxy(k.MainThreadClipboard);this.value=Object.freeze({readText(){return t.$readText()},writeText(i){return t.$writeText(i)}})}}const sh="vscode-cdn.net",vw=`vscode-resource.${sh}`,Vo=`'self' https://*.${sh}`;function ji(a,e){return a.scheme===q.http||a.scheme===q.https?a:(e&&e.authority&&e.isRemote&&a.scheme===q.file&&(a=v.from({scheme:q.vscodeRemote,authority:e.authority,path:a.path})),v.from({scheme:q.https,authority:`${a.scheme}+${yw(a.authority)}.${vw}`,path:a.path,fragment:a.fragment,query:a.query}))}function yw(a){return a.replace(/./g,e=>{const t=e.charCodeAt(0);return t>=ht.a&&t<=ht.z||t>=ht.A&&t<=ht.Z||t>=ht.Digit0&&t<=ht.Digit9?e:"-"+t.toString(16).padStart(4,"0")})}function mb(a){return a.replace(/-([0-9a-f]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}class ww{constructor(e,t,i){this._proxy=e,this._editors=t,this._remoteInfo=i,this._handlePool=0,this._disposables=new N,this._insets=new Map,this._disposables.add(t.onDidChangeVisibleTextEditors(()=>{const s=t.getVisibleTextEditors();for(const r of this._insets.values())s.indexOf(r.editor)<0&&r.inset.dispose()}))}dispose(){this._insets.forEach(e=>e.inset.dispose()),this._disposables.dispose()}createWebviewEditorInset(e,t,i,s,r){let n;for(const l of this._editors.getVisibleTextEditors(!0))if(l.value===e){n=l;break}if(!n)throw new Error("not a visible editor");const o=this,d=this._handlePool++,c=new P,h=new P,g=new class{constructor(){this._html="",this._options=Object.create(null)}asWebviewUri(l){return ji(l,o._remoteInfo)}get cspSource(){return Vo}set options(l){this._options=l,o._proxy.$setOptions(d,l)}get options(){return this._options}set html(l){this._html=l,o._proxy.$setHtml(d,l)}get html(){return this._html}get onDidReceiveMessage(){return c.event}postMessage(l){return o._proxy.$postMessage(d,l)}},m=new class{constructor(){this.editor=e,this.line=t,this.height=i,this.webview=g,this.onDidDispose=h.event}dispose(){o._insets.has(d)&&(o._insets.delete(d),o._proxy.$disposeEditorInset(d),h.fire(),h.dispose(),c.dispose())}};return this._proxy.$createEditorInset(d,n.id,n.value.document.uri,t+1,i,s||{},r.identifier,r.extensionLocation),this._insets.set(d,{editor:e,inset:m,onDidReceiveMessage:c}),m}$onDidDispose(e){const t=this._insets.get(e);t&&t.inset.dispose()}$onDidReceiveMessage(e,t){this._insets.get(e)?.onDidReceiveMessage.fire(t)}}class Ba{static{this._providerHandlePool=0}constructor(e){this.providers=new Map,this._proxy=e.getProxy(k.MainThreadCodeMapper)}async $mapCode(e,t,i){const s=this.providers.get(e);if(!s)throw new Error(`Received request to map code for unknown provider handle ${e}`);const r={textEdit:(d,c)=>{c=je(c),this._proxy.$handleProgress(t.requestId,{uri:d,edits:c.map(qe.from)})},notebookEdit:(d,c)=>{c=je(c),this._proxy.$handleProgress(t.requestId,{uri:d,edits:c.map(Tg.from)})}},n={location:t.location,chatRequestId:t.chatRequestId,chatRequestModel:t.chatRequestModel,chatSessionId:t.chatSessionId,codeBlocks:t.codeBlocks.map(d=>({code:d.code,resource:v.revive(d.resource),markdownBeforeBlock:d.markdownBeforeBlock}))};return await s.provideMappedEdits(n,r,i)??null}registerMappedEditsProvider(e,t){const i=Ba._providerHandlePool++;return this._proxy.$registerCodeMapperProvider(i,e.displayName??e.name),this.providers.set(i,t),{dispose:()=>this._proxy.$unregisterCodeMapperProvider(i)}}}function xw(a,e,t){const i=a.getProxy(k.MainThreadComments);class s{static{this.handlePool=0}constructor(){this._commentControllers=new Map,this._commentControllersByExtension=new Lt,e.registerArgumentProcessor({processArgument:f=>{if(f&&f.$mid===xe.CommentController){const _=this._commentControllers.get(f.handle);return _?_.value:f}else if(f&&f.$mid===xe.CommentThread){const _=f,x=this._commentControllers.get(_.commentControlHandle);if(!x)return _;const C=x.getCommentThread(_.commentThreadHandle);return C?C.value:_}else if(f&&(f.$mid===xe.CommentThreadReply||f.$mid===xe.CommentThreadInstance)){const _=this._commentControllers.get(f.thread.commentControlHandle);if(!_)return f;const x=_.getCommentThread(f.thread.commentThreadHandle);return x?f.$mid===xe.CommentThreadInstance?x.value:{thread:x.value,text:f.text}:f}else if(f&&f.$mid===xe.CommentNode){const _=this._commentControllers.get(f.thread.commentControlHandle);if(!_)return f;const x=_.getCommentThread(f.thread.commentThreadHandle);if(!x)return f;const C=f.commentUniqueId,S=x.getCommentByUniqueId(C);return S||f}else if(f&&f.$mid===xe.CommentThreadNode){const _=this._commentControllers.get(f.thread.commentControlHandle);if(!_)return f;const x=_.getCommentThread(f.thread.commentThreadHandle);if(!x)return f;const C=f.text,S=f.commentUniqueId,T=x.getCommentByUniqueId(S);return T?(typeof T.body=="string"?T.body=C:T.body=new ui(C),T):f}return f}})}createCommentController(f,_,x){const C=s.handlePool++,S=new n(f,C,_,x);this._commentControllers.set(S.handle,S);const T=this._commentControllersByExtension.get(f.identifier)||[];return T.push(S),this._commentControllersByExtension.set(f.identifier,T),S.value}async $createCommentThreadTemplate(f,_,x,C){const S=this._commentControllers.get(f);S&&S.$createCommentThreadTemplate(_,x,C)}async $setActiveComment(f,_){const x=this._commentControllers.get(f);x&&x.$setActiveComment(_??void 0)}async $updateCommentThreadTemplate(f,_,x){const C=this._commentControllers.get(f);C&&C.$updateCommentThreadTemplate(_,x)}$deleteCommentThread(f,_){this._commentControllers.get(f)?.$deleteCommentThread(_)}async $updateCommentThread(f,_,x){this._commentControllers.get(f)?.$updateCommentThread(_,x)}async $provideCommentingRanges(f,_,x){const C=this._commentControllers.get(f);if(!C||!C.commentingRangeProvider)return Promise.resolve(void 0);const S=await t.ensureDocumentData(v.revive(_));return we(async()=>{const T=await C.commentingRangeProvider?.provideCommentingRanges(S.document,x);let O;return Array.isArray(T)?O={ranges:T,fileComments:!1}:T?O={ranges:T.ranges||[],fileComments:T.enableFileComments||!1}:O=T??void 0,O}).then(T=>{let O;return T&&(O={ranges:T.ranges.map(I=>$.from(I)),fileComments:T.fileComments}),O})}$toggleReaction(f,_,x,C,S){const T=this._commentControllers.get(f);return!T||!T.reactionHandler?Promise.resolve(void 0):we(()=>{const O=T.getCommentThread(_);if(O){const I=O.getCommentByUniqueId(C.uniqueIdInThread);if(T!==void 0&&I&&T.reactionHandler)return T.reactionHandler(I,c(S))}return Promise.resolve(void 0)})}}class r{static{this._handlePool=0}set threadId(f){this._id=f}get threadId(){return this._id}get id(){return this._id}get resource(){return this._uri}get uri(){return this._uri}set range(f){(f===void 0!=(this._range===void 0)||!f||!this._range||!f.isEqual(this._range))&&(this._range=f,this.modifications.range=f,this._onDidUpdateCommentThread.fire())}get range(){return this._range}set canReply(f){this._canReply!==f&&(this._canReply=f,this.modifications.canReply=f,this._onDidUpdateCommentThread.fire())}get canReply(){return this._canReply}get label(){return this._label}set label(f){this._label=f,this.modifications.label=f,this._onDidUpdateCommentThread.fire()}get contextValue(){return this._contextValue}set contextValue(f){this._contextValue=f,this.modifications.contextValue=f,this._onDidUpdateCommentThread.fire()}get comments(){return this._comments}set comments(f){this._comments=f,this.modifications.comments=f,this._onDidUpdateCommentThread.fire()}get collapsibleState(){return this._collapseState}set collapsibleState(f){this._collapseState!==f&&(this._collapseState=f,this.modifications.collapsibleState=f,this._onDidUpdateCommentThread.fire())}get state(){return this._state}set state(f){this._state=f,typeof f=="object"?(b(this.extensionDescription,"commentThreadApplicability"),this.modifications.state=f.resolved,this.modifications.applicability=f.applicability):this.modifications.state=f,this._onDidUpdateCommentThread.fire()}get isDisposed(){return this._isDiposed}constructor(f,_,x,C,S,T,O,I,K){this._commentControllerHandle=_,this._id=x,this._uri=C,this._range=S,this._comments=T,this.extensionDescription=O,this._isTemplate=I,this.handle=r._handlePool++,this.commentHandle=0,this.modifications=Object.create(null),this._onDidUpdateCommentThread=new P,this.onDidUpdateCommentThread=this._onDidUpdateCommentThread.event,this._canReply=!0,this._commentsMap=new Map,this._acceptInputDisposables=new At,this._acceptInputDisposables.value=new N,this._id===void 0&&(this._id=`${f}.${this.handle}`),i.$createCommentThread(_,this.handle,this._id,this._uri,$.from(this._range),this._comments.map(W=>o(this,W,this._commentsMap,this.extensionDescription)),O.identifier,this._isTemplate,K),this._localDisposables=[],this._isDiposed=!1,this._localDisposables.push(this.onDidUpdateCommentThread(()=>{this.eventuallyUpdateCommentThread()})),this._localDisposables.push({dispose:()=>{i.$deleteCommentThread(_,this.handle)}});const ie=this;this.value={get uri(){return ie.uri},get range(){return ie.range},set range(W){ie.range=W},get comments(){return ie.comments},set comments(W){ie.comments=W},get collapsibleState(){return ie.collapsibleState},set collapsibleState(W){ie.collapsibleState=W},get canReply(){return ie.canReply},set canReply(W){ie.canReply=W},get contextValue(){return ie.contextValue},set contextValue(W){ie.contextValue=W},get label(){return ie.label},set label(W){ie.label=W},get state(){return ie.state},set state(W){ie.state=W},reveal:(W,se)=>ie.reveal(W,se),hide:()=>ie.hide(),dispose:()=>{ie.dispose()}}}updateIsTemplate(){this._isTemplate&&(this._isTemplate=!1,this.modifications.isTemplate=!1)}eventuallyUpdateCommentThread(){if(this._isDiposed)return;this.updateIsTemplate(),this._acceptInputDisposables.value||(this._acceptInputDisposables.value=new N);const f=x=>Object.prototype.hasOwnProperty.call(this.modifications,x),_={};f("range")&&(_.range=$.from(this._range)),f("label")&&(_.label=this.label),f("contextValue")&&(_.contextValue=this.contextValue??null),f("comments")&&(_.comments=this._comments.map(x=>o(this,x,this._commentsMap,this.extensionDescription))),f("collapsibleState")&&(_.collapseState=h(this._collapseState)),f("canReply")&&(_.canReply=this.canReply),f("state")&&(_.state=g(this._state)),f("applicability")&&(_.applicability=m(this._state)),f("isTemplate")&&(_.isTemplate=this._isTemplate),this.modifications={},i.$updateCommentThread(this._commentControllerHandle,this.handle,this._id,this._uri,_)}getCommentByUniqueId(f){for(const _ of this._commentsMap){const x=_[0],C=_[1];if(f===C)return x}}async reveal(f,_){b(this.extensionDescription,"commentReveal");let x;f&&f.body!==void 0?x=f:_=_??f;let C=x?this._commentsMap.get(x):void 0;C??=this._commentsMap.get(this._comments[0]);let S=!0,T=!1;return _?.focus===Bn.Reply?(T=!0,S=!1):_?.focus===Bn.Comment&&(S=!1),i.$revealCommentThread(this._commentControllerHandle,this.handle,C,{preserveFocus:S,focusReply:T})}async hide(){return i.$hideCommentThread(this._commentControllerHandle,this.handle)}dispose(){this._isDiposed=!0,this._acceptInputDisposables.dispose(),this._localDisposables.forEach(f=>f.dispose())}}class n{get id(){return this._id}get label(){return this._label}get handle(){return this._handle}get commentingRangeProvider(){return this._commentingRangeProvider}set commentingRangeProvider(f){this._commentingRangeProvider=f,f?.resourceHints&&b(this._extension,"commentingRangeHint"),i.$updateCommentingRanges(this.handle,f?.resourceHints)}get reactionHandler(){return this._reactionHandler}set reactionHandler(f){this._reactionHandler=f,i.$updateCommentControllerFeatures(this.handle,{reactionHandler:!!f})}get options(){return this._options}set options(f){this._options=f,i.$updateCommentControllerFeatures(this.handle,{options:this._options})}get activeComment(){return b(this._extension,"activeComment"),this._activeComment}get activeCommentThread(){return b(this._extension,"activeComment"),this._activeThread?.value}constructor(f,_,x,C){this._extension=f,this._handle=_,this._id=x,this._label=C,this._threads=new Map,i.$registerCommentController(this.handle,x,C,this._extension.identifier.value);const S=this;this.value=Object.freeze({id:S.id,label:S.label,get options(){return S.options},set options(T){S.options=T},get commentingRangeProvider(){return S.commentingRangeProvider},set commentingRangeProvider(T){S.commentingRangeProvider=T},get reactionHandler(){return S.reactionHandler},set reactionHandler(T){S.reactionHandler=T},get activeCommentThread(){return S.activeCommentThread},createCommentThread(T,O,I){return S.createCommentThread(T,O,I).value},dispose:()=>{S.dispose()}}),this._localDisposables=[],this._localDisposables.push({dispose:()=>{i.$unregisterCommentController(this.handle)}})}createCommentThread(f,_,x){const C=new r(this.id,this.handle,void 0,f,_,x,this._extension,!1);return this._threads.set(C.handle,C),C}$setActiveComment(f){if(!f){this._activeComment=void 0,this._activeThread=void 0;return}const _=this._threads.get(f.commentThreadHandle);_&&(this._activeComment=f.uniqueIdInThread?_.getCommentByUniqueId(f.uniqueIdInThread):void 0,this._activeThread=_)}$createCommentThreadTemplate(f,_,x){const C=new r(this.id,this.handle,void 0,v.revive(f),$.to(_),[],this._extension,!0,x);return C.collapsibleState=hs.Expanded,this._threads.set(C.handle,C),C}$updateCommentThreadTemplate(f,_){const x=this._threads.get(f);x&&(x.range=$.to(_))}$updateCommentThread(f,_){const x=this._threads.get(f);if(!x)return;(S=>Object.prototype.hasOwnProperty.call(_,S))("collapseState")&&(x.collapsibleState=h(_.collapseState))}$deleteCommentThread(f){this._threads.get(f)?.dispose(),this._threads.delete(f)}getCommentThread(f){return this._threads.get(f)}dispose(){this._threads.forEach(f=>{f.dispose()}),this._localDisposables.forEach(f=>f.dispose())}}function o(l,f,_,x){let C=_.get(f);return C||(C=++l.commentHandle,_.set(f,C)),f.state!==void 0&&b(x,"commentsDraftState"),f.reactions?.some(S=>S.reactors!==void 0)&&b(x,"commentReactor"),{mode:f.mode,contextValue:f.contextValue,uniqueIdInThread:C,body:typeof f.body=="string"?f.body:ce.from(f.body),userName:f.author.name,userIconPath:f.author.iconPath,label:f.label,commentReactions:f.reactions?f.reactions.map(S=>d(S)):void 0,state:f.state,timestamp:f.timestamp?.toJSON()}}function d(l){return{label:l.label,iconPath:l.iconPath?kg(l.iconPath):void 0,count:l.count,hasReacted:l.authorHasReacted,reactors:l.reactors&&l.reactors.length>0&&typeof l.reactors[0]!="string"?l.reactors.map(f=>f.name):l.reactors}}function c(l){return{label:l.label||"",count:l.count||0,iconPath:l.iconPath?v.revive(l.iconPath):"",authorHasReacted:l.hasReacted||!1,reactors:l.reactors?.map(f=>({name:f}))}}function h(l){if(l!==void 0)switch(l){case Vn.Expanded:return hs.Expanded;case Vn.Collapsed:return hs.Collapsed}return hs.Collapsed}function g(l){let f;if(typeof l=="object"?f=l.resolved:f=l,f!==void 0)switch(f){case zn.Unresolved:return $r.Unresolved;case zn.Resolved:return $r.Resolved}return $r.Unresolved}function m(l){let f;if(typeof l=="object"&&(f=l.applicability),f!==void 0)switch(f){case qn.Current:return Mr.Current;case qn.Outdated:return Mr.Outdated}return Mr.Current}return new s}class bw{#e;#t;#i;#s;#n;#r;#a;#o;#d;#c;#l;#h;constructor(e,t,i,s,r,n,o){this.#a="",this.#d=!1,this.#c=!1,this._onMessageEmitter=new P,this.onDidReceiveMessage=this._onMessageEmitter.event,this.#u=new P,this._onDidDispose=this.#u.event,this.#e=e,this.#t=t,this.#o=i,this.#s=s,this.#n=r,this.#r=n,this.#l=hi(n),this.#h=Ew(n),this.#i=o}#u;dispose(){this.#d=!0,this.#u.fire(),this.#u.dispose(),this._onMessageEmitter.dispose()}asWebviewUri(e){return this.#c=!0,ji(e,this.#s)}get cspSource(){const e=this.#r.extensionLocation;if(e.scheme===q.https||e.scheme===q.http){let t=e.toString();return t.endsWith("/")||(t+="/"),t+" "+Vo}return Vo}get html(){return this.assertNotDisposed(),this.#a}set html(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#h&&!this.#c&&/(["'])vscode-resource:([^\s'"]+?)(["'])/i.test(e)&&(this.#c=!0,this.#i.report("Webview vscode-resource: uris",this.#r,"Please migrate to use the 'webview.asWebviewUri' api instead: https://aka.ms/vscode-webview-use-aswebviewuri")),this.#t.$setHtml(this.#e,this.rewriteOldResourceUrlsIfNeeded(e)))}get options(){return this.assertNotDisposed(),this.#o}set options(e){this.assertNotDisposed(),ml(this.#o,e)||this.#t.$setOptions(this.#e,rh(this.#r,this.#n,e)),this.#o=e}async postMessage(e){if(this.#d)return!1;const t=Rg(e,{serializeBuffersForPostMessage:this.#l});return this.#t.$postMessage(this.#e,t.message,...t.buffers)}assertNotDisposed(){if(this.#d)throw new Error("Webview is disposed")}rewriteOldResourceUrlsIfNeeded(e){if(!this.#h)return e;const t=this.#r.extensionLocation?.scheme===q.vscodeRemote,i=this.#r.extensionLocation.scheme===q.vscodeRemote?this.#r.extensionLocation.authority:void 0;return e.replace(/(["'])(?:vscode-resource):(\/\/([^\s\/'"]+?)(?=\/))?([^\s'"]+?)(["'])/gi,(s,r,n,o,d,c)=>{const h=v.from({scheme:o||"file",path:decodeURIComponent(d)}),g=ji(h,{isRemote:t,authority:i}).toString();return`${r}${g}${c}`}).replace(/(["'])(?:vscode-webview-resource):(\/\/[^\s\/'"]+\/([^\s\/'"]+?)(?=\/))?([^\s'"]+?)(["'])/gi,(s,r,n,o,d,c)=>{const h=v.from({scheme:o||"file",path:decodeURIComponent(d)}),g=ji(h,{isRemote:t,authority:i}).toString();return`${r}${g}${c}`})}}function hi(a){try{const e=pu(gu(a.engines.vscode));return!!e&&e.majorBase>=1&&e.minorBase>=57}catch{return!1}}function Ew(a){try{const e=pu(gu(a.engines.vscode));return e?e.majorBase<1||e.majorBase===1&&e.minorBase<60:!1}catch{return!1}}class Sw extends X{constructor(e,t,i,s,r){super(),this.remoteInfo=t,this.workspace=i,this._logService=s,this._deprecationService=r,this._webviews=new Map,this._webviewProxy=e.getProxy(k.MainThreadWebviews)}dispose(){super.dispose();for(const e of this._webviews.values())e.dispose();this._webviews.clear()}$onMessage(e,t,i){const s=this.getWebview(e);if(s){const{message:r}=Ig(t,i.value);s._onMessageEmitter.fire(r)}}$onMissingCsp(e,t){this._logService.warn(`${t} created a webview without a content security policy: https://aka.ms/vscode-webview-missing-csp`)}createNewWebview(e,t,i){const s=new bw(e,this._webviewProxy,Cw(t),this.remoteInfo,this.workspace,i,this._deprecationService);this._webviews.set(e,s);const r=s._onDidDispose(()=>{r.dispose(),this.deleteWebview(e)});return s}deleteWebview(e){this._webviews.delete(e)}getWebview(e){return this._webviews.get(e)}}function hr(a){return{id:a.identifier,location:a.extensionLocation}}function rh(a,e,t){return{enableCommandUris:t.enableCommandUris,enableScripts:t.enableScripts,enableForms:t.enableForms,portMapping:t.portMapping,localResourceRoots:t.localResourceRoots||Dw(a,e)}}function Cw(a){return{enableCommandUris:a.enableCommandUris,enableScripts:a.enableScripts,enableForms:a.enableForms,portMapping:a.portMapping,localResourceRoots:a.localResourceRoots?.map(e=>v.from(e))}}function Dw(a,e){return[...(e?.getWorkspaceFolders()||[]).map(t=>t.uri),a.extensionLocation]}class He{static{this.enableDebugLogging=!1}constructor(e){this.id=e,this._data=new Map,this._idPool=1}add(e){const t=this._idPool++;return this._data.set(t,e),this.logDebugInfo(),t}get(e,t){return this._data.has(e)?this._data.get(e)[t]:void 0}delete(e){this._data.delete(e),this.logDebugInfo()}logDebugInfo(){He.enableDebugLogging&&console.log(`${this.id} cache size - ${this._data.size}`)}}class Pw{constructor(e,t){this.document=e,this._storagePath=t,this._backupCounter=1,this._edits=new He("custom documents")}addEdit(e){return this._edits.add([e])}async undo(e,t){await this.getEdit(e).undo(),t||this.disposeBackup()}async redo(e,t){await this.getEdit(e).redo(),t||this.disposeBackup()}disposeEdits(e){for(const t of e)this._edits.delete(t)}getNewBackupUri(){if(!this._storagePath)throw new Error("Backup requires a valid storage path");const e=$w(this.document.uri)+this._backupCounter++;return Js(this._storagePath,e)}updateBackup(e){this._backup?.delete(),this._backup=e}disposeBackup(){this._backup?.delete(),this._backup=void 0}getEdit(e){const t=this._edits.get(e,0);if(!t)throw new Error("No edit found");return t}}class Tw{constructor(){this._documents=new Map}get(e,t){return this._documents.get(this.key(e,t))}add(e,t,i){const s=this.key(e,t.uri);if(this._documents.has(s))throw new Error(`Document already exists for viewType:${e} resource:${t.uri}`);const r=new Pw(t,i);return this._documents.set(s,r),r}delete(e,t){const i=this.key(e,t.uri);this._documents.delete(i)}key(e,t){return`${e}@@@${t}`}}var yt;(function(a){a[a.Text=0]="Text",a[a.Custom=1]="Custom"})(yt||(yt={}));class kw{constructor(){this._providers=new Map}addTextProvider(e,t,i){return this.add(e,{type:yt.Text,extension:t,provider:i})}addCustomProvider(e,t,i){return this.add(e,{type:yt.Custom,extension:t,provider:i})}get(e){return this._providers.get(e)}add(e,t){if(this._providers.has(e))throw new Error(`Provider for viewType:${e} already registered`);return this._providers.set(e,t),new V(()=>this._providers.delete(e))}}class Iw{constructor(e,t,i,s,r){this._extHostDocuments=t,this._extensionStoragePaths=i,this._extHostWebview=s,this._extHostWebviewPanels=r,this._editorProviders=new kw,this._documents=new Tw,this._proxy=e.getProxy(k.MainThreadCustomEditors)}registerCustomEditorProvider(e,t,i,s){const r=new N;return Rw(i)?(r.add(this._editorProviders.addTextProvider(t,e,i)),this._proxy.$registerTextEditorProvider(hr(e),t,s.webviewOptions||{},{supportsMove:!!i.moveCustomTextEditor},hi(e))):(r.add(this._editorProviders.addCustomProvider(t,e,i)),_s(i)&&r.add(i.onDidChangeCustomDocument(n=>{const o=this.getCustomDocumentEntry(t,n.document.uri);if(Aw(n)){const d=o.addEdit(n);this._proxy.$onDidEdit(n.document.uri,t,d,n.label)}else this._proxy.$onContentChange(n.document.uri,t)})),this._proxy.$registerCustomEditorProvider(hr(e),t,s.webviewOptions||{},!!s.supportsMultipleEditorsPerDocument,hi(e))),V.from(r,new V(()=>{this._proxy.$unregisterEditorProvider(t)}))}async $createCustomDocument(e,t,i,s,r){const n=this._editorProviders.get(t);if(!n)throw new Error(`No provider found for '${t}'`);if(n.type!==yt.Custom)throw new Error(`Invalid provide type for '${t}'`);const o=v.revive(e),d=await n.provider.openCustomDocument(o,{backupId:i,untitledDocumentData:s?.buffer},r);let c;return _s(n.provider)&&this._extensionStoragePaths&&(c=this._extensionStoragePaths.workspaceValue(n.extension)??this._extensionStoragePaths.globalValue(n.extension)),this._documents.add(t,d,c),{editable:_s(n.provider)}}async $disposeCustomDocument(e,t){const i=this._editorProviders.get(t);if(!i)throw new Error(`No provider found for '${t}'`);if(i.type!==yt.Custom)throw new Error(`Invalid provider type for '${t}'`);const s=v.revive(e),{document:r}=this.getCustomDocumentEntry(t,s);this._documents.delete(t,r),r.dispose()}async $resolveCustomEditor(e,t,i,s,r,n){const o=this._editorProviders.get(i);if(!o)throw new Error(`No provider found for '${i}'`);const d=ye.to(r),c=this._extHostWebview.createNewWebview(t,s.contentOptions,o.extension),h=this._extHostWebviewPanels.createNewWebviewPanel(t,i,s.title,d,s.options,c,s.active),g=v.revive(e);switch(o.type){case yt.Custom:{const{document:m}=this.getCustomDocumentEntry(i,g);return o.provider.resolveCustomEditor(m,h,n)}case yt.Text:{const m=this._extHostDocuments.getDocument(g);return o.provider.resolveCustomTextEditor(m,h,n)}default:throw new Error("Unknown webview provider type")}}$disposeEdits(e,t,i){this.getCustomDocumentEntry(t,e).disposeEdits(i)}async $onMoveCustomEditor(e,t,i){const s=this._editorProviders.get(i);if(!s)throw new Error(`No provider found for '${i}'`);if(!s.provider.moveCustomTextEditor)throw new Error(`Provider does not implement move '${i}'`);const r=this._extHostWebviewPanels.getWebviewPanel(e);if(!r)throw new Error("No webview found");const n=v.revive(t),o=this._extHostDocuments.getDocument(n);await s.provider.moveCustomTextEditor(o,r,ue.None)}async $undo(e,t,i,s){return this.getCustomDocumentEntry(t,e).undo(i,s)}async $redo(e,t,i,s){return this.getCustomDocumentEntry(t,e).redo(i,s)}async $revert(e,t,i){const s=this.getCustomDocumentEntry(t,e);await this.getCustomEditorProvider(t).revertCustomDocument(s.document,i),s.disposeBackup()}async $onSave(e,t,i){const s=this.getCustomDocumentEntry(t,e);await this.getCustomEditorProvider(t).saveCustomDocument(s.document,i),s.disposeBackup()}async $onSaveAs(e,t,i,s){const r=this.getCustomDocumentEntry(t,e);return this.getCustomEditorProvider(t).saveCustomDocumentAs(r.document,v.revive(i),s)}async $backup(e,t,i){const s=this.getCustomDocumentEntry(t,e),n=await this.getCustomEditorProvider(t).backupCustomDocument(s.document,{destination:s.getNewBackupUri()},i);return s.updateBackup(n),n.id}getCustomDocumentEntry(e,t){const i=this._documents.get(e,v.revive(t));if(!i)throw new Error("No custom document found");return i}getCustomEditorProvider(e){const i=this._editorProviders.get(e)?.provider;if(!i||!_s(i))throw new Error("Custom document is not editable");return i}}function _s(a){return!!a.onDidChangeCustomDocument}function Rw(a){return typeof a.resolveCustomTextEditor=="function"}function Aw(a){return typeof a.undo=="function"&&typeof a.redo=="function"}function $w(a){const e=a.scheme===q.file||a.scheme===q.untitled?a.fsPath:a.toString();return ul(e)+""}var kt;class fr{#e;#t;#i;constructor(e,t,i,s,r,n,o,d){this._name=e,this._owner=t,this._maxDiagnosticsTotal=i,this._maxDiagnosticsPerFile=s,this._modelVersionIdProvider=r,this._isDisposed=!1,this._maxDiagnosticsTotal=Math.max(s,i),this.#i=new Ye(c=>n.getComparisonKey(c)),this.#e=o,this.#t=d}dispose(){this._isDisposed||(this.#t.fire([...this.#i.keys()]),this.#e?.$clear(this._owner),this.#i.clear(),this._isDisposed=!0)}get name(){return this._checkDisposed(),this._name}set(e,t){if(!e){this.clear();return}this._checkDisposed();let i=[];if(v.isUri(e)){if(!t){this.delete(e);return}this.#i.set(e,t.slice()),i=[e]}else if(Array.isArray(e)){i=[];let n;e=[...e].sort(fr._compareIndexedTuplesByUri);for(const o of e){const[d,c]=o;if((!n||d.toString()!==n.toString())&&(n&&this.#i.get(n).length===0&&this.#i.delete(n),n=d,i.push(d),this.#i.set(d,[])),c)this.#i.get(d)?.push(...c);else{const h=this.#i.get(d);h&&(h.length=0)}}}if(this.#t.fire(i),!this.#e)return;const s=[];let r=0;for(const n of i){let o=[];const d=this.#i.get(n);if(d)if(d.length>this._maxDiagnosticsPerFile){o=[];const c=[Ai.Error,Ai.Warning,Ai.Information,Ai.Hint];e:for(let h=0;h<4;h++)for(const g of d)if(g.severity===c[h]&&o.push({...rr.from(g),modelVersionId:this._modelVersionIdProvider(n)})===this._maxDiagnosticsPerFile)break e;o.push({severity:Qf.Info,message:J(2555,"Not showing {0} further errors and warnings.",d.length-this._maxDiagnosticsPerFile),startLineNumber:o[o.length-1].startLineNumber,startColumn:o[o.length-1].startColumn,endLineNumber:o[o.length-1].endLineNumber,endColumn:o[o.length-1].endColumn})}else o=d.map(c=>({...rr.from(c),modelVersionId:this._modelVersionIdProvider(n)}));if(s.push([n,o]),r+=o.length,r>this._maxDiagnosticsTotal)break}this.#e.$changeMany(this._owner,s)}delete(e){this._checkDisposed(),this.#t.fire([e]),this.#i.delete(e),this.#e?.$changeMany(this._owner,[[e,void 0]])}clear(){this._checkDisposed(),this.#t.fire([...this.#i.keys()]),this.#i.clear(),this.#e?.$clear(this._owner)}forEach(e,t){this._checkDisposed();for(const[i,s]of this)e.call(t,i,s,this)}*[Symbol.iterator](){this._checkDisposed();for(const e of this.#i.keys())yield[e,this.get(e)]}get(e){this._checkDisposed();const t=this.#i.get(e);return Array.isArray(t)?Object.freeze(t.slice(0)):[]}has(e){return this._checkDisposed(),Array.isArray(this.#i.get(e))}_checkDisposed(){if(this._isDisposed)throw new Error("illegal state - object is disposed")}static _compareIndexedTuplesByUri(e,t){return e[0].toString()<t[0].toString()?-1:e[0].toString()>t[0].toString()?1:0}}let zo=class{static{kt=this}static{this._idPool=0}static{this._maxDiagnosticsPerFile=1e3}static{this._maxDiagnosticsTotal=1.1*this._maxDiagnosticsPerFile}static _mapper(e){const t=new Ye;for(const i of e)t.set(i,i);return{uris:Object.freeze(Array.from(t.values()))}}constructor(e,t,i,s){this._logService=t,this._fileSystemInfoService=i,this._extHostDocumentsAndEditors=s,this._collections=new Map,this._onDidChangeDiagnostics=new Gf({merge:r=>r.flat(),delay:50}),this.onDidChangeDiagnostics=Ee.map(this._onDidChangeDiagnostics.event,kt._mapper),this._proxy=e.getProxy(k.MainThreadDiagnostics)}createDiagnosticCollection(e,t){const{_collections:i,_proxy:s,_onDidChangeDiagnostics:r,_logService:n,_fileSystemInfoService:o,_extHostDocumentsAndEditors:d}=this,c=new class{$changeMany(m,l){s.$changeMany(m,l),n.trace("[DiagnosticCollection] change many (extension, owner, uris)",e.value,m,l.length===0?"CLEARING":l)}$clear(m){s.$clear(m),n.trace("[DiagnosticCollection] remove all (extension, owner)",e.value,m)}dispose(){s.dispose()}};let h;if(!t)t="_generated_diagnostic_collection_name_#"+kt._idPool++,h=t;else if(!i.has(t))h=t;else{this._logService.warn(`DiagnosticCollection with name '${t}' does already exist.`);do h=t+kt._idPool++;while(i.has(h))}return new class extends fr{constructor(){super(t,h,kt._maxDiagnosticsTotal,kt._maxDiagnosticsPerFile,m=>d.getDocument(m)?.version,o.extUri,c,r),i.set(h,this)}dispose(){super.dispose(),i.delete(h)}}}getDiagnostics(e){if(e)return this._getDiagnostics(e);{const t=new Map,i=[];for(const s of this._collections.values())s.forEach((r,n)=>{let o=t.get(r.toString());typeof o>"u"&&(o=i.length,t.set(r.toString(),o),i.push([r,[]])),i[o][1]=i[o][1].concat(...n)});return i}}_getDiagnostics(e){let t=[];for(const i of this._collections.values())i.has(e)&&(t=t.concat(i.get(e)));return t}$acceptMarkersChange(e){if(!this._mirrorCollection){const t="_generated_mirror",i=new fr(t,t,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,s=>{},this._fileSystemInfoService.extUri,void 0,this._onDidChangeDiagnostics);this._collections.set(t,i),this._mirrorCollection=i}for(const[t,i]of e)this._mirrorCollection.set(v.revive(t),i.map(rr.to))}};zo=kt=L([E(1,re),E(2,pi)],zo);class Mw{constructor(e){this._proxy=e.getProxy(k.MainThreadDialogs)}showOpenDialog(e){return this._proxy.$showOpenDialog(e).then(t=>t?t.map(i=>v.revive(i)):void 0)}showSaveDialog(e){return this._proxy.$showSaveDialog(e).then(t=>t?v.revive(t):void 0)}}class Va{static{this._handlePool=0}constructor(e,t,i){this._documentsAndEditors=t,this._logService=i,this._documentContentProviders=new Map,this._proxy=e.getProxy(k.MainThreadDocumentContentProviders)}registerTextDocumentContentProvider(e,t){if(Object.keys(q).indexOf(e)>=0)throw new Error(`scheme '${e}' already registered`);const i=Va._handlePool++;this._documentContentProviders.set(i,t),this._proxy.$registerTextContentProvider(i,e);let s;if(typeof t.onDidChange=="function"){let r;s=t.onDidChange(async n=>{if(n.scheme!==e){this._logService.warn(`Provider for scheme '${e}' is firing event for schema '${n.scheme}' which will be IGNORED`);return}if(!this._documentsAndEditors.getDocument(n))return;r&&await r;const o=this.$provideTextDocumentContent(i,n).then(async d=>{if(!d&&typeof d!="string")return;const c=this._documentsAndEditors.getDocument(n);if(!c)return;const h=Jf(d);if(!c.equalLines(h))return this._proxy.$onVirtualDocumentChange(n,d)}).catch(fa).finally(()=>{r===o&&(r=void 0)});r=o})}return new V(()=>{this._documentContentProviders.delete(i)&&this._proxy.$unregisterTextContentProvider(i),s&&(s.dispose(),s=void 0)})}$provideTextDocumentContent(e,t){const i=this._documentContentProviders.get(e);return i?Promise.resolve(i.provideTextDocumentContent(v.revive(t),ue.None)):Promise.reject(new Error(`unsupported uri-scheme: ${t.scheme}`))}}class Hw{constructor(e,t,i,s={timeout:1500,errors:3}){this._logService=e,this._documents=t,this._mainThreadBulkEdits=i,this._thresholds=s,this._callbacks=new Xf,this._badListeners=new WeakMap}dispose(){this._callbacks.clear()}getOnWillSaveTextDocumentEvent(e){return(t,i,s)=>{const n={dispose:this._callbacks.push([t,i,e])};return Array.isArray(s)&&s.push(n),n}}async $participateInSave(e,t){const i=v.revive(e);let s=!1;const r=setTimeout(()=>s=!0,this._thresholds.timeout),n=[];try{for(const o of[...this._callbacks]){if(s)break;const d=this._documents.getDocument(i),c=await this._deliverEventAsyncAndBlameBadListeners(o,{document:d,reason:mu.to(t)});n.push(c)}}finally{clearTimeout(r)}return n}_deliverEventAsyncAndBlameBadListeners([e,t,i],s){const r=this._badListeners.get(e);return typeof r=="number"&&r>this._thresholds.errors?Promise.resolve(!1):this._deliverEventAsync(i,e,t,s).then(()=>!0,n=>{if(this._logService.error(`onWillSaveTextDocument-listener from extension '${i.identifier.value}' threw ERROR`),this._logService.error(n),!(n instanceof Error)||n.message!=="concurrent_edits"){const o=this._badListeners.get(e);this._badListeners.set(e,o?o+1:1),typeof o=="number"&&o>this._thresholds.errors&&this._logService.info(`onWillSaveTextDocument-listener from extension '${i.identifier.value}' will now be IGNORED because of timeouts and/or errors`)}return!1})}_deliverEventAsync(e,t,i,s){const r=[],n=Date.now(),{document:o,reason:d}=s,{version:c}=o,h=Object.freeze({document:o,reason:d,waitUntil(g){if(Object.isFrozen(r))throw Yf("waitUntil can not be called async");r.push(Promise.resolve(g))}});try{t.apply(i,[h])}catch(g){return Promise.reject(g)}return new Promise((g,m)=>{const l=setTimeout(()=>m(new Error("timeout")),this._thresholds.timeout);return Promise.all(r).then(f=>{this._logService.debug(`onWillSaveTextDocument-listener from extension '${e.identifier.value}' finished after ${Date.now()-n}ms`),clearTimeout(l),g(f)}).catch(f=>{clearTimeout(l),m(f)})}).then(g=>{const m={edits:[]};for(const l of g)if(Array.isArray(l)&&l.every(f=>f instanceof _u))for(const{newText:f,newEol:_,range:x}of l)m.edits.push({resource:o.uri,versionId:void 0,textEdit:{range:x&&$.from(x),text:f,eol:_&&Sl.from(_)}});if(m.edits.length!==0)return c===o.version?this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new Ke(m)):Promise.reject(new Error("concurrent_edits"))})}}class Fw{constructor(e,t){this._onDidAddDocument=new P,this._onDidRemoveDocument=new P,this._onDidChangeDocument=new P,this._onDidSaveDocument=new P,this.onDidAddDocument=this._onDidAddDocument.event,this.onDidRemoveDocument=this._onDidRemoveDocument.event,this.onDidChangeDocument=this._onDidChangeDocument.event,this.onDidSaveDocument=this._onDidSaveDocument.event,this._toDispose=new N,this._documentLoader=new Map,this._proxy=e.getProxy(k.MainThreadDocuments),this._documentsAndEditors=t,this._documentsAndEditors.onDidRemoveDocuments(i=>{for(const s of i)this._onDidRemoveDocument.fire(s.document)},void 0,this._toDispose),this._documentsAndEditors.onDidAddDocuments(i=>{for(const s of i)this._onDidAddDocument.fire(s.document)},void 0,this._toDispose)}dispose(){this._toDispose.dispose()}getAllDocumentData(){return[...this._documentsAndEditors.allDocuments()]}getDocumentData(e){if(!e)return;const t=this._documentsAndEditors.getDocument(e);if(t)return t}getDocument(e){const t=this.getDocumentData(e);if(!t?.document)throw new Error(`Unable to retrieve document from URI '${e}'`);return t.document}ensureDocumentData(e,t){const i=this._documentsAndEditors.getDocument(e);if(i&&(!t?.encoding||i.document.encoding===t.encoding))return Promise.resolve(i);let s=this._documentLoader.get(e.toString());return s?t?.encoding&&(s=s.then(r=>r.document.encoding!==t.encoding?this.ensureDocumentData(e,t):r)):(s=this._proxy.$tryOpenDocument(e,t).then(r=>{this._documentLoader.delete(e.toString());const n=v.revive(r);return js(this._documentsAndEditors.getDocument(n))},r=>(this._documentLoader.delete(e.toString()),Promise.reject(r))),this._documentLoader.set(e.toString(),s)),s}createDocumentData(e){return this._proxy.$tryCreateDocument(e).then(t=>v.revive(t))}$acceptModelLanguageChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");this._onDidRemoveDocument.fire(s.document),s._acceptLanguageId(t),this._onDidAddDocument.fire(s.document)}$acceptModelSaved(e){const t=v.revive(e),i=this._documentsAndEditors.getDocument(t);if(!i)throw new Error("unknown document");this.$acceptDirtyStateChanged(e,!1),this._onDidSaveDocument.fire(i.document)}$acceptDirtyStateChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");s._acceptIsDirty(t),this._onDidChangeDocument.fire({document:s.document,contentChanges:[],reason:void 0})}$acceptEncodingChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");s._acceptEncoding(t),this._onDidChangeDocument.fire({document:s.document,contentChanges:[],reason:void 0})}$acceptModelChanged(e,t,i){const s=v.revive(e),r=this._documentsAndEditors.getDocument(s);if(!r)throw new Error("unknown document");r._acceptIsDirty(i),r.onEvents(t);let n;t.isUndoing?n=jn.Undo:t.isRedoing&&(n=jn.Redo),this._onDidChangeDocument.fire(Zf({document:r.document,contentChanges:t.changes.map(o=>({range:$.to(o.range),rangeOffset:o.rangeOffset,rangeLength:o.rangeLength,text:o.text})),reason:n}))}setWordDefinitionFor(e,t){ay(e,t)}}class Lw{constructor(e){this._provider=new Map,this._onDidChange=new P,this.onDidChange=this._onDidChange.event,this._allKnownModels=new Set,this._handlePool=0,this._proxy=e.getProxy(k.MainThreadEmbeddings)}registerEmbeddingsProvider(e,t,i){if(this._allKnownModels.has(t))throw new Error("An embeddings provider for this model is already registered");const s=this._handlePool++;return this._proxy.$registerEmbeddingProvider(s,t),this._provider.set(s,{id:t,provider:i}),B(()=>{this._allKnownModels.delete(t),this._proxy.$unregisterEmbeddingProvider(s),this._provider.delete(s)})}async computeEmbeddings(e,t,i){i??=ue.None;let s=!1;typeof t=="string"&&(t=[t],s=!0);const r=await this._proxy.$computeEmbeddings(e,t,i);if(r.length!==t.length)throw new Error;if(s){if(r.length!==1)throw new Error;return r[0]}return r}async $provideEmbeddings(e,t,i){const s=this._provider.get(e);if(!s)return[];const r=await s.provider.provideEmbeddings(t,i);return r||[]}get embeddingsModels(){return Array.from(this._allKnownModels)}$acceptEmbeddingModels(e){this._allKnownModels=new Set(e),this._onDidChange.fire()}}class Nw{constructor(e){this._AiEmbeddingVectorProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiEmbeddingVector)}async $provideAiEmbeddingVector(e,t,i){if(this._AiEmbeddingVectorProviders.size===0)throw new Error("No embedding vector providers registered");const s=this._AiEmbeddingVectorProviders.get(e);if(!s)throw new Error("Embedding vector provider not found");const r=await s.provideEmbeddingVector(t,i);if(!r)throw new Error("Embedding vector provider returned undefined");return r}registerEmbeddingVectorProvider(e,t,i){const s=this._nextHandle;return this._nextHandle++,this._AiEmbeddingVectorProviders.set(s,i),this._proxy.$registerAiEmbeddingVectorProvider(t,s),new V(()=>{this._proxy.$unregisterAiEmbeddingVectorProvider(s),this._AiEmbeddingVectorProviders.delete(s)})}}class Ow{constructor(){this._schemes=[]}add(e){this._stateMachine=void 0,this._schemes.push(e)}delete(e){const t=this._schemes.indexOf(e);t>=0&&(this._schemes.splice(t,1),this._stateMachine=void 0)}_initStateMachine(){if(!this._stateMachine){const e=this._schemes.sort(),t=[];let i,s,r=ot.LastKnownState,n=ot.LastKnownState;for(const o of e){let d=i?ep(i,o):0;for(d===0?s=ot.Start:s=n;d<o.length;d++)d+1===o.length?(r=n,n=ot.BeforeColon):n+=1,t.push([s,o.toUpperCase().charCodeAt(d),n]),t.push([s,o.toLowerCase().charCodeAt(d),n]),s=n;i=o,n=r}t.push([ot.BeforeColon,ht.Colon,ot.AfterColon]),t.push([ot.AfterColon,ht.Slash,ot.End]),this._stateMachine=new tp(t)}}provideDocumentLinks(e){this._initStateMachine();const t=[],i=ip.computeLinks({getLineContent(s){return e.lineAt(s-1).text},getLineCount(){return e.lineCount}},this._stateMachine);for(const s of i){const r=Bi.to(s);r.target&&t.push(r)}return t}}class pr{constructor(e,t){this._extHostLanguageFeatures=t,this._linkProvider=new Ow,this._fsProvider=new Map,this._registeredSchemes=new Set,this._watches=new Map,this._handlePool=0,this._proxy=e.getProxy(k.MainThreadFileSystem)}dispose(){this._linkProviderRegistration?.dispose()}registerFileSystemProvider(e,t,i,s={}){if(pr._validateFileSystemProvider(i),this._registeredSchemes.has(t))throw new Error(`a provider for the scheme '${t}' is already registered`);this._linkProviderRegistration||(this._linkProviderRegistration=this._extHostLanguageFeatures.registerDocumentLinkProvider(e,"*",this._linkProvider));const r=this._handlePool++;this._linkProvider.add(t),this._registeredSchemes.add(t),this._fsProvider.set(r,i);let n=gt.FileReadWrite;s.isCaseSensitive&&(n+=gt.PathCaseSensitive),s.isReadonly&&(n+=gt.Readonly),typeof i.copy=="function"&&(n+=gt.FileFolderCopy),typeof i.open=="function"&&typeof i.close=="function"&&typeof i.read=="function"&&typeof i.write=="function"&&(b(e,"fsChunks"),n+=gt.FileOpenReadWriteClose);let o;s.isReadonly&&_l(s.isReadonly)&&s.isReadonly.value!==""&&(o={value:s.isReadonly.value,isTrusted:s.isReadonly.isTrusted,supportThemeIcons:s.isReadonly.supportThemeIcons,supportHtml:s.isReadonly.supportHtml,baseUri:s.isReadonly.baseUri,uris:s.isReadonly.uris}),this._proxy.$registerFileSystemProvider(r,t,n,o).catch(c=>{console.error(`FAILED to register filesystem provider of ${e.identifier.value}-extension for the scheme ${t}`),console.error(c)});const d=i.onDidChangeFile(c=>{const h=[];for(const g of c){const{uri:m,type:l}=g;if(m.scheme!==t)continue;let f;switch(l){case As.Changed:f=Hr.UPDATED;break;case As.Created:f=Hr.ADDED;break;case As.Deleted:f=Hr.DELETED;break;default:throw new Error("Unknown FileChangeType")}h.push({resource:m,type:f})}this._proxy.$onFileSystemChange(r,h)});return B(()=>{d.dispose(),this._linkProvider.delete(t),this._registeredSchemes.delete(t),this._fsProvider.delete(r),this._proxy.$unregisterProvider(r)})}static _validateFileSystemProvider(e){if(!e)throw new Error("MISSING provider");if(typeof e.watch!="function")throw new Error("Provider does NOT implement watch");if(typeof e.stat!="function")throw new Error("Provider does NOT implement stat");if(typeof e.readDirectory!="function")throw new Error("Provider does NOT implement readDirectory");if(typeof e.createDirectory!="function")throw new Error("Provider does NOT implement createDirectory");if(typeof e.readFile!="function")throw new Error("Provider does NOT implement readFile");if(typeof e.writeFile!="function")throw new Error("Provider does NOT implement writeFile");if(typeof e.delete!="function")throw new Error("Provider does NOT implement delete");if(typeof e.rename!="function")throw new Error("Provider does NOT implement rename")}static _asIStat(e){const{type:t,ctime:i,mtime:s,size:r,permissions:n}=e;return{type:t,ctime:i,mtime:s,size:r,permissions:n}}$stat(e,t){return Promise.resolve(this._getFsProvider(e).stat(v.revive(t))).then(i=>pr._asIStat(i))}$readdir(e,t){return Promise.resolve(this._getFsProvider(e).readDirectory(v.revive(t)))}$readFile(e,t){return Promise.resolve(this._getFsProvider(e).readFile(v.revive(t))).then(i=>be.wrap(i))}$writeFile(e,t,i,s){return Promise.resolve(this._getFsProvider(e).writeFile(v.revive(t),i.buffer,s))}$delete(e,t,i){return Promise.resolve(this._getFsProvider(e).delete(v.revive(t),i))}$rename(e,t,i,s){return Promise.resolve(this._getFsProvider(e).rename(v.revive(t),v.revive(i),s))}$copy(e,t,i,s){const r=this._getFsProvider(e);if(!r.copy)throw new Error('FileSystemProvider does not implement "copy"');return Promise.resolve(r.copy(v.revive(t),v.revive(i),s))}$mkdir(e,t){return Promise.resolve(this._getFsProvider(e).createDirectory(v.revive(t)))}$watch(e,t,i,s){const r=this._getFsProvider(e).watch(v.revive(i),s);this._watches.set(t,r)}$unwatch(e,t){const i=this._watches.get(t);i&&(i.dispose(),this._watches.delete(t))}$open(e,t,i){const s=this._getFsProvider(e);if(!s.open)throw new Error('FileSystemProvider does not implement "open"');return Promise.resolve(s.open(v.revive(t),i))}$close(e,t){const i=this._getFsProvider(e);if(!i.close)throw new Error('FileSystemProvider does not implement "close"');return Promise.resolve(i.close(t))}$read(e,t,i,s){const r=this._getFsProvider(e);if(!r.read)throw new Error('FileSystemProvider does not implement "read"');const n=be.alloc(s);return Promise.resolve(r.read(t,i,n.buffer,0,s)).then(o=>n.slice(0,o))}$write(e,t,i,s){const r=this._getFsProvider(e);if(!r.write)throw new Error('FileSystemProvider does not implement "write"');return Promise.resolve(r.write(t,i,s.buffer,0,s.byteLength))}_getFsProvider(e){const t=this._fsProvider.get(e);if(!t){const i=new Error;throw i.name="ENOPRO",i.message="no provider",i}return t}}class nh extends X{static{this.MAX_RESTARTS=5}constructor(e,t,i,s){super(),this.onFileChanges=e,this.onLogMessage=t,this.verboseLogging=i,this.options=s,this.watcherDisposables=this._register(new At),this.requests=void 0,this.restartCounter=0}init(){const e=new N;this.watcherDisposables.value=e,this.watcher=this.createWatcher(e),this.watcher.setVerboseLogging(this.verboseLogging),e.add(this.watcher.onDidChangeFile(t=>this.onFileChanges(t))),e.add(this.watcher.onDidLogMessage(t=>this.onLogMessage(t))),e.add(this.watcher.onDidError(t=>this.onError(t.error,t.request)))}onError(e,t){this.canRestart(e,t)?this.restartCounter<nh.MAX_RESTARTS&&this.requests?(this.error(`restarting watcher after unexpected error: ${e}`),this.restart(this.requests)):this.error(`gave up attempting to restart watcher after unexpected error: ${e}`):this.error(e)}canRestart(e,t){return!(!this.options.restartOnError||t||e.indexOf("No space left on device")!==-1||e.indexOf("EMFILE")!==-1)}restart(e){this.restartCounter++,this.init(),this.watch(e)}async watch(e){this.requests=e,await this.watcher?.watch(e)}async setVerboseLogging(e){this.verboseLogging=e,await this.watcher?.setVerboseLogging(e)}error(e){this.onLogMessage({type:"error",message:`[File Watcher (${this.options.type})] ${e}`})}trace(e){this.onLogMessage({type:"trace",message:`[File Watcher (${this.options.type})] ${e}`})}dispose(){return this.watcher=void 0,super.dispose()}}function Uw(a,e){return typeof e=="string"&&!e.startsWith(mn)&&!sp(e)?{base:a,pattern:e}:e}class Ww{get ignoreCreateEvents(){return!!(this._config&1)}get ignoreChangeEvents(){return!!(this._config&2)}get ignoreDeleteEvents(){return!!(this._config&4)}constructor(e,t,i,s,r,n,o){this.session=Math.random(),this._onDidCreate=new P,this._onDidChange=new P,this._onDidDelete=new P,this._config=0,o.ignoreCreateEvents&&(this._config+=1),o.ignoreChangeEvents&&(this._config+=2),o.ignoreDeleteEvents&&(this._config+=4);const d=fn(n),c=typeof n=="string",h=r(g=>{if(!(typeof g.session=="number"&&g.session!==this.session)){if(!o.ignoreCreateEvents)for(const m of g.created){const l=v.revive(m);d(l.fsPath)&&(!c||i.getWorkspaceFolder(l))&&this._onDidCreate.fire(l)}if(!o.ignoreChangeEvents)for(const m of g.changed){const l=v.revive(m);d(l.fsPath)&&(!c||i.getWorkspaceFolder(l))&&this._onDidChange.fire(l)}if(!o.ignoreDeleteEvents)for(const m of g.deleted){const l=v.revive(m);d(l.fsPath)&&(!c||i.getWorkspaceFolder(l))&&this._onDidDelete.fire(l)}}});this._disposable=V.from(this.ensureWatching(e,i,t,s,n,o,!1),this._onDidCreate,this._onDidChange,this._onDidDelete,h)}ensureWatching(e,t,i,s,r,n,o){const d=V.from();if(typeof r=="string"||n.ignoreChangeEvents&&n.ignoreCreateEvents&&n.ignoreDeleteEvents)return d;const c=e.getProxy(k.MainThreadFileSystemEventService);let h=!1;(r.pattern.includes(mn)||r.pattern.includes(rp))&&(h=!0);const g=[];let m,l;if(o)(n.ignoreChangeEvents||n.ignoreCreateEvents||n.ignoreDeleteEvents)&&(l=qt.UPDATED|qt.ADDED|qt.DELETED,n.ignoreChangeEvents&&(l&=~qt.UPDATED),n.ignoreCreateEvents&&(l&=~qt.ADDED),n.ignoreDeleteEvents&&(l&=~qt.DELETED));else if(h&&g.length===0){const f=t.getWorkspaceFolder(v.revive(r.baseUri)),_=i.getConfiguration("files",f).get("watcherExclude");if(_)for(const x in _)x&&_[x]===!0&&g.push(x)}else if(!h){const f=t.getWorkspaceFolder(v.revive(r.baseUri));if(f){const _=i.getConfiguration("files",f).get("watcherExclude");if(_){for(const x in _)if(x&&_[x]===!0){const C=`${np(x,"/")}/${mn}`;m||(m=[]),m.push(Uw(f.uri.fsPath,C))}}if(!m||m.length===0)return d}}return c.$watch(s.identifier.value,this.session,r.baseUri,{recursive:h,excludes:g,includes:m,filter:l},!!o),V.from({dispose:()=>c.$unwatch(this.session)})}dispose(){this._disposable.dispose()}get onDidCreate(){return this._onDidCreate.event}get onDidChange(){return this._onDidChange.event}get onDidDelete(){return this._onDidDelete.event}}class Bw{get created(){return this._created.value}get changed(){return this._changed.value}get deleted(){return this._deleted.value}constructor(e){this._events=e,this._created=new Li(()=>this._events.created.map(v.revive)),this._changed=new Li(()=>this._events.changed.map(v.revive)),this._deleted=new Li(()=>this._events.deleted.map(v.revive)),this.session=this._events.session}}class Vw{constructor(e,t,i){this._mainContext=e,this._logService=t,this._extHostDocumentsAndEditors=i,this._onFileSystemEvent=new P,this._onDidRenameFile=new P,this._onDidCreateFile=new P,this._onDidDeleteFile=new P,this._onWillRenameFile=new Fi,this._onWillCreateFile=new Fi,this._onWillDeleteFile=new Fi,this.onDidRenameFile=this._onDidRenameFile.event,this.onDidCreateFile=this._onDidCreateFile.event,this.onDidDeleteFile=this._onDidDeleteFile.event}createFileSystemWatcher(e,t,i,s,r){return new Ww(this._mainContext,t,e,i,this._onFileSystemEvent.event,Ss.from(s),r)}$onFileEvent(e){this._onFileSystemEvent.fire(new Bw(e))}$onDidRunFileOperation(e,t){switch(e){case at.MOVE:this._onDidRenameFile.fire(Object.freeze({files:t.map(i=>({oldUri:v.revive(i.source),newUri:v.revive(i.target)}))}));break;case at.DELETE:this._onDidDeleteFile.fire(Object.freeze({files:t.map(i=>v.revive(i.target))}));break;case at.CREATE:case at.COPY:this._onDidCreateFile.fire(Object.freeze({files:t.map(i=>v.revive(i.target))}));break}}getOnWillRenameFileEvent(e){return this._createWillExecuteEvent(e,this._onWillRenameFile)}getOnWillCreateFileEvent(e){return this._createWillExecuteEvent(e,this._onWillCreateFile)}getOnWillDeleteFileEvent(e){return this._createWillExecuteEvent(e,this._onWillDeleteFile)}_createWillExecuteEvent(e,t){return(i,s,r)=>{const n=function(d){i.call(s,d)};return n.extension=e,t.event(n,void 0,r)}}async $onWillRunFileOperation(e,t,i,s){switch(e){case at.MOVE:return await this._fireWillEvent(this._onWillRenameFile,{files:t.map(r=>({oldUri:v.revive(r.source),newUri:v.revive(r.target)}))},i,s);case at.DELETE:return await this._fireWillEvent(this._onWillDeleteFile,{files:t.map(r=>v.revive(r.target))},i,s);case at.CREATE:case at.COPY:return await this._fireWillEvent(this._onWillCreateFile,{files:t.map(r=>v.revive(r.target))},i,s)}}async _fireWillEvent(e,t,i,s){const r=new Set,n=[];if(await e.fireAsync(t,s,async(d,c)=>{const h=Date.now(),g=await Promise.resolve(d);g instanceof Ta&&(n.push([c.extension,g]),r.add(c.extension.displayName??c.extension.identifier.value)),Date.now()-h>i&&this._logService.warn("SLOW file-participant",c.extension.identifier)}),s.isCancellationRequested||n.length===0)return;const o={edits:[]};for(const[,d]of n){const{edits:c}=Le.from(d,{getTextDocumentVersion:h=>this._extHostDocumentsAndEditors.getDocument(h)?.version,getNotebookDocumentVersion:()=>{}});o.edits=o.edits.concat(c)}return{edit:o,extensionNames:Array.from(r)}}}class zw{constructor(e,t,i,s,r){this._extHostNotebooks=t,this._textDocumentsAndEditors=i,this._commands=s;const n=new H("interactive.open","_interactive.open","Open interactive window and return notebook editor and input URI",[new D("showOptions","Show Options",o=>!0,o=>o),new D("resource","Interactive resource Uri",o=>!0,o=>o),new D("controllerId","Notebook controller Id",o=>!0,o=>o),new D("title","Interactive editor title",o=>!0,o=>o)],new M("Notebook and input URI",o=>{if(r.debug("[ExtHostInteractive] open iw with notebook editor id",o.notebookEditorId),o.notebookEditorId!==void 0){const d=this._extHostNotebooks.getEditorById(o.notebookEditorId);return r.debug("[ExtHostInteractive] notebook editor found",d.id),{notebookUri:v.revive(o.notebookUri),inputUri:v.revive(o.inputUri),notebookEditor:d.apiEditor}}return r.debug("[ExtHostInteractive] notebook editor not found, uris for the interactive document",o.notebookUri,o.inputUri),{notebookUri:v.revive(o.notebookUri),inputUri:v.revive(o.inputUri)}}));this._commands.registerApiCommand(n)}$willAddInteractiveDocument(e,t,i,s){this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({addedDocuments:[{EOL:t,lines:[""],languageId:i,uri:e,isDirty:!1,versionId:1,encoding:"utf8"}]})}$willRemoveInteractiveDocument(e,t){this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({removedDocuments:[e]})}}class qw{constructor(e){this._handlePool=0,this._proxy=e.getProxy(k.MainThreadLabelService)}$registerResourceLabelFormatter(e){const t=this._handlePool++;return this._proxy.$registerResourceLabelFormatter(t,e),B(()=>{this._proxy.$unregisterResourceLabelFormatter(t)})}}class gr{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentSymbols(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentSymbols(i,t);if(!pa(s))return s[0]instanceof yu?s.map(Ag.from):gr._asDocumentSymbolTree(s)}static _asDocumentSymbolTree(e){e=e.slice(0).sort((s,r)=>{let n=s.location.range.start.compareTo(r.location.range.start);return n===0&&(n=r.location.range.end.compareTo(s.location.range.end)),n});const t=[],i=[];for(const s of e){const r={name:s.name||"!!MISSING: name!!",kind:tu.from(s.kind),tags:s.tags?.map($g.from)||[],detail:"",containerName:s.containerName,range:$.from(s.location.range),selectionRange:$.from(s.location.range),children:[]};for(;;){if(i.length===0){i.push(r),t.push(r);break}const n=i[i.length-1];if(Ft.containsRange(n.range,r.range)&&!Ft.equalsRange(n.range,r.range)){n.children?.push(r),i.push(r);break}i.pop()}}return t}}class vs{constructor(e,t,i,s,r,n){this._documents=e,this._commands=t,this._provider=i,this._extension=s,this._extTelemetry=r,this._logService=n,this._cache=new He("CodeLens"),this._disposables=new Map}async provideCodeLenses(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideCodeLenses(i,t);if(!s||t.isCancellationRequested)return;const r=this._cache.add(s),n=new N;this._disposables.set(r,n);const o={cacheId:r,lenses:[]};for(let d=0;d<s.length;d++){if(!de.isRange(s[d].range)){console.warn("INVALID code lens, range is not defined",this._extension.identifier.value);continue}o.lenses.push({cacheId:[r,d],range:$.from(s[d].range),command:this._commands.toInternal(s[d].command,n)})}return o}async resolveCodeLens(e,t){const i=e.cacheId&&this._cache.get(...e.cacheId);if(!i)return;let s;if(typeof this._provider.resolveCodeLens!="function"||i.isResolved?s=i:s=await this._provider.resolveCodeLens(i,t),s||(s=i),t.isCancellationRequested)return;const r=e.cacheId&&this._disposables.get(e.cacheId[0]);if(r){if(!s.command){const n=new Error("INVALID code lens resolved, lacks command: "+this._extension.identifier.value);this._extTelemetry.onExtensionError(this._extension.identifier,n),this._logService.error(n);return}return e.command=this._commands.toInternal(s.command,r),e}}releaseCodeLenses(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}}function Dr(a){return Array.isArray(a)?a.map(An.from):a?[An.from(a)]:[]}class Tc{constructor(e,t){this._documents=e,this._provider=t}async provideDefinition(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideDefinition(s,r,i);return Dr(n)}}class kc{constructor(e,t){this._documents=e,this._provider=t}async provideDeclaration(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideDeclaration(s,r,i);return Dr(n)}}class Ic{constructor(e,t){this._documents=e,this._provider=t}async provideImplementation(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideImplementation(s,r,i);return Dr(n)}}class Rc{constructor(e,t){this._documents=e,this._provider=t}async provideTypeDefinition(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideTypeDefinition(s,r,i);return Dr(n)}}class Ki{static{this.HOVER_MAP_MAX_SIZE=10}constructor(e,t){this._documents=e,this._provider=t,this._hoverCounter=0,this._hoverMap=new Map}async provideHover(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t);let o;if(i&&i.verbosityRequest){const g=i.verbosityRequest.previousHover.id,m=this._hoverMap.get(g);if(!m)throw new Error(`Hover with id ${g} not found`);const l={verbosityDelta:i.verbosityRequest.verbosityDelta,previousHover:m};o=await this._provider.provideHover(r,n,s,l)}else o=await this._provider.provideHover(r,n,s);if(!o||pa(o.contents))return;o.range||(o.range=r.getWordRangeAtPosition(n)),o.range||(o.range=new de(n,n));const d=Tn.from(o),c=this._hoverCounter;if(this._hoverMap.size===Ki.HOVER_MAP_MAX_SIZE){const g=Math.min(...this._hoverMap.keys());this._hoverMap.delete(g)}return this._hoverMap.set(c,o),this._hoverCounter+=1,{...d,id:c}}releaseHover(e){this._hoverMap.delete(e)}}class Ac{constructor(e,t){this._documents=e,this._provider=t}async provideEvaluatableExpression(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideEvaluatableExpression(s,r,i);if(n)return Mg.from(n)}}class $c{constructor(e,t){this._documents=e,this._provider=t}async provideInlineValues(e,t,i,s){const r=this._documents.getDocument(e),n=await this._provider.provideInlineValues(r,$.to(t),Yl.to(i),s);if(Array.isArray(n))return n.map(o=>Zl.from(o))}}class Mc{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentHighlights(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideDocumentHighlights(s,r,i);if(Array.isArray(n))return n.map(jl.from)}}class Hc{constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideMultiDocumentHighlights(e,t,i,s){const r=this._documents.getDocument(e),n=i.map(c=>{try{return this._documents.getDocument(c)}catch(h){this._logService.error("Error: Unable to retrieve document from URI: "+c+". Error message: "+h);return}}).filter(c=>c!==void 0),o=Z.to(t),d=await this._provider.provideMultiDocumentHighlights(r,o,n,s);if(Array.isArray(d))return d.map(Hg.from)}}class Fc{constructor(e,t){this._documents=e,this._provider=t}async provideLinkedEditingRanges(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.provideLinkedEditingRanges(s,r,i);if(n&&Array.isArray(n.ranges))return{ranges:Re(n.ranges.map($.from)),wordPattern:n.wordPattern}}}class Lc{constructor(e,t){this._documents=e,this._provider=t}async provideReferences(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t),o=await this._provider.provideReferences(r,n,i,s);if(Array.isArray(o))return o.map(tt.from)}}class wt{static{this._maxCodeActionsPerFile=1e3}constructor(e,t,i,s,r,n,o){this._documents=e,this._commands=t,this._diagnostics=i,this._provider=s,this._logService=r,this._extension=n,this._apiDeprecation=o,this._cache=new He("CodeAction"),this._disposables=new Map}async provideCodeActions(e,t,i,s){const r=this._documents.getDocument(e),n=op.isISelection(t)?et.to(t):$.to(t),o=[];for(const l of this._diagnostics.getDiagnostics(e))if(n.intersection(l.range)&&o.push(l)>wt._maxCodeActionsPerFile)break;const d={diagnostics:o,only:i.only?new Pa(i.only):void 0,triggerKind:Fg.to(i.trigger)},c=await this._provider.provideCodeActions(r,n,d,s);if(!is(c)||s.isCancellationRequested)return;const h=this._cache.add(c),g=new N;this._disposables.set(h,g);const m=[];for(let l=0;l<c.length;l++){const f=c[l];if(f)if(wt._isCommand(f)&&!(f instanceof Da))this._apiDeprecation.report("CodeActionProvider.provideCodeActions - return commands",this._extension,"Return 'CodeAction' instances instead."),m.push({_isSynthetic:!0,title:f.title,command:this._commands.toInternal(f,g)});else{const _=f;d.only&&(_.kind?d.only.contains(_.kind)||this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${d.only.value}' requested but returned code action is of kind '${_.kind.value}'. Code action will be dropped. Please check 'CodeActionContext.only' to only return requested code actions.`):this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${d.only.value}' requested but returned code action does not have a 'kind'. Code action will be dropped. Please set 'CodeAction.kind'.`));const x=_.ranges??[];m.push({cacheId:[h,l],title:_.title,command:_.command&&this._commands.toInternal(_.command,g),diagnostics:_.diagnostics&&_.diagnostics.map(rr.from),edit:_.edit&&Le.from(_.edit,void 0),kind:_.kind&&_.kind.value,isPreferred:_.isPreferred,isAI:te(this._extension,"codeActionAI")?_.isAI:!1,ranges:te(this._extension,"codeActionRanges")?Re(x.map($.from)):void 0,disabled:_.disabled?.reason})}}return{cacheId:h,actions:m}}async resolveCodeAction(e,t){const[i,s]=e,r=this._cache.get(i,s);if(!r||wt._isCommand(r))return{};if(!this._provider.resolveCodeAction)return{};const n=await this._provider.resolveCodeAction(r,t)??r;let o;n.edit&&(o=Le.from(n.edit,void 0));let d;if(n.command){const c=this._disposables.get(i);c&&(d=this._commands.toInternal(n.command,c))}return{edit:o,command:d}}releaseCodeActions(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}static _isCommand(e){return typeof e.command=="string"&&typeof e.title=="string"}}class Ci{constructor(e,t,i,s,r){this._proxy=e,this._documents=t,this._provider=i,this._handle=s,this._extension=r,this._editsCache=new He("DocumentPasteEdit.edits")}async prepareDocumentPaste(e,t,i,s){if(!this._provider.prepareDocumentPaste)return;this._cachedPrepare=void 0;const r=this._documents.getDocument(e),n=t.map(g=>$.to(g)),o=nr.toDataTransfer(i,()=>{throw new ap});if(await this._provider.prepareDocumentPaste(r,n,o,s),s.isCancellationRequested)return;const d=Array.from(o).filter(([,g])=>!(g instanceof qg)),c=new Map,h=await Promise.all(Array.from(d,async([g,m])=>{const l=it();return c.set(l,m),[g,await Yd.from(g,m,l)]}));return this._cachedPrepare=c,{items:h}}async providePasteEdits(e,t,i,s,r,n){if(!this._provider.provideDocumentPasteEdits)return[];const o=this._documents.getDocument(t),d=i.map(l=>$.to(l)),c=s.items.map(([l,f])=>{const _=this._cachedPrepare?.get(f.id);return _?[l,_]:[l,Yd.to(l,f,async x=>(await this._proxy.$resolvePasteFileData(this._handle,e,x)).buffer)]}),h=new ka(c),g=await this._provider.provideDocumentPasteEdits(o,d,h,{only:r.only?new bu(r.only):void 0,triggerKind:r.triggerKind},n);if(!g||n.isCancellationRequested)return[];const m=this._editsCache.add(g);return g.map((l,f)=>({_cacheId:[m,f],title:l.title??J(2558,"Paste using '{0}' extension",this._extension.displayName||this._extension.name),kind:l.kind,yieldTo:l.yieldTo?.map(_=>_.value),insertText:typeof l.insertText=="string"?l.insertText:{snippet:l.insertText.value},additionalEdit:l.additionalEdit?Le.from(l.additionalEdit,void 0):void 0}))}async resolvePasteEdit(e,t){const[i,s]=e,r=this._editsCache.get(i,s);if(!r||!this._provider.resolveDocumentPasteEdit)return{};const n=await this._provider.resolveDocumentPasteEdit(r,t)??r;return{insertText:n.insertText,additionalEdit:n.additionalEdit?Le.from(n.additionalEdit,void 0):void 0}}releasePasteEdits(e){this._editsCache.delete(e)}}class Nc{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentFormattingEdits(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideDocumentFormattingEdits(s,t,i);if(Array.isArray(r))return r.map(qe.from)}}class Jr{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentRangeFormattingEdits(e,t,i,s){const r=this._documents.getDocument(e),n=$.to(t),o=await this._provider.provideDocumentRangeFormattingEdits(r,n,i,s);if(Array.isArray(o))return o.map(qe.from)}async provideDocumentRangesFormattingEdits(e,t,i,s){gl(typeof this._provider.provideDocumentRangesFormattingEdits=="function","INVALID invocation of `provideDocumentRangesFormattingEdits`");const r=this._documents.getDocument(e),n=t.map($.to),o=await this._provider.provideDocumentRangesFormattingEdits(r,n,i,s);if(Array.isArray(o))return o.map(qe.from)}}class Oc{constructor(e,t){this._documents=e,this._provider=t,this.autoFormatTriggerCharacters=[]}async provideOnTypeFormattingEdits(e,t,i,s,r){const n=this._documents.getDocument(e),o=Z.to(t),d=await this._provider.provideOnTypeFormattingEdits(n,o,i,s,r);if(Array.isArray(d))return d.map(qe.from)}}class ys{constructor(e,t){this._provider=e,this._logService=t,this._cache=new He("WorkspaceSymbols")}async provideWorkspaceSymbols(e,t){const i=await this._provider.provideWorkspaceSymbols(e,t);if(!is(i))return{symbols:[]};const s=this._cache.add(i),r={cacheId:s,symbols:[]};for(let n=0;n<i.length;n++){const o=i[n];if(!o||!o.name){this._logService.warn("INVALID SymbolInformation",o);continue}r.symbols.push({...kn.from(o),cacheId:[s,n]})}return r}async resolveWorkspaceSymbol(e,t){if(typeof this._provider.resolveWorkspaceSymbol!="function"||!e.cacheId)return e;const i=this._cache.get(...e.cacheId);if(i){const s=await this._provider.resolveWorkspaceSymbol(i,t);return s&&Vs(e,kn.from(s),!0)}}releaseWorkspaceSymbols(e){this._cache.delete(e)}}class Mt{static supportsResolving(e){return typeof e.prepareRename=="function"}constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideRenameEdits(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t);try{const o=await this._provider.provideRenameEdits(r,n,i,s);return o?Le.from(o):void 0}catch(o){const d=Mt._asMessage(o);return d?{rejectReason:d,edits:void 0}:Promise.reject(o)}}async resolveRenameLocation(e,t,i){if(typeof this._provider.prepareRename!="function")return Promise.resolve(void 0);const s=this._documents.getDocument(e),r=Z.to(t);try{const n=await this._provider.prepareRename(s,r,i);let o,d;if(de.isRange(n)?(o=n,d=s.getText(n)):an(n)&&(o=n.range,d=n.placeholder),!o||!d)return;if(o.start.line>r.line||o.end.line<r.line){this._logService.warn("INVALID rename location: position line must be within range start/end lines");return}return{range:$.from(o),text:d}}catch(n){const o=Mt._asMessage(n);return o?{rejectReason:o,range:void 0,text:void 0}:Promise.reject(n)}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class oi{static{this.languageTriggerKindToVSCodeTriggerKind={[Sd.Invoke]:Kn.Invoke,[Sd.Automatic]:Kn.Automatic}}constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async supportsAutomaticNewSymbolNamesTriggerKind(){return this._provider.supportsAutomaticTriggerKind}async provideNewSymbolNames(e,t,i,s){const r=this._documents.getDocument(e),n=$.to(t);try{const o=oi.languageTriggerKindToVSCodeTriggerKind[i],d=await this._provider.provideNewSymbolNames(r,n,o,s);return d?d.map(c=>typeof c=="string"?{newSymbolName:c}:{newSymbolName:c.newSymbolName,tags:c.tags}):void 0}catch(o){this._logService.error(oi._asMessage(o)??JSON.stringify(o,null,"	"));return}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class Xr{constructor(e,t){this.resultId=e,this.tokens=t}}class Ie{constructor(e,t){this._documents=e,this._provider=t,this._nextResultId=1,this._previousResults=new Map}async provideDocumentSemanticTokens(e,t,i){const s=this._documents.getDocument(e),r=t!==0?this._previousResults.get(t):null;let n=typeof r?.resultId=="string"&&typeof this._provider.provideDocumentSemanticTokensEdits=="function"?await this._provider.provideDocumentSemanticTokensEdits(s,r.resultId,i):await this._provider.provideDocumentSemanticTokens(s,i);return r&&this._previousResults.delete(t),n?(n=Ie._fixProvidedSemanticTokens(n),this._send(Ie._convertToEdits(r,n),n)):null}async releaseDocumentSemanticColoring(e){this._previousResults.delete(e)}static _fixProvidedSemanticTokens(e){return Ie._isSemanticTokens(e)?Ie._isCorrectSemanticTokens(e)?e:new tr(new Uint32Array(e.data),e.resultId):Ie._isSemanticTokensEdits(e)?Ie._isCorrectSemanticTokensEdits(e)?e:new $s(e.edits.map(t=>new wu(t.start,t.deleteCount,t.data?new Uint32Array(t.data):t.data)),e.resultId):e}static _isSemanticTokens(e){return e&&!!e.data}static _isCorrectSemanticTokens(e){return e.data instanceof Uint32Array}static _isSemanticTokensEdits(e){return e&&Array.isArray(e.edits)}static _isCorrectSemanticTokensEdits(e){for(const t of e.edits)if(!(t.data instanceof Uint32Array))return!1;return!0}static _convertToEdits(e,t){if(!Ie._isSemanticTokens(t)||!e||!e.tokens)return t;const i=e.tokens,s=i.length,r=t.data,n=r.length;let o=0;const d=Math.min(s,n);for(;o<d&&i[o]===r[o];)o++;if(o===s&&o===n)return new $s([],t.resultId);let c=0;const h=d-o;for(;c<h&&i[s-c-1]===r[n-c-1];)c++;return new $s([{start:o,deleteCount:s-o-c,data:r.subarray(o,n-c)}],t.resultId)}_send(e,t){if(Ie._isSemanticTokens(e)){const i=this._nextResultId++;return this._previousResults.set(i,new Xr(e.resultId,e.data)),Gn({id:i,type:"full",data:e.data})}if(Ie._isSemanticTokensEdits(e)){const i=this._nextResultId++;return Ie._isSemanticTokens(t)?this._previousResults.set(i,new Xr(t.resultId,t.data)):this._previousResults.set(i,new Xr(e.resultId)),Gn({id:i,type:"delta",deltas:(e.edits||[]).map(s=>({start:s.start,deleteCount:s.deleteCount,data:s.data}))})}return null}}class Uc{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentRangeSemanticTokens(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideDocumentRangeSemanticTokens(s,$.to(t),i);return r?this._send(r):null}_send(e){return Gn({id:0,type:"full",data:e.data})}}class It{static supportsResolving(e){return typeof e.resolveCompletionItem=="function"}constructor(e,t,i,s,r){this._documents=e,this._commands=t,this._provider=i,this._apiDeprecation=s,this._extension=r,this._cache=new He("CompletionItem"),this._disposables=new Map}async provideCompletionItems(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t),o=r.getWordRangeAtPosition(n)||new de(n,n),d=o.with({end:n}),c=new di,h=await this._provider.provideCompletionItems(r,n,s,Lg.to(i));if(!h||s.isCancellationRequested)return;const g=Array.isArray(h)?new ir(h):h,m=It.supportsResolving(this._provider)?this._cache.add(g.items):this._cache.add([]),l=new N;this._disposables.set(m,l);const f=[],_={x:m,[ps.completions]:f,[ps.defaultRanges]:{replace:$.from(o),insert:$.from(d)},[ps.isIncomplete]:g.isIncomplete||void 0,[ps.duration]:c.elapsed()};for(let x=0;x<g.items.length;x++){const C=g.items[x],S=this._convertCompletionItem(C,[m,x],d,o);f.push(S)}return _}async resolveCompletionItem(e,t){if(typeof this._provider.resolveCompletionItem!="function")return;const i=this._cache.get(...e);if(!i)return;const s=this._convertCompletionItem(i,e),r=await this._provider.resolveCompletionItem(i,t);if(!r)return;const n=this._convertCompletionItem(r,e);return(s[U.insertText]!==n[U.insertText]||s[U.insertTextRules]!==n[U.insertTextRules])&&this._apiDeprecation.report("CompletionItem.insertText",this._extension,"extension MAY NOT change 'insertText' of a CompletionItem during resolve"),(s[U.commandIdent]!==n[U.commandIdent]||s[U.commandId]!==n[U.commandId]||!ml(s[U.commandArguments],n[U.commandArguments]))&&this._apiDeprecation.report("CompletionItem.command",this._extension,"extension MAY NOT change 'command' of a CompletionItem during resolve"),{...s,[U.documentation]:n[U.documentation],[U.detail]:n[U.detail],[U.additionalTextEdits]:n[U.additionalTextEdits],[U.insertText]:n[U.insertText],[U.insertTextRules]:n[U.insertTextRules],[U.commandIdent]:n[U.commandIdent],[U.commandId]:n[U.commandId],[U.commandArguments]:n[U.commandArguments]}}releaseCompletionItems(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_convertCompletionItem(e,t,i,s){const r=this._disposables.get(t[0]);if(!r)throw Error("DisposableStore is missing...");const n=this._commands.toInternal(e.command,r),o={x:t,[U.label]:e.label,[U.kind]:e.kind!==void 0?Og.from(e.kind):void 0,[U.kindModifier]:e.tags&&e.tags.map(Ng.from),[U.detail]:e.detail,[U.documentation]:typeof e.documentation>"u"?void 0:ce.fromStrict(e.documentation),[U.sortText]:e.sortText!==e.label?e.sortText:void 0,[U.filterText]:e.filterText!==e.label?e.filterText:void 0,[U.preselect]:e.preselect||void 0,[U.insertTextRules]:e.keepWhitespace?Fr.KeepWhitespace:Fr.None,[U.commitCharacters]:e.commitCharacters?.join(""),[U.additionalTextEdits]:e.additionalTextEdits&&e.additionalTextEdits.map(qe.from),[U.commandIdent]:n?.$ident,[U.commandId]:n?.id,[U.commandArguments]:n?.$ident?void 0:n?.arguments};e.textEdit?(this._apiDeprecation.report("CompletionItem.textEdit",this._extension,"Use 'CompletionItem.insertText' and 'CompletionItem.range' instead."),o[U.insertText]=e.textEdit.newText):typeof e.insertText=="string"?o[U.insertText]=e.insertText:e.insertText instanceof xu&&(o[U.insertText]=e.insertText.value,o[U.insertTextRules]|=Fr.InsertAsSnippet);let d;return e.textEdit?d=e.textEdit.range:e.range&&(d=e.range),de.isRange(d)?o[U.range]=$.from(d):d&&(!i?.isEqual(d.inserting)||!s?.isEqual(d.replacing))&&(o[U.range]={insert:$.from(d.inserting),replace:$.from(d.replacing)}),o}}class lt{constructor(e,t,i,s){this._extension=e,this._documents=t,this._provider=i,this._commands=s,this._references=new oh,this._isAdditionsProposedApiEnabled=te(this._extension,"inlineCompletionsAdditions"),this.languageTriggerKindToVSCodeTriggerKind={[Cd.Automatic]:Qn.Automatic,[Cd.Explicit]:Qn.Invoke}}get supportsHandleEvents(){return te(this._extension,"inlineCompletionsAdditions")&&(typeof this._provider.handleDidShowCompletionItem=="function"||typeof this._provider.handleDidPartiallyAcceptCompletionItem=="function"||typeof this._provider.handleDidRejectCompletionItem=="function"||typeof this._provider.handleEndOfLifetime=="function")}async provideInlineCompletions(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t),o=await this._provider.provideInlineCompletionItems(r,n,{selectedCompletionInfo:i.selectedSuggestionInfo?{range:$.to(i.selectedSuggestionInfo.range),text:i.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[i.triggerKind],requestUuid:i.requestUuid},s);if(!o||s.isCancellationRequested)return;const d=Array.isArray(o)?o:o.items,c=this._isAdditionsProposedApiEnabled?Array.isArray(o)?[]:o.commands||[]:[],h=this._isAdditionsProposedApiEnabled&&!Array.isArray(o)?o.enableForwardStability:void 0;let g;return{pid:this._references.createReferenceId({dispose(){g?.dispose()},items:d}),items:d.map((l,f)=>{let _;l.command&&(g||(g=new N),_=this._commands.toInternal(l.command,g));let x;l.action&&(g||(g=new N),x=this._commands.toInternal(l.action,g));const C=l.insertText;return{insertText:typeof C=="string"?C:{snippet:C.value},filterText:l.filterText,range:l.range?$.from(l.range):void 0,showRange:this._isAdditionsProposedApiEnabled&&l.showRange?$.from(l.showRange):void 0,command:_,action:x,idx:f,completeBracketPairs:this._isAdditionsProposedApiEnabled?l.completeBracketPairs:!1,isInlineEdit:this._isAdditionsProposedApiEnabled?l.isInlineEdit:!1,showInlineEditMenu:this._isAdditionsProposedApiEnabled?l.showInlineEditMenu:!1,displayLocation:l.displayLocation&&this._isAdditionsProposedApiEnabled?{range:$.from(l.displayLocation.range),label:l.displayLocation.label}:void 0,warning:l.warning&&this._isAdditionsProposedApiEnabled?{message:ce.from(l.warning.message),icon:l.warning.icon?Ug.fromThemeIcon(l.warning.icon):void 0}:void 0}}),commands:c.map(l=>(g||(g=new N),this._commands.toInternal(l,g))),suppressSuggestions:!1,enableForwardStability:h}}async provideInlineEditsForRange(e,t,i,s){if(!this._provider.provideInlineEditsForRange)return;b(this._extension,"inlineCompletionsAdditions");const r=this._documents.getDocument(e),n=$.to(t),o=await this._provider.provideInlineEditsForRange(r,n,{selectedCompletionInfo:i.selectedSuggestionInfo?{range:$.to(i.selectedSuggestionInfo.range),text:i.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[i.triggerKind],userPrompt:i.userPrompt,requestUuid:i.requestUuid},s);if(!o||s.isCancellationRequested)return;const d=Array.isArray(o)?o:o.items,c=this._isAdditionsProposedApiEnabled?Array.isArray(o)?[]:o.commands||[]:[],h=this._isAdditionsProposedApiEnabled&&!Array.isArray(o)?o.enableForwardStability:void 0;let g;return{pid:this._references.createReferenceId({dispose(){g?.dispose()},items:d}),items:d.map((l,f)=>{let _;l.command&&(g||(g=new N),_=this._commands.toInternal(l.command,g));let x;l.action&&(g||(g=new N),x=this._commands.toInternal(l.action,g));const C=l.insertText;return{insertText:typeof C=="string"?C:{snippet:C.value},filterText:l.filterText,range:l.range?$.from(l.range):void 0,command:_,action:x,idx:f,completeBracketPairs:this._isAdditionsProposedApiEnabled?l.completeBracketPairs:!1}}),commands:c.map(l=>(g||(g=new N),this._commands.toInternal(l,g))),suppressSuggestions:!1,enableForwardStability:h}}disposeCompletions(e){this._references.disposeReferenceId(e)?.dispose()}handleDidShowCompletionItem(e,t,i){const s=this._references.get(e)?.items[t];s&&this._provider.handleDidShowCompletionItem&&this._isAdditionsProposedApiEnabled&&this._provider.handleDidShowCompletionItem(s,i)}handlePartialAccept(e,t,i,s){const r=this._references.get(e)?.items[t];r&&this._provider.handleDidPartiallyAcceptCompletionItem&&this._isAdditionsProposedApiEnabled&&(this._provider.handleDidPartiallyAcceptCompletionItem(r,i),this._provider.handleDidPartiallyAcceptCompletionItem(r,Wg.to(s)))}handleEndOfLifetime(e,t,i){const s=this._references.get(e)?.items[t];if(s&&this._provider.handleEndOfLifetime&&this._isAdditionsProposedApiEnabled){const r=Bg.to(i,n=>this._references.get(n.pid)?.items[n.idx]);this._provider.handleEndOfLifetime(s,r)}}handleRejection(e,t){const i=this._references.get(e)?.items[t];i&&this._provider.handleDidRejectCompletionItem&&this._isAdditionsProposedApiEnabled&&this._provider.handleDidRejectCompletionItem(i)}}class Yr{async provideInlineEdits(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideInlineEdit(s,{triggerKind:this.languageTriggerKindToVSCodeTriggerKind[t.triggerKind],requestUuid:t.requestUuid},i);if(!r||i.isCancellationRequested)return;let n;const o=this._references.createReferenceId({dispose(){n?.dispose()},item:r});let d;r.accepted&&(n||(n=new N),d=this._commands.toInternal(r.accepted,n));let c;r.rejected&&(n||(n=new N),c=this._commands.toInternal(r.rejected,n));let h;r.shown&&(n||(n=new N),h=this._commands.toInternal(r.shown,n));let g;return r.action&&(n||(n=new N),g=this._commands.toInternal(r.action,n)),n||(n=new N),{pid:o,text:r.text,range:$.from(r.range),showRange:$.from(r.showRange),accepted:d,rejected:c,shown:h,action:g,commands:r.commands?.map(l=>this._commands.toInternal(l,n))}}disposeEdit(e){this._references.disposeReferenceId(e)?.dispose()}constructor(e,t,i,s){this._documents=t,this._provider=i,this._commands=s,this._references=new oh,this.languageTriggerKindToVSCodeTriggerKind={[Dd.Automatic]:Jn.Automatic,[Dd.Invoke]:Jn.Invoke}}}class oh{constructor(){this._references=new Map,this._idPool=1}createReferenceId(e){const t=this._idPool++;return this._references.set(t,e),t}disposeReferenceId(e){const t=this._references.get(e);return this._references.delete(e),t}get(e){return this._references.get(e)}}class Zr{constructor(e,t){this._documents=e,this._provider=t,this._cache=new He("SignatureHelp")}async provideSignatureHelp(e,t,i,s){const r=this._documents.getDocument(e),n=Z.to(t),o=this.reviveContext(i),d=await this._provider.provideSignatureHelp(r,n,s,o);if(d){const c=this._cache.add([d]);return{...Rn.from(d),id:c}}}reviveContext(e){let t;if(e.activeSignatureHelp){const i=Rn.to(e.activeSignatureHelp),s=this._cache.get(e.activeSignatureHelp.id,0);s?(t=s,t.activeSignature=i.activeSignature,t.activeParameter=i.activeParameter):t=i}return{...e,activeSignatureHelp:t}}releaseSignatureHelp(e){this._cache.delete(e)}}class ws{constructor(e,t,i,s,r){this._documents=e,this._commands=t,this._provider=i,this._logService=s,this._extension=r,this._cache=new He("InlayHints"),this._disposables=new Map}async provideInlayHints(e,t,i){const s=this._documents.getDocument(e),r=$.to(t),n=await this._provider.provideInlayHints(s,r,i);if(!Array.isArray(n)||n.length===0){this._logService.trace(`[InlayHints] NO inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`);return}if(i.isCancellationRequested)return;const o=this._cache.add(n);this._disposables.set(o,new N);const d={hints:[],cacheId:o};for(let c=0;c<n.length;c++)this._isValidInlayHint(n[c],r)&&d.hints.push(this._convertInlayHint(n[c],[o,c]));return this._logService.trace(`[InlayHints] ${d.hints.length} inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`),d}async resolveInlayHint(e,t){if(typeof this._provider.resolveInlayHint!="function")return;const i=this._cache.get(...e);if(!i)return;const s=await this._provider.resolveInlayHint(i,t);if(s&&this._isValidInlayHint(s))return this._convertInlayHint(s,e)}releaseHints(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_isValidInlayHint(e,t){return e.label.length===0||Array.isArray(e.label)&&e.label.every(i=>i.value.length===0)?(console.log("INVALID inlay hint, empty label",e),!1):!(t&&!t.contains(e.position))}_convertInlayHint(e,t){const i=this._disposables.get(t[0]);if(!i)throw Error("DisposableStore is missing...");const s={label:"",cacheId:t,tooltip:ce.fromStrict(e.tooltip),position:Z.from(e.position),textEdits:e.textEdits&&e.textEdits.map(qe.from),kind:e.kind&&Vg.from(e.kind),paddingLeft:e.paddingLeft,paddingRight:e.paddingRight};if(typeof e.label=="string")s.label=e.label;else{const r=[];s.label=r;for(const n of e.label){if(!n.value){console.warn("INVALID inlay hint, empty label part",this._extension.identifier.value);continue}const o={label:n.value,tooltip:ce.fromStrict(n.tooltip)};li.isLocation(n.location)&&(o.location=tt.from(n.location)),n.command&&(o.command=this._commands.toInternal(n.command,i)),r.push(o)}}return s}}class xt{constructor(e,t){this._documents=e,this._provider=t,this._cache=new He("DocumentLink")}async provideLinks(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentLinks(i,t);if(!(!Array.isArray(s)||s.length===0)&&!t.isCancellationRequested){if(typeof this._provider.resolveDocumentLink!="function")return{links:s.filter(xt._validateLink).map(Bi.from)};{const r=this._cache.add(s),n={links:[],cacheId:r};for(let o=0;o<s.length;o++){if(!xt._validateLink(s[o]))continue;const d=Bi.from(s[o]);d.cacheId=[r,o],n.links.push(d)}return n}}}static _validateLink(e){return e.target&&e.target.path.length>5e4?(console.warn("DROPPING link because it is too long"),!1):!0}async resolveLink(e,t){if(typeof this._provider.resolveDocumentLink!="function")return;const i=this._cache.get(...e);if(!i)return;const s=await this._provider.resolveDocumentLink(i,t);if(!(!s||!xt._validateLink(s)))return Bi.from(s)}releaseLinks(e){this._cache.delete(e)}}class en{constructor(e,t){this._documents=e,this._provider=t}async provideColors(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentColors(i,t);return Array.isArray(s)?s.map(n=>({color:sr.from(n.color),range:$.from(n.range)})):[]}async provideColorPresentations(e,t,i){const s=this._documents.getDocument(e),r=$.to(t.range),n=sr.to(t.color),o=await this._provider.provideColorPresentations(n,{document:s,range:r},i);if(Array.isArray(o))return o.map(Jl.from)}}class Wc{constructor(e,t){this._documents=e,this._provider=t}async provideFoldingRanges(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideFoldingRanges(s,t,i);if(Array.isArray(r))return r.map(Xl.from)}}class Bc{constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideSelectionRanges(e,t,i){const s=this._documents.getDocument(e),r=t.map(Z.to),n=await this._provider.provideSelectionRanges(s,r,i);if(!is(n))return[];if(n.length!==r.length)return this._logService.warn("BAD selection ranges, provider must return ranges for each position"),[];const o=[];for(let d=0;d<r.length;d++){const c=[];o.push(c);let h=r[d],g=n[d];for(;;){if(!g.range.contains(h))throw new Error("INVALID selection range, must contain the previous range");if(c.push(zg.from(g)),!g.parent)break;h=g.range,g=g.parent}}return o}}class Di{constructor(e,t){this._documents=e,this._provider=t,this._idPool=new ca(""),this._cache=new Map}async prepareSession(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.prepareCallHierarchy(s,r,i);if(!n)return;const o=this._idPool.nextId();return this._cache.set(o,new Map),Array.isArray(n)?n.map(d=>this._cacheAndConvertItem(o,d)):[this._cacheAndConvertItem(o,n)]}async provideCallsTo(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing call hierarchy item");const r=await this._provider.provideCallHierarchyIncomingCalls(s,i);if(r)return r.map(n=>({from:this._cacheAndConvertItem(e,n.from),fromRanges:n.fromRanges.map(o=>$.from(o))}))}async provideCallsFrom(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing call hierarchy item");const r=await this._provider.provideCallHierarchyOutgoingCalls(s,i);if(r)return r.map(n=>({to:this._cacheAndConvertItem(e,n.to),fromRanges:n.fromRanges.map(o=>$.from(o))}))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const i=this._cache.get(e),s=_a.from(t,e,i.size.toString(36));return i.set(s._itemId,t),s}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class Pi{constructor(e,t){this._documents=e,this._provider=t,this._idPool=new ca(""),this._cache=new Map}async prepareSession(e,t,i){const s=this._documents.getDocument(e),r=Z.to(t),n=await this._provider.prepareTypeHierarchy(s,r,i);if(!n)return;const o=this._idPool.nextId();return this._cache.set(o,new Map),Array.isArray(n)?n.map(d=>this._cacheAndConvertItem(o,d)):[this._cacheAndConvertItem(o,n)]}async provideSupertypes(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing type hierarchy item");const r=await this._provider.provideTypeHierarchySupertypes(s,i);if(r)return r.map(n=>this._cacheAndConvertItem(e,n))}async provideSubtypes(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing type hierarchy item");const r=await this._provider.provideTypeHierarchySubtypes(s,i);if(r)return r.map(n=>this._cacheAndConvertItem(e,n))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const i=this._cache.get(e),s=Ni.from(t,e,i.size.toString(36));return i.set(s._itemId,t),s}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class xs{constructor(e,t,i,s,r){this._proxy=e,this._documents=t,this._provider=i,this._handle=s,this._extension=r,this._cache=new He("DocumentDropEdit")}async provideDocumentOnDropEdits(e,t,i,s,r){const n=this._documents.getDocument(t),o=Z.to(i),d=nr.toDataTransfer(s,async m=>(await this._proxy.$resolveDocumentOnDropFileData(this._handle,e,m)).buffer),c=await this._provider.provideDocumentDropEdits(n,o,d,r);if(!c)return;const h=je(c),g=this._cache.add(h);return h.map((m,l)=>({_cacheId:[g,l],title:m.title??J(2559,"Drop using '{0}' extension",this._extension.displayName||this._extension.name),kind:m.kind?.value,yieldTo:m.yieldTo?.map(f=>f.value),insertText:typeof m.insertText=="string"?m.insertText:{snippet:m.insertText.value},additionalEdit:m.additionalEdit?Le.from(m.additionalEdit,void 0):void 0}))}async resolveDropEdit(e,t){const[i,s]=e,r=this._cache.get(i,s);if(!r||!this._provider.resolveDocumentDropEdit)return{};const n=await this._provider.resolveDocumentDropEdit(r,t)??r;return{additionalEdit:n.additionalEdit?Le.from(n.additionalEdit,void 0):void 0}}releaseDropEdits(e){this._cache.delete(e)}}class Ti{constructor(e,t){this.adapter=e,this.extension=t}}class fe{static{this._handlePool=0}constructor(e,t,i,s,r,n,o,d){this._uriTransformer=t,this._documents=i,this._commands=s,this._diagnostics=r,this._logService=n,this._apiDeprecation=o,this._extensionTelemetry=d,this._adapter=new Map,this._proxy=e.getProxy(k.MainThreadLanguageFeatures)}_transformDocumentSelector(e,t){return wr.from(e,this._uriTransformer,t)}_createDisposable(e){return new V(()=>{this._adapter.delete(e),this._proxy.$unregister(e)})}_nextHandle(){return fe._handlePool++}async _withAdapter(e,t,i,s,r,n=!1){const o=this._adapter.get(e);if(!o||!(o.adapter instanceof t))return s;const d=Date.now();n||this._logService.trace(`[${o.extension.identifier.value}] INVOKE provider '${i.toString().replace(/[\r\n]/g,"")}'`);const c=i(o.adapter,o.extension);return Promise.resolve(c).catch(h=>{Qi(h)||(this._logService.error(`[${o.extension.identifier.value}] provider FAILED`),this._logService.error(h),this._extensionTelemetry.onExtensionError(o.extension.identifier,h))}).finally(()=>{n||this._logService.trace(`[${o.extension.identifier.value}] provider DONE after ${Date.now()-d}ms`)}),ue.isCancellationToken(r)?hl(c,r):c}_addNewAdapter(e,t){const i=this._nextHandle();return this._adapter.set(i,new Ti(e,t)),i}static _extLabel(e){return e.displayName||e.name}static _extId(e){return e.identifier.value}registerDocumentSymbolProvider(e,t,i,s){const r=this._addNewAdapter(new gr(this._documents,i),e),n=s&&s.label||fe._extLabel(e);return this._proxy.$registerDocumentSymbolProvider(r,this._transformDocumentSelector(t,e),n),this._createDisposable(r)}$provideDocumentSymbols(e,t,i){return this._withAdapter(e,gr,s=>s.provideDocumentSymbols(v.revive(t),i),void 0,i)}registerCodeLensProvider(e,t,i){const s=this._nextHandle(),r=typeof i.onDidChangeCodeLenses=="function"?this._nextHandle():void 0;this._adapter.set(s,new Ti(new vs(this._documents,this._commands.converter,i,e,this._extensionTelemetry,this._logService),e)),this._proxy.$registerCodeLensSupport(s,this._transformDocumentSelector(t,e),r);let n=this._createDisposable(s);if(r!==void 0){const o=i.onDidChangeCodeLenses(d=>this._proxy.$emitCodeLensEvent(r));n=V.from(n,o)}return n}$provideCodeLenses(e,t,i){return this._withAdapter(e,vs,s=>s.provideCodeLenses(v.revive(t),i),void 0,i,t.scheme==="output")}$resolveCodeLens(e,t,i){return this._withAdapter(e,vs,s=>s.resolveCodeLens(t,i),void 0,void 0,!0)}$releaseCodeLenses(e,t){this._withAdapter(e,vs,i=>Promise.resolve(i.releaseCodeLenses(t)),void 0,void 0,!0)}registerDefinitionProvider(e,t,i){const s=this._addNewAdapter(new Tc(this._documents,i),e);return this._proxy.$registerDefinitionSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDefinition(e,t,i,s){return this._withAdapter(e,Tc,r=>r.provideDefinition(v.revive(t),i,s),[],s)}registerDeclarationProvider(e,t,i){const s=this._addNewAdapter(new kc(this._documents,i),e);return this._proxy.$registerDeclarationSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDeclaration(e,t,i,s){return this._withAdapter(e,kc,r=>r.provideDeclaration(v.revive(t),i,s),[],s)}registerImplementationProvider(e,t,i){const s=this._addNewAdapter(new Ic(this._documents,i),e);return this._proxy.$registerImplementationSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideImplementation(e,t,i,s){return this._withAdapter(e,Ic,r=>r.provideImplementation(v.revive(t),i,s),[],s)}registerTypeDefinitionProvider(e,t,i){const s=this._addNewAdapter(new Rc(this._documents,i),e);return this._proxy.$registerTypeDefinitionSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideTypeDefinition(e,t,i,s){return this._withAdapter(e,Rc,r=>r.provideTypeDefinition(v.revive(t),i,s),[],s)}registerHoverProvider(e,t,i,s){const r=this._addNewAdapter(new Ki(this._documents,i),e);return this._proxy.$registerHoverProvider(r,this._transformDocumentSelector(t,e)),this._createDisposable(r)}$provideHover(e,t,i,s,r){return this._withAdapter(e,Ki,n=>n.provideHover(v.revive(t),i,s,r),void 0,r)}$releaseHover(e,t){this._withAdapter(e,Ki,i=>Promise.resolve(i.releaseHover(t)),void 0,void 0)}registerEvaluatableExpressionProvider(e,t,i,s){const r=this._addNewAdapter(new Ac(this._documents,i),e);return this._proxy.$registerEvaluatableExpressionProvider(r,this._transformDocumentSelector(t,e)),this._createDisposable(r)}$provideEvaluatableExpression(e,t,i,s){return this._withAdapter(e,Ac,r=>r.provideEvaluatableExpression(v.revive(t),i,s),void 0,s)}registerInlineValuesProvider(e,t,i,s){const r=typeof i.onDidChangeInlineValues=="function"?this._nextHandle():void 0,n=this._addNewAdapter(new $c(this._documents,i),e);this._proxy.$registerInlineValuesProvider(n,this._transformDocumentSelector(t,e),r);let o=this._createDisposable(n);if(r!==void 0){const d=i.onDidChangeInlineValues(c=>this._proxy.$emitInlineValuesEvent(r));o=V.from(o,d)}return o}$provideInlineValues(e,t,i,s,r){return this._withAdapter(e,$c,n=>n.provideInlineValues(v.revive(t),i,s,r),void 0,r)}registerDocumentHighlightProvider(e,t,i){const s=this._addNewAdapter(new Mc(this._documents,i),e);return this._proxy.$registerDocumentHighlightProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}registerMultiDocumentHighlightProvider(e,t,i){const s=this._addNewAdapter(new Hc(this._documents,i,this._logService),e);return this._proxy.$registerMultiDocumentHighlightProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDocumentHighlights(e,t,i,s){return this._withAdapter(e,Mc,r=>r.provideDocumentHighlights(v.revive(t),i,s),void 0,s)}$provideMultiDocumentHighlights(e,t,i,s,r){return this._withAdapter(e,Hc,n=>n.provideMultiDocumentHighlights(v.revive(t),i,s.map(o=>v.revive(o)),r),void 0,r)}registerLinkedEditingRangeProvider(e,t,i){const s=this._addNewAdapter(new Fc(this._documents,i),e);return this._proxy.$registerLinkedEditingRangeProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideLinkedEditingRanges(e,t,i,s){return this._withAdapter(e,Fc,async r=>{const n=await r.provideLinkedEditingRanges(v.revive(t),i,s);if(n)return{ranges:n.ranges,wordPattern:n.wordPattern?fe._serializeRegExp(n.wordPattern):void 0}},void 0,s)}registerReferenceProvider(e,t,i){const s=this._addNewAdapter(new Lc(this._documents,i),e);return this._proxy.$registerReferenceSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideReferences(e,t,i,s,r){return this._withAdapter(e,Lc,n=>n.provideReferences(v.revive(t),i,s,r),void 0,r)}registerCodeActionProvider(e,t,i,s){const r=new N,n=this._addNewAdapter(new wt(this._documents,this._commands.converter,this._diagnostics,i,this._logService,e,this._apiDeprecation),e);return this._proxy.$registerCodeActionSupport(n,this._transformDocumentSelector(t,e),{providedKinds:s?.providedCodeActionKinds?.map(o=>o.value),documentation:s?.documentation?.map(o=>({kind:o.kind.value,command:this._commands.converter.toInternal(o.command,r)}))},fe._extLabel(e),fe._extId(e),!!i.resolveCodeAction),r.add(this._createDisposable(n)),r}$provideCodeActions(e,t,i,s,r){return this._withAdapter(e,wt,n=>n.provideCodeActions(v.revive(t),i,s,r),void 0,r)}$resolveCodeAction(e,t,i){return this._withAdapter(e,wt,s=>s.resolveCodeAction(t,i),{},void 0)}$releaseCodeActions(e,t){this._withAdapter(e,wt,i=>Promise.resolve(i.releaseCodeActions(t)),void 0,void 0)}registerDocumentFormattingEditProvider(e,t,i){const s=this._addNewAdapter(new Nc(this._documents,i),e);return this._proxy.$registerDocumentFormattingSupport(s,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name),this._createDisposable(s)}$provideDocumentFormattingEdits(e,t,i,s){return this._withAdapter(e,Nc,r=>r.provideDocumentFormattingEdits(v.revive(t),i,s),void 0,s)}registerDocumentRangeFormattingEditProvider(e,t,i){const s=typeof i.provideDocumentRangesFormattingEdits=="function",r=this._addNewAdapter(new Jr(this._documents,i),e);return this._proxy.$registerRangeFormattingSupport(r,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name,s),this._createDisposable(r)}$provideDocumentRangeFormattingEdits(e,t,i,s,r){return this._withAdapter(e,Jr,n=>n.provideDocumentRangeFormattingEdits(v.revive(t),i,s,r),void 0,r)}$provideDocumentRangesFormattingEdits(e,t,i,s,r){return this._withAdapter(e,Jr,n=>n.provideDocumentRangesFormattingEdits(v.revive(t),i,s,r),void 0,r)}registerOnTypeFormattingEditProvider(e,t,i,s){const r=this._addNewAdapter(new Oc(this._documents,i),e);return this._proxy.$registerOnTypeFormattingSupport(r,this._transformDocumentSelector(t,e),s,e.identifier),this._createDisposable(r)}$provideOnTypeFormattingEdits(e,t,i,s,r,n){return this._withAdapter(e,Oc,o=>o.provideOnTypeFormattingEdits(v.revive(t),i,s,r,n),void 0,n)}registerWorkspaceSymbolProvider(e,t){const i=this._addNewAdapter(new ys(t,this._logService),e);return this._proxy.$registerNavigateTypeSupport(i,typeof t.resolveWorkspaceSymbol=="function"),this._createDisposable(i)}$provideWorkspaceSymbols(e,t,i){return this._withAdapter(e,ys,s=>s.provideWorkspaceSymbols(t,i),{symbols:[]},i)}$resolveWorkspaceSymbol(e,t,i){return this._withAdapter(e,ys,s=>s.resolveWorkspaceSymbol(t,i),void 0,void 0)}$releaseWorkspaceSymbols(e,t){this._withAdapter(e,ys,i=>i.releaseWorkspaceSymbols(t),void 0,void 0)}registerRenameProvider(e,t,i){const s=this._addNewAdapter(new Mt(this._documents,i,this._logService),e);return this._proxy.$registerRenameSupport(s,this._transformDocumentSelector(t,e),Mt.supportsResolving(i)),this._createDisposable(s)}$provideRenameEdits(e,t,i,s,r){return this._withAdapter(e,Mt,n=>n.provideRenameEdits(v.revive(t),i,s,r),void 0,r)}$resolveRenameLocation(e,t,i,s){return this._withAdapter(e,Mt,r=>r.resolveRenameLocation(v.revive(t),i,s),void 0,s)}registerNewSymbolNamesProvider(e,t,i){const s=this._addNewAdapter(new oi(this._documents,i,this._logService),e);return this._proxy.$registerNewSymbolNamesProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$supportsAutomaticNewSymbolNamesTriggerKind(e){return this._withAdapter(e,oi,t=>t.supportsAutomaticNewSymbolNamesTriggerKind(),!1,void 0)}$provideNewSymbolNames(e,t,i,s,r){return this._withAdapter(e,oi,n=>n.provideNewSymbolNames(v.revive(t),i,s,r),void 0,r)}registerDocumentSemanticTokensProvider(e,t,i,s){const r=this._addNewAdapter(new Ie(this._documents,i),e),n=typeof i.onDidChangeSemanticTokens=="function"?this._nextHandle():void 0;this._proxy.$registerDocumentSemanticTokensProvider(r,this._transformDocumentSelector(t,e),s,n);let o=this._createDisposable(r);if(n){const d=i.onDidChangeSemanticTokens(c=>this._proxy.$emitDocumentSemanticTokensEvent(n));o=V.from(o,d)}return o}$provideDocumentSemanticTokens(e,t,i,s){return this._withAdapter(e,Ie,r=>r.provideDocumentSemanticTokens(v.revive(t),i,s),null,s)}$releaseDocumentSemanticTokens(e,t){this._withAdapter(e,Ie,i=>i.releaseDocumentSemanticColoring(t),void 0,void 0)}registerDocumentRangeSemanticTokensProvider(e,t,i,s){const r=this._addNewAdapter(new Uc(this._documents,i),e);return this._proxy.$registerDocumentRangeSemanticTokensProvider(r,this._transformDocumentSelector(t,e),s),this._createDisposable(r)}$provideDocumentRangeSemanticTokens(e,t,i,s){return this._withAdapter(e,Uc,r=>r.provideDocumentRangeSemanticTokens(v.revive(t),i,s),null,s)}registerCompletionItemProvider(e,t,i,s){const r=this._addNewAdapter(new It(this._documents,this._commands.converter,i,this._apiDeprecation,e),e);return this._proxy.$registerCompletionsProvider(r,this._transformDocumentSelector(t,e),s,It.supportsResolving(i),e.identifier),this._createDisposable(r)}$provideCompletionItems(e,t,i,s,r){return this._withAdapter(e,It,n=>n.provideCompletionItems(v.revive(t),i,s,r),void 0,r)}$resolveCompletionItem(e,t,i){return this._withAdapter(e,It,s=>s.resolveCompletionItem(t,i),void 0,i)}$releaseCompletionItems(e,t){this._withAdapter(e,It,i=>i.releaseCompletionItems(t),void 0,void 0)}registerInlineCompletionsProvider(e,t,i,s){const r=typeof i.onDidChange=="function"&&te(e,"inlineCompletionsAdditions")?this._nextHandle():void 0,n=new lt(e,this._documents,i,this._commands.converter),o=this._addNewAdapter(n,e);let d=this._createDisposable(o);if(r!==void 0){const c=i.onDidChange(h=>this._proxy.$emitInlineCompletionsChange(r));d=V.from(d,c)}return this._proxy.$registerInlineCompletionsSupport(o,this._transformDocumentSelector(t,e),n.supportsHandleEvents,ge.toKey(e.identifier.value),s?.yieldTo?.map(c=>ge.toKey(c))||[],s?.displayName,s?.debounceDelayMs,r),d}$provideInlineCompletions(e,t,i,s,r){return this._withAdapter(e,lt,n=>n.provideInlineCompletions(v.revive(t),i,s,r),void 0,r)}$provideInlineEditsForRange(e,t,i,s,r){return this._withAdapter(e,lt,n=>n.provideInlineEditsForRange(v.revive(t),i,s,r),void 0,r)}$handleInlineCompletionDidShow(e,t,i,s){this._withAdapter(e,lt,async r=>{r.handleDidShowCompletionItem(t,i,s)},void 0,void 0)}$handleInlineCompletionPartialAccept(e,t,i,s,r){this._withAdapter(e,lt,async n=>{n.handlePartialAccept(t,i,s,r)},void 0,void 0)}$handleInlineCompletionEndOfLifetime(e,t,i,s){this._withAdapter(e,lt,async r=>{r.handleEndOfLifetime(t,i,s)},void 0,void 0)}$handleInlineCompletionRejection(e,t,i){this._withAdapter(e,lt,async s=>{s.handleRejection(t,i)},void 0,void 0)}$freeInlineCompletionsList(e,t){this._withAdapter(e,lt,async i=>{i.disposeCompletions(t)},void 0,void 0)}registerInlineEditProvider(e,t,i){const s=new Yr(e,this._documents,i,this._commands.converter),r=this._addNewAdapter(s,e);return this._proxy.$registerInlineEditProvider(r,this._transformDocumentSelector(t,e),e.identifier,i.displayName||e.name),this._createDisposable(r)}$provideInlineEdit(e,t,i,s){return this._withAdapter(e,Yr,r=>r.provideInlineEdits(v.revive(t),i,s),void 0,s)}$freeInlineEdit(e,t){this._withAdapter(e,Yr,async i=>{i.disposeEdit(t)},void 0,void 0)}registerSignatureHelpProvider(e,t,i,s){const r=Array.isArray(s)?{triggerCharacters:s,retriggerCharacters:[]}:s,n=this._addNewAdapter(new Zr(this._documents,i),e);return this._proxy.$registerSignatureHelpProvider(n,this._transformDocumentSelector(t,e),r),this._createDisposable(n)}$provideSignatureHelp(e,t,i,s,r){return this._withAdapter(e,Zr,n=>n.provideSignatureHelp(v.revive(t),i,s,r),void 0,r)}$releaseSignatureHelp(e,t){this._withAdapter(e,Zr,i=>i.releaseSignatureHelp(t),void 0,void 0)}registerInlayHintsProvider(e,t,i){const s=typeof i.onDidChangeInlayHints=="function"?this._nextHandle():void 0,r=this._addNewAdapter(new ws(this._documents,this._commands.converter,i,this._logService,e),e);this._proxy.$registerInlayHintsProvider(r,this._transformDocumentSelector(t,e),typeof i.resolveInlayHint=="function",s,fe._extLabel(e));let n=this._createDisposable(r);if(s!==void 0){const o=i.onDidChangeInlayHints(d=>this._proxy.$emitInlayHintsEvent(s));n=V.from(n,o)}return n}$provideInlayHints(e,t,i,s){return this._withAdapter(e,ws,r=>r.provideInlayHints(v.revive(t),i,s),void 0,s)}$resolveInlayHint(e,t,i){return this._withAdapter(e,ws,s=>s.resolveInlayHint(t,i),void 0,i)}$releaseInlayHints(e,t){this._withAdapter(e,ws,i=>i.releaseHints(t),void 0,void 0)}registerDocumentLinkProvider(e,t,i){const s=this._addNewAdapter(new xt(this._documents,i),e);return this._proxy.$registerDocumentLinkProvider(s,this._transformDocumentSelector(t,e),typeof i.resolveDocumentLink=="function"),this._createDisposable(s)}$provideDocumentLinks(e,t,i){return this._withAdapter(e,xt,s=>s.provideLinks(v.revive(t),i),void 0,i,t.scheme==="output")}$resolveDocumentLink(e,t,i){return this._withAdapter(e,xt,s=>s.resolveLink(t,i),void 0,void 0,!0)}$releaseDocumentLinks(e,t){this._withAdapter(e,xt,i=>i.releaseLinks(t),void 0,void 0,!0)}registerColorProvider(e,t,i){const s=this._addNewAdapter(new en(this._documents,i),e);return this._proxy.$registerDocumentColorProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDocumentColors(e,t,i){return this._withAdapter(e,en,s=>s.provideColors(v.revive(t),i),[],i)}$provideColorPresentations(e,t,i,s){return this._withAdapter(e,en,r=>r.provideColorPresentations(v.revive(t),i,s),void 0,s)}registerFoldingRangeProvider(e,t,i){const s=this._nextHandle(),r=typeof i.onDidChangeFoldingRanges=="function"?this._nextHandle():void 0;this._adapter.set(s,new Ti(new Wc(this._documents,i),e)),this._proxy.$registerFoldingRangeProvider(s,this._transformDocumentSelector(t,e),e.identifier,r);let n=this._createDisposable(s);if(r!==void 0){const o=i.onDidChangeFoldingRanges(()=>this._proxy.$emitFoldingRangeEvent(r));n=V.from(n,o)}return n}$provideFoldingRanges(e,t,i,s){return this._withAdapter(e,Wc,r=>r.provideFoldingRanges(v.revive(t),i,s),void 0,s)}registerSelectionRangeProvider(e,t,i){const s=this._addNewAdapter(new Bc(this._documents,i,this._logService),e);return this._proxy.$registerSelectionRangeProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideSelectionRanges(e,t,i,s){return this._withAdapter(e,Bc,r=>r.provideSelectionRanges(v.revive(t),i,s),[],s)}registerCallHierarchyProvider(e,t,i){const s=this._addNewAdapter(new Di(this._documents,i),e);return this._proxy.$registerCallHierarchyProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$prepareCallHierarchy(e,t,i,s){return this._withAdapter(e,Di,r=>Promise.resolve(r.prepareSession(v.revive(t),i,s)),void 0,s)}$provideCallHierarchyIncomingCalls(e,t,i,s){return this._withAdapter(e,Di,r=>r.provideCallsTo(t,i,s),void 0,s)}$provideCallHierarchyOutgoingCalls(e,t,i,s){return this._withAdapter(e,Di,r=>r.provideCallsFrom(t,i,s),void 0,s)}$releaseCallHierarchy(e,t){this._withAdapter(e,Di,i=>Promise.resolve(i.releaseSession(t)),void 0,void 0)}registerTypeHierarchyProvider(e,t,i){const s=this._addNewAdapter(new Pi(this._documents,i),e);return this._proxy.$registerTypeHierarchyProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$prepareTypeHierarchy(e,t,i,s){return this._withAdapter(e,Pi,r=>Promise.resolve(r.prepareSession(v.revive(t),i,s)),void 0,s)}$provideTypeHierarchySupertypes(e,t,i,s){return this._withAdapter(e,Pi,r=>r.provideSupertypes(t,i,s),void 0,s)}$provideTypeHierarchySubtypes(e,t,i,s){return this._withAdapter(e,Pi,r=>r.provideSubtypes(t,i,s),void 0,s)}$releaseTypeHierarchy(e,t){this._withAdapter(e,Pi,i=>Promise.resolve(i.releaseSession(t)),void 0,void 0)}registerDocumentOnDropEditProvider(e,t,i,s){const r=this._nextHandle();return this._adapter.set(r,new Ti(new xs(this._proxy,this._documents,i,r,e),e)),this._proxy.$registerDocumentOnDropEditProvider(r,this._transformDocumentSelector(t,e),s?{supportsResolve:!!i.resolveDocumentDropEdit,dropMimeTypes:s.dropMimeTypes,providedDropKinds:s.providedDropEditKinds?.map(n=>n.value)}:void 0),this._createDisposable(r)}$provideDocumentOnDropEdits(e,t,i,s,r,n){return this._withAdapter(e,xs,o=>Promise.resolve(o.provideDocumentOnDropEdits(t,v.revive(i),s,r,n)),void 0,void 0)}$resolveDropEdit(e,t,i){return this._withAdapter(e,xs,s=>s.resolveDropEdit(t,i),{},void 0)}$releaseDocumentOnDropEdits(e,t){this._withAdapter(e,xs,i=>Promise.resolve(i.releaseDropEdits(t)),void 0,void 0)}registerDocumentPasteEditProvider(e,t,i,s){const r=this._nextHandle();return this._adapter.set(r,new Ti(new Ci(this._proxy,this._documents,i,r,e),e)),this._proxy.$registerPasteEditProvider(r,this._transformDocumentSelector(t,e),{supportsCopy:!!i.prepareDocumentPaste,supportsPaste:!!i.provideDocumentPasteEdits,supportsResolve:!!i.resolveDocumentPasteEdit,providedPasteEditKinds:s.providedPasteEditKinds?.map(n=>n.value),copyMimeTypes:s.copyMimeTypes,pasteMimeTypes:s.pasteMimeTypes}),this._createDisposable(r)}$prepareDocumentPaste(e,t,i,s,r){return this._withAdapter(e,Ci,n=>n.prepareDocumentPaste(v.revive(t),i,s,r),void 0,r)}$providePasteEdits(e,t,i,s,r,n,o){return this._withAdapter(e,Ci,d=>d.providePasteEdits(t,v.revive(i),s,r,n,o),void 0,o)}$resolvePasteEdit(e,t,i){return this._withAdapter(e,Ci,s=>s.resolvePasteEdit(t,i),{},void 0)}$releasePasteEdits(e,t){this._withAdapter(e,Ci,i=>Promise.resolve(i.releasePasteEdits(t)),void 0,void 0)}static _serializeRegExp(e){return{pattern:e.source,flags:e.flags}}static _serializeIndentationRule(e){return{decreaseIndentPattern:fe._serializeRegExp(e.decreaseIndentPattern),increaseIndentPattern:fe._serializeRegExp(e.increaseIndentPattern),indentNextLinePattern:e.indentNextLinePattern?fe._serializeRegExp(e.indentNextLinePattern):void 0,unIndentedLinePattern:e.unIndentedLinePattern?fe._serializeRegExp(e.unIndentedLinePattern):void 0}}static _serializeOnEnterRule(e){return{beforeText:fe._serializeRegExp(e.beforeText),afterText:e.afterText?fe._serializeRegExp(e.afterText):void 0,previousLineText:e.previousLineText?fe._serializeRegExp(e.previousLineText):void 0,action:e.action}}static _serializeOnEnterRules(e){return e.map(fe._serializeOnEnterRule)}static _serializeAutoClosingPair(e){return{open:e.open,close:e.close,notIn:e.notIn?e.notIn.map(t=>vu.toString(t)):void 0}}static _serializeAutoClosingPairs(e){return e.map(fe._serializeAutoClosingPair)}setLanguageConfiguration(e,t,i){const{wordPattern:s}=i;if(s&&al(s))throw new Error(`Invalid language configuration: wordPattern '${s}' is not allowed to match the empty string.`);s?this._documents.setWordDefinitionFor(t,s):this._documents.setWordDefinitionFor(t,void 0),i.__electricCharacterSupport&&this._apiDeprecation.report("LanguageConfiguration.__electricCharacterSupport",e,"Do not use."),i.__characterPairSupport&&this._apiDeprecation.report("LanguageConfiguration.__characterPairSupport",e,"Do not use.");const r=this._nextHandle(),n={comments:i.comments,brackets:i.brackets,wordPattern:i.wordPattern?fe._serializeRegExp(i.wordPattern):void 0,indentationRules:i.indentationRules?fe._serializeIndentationRule(i.indentationRules):void 0,onEnterRules:i.onEnterRules?fe._serializeOnEnterRules(i.onEnterRules):void 0,__electricCharacterSupport:i.__electricCharacterSupport,__characterPairSupport:i.__characterPairSupport,autoClosingPairs:i.autoClosingPairs?fe._serializeAutoClosingPairs(i.autoClosingPairs):void 0};return this._proxy.$setLanguageConfiguration(r,t,n),this._createDisposable(r)}$setWordDefinitions(e){for(const t of e)this._documents.setWordDefinitionFor(t.languageId,new RegExp(t.regexSource,t.regexFlags))}}const Vc="vscode_editFile",qo="vscode_editFile_internal",zc={id:qo,displayName:"",modelDescription:"",source:{type:"internal"}};let jo=class{constructor(e,t,i){this.chatService=e,this.codeMapperService=t,this.notebookService=i}async invoke(e,t,i,s){if(!e.context)throw new Error("toolInvocationToken is required for this tool");const r=e.parameters,n=v.revive(r.uri),o=Qg.parse(n)?.notebook||n,d=this.chatService.getSession(e.context?.sessionId),c=d.getRequests().at(-1);c.response?.response.getMarkdown().length&&d.acceptResponseProgress(c,{kind:"undoStop",id:it()}),d.acceptResponseProgress(c,{kind:"markdownContent",content:new Pd("\n````\n")}),d.acceptResponseProgress(c,{kind:"codeblockUri",uri:o,isEdit:!0}),d.acceptResponseProgress(c,{kind:"markdownContent",content:new Pd("\n````\n")}),this.notebookService.hasSupportedNotebooks(o)&&this.notebookService.getNotebookTextModel(o)?d.acceptResponseProgress(c,{kind:"notebookEdit",edits:[],uri:o}):d.acceptResponseProgress(c,{kind:"textEdit",edits:[],uri:o});const h=d.editingSession;if(!h)throw new Error("This tool must be called from within an editing session");const g=await this.codeMapperService.mapCode({codeBlocks:[{code:r.code,resource:o,markdownBeforeBlock:r.explanation}],location:"tool",chatRequestId:e.chatRequestId,chatRequestModel:e.modelId,chatSessionId:e.context.sessionId},{textEdit:(l,f)=>{d.acceptResponseProgress(c,{kind:"textEdit",uri:l,edits:f})},notebookEdit(l,f){d.acceptResponseProgress(c,{kind:"notebookEdit",uri:l,edits:f})}},s);if(this.notebookService.hasSupportedNotebooks(o)&&this.notebookService.getNotebookTextModel(o)?d.acceptResponseProgress(c,{kind:"notebookEdit",uri:o,edits:[],done:!0}):d.acceptResponseProgress(c,{kind:"textEdit",uri:o,edits:[],done:!0}),g?.errorMessage)throw new Error(g.errorMessage);let m;return await new Promise(l=>{let f=!1;m=dp(_=>{const C=h.entries.read(_)?.find(S=>S.modifiedURI.toString()===o.toString());C&&(C.isCurrentlyBeingModifiedBy.read(_)?f=!0:f&&l(!0))})}).finally(()=>{m.dispose()}),{content:[{kind:"text",value:"The file was edited successfully"}]}}async prepareToolInvocation(e,t){return{presentation:"hidden"}}};jo=L([E(0,jg),E(1,Kg),E(2,Gg)],jo);let qc=class extends X{static{this.ID="chat.builtinTools"}constructor(e,t){super();const i=t.createInstance(jo);this._register(e.registerToolData(zc)),this._register(e.registerToolImplementation(zc.id,i))}};qc=L([E(0,Jg),E(1,ha)],qc);const jw="vscode_fetchWebPage_internal",Kw="vscode_searchExtensions_internal";rs.fromId(cp.extensions.id),J(6799,"Search Extensions"),J(6800,"This is a tool for browsing Visual Studio Code Extensions Marketplace. It allows the model to search for extensions and retrieve detailed information about them. The model should use this tool whenever it needs to discover extensions or resolve information about known ones. To use the tool, the model has to provide the category of the extensions, relevant search keywords, or known extension IDs. Note that search results may include false positives, so reviewing and filtering is recommended.");let jc=class{constructor(e){this.extensionWorkbenchService=e}async invoke(e,t,i,s){const r=e.parameters;if(!r.keywords?.length&&!r.category&&!r.ids?.length)return{content:[{kind:"text",value:J(6801,"Please provide a category or keywords or ids to search for.")}]};const n=new Map,o=h=>{for(const g of h)g.deprecationInfo||g.isMalicious||n.set(g.identifier.id.toLowerCase(),{id:g.identifier.id,name:g.displayName,description:g.description,installed:g.state===Yg.Installed,installCount:g.installCount??0,rating:g.rating??0,categories:g.categories??[],tags:g.gallery?.tags??[]})},d=async h=>{const g=await this.extensionWorkbenchService.queryGallery({text:h,pageSize:10,sortBy:lp.InstallCount},s);g.firstPage.length&&o(g.firstPage)};if(r.ids?.length){const h=await this.extensionWorkbenchService.getExtensions(r.ids.map(g=>({id:g})),s);o(h)}if(r.keywords?.length)for(const h of r.keywords??[])if(h==="featured")await d("featured");else{let g=r.category?`category:"${r.category}"`:"";g=h?`${g} ${h}`.trim():g,await d(g)}else await d(`category:"${r.category}"`);const c=Array.from(n.values());return{content:[{kind:"text",value:`Here are the list of extensions:
${JSON.stringify(c)}
. Important: Use the following format to display extensions to the user because there is a renderer available to parse these extensions in this format and display them with all details. So, do not describe about the extensions to the user.
\`\`\`vscode-extensions
extensionId1,extensionId2
\`\`\`
.`}],toolResultDetails:{input:JSON.stringify(r),output:[{type:"text",value:JSON.stringify(c.map(h=>h.id))}]}}}};jc=L([E(0,Xg)],jc);class Kc{constructor(e){this._data=e}update(e){this._data=e}get data(){return this._data}get apiObject(){if(!this._apiObject){const e=this;this._apiObject=Object.freeze({get name(){return e._data.id},get description(){return e._data.modelDescription},get inputSchema(){return e._data.inputSchema},get tags(){return e._data.tags??[]}})}return this._apiObject}}class Gw{constructor(e,t){this._languageModels=t,this._registeredTools=new Map,this._tokenCountFuncs=new Map,this._allTools=new Map,this._proxy=e.getProxy(k.MainThreadLanguageModelTools),this._proxy.$getTools().then(i=>{for(const s of i)this._allTools.set(s.id,new Kc(ze(s)))})}async $countTokensForInvocation(e,t,i){const s=this._tokenCountFuncs.get(e);if(!s)throw new Error(`Tool invocation call ${e} not found`);return await s(t,i)}async invokeTool(e,t,i,s){const r=it();i.tokenizationOptions&&this._tokenCountFuncs.set(r,i.tokenizationOptions.countTokens);try{if(i.toolInvocationToken&&!Zg(i.toolInvocationToken))throw new Error("Invalid tool invocation token");if((t===qo||t===Vc)&&!te(e,"chatParticipantPrivate"))throw new Error(`Invalid tool: ${t}`);const n=await this._proxy.$invokeTool({toolId:t,callId:r,parameters:i.input,tokenBudget:i.tokenizationOptions?.tokenBudget,context:i.toolInvocationToken,chatRequestId:te(e,"chatParticipantPrivate")?i.chatRequestId:void 0,chatInteractionId:te(e,"chatParticipantPrivate")?i.chatInteractionId:void 0},s),o=n instanceof Ke?n.value:n;return Zd.to(ze(o))}finally{this._tokenCountFuncs.delete(r)}}$onDidChangeTools(e){const t=new Set(this._registeredTools.keys());for(const i of e){t.delete(i.id);const s=this._allTools.get(i.id);s?s.update(i):this._allTools.set(i.id,new Kc(ze(i)))}for(const i of t)this._allTools.delete(i)}getTools(e){return Array.from(this._allTools.values()).map(t=>t.apiObject).filter(t=>{switch(t.name){case qo:case Vc:case jw:case Kw:return te(e,"chatParticipantPrivate");default:return!0}})}async $invokeTool(e,t){const i=this._registeredTools.get(e.toolId);if(!i)throw new Error(`Unknown tool ${e.toolId}`);const s={input:e.parameters,toolInvocationToken:e.context};te(i.extension,"chatParticipantPrivate")&&(s.chatRequestId=e.chatRequestId,s.chatInteractionId=e.chatInteractionId,s.chatSessionId=e.context?.sessionId,e.toolSpecificData?.kind==="terminal"&&(s.terminalCommand=e.toolSpecificData.command)),te(i.extension,"chatParticipantAdditions")&&e.modelId&&(s.model=await this.getModel(e.modelId,i.extension)),e.tokenBudget!==void 0&&(s.tokenizationOptions={tokenBudget:e.tokenBudget,countTokens:this._tokenCountFuncs.get(e.callId)||((o,d=ue.None)=>this._proxy.$countTokensForInvocation(e.callId,o,d))});let r;te(i.extension,"toolProgress")&&(r={report:o=>{this._proxy.$acceptToolProgress(e.callId,{message:ce.fromStrict(o.message),increment:o.increment,total:100})}});const n=await pl(Promise.resolve(i.tool.invoke(s,t,r)),t);if(!n)throw new ua;return Zd.from(n,i.extension)}async getModel(e,t){let i;if(e&&(i=await this._languageModels.getLanguageModelByIdentifier(t,e)),!i&&(i=await this._languageModels.getDefaultLanguageModel(t),!i))throw new Error("Language model unavailable");return i}async $prepareToolInvocation(e,t,i){const s=this._registeredTools.get(e);if(!s)throw new Error(`Unknown tool ${e}`);const r={input:t};if(te(s.extension,"chatParticipantPrivate")&&s.tool.prepareInvocation2){const n=await s.tool.prepareInvocation2(r,i);return n?{confirmationMessages:n.confirmationMessages?{title:n.confirmationMessages.title,message:typeof n.confirmationMessages.message=="string"?n.confirmationMessages.message:ce.from(n.confirmationMessages.message)}:void 0,toolSpecificData:{kind:"terminal",language:n.language,command:n.command}}:void 0}else if(s.tool.prepareInvocation){const n=await s.tool.prepareInvocation(r,i);return n?((n.pastTenseMessage||n.presentation)&&b(s.extension,"chatParticipantPrivate"),{confirmationMessages:n.confirmationMessages?{title:n.confirmationMessages.title,message:typeof n.confirmationMessages.message=="string"?n.confirmationMessages.message:ce.from(n.confirmationMessages.message)}:void 0,invocationMessage:ce.fromStrict(n.invocationMessage),pastTenseMessage:ce.fromStrict(n.pastTenseMessage),presentation:n.presentation}):void 0}}registerTool(e,t,i){return this._registeredTools.set(t,{extension:e,tool:i}),this._proxy.$registerTool(t),B(()=>{this._registeredTools.delete(t),this._proxy.$unregisterTool(t)})}}class Qw{constructor(e,t,i,s){this._documents=t,this._commands=i,this._uriTransformer=s,this._languageIds=[],this._handlePool=0,this._ids=new Set,this._proxy=e.getProxy(k.MainThreadLanguages)}$acceptLanguageIds(e){this._languageIds=e}async getLanguages(){return this._languageIds.slice(0)}async changeLanguage(e,t){await this._proxy.$changeLanguage(e,t);const i=this._documents.getDocumentData(e);if(!i)throw new Error(`document '${e.toString()}' NOT found`);return i.document}async tokenAtPosition(e,t){const i=e.version,s=Z.from(t),r=await this._proxy.$tokensAtPosition(e.uri,s),n={type:Eu.Other,range:e.getWordRangeAtPosition(t)??new de(t.line,t.character,t.line,t.character)};if(!r)return n;const o={range:$.to(r.range),type:em.to(r.type)};return!o.range.contains(t)||i!==e.version?n:o}createLanguageStatusItem(e,t,i){const s=this._handlePool++,r=this._proxy,n=this._ids,o=`${e.identifier.value}/${t}`;if(n.has(o))throw new Error(`LanguageStatusItem with id '${t}' ALREADY exists`);n.add(o);const d={selector:i,id:t,name:e.displayName??e.name,severity:Ms.Information,command:void 0,text:"",detail:"",busy:!1};let c;const h=new N,g=()=>{if(c?.dispose(),!n.has(o)){console.warn(`LanguageStatusItem (${t}) from ${e.identifier.value} has been disposed and CANNOT be updated anymore`);return}c=up(()=>{h.clear(),this._proxy.$setLanguageStatus(s,{id:o,name:d.name??e.displayName??e.name,source:e.displayName??e.name,selector:wr.from(d.selector,this._uriTransformer),label:d.text,detail:d.detail??"",severity:d.severity===Ms.Error?Te.Error:d.severity===Ms.Warning?Te.Warning:Te.Info,command:d.command&&this._commands.toInternal(d.command,h),accessibilityInfo:d.accessibilityInformation,busy:d.busy})},0)},m={dispose(){h.dispose(),c?.dispose(),r.$removeLanguageStatus(s),n.delete(o)},get id(){return d.id},get name(){return d.name},set name(l){d.name=l,g()},get selector(){return d.selector},set selector(l){d.selector=l,g()},get text(){return d.text},set text(l){d.text=l,g()},set text2(l){b(e,"languageStatusText"),d.text=l,g()},get text2(){return b(e,"languageStatusText"),d.text},get detail(){return d.detail},set detail(l){d.detail=l,g()},get severity(){return d.severity},set severity(l){d.severity=l,g()},get accessibilityInformation(){return d.accessibilityInformation},set accessibilityInformation(l){d.accessibilityInformation=l,g()},get command(){return d.command},set command(l){d.command=l,g()},get busy(){return d.busy},set busy(l){d.busy=l,g()}};return g(),m}}function Jw(a){return a&&a.title}let Ko=class{constructor(e,t){this._logService=t,this._proxy=e.getProxy(k.MainThreadMessageService)}showMessage(e,t,i,s,r){const n={source:{identifier:e.identifier,label:e.displayName||e.name}};let o;typeof s=="string"||Jw(s)?o=[s,...r]:(n.modal=s?.modal,n.useCustom=s?.useCustom,n.detail=s?.detail,o=r),n.useCustom&&b(e,"resolvers");const d=[];let c=!1;for(let h=0;h<o.length;h++){const g=o[h];if(typeof g=="string")d.push({title:g,handle:h,isCloseAffordance:!1});else if(typeof g=="object"){const{title:m,isCloseAffordance:l}=g;d.push({title:m,isCloseAffordance:!!l,handle:h}),l&&(c?this._logService.warn(`[${e.identifier}] Only one message item can have 'isCloseAffordance':`,g):c=!0)}else this._logService.warn(`[${e.identifier}] Invalid message item:`,g)}return this._proxy.$showMessage(t,i,n,d).then(h=>{if(typeof h=="number")return o[h]})}};Ko=L([E(1,re)],Ko);class tn{constructor(e,t,i,s){this.start=e,this.deletedCount=t,this.deletedItems=i,this.items=s}asApiEvent(){return{range:new yr(this.start,this.start+this.deletedCount),addedCells:this.items.map(e=>e.apiCell),removedCells:this.deletedItems}}}class Go{static asModelAddData(e){return{EOL:e.eol,lines:e.source,languageId:e.language,uri:e.uri,isDirty:!1,versionId:1,encoding:"utf8"}}constructor(e,t,i){this.notebook=e,this._extHostDocument=t,this._cellData=i,this.handle=i.handle,this.uri=v.revive(i.uri),this.cellKind=i.cellKind,this._outputs=i.outputs.map(or.to),this._internalMetadata=i.internalMetadata??{},this._metadata=Object.freeze(i.metadata??{}),this._previousResult=Object.freeze(ec.to(i.internalMetadata??{}))}get internalMetadata(){return this._internalMetadata}get apiCell(){if(!this._apiCell){const e=this,t=this._extHostDocument.getDocument(this.uri);if(!t)throw new Error(`MISSING extHostDocument for notebook cell: ${this.uri}`);const i={get index(){return e.notebook.getCellIndex(e)},notebook:e.notebook.apiNotebook,kind:tm.to(this._cellData.cellKind),document:t.document,get mime(){return e._mime},set mime(s){e._mime=s},get outputs(){return e._outputs.slice(0)},get metadata(){return e._metadata},get executionSummary(){return e._previousResult}};this._apiCell=Object.freeze(i)}return this._apiCell}setOutputs(e){this._outputs=e.map(or.to)}setOutputItems(e,t,i){const s=i.map(Su.to),r=this._outputs.find(n=>n.id===e);if(r&&(t||(r.items.length=0),r.items.push(...s),r.items.length>1&&r.items.every(n=>im(n.mime)))){const n=new Map,o=[];r.items.forEach(d=>{let c;n.has(d.mime)?c=n.get(d.mime):(c=[],n.set(d.mime,c),o.push(d.mime)),c.push(d.data)}),r.items.length=0,o.forEach(d=>{const c=sm(n.get(d));r.items.push({mime:d,data:c.data.buffer})})}}setMetadata(e){this._metadata=Object.freeze(e)}setInternalMetadata(e){this._internalMetadata=e,this._previousResult=Object.freeze(ec.to(e))}setMime(e){}}class za{static{this._handlePool=0}constructor(e,t,i,s,r){this._proxy=e,this._textDocumentsAndEditors=t,this._textDocuments=i,this.uri=s,this.handle=za._handlePool++,this._cells=[],this._versionId=0,this._isDirty=!1,this._disposed=!1,this._notebookType=r.viewType,this._metadata=Object.freeze(r.metadata??Object.create(null)),this._spliceNotebookCells([[0,0,r.cells]],!0,void 0),this._versionId=r.versionId}dispose(){this._disposed=!0}get versionId(){return this._versionId}get apiNotebook(){if(!this._notebook){const e=this,t={get uri(){return e.uri},get version(){return e._versionId},get notebookType(){return e._notebookType},get isDirty(){return e._isDirty},get isUntitled(){return e.uri.scheme===q.untitled},get isClosed(){return e._disposed},get metadata(){return e._metadata},get cellCount(){return e._cells.length},cellAt(i){return i=e._validateIndex(i),e._cells[i].apiCell},getCells(i){return(i?e._getCells(i):e._cells).map(r=>r.apiCell)},save(){return e._save()},[Symbol.for("debug.description")](){return`NotebookDocument(${this.uri.toString()})`}};this._notebook=Object.freeze(t)}return this._notebook}acceptDocumentPropertiesChanged(e){e.metadata&&(this._metadata=Object.freeze({...this._metadata,...e.metadata}))}acceptDirty(e){this._isDirty=e}acceptModelChanged(e,t,i){this._versionId=e.versionId,this._isDirty=t,this.acceptDocumentPropertiesChanged({metadata:i});const s={notebook:this.apiNotebook,metadata:i,cellChanges:[],contentChanges:[]},r=[];for(const o of e.rawEvents)o.kind===Ge.ModelChange?this._spliceNotebookCells(o.changes,!1,s.contentChanges):o.kind===Ge.Move?this._moveCells(o.index,o.length,o.newIdx,s.contentChanges):o.kind===Ge.Output?(this._setCellOutputs(o.index,o.outputs),r.push({cell:this._cells[o.index].apiCell,outputs:this._cells[o.index].apiCell.outputs})):o.kind===Ge.OutputItem?(this._setCellOutputItems(o.index,o.outputId,o.append,o.outputItems),r.push({cell:this._cells[o.index].apiCell,outputs:this._cells[o.index].apiCell.outputs})):o.kind===Ge.ChangeCellLanguage?(this._changeCellLanguage(o.index,o.language),r.push({cell:this._cells[o.index].apiCell,document:this._cells[o.index].apiCell.document})):o.kind===Ge.ChangeCellContent?r.push({cell:this._cells[o.index].apiCell,document:this._cells[o.index].apiCell.document}):o.kind===Ge.ChangeCellMime?this._changeCellMime(o.index,o.mime):o.kind===Ge.ChangeCellMetadata?(this._changeCellMetadata(o.index,o.metadata),r.push({cell:this._cells[o.index].apiCell,metadata:this._cells[o.index].apiCell.metadata})):o.kind===Ge.ChangeCellInternalMetadata&&(this._changeCellInternalMetadata(o.index,o.internalMetadata),r.push({cell:this._cells[o.index].apiCell,executionSummary:this._cells[o.index].apiCell.executionSummary}));const n=new Map;for(let o=0;o<r.length;o++){const d=r[o],c=n.get(d.cell);if(c===void 0){const h=s.cellChanges.push({document:void 0,executionSummary:void 0,metadata:void 0,outputs:void 0,...d});n.set(d.cell,h-1)}else s.cellChanges[c]={...s.cellChanges[c],...d}}return s}_validateIndex(e){return e=e|0,e<0?0:e>=this._cells.length?this._cells.length-1:e}_validateRange(e){let t=e.start|0,i=e.end|0;return t<0&&(t=0),i>this._cells.length&&(i=this._cells.length),e.with({start:t,end:i})}_getCells(e){e=this._validateRange(e);const t=[];for(let i=e.start;i<e.end;i++)t.push(this._cells[i]);return t}async _save(){return this._disposed?Promise.reject(new Error("Notebook has been closed")):this._proxy.$trySaveNotebook(this.uri)}_spliceNotebookCells(e,t,i){if(this._disposed)return;const s=[],r=[],n=[];if(e.reverse().forEach(o=>{const c=o[2].map(m=>{const l=new Go(this,this._textDocumentsAndEditors,m);return t||r.push(Go.asModelAddData(m)),l}),h=new tn(o[0],o[1],[],c),g=this._cells.splice(o[0],o[1],...c);for(const m of g)n.push(m.uri),h.deletedItems.push(m.apiCell);s.push(h)}),this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({addedDocuments:r,removedDocuments:n}),i)for(const o of s)i.push(o.asApiEvent())}_moveCells(e,t,i,s){const r=this._cells.splice(e,t);this._cells.splice(i,0,...r);const n=[new tn(e,t,r.map(o=>o.apiCell),[]),new tn(i,0,[],r)];for(const o of n)s.push(o.asApiEvent())}_setCellOutputs(e,t){this._cells[e].setOutputs(t)}_setCellOutputItems(e,t,i,s){this._cells[e].setOutputItems(t,i,s)}_changeCellLanguage(e,t){const i=this._cells[e];i.apiCell.document.languageId!==t&&this._textDocuments.$acceptModelLanguageChanged(i.uri,t)}_changeCellMime(e,t){const i=this._cells[e];i.apiCell.mime=t}_changeCellMetadata(e,t){this._cells[e].setMetadata(t)}_changeCellInternalMetadata(e,t){this._cells[e].setInternalMetadata(t)}getCellFromApiCell(e){return this._cells.find(t=>t.apiCell===e)}getCellFromIndex(e){return this._cells[e]}getCell(e){return this._cells.find(t=>t.handle===e)}getCellIndex(e){return this._cells.indexOf(e)}}class ts{static{this.apiEditorsToExtHost=new WeakMap}constructor(e,t,i,s,r,n,o){this.id=e,this._proxy=t,this.notebookData=i,this._visibleRanges=s,this._selections=r,this._viewColumn=n,this.viewType=o,this._visible=!1}get apiEditor(){if(!this._editor){const e=this;this._editor={get notebook(){return e.notebookData.apiNotebook},get selection(){return e._selections[0]},set selection(t){this.selections=[t]},get selections(){return e._selections},set selections(t){if(!Array.isArray(t)||!t.every(yr.isNotebookRange))throw zs("selections");e._selections=t,e._trySetSelections(t)},get visibleRanges(){return e._visibleRanges},revealRange(t,i){e._proxy.$tryRevealRange(e.id,bt.from(t),i??Cu.Default)},get viewColumn(){return e._viewColumn},get replOptions(){if(e.viewType==="repl")return{appendIndex:this.notebook.cellCount-1}},[Symbol.for("debug.description")](){return`NotebookEditor(${this.notebook.uri.toString()})`}},ts.apiEditorsToExtHost.set(this._editor,this)}return this._editor}get visible(){return this._visible}_acceptVisibility(e){this._visible=e}_acceptVisibleRanges(e){this._visibleRanges=e}_acceptSelections(e){this._selections=e}_trySetSelections(e){this._proxy.$trySetSelections(this.id,e.map(bt.from))}_acceptViewColumn(e){this._viewColumn=e}}class Xw extends X{constructor(e,t,i){super(),this._source=e,this._inputTextBuffer=t,this._outputs=i,this._outputTextBuffers=void 0}_getFullModelRange(e){const t=e.getLineCount();return new Ft(1,1,t,this._getLineMaxColumn(e,t))}_getLineMaxColumn(e,t){if(t<1||t>e.getLineCount())throw new Error("Illegal value for lineNumber");return e.getLineLength(t)+1}get inputTextBuffer(){if(!this._inputTextBuffer){const e=new Td;e.acceptChunk(this._source);const t=e.finish(!0),{textBuffer:i,disposable:s}=t.create(kd.LF);this._inputTextBuffer=i,this._register(s)}return this._inputTextBuffer}get outputTextBuffers(){return this._outputTextBuffers||(this._outputTextBuffers=this._outputs.map(e=>{const t=new Td;t.acceptChunk(e);const i=t.finish(!0),{textBuffer:s,disposable:r}=i.create(kd.LF);return this._register(r),s})),this._outputTextBuffers}findInInputs(e){const i=new Id(e,!1,!1,null).parseSearchRequest();if(!i)return[];const s=this._getFullModelRange(this.inputTextBuffer);return this.inputTextBuffer.findMatchesLineByLine(s,i,!0,5e3)}findInOutputs(e){const i=new Id(e,!1,!1,null).parseSearchRequest();return i?this.outputTextBuffers.map(s=>{const r=s.findMatchesLineByLine(this._getFullModelRange(s),i,!0,5e3);if(r.length!==0)return{textBuffer:s,matches:r}}).filter(s=>!!s):[]}}function Gc(a,e){let t=-1;const i=[];let s=[];return a.forEach(n=>{n.range.startLineNumber!==t&&s.length>0&&(i.push([...s]),s=[]),s.push(n),t=n.range.endLineNumber}),s.length>0&&i.push([...s]),i.map(n=>{const o=[],d=n[0].range.startLineNumber,c=n[n.length-1].range.endLineNumber;for(let h=d;h<=c;h++)o.push(e.getLineContent(h));return new rm(o.join(`
`)+`
`,n.map(h=>new Ft(h.range.startLineNumber-1,h.range.startColumn-1,h.range.endLineNumber-1,h.range.endColumn-1)))})}class ii{static{this._notebookStatusBarItemProviderHandlePool=0}get activeNotebookEditor(){return this._activeNotebookEditor?.apiEditor}get visibleNotebookEditors(){return this._visibleNotebookEditors.map(e=>e.apiEditor)}constructor(e,t,i,s,r,n,o){this._textDocumentsAndEditors=i,this._textDocuments=s,this._extHostFileSystem=r,this._extHostSearch=n,this._logService=o,this._notebookStatusBarItemProviders=new Map,this._documents=new Ye,this._editors=new Map,this._onDidChangeActiveNotebookEditor=new P,this.onDidChangeActiveNotebookEditor=this._onDidChangeActiveNotebookEditor.event,this._visibleNotebookEditors=[],this._onDidOpenNotebookDocument=new P,this.onDidOpenNotebookDocument=this._onDidOpenNotebookDocument.event,this._onDidCloseNotebookDocument=new P,this.onDidCloseNotebookDocument=this._onDidCloseNotebookDocument.event,this._onDidChangeVisibleNotebookEditors=new P,this.onDidChangeVisibleNotebookEditors=this._onDidChangeVisibleNotebookEditors.event,this._statusBarCache=new He("NotebookCellStatusBarCache"),this._handlePool=0,this._notebookSerializer=new Map,this._notebookProxy=e.getProxy(k.MainThreadNotebook),this._notebookDocumentsProxy=e.getProxy(k.MainThreadNotebookDocuments),this._notebookEditorsProxy=e.getProxy(k.MainThreadNotebookEditors),this._commandsConverter=t.converter,t.registerArgumentProcessor({processArgument:d=>{if(d&&d.$mid===xe.NotebookCellActionContext){const c=d.notebookEditor?.notebookUri,h=d.cell.handle,m=this._documents.get(c)?.getCell(h);if(m)return m.apiCell}if(d&&d.$mid===xe.NotebookActionContext){const c=d.uri,h=this._documents.get(c);if(h)return h.apiNotebook}return d}}),ii._registerApiCommands(t)}getEditorById(e){const t=this._editors.get(e);if(!t)throw new Error(`unknown text editor: ${e}. known editors: ${[...this._editors.keys()]} `);return t}getIdByEditor(e){for(const[t,i]of this._editors)if(i.apiEditor===e)return t}get notebookDocuments(){return[...this._documents.values()]}getNotebookDocument(e,t){const i=this._documents.get(e);if(!i&&!t)throw new Error(`NO notebook document for '${e}'`);return i}static _convertNotebookRegistrationData(e,t){if(!t)return;const i=t.filenamePattern.map(s=>su.from(s)).filter(s=>s!==void 0);if(t.filenamePattern&&!i){console.warn(`Notebook content provider view options file name pattern is invalid ${t.filenamePattern}`);return}return{extension:e.identifier,providerDisplayName:e.displayName||e.name,displayName:t.displayName,filenamePattern:i,priority:t.exclusive?nm.exclusive:void 0}}registerNotebookCellStatusBarItemProvider(e,t,i){const s=ii._notebookStatusBarItemProviderHandlePool++,r=typeof i.onDidChangeCellStatusBarItems=="function"?ii._notebookStatusBarItemProviderHandlePool++:void 0;this._notebookStatusBarItemProviders.set(s,i),this._notebookProxy.$registerNotebookCellStatusBarItemProvider(s,r,t);let n;return r!==void 0&&(n=i.onDidChangeCellStatusBarItems(o=>this._notebookProxy.$emitCellStatusBarEvent(r))),new V(()=>{this._notebookStatusBarItemProviders.delete(s),this._notebookProxy.$unregisterNotebookCellStatusBarItemProvider(s,r),n?.dispose()})}async createNotebookDocument(e){const t=await this._notebookDocumentsProxy.$tryCreateNotebook({viewType:e.viewType,content:e.content&&jt.from(e.content)});return v.revive(t)}async openNotebookDocument(e){const t=this._documents.get(e);if(t)return t.apiNotebook;const i=await this._notebookDocumentsProxy.$tryOpenNotebook(e),s=this._documents.get(v.revive(i));return js(s?.apiNotebook)}async showNotebookDocument(e,t){let i;typeof t=="object"?i={position:ye.from(t.viewColumn),preserveFocus:t.preserveFocus,selections:t.selections&&t.selections.map(bt.from),pinned:typeof t.preview=="boolean"?!t.preview:void 0,label:typeof t.asRepl=="string"?t.asRepl:typeof t.asRepl=="object"?t.asRepl.label:void 0}:i={preserveFocus:!1,pinned:!0};const s=t?.asRepl?"repl":e.notebookType,r=await this._notebookEditorsProxy.$tryShowNotebookDocument(e.uri,s,i),n=r&&this._editors.get(r)?.apiEditor;if(n)return n;throw r?new Error(`Could NOT open editor for "${e.uri.toString()}" because another editor opened in the meantime.`):new Error(`Could NOT open editor for "${e.uri.toString()}".`)}async $provideNotebookCellStatusBarItems(e,t,i,s){const r=this._notebookStatusBarItemProviders.get(e),n=v.revive(t),o=this._documents.get(n);if(!o||!r)return;const d=o.getCellFromIndex(i);if(!d)return;const c=await r.provideCellStatusBarItems(d.apiCell,s);if(!c)return;const h=new N,g=this._statusBarCache.add([h]),l=(Array.isArray(c)?c:[c]).map(f=>om.from(f,this._commandsConverter,h));return{cacheId:g,items:l}}$releaseNotebookCellStatusBarItems(e){this._statusBarCache.delete(e)}registerNotebookSerializer(e,t,i,s,r){if(pn(t))throw new Error("viewType cannot be empty or just whitespace");const n=this._handlePool++;return this._notebookSerializer.set(n,{viewType:t,serializer:i,options:s}),this._notebookProxy.$registerNotebookSerializer(n,{id:e.identifier,location:e.extensionLocation},t,am.from(s),ii._convertNotebookRegistrationData(e,r)),B(()=>{this._notebookProxy.$unregisterNotebookSerializer(n)})}async $dataToNotebook(e,t,i){const s=this._notebookSerializer.get(e);if(!s)throw new Error("NO serializer found");const r=await s.serializer.deserializeNotebook(t.buffer,i);return new Ke(jt.from(r))}async $notebookToData(e,t,i){const s=this._notebookSerializer.get(e);if(!s)throw new Error("NO serializer found");const r=await s.serializer.serializeNotebook(jt.to(t.value),i);return be.wrap(r)}async $saveNotebook(e,t,i,s,r){const n=v.revive(t),o=this._notebookSerializer.get(e);if(this.trace(`enter saveNotebook(versionId: ${i}, ${n.toString()})`),!o)throw new Error("NO serializer found");const d=this._documents.get(n);if(!d)throw new Error("Document NOT found");if(d.versionId!==i)throw new Error("Document version mismatch");if(!this._extHostFileSystem.value.isWritableFileSystem(n.scheme))throw new Rd(J(2564,"Unable to modify read-only file '{0}'",this._resourceForError(n)),Ad.FILE_PERMISSION_DENIED);const c={metadata:$d(d.apiNotebook.metadata,f=>!(o.options?.transientDocumentMetadata??{})[f]),cells:[]};for(const f of d.apiNotebook.getCells()){const _=new Du(f.kind,f.document.getText(),f.document.languageId,f.mime,o.options?.transientOutputs?[]:[...f.outputs],f.metadata,f.executionSummary);_.metadata=$d(f.metadata,x=>!(o.options?.transientCellMetadata??{})[x]),c.cells.push(_)}if(await this._validateWriteFile(n,s),r.isCancellationRequested)throw new Error("canceled");const h=await o.serializer.serializeNotebook(c,r);if(r.isCancellationRequested)throw new Error("canceled");this.trace(`serialized versionId: ${i} ${n.toString()}`),await this._extHostFileSystem.value.writeFile(n,h),this.trace(`Finished write versionId: ${i} ${n.toString()}`);const g=this._extHostFileSystem.getFileSystemProviderExtUri(n.scheme),m=await this._extHostFileSystem.value.stat(n),l={name:g.basename(n),isFile:(m.type&Hi.File)!==0,isDirectory:(m.type&Hi.Directory)!==0,isSymbolicLink:(m.type&Hi.SymbolicLink)!==0,mtime:m.mtime,ctime:m.ctime,size:m.size,readonly:!!((m.permissions??0)&Ws.Readonly)||!this._extHostFileSystem.value.isWritableFileSystem(n.scheme),locked:!!((m.permissions??0)&Ws.Locked),etag:Md({mtime:m.mtime,size:m.size}),children:void 0};return this.trace(`exit saveNotebook(versionId: ${i}, ${n.toString()})`),l}async $searchInNotebooks(e,t,i,s,r){const n=this._notebookSerializer.get(e)?.serializer;if(!n)return{limitHit:!1,results:[]};const o=new hp;await(async(m,l,f)=>{await Promise.all(m.map(async _=>await Promise.all(_.filenamePatterns.map(x=>{const C={_reason:f._reason,folderQueries:f.folderQueries,includePattern:f.includePattern,excludePattern:f.excludePattern,maxResults:f.maxResults,type:ql.File,filePattern:x};return this._extHostSearch.doInternalFileSearchWithCustomCallback(C,l,S=>{S.forEach(T=>{o.has(T)||s.some(I=>_.isFromSettings&&!I.isFromSettings?!1:I.filenamePatterns.some(K=>dm(K,T)))||o.add(T)})}).catch(S=>{if(S.code==="ENOENT")return console.warn("Could not find notebook search results, ignoring notebook results."),{limitHit:!1,messages:[]};throw S})}))))})(i,r,t);const c=new Ye;let h=!1;const g=Array.from(o).map(async m=>{const l=[];try{if(r.isCancellationRequested)return;if(t.maxResults&&[...c.values()].reduce((C,S)=>C+S.cellResults.length,0)>t.maxResults){h=!0;return}const f=[],_=this._documents.get(m);if(_)_.apiNotebook.getCells().forEach(S=>f.push({input:S.document.getText(),outputs:S.outputs.flatMap(T=>T.items.map(O=>O.data.toString()))}));else{const C=await this._extHostFileSystem.value.readFile(m),S=be.fromString(C.toString()),T=await n.deserializeNotebook(S.buffer,r);if(r.isCancellationRequested)return;jt.from(T).cells.forEach(I=>f.push({input:I.source,outputs:I.outputs.flatMap(K=>K.items.map(ie=>ie.valueBytes.toString()))}))}if(r.isCancellationRequested)return;f.forEach((C,S)=>{const T=t.contentPattern.pattern,O=new Xw(C.input,void 0,C.outputs),I=O.findInInputs(T),K=O.findInOutputs(T),ie=K.flatMap(W=>Gc(W.matches,W.textBuffer)).map((W,se)=>(W.webviewIndex=se,W));if(I.length>0||K.length>0){const W={index:S,contentResults:Gc(I,O.inputTextBuffer),webviewResults:ie};l.push(W)}});const x={resource:m,cellResults:l};c.set(m,x);return}catch{return}});return await Promise.all(g),{limitHit:h,results:[...c.values()]}}async _validateWriteFile(e,t){const i=await this._extHostFileSystem.value.stat(e);if(typeof t?.mtime=="number"&&typeof t.etag=="string"&&t.etag!==fp&&typeof i.mtime=="number"&&typeof i.size=="number"&&t.mtime<i.mtime&&t.etag!==Md({mtime:t.mtime,size:i.size}))throw new Rd(J(2565,"File Modified Since"),Ad.FILE_MODIFIED_SINCE,t)}_resourceForError(e){return e.scheme===q.file?e.fsPath:e.toString()}_createExtHostEditor(e,t,i){if(this._editors.has(t))throw new Error(`editor with id ALREADY EXSIST: ${t}`);const s=new ts(t,this._notebookEditorsProxy,e,i.visibleRanges.map(bt.to),i.selections.map(bt.to),typeof i.viewColumn=="number"?ye.to(i.viewColumn):void 0,i.viewType);this._editors.set(t,s)}$acceptDocumentAndEditorsDelta(e){if(e.value.removedDocuments)for(const t of e.value.removedDocuments){const i=v.revive(t),s=this._documents.get(i);s&&(s.dispose(),this._documents.delete(i),this._textDocumentsAndEditors.$acceptDocumentsAndEditorsDelta({removedDocuments:s.apiNotebook.getCells().map(r=>r.document.uri)}),this._onDidCloseNotebookDocument.fire(s.apiNotebook));for(const r of this._editors.values())r.notebookData.uri.toString()===i.toString()&&this._editors.delete(r.id)}if(e.value.addedDocuments){const t=[];for(const i of e.value.addedDocuments){const s=v.revive(i.uri);if(this._documents.has(s))throw new Error(`adding EXISTING notebook ${s} `);const r=new za(this._notebookDocumentsProxy,this._textDocumentsAndEditors,this._textDocuments,s,i);t.push(...i.cells.map(n=>Go.asModelAddData(n))),this._documents.get(s)?.dispose(),this._documents.set(s,r),this._textDocumentsAndEditors.$acceptDocumentsAndEditorsDelta({addedDocuments:t}),this._onDidOpenNotebookDocument.fire(r.apiNotebook)}}if(e.value.addedEditors)for(const t of e.value.addedEditors){if(this._editors.has(t.id))return;const i=v.revive(t.documentUri),s=this._documents.get(i);s&&this._createExtHostEditor(s,t.id,t)}if(e.value.removedEditors)for(const t of e.value.removedEditors){const i=this._editors.get(t);i&&(this._editors.delete(t),this._activeNotebookEditor?.id===i.id&&(this._activeNotebookEditor=void 0))}if(e.value.visibleEditors){this._visibleNotebookEditors=e.value.visibleEditors.map(i=>this._editors.get(i)).filter(i=>!!i);const t=new Set;this._visibleNotebookEditors.forEach(i=>t.add(i.id));for(const i of this._editors.values()){const s=t.has(i.id);i._acceptVisibility(s)}this._visibleNotebookEditors=[...this._editors.values()].map(i=>i).filter(i=>i.visible),this._onDidChangeVisibleNotebookEditors.fire(this.visibleNotebookEditors)}e.value.newActiveEditor===null?this._activeNotebookEditor=void 0:e.value.newActiveEditor&&(this._editors.get(e.value.newActiveEditor)||console.error(`FAILED to find active notebook editor ${e.value.newActiveEditor}`),this._activeNotebookEditor=this._editors.get(e.value.newActiveEditor)),e.value.newActiveEditor!==void 0&&this._onDidChangeActiveNotebookEditor.fire(this._activeNotebookEditor?.apiEditor)}static _registerApiCommands(e){const t=D.String.with("notebookType","A notebook type"),i=new H("vscode.executeDataToNotebook","_executeDataToNotebook","Invoke notebook serializer",[t,new D("data","Bytes to convert to data",r=>r instanceof Uint8Array,r=>be.wrap(r))],new M("Notebook Data",r=>jt.to(r.value))),s=new H("vscode.executeNotebookToData","_executeNotebookToData","Invoke notebook serializer",[t,new D("NotebookData","Notebook data to convert to bytes",r=>!0,r=>new Ke(jt.from(r)))],new M("Bytes",r=>r.buffer));e.registerApiCommand(i),e.registerApiCommand(s)}trace(e){this._logService.trace(`[Extension Host Notebook] ${e}`)}}class Yw{constructor(e,t,i,s={timeout:1500,errors:3}){this._logService=e,this._notebooksAndEditors=t,this._mainThreadBulkEdits=i,this._thresholds=s,this._onWillSaveNotebookDocumentEvent=new Fi}dispose(){}getOnWillSaveNotebookDocumentEvent(e){return(t,i,s)=>{const r=function(o){t.call(i,o)};return r.extension=e,this._onWillSaveNotebookDocumentEvent.event(r,void 0,s)}}async $participateInSave(e,t,i){const s=v.revive(e),r=this._notebooksAndEditors.getNotebookDocument(s);if(!r)throw new Error("Unable to resolve notebook document");const n=[];if(await this._onWillSaveNotebookDocumentEvent.fireAsync({notebook:r.apiNotebook,reason:mu.to(t)},i,async(d,c)=>{const h=Date.now(),g=await await Promise.resolve(d);Date.now()-h>this._thresholds.timeout&&this._logService.warn("onWillSaveNotebookDocument-listener from extension",c.extension.identifier),!i.isCancellationRequested&&g&&(g instanceof Ta?n.push(g):this._logService.warn("onWillSaveNotebookDocument-listener from extension",c.extension.identifier,"ignored due to invalid data"))}),i.isCancellationRequested)return!1;if(n.length===0)return!0;const o={edits:[]};for(const d of n){const{edits:c}=Le.from(d);o.edits=o.edits.concat(c)}return this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new Ke(o))}}class Zw{constructor(e){this._notebooksAndEditors=e,this._onDidSaveNotebookDocument=new P,this.onDidSaveNotebookDocument=this._onDidSaveNotebookDocument.event,this._onDidChangeNotebookDocument=new P,this.onDidChangeNotebookDocument=this._onDidChangeNotebookDocument.event}$acceptModelChanged(e,t,i,s){const n=this._notebooksAndEditors.getNotebookDocument(v.revive(e)).acceptModelChanged(t.value,i,s);this._onDidChangeNotebookDocument.fire(n)}$acceptDirtyStateChanged(e,t){this._notebooksAndEditors.getNotebookDocument(v.revive(e)).acceptDirty(t)}$acceptModelSaved(e){const t=this._notebooksAndEditors.getNotebookDocument(v.revive(e));this._onDidSaveNotebookDocument.fire(t.apiNotebook)}}let Qo=class{constructor(e,t){this._logService=e,this._notebooksAndEditors=t,this._onDidChangeNotebookEditorSelection=new P,this._onDidChangeNotebookEditorVisibleRanges=new P,this.onDidChangeNotebookEditorSelection=this._onDidChangeNotebookEditorSelection.event,this.onDidChangeNotebookEditorVisibleRanges=this._onDidChangeNotebookEditorVisibleRanges.event}$acceptEditorPropertiesChanged(e,t){this._logService.debug("ExtHostNotebook#$acceptEditorPropertiesChanged",e,t);const i=this._notebooksAndEditors.getEditorById(e);t.visibleRanges&&i._acceptVisibleRanges(t.visibleRanges.ranges.map(bt.to)),t.selections&&i._acceptSelections(t.selections.selections.map(bt.to)),t.visibleRanges&&this._onDidChangeNotebookEditorVisibleRanges.fire({notebookEditor:i.apiEditor,visibleRanges:i.apiEditor.visibleRanges}),t.selections&&this._onDidChangeNotebookEditorSelection.fire(Object.freeze({notebookEditor:i.apiEditor,selections:i.apiEditor.selections}))}$acceptEditorViewColumns(e){for(const t in e)this._notebooksAndEditors.getEditorById(t)._acceptViewColumn(ye.to(e[t]))}};Qo=L([E(0,re)],Qo);const ex=100;var Qc;(function(a){a[a.Disconnected=1]="Disconnected",a[a.Connected=2]="Connected",a[a.Initializing=3]="Initializing"})(Qc||(Qc={}));let Jo=class{constructor(e,t,i,s,r){this._initData=t,this._extHostNotebook=i,this._commands=s,this._logService=r,this._activeExecutions=new Ye,this._activeNotebookExecutions=new Ye,this._kernelDetectionTask=new Map,this._kernelDetectionTaskHandlePool=0,this._kernelSourceActionProviders=new Map,this._kernelSourceActionProviderHandlePool=0,this._kernelData=new Map,this._handlePool=0,this._onDidChangeCellExecutionState=new P,this.onDidChangeNotebookCellExecutionState=this._onDidChangeCellExecutionState.event,this.id=0,this.variableStore={},this._proxy=e.getProxy(k.MainThreadNotebookKernels);const n=new H("notebook.selectKernel","_notebook.selectKernel","Trigger kernel picker for specified notebook editor widget",[new D("options","Select kernel options",d=>!0,d=>{if(d&&"notebookEditor"in d&&"id"in d){const c=this._extHostNotebook.getIdByEditor(d.notebookEditor);return{id:d.id,extension:d.extension,notebookEditorId:c}}else if(d&&"notebookEditor"in d){const c=this._extHostNotebook.getIdByEditor(d.notebookEditor);if(c===void 0)throw new Error(`Cannot invoke 'notebook.selectKernel' for unrecognized notebook editor ${d.notebookEditor.notebook.uri.toString()}`);return"skipIfAlreadySelected"in d?{notebookEditorId:c,skipIfAlreadySelected:d.skipIfAlreadySelected}:{notebookEditorId:c}}return d})],M.Void),o=new H("vscode.executeNotebookVariableProvider","_executeNotebookVariableProvider","Execute notebook variable provider",[D.Uri],new M("A promise that resolves to an array of variables",(d,c)=>d.map(h=>({variable:{name:h.name,value:h.value,expression:h.expression,type:h.type,language:h.language},hasNamedChildren:h.hasNamedChildren,indexedChildrenCount:h.indexedChildrenCount}))));this._commands.registerApiCommand(n),this._commands.registerApiCommand(o)}createNotebookController(e,t,i,s,r,n){for(const I of this._kernelData.values())if(I.controller.id===t&&ge.equals(e.identifier,I.extensionId))throw new Error(`notebook controller with id '${t}' ALREADY exist`);const o=this._handlePool++,d=this;this._logService.trace(`NotebookController[${o}], CREATED by ${e.identifier.value}, ${t}`);const c=()=>console.warn(`NO execute handler from notebook controller '${l.id}' of extension: '${e.identifier}'`);let h=!1;const g=new P,m=new P,l={id:bs(e.identifier,t),notebookType:i,extensionId:e.identifier,extensionLocation:e.extensionLocation,label:s||e.identifier.value,preloads:n?n.map(tc.from):[]};let f=r??c,_,x;this._proxy.$addKernel(o,l).catch(I=>{console.log(I),h=!0});let C=0;const S=()=>{if(h)return;const I=++C;Promise.resolve().then(()=>{I===C&&this._proxy.$updateKernel(o,l)})},T=new Ye,O={get id(){return t},get notebookType(){return l.notebookType},onDidChangeSelectedNotebooks:g.event,get label(){return l.label},set label(I){l.label=I??e.displayName??e.name,S()},get detail(){return l.detail??""},set detail(I){l.detail=I,S()},get description(){return l.description??""},set description(I){l.description=I,S()},get supportedLanguages(){return l.supportedLanguages},set supportedLanguages(I){l.supportedLanguages=I,S()},get supportsExecutionOrder(){return l.supportsExecutionOrder??!1},set supportsExecutionOrder(I){l.supportsExecutionOrder=I,S()},get rendererScripts(){return l.preloads?l.preloads.map(tc.to):[]},get executeHandler(){return f},set executeHandler(I){f=I??c},get interruptHandler(){return _},set interruptHandler(I){_=I,l.supportsInterrupt=!!I,S()},set variableProvider(I){b(e,"notebookVariableProvider"),x=I,l.hasVariableProvider=!!I,I?.onDidChangeVariables(K=>d._proxy.$variablesUpdated(K.uri)),S()},get variableProvider(){return x},createNotebookCellExecution(I){if(h)throw new Error("notebook controller is DISPOSED");if(!T.has(I.notebook.uri))throw d._logService.trace(`NotebookController[${o}] NOT associated to notebook, associated to THESE notebooks:`,Array.from(T.keys()).map(K=>K.toString())),new Error(`notebook controller is NOT associated to notebook: ${I.notebook.uri.toString()}`);return d._createNotebookCellExecution(I,bs(e.identifier,this.id))},createNotebookExecution(I){if(b(e,"notebookExecution"),h)throw new Error("notebook controller is DISPOSED");if(!T.has(I.uri))throw d._logService.trace(`NotebookController[${o}] NOT associated to notebook, associated to THESE notebooks:`,Array.from(T.keys()).map(K=>K.toString())),new Error(`notebook controller is NOT associated to notebook: ${I.uri.toString()}`);return d._createNotebookExecution(I,bs(e.identifier,this.id))},dispose:()=>{h||(this._logService.trace(`NotebookController[${o}], DISPOSED`),h=!0,this._kernelData.delete(o),g.dispose(),m.dispose(),this._proxy.$removeKernel(o))},updateNotebookAffinity(I,K){K===Tu.Hidden&&b(e,"notebookControllerAffinityHidden"),d._proxy.$updateNotebookPriority(o,I.uri,K)},onDidReceiveMessage:m.event,postMessage(I,K){return b(e,"notebookMessaging"),d._proxy.$postMessage(o,K&&d._extHostNotebook.getIdByEditor(K),I)},asWebviewUri(I){return b(e,"notebookMessaging"),ji(I,d._initData.remote)}};return this._kernelData.set(o,{extensionId:e.identifier,controller:O,onDidReceiveMessage:m,onDidChangeSelection:g,associatedNotebooks:T}),O}getIdByController(e){for(const[t,i]of this._kernelData)if(i.controller===e)return bs(i.extensionId,e.id);return null}createNotebookControllerDetectionTask(e,t){const i=this._kernelDetectionTaskHandlePool++,s=this;this._logService.trace(`NotebookControllerDetectionTask[${i}], CREATED by ${e.identifier.value}`),this._proxy.$addKernelDetectionTask(i,t);const r={dispose:()=>{this._kernelDetectionTask.delete(i),s._proxy.$removeKernelDetectionTask(i)}};return this._kernelDetectionTask.set(i,r),r}registerKernelSourceActionProvider(e,t,i){const s=this._kernelSourceActionProviderHandlePool++,r=typeof i.onDidChangeNotebookKernelSourceActions=="function"?s:void 0,n=this;this._kernelSourceActionProviders.set(s,i),this._logService.trace(`NotebookKernelSourceActionProvider[${s}], CREATED by ${e.identifier.value}`),this._proxy.$addKernelSourceActionProvider(s,s,t);let o;return r!==void 0&&(o=i.onDidChangeNotebookKernelSourceActions(d=>this._proxy.$emitNotebookKernelSourceActionsChangeEvent(r))),{dispose:()=>{this._kernelSourceActionProviders.delete(s),n._proxy.$removeKernelSourceActionProvider(s,s),o?.dispose()}}}async $provideKernelSourceActions(e,t){const i=this._kernelSourceActionProviders.get(e);if(i){const s=new N;return(await i.provideNotebookKernelSourceActions(t)??[]).map(n=>cm.from(n,this._commands.converter,s))}return[]}$acceptNotebookAssociation(e,t,i){const s=this._kernelData.get(e);if(s){const r=this._extHostNotebook.getNotebookDocument(v.revive(t));i?s.associatedNotebooks.set(r.uri,!0):s.associatedNotebooks.delete(r.uri),this._logService.trace(`NotebookController[${e}] ASSOCIATE notebook`,r.uri.toString(),i),s.onDidChangeSelection.fire({selected:i,notebook:r.apiNotebook})}}async $executeCells(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getNotebookDocument(v.revive(t)),n=[];for(const o of i){const d=r.getCell(o);d&&n.push(d.apiCell)}try{this._logService.trace(`NotebookController[${e}] EXECUTE cells`,r.uri.toString(),n.length),await s.controller.executeHandler.call(s.controller,n,r.apiNotebook,s.controller)}catch(o){this._logService.error(`NotebookController[${e}] execute cells FAILED`,o),console.error(o)}}async $cancelCells(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getNotebookDocument(v.revive(t));if(s.controller.interruptHandler)await s.controller.interruptHandler.call(s.controller,r.apiNotebook);else for(const n of i){const o=r.getCell(n);o&&this._activeExecutions.get(o.uri)?.cancel()}if(s.controller.interruptHandler){const n=this._activeNotebookExecutions.get(r.uri);this._activeNotebookExecutions.delete(r.uri),i.length&&Array.isArray(n)&&n.length&&n.forEach(o=>o.dispose())}}async $provideVariables(e,t,i,s,r,n,o){const d=this._kernelData.get(e);if(!d)return;const c=this._extHostNotebook.getNotebookDocument(v.revive(i)),h=d.controller.variableProvider;if(!h)return;let g;if(s!==void 0){if(g=this.variableStore[s],!g)return}else this.variableStore={};const m=r==="named"?Yn.Named:Yn.Indexed,l=h.provideVariables(c.apiNotebook,g,m,n,o);let f=0;for await(const _ of l){if(o.isCancellationRequested)return;const x={id:this.id++,name:_.variable.name,value:_.variable.value,type:_.variable.type,interfaces:_.variable.interfaces,language:_.variable.language,expression:_.variable.expression,hasNamedChildren:_.hasNamedChildren,indexedChildrenCount:_.indexedChildrenCount,extensionId:d.extensionId.value};if(this.variableStore[x.id]=_.variable,this._proxy.$receiveVariable(t,x),f++>=ex)return}}$acceptKernelMessageFromRenderer(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getEditorById(t);s.onDidReceiveMessage.fire(Object.freeze({editor:r.apiEditor,message:i}))}$cellExecutionChanged(e,t,i){const r=this._extHostNotebook.getNotebookDocument(v.revive(e)).getCell(t);if(r){const n=i?lm.to(i):Pu.Idle;n!==void 0&&this._onDidChangeCellExecutionState.fire({cell:r.apiCell,state:n})}}_createNotebookCellExecution(e,t){if(e.index<0)throw new Error("CANNOT execute cell that has been REMOVED from notebook");const s=this._extHostNotebook.getNotebookDocument(e.notebook.uri).getCellFromApiCell(e);if(!s)throw new Error("invalid cell");if(this._activeExecutions.has(s.uri))throw new Error(`duplicate execution for ${s.uri}`);const r=new qa(t,s,this._proxy);this._activeExecutions.set(s.uri,r);const n=r.onDidChangeState(()=>{r.state===Be.Resolved&&(r.dispose(),n.dispose(),this._activeExecutions.delete(s.uri))});return r.asApiObject()}_createNotebookExecution(e,t){const i=this._extHostNotebook.getNotebookDocument(e.uri),s=e.getCells().find(o=>{const d=i.getCellFromApiCell(o);return d&&this._activeExecutions.has(d.uri)});if(s)throw new Error(`duplicate cell execution for ${s.document.uri}`);if(this._activeNotebookExecutions.has(i.uri))throw new Error(`duplicate notebook execution for ${i.uri}`);const r=new ja(t,i,this._proxy),n=r.onDidChangeState(()=>{r.state===Xe.Resolved&&(r.dispose(),n.dispose(),this._activeNotebookExecutions.delete(i.uri))});return this._activeNotebookExecutions.set(i.uri,[r,n]),r.asApiObject()}};Jo=L([E(4,re)],Jo);var Be;(function(a){a[a.Init=0]="Init",a[a.Started=1]="Started",a[a.Resolved=2]="Resolved"})(Be||(Be={}));class qa extends X{static{this.HANDLE=0}get state(){return this._state}constructor(e,t,i){super(),this._cell=t,this._proxy=i,this._handle=qa.HANDLE++,this._onDidChangeState=new P,this.onDidChangeState=this._onDidChangeState.event,this._state=Be.Init,this._tokenSource=this._register(new he),this._collector=new ix(10,s=>this.update(s)),this._executionOrder=t.internalMetadata.executionOrder,this._proxy.$createExecution(this._handle,e,this._cell.notebook.uri,this._cell.handle)}cancel(){this._tokenSource.cancel()}async updateSoon(e){await this._collector.addItem(e)}async update(e){const t=Array.isArray(e)?e:[e];return this._proxy.$updateExecution(this._handle,new Ke(t))}verifyStateForOutput(){if(this._state===Be.Init)throw new Error("Must call start before modifying cell output");if(this._state===Be.Resolved)throw new Error("Cannot modify cell output after calling resolve")}cellIndexToHandle(e){let t=this._cell;if(e&&(t=this._cell.notebook.getCellFromApiCell(e)),!t)throw new Error("INVALID cell");return t.handle}validateAndConvertOutputs(e){return e.map(t=>{const i=Xn.ensureUniqueMimeTypes(t.items,!0);return i===t.items?or.from(t):or.from({items:i,id:t.id,metadata:t.metadata})})}async updateOutputs(e,t,i){const s=this.cellIndexToHandle(t),r=this.validateAndConvertOutputs(je(e));return this.updateSoon({editType:gs.Output,cellHandle:s,append:i,outputs:r})}async updateOutputItems(e,t,i){return e=Xn.ensureUniqueMimeTypes(je(e),!0),this.updateSoon({editType:gs.OutputItems,items:e.map(Su.from),outputId:t.id,append:i})}asApiObject(){const e=this;return Object.freeze({get token(){return e._tokenSource.token},get cell(){return e._cell.apiCell},get executionOrder(){return e._executionOrder},set executionOrder(i){e._executionOrder=i,e.update([{editType:gs.ExecutionState,executionOrder:e._executionOrder}])},start(i){if(e._state===Be.Resolved||e._state===Be.Started)throw new Error("Cannot call start again");e._state=Be.Started,e._onDidChangeState.fire(),e.update({editType:gs.ExecutionState,runStartTime:i})},end(i,s,r){if(e._state===Be.Resolved)throw new Error("Cannot call resolve twice");e._state=Be.Resolved,e._onDidChangeState.fire(),e._collector.flush();const n=tx(r);e._proxy.$completeExecution(e._handle,new Ke({runEndTime:s,lastRunSuccess:i,error:n}))},clearOutput(i){return e.verifyStateForOutput(),e.updateOutputs([],i,!1)},appendOutput(i,s){return e.verifyStateForOutput(),e.updateOutputs(i,s,!0)},replaceOutput(i,s){return e.verifyStateForOutput(),e.updateOutputs(i,s,!1)},appendOutputItems(i,s){return e.verifyStateForOutput(),e.updateOutputItems(i,s,!0)},replaceOutputItems(i,s){return e.verifyStateForOutput(),e.updateOutputItems(i,s,!1)}})}}function tx(a){const e=s=>s?{startLineNumber:s.start.line,startColumn:s.start.character,endLineNumber:s.end.line,endColumn:s.end.character}:void 0,t=s=>({uri:s.uri,position:s.position,label:s.label});return a?{name:a.name,message:a.message,stack:a.stack instanceof Array?a.stack.map(s=>t(s)):a.stack,location:e(a.location),uri:a.uri}:void 0}var Xe;(function(a){a[a.Init=0]="Init",a[a.Started=1]="Started",a[a.Resolved=2]="Resolved"})(Xe||(Xe={}));class ja extends X{static{this.HANDLE=0}get state(){return this._state}constructor(e,t,i){super(),this._notebook=t,this._proxy=i,this._handle=ja.HANDLE++,this._onDidChangeState=new P,this.onDidChangeState=this._onDidChangeState.event,this._state=Xe.Init,this._tokenSource=this._register(new he),this._proxy.$createNotebookExecution(this._handle,e,this._notebook.uri)}cancel(){this._tokenSource.cancel()}asApiObject(){return Object.freeze({start:()=>{if(this._state===Xe.Resolved||this._state===Xe.Started)throw new Error("Cannot call start again");this._state=Xe.Started,this._onDidChangeState.fire(),this._proxy.$beginNotebookExecution(this._handle)},end:()=>{if(this._state===Xe.Resolved)throw new Error("Cannot call resolve twice");this._state=Xe.Resolved,this._onDidChangeState.fire(),this._proxy.$completeNotebookExecution(this._handle)}})}}class ix{constructor(e,t){this.delay=e,this.callback=t,this.batch=[],this.startedTimer=Date.now()}addItem(e){return this.batch.push(e),this.currentDeferred||(this.currentDeferred=new Ks,this.startedTimer=Date.now(),si(this.delay).then(()=>this.flush())),Date.now()-this.startedTimer>this.delay?this.flush():this.currentDeferred.p}flush(){if(this.batch.length===0||!this.currentDeferred)return Promise.resolve();const e=this.currentDeferred;this.currentDeferred=void 0;const t=this.batch;return this.batch=[],this.callback(t).finally(()=>e.complete())}}function bs(a,e){return`${a.value}/${e}`}class sx{constructor(e,t){this._extHostNotebook=t,this._rendererMessageEmitters=new Map,this.proxy=e.getProxy(k.MainThreadNotebookRenderers)}$postRendererMessage(e,t,i){const s=this._extHostNotebook.getEditorById(e);this._rendererMessageEmitters.get(t)?.fire({editor:s.apiEditor,message:i})}createRendererMessaging(e,t){if(!e.contributes?.notebookRenderer?.some(s=>s.id===t))throw new Error(`Extensions may only call createRendererMessaging() for renderers they contribute (got ${t})`);return{onDidReceiveMessage:(s,r,n)=>this.getOrCreateEmitterFor(t).event(s,r,n),postMessage:(s,r)=>{ts.apiEditorsToExtHost.has(s)&&([s,r]=[r,s]);const n=r&&ts.apiEditorsToExtHost.get(r);return this.proxy.$postMessage(n?.id,t,s)}}}getOrCreateEmitterFor(e){let t=this._rendererMessageEmitters.get(e);return t||(t=new P({onDidRemoveLastListener:()=>{t?.dispose(),this._rendererMessageEmitters.delete(e)}}),this._rendererMessageEmitters.set(e,t),t)}}class rx{constructor(e){this.handlers=new Map,this.proxy=e.getProxy(k.MainThreadProfileContentHandlers)}registerProfileContentHandler(e,t,i){if(b(e,"profileContentHandlers"),this.handlers.has(t))throw new Error(`Handler with id '${t}' already registered`);return this.handlers.set(t,i),this.proxy.$registerProfileContentHandler(t,i.name,i.description,e.identifier.value),B(()=>{this.handlers.delete(t),this.proxy.$unregisterProfileContentHandler(t)})}async $saveProfile(e,t,i,s){const r=this.handlers.get(e);if(!r)throw new Error(`Unknown handler with id: ${e}`);return r.saveProfile(t,i,s)}async $readProfile(e,t,i){const s=this.handlers.get(e);if(!s)throw new Error(`Unknown handler with id: ${e}`);return s.readProfile(ai(t)?t:v.revive(t),i)}}class nx{constructor(e){this._handles=0,this._mapHandleToCancellationSource=new Map,this._proxy=e}async withProgress(e,t,i){const s=this._handles++,{title:r,location:n,cancellable:o}=t,d={label:e.displayName||e.name,id:e.identifier.value};return this._proxy.$startProgress(s,{location:um.from(n),title:r,source:d,cancellable:o},e.isUnderDevelopment?void 0:e.identifier.value).catch(vl),this._withProgress(s,i,!!o)}_withProgress(e,t,i){let s;i&&(s=new he,this._mapHandleToCancellationSource.set(e,s));const r=o=>{this._proxy.$progressEnd(o),this._mapHandleToCancellationSource.delete(o),s?.dispose()};let n;try{n=t(new Xo(this._proxy,e),i&&s?s.token:ue.None)}catch(o){throw r(e),o}return n.then(o=>r(e),o=>r(e)),n}$acceptProgressCanceled(e){const t=this._mapHandleToCancellationSource.get(e);t&&(t.cancel(),this._mapHandleToCancellationSource.delete(e))}}function ox(a,e){return a.message=e.message,typeof e.increment=="number"&&(typeof a.increment=="number"?a.increment+=e.increment:a.increment=e.increment),a}class Xo extends la{constructor(e,t){super(i=>this.throttledReport(i)),this._proxy=e,this._handle=t}throttledReport(e){this._proxy.$progressReport(this._handle,e)}}Xo.__decorator=L([pp(100,(a,e)=>ox(a,e),()=>Object.create(null))],Xo.prototype,"throttledReport",null);class Ka{static{this.handlePool=0}constructor(e,t){this.uriTransformer=t,this.providers=new Map,this.proxy=e.getProxy(k.MainThreadQuickDiff)}$provideOriginalResource(e,t,i){const s=v.revive(t),r=this.providers.get(e);return r?we(()=>r.provideOriginalResource(s,i)).then(n=>n||null):Promise.resolve(null)}registerQuickDiffProvider(e,t,i,s,r,n){const o=Ka.handlePool++;this.providers.set(o,i);const d=ge.toKey(e.identifier);return this.proxy.$registerQuickDiffProvider(o,wr.from(t,this.uriTransformer),`${d}.${s}`,r,n),{dispose:()=>{this.proxy.$unregisterQuickDiffProvider(o),this.providers.delete(o)}}}}function ax(a,e,t){const i=a.getProxy(k.MainThreadQuickOpen);class s{constructor(l,f){this._sessions=new Map,this._instances=0,this._workspace=l,this._commands=f}showQuickPick(l,f,_,x=ue.None){this._onDidSelectItem=void 0;const C=Promise.resolve(f),S=++this._instances,T=i.$show(S,{title:_?.title,placeHolder:_?.placeHolder,matchOnDescription:_?.matchOnDescription,matchOnDetail:_?.matchOnDetail,ignoreFocusLost:_?.ignoreFocusOut,canPickMany:_?.canPickMany},x),O={},I=T.then(()=>O);return Promise.race([I,C]).then(K=>{if(K===O)return;const ie=te(l,"quickPickItemTooltip");return C.then(W=>{const se=[];for(let Q=0;Q<W.length;Q++){const me=W[Q];if(typeof me=="string")se.push({label:me,handle:Q});else if(me.kind===eo.Separator)se.push({type:"separator",label:me.label});else{me.tooltip&&!ie&&console.warn(`Extension '${l.identifier.value}' uses a tooltip which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${l.identifier.value}`);const le=me.iconPath?c(me.iconPath):void 0;se.push({label:me.label,iconPath:le?.iconPath,iconClass:le?.iconClass,description:me.description,detail:me.detail,picked:me.picked,alwaysShow:me.alwaysShow,tooltip:ie?ce.fromStrict(me.tooltip):void 0,handle:Q})}}return _&&typeof _.onDidSelectItem=="function"&&(this._onDidSelectItem=Q=>{_.onDidSelectItem(W[Q])}),i.$setItems(S,se),T.then(Q=>{if(typeof Q=="number")return W[Q];if(Array.isArray(Q))return Q.map(me=>W[me])})})}).then(void 0,K=>{if(!Qi(K))return i.$setError(S,K),Promise.reject(K)})}$onItemSelected(l){this._onDidSelectItem?.(l)}showInput(l,f=ue.None){return this._validateInput=l?.validateInput,i.$input(l,typeof this._validateInput=="function",f).then(void 0,_=>{if(!Qi(_))return Promise.reject(_)})}async $validateInput(l){if(!this._validateInput)return;const f=await this._validateInput(l);if(!f||typeof f=="string")return f;let _;switch(f.severity){case Hs.Info:_=Te.Info;break;case Hs.Warning:_=Te.Warning;break;case Hs.Error:_=Te.Error;break;default:_=f.message?Te.Error:Te.Ignore;break}return{content:f.message,severity:_}}async showWorkspaceFolderPick(l,f=ue.None){const _=await this._commands.executeCommand("_workbench.pickWorkspaceFolder",[l]);if(!_)return;const x=await this._workspace.getWorkspaceFolders2();if(x)return x.find(C=>C.uri.toString()===_.uri.toString())}createQuickPick(l){const f=new h(l,()=>this._sessions.delete(f._id));return this._sessions.set(f._id,f),f}createInputBox(l){const f=new g(l,()=>this._sessions.delete(f._id));return this._sessions.set(f._id,f),f}$onDidChangeValue(l,f){this._sessions.get(l)?._fireDidChangeValue(f)}$onDidAccept(l){this._sessions.get(l)?._fireDidAccept()}$onDidChangeActive(l,f){const _=this._sessions.get(l);_ instanceof h&&_._fireDidChangeActive(f)}$onDidChangeSelection(l,f){const _=this._sessions.get(l);_ instanceof h&&_._fireDidChangeSelection(f)}$onDidTriggerButton(l,f){this._sessions.get(l)?._fireDidTriggerButton(f)}$onDidTriggerItemButton(l,f,_){const x=this._sessions.get(l);x instanceof h&&x._fireDidTriggerItemButton(f,_)}$onDidHide(l){this._sessions.get(l)?._fireDidHide()}}class r{static{this._nextId=1}constructor(l,f){this._extension=l,this._onDidDispose=f,this._id=h._nextId++,this._visible=!1,this._expectingHide=!1,this._enabled=!0,this._busy=!1,this._ignoreFocusOut=!0,this._value="",this._valueSelection=void 0,this._buttons=[],this._handlesToButtons=new Map,this._onDidAcceptEmitter=new P,this._onDidChangeValueEmitter=new P,this._onDidTriggerButtonEmitter=new P,this._onDidHideEmitter=new P,this._pendingUpdate={id:this._id},this._disposed=!1,this._disposables=[this._onDidTriggerButtonEmitter,this._onDidHideEmitter,this._onDidAcceptEmitter,this._onDidChangeValueEmitter],this.onDidChangeValue=this._onDidChangeValueEmitter.event,this.onDidAccept=this._onDidAcceptEmitter.event,this.onDidTriggerButton=this._onDidTriggerButtonEmitter.event,this.onDidHide=this._onDidHideEmitter.event}get title(){return this._title}set title(l){this._title=l,this.update({title:l})}get step(){return this._steps}set step(l){this._steps=l,this.update({step:l})}get totalSteps(){return this._totalSteps}set totalSteps(l){this._totalSteps=l,this.update({totalSteps:l})}get enabled(){return this._enabled}set enabled(l){this._enabled=l,this.update({enabled:l})}get busy(){return this._busy}set busy(l){this._busy=l,this.update({busy:l})}get ignoreFocusOut(){return this._ignoreFocusOut}set ignoreFocusOut(l){this._ignoreFocusOut=l,this.update({ignoreFocusOut:l})}get value(){return this._value}set value(l){this._value=l,this.update({value:l})}get valueSelection(){return this._valueSelection}set valueSelection(l){this._valueSelection=l,this.update({valueSelection:l})}get placeholder(){return this._placeholder}set placeholder(l){this._placeholder=l,this.update({placeholder:l})}get buttons(){return this._buttons}set buttons(l){const f=te(this._extension,"quickInputButtonLocation");!f&&l.some(_=>_.location)&&console.warn(`Extension '${this._extension.identifier.value}' uses a button location which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${this._extension.identifier.value}`),this._buttons=l.slice(),this._handlesToButtons.clear(),l.forEach((_,x)=>{const C=_===Zn.Back?-1:x;this._handlesToButtons.set(C,_)}),this.update({buttons:l.map((_,x)=>({...c(_.iconPath),tooltip:_.tooltip,handle:_===Zn.Back?-1:x,location:f?_.location:void 0}))})}show(){this._visible=!0,this._expectingHide=!0,this.update({visible:!0})}hide(){this._visible=!1,this.update({visible:!1})}_fireDidAccept(){this._onDidAcceptEmitter.fire()}_fireDidChangeValue(l){this._value=l,this._onDidChangeValueEmitter.fire(l)}_fireDidTriggerButton(l){const f=this._handlesToButtons.get(l);f&&this._onDidTriggerButtonEmitter.fire(f)}_fireDidHide(){this._expectingHide&&(this._expectingHide=this._visible,this._onDidHideEmitter.fire())}dispose(){this._disposed||(this._disposed=!0,this._fireDidHide(),this._disposables=qs(this._disposables),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=void 0),this._onDidDispose(),i.$dispose(this._id))}update(l){if(!this._disposed){for(const f of Object.keys(l)){const _=l[f];this._pendingUpdate[f]=_===void 0?null:_}"visible"in this._pendingUpdate?(this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=void 0),this.dispatchUpdate()):this._visible&&!this._updateTimeout&&(this._updateTimeout=setTimeout(()=>{this._updateTimeout=void 0,this.dispatchUpdate()},0))}}dispatchUpdate(){i.$createOrUpdate(this._pendingUpdate),this._pendingUpdate={id:this._id}}}function n(m){if(m instanceof Et)return{id:m.id};const l=d(m),f=o(m);return{dark:typeof l=="string"?v.file(l):l,light:typeof f=="string"?v.file(f):f}}function o(m){return typeof m=="object"&&"light"in m?m.light:m}function d(m){return typeof m=="object"&&"dark"in m?m.dark:m}function c(m){const l=n(m);let f,_;return"id"in l?_=rs.asClassName(l):f=l,{iconPath:f,iconClass:_}}class h extends r{constructor(l,f){super(l,f),this._items=[],this._handlesToItems=new Map,this._itemsToHandles=new Map,this._canSelectMany=!1,this._matchOnDescription=!0,this._matchOnDetail=!0,this._sortByLabel=!0,this._keepScrollPosition=!1,this._activeItems=[],this._onDidChangeActiveEmitter=new P,this._selectedItems=[],this._onDidChangeSelectionEmitter=new P,this._onDidTriggerItemButtonEmitter=new P,this.onDidChangeActive=this._onDidChangeActiveEmitter.event,this.onDidChangeSelection=this._onDidChangeSelectionEmitter.event,this.onDidTriggerItemButton=this._onDidTriggerItemButtonEmitter.event,this._disposables.push(this._onDidChangeActiveEmitter,this._onDidChangeSelectionEmitter,this._onDidTriggerItemButtonEmitter),this.update({type:"quickPick"})}get items(){return this._items}set items(l){this._items=l.slice(),this._handlesToItems.clear(),this._itemsToHandles.clear(),l.forEach((x,C)=>{this._handlesToItems.set(C,x),this._itemsToHandles.set(x,C)});const f=te(this._extension,"quickPickItemTooltip"),_=[];for(let x=0;x<l.length;x++){const C=l[x];if(C.kind===eo.Separator)_.push({type:"separator",label:C.label});else{C.tooltip&&!f&&console.warn(`Extension '${this._extension.identifier.value}' uses a tooltip which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${this._extension.identifier.value}`);const S=C.iconPath?c(C.iconPath):void 0;_.push({handle:x,label:C.label,iconPath:S?.iconPath,iconClass:S?.iconClass,description:C.description,detail:C.detail,picked:C.picked,alwaysShow:C.alwaysShow,tooltip:f?ce.fromStrict(C.tooltip):void 0,buttons:C.buttons?.map((T,O)=>({...c(T.iconPath),tooltip:T.tooltip,handle:O}))})}}this.update({items:_})}get canSelectMany(){return this._canSelectMany}set canSelectMany(l){this._canSelectMany=l,this.update({canSelectMany:l})}get matchOnDescription(){return this._matchOnDescription}set matchOnDescription(l){this._matchOnDescription=l,this.update({matchOnDescription:l})}get matchOnDetail(){return this._matchOnDetail}set matchOnDetail(l){this._matchOnDetail=l,this.update({matchOnDetail:l})}get sortByLabel(){return this._sortByLabel}set sortByLabel(l){this._sortByLabel=l,this.update({sortByLabel:l})}get keepScrollPosition(){return this._keepScrollPosition}set keepScrollPosition(l){this._keepScrollPosition=l,this.update({keepScrollPosition:l})}get activeItems(){return this._activeItems}set activeItems(l){this._activeItems=l.filter(f=>this._itemsToHandles.has(f)),this.update({activeItems:this._activeItems.map(f=>this._itemsToHandles.get(f))})}get selectedItems(){return this._selectedItems}set selectedItems(l){this._selectedItems=l.filter(f=>this._itemsToHandles.has(f)),this.update({selectedItems:this._selectedItems.map(f=>this._itemsToHandles.get(f))})}_fireDidChangeActive(l){const f=Re(l.map(_=>this._handlesToItems.get(_)));this._activeItems=f,this._onDidChangeActiveEmitter.fire(f)}_fireDidChangeSelection(l){const f=Re(l.map(_=>this._handlesToItems.get(_)));this._selectedItems=f,this._onDidChangeSelectionEmitter.fire(f)}_fireDidTriggerItemButton(l,f){const _=this._handlesToItems.get(l);if(!_||!_.buttons||!_.buttons.length)return;const x=_.buttons[f];x&&this._onDidTriggerItemButtonEmitter.fire({button:x,item:_})}}class g extends r{constructor(l,f){super(l,f),this._password=!1,this.update({type:"inputBox"})}get password(){return this._password}set password(l){this._password=l,this.update({password:l})}get prompt(){return this._prompt}set prompt(l){this._prompt=l,this.update({prompt:l})}get validationMessage(){return this._validationMessage}set validationMessage(l){this._validationMessage=l,l?typeof l=="string"?this.update({validationMessage:l,severity:Te.Error}):this.update({validationMessage:l.message,severity:l.severity??Te.Error}):this.update({validationMessage:void 0,severity:Te.Ignore})}}return new s(e,t)}var Yo;function Jc(a){return a instanceof v}function dx(a,e){return a.scheme===q.file&&e.scheme===q.file&&_p?a.toString()===e.toString():a.toString().toLowerCase()===e.toString().toLowerCase()}function sn(a){if(a)return typeof a.iconPath=="string"?v.file(a.iconPath):v.isUri(a.iconPath)||rs.isThemeIcon(a.iconPath)?a.iconPath:void 0}function Ht(a){if(a){if(v.isUri(a))return a;if(rs.isThemeIcon(a))return a;{const e=a;return{light:e.light,dark:e.dark}}}else return}function cx(a){const e=Ht(a.authorIcon),t=a.references?.map(i=>({...i,icon:Ht(i.icon)}));return{...a,authorIcon:e,references:t}}function rn(a){return a?{...a,icon:Ht(a.icon)}:void 0}function nn(a,e){if(!a.iconPath&&!e.iconPath)return 0;if(a.iconPath){if(!e.iconPath)return 1}else return-1;const t=typeof a.iconPath=="string"?a.iconPath:v.isUri(a.iconPath)?a.iconPath.fsPath:a.iconPath.id,i=typeof e.iconPath=="string"?e.iconPath:v.isUri(e.iconPath)?e.iconPath.fsPath:e.iconPath.id;return Es(t,i)}function lx(a,e){let t=0;if(a.strikeThrough!==e.strikeThrough)return a.strikeThrough?1:-1;if(a.faded!==e.faded)return a.faded?1:-1;if(a.tooltip!==e.tooltip)return(a.tooltip||"").localeCompare(e.tooltip||"");if(t=nn(a,e),t!==0)return t;if(a.light&&e.light)t=nn(a.light,e.light);else{if(a.light)return 1;if(e.light)return-1}if(t!==0)return t;if(a.dark&&e.dark)t=nn(a.dark,e.dark);else{if(a.dark)return 1;if(e.dark)return-1}return t}function ux(a,e){if(a.command!==e.command)return a.command<e.command?-1:1;if(a.title!==e.title)return a.title<e.title?-1:1;if(a.tooltip!==e.tooltip){if(a.tooltip!==void 0&&e.tooltip!==void 0)return a.tooltip<e.tooltip?-1:1;if(a.tooltip!==void 0)return 1;if(e.tooltip!==void 0)return-1}if(a.arguments===e.arguments)return 0;if(a.arguments)if(e.arguments){if(a.arguments.length!==e.arguments.length)return a.arguments.length-e.arguments.length}else return 1;else return-1;for(let t=0;t<a.arguments.length;t++){const i=a.arguments[t],s=e.arguments[t];if(i!==s&&!(Jc(i)&&Jc(s)&&dx(i,s)))return i<s?-1:1}return 0}function Xc(a,e){let t=Es(a.resourceUri.fsPath,e.resourceUri.fsPath,!0);if(t!==0)return t;if(a.command&&e.command)t=ux(a.command,e.command);else{if(a.command)return 1;if(e.command)return-1}if(t!==0)return t;if(a.decorations&&e.decorations)t=lx(a.decorations,e.decorations);else{if(a.decorations)return 1;if(e.decorations)return-1}if(t!==0)return t;if(a.multiFileDiffEditorModifiedUri&&e.multiFileDiffEditorModifiedUri)t=Es(a.multiFileDiffEditorModifiedUri.fsPath,e.multiFileDiffEditorModifiedUri.fsPath,!0);else{if(a.multiFileDiffEditorModifiedUri)return 1;if(e.multiFileDiffEditorModifiedUri)return-1}if(t!==0)return t;if(a.multiDiffEditorOriginalUri&&e.multiDiffEditorOriginalUri)t=Es(a.multiDiffEditorOriginalUri.fsPath,e.multiDiffEditorOriginalUri.fsPath,!0);else{if(a.multiDiffEditorOriginalUri)return 1;if(e.multiDiffEditorOriginalUri)return-1}return t}function hx(a,e){for(let t=0;t<a.length;t++)if(a[t]!==e[t])return!1;return!0}function fx(a,e){return a.command===e.command&&a.title===e.title&&a.tooltip===e.tooltip&&(a.arguments&&e.arguments?hx(a.arguments,e.arguments):a.arguments===e.arguments)}function px(a,e){return da(a,e,fx)}class gx{#e;#t;get value(){return this._value}set value(e){e=e??"",this.#e.$setInputBoxValue(this._sourceControlHandle,e),this.updateValue(e)}get onDidChange(){return this._onDidChange.event}get placeholder(){return this._placeholder}set placeholder(e){this.#e.$setInputBoxPlaceholder(this._sourceControlHandle,e),this._placeholder=e}get validateInput(){return b(this._extension,"scmValidation"),this._validateInput}set validateInput(e){if(b(this._extension,"scmValidation"),e&&typeof e!="function")throw new Error(`[${this._extension.identifier.value}]: Invalid SCM input box validation function`);this._validateInput=e,this.#e.$setValidationProviderIsEnabled(this._sourceControlHandle,!!e)}get enabled(){return this._enabled}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.#e.$setInputBoxEnablement(this._sourceControlHandle,e))}get visible(){return this._visible}set visible(e){e=!!e,this._visible!==e&&(this._visible=e,this.#e.$setInputBoxVisibility(this._sourceControlHandle,e))}get document(){return b(this._extension,"scmTextDocument"),this.#t.getDocument(this._documentUri)}constructor(e,t,i,s,r){this._extension=e,this._sourceControlHandle=s,this._documentUri=r,this._value="",this._onDidChange=new P,this._placeholder="",this._enabled=!0,this._visible=!0,this.#t=t,this.#e=i}showValidationMessage(e,t){b(this._extension,"scmValidation"),this.#e.$showValidationMessage(this._sourceControlHandle,e,t)}$onInputBoxValueChange(e){this.updateValue(e)}updateValue(e){this._value=e,this._onDidChange.fire(e)}}class Ga{static{this._handlePool=0}get disposed(){return this._disposed}get id(){return this._id}get label(){return this._label}set label(e){this._label=e,this._proxy.$updateGroupLabel(this._sourceControlHandle,this.handle,e)}get contextValue(){return this._contextValue}set contextValue(e){this._contextValue=e,this._proxy.$updateGroup(this._sourceControlHandle,this.handle,this.features)}get hideWhenEmpty(){return this._hideWhenEmpty}set hideWhenEmpty(e){this._hideWhenEmpty=e,this._proxy.$updateGroup(this._sourceControlHandle,this.handle,this.features)}get features(){return{contextValue:this.contextValue,hideWhenEmpty:this.hideWhenEmpty}}get resourceStates(){return[...this._resourceStates]}set resourceStates(e){this._resourceStates=[...e],this._onDidUpdateResourceStates.fire()}constructor(e,t,i,s,r,n,o){this._proxy=e,this._commands=t,this._sourceControlHandle=i,this._id=s,this._label=r,this.multiDiffEditorEnableViewChanges=n,this._extension=o,this._resourceHandlePool=0,this._resourceStates=[],this._resourceStatesMap=new Map,this._resourceStatesCommandsMap=new Map,this._resourceStatesDisposablesMap=new Map,this._onDidUpdateResourceStates=new P,this.onDidUpdateResourceStates=this._onDidUpdateResourceStates.event,this._disposed=!1,this._onDidDispose=new P,this.onDidDispose=this._onDidDispose.event,this._handlesSnapshot=[],this._resourceSnapshot=[],this._contextValue=void 0,this._hideWhenEmpty=void 0,this.handle=Ga._handlePool++}getResourceState(e){return this._resourceStatesMap.get(e)}$executeResourceCommand(e,t){const i=this._resourceStatesCommandsMap.get(e);return i?we(()=>this._commands.executeCommand(i.command,...i.arguments||[],t)):Promise.resolve(void 0)}_takeResourceStateSnapshot(){const e=[...this._resourceStates].sort(Xc),i=gp(this._resourceSnapshot,e,Xc).map(n=>{const o=n.toInsert.map(d=>{const c=this._resourceHandlePool++;this._resourceStatesMap.set(c,d);const h=d.resourceUri;let g;if(d.command)if(d.command.command==="vscode.open"||d.command.command==="vscode.diff"||d.command.command==="vscode.changes"){const W=new N;g=this._commands.converter.toInternal(d.command,W),this._resourceStatesDisposablesMap.set(c,W)}else this._resourceStatesCommandsMap.set(c,d.command);const m=te(this._extension,"scmMultiDiffEditor"),l=m?d.multiDiffEditorOriginalUri:void 0,f=m?d.multiFileDiffEditorModifiedUri:void 0,_=sn(d.decorations),x=d.decorations&&sn(d.decorations.light)||_,C=d.decorations&&sn(d.decorations.dark)||_,S=[x,C],T=d.decorations&&d.decorations.tooltip||"",O=d.decorations&&!!d.decorations.strikeThrough,I=d.decorations&&!!d.decorations.faded,K=d.contextValue||"";return{rawResource:[c,h,S,T,O,I,K,g,l,f],handle:c}});return{start:n.start,deleteCount:n.deleteCount,toInsert:o}}),s=i.map(({start:n,deleteCount:o,toInsert:d})=>[n,o,d.map(c=>c.rawResource)]),r=i.reverse();for(const{start:n,deleteCount:o,toInsert:d}of r){const c=d.map(g=>g.handle),h=this._handlesSnapshot.splice(n,o,...c);for(const g of h)this._resourceStatesMap.delete(g),this._resourceStatesCommandsMap.delete(g),this._resourceStatesDisposablesMap.get(g)?.dispose(),this._resourceStatesDisposablesMap.delete(g)}return this._resourceSnapshot=e,s}dispose(){this._disposed=!0,this._onDidDispose.fire()}}class Nt{static{this._handlePool=0}#e;get id(){return this._id}get label(){return this._label}get rootUri(){return this._rootUri}get inputBox(){return this._inputBox}get count(){return this._count}set count(e){this._count!==e&&(this._count=e,this.#e.$updateSourceControl(this.handle,{count:e}))}get quickDiffProvider(){return this._quickDiffProvider}set quickDiffProvider(e){this._quickDiffProvider=e;let t;te(this._extension,"quickDiffProvider")&&(t=e?.label),this.#e.$updateSourceControl(this.handle,{hasQuickDiffProvider:!!e,quickDiffLabel:t})}get secondaryQuickDiffProvider(){return b(this._extension,"quickDiffProvider"),this._secondaryQuickDiffProvider}set secondaryQuickDiffProvider(e){b(this._extension,"quickDiffProvider"),this._secondaryQuickDiffProvider=e;const t=e?.label;this.#e.$updateSourceControl(this.handle,{hasSecondaryQuickDiffProvider:!!e,secondaryQuickDiffLabel:t})}get historyProvider(){return b(this._extension,"scmHistoryProvider"),this._historyProvider}set historyProvider(e){b(this._extension,"scmHistoryProvider"),this._historyProvider=e,this._historyProviderDisposable.value=new N,this.#e.$updateSourceControl(this.handle,{hasHistoryProvider:!!e}),e&&(this._historyProviderDisposable.value.add(e.onDidChangeCurrentHistoryItemRefs(()=>{const t=rn(e?.currentHistoryItemRef),i=rn(e?.currentHistoryItemRemoteRef),s=rn(e?.currentHistoryItemBaseRef);this.#e.$onDidChangeHistoryProviderCurrentHistoryItemRefs(this.handle,t,i,s)})),this._historyProviderDisposable.value.add(e.onDidChangeHistoryItemRefs(t=>{if(t.added.length===0&&t.modified.length===0&&t.removed.length===0)return;const i=t.added.map(n=>({...n,icon:Ht(n.icon)})),s=t.modified.map(n=>({...n,icon:Ht(n.icon)})),r=t.removed.map(n=>({...n,icon:Ht(n.icon)}));this.#e.$onDidChangeHistoryProviderHistoryItemRefs(this.handle,{added:i,modified:s,removed:r,silent:t.silent})})))}get commitTemplate(){return this._commitTemplate}set commitTemplate(e){e!==this._commitTemplate&&(this._commitTemplate=e,this.#e.$updateSourceControl(this.handle,{commitTemplate:e}))}get acceptInputCommand(){return this._acceptInputCommand}set acceptInputCommand(e){this._acceptInputDisposables.value=new N,this._acceptInputCommand=e;const t=this._commands.converter.toInternal(e,this._acceptInputDisposables.value);this.#e.$updateSourceControl(this.handle,{acceptInputCommand:t})}get actionButton(){return b(this._extension,"scmActionButton"),this._actionButton}set actionButton(e){if(b(this._extension,"scmActionButton"),mp(this._actionButton,e))return;this._actionButton=e,this._actionButtonDisposables.value=new N;const t=e!==void 0?{command:{...this._commands.converter.toInternal(e.command,this._actionButtonDisposables.value),shortTitle:e.command.shortTitle},secondaryCommands:e.secondaryCommands?.map(i=>i.map(s=>this._commands.converter.toInternal(s,this._actionButtonDisposables.value))),enabled:e.enabled}:void 0;this.#e.$updateSourceControl(this.handle,{actionButton:t??null})}get statusBarCommands(){return this._statusBarCommands}set statusBarCommands(e){if(this._statusBarCommands&&e&&px(this._statusBarCommands,e))return;this._statusBarDisposables.value=new N,this._statusBarCommands=e;const t=(e||[]).map(i=>this._commands.converter.toInternal(i,this._statusBarDisposables.value));this.#e.$updateSourceControl(this.handle,{statusBarCommands:t})}get selected(){return this._selected}constructor(e,t,i,s,r,n,o){this._extension=e,this._commands=s,this._id=r,this._label=n,this._rootUri=o,this._groups=new Map,this._count=void 0,this._quickDiffProvider=void 0,this._secondaryQuickDiffProvider=void 0,this._historyProviderDisposable=new At,this._commitTemplate=void 0,this._acceptInputDisposables=new At,this._acceptInputCommand=void 0,this._actionButtonDisposables=new At,this._statusBarDisposables=new At,this._statusBarCommands=void 0,this._selected=!1,this._onDidChangeSelection=new P,this.onDidChangeSelection=this._onDidChangeSelection.event,this.handle=Nt._handlePool++,this.createdResourceGroups=new Map,this.updatedResourceGroups=new Set,this.#e=i;const d=v.from({scheme:q.vscodeSourceControl,path:`${r}/scm${this.handle}/input`,query:o?`rootUri=${encodeURIComponent(o.toString())}`:void 0});this._inputBox=new gx(e,t,this.#e,this.handle,d),this.#e.$registerSourceControl(this.handle,r,n,o,d)}createResourceGroup(e,t,i){const s=te(this._extension,"scmMultiDiffEditor")&&i?.multiDiffEditorEnableViewChanges===!0,r=new Ga(this.#e,this._commands,this.handle,e,t,s,this._extension),n=Ee.once(r.onDidDispose)(()=>this.createdResourceGroups.delete(r));return this.createdResourceGroups.set(r,n),this.eventuallyAddResourceGroups(),r}eventuallyAddResourceGroups(){const e=[],t=[];for(const[i,s]of this.createdResourceGroups){s.dispose();const r=i.onDidUpdateResourceStates(()=>{this.updatedResourceGroups.add(i),this.eventuallyUpdateResourceStates()});Ee.once(i.onDidDispose)(()=>{this.updatedResourceGroups.delete(i),r.dispose(),this._groups.delete(i.handle),this.#e.$unregisterGroup(this.handle,i.handle)}),e.push([i.handle,i.id,i.label,i.features,i.multiDiffEditorEnableViewChanges]);const n=i._takeResourceStateSnapshot();n.length>0&&t.push([i.handle,n]),this._groups.set(i.handle,i)}this.#e.$registerGroups(this.handle,e,t),this.createdResourceGroups.clear()}eventuallyUpdateResourceStates(){const e=[];this.updatedResourceGroups.forEach(t=>{const i=t._takeResourceStateSnapshot();i.length!==0&&e.push([t.handle,i])}),e.length>0&&this.#e.$spliceResourceStates(this.handle,e),this.updatedResourceGroups.clear()}getResourceGroup(e){return this._groups.get(e)}setSelectionState(e){this._selected=e,this._onDidChangeSelection.fire(e)}dispose(){this._acceptInputDisposables.dispose(),this._actionButtonDisposables.dispose(),this._statusBarDisposables.dispose(),this._groups.forEach(e=>e.dispose()),this.#e.$unregisterSourceControl(this.handle)}}Nt.__decorator=L([yl(100)],Nt.prototype,"eventuallyAddResourceGroups",null);Nt.__decorator=L([yl(100)],Nt.prototype,"eventuallyUpdateResourceStates",null);let Zo=class{static{Yo=this}static{this._handlePool=0}get onDidChangeActiveProvider(){return this._onDidChangeActiveProvider.event}constructor(e,t,i,s){this._commands=t,this._extHostDocuments=i,this.logService=s,this._sourceControls=new Map,this._sourceControlsByExtension=new Lt,this._onDidChangeActiveProvider=new P,this._proxy=e.getProxy(k.MainThreadSCM),this._telemetry=e.getProxy(k.MainThreadTelemetry),t.registerArgumentProcessor({processArgument:r=>{if(r&&r.$mid===xe.ScmResource){const n=this._sourceControls.get(r.sourceControlHandle);if(!n)return r;const o=n.getResourceGroup(r.groupHandle);return o?o.getResourceState(r.handle):r}else if(r&&r.$mid===xe.ScmResourceGroup){const n=this._sourceControls.get(r.sourceControlHandle);return n?n.getResourceGroup(r.groupHandle):r}else if(r&&r.$mid===xe.ScmProvider){const n=this._sourceControls.get(r.handle);return n||r}return r}})}createSourceControl(e,t,i,s){this.logService.trace("ExtHostSCM#createSourceControl",e.identifier.value,t,i,s),this._telemetry.$publicLog2("api/scm/createSourceControl",{extensionId:e.identifier.value});const r=Yo._handlePool++,n=new Nt(e,this._extHostDocuments,this._proxy,this._commands,t,i,s);this._sourceControls.set(r,n);const o=this._sourceControlsByExtension.get(e.identifier)||[];return o.push(n),this._sourceControlsByExtension.set(e.identifier,o),n}getLastInputBox(e){this.logService.trace("ExtHostSCM#getLastInputBox",e.identifier.value);const t=this._sourceControlsByExtension.get(e.identifier),i=t&&t[t.length-1];return i&&i.inputBox}$provideOriginalResource(e,t,i){const s=v.revive(t);this.logService.trace("ExtHostSCM#$provideOriginalResource",e,s.toString());const r=this._sourceControls.get(e);return!r||!r.quickDiffProvider||!r.quickDiffProvider.provideOriginalResource?Promise.resolve(null):we(()=>r.quickDiffProvider.provideOriginalResource(s,i)).then(n=>n||null)}$provideSecondaryOriginalResource(e,t,i){const s=v.revive(t);this.logService.trace("ExtHostSCM#$provideSecondaryOriginalResource",e,s.toString());const r=this._sourceControls.get(e);return!r||!r.secondaryQuickDiffProvider||!r.secondaryQuickDiffProvider.provideOriginalResource?Promise.resolve(null):we(()=>r.secondaryQuickDiffProvider.provideOriginalResource(s,i)).then(n=>n||null)}$onInputBoxValueChange(e,t){this.logService.trace("ExtHostSCM#$onInputBoxValueChange",e);const i=this._sourceControls.get(e);return i&&i.inputBox.$onInputBoxValueChange(t),Promise.resolve(void 0)}$executeResourceCommand(e,t,i,s){this.logService.trace("ExtHostSCM#$executeResourceCommand",e,t,i);const r=this._sourceControls.get(e);if(!r)return Promise.resolve(void 0);const n=r.getResourceGroup(t);return n?n.$executeResourceCommand(i,s):Promise.resolve(void 0)}$validateInput(e,t,i){this.logService.trace("ExtHostSCM#$validateInput",e);const s=this._sourceControls.get(e);return!s||!s.inputBox.validateInput?Promise.resolve(void 0):we(()=>s.inputBox.validateInput(t,i)).then(r=>{if(!r)return Promise.resolve(void 0);const n=ce.fromStrict(r.message);return n?Promise.resolve([n,r.type]):Promise.resolve(void 0)})}$setSelectedSourceControl(e){return this.logService.trace("ExtHostSCM#$setSelectedSourceControl",e),e!==void 0&&this._sourceControls.get(e)?.setSelectionState(!0),this._selectedSourceControlHandle!==void 0&&this._sourceControls.get(this._selectedSourceControlHandle)?.setSelectionState(!1),this._selectedSourceControlHandle=e,Promise.resolve(void 0)}async $resolveHistoryItemRefsCommonAncestor(e,t,i){try{return await this._sourceControls.get(e)?.historyProvider?.resolveHistoryItemRefsCommonAncestor(t,i)??void 0}catch(s){this.logService.error("ExtHostSCM#$resolveHistoryItemRefsCommonAncestor",s);return}}async $provideHistoryItemRefs(e,t,i){try{return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItemRefs(t,i))?.map(n=>({...n,icon:Ht(n.icon)}))??void 0}catch(s){this.logService.error("ExtHostSCM#$provideHistoryItemRefs",s);return}}async $provideHistoryItems(e,t,i){try{return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItems(t,i))?.map(n=>cx(n))??void 0}catch(s){this.logService.error("ExtHostSCM#$provideHistoryItems",s);return}}async $provideHistoryItemChanges(e,t,i,s){try{return await this._sourceControls.get(e)?.historyProvider?.provideHistoryItemChanges(t,i,s)??void 0}catch(r){this.logService.error("ExtHostSCM#$provideHistoryItemChanges",r);return}}};Zo=Yo=L([E(3,re)],Zo);class Qa{static{this.handlePool=0}constructor(e,t){this.uriTransformer=t,this.providers=new Map,this.proxy=e.getProxy(k.MainThreadShare)}async $provideShare(e,t,i){return await this.providers.get(e)?.provideShare({selection:$.to(t.selection),resourceUri:v.revive(t.resourceUri)},i)??void 0}registerShareProvider(e,t){const i=Qa.handlePool++;return this.providers.set(i,t),this.proxy.$registerShareProvider(i,wr.from(e,this.uriTransformer),t.id,t.label,t.priority),{dispose:()=>{this.proxy.$unregisterShareProvider(i),this.providers.delete(i)}}}}class Ja{static{this.ID_POOL=1}constructor(e){this.providers=new Map,this.sessions=new Map,this.synthesizers=new Map,this.proxy=e.getProxy(k.MainThreadSpeech)}async $createSpeechToTextSession(e,t,i){const s=this.providers.get(e);if(!s)return;const r=new N,n=new he;this.sessions.set(t,n);const o=await s.provideSpeechToTextSession(n.token,i?{language:i}:void 0);o&&(r.add(o.onDidChange(d=>{n.token.isCancellationRequested||this.proxy.$emitSpeechToTextEvent(t,d)})),r.add(n.token.onCancellationRequested(()=>r.dispose())))}async $cancelSpeechToTextSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e)}async $createTextToSpeechSession(e,t,i){const s=this.providers.get(e);if(!s)return;const r=new N,n=new he;this.sessions.set(t,n);const o=await s.provideTextToSpeechSession(n.token,i?{language:i}:void 0);o&&(this.synthesizers.set(t,o),r.add(o.onDidChange(d=>{n.token.isCancellationRequested||this.proxy.$emitTextToSpeechEvent(t,d)})),r.add(n.token.onCancellationRequested(()=>r.dispose())))}async $synthesizeSpeech(e,t){this.synthesizers.get(e)?.synthesize(t)}async $cancelTextToSpeechSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e),this.synthesizers.delete(e)}async $createKeywordRecognitionSession(e,t){const i=this.providers.get(e);if(!i)return;const s=new N,r=new he;this.sessions.set(t,r);const n=await i.provideKeywordRecognitionSession(r.token);n&&(s.add(n.onDidChange(o=>{r.token.isCancellationRequested||this.proxy.$emitKeywordRecognitionEvent(t,o)})),s.add(r.token.onCancellationRequested(()=>s.dispose())))}async $cancelKeywordRecognitionSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e)}registerProvider(e,t,i){const s=Ja.ID_POOL++;return this.providers.set(s,i),this.proxy.$registerProvider(s,t,{extension:e,displayName:e.value}),B(()=>{this.proxy.$unregisterProvider(s),this.providers.delete(s)})}}class Gi{static{this.ID_GEN=0}static{this.ALLOWED_BACKGROUND_COLORS=new Map([["statusBarItem.errorBackground",new to("statusBarItem.errorForeground")],["statusBarItem.warningBackground",new to("statusBarItem.warningForeground")]])}#e;#t;constructor(e,t,i,s,r,n=ei.Left,o,d){if(this._onDispose=d,this._disposed=!1,this._text="",this._staleCommandRegistrations=new N,this.#e=e,this.#t=t,r&&s){this._entryId=hm(s.identifier,r);const c=i.get(this._entryId);c&&(n=c.alignLeft?ei.Left:ei.Right,o=c.priority,this._visible=!0,this.name=c.name,this.text=c.text,this.tooltip=c.tooltip,this.command=c.command,this.accessibilityInformation=c.accessibilityInformation)}else this._entryId=String(Gi.ID_GEN++);this._extension=s,this._id=r,this._alignment=n,this._priority=this.validatePriority(o)}validatePriority(e){if(vp(e))return e===Number.POSITIVE_INFINITY?Number.MAX_VALUE:e===Number.NEGATIVE_INFINITY?-Number.MAX_VALUE:e}get id(){return this._id??this._extension.identifier.value}get entryId(){return this._entryId}get alignment(){return this._alignment}get priority(){return this._priority}get text(){return this._text}get name(){return this._name}get tooltip(){return this._tooltip}get tooltip2(){return this._extension&&b(this._extension,"statusBarItemTooltip"),this._tooltip2}get color(){return this._color}get backgroundColor(){return this._backgroundColor}get command(){return this._command?.fromApi}get accessibilityInformation(){return this._accessibilityInformation}set text(e){this._text=e,this.update()}set name(e){this._name=e,this.update()}set tooltip(e){this._tooltip=e,this.update()}set tooltip2(e){this._extension&&b(this._extension,"statusBarItemTooltip"),this._tooltip2=e,this.update()}set color(e){this._color=e,this.update()}set backgroundColor(e){e&&!Gi.ALLOWED_BACKGROUND_COLORS.has(e.id)&&(e=void 0),this._backgroundColor=e,this.update()}set command(e){this._command?.fromApi!==e&&(this._latestCommandRegistration&&this._staleCommandRegistrations.add(this._latestCommandRegistration),this._latestCommandRegistration=new N,typeof e=="string"?this._command={fromApi:e,internal:this.#t.toInternal({title:"",command:e},this._latestCommandRegistration)}:e?this._command={fromApi:e,internal:this.#t.toInternal(e,this._latestCommandRegistration)}:this._command=void 0,this.update())}set accessibilityInformation(e){this._accessibilityInformation=e,this.update()}show(){this._visible=!0,this.update()}hide(){clearTimeout(this._timeoutHandle),this._visible=!1,this.#e.$disposeEntry(this._entryId)}update(){this._disposed||!this._visible||(clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{this._timeoutHandle=void 0;let e;this._extension?this._id?e=`${this._extension.identifier.value}.${this._id}`:e=this._extension.identifier.value:e=this._id;let t;this._name?t=this._name:t=J(2566,"{0} (Extension)",this._extension.displayName||this._extension.name);let i=this._color;this._backgroundColor&&(i=Gi.ALLOWED_BACKGROUND_COLORS.get(this._backgroundColor.id));let s,r;typeof this._tooltip2=="function"?(s=ce.fromStrict(this._tooltip),r=!0):(s=ce.fromStrict(this._tooltip2??this._tooltip),r=!1),this.#e.$setEntry(this._entryId,e,this._extension?.identifier.value,t,this._text,s,r,this._command?.internal,i,this._backgroundColor,this._alignment===ei.Left,this._priority,this._accessibilityInformation),this._staleCommandRegistrations.clear()},0))}dispose(){this.hide(),this._onDispose?.(),this._disposed=!0}}class mx{constructor(e){this._messages=[],this._item=e.createStatusBarEntry(void 0,"status.extensionMessage",ei.Left,Number.MIN_VALUE),this._item.name=J(2567,"Extension Status")}dispose(){this._messages.length=0,this._item.dispose()}setMessage(e){const t={message:e};return this._messages.unshift(t),this._update(),new V(()=>{const i=this._messages.indexOf(t);i>=0&&(this._messages.splice(i,1),this._update())})}_update(){this._messages.length>0?(this._item.text=this._messages[0].message,this._item.show()):this._item.hide()}}class _x{constructor(e,t){this._entries=new Map,this._existingItems=new Map,this._proxy=e.getProxy(k.MainThreadStatusBar),this._commands=t,this._statusMessage=new mx(this)}$acceptStaticEntries(e){for(const t of e)this._existingItems.set(t.entryId,t)}async $provideTooltip(e,t){const i=this._entries.get(e);if(!i)return;const s=typeof i.tooltip2=="function"?await i.tooltip2(t):i.tooltip2;return t.isCancellationRequested?void 0:ce.fromStrict(s)}createStatusBarEntry(e,t,i,s){const r=new Gi(this._proxy,this._commands,this._existingItems,e,t,i,s,()=>this._entries.delete(r.entryId));return this._entries.set(r.entryId,r),r}setStatusBarMessage(e,t){const i=this._statusMessage.setMessage(e);let s;return typeof t=="number"?s=setTimeout(()=>i.dispose(),t):typeof t<"u"&&t.then(()=>i.dispose(),()=>i.dispose()),new V(()=>{i.dispose(),clearTimeout(s)})}}class vx extends X{constructor(e,t){super(),this._extHostDocumentsAndEditors=t,this._onDidChangeTextEditorSelection=new P,this._onDidChangeTextEditorOptions=new P,this._onDidChangeTextEditorVisibleRanges=new P,this._onDidChangeTextEditorViewColumn=new P,this._onDidChangeTextEditorDiffInformation=new P,this._onDidChangeActiveTextEditor=new P,this._onDidChangeVisibleTextEditors=new P,this.onDidChangeTextEditorSelection=this._onDidChangeTextEditorSelection.event,this.onDidChangeTextEditorOptions=this._onDidChangeTextEditorOptions.event,this.onDidChangeTextEditorVisibleRanges=this._onDidChangeTextEditorVisibleRanges.event,this.onDidChangeTextEditorViewColumn=this._onDidChangeTextEditorViewColumn.event,this.onDidChangeTextEditorDiffInformation=this._onDidChangeTextEditorDiffInformation.event,this.onDidChangeActiveTextEditor=this._onDidChangeActiveTextEditor.event,this.onDidChangeVisibleTextEditors=this._onDidChangeVisibleTextEditors.event,this._proxy=e.getProxy(k.MainThreadTextEditors),this._register(this._extHostDocumentsAndEditors.onDidChangeVisibleTextEditors(i=>this._onDidChangeVisibleTextEditors.fire(i))),this._register(this._extHostDocumentsAndEditors.onDidChangeActiveTextEditor(i=>this._onDidChangeActiveTextEditor.fire(i)))}getActiveTextEditor(){return this._extHostDocumentsAndEditors.activeEditor()}getVisibleTextEditors(e){const t=this._extHostDocumentsAndEditors.allEditors();return e?t:t.map(i=>i.value)}async showTextDocument(e,t,i){let s;typeof t=="number"?s={position:ye.from(t),preserveFocus:i}:typeof t=="object"?s={position:ye.from(t.viewColumn),preserveFocus:t.preserveFocus,selection:typeof t.selection=="object"?$.from(t.selection):void 0,pinned:typeof t.preview=="boolean"?!t.preview:void 0}:s={preserveFocus:!1};const r=await this._proxy.$tryShowTextDocument(e.uri,s),n=r&&this._extHostDocumentsAndEditors.getEditor(r);if(n)return n.value;throw r?new Error(`Could NOT open editor for "${e.uri.toString()}" because another editor opened in the meantime.`):new Error(`Could NOT open editor for "${e.uri.toString()}".`)}createTextEditorDecorationType(e,t){return new $a(this._proxy,e,t).value}$acceptEditorPropertiesChanged(e,t){const i=this._extHostDocumentsAndEditors.getEditor(e);if(!i)throw new Error("unknown text editor");if(t.options&&i._acceptOptions(t.options),t.selections){const s=t.selections.selections.map(et.to);i._acceptSelections(s)}if(t.visibleRanges){const s=Re(t.visibleRanges.map($.to));i._acceptVisibleRanges(s)}if(t.options&&this._onDidChangeTextEditorOptions.fire({textEditor:i.value,options:{...t.options,lineNumbers:Ps.to(t.options.lineNumbers)}}),t.selections){const s=ku.fromValue(t.selections.source),r=t.selections.selections.map(et.to);this._onDidChangeTextEditorSelection.fire({textEditor:i.value,selections:r,kind:s})}if(t.visibleRanges){const s=Re(t.visibleRanges.map($.to));this._onDidChangeTextEditorVisibleRanges.fire({textEditor:i.value,visibleRanges:s})}}$acceptEditorPositionData(e){for(const t in e){const i=this._extHostDocumentsAndEditors.getEditor(t);if(!i)throw new Error("Unknown text editor");const s=ye.to(e[t]);i.value.viewColumn!==s&&(i._acceptViewColumn(s),this._onDidChangeTextEditorViewColumn.fire({textEditor:i.value,viewColumn:s}))}}$acceptEditorDiffInformation(e,t){const i=this._extHostDocumentsAndEditors.getEditor(e);if(!i)throw new Error("unknown text editor");if(!t){i._acceptDiffInformation(void 0),this._onDidChangeTextEditorDiffInformation.fire({textEditor:i.value,diffInformation:void 0});return}const s=this,r=t.map(n=>{const o=v.revive(n.original),d=v.revive(n.modified),c=n.changes.map(h=>{const[g,m,l,f]=h;let _;return g===m?_=Fs.Addition:l===f?_=Fs.Deletion:_=Fs.Modification,{original:{startLineNumber:g,endLineNumberExclusive:m},modified:{startLineNumber:l,endLineNumberExclusive:f},kind:_}});return Object.freeze({documentVersion:n.documentVersion,original:o,modified:d,changes:c,get isStale(){return s._extHostDocumentsAndEditors.getDocument(d)?.version!==n.documentVersion}})});i._acceptDiffInformation(r),this._onDidChangeTextEditorDiffInformation.fire({textEditor:i.value,diffInformation:r})}getDiffInformation(e){return Promise.resolve(this._proxy.$getDiffInformation(e))}}let ea=class{constructor(e){this._actual=new ic(Xt.Dark),this._onDidChangeActiveColorTheme=new P}get activeColorTheme(){return this._actual}$onColorThemeChange(e){let t;switch(e){case"light":t=Xt.Light;break;case"hcDark":t=Xt.HighContrast;break;case"hcLight":t=Xt.HighContrastLight;break;default:t=Xt.Dark}this._actual=new ic(t),this._onDidChangeActiveColorTheme.fire(this._actual)}get onDidChangeActiveColorTheme(){return this._onDidChangeActiveColorTheme.event}};ea=L([E(0,j)],ea);class yx{constructor(e,t){this._providers=new Map,this._itemsBySourceAndUriMap=new Map,this._proxy=e.getProxy(k.MainThreadTimeline),t.registerArgumentProcessor({processArgument:(i,s)=>{if(i&&i.$mid===xe.TimelineActionContext)if(this._providers.get(i.source)&&s&&te(s,"timeline")){const r=i.uri===void 0?void 0:v.revive(i.uri);return this._itemsBySourceAndUriMap.get(i.source)?.get(Yc(r))?.get(i.handle)}else return;return i}})}async $getTimeline(e,t,i,s){return this._providers.get(e)?.provider.provideTimeline(v.revive(t),i,s)}registerTimelineProvider(e,t,i,s){const r=new N,n=this.convertTimelineItem(t.id,s,r).bind(this);let o;t.onDidChange&&(o=t.onDidChange(c=>this._proxy.$emitTimelineChangeEvent({uri:void 0,reset:!0,...c,id:t.id}),this));const d=this._itemsBySourceAndUriMap;return this.registerTimelineProviderCore({...t,scheme:e,onDidChange:void 0,async provideTimeline(c,h,g){h?.resetCache&&(r.clear(),d.get(t.id)?.clear());const m=await t.provideTimeline(c,h,g);if(m==null)return;const l=n(c,h);return{...m,source:t.id,items:m.items.map(l)}},dispose(){for(const c of d.values())c.get(t.id)?.clear();o?.dispose(),r.dispose()}},i)}convertTimelineItem(e,t,i){return(s,r)=>{let n;if(r?.cacheResults){let o=this._itemsBySourceAndUriMap.get(e);o===void 0&&(o=new Map,this._itemsBySourceAndUriMap.set(e,o));const d=Yc(s);n=o.get(d),n===void 0&&(n=new Map,o.set(d,n))}return o=>{const{iconPath:d,...c}=o,h=`${e}|${o.id??o.timestamp}`;n?.set(h,o);let g,m,l;o.iconPath&&(d instanceof Et?l={id:d.id,color:d.color}:v.isUri(d)?(g=d,m=d):{light:g,dark:m}=d);let f;return ui.isMarkdownString(c.tooltip)?f=ce.from(c.tooltip):ai(c.tooltip)?f=c.tooltip:ui.isMarkdownString(c.detail)?(console.warn("Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip"),f=ce.from(c.detail)):ai(c.detail)&&(console.warn("Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip"),f=c.detail),{...c,id:c.id??void 0,handle:h,source:e,command:o.command?t.toInternal(o.command,i):void 0,icon:g,iconDark:m,themeIcon:l,tooltip:f,accessibilityInformation:o.accessibilityInformation}}}}registerTimelineProviderCore(e,t){if(this._providers.get(e.id))throw new Error(`Timeline Provider ${e.id} already exists.`);return this._proxy.$registerTimelineProvider({id:e.id,label:e.label,scheme:e.scheme}),this._providers.set(e.id,{provider:e,extension:t}),B(()=>{for(const s of this._itemsBySourceAndUriMap.values())s.get(e.id)?.clear();this._providers.delete(e.id),this._proxy.$unregisterTimelineProvider(e.id),e.dispose()})}}function Yc(a){return a?.toString()}function Zc(a,e){if(ai(a))return{label:a};if(a&&typeof a=="object"&&typeof a.label=="string"){let t;return Array.isArray(a.highlights)&&(t=a.highlights.filter(i=>i.length===2&&typeof i[0]=="number"&&typeof i[1]=="number"),t=t.length?t:void 0),{label:a.label,highlights:t}}}class wx extends X{constructor(e,t,i){super(),this._proxy=e,this.commands=t,this.logService=i,this.treeViews=new Map,this.treeDragAndDropService=new yp;function s(r){return r&&r.$treeViewId&&(r.$treeItemHandle||r.$selectedTreeItems||r.$focusedTreeItem)}t.registerArgumentProcessor({processArgument:r=>s(r)?this.convertArgument(r):Array.isArray(r)&&r.length>0?r.map(n=>s(n)?this.convertArgument(n):n):r})}registerTreeDataProvider(e,t,i){const s=this.createTreeView(e,{treeDataProvider:t},i);return{dispose:()=>s.dispose()}}createTreeView(e,t,i){if(!t||!t.treeDataProvider)throw new Error("Options with treeDataProvider is mandatory");const s=t.dragAndDropController?.dropMimeTypes??[],r=t.dragAndDropController?.dragMimeTypes??[],n=!!t.dragAndDropController?.handleDrag,o=!!t.dragAndDropController?.handleDrop,d=this.createExtHostTreeView(e,t,i),c={showCollapseAll:!!t.showCollapseAll,canSelectMany:!!t.canSelectMany,dropMimeTypes:s,dragMimeTypes:r,hasHandleDrag:n,hasHandleDrop:o,manuallyManageCheckboxes:!!t.manageCheckboxStateManually},h=this._proxy.$registerTreeViewDataProvider(e,c),g={get onDidCollapseElement(){return d.onDidCollapseElement},get onDidExpandElement(){return d.onDidExpandElement},get selection(){return d.selectedElements},get onDidChangeSelection(){return d.onDidChangeSelection},get activeItem(){return b(i,"treeViewActiveItem"),d.focusedElement},get onDidChangeActiveItem(){return b(i,"treeViewActiveItem"),d.onDidChangeActiveItem},get visible(){return d.visible},get onDidChangeVisibility(){return d.onDidChangeVisibility},get onDidChangeCheckboxState(){return d.onDidChangeCheckboxState},get message(){return d.message},set message(m){_l(m)&&b(i,"treeViewMarkdownMessage"),d.message=m},get title(){return d.title},set title(m){d.title=m},get description(){return d.description},set description(m){d.description=m},get badge(){return d.badge},set badge(m){m!==void 0&&fm.isViewBadge(m)?d.badge={value:Math.floor(Math.abs(m.value)),tooltip:m.tooltip}:m===void 0&&(d.badge=void 0)},reveal:(m,l)=>d.reveal(m,l),dispose:async()=>{await h,this.treeViews.delete(e),d.dispose()}};return this._register(g),g}async $getChildren(e,t){const i=this.treeViews.get(e);if(!i)return Promise.reject(new Qe(e));if(!t){const r=await i.getChildren();return r?[[0,...r]]:void 0}const s=[];for(let r=0;r<t.length;r++){const n=t[r],o=await i.getChildren(n);o&&s.push([r,...o])}return s}async $handleDrop(e,t,i,s,r,n,o,d){const c=this.treeViews.get(e);if(!c)return Promise.reject(new Qe(e));const h=nr.toDataTransfer(i,async g=>(await this._proxy.$resolveDropFileData(e,t,g)).buffer);return o===e&&d&&await this.addAdditionalTransferItems(h,c,d,r,n),c.onDrop(h,s,r)}async addAdditionalTransferItems(e,t,i,s,r){const n=this.treeDragAndDropService.removeDragOperationTransfer(r);if(n)(await n)?.forEach((o,d)=>{o&&e.set(d,o)});else if(r&&t.handleDrag){const o=t.handleDrag(i,e,s);this.treeDragAndDropService.addDragOperationTransfer(r,o),await o}return e}async $handleDrag(e,t,i,s){const r=this.treeViews.get(e);if(!r)return Promise.reject(new Qe(e));const n=await this.addAdditionalTransferItems(new ka,r,t,s,i);if(!(!n||s.isCancellationRequested))return nr.from(n)}async $hasResolve(e){const t=this.treeViews.get(e);if(!t)throw new Qe(e);return t.hasResolve}$resolve(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Qe(e);return s.resolveTreeItem(t,i)}$setExpanded(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Qe(e);s.setExpanded(t,i)}$setSelectionAndFocus(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Qe(e);s.setSelectionAndFocus(t,i)}$setVisible(e,t){const i=this.treeViews.get(e);if(!i){if(!t)return;throw new Qe(e)}i.setVisible(t)}$changeCheckboxState(e,t){const i=this.treeViews.get(e);if(!i)throw new Qe(e);i.setCheckboxState(t)}createExtHostTreeView(e,t,i){const s=this._register(new mr(e,t,this._proxy,this.commands.converter,this.logService,i));return this.treeViews.set(e,s),s}convertArgument(e){const t=this.treeViews.get(e.$treeViewId);return t&&"$treeItemHandle"in e?t.getExtensionElement(e.$treeItemHandle):t&&"$focusedTreeItem"in e&&e.$focusedTreeItem?t.focusedElement:null}}class mr extends X{static{this.LABEL_HANDLE_PREFIX="0"}static{this.ID_HANDLE_PREFIX="1"}get visible(){return this._visible}get selectedElements(){return this._selectedHandles.map(e=>this.getExtensionElement(e)).filter(e=>!Ei(e))}get focusedElement(){return this._focusedHandle?this.getExtensionElement(this._focusedHandle):void 0}constructor(e,t,i,s,r,n){if(super(),this.viewId=e,this.proxy=i,this.commands=s,this.logService=r,this.extension=n,this.roots=void 0,this.elements=new Map,this.nodes=new Map,this._visible=!1,this._selectedHandles=[],this._focusedHandle=void 0,this._onDidExpandElement=this._register(new P),this.onDidExpandElement=this._onDidExpandElement.event,this._onDidCollapseElement=this._register(new P),this.onDidCollapseElement=this._onDidCollapseElement.event,this._onDidChangeSelection=this._register(new P),this.onDidChangeSelection=this._onDidChangeSelection.event,this._onDidChangeActiveItem=this._register(new P),this.onDidChangeActiveItem=this._onDidChangeActiveItem.event,this._onDidChangeVisibility=this._register(new P),this.onDidChangeVisibility=this._onDidChangeVisibility.event,this._onDidChangeCheckboxState=this._register(new P),this.onDidChangeCheckboxState=this._onDidChangeCheckboxState.event,this._onDidChangeData=this._register(new P),this.refreshPromise=Promise.resolve(),this.refreshQueue=Promise.resolve(),this._message="",this._title="",this._refreshCancellationSource=new he,n.contributes&&n.contributes.views)for(const h in n.contributes.views)for(const g of n.contributes.views[h])g.id===e&&(this._title=g.name);this.dataProvider=t.treeDataProvider,this.dndController=t.dragAndDropController,this.dataProvider.onDidChangeTreeData&&this._register(this.dataProvider.onDidChangeTreeData(h=>{Array.isArray(h)&&h.length===0||this._onDidChangeData.fire({message:!1,element:h})}));let o,d;const c=Ee.debounce(this._onDidChangeData.event,(h,g)=>(h||(h={message:!1,elements:[]}),g.element!==!1&&(o||(o=new Promise(m=>d=m),this.refreshPromise=this.refreshPromise.then(()=>o)),Array.isArray(g.element)?h.elements.push(...g.element):h.elements.push(g.element)),g.message&&(h.message=!0),h),200,!0);this._register(c(({message:h,elements:g})=>{g.length&&(this.refreshQueue=this.refreshQueue.then(()=>{const m=d;return o=null,this.refresh(g).then(()=>m())})),h&&this.proxy.$setMessage(this.viewId,ce.fromStrict(this._message)??"")}))}async getChildren(e){const t=e?this.getExtensionElement(e):void 0;if(e&&!t)return this.logService.error(`No tree item with id '${e}' found.`),Promise.resolve([]);let i=this.getChildrenNodes(e);return i||(i=await this.fetchChildrenNodes(t)),i?i.map(s=>s.item):void 0}getExtensionElement(e){return this.elements.get(e)}reveal(e,t){t=t||{select:!0,focus:!1};const i=Ei(t.select)?!0:t.select,s=Ei(t.focus)?!1:t.focus,r=Ei(t.expand)?!1:t.expand;return typeof this.dataProvider.getParent!="function"?Promise.reject(new Error("Required registered TreeDataProvider to implement 'getParent' method to access 'reveal' method")):e?this.refreshPromise.then(()=>this.resolveUnknownParentChain(e)).then(n=>this.resolveTreeNode(e,n[n.length-1]).then(o=>this.proxy.$reveal(this.viewId,{item:o.item,parentChain:n.map(d=>d.item)},{select:i,focus:s,expand:r})),n=>this.logService.error(n)):this.proxy.$reveal(this.viewId,void 0,{select:i,focus:s,expand:r})}get message(){return this._message}set message(e){this._message=e,this._onDidChangeData.fire({message:!0,element:!1})}get title(){return this._title}set title(e){this._title=e,this.proxy.$setTitle(this.viewId,e,this._description)}get description(){return this._description}set description(e){this._description=e,this.proxy.$setTitle(this.viewId,this._title,e)}get badge(){return this._badge}set badge(e){this._badge?.value===e?.value&&this._badge?.tooltip===e?.tooltip||(this._badge=Iu.from(e),this.proxy.$setBadge(this.viewId,e))}setExpanded(e,t){const i=this.getExtensionElement(e);i&&(t?this._onDidExpandElement.fire(Object.freeze({element:i})):this._onDidCollapseElement.fire(Object.freeze({element:i})))}setSelectionAndFocus(e,t){const i=!da(this._selectedHandles,e);this._selectedHandles=e;const s=this._focusedHandle!==t;this._focusedHandle=t,i&&this._onDidChangeSelection.fire(Object.freeze({selection:this.selectedElements})),s&&this._onDidChangeActiveItem.fire(Object.freeze({activeItem:this.focusedElement}))}setVisible(e){e!==this._visible&&(this._visible=e,this._onDidChangeVisibility.fire(Object.freeze({visible:this._visible})))}async setCheckboxState(e){const t=(await Promise.all(e.map(async i=>{const s=this.getExtensionElement(i.treeItemHandle);return s?{extensionItem:s,treeItem:await this.dataProvider.getTreeItem(s),newState:i.newState?Yt.Checked:Yt.Unchecked}:Promise.resolve(void 0)}))).filter(i=>i!==void 0);t.forEach(i=>{i.treeItem.checkboxState=i.newState?Yt.Checked:Yt.Unchecked}),this._onDidChangeCheckboxState.fire({items:t.map(i=>[i.extensionItem,i.newState])})}async handleDrag(e,t,i){const s=[];for(const r of e){const n=this.getExtensionElement(r);n&&s.push(n)}if(!(!this.dndController?.handleDrag||s.length===0))return await this.dndController.handleDrag(s,t,i),t}get hasHandleDrag(){return!!this.dndController?.handleDrag}async onDrop(e,t,i){const s=t?this.getExtensionElement(t):void 0;if(!(!s&&t||!this.dndController?.handleDrop))return we(()=>this.dndController?.handleDrop?this.dndController.handleDrop(s,e,i):void 0)}get hasResolve(){return!!this.dataProvider.resolveTreeItem}async resolveTreeItem(e,t){if(!this.dataProvider.resolveTreeItem)return;const i=this.elements.get(e);if(i){const s=this.nodes.get(i);if(s){const r=await this.dataProvider.resolveTreeItem(s.extensionItem,i,t)??s.extensionItem;return this.validateTreeItem(r),s.item.tooltip=this.getTooltip(r.tooltip),s.item.command=this.getCommand(s.disposableStore,r.command),s.item}}}resolveUnknownParentChain(e){return this.resolveParent(e).then(t=>t?this.resolveUnknownParentChain(t).then(i=>this.resolveTreeNode(t,i[i.length-1]).then(s=>(i.push(s),i))):Promise.resolve([]))}resolveParent(e){const t=this.nodes.get(e);return t?Promise.resolve(t.parent?this.elements.get(t.parent.item.handle):void 0):we(()=>this.dataProvider.getParent(e))}resolveTreeNode(e,t){const i=this.nodes.get(e);return i?Promise.resolve(i):we(()=>this.dataProvider.getTreeItem(e)).then(s=>this.createHandle(e,s,t,!0)).then(s=>this.getChildren(t?t.item.handle:void 0).then(()=>{const r=this.getExtensionElement(s);if(r){const n=this.nodes.get(r);if(n)return Promise.resolve(n)}throw new Error(`Cannot resolve tree item for element ${s} from extension ${this.extension.identifier.value}`)}))}getChildrenNodes(e){if(e){let t;if(typeof e=="string"){const i=this.getExtensionElement(e);t=i?this.nodes.get(i):void 0}else t=e;return t&&t.children||void 0}return this.roots}async fetchChildrenNodes(e){this.clearChildren(e);const t=new he(this._refreshCancellationSource.token);try{const i=e?this.nodes.get(e):void 0,s=await this.dataProvider.getChildren(e);if(t.token.isCancellationRequested)return;const r=Re(s||[]),n=await Promise.all(Re(r).map(d=>this.dataProvider.getTreeItem(d)));if(t.token.isCancellationRequested)return;const o=n.map((d,c)=>d?this.createAndRegisterTreeNode(r[c],d,i):null);return Re(o)}finally{t.dispose()}}refresh(e){if(e.some(i=>!i))return this._refreshCancellationSource.dispose(!0),this._refreshCancellationSource=new he,this.clearAll(),this.proxy.$refresh(this.viewId);{const i=this.getHandlesToRefresh(e);if(i.length)return this.refreshHandles(i)}return Promise.resolve(void 0)}getHandlesToRefresh(e){const t=new Set,i=e.map(r=>this.nodes.get(r));for(const r of i)if(r&&!t.has(r.item.handle)){let n=r;for(;n&&n.parent&&i.findIndex(o=>n&&n.parent&&o&&o.item.handle===n.parent.item.handle)===-1;){const o=this.elements.get(n.parent.item.handle);n=o?this.nodes.get(o):void 0}n&&!n.parent&&t.add(r.item.handle)}const s=[];return t.forEach(r=>{const n=this.elements.get(r);if(n){const o=this.nodes.get(n);o&&(!o.parent||!t.has(o.parent.item.handle))&&s.push(r)}}),s}refreshHandles(e){const t={};return Promise.all(e.map(i=>this.refreshNode(i).then(s=>{s&&(t[i]=s.item)}))).then(()=>Object.keys(t).length?this.proxy.$refresh(this.viewId,t):void 0)}refreshNode(e){const t=this.getExtensionElement(e);if(t){const i=this.nodes.get(t);if(i)return this.clearChildren(t),we(()=>this.dataProvider.getTreeItem(t)).then(s=>{if(s){const r=this.createTreeNode(t,s,i.parent);return this.updateNodeCache(t,r,i,i.parent),i.dispose(),r}return null})}return Promise.resolve(null)}createAndRegisterTreeNode(e,t,i){const s=this.createTreeNode(e,t,i);if(t.id&&this.elements.has(s.item.handle))throw new Error(J(2570,"Element with id {0} is already registered",t.id));return this.addNodeToCache(e,s),this.addNodeToParentCache(s,i),s}getTooltip(e){return ui.isMarkdownString(e)?ce.from(e):e}getCommand(e,t){return t?{...this.commands.toInternal(t,e),originalId:t.command}:void 0}getCheckbox(e){if(e.checkboxState===void 0)return;let t,i,s;return typeof e.checkboxState=="number"?t=e.checkboxState:(t=e.checkboxState.state,i=e.checkboxState.tooltip,s=e.checkboxState.accessibilityInformation),{isChecked:t===Yt.Checked,tooltip:i,accessibilityInformation:s}}validateTreeItem(e){if(!Ru.isTreeItem(e,this.extension))throw new Error(`Extension ${this.extension.identifier.value} has provided an invalid tree item.`)}createTreeNode(e,t,i){this.validateTreeItem(t);const s=this._register(new N),r=this.createHandle(e,t,i),n=this.getLightIconPath(t);return{item:{handle:r,parentHandle:i?i.item.handle:void 0,label:Zc(t.label),description:t.description,resourceUri:t.resourceUri,tooltip:this.getTooltip(t.tooltip),command:this.getCommand(s,t.command),contextValue:t.contextValue,icon:n,iconDark:this.getDarkIconPath(t)||n,themeIcon:this.getThemeIcon(t),collapsibleState:Ei(t.collapsibleState)?Au.None:t.collapsibleState,accessibilityInformation:t.accessibilityInformation,checkbox:this.getCheckbox(t)},extensionItem:t,parent:i,children:void 0,disposableStore:s,dispose(){s.dispose()}}}getThemeIcon(e){return e.iconPath instanceof Et?e.iconPath:void 0}createHandle(e,{id:t,label:i,resourceUri:s},r,n){if(t)return`${mr.ID_HANDLE_PREFIX}/${t}`;const o=Zc(i),d=r?r.item.handle:mr.LABEL_HANDLE_PREFIX;let c=o?o.label:s?il(s):"";c=c.indexOf("/")!==-1?c.replace("/","//"):c;const h=this.nodes.has(e)?this.nodes.get(e).item.handle:void 0,g=this.getChildrenNodes(r)||[];let m,l=0;do{if(m=`${d}/${l}:${c}`,n||!this.elements.has(m)||h===m)break;l++}while(l<=g.length);return m}getLightIconPath(e){if(e.iconPath&&!(e.iconPath instanceof Et))return typeof e.iconPath=="string"||v.isUri(e.iconPath)?this.getIconPath(e.iconPath):this.getIconPath(e.iconPath.light)}getDarkIconPath(e){if(e.iconPath&&!(e.iconPath instanceof Et)&&e.iconPath.dark)return this.getIconPath(e.iconPath.dark)}getIconPath(e){return v.isUri(e)?e:v.file(e)}addNodeToCache(e,t){this.elements.set(t.item.handle,e),this.nodes.set(e,t)}updateNodeCache(e,t,i,s){this.elements.delete(t.item.handle),this.nodes.delete(e),t.item.handle!==i.item.handle&&this.elements.delete(i.item.handle),this.addNodeToCache(e,t);const r=this.getChildrenNodes(s)||[],n=r.filter(o=>o.item.handle===i.item.handle)[0];n&&r.splice(r.indexOf(n),1,t)}addNodeToParentCache(e,t){t?(t.children||(t.children=[]),t.children.push(e)):(this.roots||(this.roots=[]),this.roots.push(e))}clearChildren(e){if(e){const t=this.nodes.get(e);if(t){if(t.children)for(const i of t.children){const s=this.elements.get(i.item.handle);s&&this.clear(s)}t.children=void 0}}else this.clearAll()}clear(e){const t=this.nodes.get(e);if(t){if(t.children)for(const i of t.children){const s=this.elements.get(i.item.handle);s&&this.clear(s)}this.nodes.delete(e),this.elements.delete(t.item.handle),t.dispose()}}clearAll(){this.roots=void 0,this.elements.clear(),this.nodes.forEach(e=>e.dispose()),this.nodes.clear()}dispose(){super.dispose(),this._refreshCancellationSource.dispose(),this.clearAll(),this.proxy.$disposeTree(this.viewId)}}class Xa{static{this.supportedSchemes=new Set([q.http,q.https])}constructor(e){this._openers=new Map,this._proxy=e.getProxy(k.MainThreadUriOpeners)}registerExternalUriOpener(e,t,i,s){if(this._openers.has(t))throw new Error(`Opener with id '${t}' already registered`);const r=s.schemes.find(n=>!Xa.supportedSchemes.has(n));if(r)throw new Error(`Scheme '${r}' is not supported. Only http and https are currently supported.`);return this._openers.set(t,i),this._proxy.$registerUriOpener(t,s.schemes,e,s.label),B(()=>{this._openers.delete(t),this._proxy.$unregisterUriOpener(t)})}async $canOpenUri(e,t,i){const s=this._openers.get(e);if(!s)throw new Error(`Unknown opener with id: ${e}`);const r=v.revive(t);return s.canOpenExternalUri(r,i)}async $openUri(e,t,i){const s=this._openers.get(e);if(!s)throw new Error(`Unknown opener id: '${e}'`);return s.openExternalUri(v.revive(t.resolvedUri),{sourceUri:v.revive(t.sourceUri)},i)}}class Ya{static{this.HandlePool=0}constructor(e){this.handles=new ss,this.handlers=new Map,this._proxy=e.getProxy(k.MainThreadUrls)}registerUriHandler(e,t){const i=e.identifier;if(this.handles.has(i))throw new Error(`Protocol handler already registered for extension ${i}`);const s=Ya.HandlePool++;return this.handles.add(i),this.handlers.set(s,t),this._proxy.$registerUriHandler(s,i,e.displayName||e.name),B(()=>{this.handles.delete(i),this.handlers.delete(s),this._proxy.$unregisterUriHandler(s)})}$handleExternalUri(e,t){const i=this.handlers.get(e);if(!i)return Promise.resolve(void 0);try{i.handleUri(v.revive(t))}catch(s){fa(s)}return Promise.resolve(void 0)}async createAppUri(e){return v.revive(await this._proxy.$createAppUri(e))}}class xx extends X{#e;#t;#i;#s;#n;#r;#a;#o;#d;#c;#l;#h;#u;constructor(e,t,i,s){super(),this.#o=void 0,this.#d=!0,this.#l=!1,this.#h=this._register(new P),this.onDidDispose=this.#h.event,this.#u=this._register(new P),this.onDidChangeViewState=this.#u.event,this.#e=e,this.#t=t,this.#s=i,this.#i=s.viewType,this.#n=s.panelOptions,this.#o=s.viewColumn,this.#r=s.title,this.#c=s.active}dispose(){this.#l||(this.#l=!0,this.#h.fire(),this.#t.$disposeWebview(this.#e),this.#s.dispose(),super.dispose())}get webview(){return this.assertNotDisposed(),this.#s}get viewType(){return this.assertNotDisposed(),this.#i}get title(){return this.assertNotDisposed(),this.#r}set title(e){this.assertNotDisposed(),this.#r!==e&&(this.#r=e,this.#t.$setTitle(this.#e,e))}get iconPath(){return this.assertNotDisposed(),this.#a}set iconPath(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#t.$setIconPath(this.#e,v.isUri(e)?{light:e,dark:e}:e))}get options(){return this.#n}get viewColumn(){if(this.assertNotDisposed(),!(typeof this.#o=="number"&&this.#o<0))return this.#o}get active(){return this.assertNotDisposed(),this.#c}get visible(){return this.assertNotDisposed(),this.#d}_updateViewState(e){this.#l||(this.active!==e.active||this.visible!==e.visible||this.viewColumn!==e.viewColumn)&&(this.#c=e.active,this.#d=e.visible,this.#o=e.viewColumn,this.#u.fire({webviewPanel:this}))}reveal(e,t){this.assertNotDisposed(),this.#t.$reveal(this.#e,{viewColumn:typeof e>"u"?void 0:ye.from(e),preserveFocus:!!t})}assertNotDisposed(){if(this.#l)throw new Error("Webview is disposed")}}class Za extends X{static newHandle(){return it()}constructor(e,t,i){super(),this.webviews=t,this.workspace=i,this._webviewPanels=new Map,this._serializers=new Map,this._proxy=e.getProxy(k.MainThreadWebviewPanels)}dispose(){super.dispose(),this._webviewPanels.forEach(e=>e.dispose()),this._webviewPanels.clear()}createWebviewPanel(e,t,i,s,r={}){const n=typeof s=="object"?s.viewColumn:s,o={viewColumn:ye.from(n),preserveFocus:typeof s=="object"&&!!s.preserveFocus},d=hi(e),c=Za.newHandle();this._proxy.$createWebviewPanel(hr(e),c,t,{title:i,panelOptions:bx(r),webviewOptions:rh(e,this.workspace,r),serializeBuffersForPostMessage:d},o);const h=this.webviews.createNewWebview(c,r,e);return this.createNewWebviewPanel(c,t,i,n,r,h,!0)}$onDidChangeWebviewPanelViewStates(e){const t=Object.keys(e);t.sort((i,s)=>{const r=e[i],n=e[s];return r.active?1:n.active?-1:+r.visible-+n.visible});for(const i of t){const s=this.getWebviewPanel(i);if(!s)continue;const r=e[i];s._updateViewState({active:r.active,visible:r.visible,viewColumn:ye.to(r.position)})}}async $onDidDisposeWebviewPanel(e){this.getWebviewPanel(e)?.dispose(),this._webviewPanels.delete(e),this.webviews.deleteWebview(e)}registerWebviewPanelSerializer(e,t,i){if(this._serializers.has(t))throw new Error(`Serializer for '${t}' already registered`);return this._serializers.set(t,{serializer:i,extension:e}),this._proxy.$registerSerializer(t,{serializeBuffersForPostMessage:hi(e)}),new V(()=>{this._serializers.delete(t),this._proxy.$unregisterSerializer(t)})}async $deserializeWebviewPanel(e,t,i,s){const r=this._serializers.get(t);if(!r)throw new Error(`No serializer found for '${t}'`);const{serializer:n,extension:o}=r,d=this.webviews.createNewWebview(e,i.webviewOptions,o),c=this.createNewWebviewPanel(e,t,i.title,s,i.panelOptions,d,i.active);await n.deserializeWebviewPanel(c,i.state)}createNewWebviewPanel(e,t,i,s,r,n,o){const d=new xx(e,this._proxy,n,{viewType:t,title:i,viewColumn:s,panelOptions:r,active:o});return this._webviewPanels.set(e,d),d}getWebviewPanel(e){return this._webviewPanels.get(e)}}function bx(a){return{enableFindWidget:a.enableFindWidget,retainContextWhenHidden:a.retainContextWhenHidden}}class Ex extends X{#e;#t;#i;#s;#n;#r;#a;#o;#d;constructor(e,t,i,s,r,n){super(),this.#n=!1,this.#c=this._register(new P),this.onDidChangeVisibility=this.#c.event,this.#l=this._register(new P),this.onDidDispose=this.#l.event,this.#i=i,this.#a=s,this.#e=e,this.#t=t,this.#s=r,this.#r=n}dispose(){this.#n||(this.#n=!0,this.#l.fire(),this.#s.dispose(),super.dispose())}#c;#l;get title(){return this.assertNotDisposed(),this.#a}set title(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#t.$setWebviewViewTitle(this.#e,e))}get description(){return this.assertNotDisposed(),this.#o}set description(e){this.assertNotDisposed(),this.#o!==e&&(this.#o=e,this.#t.$setWebviewViewDescription(this.#e,e))}get visible(){return this.#r}get webview(){return this.#s}get viewType(){return this.#i}_setVisible(e){e===this.#r||this.#n||(this.#r=e,this.#c.fire())}get badge(){return this.assertNotDisposed(),this.#d}set badge(e){this.assertNotDisposed(),!(e?.value===this.#d?.value&&e?.tooltip===this.#d?.tooltip)&&(this.#d=Iu.from(e),this.#t.$setWebviewViewBadge(this.#e,e))}show(e){this.assertNotDisposed(),this.#t.$show(this.#e,!!e)}assertNotDisposed(){if(this.#n)throw new Error("Webview is disposed")}}class Sx{constructor(e,t){this._extHostWebview=t,this._viewProviders=new Map,this._webviewViews=new Map,this._proxy=e.getProxy(k.MainThreadWebviewViews)}registerWebviewViewProvider(e,t,i,s){if(this._viewProviders.has(t))throw new Error(`View provider for '${t}' already registered`);return this._viewProviders.set(t,{provider:i,extension:e}),this._proxy.$registerWebviewViewProvider(hr(e),t,{retainContextWhenHidden:s?.retainContextWhenHidden,serializeBuffersForPostMessage:hi(e)}),new V(()=>{this._viewProviders.delete(t),this._proxy.$unregisterWebviewViewProvider(t)})}async $resolveWebviewView(e,t,i,s,r){const n=this._viewProviders.get(t);if(!n)throw new Error(`No view provider found for '${t}'`);const{provider:o,extension:d}=n,c=this._extHostWebview.createNewWebview(e,{},d),h=new Ex(e,this._proxy,t,i,c,!0);this._webviewViews.set(e,h),await o.resolveWebviewView(h,{state:s},r)}async $onDidChangeWebviewViewVisibility(e,t){this.getWebviewView(e)._setVisible(t)}async $disposeWebviewView(e){const t=this.getWebviewView(e);this._webviewViews.delete(e),t.dispose(),this._extHostWebview.deleteWebview(e)}getWebviewView(e){const t=this._webviewViews.get(e);if(!t)throw new Error("No webview found");return t}}class Cx{constructor(e){this._settingsSearchProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiSettingsSearch)}async $startSearch(e,t,i,s){if(this._settingsSearchProviders.size===0)throw new Error("No related information providers registered");const r=this._settingsSearchProviders.get(e);if(!r)throw new Error("Settings search provider not found");const n=new la(o=>{this._proxy.$handleSearchResult(e,pm.fromSettingsSearchResult(o))});return r.provideSettingsSearchResults(t,i,n,s)}registerSettingsSearchProvider(e,t){const i=this._nextHandle;return this._nextHandle++,this._settingsSearchProviders.set(i,t),this._proxy.$registerAiSettingsSearchProvider(i),new V(()=>{this._proxy.$unregisterAiSettingsSearchProvider(i),this._settingsSearchProviders.delete(i)})}}function Dx(a){const e=a.get(Se),t=a.get(pi),i=a.get(xr),s=a.get(Wt),r=a.get(st),n=a.get(Aa),o=a.get(rt),d=a.get(br),c=a.get(j),h=a.get(Ma),g=a.get(zu),m=a.get(fi),l=a.get(re),f=a.get(Sa),_=a.get(Er),x=a.get(eh),C=a.get(La),S=a.get(os),T=a.get(Oa),O=a.get(Ha),I=a.get(Fa),K=a.get(Oo);c.set(R.ExtHostFileSystemInfo,t),c.set(R.ExtHostLogLevelServiceShape,m),c.set(R.ExtHostWorkspace,r),c.set(R.ExtHostConfiguration,o),c.set(R.ExtHostExtensionService,s),c.set(R.ExtHostStorage,h),c.set(R.ExtHostTunnelService,f),c.set(R.ExtHostWindow,x),c.set(R.ExtHostSecretState,C),c.set(R.ExtHostTelemetry,n),c.set(R.ExtHostEditorTabs,S),c.set(R.ExtHostManagedSockets,T),c.set(R.ExtHostAuthentication,O),c.set(R.ExtHostChatProvider,I);const ie=c.set(R.ExtHostDecorations,a.get(Lu)),W=c.set(R.ExtHostDocumentsAndEditors,a.get(gi)),se=c.set(R.ExtHostCommands,a.get(Ut)),Q=c.set(R.ExtHostTerminalService,a.get(mi)),me=c.set(R.ExtHostTerminalShellIntegration,a.get(th)),le=c.set(R.ExtHostDebugService,a.get(Ju)),Bt=c.set(R.ExtHostSearch,a.get(Zu)),Ne=c.set(R.ExtHostTask,a.get(Wu)),ah=c.set(R.ExtHostOutputService,a.get(Hu)),as=c.set(R.ExtHostLocalization,a.get(Na)),ed=c.set(R.ExtHostUrls,new Ya(c)),Ce=c.set(R.ExtHostDocuments,new Fw(c,W)),dh=c.set(R.ExtHostDocumentContentProviders,new Va(c,W,l)),ch=c.set(R.ExtHostDocumentSaveParticipant,new Hw(l,Ce,c.getProxy(k.MainThreadBulkEdits))),pe=c.set(R.ExtHostNotebook,new ii(c,se,W,Ce,i,Bt,l)),td=c.set(R.ExtHostNotebookDocuments,new Zw(pe)),id=c.set(R.ExtHostNotebookEditors,new Qo(l,pe)),ds=c.set(R.ExtHostNotebookKernels,new Jo(c,e,pe,se,l)),lh=c.set(R.ExtHostNotebookRenderers,new sx(c,pe)),uh=c.set(R.ExtHostNotebookDocumentSaveParticipant,new Yw(l,pe,c.getProxy(k.MainThreadBulkEdits))),ke=c.set(R.ExtHostEditors,new vx(c,W)),sd=c.set(R.ExtHostTreeViews,new wx(c.getProxy(k.MainThreadTreeViews),se,l)),hh=c.set(R.ExtHostEditorInsets,new ww(c.getProxy(k.MainThreadEditorInsets),ke,e.remote)),vi=c.set(R.ExtHostDiagnostics,new zo(c,l,t,W)),cs=c.set(R.ExtHostLanguages,new Qw(c,Ce,se.converter,d)),z=c.set(R.ExtHostLanguageFeatures,new fe(c,d,Ce,se,vi,l,_,n)),fh=c.set(R.ExtHostCodeMapper,new Ba(c)),ph=c.set(R.ExtHostFileSystem,new pr(c,z)),St=c.set(R.ExtHostFileSystemEventService,new Vw(c,l,W)),yi=c.set(R.ExtHostQuickOpen,ax(c,r,se)),rd=c.set(R.ExtHostSCM,new Zo(c,se,Ce,l)),gh=c.set(R.ExtHostQuickDiff,new Ka(c,d)),mh=c.set(R.ExtHostShare,new Qa(c,d)),_h=c.set(R.ExtHostComments,xw(c,se,Ce)),nd=c.set(R.ExtHostProgress,new nx(c.getProxy(k.MainThreadProgress))),vh=c.set(R.ExtHostLabelService,new qw(c)),od=c.set(R.ExtHostTheming,new ea(c)),yh=c.set(R.ExtHostTimeline,new yx(c,se)),Pr=c.set(R.ExtHostWebviews,new Sw(c,e.remote,r,l,_)),Tr=c.set(R.ExtHostWebviewPanels,new Za(c,Pr,r)),wh=c.set(R.ExtHostCustomEditors,new Iw(c,Ce,g,Pr,Tr)),xh=c.set(R.ExtHostWebviewViews,new Sx(c,Pr)),Vt=c.set(R.ExtHostTesting,a.get(Cr)),bh=c.set(R.ExtHostUriOpeners,new Xa(c)),Eh=c.set(R.ExtHostProfileContentHandlers,new rx(c));c.set(R.ExtHostInteractive,new zw(c,pe,W,se,l));const ls=c.set(R.ExtHostLanguageModelTools,new Gw(c,I)),zt=c.set(R.ExtHostChatAgents2,new ti(c,l,se,Ce,I,vi,ls)),ad=c.set(R.ExtHostAiRelatedInformation,new cw(c)),Sh=c.set(R.ExtHostAiEmbeddingVector,new Nw(c)),Ch=c.set(R.ExtHostAiSettingsSearch,new Cx(c)),dd=c.set(R.ExtHostStatusBar,new _x(c,se.converter)),Dh=c.set(R.ExtHostSpeech,new Ja(c)),wi=c.set(R.ExtHostEmbeddings,new Lw(c));c.set(R.ExtHostMcp,a.get(Oo));const Ph=Object.values(R);c.assertRegistered(Ph);const Th=new Bo(c,W),kh=new _w(c),kr=new Ko(c,l),cd=new Mw(c),Ih=new gw(c);return uw.register(se),function(w,nt,Ir){function A(u){return(p,y,F)=>{const Y=u(_e=>{try{p.call(y,_e)}catch(Gh){vl(new fl(w.identifier,Gh,"FAILED to handle event"))}});return F?.push(Y),Y}}const G=function(){let u=!w.isUnderDevelopment;function p(){u||(l.info(`Extension '${w.identifier.value}' uses a document selector without scheme. Learn more about this: https://go.microsoft.com/fwlink/?linkid=872305`),u=!0)}return function y(F){if(Array.isArray(F))F.forEach(y);else if(typeof F=="string")p();else{const Y=F;typeof Y.scheme>"u"&&p(),typeof Y.exclusive=="boolean"&&b(w,"documentFiltersExclusive")}return F}}(),Rh={getSession(u,p,y){return(typeof y?.forceNewSession=="object"&&y.forceNewSession.learnMore||typeof y?.createIfNone=="object"&&y.createIfNone.learnMore)&&b(w,"authLearnMore"),O.getSession(w,u,p,y)},getAccounts(u){return O.getAccounts(u)},async hasSession(u,p){return b(w,"authSession"),!!await O.getSession(w,u,p,{silent:!0})},get onDidChangeSessions(){return A(O.getExtensionScopedSessionsEvent(w.identifier.value))},registerAuthenticationProvider(u,p,y,F){return O.registerAuthenticationProvider(u,p,y,F)}},Ah={registerCommand(u,p,y){return se.registerCommand(!0,u,p,y,void 0,w)},registerTextEditorCommand(u,p,y){return se.registerCommand(!0,u,(...F)=>{const Y=ke.getActiveTextEditor();if(!Y){l.warn("Cannot execute "+u+" because there is no active text editor.");return}return Y.edit(_e=>{p.apply(y,[Y,_e,...F])}).then(_e=>{_e||l.warn("Edits from command "+u+" were not applied.")},_e=>{l.warn("An error occurred while running command "+u,_e)})},void 0,void 0,w)},registerDiffInformationCommand:(u,p,y)=>(b(w,"diffCommand"),se.registerCommand(!0,u,async(...F)=>{const Y=W.activeEditor(!0);if(!Y){l.warn("Cannot execute "+u+" because there is no active text editor.");return}const _e=await ke.getDiffInformation(Y.id);p.apply(y,[_e,...F])},void 0,void 0,w)),executeCommand(u,...p){return se.executeCommand(u,...p)},getCommands(u=!1){return se.getCommands(u)}},$h={get machineId(){return e.telemetryInfo.machineId},get sessionId(){return e.telemetryInfo.sessionId},get language(){return e.environment.appLanguage},get appName(){return e.environment.appName},get appRoot(){return e.environment.appRoot?.fsPath??""},get appHost(){return e.environment.appHost},get uriScheme(){return e.environment.appUriScheme},get clipboard(){return kh.value},get shell(){return Q.getDefaultShell(!1)},get onDidChangeShell(){return A(Q.onDidChangeShell)},get isTelemetryEnabled(){return n.getTelemetryConfiguration()},get onDidChangeTelemetryEnabled(){return A(n.onDidChangeTelemetryEnabled)},get telemetryConfiguration(){return b(w,"telemetry"),n.getTelemetryDetails()},get onDidChangeTelemetryConfiguration(){return b(w,"telemetry"),A(n.onDidChangeTelemetryConfiguration)},get isNewAppInstall(){return Ou(e.telemetryInfo.firstSessionDate)},createTelemetryLogger(u,p){return Nu.validateSender(u),n.instantiateLogger(w,u,p)},openExternal(u,p){return x.openUri(u,{allowTunneling:!!e.remote.authority,allowContributedOpeners:p?.allowContributedOpeners})},async asExternalUri(u){if(u.scheme===e.environment.appUriScheme)return ed.createAppUri(u);try{return await x.asExternalUri(u,{allowTunneling:!!e.remote.authority})}catch(p){if(Hd(u,q.http)||Hd(u,q.https))return u;throw p}},get remoteName(){return nl(e.remote.authority)},get remoteAuthority(){return b(w,"resolvers"),e.remote.authority},get uiKind(){return e.uiKind},get logLevel(){return l.getLevel()},get onDidChangeLogLevel(){return A(l.onDidChangeLogLevel)},get appQuality(){return b(w,"resolvers"),e.quality},get appCommit(){return b(w,"resolvers"),e.commit}},Mh={createTestController(u,p,y){return Vt.createTestController(w,u,p,y)},createTestObserver(){return b(w,"testObserver"),Vt.createTestObserver()},runTests(u){return b(w,"testObserver"),Vt.runTests(u)},registerTestFollowupProvider(u){return b(w,"testObserver"),Vt.registerTestFollowupProvider(u)},get onDidChangeTestResults(){return b(w,"testObserver"),A(Vt.onResultsChanged)},get testResults(){return b(w,"testObserver"),Vt.results}},us=e.remote.isRemote?Wi.Workspace:Wi.UI,Hh={getExtension(u,p){te(w,"extensionsAny")||(p=!1);const y=nt.mine.getExtensionDescription(u);if(y)return new Mi(s,w.identifier,y,us,!1);if(p){const F=nt.all.getExtensionDescription(u);if(F)return new Mi(s,w.identifier,F,us,!0)}},get all(){const u=[];for(const p of nt.mine.getAllExtensionDescriptions())u.push(new Mi(s,w.identifier,p,us,!1));return u},get allAcrossExtensionHosts(){b(w,"extensionsAny");const u=new ss(nt.mine.getAllExtensionDescriptions().map(y=>y.identifier)),p=[];for(const y of nt.all.getAllExtensionDescriptions()){const F=!u.has(y.identifier);p.push(new Mi(s,w.identifier,y,us,F))}return p},get onDidChange(){return te(w,"extensionsAny")?A(Ee.any(nt.mine.onDidChange,nt.all.onDidChange)):A(nt.mine.onDidChange)}},Fh={createDiagnosticCollection(u){return vi.createDiagnosticCollection(w.identifier,u)},get onDidChangeDiagnostics(){return A(vi.onDidChangeDiagnostics)},getDiagnostics:u=>vi.getDiagnostics(u),getLanguages(){return cs.getLanguages()},setTextDocumentLanguage(u,p){return cs.changeLanguage(u.uri,p)},match(u,p){const y=Nv.from(u);let F;return Ov(y)&&(F=pe.notebookDocuments.find(Y=>Y.apiNotebook.getCells().find(_e=>_e.document===p))?.apiNotebook),Uv(y,p.uri,p.languageId,!0,F?.uri,F?.notebookType)},registerCodeActionsProvider(u,p,y){return z.registerCodeActionProvider(w,G(u),p,y)},registerDocumentPasteEditProvider(u,p,y){return z.registerDocumentPasteEditProvider(w,G(u),p,y)},registerCodeLensProvider(u,p){return z.registerCodeLensProvider(w,G(u),p)},registerDefinitionProvider(u,p){return z.registerDefinitionProvider(w,G(u),p)},registerDeclarationProvider(u,p){return z.registerDeclarationProvider(w,G(u),p)},registerImplementationProvider(u,p){return z.registerImplementationProvider(w,G(u),p)},registerTypeDefinitionProvider(u,p){return z.registerTypeDefinitionProvider(w,G(u),p)},registerHoverProvider(u,p){return z.registerHoverProvider(w,G(u),p,w.identifier)},registerEvaluatableExpressionProvider(u,p){return z.registerEvaluatableExpressionProvider(w,G(u),p,w.identifier)},registerInlineValuesProvider(u,p){return z.registerInlineValuesProvider(w,G(u),p,w.identifier)},registerDocumentHighlightProvider(u,p){return z.registerDocumentHighlightProvider(w,G(u),p)},registerMultiDocumentHighlightProvider(u,p){return z.registerMultiDocumentHighlightProvider(w,G(u),p)},registerLinkedEditingRangeProvider(u,p){return z.registerLinkedEditingRangeProvider(w,G(u),p)},registerReferenceProvider(u,p){return z.registerReferenceProvider(w,G(u),p)},registerRenameProvider(u,p){return z.registerRenameProvider(w,G(u),p)},registerNewSymbolNamesProvider(u,p){return b(w,"newSymbolNamesProvider"),z.registerNewSymbolNamesProvider(w,G(u),p)},registerDocumentSymbolProvider(u,p,y){return z.registerDocumentSymbolProvider(w,G(u),p,y)},registerWorkspaceSymbolProvider(u){return z.registerWorkspaceSymbolProvider(w,u)},registerDocumentFormattingEditProvider(u,p){return z.registerDocumentFormattingEditProvider(w,G(u),p)},registerDocumentRangeFormattingEditProvider(u,p){return z.registerDocumentRangeFormattingEditProvider(w,G(u),p)},registerOnTypeFormattingEditProvider(u,p,y,...F){return z.registerOnTypeFormattingEditProvider(w,G(u),p,[y].concat(F))},registerDocumentSemanticTokensProvider(u,p,y){return z.registerDocumentSemanticTokensProvider(w,G(u),p,y)},registerDocumentRangeSemanticTokensProvider(u,p,y){return z.registerDocumentRangeSemanticTokensProvider(w,G(u),p,y)},registerSignatureHelpProvider(u,p,y,...F){return typeof y=="object"?z.registerSignatureHelpProvider(w,G(u),p,y):z.registerSignatureHelpProvider(w,G(u),p,typeof y>"u"?[]:[y,...F])},registerCompletionItemProvider(u,p,...y){return z.registerCompletionItemProvider(w,G(u),p,y)},registerInlineCompletionItemProvider(u,p,y){return p.handleDidShowCompletionItem&&b(w,"inlineCompletionsAdditions"),p.handleDidPartiallyAcceptCompletionItem&&b(w,"inlineCompletionsAdditions"),y&&b(w,"inlineCompletionsAdditions"),z.registerInlineCompletionsProvider(w,G(u),p,y)},registerInlineEditProvider(u,p){return b(w,"inlineEdit"),z.registerInlineEditProvider(w,G(u),p)},registerDocumentLinkProvider(u,p){return z.registerDocumentLinkProvider(w,G(u),p)},registerColorProvider(u,p){return z.registerColorProvider(w,G(u),p)},registerFoldingRangeProvider(u,p){return z.registerFoldingRangeProvider(w,G(u),p)},registerSelectionRangeProvider(u,p){return z.registerSelectionRangeProvider(w,u,p)},registerCallHierarchyProvider(u,p){return z.registerCallHierarchyProvider(w,u,p)},registerTypeHierarchyProvider(u,p){return z.registerTypeHierarchyProvider(w,u,p)},setLanguageConfiguration:(u,p)=>z.setLanguageConfiguration(w,u,p),getTokenInformationAtPosition(u,p){return b(w,"tokenInformation"),cs.tokenAtPosition(u,p)},registerInlayHintsProvider(u,p){return z.registerInlayHintsProvider(w,u,p)},createLanguageStatusItem(u,p){return cs.createLanguageStatusItem(w,u,p)},registerDocumentDropEditProvider(u,p,y){return z.registerDocumentOnDropEditProvider(w,u,p,y)}},Lh={get activeTextEditor(){return ke.getActiveTextEditor()},get visibleTextEditors(){return ke.getVisibleTextEditors()},get activeTerminal(){return Q.activeTerminal},get terminals(){return Q.terminals},async showTextDocument(u,p,y){v.isUri(u)&&u.scheme===q.vscodeRemote&&!u.authority&&_.report("workspace.showTextDocument",w,"A URI of 'vscode-remote' scheme requires an authority.");const F=await(v.isUri(u)?Promise.resolve(ld.openTextDocument(u)):Promise.resolve(u));return ke.showTextDocument(F,p,y)},createTextEditorDecorationType(u){return ke.createTextEditorDecorationType(w,u)},onDidChangeActiveTextEditor(u,p,y){return A(ke.onDidChangeActiveTextEditor)(u,p,y)},onDidChangeVisibleTextEditors(u,p,y){return A(ke.onDidChangeVisibleTextEditors)(u,p,y)},onDidChangeTextEditorSelection(u,p,y){return A(ke.onDidChangeTextEditorSelection)(u,p,y)},onDidChangeTextEditorOptions(u,p,y){return A(ke.onDidChangeTextEditorOptions)(u,p,y)},onDidChangeTextEditorVisibleRanges(u,p,y){return A(ke.onDidChangeTextEditorVisibleRanges)(u,p,y)},onDidChangeTextEditorViewColumn(u,p,y){return A(ke.onDidChangeTextEditorViewColumn)(u,p,y)},onDidChangeTextEditorDiffInformation(u,p,y){return b(w,"textEditorDiffInformation"),A(ke.onDidChangeTextEditorDiffInformation)(u,p,y)},onDidCloseTerminal(u,p,y){return A(Q.onDidCloseTerminal)(u,p,y)},onDidOpenTerminal(u,p,y){return A(Q.onDidOpenTerminal)(u,p,y)},onDidChangeActiveTerminal(u,p,y){return A(Q.onDidChangeActiveTerminal)(u,p,y)},onDidChangeTerminalDimensions(u,p,y){return b(w,"terminalDimensions"),A(Q.onDidChangeTerminalDimensions)(u,p,y)},onDidChangeTerminalState(u,p,y){return A(Q.onDidChangeTerminalState)(u,p,y)},onDidWriteTerminalData(u,p,y){return b(w,"terminalDataWriteEvent"),A(Q.onDidWriteTerminalData)(u,p,y)},onDidExecuteTerminalCommand(u,p,y){return b(w,"terminalExecuteCommandEvent"),A(Q.onDidExecuteTerminalCommand)(u,p,y)},onDidChangeTerminalShellIntegration(u,p,y){return A(me.onDidChangeTerminalShellIntegration)(u,p,y)},onDidStartTerminalShellExecution(u,p,y){return A(me.onDidStartTerminalShellExecution)(u,p,y)},onDidEndTerminalShellExecution(u,p,y){return A(me.onDidEndTerminalShellExecution)(u,p,y)},get state(){return x.getState()},onDidChangeWindowState(u,p,y){return A(x.onDidChangeWindowState)(u,p,y)},showInformationMessage(u,...p){return kr.showMessage(w,Te.Info,u,p[0],p.slice(1))},showWarningMessage(u,...p){return kr.showMessage(w,Te.Warning,u,p[0],p.slice(1))},showErrorMessage(u,...p){return kr.showMessage(w,Te.Error,u,p[0],p.slice(1))},showQuickPick(u,p,y){return yi.showQuickPick(w,u,p,y)},showWorkspaceFolderPick(u){return yi.showWorkspaceFolderPick(u)},showInputBox(u,p){return yi.showInput(u,p)},showOpenDialog(u){return cd.showOpenDialog(u)},showSaveDialog(u){return cd.showSaveDialog(u)},createStatusBarItem(u,p,y){let F,Y,_e;return typeof u=="string"?(F=u,Y=p,_e=y):(Y=u,_e=p),dd.createStatusBarEntry(w,F,Y,_e)},setStatusBarMessage(u,p){return dd.setStatusBarMessage(u,p)},withScmProgress(u){return _.report("window.withScmProgress",w,"Use 'withProgress' instead."),nd.withProgress(w,{location:rc.SourceControl},(p,y)=>u({report(F){}}))},withProgress(u,p){return nd.withProgress(w,u,p)},createOutputChannel(u,p){return ah.createOutputChannel(u,p,w)},createWebviewPanel(u,p,y,F){return Tr.createWebviewPanel(w,u,p,y,F)},createWebviewTextEditorInset(u,p,y,F){return b(w,"editorInsets"),hh.createWebviewEditorInset(u,p,y,F,w)},createTerminal(u,p,y){return typeof u=="object"?"pty"in u?Q.createExtensionTerminal(u):Q.createTerminalFromOptions(u):Q.createTerminal(u,p,y)},registerTerminalLinkProvider(u){return Q.registerLinkProvider(u)},registerTerminalProfileProvider(u,p){return Q.registerProfileProvider(w,u,p)},registerTerminalCompletionProvider(u,...p){return b(w,"terminalCompletionProvider"),Q.registerTerminalCompletionProvider(w,u,...p)},registerTerminalQuickFixProvider(u,p){return b(w,"terminalQuickFixProvider"),Q.registerTerminalQuickFixProvider(u,w.identifier.value,p)},registerTreeDataProvider(u,p){return sd.registerTreeDataProvider(u,p,w)},createTreeView(u,p){return sd.createTreeView(u,p,w)},registerWebviewPanelSerializer:(u,p)=>Tr.registerWebviewPanelSerializer(w,u,p),registerCustomEditorProvider:(u,p,y={})=>wh.registerCustomEditorProvider(w,u,p,y),registerFileDecorationProvider(u){return ie.registerFileDecorationProvider(u,w)},registerUriHandler(u){return ed.registerUriHandler(w,u)},createQuickPick(){return yi.createQuickPick(w)},createInputBox(){return yi.createInputBox(w)},get activeColorTheme(){return od.activeColorTheme},onDidChangeActiveColorTheme(u,p,y){return A(od.onDidChangeActiveColorTheme)(u,p,y)},registerWebviewViewProvider(u,p,y){return xh.registerWebviewViewProvider(w,u,p,y?.webviewOptions)},get activeNotebookEditor(){return pe.activeNotebookEditor},onDidChangeActiveNotebookEditor(u,p,y){return A(pe.onDidChangeActiveNotebookEditor)(u,p,y)},get visibleNotebookEditors(){return pe.visibleNotebookEditors},get onDidChangeVisibleNotebookEditors(){return A(pe.onDidChangeVisibleNotebookEditors)},onDidChangeNotebookEditorSelection(u,p,y){return A(id.onDidChangeNotebookEditorSelection)(u,p,y)},onDidChangeNotebookEditorVisibleRanges(u,p,y){return A(id.onDidChangeNotebookEditorVisibleRanges)(u,p,y)},showNotebookDocument(u,p){return pe.showNotebookDocument(u,p)},registerExternalUriOpener(u,p,y){return b(w,"externalUriOpener"),bh.registerExternalUriOpener(w.identifier,u,p,y)},registerProfileContentHandler(u,p){return b(w,"profileContentHandlers"),Eh.registerProfileContentHandler(w,u,p)},registerQuickDiffProvider(u,p,y,F,Y){return b(w,"quickDiffProvider"),gh.registerQuickDiffProvider(w,G(u),p,y,F,Y)},get tabGroups(){return S.tabGroups},registerShareProvider(u,p){return b(w,"shareProvider"),mh.registerShareProvider(G(u),p)},get nativeHandle(){return b(w,"nativeWindowHandle"),x.nativeHandle},createChatStatusItem:u=>(b(w,"chatStatusItem"),Ih.createChatStatusItem(w,u))},ld={get rootPath(){return _.report("workspace.rootPath",w,"Please use 'workspace.workspaceFolders' instead. More details: https://aka.ms/vscode-eliminating-rootpath"),r.getPath()},set rootPath(u){throw new Rt("rootPath")},getWorkspaceFolder(u){return r.getWorkspaceFolder(u)},get workspaceFolders(){return r.getWorkspaceFolders()},get name(){return r.name},set name(u){throw new Rt("name")},get workspaceFile(){return r.workspaceFile},set workspaceFile(u){throw new Rt("workspaceFile")},updateWorkspaceFolders:(u,p,...y)=>r.updateWorkspaceFolders(w,u,p||0,...y),onDidChangeWorkspaceFolders:function(u,p,y){return A(r.onDidChangeWorkspace)(u,p,y)},asRelativePath:(u,p)=>r.getRelativePath(u,p),findFiles:(u,p,y,F)=>r.findFiles(u,p,y,w.identifier,F),findFiles2:(u,p,y)=>(b(w,"findFiles2"),r.findFiles2(u,p,w.identifier,y)),findTextInFiles:(u,p,y,F)=>{b(w,"findTextInFiles");let Y,_e;return typeof p=="object"?(Y=p,_e=y):(Y={},_e=p,F=y),r.findTextInFiles(u,Y||{},_e,w.identifier,F)},findTextInFiles2:(u,p,y)=>(b(w,"findTextInFiles2"),b(w,"textSearchProvider2"),r.findTextInFiles2(u,p,w.identifier,y)),save:u=>r.save(u),saveAs:u=>r.saveAs(u),saveAll:u=>r.saveAll(u),applyEdit(u,p){return Th.applyWorkspaceEdit(u,w,p)},createFileSystemWatcher:(u,p,y,F)=>{const Y={ignoreCreateEvents:!!p,ignoreChangeEvents:!!y,ignoreDeleteEvents:!!F};return St.createFileSystemWatcher(r,Ir,w,u,Y)},get textDocuments(){return Ce.getAllDocumentData().map(u=>u.document)},set textDocuments(u){throw new Rt("textDocuments")},openTextDocument(u,p){let y;if(p=p??u,typeof u=="string")y=Promise.resolve(v.file(u));else if(v.isUri(u))y=Promise.resolve(u);else if(!p||typeof p=="object")y=Ce.createDocumentData(p);else throw new Error("illegal argument - uriOrFileNameOrOptions");return y.then(F=>(l.trace(`openTextDocument from ${w.identifier}`),F.scheme===q.vscodeRemote&&!F.authority&&_.report("workspace.openTextDocument",w,"A URI of 'vscode-remote' scheme requires an authority."),Ce.ensureDocumentData(F,p).then(Y=>Y.document)))},onDidOpenTextDocument:(u,p,y)=>A(Ce.onDidAddDocument)(u,p,y),onDidCloseTextDocument:(u,p,y)=>A(Ce.onDidRemoveDocument)(u,p,y),onDidChangeTextDocument:(u,p,y)=>A(Ce.onDidChangeDocument)(u,p,y),onDidSaveTextDocument:(u,p,y)=>A(Ce.onDidSaveDocument)(u,p,y),onWillSaveTextDocument:(u,p,y)=>A(ch.getOnWillSaveTextDocumentEvent(w))(u,p,y),get notebookDocuments(){return pe.notebookDocuments.map(u=>u.apiNotebook)},async openNotebookDocument(u,p){let y;if(v.isUri(u))y=u,await pe.openNotebookDocument(u);else if(typeof u=="string")y=v.revive(await pe.createNotebookDocument({viewType:u,content:p}));else throw new Error("Invalid arguments");return pe.getNotebookDocument(y).apiNotebook},onDidSaveNotebookDocument(u,p,y){return A(td.onDidSaveNotebookDocument)(u,p,y)},onDidChangeNotebookDocument(u,p,y){return A(td.onDidChangeNotebookDocument)(u,p,y)},onWillSaveNotebookDocument(u,p,y){return A(uh.getOnWillSaveNotebookDocumentEvent(w))(u,p,y)},get onDidOpenNotebookDocument(){return A(pe.onDidOpenNotebookDocument)},get onDidCloseNotebookDocument(){return A(pe.onDidCloseNotebookDocument)},registerNotebookSerializer(u,p,y,F){return pe.registerNotebookSerializer(w,u,p,y,te(w,"notebookLiveShare")?F:void 0)},onDidChangeConfiguration:(u,p,y)=>A(Ir.onDidChangeConfiguration)(u,p,y),getConfiguration(u,p){return p=arguments.length===1?void 0:p,Ir.getConfiguration(u,p,w)},registerTextDocumentContentProvider(u,p){return dh.registerTextDocumentContentProvider(u,p)},registerTaskProvider:(u,p)=>(_.report("window.registerTaskProvider",w,"Use the corresponding function on the 'tasks' namespace instead"),Ne.registerTaskProvider(w,u,p)),registerFileSystemProvider(u,p,y){return bp(ph.registerFileSystemProvider(w,u,p,y),i.addFileSystemProvider(u,p,y))},get fs(){return i.value},registerFileSearchProvider:(u,p)=>(b(w,"fileSearchProvider"),Bt.registerFileSearchProviderOld(u,p)),registerTextSearchProvider:(u,p)=>(b(w,"textSearchProvider"),Bt.registerTextSearchProviderOld(u,p)),registerAITextSearchProvider:(u,p)=>(b(w,"aiTextSearchProvider"),b(w,"textSearchProvider2"),Bt.registerAITextSearchProvider(u,p)),registerFileSearchProvider2:(u,p)=>(b(w,"fileSearchProvider2"),Bt.registerFileSearchProvider(u,p)),registerTextSearchProvider2:(u,p)=>(b(w,"textSearchProvider2"),Bt.registerTextSearchProvider(u,p)),registerRemoteAuthorityResolver:(u,p)=>(b(w,"resolvers"),s.registerRemoteAuthorityResolver(u,p)),registerResourceLabelFormatter:u=>(b(w,"resolvers"),vh.$registerResourceLabelFormatter(u)),getRemoteExecServer:u=>(b(w,"resolvers"),s.getRemoteExecServer(u)),onDidCreateFiles:(u,p,y)=>A(St.onDidCreateFile)(u,p,y),onDidDeleteFiles:(u,p,y)=>A(St.onDidDeleteFile)(u,p,y),onDidRenameFiles:(u,p,y)=>A(St.onDidRenameFile)(u,p,y),onWillCreateFiles:(u,p,y)=>A(St.getOnWillCreateFileEvent(w))(u,p,y),onWillDeleteFiles:(u,p,y)=>A(St.getOnWillDeleteFileEvent(w))(u,p,y),onWillRenameFiles:(u,p,y)=>A(St.getOnWillRenameFileEvent(w))(u,p,y),openTunnel:u=>(b(w,"tunnels"),f.openTunnel(w,u).then(p=>{if(!p)throw new Error("cannot open tunnel");return p})),get tunnels(){return b(w,"tunnels"),f.getTunnels()},onDidChangeTunnels:(u,p,y)=>(b(w,"tunnels"),A(f.onDidChangeTunnels)(u,p,y)),registerPortAttributesProvider:(u,p)=>(b(w,"portsAttributes"),f.registerPortsAttributesProvider(u,p)),registerTunnelProvider:(u,p)=>(b(w,"tunnelFactory"),f.registerTunnelProvider(u,p)),registerTimelineProvider:(u,p)=>(b(w,"timeline"),yh.registerTimelineProvider(u,p,w.identifier,se.converter)),get isTrusted(){return r.trusted},requestWorkspaceTrust:u=>(b(w,"workspaceTrust"),r.requestWorkspaceTrust(u)),onDidGrantWorkspaceTrust:(u,p,y)=>A(r.onDidGrantWorkspaceTrust)(u,p,y),registerEditSessionIdentityProvider:(u,p)=>(b(w,"editSessionIdentityProvider"),r.registerEditSessionIdentityProvider(u,p)),onWillCreateEditSessionIdentity:(u,p,y)=>(b(w,"editSessionIdentityProvider"),A(r.getOnWillCreateEditSessionIdentityEvent(w))(u,p,y)),registerCanonicalUriProvider:(u,p)=>(b(w,"canonicalUriProvider"),r.registerCanonicalUriProvider(u,p)),getCanonicalUri:(u,p,y)=>(b(w,"canonicalUriProvider"),r.provideCanonicalUri(u,p,y)),decode(u,p){return r.decode(u,p)},encode(u,p){return r.encode(u,p)}},Nh={get inputBox(){return _.report("scm.inputBox",w,"Use 'SourceControl.inputBox' instead"),rd.getLastInputBox(w)},createSourceControl(u,p,y){return rd.createSourceControl(w,u,p,y)}},Oh={createCommentController(u,p){return _h.createCommentController(w,u,p)}},Uh={get activeDebugSession(){return le.activeDebugSession},get activeDebugConsole(){return le.activeDebugConsole},get breakpoints(){return le.breakpoints},get activeStackItem(){return le.activeStackItem},registerDebugVisualizationProvider(u,p){return b(w,"debugVisualization"),le.registerDebugVisualizationProvider(w,u,p)},registerDebugVisualizationTreeProvider(u,p){return b(w,"debugVisualization"),le.registerDebugVisualizationTree(w,u,p)},onDidStartDebugSession(u,p,y){return A(le.onDidStartDebugSession)(u,p,y)},onDidTerminateDebugSession(u,p,y){return A(le.onDidTerminateDebugSession)(u,p,y)},onDidChangeActiveDebugSession(u,p,y){return A(le.onDidChangeActiveDebugSession)(u,p,y)},onDidReceiveDebugSessionCustomEvent(u,p,y){return A(le.onDidReceiveDebugSessionCustomEvent)(u,p,y)},onDidChangeBreakpoints(u,p,y){return A(le.onDidChangeBreakpoints)(u,p,y)},onDidChangeActiveStackItem(u,p,y){return A(le.onDidChangeActiveStackItem)(u,p,y)},registerDebugConfigurationProvider(u,p,y){return le.registerDebugConfigurationProvider(u,p,y||nc.Initial)},registerDebugAdapterDescriptorFactory(u,p){return le.registerDebugAdapterDescriptorFactory(w,u,p)},registerDebugAdapterTrackerFactory(u,p){return le.registerDebugAdapterTrackerFactory(u,p)},startDebugging(u,p,y){return!y||typeof y=="object"&&"configuration"in y?le.startDebugging(u,p,{parentSession:y}):le.startDebugging(u,p,y||{})},stopDebugging(u){return le.stopDebugging(u)},addBreakpoints(u){return le.addBreakpoints(u)},removeBreakpoints(u){return le.removeBreakpoints(u)},asDebugSourceUri(u,p){return le.asDebugSourceUri(u,p)}},Wh={registerTaskProvider:(u,p)=>Ne.registerTaskProvider(w,u,p),fetchTasks:u=>Ne.fetchTasks(u),executeTask:u=>Ne.executeTask(w,u),get taskExecutions(){return Ne.taskExecutions},onDidStartTask:(u,p,y)=>A(Ne.onDidStartTask)(u,p,y),onDidEndTask:(u,p,y)=>A(Ne.onDidEndTask)(u,p,y),onDidStartTaskProcess:(u,p,y)=>A(Ne.onDidStartTaskProcess)(u,p,y),onDidEndTaskProcess:(u,p,y)=>A(Ne.onDidEndTaskProcess)(u,p,y),onDidStartTaskProblemMatchers:(u,p,y)=>(b(w,"taskProblemMatcherStatus"),A(Ne.onDidStartTaskProblemMatchers)(u,p,y)),onDidEndTaskProblemMatchers:(u,p,y)=>(b(w,"taskProblemMatcherStatus"),A(Ne.onDidEndTaskProblemMatchers)(u,p,y))},Bh={createNotebookController(u,p,y,F,Y){return ds.createNotebookController(w,u,p,y,F,te(w,"notebookMessaging")?Y:void 0)},registerNotebookCellStatusBarItemProvider:(u,p)=>pe.registerNotebookCellStatusBarItemProvider(w,u,p),createRendererMessaging(u){return lh.createRendererMessaging(w,u)},createNotebookControllerDetectionTask(u){return b(w,"notebookKernelSource"),ds.createNotebookControllerDetectionTask(w,u)},registerKernelSourceActionProvider(u,p){return b(w,"notebookKernelSource"),ds.registerKernelSourceActionProvider(w,u,p)},onDidChangeNotebookCellExecutionState(u,p,y){return b(w,"notebookCellExecutionState"),A(ds.onDidChangeNotebookCellExecutionState)(u,p,y)}},Vh={t(...u){if(typeof u[0]=="string"){const p=u.shift(),y=!u||typeof u[0]!="object"?u:u[0];return as.getMessage(w.identifier.value,{message:p,args:y})}return as.getMessage(w.identifier.value,u[0])},get bundle(){return as.getBundle(w.identifier.value)},get uri(){return as.getBundleUri(w.identifier.value)}},zh={transferActiveChat(u){return b(w,"interactive"),zt.transferActiveChat(u)}},qh={getRelatedInformation(u,p){return b(w,"aiRelatedInformation"),ad.getRelatedInformation(w,u,p)},registerRelatedInformationProvider(u,p){return b(w,"aiRelatedInformation"),ad.registerRelatedInformationProvider(w,u,p)},registerEmbeddingVectorProvider(u,p){return b(w,"aiRelatedInformation"),Sh.registerEmbeddingVectorProvider(w,u,p)},registerSettingsSearchProvider(u){return b(w,"aiSettingsSearch"),Ch.registerSettingsSearchProvider(w,u)}},jh={registerMappedEditsProvider(u,p){return b(w,"mappedEditsProvider"),{dispose(){}}},registerMappedEditsProvider2(u){return b(w,"mappedEditsProvider"),fh.registerMappedEditsProvider(w,u)},createChatParticipant(u,p){return zt.createChatAgent(w,u,p)},createDynamicChatParticipant(u,p,y){return b(w,"chatParticipantPrivate"),zt.createDynamicChatAgent(w,u,p,y)},registerChatParticipantDetectionProvider(u){return b(w,"chatParticipantPrivate"),zt.registerChatParticipantDetectionProvider(w,u)},registerRelatedFilesProvider(u,p){return b(w,"chatEditing"),zt.registerRelatedFilesProvider(w,u,p)},onDidDisposeChatSession:(u,p,y)=>(b(w,"chatParticipantPrivate"),A(zt.onDidDisposeChatSession)(u,p,y))},Rr={selectChatModels:u=>I.selectLanguageModels(w,u??{}),onDidChangeChatModels:(u,p,y)=>I.onDidChangeProviders(u,p,y),registerChatModelProvider:(u,p,y)=>(b(w,"chatProvider"),I.registerLanguageModel(w,u,p,y)),get embeddingModels(){return b(w,"embeddings"),wi.embeddingsModels},onDidChangeEmbeddingModels:(u,p,y)=>(b(w,"embeddings"),wi.onDidChange(u,p,y)),registerEmbeddingsProvider(u,p){return b(w,"embeddings"),wi.registerEmbeddingsProvider(w,u,p)},async computeEmbeddings(u,p,y){return b(w,"embeddings"),wi.computeEmbeddings(u,p,y)},registerTool(u,p){return ls.registerTool(w,u,p)},invokeTool(u,p,y){return ls.invokeTool(w,u,p,y)},get tools(){return ls.getTools(w)},fileIsIgnored(u,p){return I.fileIsIgnored(w,u,p)},registerIgnoredFileProvider(u){return I.registerIgnoredFileProvider(w,u)},registerMcpServerDefinitionProvider(u,p){return b(w,"mcpConfigurationProvider"),K.registerMcpConfigurationProvider(w,u,p)}};Rr.registerMcpConfigurationProvider=Rr.registerMcpServerDefinitionProvider;const Kh={registerSpeechProvider(u,p){return b(w,"speech"),Dh.registerProvider(w.identifier,u,p)}};return{version:e.version,ai:qh,authentication:Rh,commands:Ah,comments:Oh,chat:jh,debug:Uh,env:$h,extensions:Hh,interactive:zh,l10n:Vh,languages:Fh,lm:Rr,notebooks:Bh,scm:Nh,speech:Kh,tasks:Wh,tests:Mh,window:Lh,workspace:ld,Breakpoint:Lv,TerminalOutputAnchor:Fv,ChatResultFeedbackKind:Mn,ChatVariableLevel:Hv,ChatCompletionItem:Mv,ChatReferenceDiagnostic:$v,CallHierarchyIncomingCall:Av,CallHierarchyItem:wl,CallHierarchyOutgoingCall:Rv,CancellationError:ua,CancellationTokenSource:he,CandidatePortSource:Iv,CodeAction:Da,CodeActionKind:Pa,CodeActionTriggerKind:kv,CodeLens:iu,Color:Ql,ColorInformation:Gl,ColorPresentation:Tv,ColorThemeKind:Xt,CommentMode:Pv,CommentState:Dv,CommentThreadCollapsibleState:Vn,CommentThreadState:zn,CommentThreadApplicability:qn,CommentThreadFocus:Bn,CompletionItem:Cv,CompletionItemKind:Sv,CompletionItemTag:Ev,CompletionList:ir,CompletionTriggerKind:bv,ConfigurationTarget:Cs,CustomExecution:Cl,DebugAdapterExecutable:Ul,DebugAdapterInlineImplementation:En,DebugAdapterNamedPipeServer:Wl,DebugAdapterServer:Sn,DebugConfigurationProviderTriggerKind:nc,DebugConsoleMode:Ll,DebugVisualization:xv,DecorationRangeBehavior:wv,Diagnostic:yv,DiagnosticRelatedInformation:vv,DiagnosticSeverity:Ai,DiagnosticTag:_v,Disposable:V,DocumentHighlight:mv,DocumentHighlightKind:gv,MultiDocumentHighlight:pv,DocumentLink:fv,DocumentSymbol:yu,EndOfLine:Yi,EnvironmentVariableMutatorType:Ts,EvaluatableExpression:hv,InlineValueText:uv,InlineValueVariableLookup:lv,InlineValueEvaluatableExpression:cv,InlineCompletionTriggerKind:Qn,EventEmitter:P,ExtensionKind:Wi,ExtensionMode:ks,ExternalUriOpenerPriority:dv,FileChangeType:As,FileDecoration:_n,FileDecoration2:_n,FileSystemError:ve,FileType:Hi,FilePermission:Ws,FoldingRange:av,FoldingRangeKind:ov,FunctionBreakpoint:Ri,InlineCompletionItem:nv,InlineCompletionList:rv,Hover:sv,VerboseHover:iv,HoverVerbosityAction:tv,IndentAction:Wv,Location:li,MarkdownString:ui,OverviewRulerLane:xp,ParameterInformation:ev,PortAutoForwardAction:Z_,Position:Fe,ProcessExecution:va,ProgressLocation:rc,QuickInputButtonLocation:Y_,QuickInputButtons:Zn,Range:de,RelativePattern:X_,Selection:ci,SelectionRange:Kl,SemanticTokens:tr,SemanticTokensBuilder:J_,SemanticTokensEdit:wu,SemanticTokensEdits:$s,SemanticTokensLegend:In,ShellExecution:Ys,ShellQuoting:Q_,SignatureHelp:G_,SignatureHelpTriggerKind:K_,SignatureInformation:j_,SnippetString:xu,SourceBreakpoint:Ii,StandardTokenType:Eu,StatusBarAlignment:ei,SymbolInformation:eu,SymbolKind:q_,SymbolTag:z_,Task:Dl,TaskEventKind:V_,TaskGroup:yn,TaskPanelKind:B_,TaskRevealKind:W_,TaskScope:Zs,TerminalLink:U_,TerminalQuickFixTerminalCommand:O_,TerminalQuickFixOpener:N_,TerminalLocation:L_,TerminalProfile:F_,TerminalExitReason:H_,TerminalShellExecutionCommandLineConfidence:Pn,TerminalCompletionItem:M_,TerminalCompletionItemKind:$_,TerminalCompletionList:A_,TerminalShellType:R_,TextDocumentSaveReason:I_,TextEdit:_u,SnippetTextEdit:k_,TextEditorCursorStyle:wp,TextEditorChangeKind:Fs,TextEditorLineNumbersStyle:T_,TextEditorRevealType:El,TextEditorSelectionChangeKind:ku,SyntaxTokenType:vu,TextDocumentChangeReason:jn,ThemeColor:to,ThemeIcon:Et,TreeItem:Ru,TreeItemCheckboxState:Yt,TreeItemCollapsibleState:Au,TypeHierarchyItem:xl,UIKind:vn,Uri:v,ViewColumn:P_,WorkspaceEdit:Ta,DocumentPasteTriggerKind:D_,DocumentDropEdit:C_,DocumentDropOrPasteEditKind:bu,DocumentPasteEdit:S_,InlayHint:E_,InlayHintLabelPart:b_,InlayHintKind:x_,RemoteAuthorityResolverError:Jt,ResolvedAuthority:w_,ManagedResolvedAuthority:Is,SourceControlInputBoxValidationType:y_,ExtensionRuntime:$u,TimelineItem:v_,NotebookRange:yr,NotebookCellKind:__,NotebookCellExecutionState:Pu,NotebookCellData:Du,NotebookData:m_,NotebookRendererScript:g_,NotebookCellStatusBarAlignment:p_,NotebookEditorRevealType:Cu,NotebookCellOutput:Xn,NotebookCellOutputItem:f_,CellErrorStackFrame:h_,NotebookCellStatusBarItem:u_,NotebookControllerAffinity:l_,NotebookControllerAffinity2:Tu,NotebookEdit:c_,NotebookKernelSourceAction:d_,NotebookVariablesRequestKind:Yn,PortAttributes:a_,LinkedEditingRanges:o_,TestResultState:n_,TestRunRequest:Fl,TestMessage:r_,TestMessageStackFrame:s_,TestTag:i_,TestRunProfileKind:t_,TextSearchCompleteMessageType:sc,DataTransfer:ka,DataTransferItem:e_,TestCoverageCount:Zm,FileCoverage:bn,StatementCoverage:Ym,BranchCoverage:Xm,DeclarationCoverage:Jm,WorkspaceTrustState:Qm,LanguageStatusSeverity:Ms,QuickPickItemKind:eo,InputBoxValidationSeverity:Hs,TabInputText:ba,TabInputTextDiff:er,TabInputTextMerge:Al,TabInputCustom:xa,TabInputNotebook:wa,TabInputNotebookDiff:ya,TabInputWebview:Rl,TabInputTerminal:Il,TabInputInteractiveWindow:kl,TabInputChat:Tl,TabInputTextMultiDiff:Pl,TelemetryTrustedValue:ol,LogLevel:ut,EditSessionIdentityMatch:io,InteractiveSessionVoteDirection:Gm,ChatCopyKind:Km,ChatEditingSessionActionOutcome:jm,InteractiveEditorResponseFeedbackKind:qm,DebugStackFrame:Ol,DebugThread:Nl,RelatedInformationType:zm,SpeechToTextStatus:Vm,TextToSpeechStatus:Bm,PartialAcceptTriggerKind:Wm,InlineCompletionEndOfLifeReasonKind:Um,KeywordRecognitionStatus:Om,ChatImageMimeType:Nm,ChatResponseMarkdownPart:fu,ChatResponseFileTreePart:uu,ChatResponseAnchorPart:Wn,ChatResponseProgressPart:Lm,ChatResponseProgressPart2:Rs,ChatResponseReferencePart:Vi,ChatResponseReferencePart2:Vi,ChatResponseCodeCitationPart:Un,ChatResponseCodeblockUriPart:hu,ChatResponseWarningPart:Nn,ChatResponseTextEditPart:Hn,ChatResponseNotebookEditPart:Fn,ChatResponseMarkdownWithVulnerabilitiesPart:Ln,ChatResponseCommandButtonPart:lu,ChatResponseConfirmationPart:On,ChatResponseMovePart:du,ChatResponseExtensionsPart:cu,ChatResponseReferencePartStatusKind:Fm,ChatRequestTurn:$n,ChatRequestTurn2:$n,ChatResponseTurn:ou,ChatLocation:Hm,ChatRequestEditorData:ru,ChatRequestNotebookData:au,ChatReferenceBinaryData:Mm,ChatRequestEditedFileEventKind:$m,LanguageModelChatMessageRole:Ml,LanguageModelChatMessage:Am,LanguageModelChatMessage2:Rm,LanguageModelToolResultPart:Im,LanguageModelToolResultPart2:km,LanguageModelTextPart:Ui,LanguageModelToolCallPart:Ea,LanguageModelError:Je,LanguageModelToolResult:Tm,LanguageModelToolResult2:Pm,LanguageModelDataPart:Hl,LanguageModelExtraDataPart:Dm,ExtendedLanguageModelToolResult:Cm,PreparedTerminalToolInvocation:Sm,LanguageModelChatToolMode:Em,LanguageModelPromptTsxPart:bm,NewSymbolName:xm,NewSymbolNameTag:wm,NewSymbolNameTriggerKind:Kn,InlineEdit:ym,InlineEditTriggerKind:Jn,ExcludeSettingOptions:Pt,TextSearchContext2:ga,TextSearchMatch2:_t,AISearchKeyword:Dn,TextSearchCompleteMessageTypeNew:sc,ChatErrorLevel:vm,McpHttpServerDefinition:_m,McpStdioServerDefinition:mm,SettingsSearchResultKind:gm}}}var Us;let ta=class{constructor(e,t,i,s,r,n,o){this._apiFactory=e,this._extensionRegistry=t,this._instaService=i,this._extHostConfiguration=s,this._extHostExtensionService=r,this._initData=n,this._logService=o,this._factories=new Map,this._alternatives=[]}async install(){this._installInterceptor(),We("code/extHost/willWaitForConfig");const e=await this._extHostConfiguration.getConfigProvider();We("code/extHost/didWaitForConfig");const t=await this._extHostExtensionService.getExtensionPathIndex();this.register(new Px(this._apiFactory,t,this._extensionRegistry,e,this._logService)),this.register(this._instaService.createInstance(ia)),this._initData.remote.isRemote&&this.register(this._instaService.createInstance(sa,t,this._initData.environment.appUriScheme))}register(e){if("nodeModuleName"in e)if(Array.isArray(e.nodeModuleName))for(const t of e.nodeModuleName)this._factories.set(t,e);else this._factories.set(e.nodeModuleName,e);typeof e.alternativeModuleName=="function"&&this._alternatives.push(t=>e.alternativeModuleName(t))}};ta=L([E(2,ha),E(3,rt),E(4,Wt),E(5,Se),E(6,re)],ta);let ia=class{static{Us=this}static{this.aliased=new Map([["vscode-ripgrep","@vscode/ripgrep"],["vscode-windows-registry","@vscode/windows-registry"]])}constructor(e){if(e.environment.appRoot&&Us.aliased.size){const t=Ep(this.forceForwardSlashes(e.environment.appRoot.fsPath)),i="[a-z0-9_.-]",s=`@${i}+\\/${i}+|${i}+`,r="node_modules|node_modules\\.asar(?:\\.unpacked)?";this.re=new RegExp(`^(${t}/${r}\\/)(${s})(.*)$`,"i")}}alternativeModuleName(e){if(!this.re)return;const t=this.re.exec(this.forceForwardSlashes(e));if(!t)return;const[,i,s,r]=t,n=Us.aliased.get(s);if(n!==void 0)return console.warn(`${s} as been renamed to ${n}, please update your imports`),i+n+r}forceForwardSlashes(e){return e.replace(/\\/g,"/")}};ia=Us=L([E(0,Se)],ia);class Px{constructor(e,t,i,s,r){this._apiFactory=e,this._extensionPaths=t,this._extensionRegistry=i,this._configProvider=s,this._logService=r,this.nodeModuleName="vscode",this._extApiImpl=new Lt}load(e,t){const i=this._extensionPaths.findSubstr(t);if(i){let s=this._extApiImpl.get(i.identifier);return s||(s=this._apiFactory(i,this._extensionRegistry,this._configProvider),this._extApiImpl.set(i.identifier,s)),s}if(!this._defaultApiImpl){let s="";this._extensionPaths.forEach((r,n)=>s+=`	${n} -> ${r.identifier.value}
`),this._logService.warn(`Could not identify extension for 'vscode' require call from ${t}. These are the extension path mappings: 
${s}`),this._defaultApiImpl=this._apiFactory(Sp,this._extensionRegistry,this._configProvider)}return this._defaultApiImpl}}let sa=class{constructor(e,t,i){this._extensionPaths=e,this._appUriScheme=t,this.nodeModuleName=["open","opn"],this._mainThreadTelemetry=i.getProxy(k.MainThreadTelemetry);const s=i.getProxy(k.MainThreadWindow);this._impl=(r,n)=>{const o=v.parse(r);return n?this.callOriginal(r,n):o.scheme==="http"||o.scheme==="https"?s.$openUri(o,r,{allowTunneling:!0}):o.scheme==="mailto"||o.scheme===this._appUriScheme?s.$openUri(o,r,{}):this.callOriginal(r,n)}}load(e,t,i){const s=this._extensionPaths.findSubstr(t);return s&&(this._extensionId=s.identifier.value,this.sendShimmingTelemetry()),this._original=i(e),this._impl}callOriginal(e,t){return this.sendNoForwardTelemetry(),this._original(e,t)}sendShimmingTelemetry(){this._extensionId&&this._mainThreadTelemetry.$publicLog2("shimming.open",{extension:this._extensionId})}sendNoForwardTelemetry(){this._extensionId&&this._mainThreadTelemetry.$publicLog2("shimming.open.call.noForward",{extension:this._extensionId})}};sa=L([E(2,j)],sa);let ra=class{constructor(e,t){this._mainThreadConsole=e.getProxy(k.MainThreadConsole),this._includeStack=t.consoleForward.includeStack,this._logNative=t.consoleForward.logNative,this._wrapConsoleMethod("info","log"),this._wrapConsoleMethod("log","log"),this._wrapConsoleMethod("warn","warn"),this._wrapConsoleMethod("debug","debug"),this._wrapConsoleMethod("error","error")}_wrapConsoleMethod(e,t){const i=this,s=console[e];Object.defineProperty(console,e,{set:()=>{},get:()=>function(){i._handleConsoleCall(e,t,s,arguments)}})}_handleConsoleCall(e,t,i,s){this._mainThreadConsole.$logExtensionHostMessage({type:"__$console",severity:t,arguments:kx(s,this._includeStack)}),this._logNative&&this._nativeConsoleLogMessage(e,i,s)}};ra=L([E(0,j),E(1,Se)],ra);const Tx=1e5;function kx(a,e){const t=[];if(a.length)for(let i=0;i<a.length;i++){let s=a[i];if(typeof s>"u")s="undefined";else if(s instanceof Error){const r=s;r.stack?s=r.stack:s=r.toString()}t.push(s)}if(e){const i=new Error().stack;i&&t.push({__$stack:i.split(`
`).slice(3).join(`
`)})}try{const i=Cp(t);return i.length>Tx?"Output omitted for a large object that exceeds the limits":i}catch(i){return`Output omitted for an object that cannot be inspected ('${i.toString()}')`}}let na=class extends ra{constructor(e,t){super(e,t)}_nativeConsoleLogMessage(e,t,i){t.apply(console,i)}};na=L([E(0,j),E(1,Se)],na);class Ix extends ta{_installInterceptor(){}getModule(e,t){for(const i of this._alternatives){const s=i(e);if(s){e=s;break}}if(this._factories.has(e))return this._factories.get(e).load(e,t,()=>{throw new Error("CANNOT LOAD MODULE from here.")})}}class Rb extends ko{constructor(){super(...arguments),this.extensionRuntime=$u.Webworker}async _beforeAlmostReadyToRunExtensions(){Qs&&this._instaService.createInstance(na),this._apiFactory=this._instaService.invokeFunction(Dx),this._fakeModules=this._instaService.createInstance(Ix,this._apiFactory,{mine:this._myRegistry,all:this._globalRegistry}),await this._fakeModules.install(),performance.mark("code/extHost/didInitAPI"),await this._waitForDebuggerAttachment()}_getEntryPoint(e){return e.browser}async _loadCommonJSModule(e,t,i){t=t.with({path:Rx(t.path,".js")});const s=e?.identifier.value;s&&performance.mark(`code/extHost/willFetchExtensionCode/${s}`);const r=v.revive(await this._mainThreadExtensionsProxy.$asBrowserUri(t)),n=await fetch(r.toString(!0));if(s&&performance.mark(`code/extHost/didFetchExtensionCode/${s}`),n.status!==200)throw new Error(n.statusText);const o=await n.text(),d=`${t.toString(!0)}#vscode-extension`,c=`${o}
//# sourceURL=${d}`;let h;try{h=new Function("module","exports","require",c)}catch(f){throw console.error(s?`Loading code for extension ${s} failed: ${f.message}`:`Loading code failed: ${f.message}`),console.error(`${t.toString(!0)}${typeof f.line=="number"?` line ${f.line}`:""}${typeof f.column=="number"?` column ${f.column}`:""}`),console.error(f),f}e&&await this._extHostLocalizationService.initializeLocalizedMessages(e);const g={},m={exports:g},l=f=>{const _=this._fakeModules.getModule(f,t);if(_===void 0)throw new Error(`Cannot load module '${f}'`);return _};try{return i.codeLoadingStart(),s&&performance.mark(`code/extHost/willLoadExtensionCode/${s}`),h(m,g,l),m.exports!==g?m.exports:g}finally{s&&performance.mark(`code/extHost/didLoadExtensionCode/${s}`),i.codeLoadingStop()}}_loadESMModule(e,t,i){throw new Error("ESM modules are not supported in the web worker extension host")}async $setRemoteEnvironment(e){}async _waitForDebuggerAttachment(e=5e3){if(!this._initData.environment.isExtensionDevelopmentDebug)return;const t=Date.now()+e;for(;Date.now()<t&&!("__jsDebugIsReady"in globalThis);)await si(10)}}function Rx(a,e){return a.endsWith(e)?a:a+e}export{gc as E,Wt as I,zu as a,Rb as b,ih as c,cc as d,Aa as e,io as f,mb as g,Vo as h,vw as w};

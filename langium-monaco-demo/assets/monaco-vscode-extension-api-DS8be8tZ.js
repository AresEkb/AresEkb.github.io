import{c as Y,S as G,l8 as fl,an as gt,_ as L,o as E,ab as ap,V as be,am as zs,F as Wi,aj as fn,aa as Pe,aT as cp,aF as xc,aG as dp,t as V,mL as St,aP as se,vj as lp,W as hi,l5 as me,s3 as hp,h as N,a5 as D,aX as gl,a_ as up,vk as Vi,vl as pp,ct as mt,U as v,k as ml,m as wa,m5 as bc,b as Te,l as j,bL as _l,aO as de,o8 as xr,n2 as qe,b4 as fp,az as gp,aN as mp,n4 as _p,nt as Ec,d$ as vp,cU as yp,ak as xa,dW as wp,lU as js,kW as Ge,vm as xp,ov as bp,M as vl,no as b,dh as Sc,lL as qs,c_ as Ep,X as Or,d_ as Sp,cZ as De,T as gn,Z as At,dq as Ut,D as Z,oe as Pi,vn as Cp,ce as yl,vo as Dp,vp as Cc,np as Dc,vq as Pp,jD as ui,bh as Wt,bt as br,qU as wl,ed as Ct,kU as Er,cV as Tp,vr as kp,vs as Me,dY as pi,vt as xl,rD as Ip,b7 as Rp,lN as ba,vu as Mt,jK as Ks,bs as et,f5 as Bi,aJ as Gs,B as fi,aZ as Ht,l4 as Se,C as he,ae as Ap,o7 as mn,vv as _n,vw as xe,A as Pc,vx as $p,tm as Mp,rM as Hp,a as Qs,c$ as Vt,vy as Tc,cB as Ea,a1 as Js,l0 as Xs,n8 as vn,kV as os,bu as Sa,vz as Fp,jC as yn,sm as Ca,E as Ee,bo as gi,oF as Da,k$ as Lp,hc as Np,i2 as Op,he as bl,vA as Up,nB as Ys,oB as Wp,oA as wn,vB as Vp,oa as kc,I as Pa,nM as Pt,hP as El,ac as Ve,vC as Zs,vD as xn,be as Nt,aS as er,n7 as ie,ok as Ic,vE as Bp,vF as zp,p1 as Sl,nK as jp,nJ as qp,vG as Kp,aU as bn,gh as Mi,aK as Cl,gD as Gp,ib as Rc,Q as Qp,w as Re,ik as as,vH as Jp,bH as En,L as Hi,cT as Xp,n9 as Yp,j as Zp,mJ as ef,hu as Sn,dg as tf,vI as sf,aR as We,lr as re,ls as ne,vJ as rf,vK as nf,cI as Ac,vL as of,vM as $c,vN as Dl,vO as af,p9 as Ta,mg as cf,mi as df,vP as lf,kS as Pl,ef as ut,te as gs,sb as Ur,sg as Wr,a6 as Tl,vQ as hf,bU as uf,fk as pf,bl as ff,vR as gf,vS as mf,lu as kl,aQ as Vr,vT as at,fE as _f,vU as vf,vV as yf,vW as Cn,bJ as wf,ap as ct,vX as xf,vY as Jt,nz as bf,u7 as Mc,ds as Ef,nk as Br,oL as Hc,tV as Fc,vZ as Sf,d1 as Lc,bx as Cf,v_ as Df,bn as Pf,ml as Tf,v$ as Nc,w0 as Oc,tD as Uc,x as Wc,z as Vc,w1 as Bc,al as zc,bI as kf,aw as If,w2 as Rf,lD as Il,w3 as Ds,s6 as Af,J as $f,fh as Mf,y as Ti,w4 as Hf,gV as Ff,sj as Lf,dy as Nf,q4 as jc,ej as Of,w5 as Uf,w6 as Wf,N as Vf}from"./monaco-vscode-base-service-override-DWrDktfJ.js";import{I as q,M as k,F as ye,a as _e,O as zr,E as kt,G as Ps,r as qc,T as _t,R as ce,b as ka,D as W,c as Dn,C as Ts,d as Bf,e as zf,f as jf,h as ks,i as A,j as Ia,k as qf,l as cs,m as oe,n as ts,o as Kf,p as ae,U as Pn,P as Fe,q as te,S as mi,s as it,t as Rl,u as Ra,v as Al,x as zi,y as $l,z as Gf,A as Qe,B as st,L as _i,N as ai,H as bt,J as is,K as Qf,V as we,Q as Ml,W as Jf,X as Xf,Y as Hl,Z as Is,_ as Yf,$ as tr,a0 as Zf,a1 as Kc,a2 as eg,a3 as tg,a4 as Rs,a5 as Aa,a6 as ir,a7 as sr,a8 as Fl,a9 as Ll,aa as Tn,ab as ig,ac as Ft,ad as Oe,ae as Nl,af as rr,ag as Ol,ah as Ul,ai as Wl,aj as $a,ak as Ma,al as Vl,am as Ha,an as Bl,ao as Fa,ap as ji,aq as Gc,ar as zl,as as kn,at as jr,au as Ye,av as jl,aw as La,ax as qi,ay as ql,az as Na,aA as As,aB as Ki,aC as sg,aD as ti,aE as ms,aF as $s,aG as rg,aH as ng,aI as Qc,aJ as $e,aK as qr,aL as In,aM as Jc,aN as Oa,aO as Rn,aP as og,aQ as ag,aR as Kl,aS as cg,aT as Kr,aU as dg,aV as An,aW as lg,aX as hg,aY as ug,aZ as Fi,a_ as Li,a$ as Xc,b0 as Gl,b1 as $n,b2 as pg,b3 as fg,b4 as gg,b5 as Ql,b6 as Jl,b7 as Xl,b8 as Mn,b9 as Yl,ba as Yc,bb as Et,bc as mg,bd as Hn,be as Zl,bf as ci,bg as eh,bh as th,bi as _g,bj as ih,bk as Fn,bl as vg,bm as Ln,bn as yg,bo as wg,bp as It,bq as Gr,br as xg,bs as Qr,bt as bg,bu as Eg,bv as Sg,bw as sh,bx as Ke,by as Nn,bz as rh,bA as On,bB as Cg,bC as Dg,bD as Le,bE as Gi,bF as Un,bG as Zc,bH as nr,bI as or,bJ as Pg,bK as Wn,bL as nh,bM as ar,bN as oh,bO as ah,bP as Tg,bQ as ch,bR as dh,bS as lh,bT as Jr,bU as Vn,bV as hh,bW as uh,bX as ph,bY as Ua,bZ as Wa,b_ as fh,b$ as kg,c0 as Ig,c1 as ed,c2 as Rg,c3 as td,c4 as gh,c5 as Xr,c6 as id,c7 as Ag,c8 as Bn,c9 as mh,ca as _h,cb as $g,cc as sd,cd as zn,ce as Mg,cf as Hg,cg as vh,ch as jn,ci as qn,cj as Kn,ck as Gn,cl as Qn,cm as Jn,cn as yh,co as wh,cp as Ms,cq as Qi,cr as rd,cs as nd,ct as Xn,cu as od,cv as Yn,cw as ad,cx as Fg,cy as Lg,cz as Ng,cA as Og,cB as Yr,cC as cd,cD as Ug,cE as xh,cF as Wg,cG as bh,cH as Vg,cI as Eh,cJ as Bg,cK as Sh,cL as zg,cM as jg,cN as vi,cO as qg,cP as Zn,cQ as eo,cR as to,cS as io,cT as Kg,cU as Gg,cV as Qg,cW as Ch,cX as Dh,cY as cr,cZ as Ni,c_ as Ph,c$ as Th,d0 as so,d1 as Hs,d2 as Va,d3 as ro,d4 as Sr,d5 as kh,d6 as Ih,d7 as Jg,d8 as Xg,d9 as Yg,da as Zg,db as em,dc as Fs,dd as Rh,de as no,df as tm,dg as _s,dh as U,di as im,dj as sm,dk as Ah,dl as oo,dm as rm,dn as nm,dp as om,dq as ao,dr as am,ds as cm,dt as dr,du as dm,dv as dd,dw as Ba,dx as $h,dy as Mh,dz as lm,dA as hm,dB as um,dC as pm,dD as fm,dE as gm,dF as mm,dG as _m,dH as ld,dI as Hh,dJ as vm,dK as Ls,dL as Je,dM as lr,dN as hd,dO as ym,dP as Fh,dQ as wm,dR as xm,dS as Lh,dT as bm,dU as Em,dV as Xt,dW as Sm,dX as Cm,dY as Nh,dZ as Dm,d_ as co,d$ as vs,e0 as ud,e1 as Pm,e2 as lo,e3 as Oh,e4 as ho,e5 as uo,e6 as Ns,e7 as po,e8 as ri,e9 as Tm,ea as Uh,eb as Os,ec as pd,ed as ii,ee as Wh,ef as si,eg as Vh,eh as Bh,ei as Xe,ej as km,ek as Im,el as R,em as Rm,en as Am,eo as $m,ep as Mm,eq as fd,er as Hm,es as Fm,et as Lm,eu as Nm,ev as Om,ew as Um,ex as Wm,ey as Vm,ez as Bm,eA as zm,eB as jm,eC as qm,eD as Km,eE as Gm,eF as Qm,eG as Jm,eH as Xm,eI as Ym,eJ as Zm,eK as e_,eL as t_,eM as i_,eN as s_,eO as r_,eP as n_,eQ as o_,eR as a_,eS as c_,eT as d_,eU as l_,eV as h_,eW as u_,eX as p_,eY as f_,eZ as g_,e_ as m_,e$ as __,f0 as v_,f1 as y_,f2 as w_,f3 as x_,f4 as b_,f5 as E_,f6 as S_,f7 as C_,f8 as D_,f9 as P_,fa as T_,fb as k_,fc as I_,fd as R_,fe as A_,ff as $_,fg as M_,fh as zh,fi as H_,fj as F_,fk as L_,fl as N_,fm as O_,fn as U_,fo as W_,fp as V_,fq as B_,fr as z_,fs as j_,ft as q_,fu as K_,fv as G_,fw as Q_,fx as J_,fy as X_,fz as Y_,fA as Z_,fB as ev,fC as tv,fD as iv,fE as sv,fF as rv,fG as nv,fH as ov,fI as av,fJ as cv,fK as dv,fL as lv,fM as hv,fN as uv,fO as pv,fP as fv,fQ as gv,fR as mv,fS as _v,fT as vv,fU as yv,fV as wv,fW as xv,fX as bv,fY as Ev,fZ as Sv,f_ as Cv,f$ as Dv,g0 as Pv,g1 as Tv,g2 as kv,g3 as Iv,g4 as Rv,g5 as Av,g6 as $v,g7 as Mv,g8 as Hv,g9 as Fv,ga as Lv,gb as gd,gc as Nv,gd as Ov,ge as Uv,gf as Wv,gg as Vv,gh as Bv,gi as zv,gj as jv,gk as qv,gl as Kv,gm as Gv,gn as Qv,go as Jv,gp as Xv,gq as Yv,gr as Zv,gs as ey,gt as ty,gu as iy}from"./monaco-vscode-api-C8AKrXDl.js";import{at as sy}from"./monaco-vscode-editor-api-Cjp3CvRF.js";import{ci as ry,cj as ny,ck as oy,cl as ay,cm as cy}from"./monaco-vscode-configuration-service-override-COq0Cpay.js";var fo;(function(a){a[a.Complete=100]="Complete",a[a.Partial=50]="Partial",a[a.None=0]="None"})(fo||(fo={}));class dy{constructor(){this._systemSchemes=new Set(Object.keys(G)),this._providerInfo=new Map,this.extUri=new fl(e=>{const t=this._providerInfo.get(e.scheme);return!(t===void 0||t&gt.PathCaseSensitive)})}$acceptProviderInfos(e,t){t===null?this._providerInfo.delete(e.scheme):this._providerInfo.set(e.scheme,t)}isFreeScheme(e){return!this._providerInfo.has(e)&&!this._systemSchemes.has(e)}getCapabilities(e){return this._providerInfo.get(e)}}const wi=Y("IExtHostFileSystemInfo");var je;let go=je=class{constructor(e,t){this._fileSystemProvider=new Map,this._writeQueue=new ap,this._proxy=e.getProxy(k.MainThreadFileSystem);const i=this;this.value=Object.freeze({async stat(s){try{let r;const n=i._fileSystemProvider.get(s.scheme);return n?(await i._proxy.$ensureActivation(s.scheme),r=await n.impl.stat(s)):r=await i._proxy.$stat(s),{type:r.type,ctime:r.ctime,mtime:r.mtime,size:r.size,permissions:r.permissions===zs.Readonly?1:void 0}}catch(r){je._handleError(r)}},async readDirectory(s){try{const r=i._fileSystemProvider.get(s.scheme);return r?(await i._proxy.$ensureActivation(s.scheme),(await r.impl.readDirectory(s)).slice()):await i._proxy.$readdir(s)}catch(r){return je._handleError(r)}},async createDirectory(s){try{const r=i._fileSystemProvider.get(s.scheme);return r&&!r.isReadonly?(await i._proxy.$ensureActivation(s.scheme),await i.mkdirp(r.impl,r.extUri,s)):await i._proxy.$mkdir(s)}catch(r){return je._handleError(r)}},async readFile(s){try{const r=i._fileSystemProvider.get(s.scheme);return r?(await i._proxy.$ensureActivation(s.scheme),(await r.impl.readFile(s)).slice()):(await i._proxy.$readFile(s)).buffer}catch(r){return je._handleError(r)}},async writeFile(s,r){try{const n=i._fileSystemProvider.get(s.scheme);return n&&!n.isReadonly?(await i._proxy.$ensureActivation(s.scheme),await i.mkdirp(n.impl,n.extUri,n.extUri.dirname(s)),await i._writeQueue.queueFor(s,()=>Promise.resolve(n.impl.writeFile(s,r,{create:!0,overwrite:!0})))):await i._proxy.$writeFile(s,be.wrap(r))}catch(n){return je._handleError(n)}},async delete(s,r){try{const n=i._fileSystemProvider.get(s.scheme);return n&&!n.isReadonly&&!r?.useTrash?(await i._proxy.$ensureActivation(s.scheme),await n.impl.delete(s,{recursive:!1,...r})):await i._proxy.$delete(s,{recursive:!1,useTrash:!1,atomic:!1,...r})}catch(n){return je._handleError(n)}},async rename(s,r,n){try{return await i._proxy.$rename(s,r,{overwrite:!1,...n})}catch(o){return je._handleError(o)}},async copy(s,r,n){try{return await i._proxy.$copy(s,r,{overwrite:!1,...n})}catch(o){return je._handleError(o)}},isWritableFileSystem(s){const r=t.getCapabilities(s);if(typeof r=="number")return!(r&gt.Readonly)}})}async mkdirp(e,t,i){const s=[];for(;!t.isEqual(i,t.dirname(i));)try{if(((await e.stat(i)).type&Wi.Directory)===0)throw ye.FileExists(`Unable to create folder '${i.scheme===G.file?i.fsPath:i.toString(!0)}' that already exists but is not a directory`);break}catch(r){if(fn(r)!==Pe.FileNotFound)throw r;s.push(t.basename(i)),i=t.dirname(i)}for(let r=s.length-1;r>=0;r--){i=t.joinPath(i,s[r]);try{await e.createDirectory(i)}catch(n){if(fn(n)!==Pe.FileExists)throw n}}}static _handleError(e){if(e instanceof ye)throw e;if(e instanceof cp)switch(e.code){case Pe.FileExists:throw ye.FileExists(e.message);case Pe.FileNotFound:throw ye.FileNotFound(e.message);case Pe.FileNotADirectory:throw ye.FileNotADirectory(e.message);case Pe.FileIsADirectory:throw ye.FileIsADirectory(e.message);case Pe.NoPermissions:throw ye.NoPermissions(e.message);case Pe.Unavailable:throw ye.Unavailable(e.message);default:throw new ye(e.message,e.name)}if(!(e instanceof Error))throw new ye(String(e));if(e.name==="ENOPRO"||e.message.includes("ENOPRO"))throw ye.Unavailable(e.message);switch(e.name){case Pe.FileExists:throw ye.FileExists(e.message);case Pe.FileNotFound:throw ye.FileNotFound(e.message);case Pe.FileNotADirectory:throw ye.FileNotADirectory(e.message);case Pe.FileIsADirectory:throw ye.FileIsADirectory(e.message);case Pe.NoPermissions:throw ye.NoPermissions(e.message);case Pe.Unavailable:throw ye.Unavailable(e.message);default:throw new ye(e.message,e.name)}}addFileSystemProvider(e,t,i){return this._fileSystemProvider.set(e,{impl:t,extUri:i?.isCaseSensitive?xc:dp,isReadonly:!!i?.isReadonly}),V(()=>this._fileSystemProvider.delete(e))}getFileSystemProviderExtUri(e){return this._fileSystemProvider.get(e)?.extUri??xc}};go=je=L([E(0,q),E(1,wi)],go);const Cr=Y("IExtHostConsumerFileSystem");class jh extends gl{constructor(e,t,i,s,r){super(),this.id=e,this.name=t,this.logger=i,this.proxy=s,this.extension=r,this.offset=0,this.visible=!1,this.setLevel(i.getLevel()),this._register(i.onDidChangeLogLevel(n=>this.setLevel(n))),this._register(V(()=>this.proxy.$dispose(this.id)))}get logLevel(){return this.getLevel()}appendLine(e){this.append(e+`
`)}append(e){this.info(e)}clear(){const e=this.offset;this.logger.flush(),this.proxy.$update(this.id,zr.Clear,e)}replace(e){const t=this.offset;this.info(e),this.proxy.$update(this.id,zr.Replace,t),this.visible&&this.logger.flush()}show(e,t){this.logger.flush(),this.proxy.$reveal(this.id,!!(typeof e=="boolean"?e:t))}hide(){this.proxy.$close(this.id)}log(e,t){this.offset+=be.fromString(t).byteLength,up(this.logger,e,t),this.visible&&(this.logger.flush(),this.proxy.$update(this.id,zr.Append))}}class ly extends jh{appendLine(e){this.append(e)}}let mo=class{constructor(e,t,i,s,r,n){this.initData=t,this.extHostFileSystem=i,this.extHostFileSystemInfo=s,this.loggerService=r,this.logService=n,this.extensionLogDirectoryPromise=new Map,this.namePool=1,this.channels=new Map,this.visibleChannelId=null,this.proxy=e.getProxy(k.MainThreadOutputService),this.outputsLocation=this.extHostFileSystemInfo.extUri.joinPath(t.logsLocation,`output_logging_${lp(new Date).replace(/-|:|\.\d+Z$/g,"")}`)}$setVisibleChannel(e){this.visibleChannelId=e;for(const[t,i]of this.channels)i.visible=t===this.visibleChannelId}createOutputChannel(e,t,i){if(e=e.trim(),!e)throw new Error("illegal argument `name`. must not be falsy");const s=typeof t=="object"&&t.log,r=hi(t)?t:void 0;if(hi(r)&&!r.trim())throw new Error("illegal argument `languageId`. must not be empty");let n;const o=this.initData.environment.extensionLogLevel?.find(([h])=>me.equals(i.identifier,h))?.[1];o&&(n=hp(o));const c=new N,d=s?this.doCreateLogOutputChannel(e,n,i,c):this.doCreateOutputChannel(e,r,i,c);return d.then(h=>{this.channels.set(h.id,h),h.visible=h.id===this.visibleChannelId,c.add(V(()=>this.channels.delete(h.id)))}),s?this.createExtHostLogOutputChannel(e,n??this.logService.getLevel(),d,c):this.createExtHostOutputChannel(e,d,c)}async doCreateOutputChannel(e,t,i,s){this.outputDirectoryPromise||(this.outputDirectoryPromise=this.extHostFileSystem.value.createDirectory(this.outputsLocation).then(()=>this.outputsLocation));const r=await this.outputDirectoryPromise,n=this.extHostFileSystemInfo.extUri.joinPath(r,`${this.namePool++}-${e.replace(/[\\/:\*\?"<>\|]/g,"")}.log`),o=s.add(this.loggerService.createLogger(n,{logLevel:"always",donotRotate:!0,donotUseFormatters:!0,hidden:!0})),c=await this.proxy.$register(e,n,t,i.identifier.value);return s.add(V(()=>this.loggerService.deregisterLogger(n))),new jh(c,e,o,this.proxy,i)}async doCreateLogOutputChannel(e,t,i,s){const r=await this.createExtensionLogDirectory(i),n=e.replace(/[\\/:\*\?"<>\|]/g,""),o=this.extHostFileSystemInfo.extUri.joinPath(r,`${n}.log`),c=`${i.identifier.value}.${n}`,d=s.add(this.loggerService.createLogger(o,{id:c,name:e,logLevel:t,extensionId:i.identifier.value}));return s.add(V(()=>this.loggerService.deregisterLogger(o))),new ly(c,e,d,this.proxy,i)}createExtensionLogDirectory(e){let t=this.extensionLogDirectoryPromise.get(e.identifier.value);if(!t){const i=this.extHostFileSystemInfo.extUri.joinPath(this.initData.logsLocation,e.identifier.value);this.extensionLogDirectoryPromise.set(e.identifier.value,t=(async()=>{try{await this.extHostFileSystem.value.createDirectory(i)}catch(s){if(fn(s)!==Pe.FileExists)throw s}return i})())}return t}createExtHostOutputChannel(e,t,i){const s=()=>{if(i.isDisposed)throw new Error("Channel has been closed")};return t.then(r=>i.add(r)),{get name(){return e},append(r){s(),t.then(n=>n.append(r))},appendLine(r){s(),t.then(n=>n.appendLine(r))},clear(){s(),t.then(r=>r.clear())},replace(r){s(),t.then(n=>n.replace(r))},show(r,n){s(),t.then(o=>o.show(r,n))},hide(){s(),t.then(r=>r.hide())},dispose(){i.dispose()}}}createExtHostLogOutputChannel(e,t,i,s){const r=()=>{if(s.isDisposed)throw new Error("Channel has been closed")},n=s.add(new D);function o(c){t=c,n.fire(c)}return i.then(c=>{c.logLevel!==t&&o(c.logLevel),s.add(c.onDidChangeLogLevel(d=>o(d)))}),{...this.createExtHostOutputChannel(e,i,s),get logLevel(){return t},onDidChangeLogLevel:n.event,trace(c,...d){r(),i.then(h=>h.trace(c,...d))},debug(c,...d){r(),i.then(h=>h.debug(c,...d))},info(c,...d){r(),i.then(h=>h.info(c,...d))},warn(c,...d){r(),i.then(h=>h.warn(c,...d))},error(c,...d){r(),i.then(h=>h.error(c,...d))}}}};mo=L([E(0,q),E(1,_e),E(2,Cr),E(3,wi),E(4,St),E(5,se)],mo);const qh=Y("IExtHostOutputService"),Dr=Y("IURITransformerService");class hy{constructor(e){e?(this.transformIncoming=e.transformIncoming.bind(e),this.transformOutgoing=e.transformOutgoing.bind(e),this.transformOutgoingURI=e.transformOutgoingURI.bind(e),this.transformOutgoingScheme=e.transformOutgoingScheme.bind(e)):(this.transformIncoming=t=>t,this.transformOutgoing=t=>t,this.transformOutgoingURI=t=>t,this.transformOutgoingScheme=t=>t)}}function ss(a,e,t){return new fl(i=>za(i,t)).isEqual(a,e)}function uy(a,e,t){return ss(a.uri,e.uri,t)?0:js(a.uri.toString(),e.uri.toString())}function py(a,e,t){return a.index!==e.index?a.index<e.index?-1:1:ss(a.uri,e.uri,t)?js(a.name,e.name):js(a.uri.toString(),e.uri.toString())}function Kh(a,e,t,i){const s=a.slice(0).sort((n,o)=>t(n,o,i)),r=e.slice(0).sort((n,o)=>t(n,o,i));return wp(s,r,(n,o)=>t(n,o,i))}function za(a,e){const t=e.getCapabilities(a.scheme);return!(t&&t&gt.PathCaseSensitive)}class di extends vp{static toExtHostWorkspace(e,t,i,s){if(!e)return{workspace:null,added:[],removed:[]};const{id:r,name:n,folders:o,configuration:c,transient:d,isUntitled:h}=e,f=[],m=t;t?o.forEach((x,S)=>{const C=v.revive(x.uri),T=di._findFolder(i||t,C,s);T?(T.name=x.name,T.index=x.index,f.push(T)):f.push({uri:C,name:x.name,index:S})}):f.push(...o.map(({uri:x,name:S,index:C})=>({uri:v.revive(x),name:S,index:C}))),f.sort((x,S)=>x.index<S.index?-1:1);const l=new di(r,n,f,!!d,c?v.revive(c):null,!!h,x=>za(x,s)),{added:p,removed:_}=Kh(m?m.workspaceFolders:[],l.workspaceFolders,uy,s);return{workspace:l,added:p,removed:_}}static _findFolder(e,t,i){for(let s=0;s<e.folders.length;s++){const r=e.workspaceFolders[s];if(ss(r.uri,t,i))return r}}constructor(e,t,i,s,r,n,o){super(e,i.map(c=>new yp(c)),s,r,o),this._name=t,this._isUntitled=n,this._workspaceFolders=[],this._structure=xa.forUris(o,()=>!0),i.forEach(c=>{this._workspaceFolders.push(c),this._structure.set(c.uri,c)})}get name(){return this._name}get isUntitled(){return this._isUntitled}get workspaceFolders(){return this._workspaceFolders.slice(0)}getWorkspaceFolder(e,t){return t&&this._structure.get(e)&&(e=wa(e)),this._structure.findSubstr(e)}resolveWorkspaceFolder(e){return this._structure.get(e)}}let _o=class{constructor(e,t,i,s,r){this._onDidChangeWorkspace=new D,this.onDidChangeWorkspace=this._onDidChangeWorkspace.event,this._onDidGrantWorkspaceTrust=new D,this.onDidGrantWorkspaceTrust=this._onDidGrantWorkspaceTrust.event,this._activeSearchCallbacks=[],this._trusted=!1,this._editSessionIdentityProviders=new Map,this._providerHandlePool=0,this._onWillCreateEditSessionIdentityEvent=new Vi,this._canonicalUriProviders=new Map,this._logService=s,this._extHostFileSystemInfo=i,this._uriTransformerService=r,this._requestIdProvider=new pp,this._barrier=new mt,this._proxy=e.getProxy(k.MainThreadWorkspace),this._messageService=e.getProxy(k.MainThreadMessageService);const n=t.workspace;this._confirmedWorkspace=n?new di(n.id,n.name,[],!!n.transient,n.configuration?v.revive(n.configuration):null,!!n.isUntitled,o=>za(o,i)):void 0}$initializeWorkspace(e,t){this._trusted=t,this.$acceptWorkspaceData(e),this._barrier.open()}waitForInitializeCall(){return this._barrier.wait()}get workspace(){return this._actualWorkspace}get name(){return this._actualWorkspace?this._actualWorkspace.name:void 0}get workspaceFile(){if(this._actualWorkspace&&this._actualWorkspace.configuration)return this._actualWorkspace.isUntitled?v.from({scheme:G.untitled,path:ml(wa(this._actualWorkspace.configuration))}):this._actualWorkspace.configuration}get _actualWorkspace(){return this._unconfirmedWorkspace||this._confirmedWorkspace}getWorkspaceFolders(){if(this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}async getWorkspaceFolders2(){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.workspaceFolders.slice(0)}updateWorkspaceFolders(e,t,i,...s){const r=[];if(Array.isArray(s)&&s.forEach(h=>{v.isUri(h.uri)&&!r.some(f=>ss(f.uri,h.uri,this._extHostFileSystemInfo))&&r.push({uri:h.uri,name:h.name||bc(h.uri)})}),this._unconfirmedWorkspace||[t,i].some(h=>typeof h!="number"||h<0)||i===0&&r.length===0)return!1;const n=this._actualWorkspace?this._actualWorkspace.workspaceFolders:[];if(t+i>n.length)return!1;const o=n.slice(0);o.splice(t,i,...r.map(h=>({uri:h.uri,name:h.name||bc(h.uri),index:void 0})));for(let h=0;h<o.length;h++){const f=o[h];if(o.some((m,l)=>l!==h&&ss(f.uri,m.uri,this._extHostFileSystemInfo)))return!1}o.forEach((h,f)=>h.index=f);const{added:c,removed:d}=Kh(n,o,py,this._extHostFileSystemInfo);if(c.length===0&&d.length===0)return!1;if(this._proxy){const h=e.displayName||e.name;this._proxy.$updateWorkspaceFolders(h,t,i,r).then(void 0,f=>{this._unconfirmedWorkspace=void 0;const m={source:{identifier:e.identifier,label:e.displayName||e.name}};this._messageService.$showMessage(Te.Error,j(2597,"Extension '{0}' failed to update workspace folders: {1}",h,f.toString()),m,[])})}return this.trySetWorkspaceFolders(o),!0}getWorkspaceFolder(e,t){if(this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(e,t)}async getWorkspaceFolder2(e,t){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.getWorkspaceFolder(e,t)}async resolveWorkspaceFolder(e){if(await this._barrier.wait(),!!this._actualWorkspace)return this._actualWorkspace.resolveWorkspaceFolder(e)}getPath(){if(!this._actualWorkspace)return;const{folders:e}=this._actualWorkspace;if(e.length!==0)return e[0].uri.fsPath}getRelativePath(e,t){let i,s="";if(typeof e=="string"?(i=v.file(e),s=e):typeof e<"u"&&(i=e,s=e.fsPath),!i)return s;const r=this.getWorkspaceFolder(i,!0);if(!r)return s;typeof t>"u"&&this._actualWorkspace&&(t=this._actualWorkspace.folders.length>1);let n=_l(r.uri,i);return t&&r.name&&(n=`${r.name}/${n}`),n}trySetWorkspaceFolders(e){this._actualWorkspace&&(this._unconfirmedWorkspace=di.toExtHostWorkspace({id:this._actualWorkspace.id,name:this._actualWorkspace.name,configuration:this._actualWorkspace.configuration,folders:e,isUntitled:this._actualWorkspace.isUntitled},this._actualWorkspace,void 0,this._extHostFileSystemInfo).workspace||void 0)}$acceptWorkspaceData(e){const{workspace:t,added:i,removed:s}=di.toExtHostWorkspace(e,this._confirmedWorkspace,this._unconfirmedWorkspace,this._extHostFileSystemInfo);this._confirmedWorkspace=t||void 0,this._unconfirmedWorkspace=void 0,this._onDidChangeWorkspace.fire(Object.freeze({added:i,removed:s}))}findFiles(e,t,i,s,r=de.None){this._logService.trace(`extHostWorkspace#findFiles: fileSearch, extension: ${s.value}, entryPoint: findFiles`);let n="",o=!0;return t===null?o=!1:t!==void 0&&(typeof t=="string"?n=t:n=t.pattern),this._findFilesImpl({type:"include",value:e},{exclude:[n],maxResults:i,useExcludeSettings:o?kt.FilesExclude:kt.None,useIgnoreFiles:{local:!1}},r)}findFiles2(e,t={},i,s=de.None){return this._logService.trace(`extHostWorkspace#findFiles2New: fileSearch, extension: ${i.value}, entryPoint: findFiles2New`),this._findFilesImpl({type:"filePatterns",value:e},t,s)}async _findFilesImpl(e,t,i){if(i.isCancellationRequested)return Promise.resolve([]);const s=e.type==="include"?[e.value]:e.value??[];if(!Array.isArray(s))throw console.error("Invalid file pattern provided",s),new Error(`Invalid file pattern provided ${JSON.stringify(s)}`);const r=s.map(n=>{const o=md(t.exclude),c={ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles?.local=="boolean"?!t.useIgnoreFiles.local:void 0,disregardGlobalIgnoreFiles:typeof t.useIgnoreFiles?.global=="boolean"?!t.useIgnoreFiles.global:void 0,disregardParentIgnoreFiles:typeof t.useIgnoreFiles?.parent=="boolean"?!t.useIgnoreFiles.parent:void 0,disregardExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings===kt.None,disregardSearchExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings!==kt.SearchAndFilesExclude,maxResults:t.maxResults,excludePattern:o.length>0?o:void 0,_reason:"startFileSearch",shouldGlobSearch:e.type==="include"?void 0:!0},d=Us(Ps.from(n)),h=d?.folder;return e.type==="include"?c.includePattern=d?.pattern:c.filePattern=d?.pattern,{folder:h,options:c}});return this._findFilesBase(r,i)}async _findFilesBase(e,t){return(await Promise.all(e?.map(s=>this._proxy.$startFileSearch(s.folder??null,s.options,t).then(r=>Array.isArray(r)?r.map(n=>v.revive(n)):[]))??[])).flat()}findTextInFiles2(e,t,i,s=de.None){this._logService.trace(`extHostWorkspace#findTextInFiles2: textSearch, extension: ${i.value}, entryPoint: findTextInFiles2`);const r=m=>{if(!t)return{folder:void 0,options:{}};const l=m?Us(Ps.from(m)):void 0,p=t.exclude?md(t.exclude):void 0;return{options:{ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles=="boolean"?!t.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof t.useIgnoreFiles?.global=="boolean"?!t.useIgnoreFiles?.global:void 0,disregardParentIgnoreFiles:typeof t.useIgnoreFiles?.parent=="boolean"?!t.useIgnoreFiles?.parent:void 0,disregardExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings===kt.None,disregardSearchExcludeSettings:t.useExcludeSettings!==void 0&&t.useExcludeSettings!==kt.SearchAndFilesExclude,fileEncoding:t.encoding,maxResults:t.maxResults,previewOptions:t.previewOptions?{matchLines:t.previewOptions?.numMatchLines??100,charsPerLine:t.previewOptions?.charsPerLine??1e4}:void 0,surroundingContext:t.surroundingContext,includePattern:l?.pattern,excludePattern:p},folder:l?.folder}},o=(t?.include?.map(m=>r(m))??[r(void 0)]).filter(m=>!!m),c=new N,d=c.add(new D),h=this.findTextInFilesBase(e,o,(m,l)=>d.fire({result:m,uri:l}),s);return{results:new xr(async m=>{c.add(d.event(l=>{const p=l.result,_=l.uri;qc(p)?m.emitOne(new _t(_,p.rangeLocations.map(x=>({previewRange:new ce(x.preview.startLineNumber,x.preview.startColumn,x.preview.endLineNumber,x.preview.endColumn),sourceRange:new ce(x.source.startLineNumber,x.source.startColumn,x.source.endLineNumber,x.source.endColumn)})),p.previewText)):m.emitOne(new ka(_,p.text,p.lineNumber))})),await h}),complete:h.then(m=>(c.dispose(),{limitHit:m?.limitHit??!1}))}}async findTextInFilesBase(e,t,i,s=de.None){const r=this._requestIdProvider.getNext();let n=!1;if(s.onCancellationRequested(o=>{n=!0}),this._activeSearchCallbacks[r]=o=>{if(n)return;const c=v.revive(o.resource);o.results.forEach(d=>{const h=qe(d);i(h,c)})},s.isCancellationRequested)return{};try{const o=await Promise.all(t?.map(c=>this._proxy.$startTextSearch(e,c.folder??null,c.options,r,s)||{})??[]);return delete this._activeSearchCallbacks[r],o.reduce((c,d)=>({limitHit:c?.limitHit||(d?.limitHit??!1),message:[c?.message??[],d?.message??[]].flat()}),{})??{limitHit:!1}}catch(o){throw delete this._activeSearchCallbacks[r],o}}async findTextInFiles(e,t,i,s,r=de.None){this._logService.trace(`extHostWorkspace#findTextInFiles: textSearch, extension: ${s.value}, entryPoint: findTextInFiles`);const n=typeof t.previewOptions>"u"?{matchLines:100,charsPerLine:1e4}:t.previewOptions,o=Us(Ps.from(t.include)),c=typeof t.exclude=="string"?t.exclude:t.exclude?t.exclude.pattern:void 0,d={ignoreSymlinks:typeof t.followSymlinks=="boolean"?!t.followSymlinks:void 0,disregardIgnoreFiles:typeof t.useIgnoreFiles=="boolean"?!t.useIgnoreFiles:void 0,disregardGlobalIgnoreFiles:typeof t.useGlobalIgnoreFiles=="boolean"?!t.useGlobalIgnoreFiles:void 0,disregardParentIgnoreFiles:typeof t.useParentIgnoreFiles=="boolean"?!t.useParentIgnoreFiles:void 0,disregardExcludeSettings:typeof t.useDefaultExcludes=="boolean"?!t.useDefaultExcludes:!0,disregardSearchExcludeSettings:typeof t.useSearchExclude=="boolean"?!t.useSearchExclude:!0,fileEncoding:t.encoding,maxResults:t.maxResults,previewOptions:n,surroundingContext:t.afterContext,includePattern:o?.pattern,excludePattern:c?[{pattern:c}]:void 0},h=(f,m)=>{qc(f)?i({uri:m,preview:{text:f.previewText,matches:Ec(f.rangeLocations,l=>new ce(l.preview.startLineNumber,l.preview.startColumn,l.preview.endLineNumber,l.preview.endColumn))},ranges:Ec(f.rangeLocations,l=>new ce(l.source.startLineNumber,l.source.startColumn,l.source.endLineNumber,l.source.endColumn))}):i({uri:m,text:f.text,lineNumber:f.lineNumber})};return this.findTextInFilesBase(e,[{options:d,folder:o?.folder}],h,r)}$handleTextSearchResult(e,t){this._activeSearchCallbacks[t]?.(e)}async save(e){const t=await this._proxy.$save(e,{saveAs:!1});return v.revive(t)}async saveAs(e){const t=await this._proxy.$save(e,{saveAs:!0});return v.revive(t)}saveAll(e){return this._proxy.$saveAll(e)}resolveProxy(e){return this._proxy.$resolveProxy(e)}lookupAuthorization(e){return this._proxy.$lookupAuthorization(e)}lookupKerberosAuthorization(e){return this._proxy.$lookupKerberosAuthorization(e)}loadCertificates(){return this._proxy.$loadCertificates()}get trusted(){return this._trusted}requestWorkspaceTrust(e){return this._proxy.$requestWorkspaceTrust(e)}$onDidGrantWorkspaceTrust(){this._trusted||(this._trusted=!0,this._onDidGrantWorkspaceTrust.fire())}registerEditSessionIdentityProvider(e,t){if(this._editSessionIdentityProviders.has(e))throw new Error(`A provider has already been registered for scheme ${e}`);this._editSessionIdentityProviders.set(e,t);const i=this._uriTransformerService.transformOutgoingScheme(e),s=this._providerHandlePool++;return this._proxy.$registerEditSessionIdentityProvider(s,i),V(()=>{this._editSessionIdentityProviders.delete(e),this._proxy.$unregisterEditSessionIdentityProvider(s)})}async $getEditSessionIdentifier(e,t){this._logService.info("Getting edit session identifier for workspaceFolder",e);const i=await this.resolveWorkspaceFolder(v.revive(e));if(!i){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",i);const s=this._editSessionIdentityProviders.get(i.uri.scheme);if(this._logService.info(`Provider for scheme ${i.uri.scheme} is defined: `,!!s),!s)return;const r=await s.provideEditSessionIdentity(i,t);if(this._logService.info("Provider returned edit session identifier: ",r),!!r)return r}async $provideEditSessionIdentityMatch(e,t,i,s){this._logService.info("Getting edit session identifier for workspaceFolder",e);const r=await this.resolveWorkspaceFolder(v.revive(e));if(!r){this._logService.warn("Unable to resolve workspace folder");return}this._logService.info("Invoking #provideEditSessionIdentity for workspaceFolder",r);const n=this._editSessionIdentityProviders.get(r.uri.scheme);if(this._logService.info(`Provider for scheme ${r.uri.scheme} is defined: `,!!n),!n)return;const o=await n.provideEditSessionIdentityMatch?.(t,i,s);if(this._logService.info("Provider returned edit session identifier match result: ",o),!!o)return o}getOnWillCreateEditSessionIdentityEvent(e){return(t,i,s)=>{const r=function(o){t.call(i,o)};return r.extension=e,this._onWillCreateEditSessionIdentityEvent.event(r,void 0,s)}}async $onWillCreateEditSessionIdentity(e,t,i){const s=await this.resolveWorkspaceFolder(v.revive(e));if(s===void 0)throw new Error("Unable to resolve workspace folder");await this._onWillCreateEditSessionIdentityEvent.fireAsync({workspaceFolder:s},t,async(r,n)=>{const o=Date.now();await Promise.resolve(r),Date.now()-o>i&&this._logService.warn("SLOW edit session create-participant",n.extension.identifier)}),t.isCancellationRequested}registerCanonicalUriProvider(e,t){if(this._canonicalUriProviders.has(e))throw new Error(`A provider has already been registered for scheme ${e}`);this._canonicalUriProviders.set(e,t);const i=this._uriTransformerService.transformOutgoingScheme(e),s=this._providerHandlePool++;return this._proxy.$registerCanonicalUriProvider(s,i),V(()=>{this._canonicalUriProviders.delete(e),this._proxy.$unregisterCanonicalUriProvider(s)})}async provideCanonicalUri(e,t,i){const s=this._canonicalUriProviders.get(e.scheme);if(!s)return;const r=await s.provideCanonicalUri?.(v.revive(e),t,i);if(r)return r}async $provideCanonicalUri(e,t,i){return this.provideCanonicalUri(v.revive(e),{targetScheme:t},i)}async decode(e,t){const[i,s]=this.toEncodeDecodeParameters(t),r=await this._proxy.$resolveDecoding(i,s),n=(await ry(fp(be.wrap(e)),{...r,acceptTextOnly:!0,overwriteEncoding:o=>o===null||o===r.preferredEncoding?Promise.resolve(r.preferredEncoding):this._proxy.$validateDetectedEncoding(i,o,s)})).stream;return gp(n,o=>o.join(""))}async encode(e,t){const[i,s]=this.toEncodeDecodeParameters(t),{encoding:r,addBOM:n}=await this._proxy.$resolveEncoding(i,s);if(r===ny&&!n)return be.fromString(e).buffer;const o=await oy(ay(e),r,{addBOM:n});return mp(o).buffer}toEncodeDecodeParameters(e){const t=_p(e?.uri)?e.uri:void 0,i=typeof e?.encoding=="string"?e.encoding:void 0;return[t,i?{encoding:i}:void 0]}};_o=L([E(0,q),E(1,_e),E(2,wi),E(3,se),E(4,Dr)],_o);const rt=Y("IExtHostWorkspace");function Us(a){let e,t;if(a)return typeof a=="string"?e=a:(e=a.pattern,t=v.revive(a.baseUri)),{pattern:e,folder:t}}function md(a){return(a?.map(e=>{if(typeof e=="string")return e===""?void 0:{pattern:e,uri:void 0};{const t=Us(e);return t?{pattern:t.pattern,uri:t.folder}:void 0}})??[]).filter(e=>!!e)}var Oi;let vo=class{static{Oi=this}static{this._handlePool=0}static{this._maxEventSize=250}constructor(e,t){this._logService=t,this._provider=new Map,this._proxy=e.getProxy(k.MainThreadDecorations)}registerFileDecorationProvider(e,t){const i=Oi._handlePool++;this._provider.set(i,{provider:e,extensionDescription:t}),this._proxy.$registerDecorationProvider(i,t.identifier.value);const s=e.onDidChangeFileDecorations&&e.onDidChangeFileDecorations(r=>{if(!r){this._proxy.$onDidChange(i,null);return}const n=Ge(r);if(n.length<=Oi._maxEventSize){this._proxy.$onDidChange(i,n);return}this._logService.warn("[Decorations] CAPPING events from decorations provider",t.identifier.value,n.length);const o=n.map(h=>({uri:h,rank:xp(h.path,"/")})),c=bp(o,(h,f)=>h.rank-f.rank||js(h.uri.path,f.uri.path)),d=[];e:for(const h of c){let f;for(const m of h){const l=vl(m.uri.path);if(f!==l&&(f=l,d.push(m.uri)>=Oi._maxEventSize))break e}}this._proxy.$onDidChange(i,d)});return new W(()=>{s?.dispose(),this._proxy.$unregisterDecorationProvider(i),this._provider.delete(i)})}async $provideDecorations(e,t,i){if(!this._provider.has(e))return Object.create(null);const s=Object.create(null),{provider:r,extensionDescription:n}=this._provider.get(e);return await Promise.all(t.map(async o=>{try{const{uri:c,id:d}=o,h=await Promise.resolve(r.provideFileDecoration(v.revive(c),i));if(!h)return;try{Dn.validate(h),h.badge&&typeof h.badge!="string"&&b(n,"codiconDecoration"),s[d]=[h.propagate,h.tooltip,h.badge,h.color]}catch(f){this._logService.warn(`INVALID decoration from extension '${n.identifier.value}': ${f}`)}}catch(c){this._logService.error(c)}})),s}};vo=Oi=L([E(0,q),E(1,se)],vo);const Gh=Y("IExtHostDecorations");function ys(a,e){if(e){const t=e.split(".");let i=a;for(let s=0;i&&s<t.length;s++)i=i[t[s]];return i}}function fy(a){return a instanceof v}function gy(a){return a&&a.uri instanceof v&&a.languageId&&typeof a.languageId=="string"}function my(a){return a&&!a.uri&&a.languageId&&typeof a.languageId=="string"}function _y(a){return a&&a.uri instanceof v&&(!a.name||typeof a.name=="string")&&(!a.index||typeof a.index=="number")}function _d(a){if(fy(a))return{resource:a};if(gy(a))return{resource:a.uri,overrideIdentifier:a.languageId};if(my(a))return{overrideIdentifier:a.languageId};if(_y(a))return{resource:a.uri};if(a===null)return{resource:null}}let yo=class{constructor(e,t,i){this._proxy=e.getProxy(k.MainThreadConfiguration),this._extHostWorkspace=t,this._logService=i,this._barrier=new mt,this._actual=null}getConfigProvider(){return this._barrier.wait().then(e=>this._actual)}$initializeConfiguration(e){this._actual=new vy(this._proxy,this._extHostWorkspace,e,this._logService),this._barrier.open()}$acceptConfigurationChanged(e,t){this.getConfigProvider().then(i=>i.$acceptConfigurationChanged(e,t))}};yo=L([E(0,q),E(1,rt),E(2,se)],yo);class vy{constructor(e,t,i,s){this._onDidChangeConfiguration=new D,this._proxy=e,this._logService=s,this._extHostWorkspace=t,this._configuration=Sc.parse(i,s),this._configurationScopes=this._toMap(i.configurationScopes)}get onDidChangeConfiguration(){return this._onDidChangeConfiguration&&this._onDidChangeConfiguration.event}$acceptConfigurationChanged(e,t){const i={data:this._configuration.toData(),workspace:this._extHostWorkspace.workspace};this._configuration=Sc.parse(e,this._logService),this._configurationScopes=this._toMap(e.configurationScopes),this._onDidChangeConfiguration.fire(this._toConfigurationChangeEvent(t,i))}getConfiguration(e,t,i){const s=_d(t)||{},r=this._toReadonlyValue(this._configuration.getValue(e,s,this._extHostWorkspace.workspace));e&&this._validateConfigurationAccess(e,s,i?.identifier);function n(c){if(c==null)return null;if(typeof c=="boolean")return c?At.USER:At.WORKSPACE;switch(c){case Ts.Global:return At.USER;case Ts.Workspace:return At.WORKSPACE;case Ts.WorkspaceFolder:return At.WORKSPACE_FOLDER}}const o={has(c){return typeof ys(r,c)<"u"},get:(c,d)=>{this._validateConfigurationAccess(e?`${e}.${c}`:c,s,i?.identifier);let h=ys(r,c);if(typeof h>"u")h=d;else{let f;const m=(l,p)=>{if(gn(l)){let _;const x=()=>{f=f||De(r),_=_||ys(f,p)};return new Proxy(l,{get:(S,C)=>{if(typeof C=="string"&&C.toLowerCase()==="tojson")return x(),()=>_;if(f)return _=_||ys(f,p),_[C];const T=S[C];return typeof C=="string"?m(T,`${p}.${C}`):T},set:(S,C,T)=>(x(),_&&(_[C]=T),!0),deleteProperty:(S,C)=>(x(),_&&delete _[C],!0),defineProperty:(S,C,T)=>(x(),_&&Object.defineProperty(_,C,T),!0)})}return Array.isArray(l)?De(l):l};h=m(h,c)}return h},update:(c,d,h,f)=>{c=e?`${e}.${c}`:c;const m=n(h);return d!==void 0?this._proxy.$updateConfigurationOption(m,c,d,s,f):this._proxy.$removeConfigurationOption(m,c,s,f)},inspect:c=>{c=e?`${e}.${c}`:c;const d=this._configuration.inspect(c,s,this._extHostWorkspace.workspace);if(d)return{key:c,defaultValue:De(d.policy?.value??d.default?.value),globalLocalValue:De(d.userLocal?.value),globalRemoteValue:De(d.userRemote?.value),globalValue:De(d.user?.value??d.application?.value),workspaceValue:De(d.workspace?.value),workspaceFolderValue:De(d.workspaceFolder?.value),defaultLanguageValue:De(d.default?.override),globalLocalLanguageValue:De(d.userLocal?.override),globalRemoteLanguageValue:De(d.userRemote?.override),globalLanguageValue:De(d.user?.override??d.application?.override),workspaceLanguageValue:De(d.workspace?.override),workspaceFolderLanguageValue:De(d.workspaceFolder?.override),languageIds:De(d.overrideIdentifiers)}}};return typeof r=="object"&&qs(o,r,!1),Object.freeze(o)}_toReadonlyValue(e){const t=i=>gn(i)?new Proxy(i,{get:(s,r)=>t(s[r]),set:(s,r,n)=>{throw new Error(`TypeError: Cannot assign to read only property '${String(r)}' of object`)},deleteProperty:(s,r)=>{throw new Error(`TypeError: Cannot delete read only property '${String(r)}' of object`)},defineProperty:(s,r)=>{throw new Error(`TypeError: Cannot define property '${String(r)}' for a readonly object`)},setPrototypeOf:s=>{throw new Error("TypeError: Cannot set prototype for a readonly object")},isExtensible:()=>!1,preventExtensions:()=>!0}):i;return t(e)}_validateConfigurationAccess(e,t,i){const s=Ep.test(e)?Or.RESOURCE:this._configurationScopes.get(e),r=i?`[${i.value}] `:"";if(Or.RESOURCE===s){typeof t?.resource>"u"&&this._logService.warn(`${r}Accessing a resource scoped configuration without providing a resource is not expected. To get the effective value for '${e}', provide the URI of a resource or 'null' for any resource.`);return}if(Or.WINDOW===s){t?.resource&&this._logService.warn(`${r}Accessing a window scoped configuration for a resource is not expected. To associate '${e}' to a resource, define its scope to 'resource' in configuration contributions in 'package.json'.`);return}}_toConfigurationChangeEvent(e,t){const i=new Sp(e,t,this._configuration,this._extHostWorkspace.workspace,this._logService);return Object.freeze({affectsConfiguration:(s,r)=>i.affectsConfiguration(s,_d(r))})}_toMap(e){return e.reduce((t,i)=>(t.set(i[0],i[1]),t),new Map)}}const nt=Y("IExtHostConfiguration"),Tt=(a,e,t,i)=>{let s=e;return{enumerable:!0,configurable:!1,get(){return s},set(r){if(!t(s,r)){const n=s;s=r,a.listener?.(i(r,n))}}}},Yt=(a,e)=>a===e,dt={range:(a,e)=>a===e?!0:!a||!e?!1:a.isEqual(e),label:Yt,description:Yt,sortText:Yt,busy:Yt,error:Yt,canResolveChildren:Yt,tags:(a,e)=>!(a.length!==e.length||a.some(t=>!e.find(i=>t.id===i.id)))},Zt=a=>e=>({op:ks.SetProp,update:a(e)}),yy=(a,e)=>({range:(()=>{let t;const i=Zt(s=>({range:Ut.lift(A.from(s))}));return{enumerable:!0,configurable:!1,get(){return t},set(s){a.listener?.({op:ks.DocumentSynced}),dt.range(t,s)||(t=s,a.listener?.(i(s)))}}})(),label:Tt(a,e,dt.label,Zt(t=>({label:t}))),description:Tt(a,void 0,dt.description,Zt(t=>({description:t}))),sortText:Tt(a,void 0,dt.sortText,Zt(t=>({sortText:t}))),canResolveChildren:Tt(a,!1,dt.canResolveChildren,t=>({op:ks.UpdateCanResolveChildren,state:t})),busy:Tt(a,!1,dt.busy,Zt(t=>({busy:t}))),error:Tt(a,void 0,dt.error,Zt(t=>({error:ae.fromStrict(t)||null}))),tags:Tt(a,[],dt.tags,(t,i)=>({op:ks.SetTags,new:t.map(ts.from),old:i.map(ts.from)}))}),wy=a=>{const e=oe.fromString(a.extId),t=new zt(e.controllerId,e.localId,a.label,v.revive(a.uri)||void 0);return t.range=A.to(a.range||void 0),t.description=a.description||void 0,t.sortText=a.sortText||void 0,t.tags=a.tags.map(i=>ts.to({id:Kf(i).tagId})),t},vd=a=>{let e;for(const t of a.tests){const i=wy(t.item);Ia(i).parent=e,e=i}return e};class zt{constructor(e,t,i,s){if(t.includes(Bf.Delimiter))throw new Error(`Test IDs may not include the ${JSON.stringify(t)} symbol`);const r=zf(this,e);Object.defineProperties(this,{id:{value:t,enumerable:!0,writable:!1},uri:{value:s,enumerable:!0,writable:!1},parent:{enumerable:!1,get(){return r.parent instanceof ja?void 0:r.parent}},children:{value:jf(r,Ia,zt),enumerable:!0,writable:!1},...yy(r,i)})}}class ja extends zt{constructor(e,t){super(e,e,t,void 0),this._isRoot=!0}}class xy extends qf{constructor(e,t,i){super({controllerId:e,getDocumentVersion:s=>s&&i.getDocument(s)?.version,getApiFor:Ia,getChildren:s=>s.children,root:new ja(e,t),toITestItem:cs.from})}}let yd=class extends Z{constructor(e,t,i){super(),this.initData=t,this._onDidChangeTelemetryEnabled=this._register(new D),this.onDidChangeTelemetryEnabled=this._onDidChangeTelemetryEnabled.event,this._onDidChangeTelemetryConfiguration=this._register(new D),this.onDidChangeTelemetryConfiguration=this._onDidChangeTelemetryConfiguration.event,this._productConfig={usage:!0,error:!0},this._level=Pi.NONE,this._inLoggingOnlyMode=!1,this._telemetryLoggers=new Map,this._inLoggingOnlyMode=this.initData.environment.isExtensionTelemetryLoggingOnly;const s=t.remote.isRemote?"remoteExtHostTelemetry":e?"workerExtHostTelemetry":"extHostTelemetry";this._outputLogger=this._register(i.createLogger(s,{name:j(2592,"Extension Telemetry{0}",this._inLoggingOnlyMode?" (Not Sent)":""),hidden:!0,group:Cp}))}getTelemetryConfiguration(){return this._level===Pi.USAGE}getTelemetryDetails(){return{isCrashEnabled:this._level>=Pi.CRASH,isErrorsEnabled:this._productConfig.error?this._level>=Pi.ERROR:!1,isUsageEnabled:this._productConfig.usage?this._level>=Pi.USAGE:!1}}instantiateLogger(e,t,i){const s=this.getTelemetryDetails(),r=new Qh(t,i,e,this._outputLogger,this._inLoggingOnlyMode,this.getBuiltInCommonProperties(e),{isUsageEnabled:s.isUsageEnabled,isErrorsEnabled:s.isErrorsEnabled}),n=this._telemetryLoggers.get(e.identifier.value)??[];return this._telemetryLoggers.set(e.identifier.value,[...n,r]),r.apiTelemetryLogger}$initializeTelemetryLevel(e,t,i){this._level=e,this._productConfig=i??{usage:!0,error:!0}}getBuiltInCommonProperties(e){const t=Object.create(null);switch(t["common.extname"]=`${e.publisher}.${e.name}`,t["common.extversion"]=e.version,t["common.vscodemachineid"]=this.initData.telemetryInfo.machineId,t["common.vscodesessionid"]=this.initData.telemetryInfo.sessionId,t["common.vscodecommithash"]=this.initData.commit,t["common.sqmid"]=this.initData.telemetryInfo.sqmId,t["common.devDeviceId"]=this.initData.telemetryInfo.devDeviceId,t["common.vscodeversion"]=this.initData.version,t["common.isnewappinstall"]=Jh(this.initData.telemetryInfo.firstSessionDate),t["common.product"]=this.initData.environment.appHost,this.initData.uiKind){case Pn.Web:t["common.uikind"]="web";break;case Pn.Desktop:t["common.uikind"]="desktop";break;default:t["common.uikind"]="unknown"}return t["common.remotename"]=yl(Dp(this.initData.remote.authority)),t}$onDidChangeTelemetryLevel(e){this._oldTelemetryEnablement=this.getTelemetryConfiguration(),this._level=e;const t=this.getTelemetryDetails();this._telemetryLoggers.forEach((i,s)=>{const r=i.filter(n=>!n.isDisposed);r.length===0?this._telemetryLoggers.delete(s):this._telemetryLoggers.set(s,r)}),this._telemetryLoggers.forEach(i=>{for(const s of i)s.updateTelemetryEnablements(t.isUsageEnabled,t.isErrorsEnabled)}),this._oldTelemetryEnablement!==this.getTelemetryConfiguration()&&this._onDidChangeTelemetryEnabled.fire(this.getTelemetryConfiguration()),this._onDidChangeTelemetryConfiguration.fire(this.getTelemetryDetails())}onExtensionError(e,t){const s=this._telemetryLoggers.get(e.value)?.filter(n=>!n.isDisposed);if(!s)return this._telemetryLoggers.delete(e.value),!1;let r=!1;for(const n of s)n.ignoreUnhandledExtHostErrors||(n.logError(t),r=!0);return r}};yd=L([E(1,_e),E(2,St)],yd);class Qh{static validateSender(e){if(typeof e!="object")throw new TypeError("TelemetrySender argument is invalid");if(typeof e.sendEventData!="function")throw new TypeError("TelemetrySender.sendEventData must be a function");if(typeof e.sendErrorData!="function")throw new TypeError("TelemetrySender.sendErrorData must be a function");if(typeof e.flush<"u"&&typeof e.flush!="function")throw new TypeError("TelemetrySender.flush must be a function or undefined")}constructor(e,t,i,s,r,n,o){this._extension=i,this._logger=s,this._inLoggingOnlyMode=r,this._commonProperties=n,this._onDidChangeEnableStates=new D,this.ignoreUnhandledExtHostErrors=t?.ignoreUnhandledErrors??!1,this._ignoreBuiltinCommonProperties=t?.ignoreBuiltInCommonProperties??!1,this._additionalCommonProperties=t?.additionalCommonProperties,this._sender=e,this._telemetryEnablements={isUsageEnabled:o.isUsageEnabled,isErrorsEnabled:o.isErrorsEnabled}}updateTelemetryEnablements(e,t){this._apiObject&&(this._telemetryEnablements={isUsageEnabled:e,isErrorsEnabled:t},this._onDidChangeEnableStates.fire(this._apiObject))}mixInCommonPropsAndCleanData(e){let t="properties"in e?e.properties??{}:e;return t=Cc(t,[]),this._additionalCommonProperties&&(t=qs(t,this._additionalCommonProperties)),this._ignoreBuiltinCommonProperties||(t=qs(t,this._commonProperties)),"properties"in e?e.properties=t:e=t,e}logEvent(e,t){this._sender&&(this._extension.publisher==="vscode"?e=this._extension.name+"/"+e:e=this._extension.identifier.value+"/"+e,t=this.mixInCommonPropsAndCleanData(t||{}),this._inLoggingOnlyMode||this._sender?.sendEventData(e,t),this._logger.trace(e,t))}logUsage(e,t){this._telemetryEnablements.isUsageEnabled&&this.logEvent(e,t)}logError(e,t){if(!(!this._telemetryEnablements.isErrorsEnabled||!this._sender))if(typeof e=="string")this.logEvent(e,t);else{const i={name:e.name,message:e.message,stack:e.stack,cause:e.cause},s=Cc(i,[]),r=new Error(s.message,{cause:s.cause});r.stack=s.stack,r.name=s.name,t=this.mixInCommonPropsAndCleanData(t||{}),this._inLoggingOnlyMode||this._sender.sendErrorData(r,t),this._logger.trace("exception",t)}}get apiTelemetryLogger(){if(!this._apiObject){const e=this,t={logUsage:e.logUsage.bind(e),get isUsageEnabled(){return e._telemetryEnablements.isUsageEnabled},get isErrorsEnabled(){return e._telemetryEnablements.isErrorsEnabled},logError:e.logError.bind(e),dispose:e.dispose.bind(e),onDidChangeEnableStates:e._onDidChangeEnableStates.event.bind(e)};this._apiObject=Object.freeze(t)}return this._apiObject}get isDisposed(){return!this._sender}dispose(){if(this._sender?.flush){let e=this._sender;this._sender=void 0,Promise.resolve(e.flush()).then(e=void 0),this._apiObject=void 0}else this._sender=void 0}}function Jh(a){const e=Date.now()-new Date(a).getTime();return isNaN(e)?!1:e<1e3*60*60*24}const qa=Y("IExtHostTelemetry");let wo=class{#e;#t;#i;constructor(e,t,i){this._commands=new Map,this._apiCommands=new Map,this.#e=e.getProxy(k.MainThreadCommands),this._logService=t,this.#i=i,this.#t=e.getProxy(k.MainThreadTelemetry),this.converter=new by(this,s=>{const r=this._apiCommands.get(s);return r?.result===M.Void?r:void 0},t),this._argumentProcessors=[{processArgument(s){return qe(s)}},{processArgument(s){return Dc(s,function(r){if(Ut.isIRange(r))return A.to(r);if(Tp.isIPosition(r))return te.to(r);if(Ut.isIRange(r.range)&&v.isUri(r.uri))return st.to(r);if(r instanceof be)return r.buffer.buffer;if(!Array.isArray(r))return r})}}]}registerArgumentProcessor(e){this._argumentProcessors.push(e)}registerApiCommand(e){const t=this.registerCommand(!1,e.id,async(...i)=>{const s=e.args.map((n,o)=>{if(!n.validate(i[o]))throw new Error(`Invalid argument '${n.name}' when running '${e.id}', received: ${typeof i[o]=="object"?JSON.stringify(i[o],null,"	"):i[o]} `);return n.convert(i[o])}),r=await this.executeCommand(e.internalId,...s);return e.result.convert(r,i,this.converter)},void 0,{description:e.description,args:e.args,returns:e.result.description});return this._apiCommands.set(e.id,e),new W(()=>{t.dispose(),this._apiCommands.delete(e.id)})}registerCommand(e,t,i,s,r,n){if(this._logService.trace("ExtHostCommands#registerCommand",t),!t.trim().length)throw new Error("invalid id");if(this._commands.has(t))throw new Error(`command '${t}' already exists`);return this._commands.set(t,{callback:i,thisArg:s,metadata:r,extension:n}),e&&this.#e.$registerCommand(t),new W(()=>{this._commands.delete(t)&&e&&this.#e.$unregisterCommand(t)})}executeCommand(e,...t){return this._logService.trace("ExtHostCommands#executeCommand",e),this._doExecuteCommand(e,t,!0)}async _doExecuteCommand(e,t,i){if(this._commands.has(e))return this.#e.$fireCommandActivationEvent(e),this._executeContributedCommand(e,t,!1);{let s=!1;const r=Dc(t,function(n){if(n instanceof Fe)return te.from(n);if(n instanceof ce)return A.from(n);if(n instanceof _i)return st.from(n);if(ai.isNotebookRange(n))return bt.from(n);if(n instanceof ArrayBuffer)return s=!0,be.wrap(new Uint8Array(n));if(n instanceof Uint8Array)return s=!0,be.wrap(n);if(n instanceof be)return s=!0,n;if(!Array.isArray(n))return n});try{const n=await this.#e.$executeCommand(e,s?new Qe(r):r,i);return qe(n)}catch(n){if(n instanceof Error&&n.message==="$executeCommand:retry")return this._doExecuteCommand(e,t,!1);throw n}}}async _executeContributedCommand(e,t,i){const s=this._commands.get(e);if(!s)throw new Error("Unknown command");const{callback:r,thisArg:n,metadata:o}=s;if(o?.args)for(let d=0;d<o.args.length;d++)try{Pp(t[d],o.args[d].constraint)}catch{throw new Error(`Running the contributed command: '${e}' failed. Illegal argument '${o.args[d].name}' - ${o.args[d].description}`)}const c=ui.create();try{return await r.apply(n,t)}catch(d){if(e===this.converter.delegatingCommandId){const h=this.converter.getActualCommand(...t);h&&(e=h.command)}if(Wt(d)||this._logService.error(d,e,s.extension?.identifier),!i)throw d;if(s.extension?.identifier){const h=this.#i.onExtensionError(s.extension.identifier,d);this._logService.trace("forwarded error to extension?",h,s.extension?.identifier)}throw new class extends Error{constructor(){super(br(d)),this.id=e,this.source=s.extension?.displayName??s.extension?.name}}}finally{this._reportTelemetry(s,e,c.elapsed())}}_reportTelemetry(e,t,i){e.extension&&this.#t.$publicLog2("Extension:ActionExecuted",{extensionId:e.extension.identifier.value,id:new wl(t),duration:i})}$executeContributedCommand(e,...t){this._logService.trace("ExtHostCommands#$executeContributedCommand",e);const i=this._commands.get(e);return i?(t=t.map(s=>this._argumentProcessors.reduce((r,n)=>n.processArgument(r,i.extension),s)),this._executeContributedCommand(e,t,!0)):Promise.reject(new Error(`Contributed command '${e}' does not exist.`))}getCommands(e=!1){return this._logService.trace("ExtHostCommands#getCommands",e),this.#e.$getCommands().then(t=>(e&&(t=t.filter(i=>i[0]!=="_")),t))}$getContributedCommandMetadata(){const e=Object.create(null);for(const[t,i]of this._commands){const{metadata:s}=i;s&&(e[t]=s)}return Promise.resolve(e)}};wo=L([E(0,q),E(1,se),E(2,qa)],wo);const jt=Y("IExtHostCommands");class by{constructor(e,t,i){this._commands=e,this._lookupApiCommand=t,this._logService=i,this.delegatingCommandId=`__vsc${Ct()}`,this._cache=new Map,this._cachIdPool=0,this._commands.registerCommand(!0,this.delegatingCommandId,this._executeConvertedCommand,this)}toInternal(e,t){if(!e)return;const i={$ident:void 0,id:e.command,title:e.title,tooltip:e.tooltip};if(!e.command)return i;const s=this._lookupApiCommand(e.command);if(s)i.id=s.internalId,i.arguments=s.args.map((r,n)=>r.convert(e.arguments&&e.arguments[n]));else if(Er(e.arguments)){const r=`${e.command} /${++this._cachIdPool}`;this._cache.set(r,e),t.add(V(()=>{this._cache.delete(r),this._logService.trace("CommandsConverter#DISPOSE",r)})),i.$ident=r,i.id=this.delegatingCommandId,i.arguments=[r],this._logService.trace("CommandsConverter#CREATE",e.command,r)}return i}fromInternal(e){return typeof e.$ident=="string"?this._cache.get(e.$ident):{command:e.id,title:e.title,arguments:e.arguments}}getActualCommand(...e){return this._cache.get(e[0])}_executeConvertedCommand(...e){const t=this.getActualCommand(...e);return this._logService.trace("CommandsConverter#EXECUTE",e[0],t?t.command:"MISSING"),t?this._commands.executeCommand(t.command,...t.arguments||[]):Promise.reject(`Actual command not found, wanted to execute ${e[0]}`)}}class P{static{this.Uri=new P("uri","Uri of a text document",e=>v.isUri(e),e=>e)}static{this.Position=new P("position","A position in a text document",e=>Fe.isPosition(e),te.from)}static{this.Range=new P("range","A range in a text document",e=>ce.isRange(e),A.from)}static{this.Selection=new P("selection","A selection in a text document",e=>mi.isSelection(e),it.from)}static{this.Number=new P("number","",e=>typeof e=="number",e=>e)}static{this.String=new P("string","",e=>typeof e=="string",e=>e)}static Arr(e){return new P(`${e.name}_array`,`Array of ${e.name}, ${e.description}`,t=>Array.isArray(t)&&t.every(i=>e.validate(i)),t=>t.map(i=>e.convert(i)))}static{this.CallHierarchyItem=new P("item","A call hierarchy item",e=>e instanceof Rl,Ra.from)}static{this.TypeHierarchyItem=new P("item","A type hierarchy item",e=>e instanceof Al,zi.from)}static{this.TestItem=new P("testItem","A VS Code TestItem",e=>e instanceof zt,cs.from)}static{this.TestProfile=new P("testProfile","A VS Code test profile",e=>e instanceof $l,Gf.from)}constructor(e,t,i,s){this.name=e,this.description=t,this.validate=i,this.convert=s}optional(){return new P(this.name,`(optional) ${this.description}`,e=>e==null||this.validate(e),e=>e===void 0?void 0:e===null?null:this.convert(e))}with(e,t){return new P(e??this.name,t??this.description,this.validate,this.convert)}}class M{static{this.Void=new M("no result",e=>e)}constructor(e,t){this.description=e,this.convert=t}}class H{constructor(e,t,i,s,r){this.id=e,this.internalId=t,this.description=i,this.args=s,this.result=r}}const xo=new Map;function Ey(a,e){e?xo.set(a,e):xo.delete(a)}function Sy(a){return xo.get(a)}class Cy extends kp{constructor(e,t,i,s,r,n,o,c){super(t,i,s,r),this._proxy=e,this._languageId=n,this._isDirty=o,this._encoding=c,this._isDisposed=!1}dispose(){Me(!this._isDisposed),this._isDisposed=!0,this._isDirty=!1}equalLines(e){return pi(this._lines,e)}get document(){if(!this._document){const e=this;this._document={get uri(){return e._uri},get fileName(){return e._uri.fsPath},get isUntitled(){return e._uri.scheme===G.untitled},get languageId(){return e._languageId},get version(){return e._versionId},get isClosed(){return e._isDisposed},get isDirty(){return e._isDirty},get encoding(){return e._encoding},save(){return e._save()},getText(t){return t?e._getTextInRange(t):e.getText()},get eol(){return e._eol===`
`?is.LF:is.CRLF},get lineCount(){return e._lines.length},lineAt(t){return e._lineAt(t)},offsetAt(t){return e._offsetAt(t)},positionAt(t){return e._positionAt(t)},validateRange(t){return e._validateRange(t)},validatePosition(t){return e._validatePosition(t)},getWordRangeAtPosition(t,i){return e._getWordRangeAtPosition(t,i)},[Symbol.for("debug.description")](){return`TextDocument(${e._uri.toString()})`}}}return Object.freeze(this._document)}_acceptLanguageId(e){Me(!this._isDisposed),this._languageId=e}_acceptIsDirty(e){Me(!this._isDisposed),this._isDirty=e}_acceptEncoding(e){Me(!this._isDisposed),this._encoding=e}_save(){return this._isDisposed?Promise.reject(new Error("Document has been closed")):this._proxy.$trySaveDocument(this._uri)}_getTextInRange(e){const t=this._validateRange(e);if(t.isEmpty)return"";if(t.isSingleLine)return this._lines[t.start.line].substring(t.start.character,t.end.character);const i=this._eol,s=t.start.line,r=t.end.line,n=[];n.push(this._lines[s].substring(t.start.character));for(let o=s+1;o<r;o++)n.push(this._lines[o]);return n.push(this._lines[r].substring(0,t.end.character)),n.join(i)}_lineAt(e){let t;if(e instanceof Fe?t=e.line:typeof e=="number"&&(t=e),typeof t!="number"||t<0||t>=this._lines.length||Math.floor(t)!==t)throw new Error("Illegal value for `line`");return new Dy(t,this._lines[t],t===this._lines.length-1)}_offsetAt(e){return e=this._validatePosition(e),this._ensureLineStarts(),this._lineStarts.getPrefixSum(e.line-1)+e.character}_positionAt(e){e=Math.floor(e),e=Math.max(0,e),this._ensureLineStarts();const t=this._lineStarts.getIndexOf(e),i=this._lines[t.index].length;return new Fe(t.index,Math.min(t.remainder,i))}_validateRange(e){if(!(e instanceof ce))throw new Error("Invalid argument");const t=this._validatePosition(e.start),i=this._validatePosition(e.end);return t===e.start&&i===e.end?e:new ce(t.line,t.character,i.line,i.character)}_validatePosition(e){if(!(e instanceof Fe))throw new Error("Invalid argument");if(this._lines.length===0)return e.with(0,0);let{line:t,character:i}=e,s=!1;if(t<0)t=0,i=0,s=!0;else if(t>=this._lines.length)t=this._lines.length-1,i=this._lines[t].length,s=!0;else{const r=this._lines[t].length;i<0?(i=0,s=!0):i>r&&(i=r,s=!0)}return s?new Fe(t,i):e}_getWordRangeAtPosition(e,t){const i=this._validatePosition(e);if(!t)t=Sy(this._languageId);else if(xl(t))throw new Error(`[getWordRangeAtPosition]: ignoring custom regexp '${t.source}' because it matches the empty string.`);const s=Ip(i.character+1,Rp(t),this._lines[i.line],0);if(s)return new ce(i.line,s.startColumn-1,i.line,s.endColumn-1)}}class Dy{constructor(e,t,i){this._line=e,this._text=t,this._isLastLine=i}get lineNumber(){return this._line}get text(){return this._text}get range(){return new ce(this._line,0,this._line,this._text.length)}get rangeIncludingLineBreak(){return this._isLastLine?this.range:new ce(this._line,0,this._line+1,0)}get firstNonWhitespaceCharacterIndex(){return/^(\s*)/.exec(this._text)[1].length}get isEmptyOrWhitespace(){return this.firstNonWhitespaceCharacterIndex===this._text.length}}class Ka{static{this._Keys=new ba("TextEditorDecorationType")}constructor(e,t,i){const s=Ka._Keys.nextId();e.$registerTextEditorDecorationType(t.identifier,s,Qf.from(i)),this.value=Object.freeze({key:s,dispose(){e.$removeTextEditorDecorationType(s)}})}}class Py{constructor(e,t){this._collectedEdits=[],this._setEndOfLine=void 0,this._finalized=!1,this._document=e,this._documentVersionId=e.version,this._undoStopBefore=t.undoStopBefore,this._undoStopAfter=t.undoStopAfter}finalize(){return this._finalized=!0,{documentVersionId:this._documentVersionId,edits:this._collectedEdits,setEndOfLine:this._setEndOfLine,undoStopBefore:this._undoStopBefore,undoStopAfter:this._undoStopAfter}}_throwIfFinalized(){if(this._finalized)throw new Error("Edit is only valid while callback runs")}replace(e,t){this._throwIfFinalized();let i=null;if(e instanceof Fe)i=new ce(e,e);else if(e instanceof ce)i=e;else throw new Error("Unrecognized location");this._pushEdit(i,t,!1)}insert(e,t){this._throwIfFinalized(),this._pushEdit(new ce(e,e),t,!0)}delete(e){this._throwIfFinalized();let t=null;if(e instanceof ce)t=e;else throw new Error("Unrecognized location");this._pushEdit(t,null,!0)}_pushEdit(e,t,i){const s=this._document.validateRange(e);this._collectedEdits.push({range:s,text:t,forceMoveMarkers:i})}setEndOfLine(e){if(this._throwIfFinalized(),e!==is.LF&&e!==is.CRLF)throw Ks("endOfLine");this._setEndOfLine=e}}class Ty{constructor(e,t,i,s){this._proxy=e,this._id=t,this._accept(i),this._logService=s;const r=this;this.value={get tabSize(){return r._tabSize},set tabSize(n){r._setTabSize(n)},get indentSize(){return r._indentSize},set indentSize(n){r._setIndentSize(n)},get insertSpaces(){return r._insertSpaces},set insertSpaces(n){r._setInsertSpaces(n)},get cursorStyle(){return r._cursorStyle},set cursorStyle(n){r._setCursorStyle(n)},get lineNumbers(){return r._lineNumbers},set lineNumbers(n){r._setLineNumbers(n)}}}_accept(e){this._tabSize=e.tabSize,this._indentSize=e.indentSize,this._originalIndentSize=e.originalIndentSize,this._insertSpaces=e.insertSpaces,this._cursorStyle=e.cursorStyle,this._lineNumbers=Is.to(e.lineNumbers)}_validateTabSize(e){if(e==="auto")return"auto";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setTabSize(e){const t=this._validateTabSize(e);if(t!==null){if(typeof t=="number"){if(this._tabSize===t)return;this._tabSize=t}this._warnOnError("setTabSize",this._proxy.$trySetOptions(this._id,{tabSize:t}))}}_validateIndentSize(e){if(e==="tabSize")return"tabSize";if(typeof e=="number"){const t=Math.floor(e);return t>0?t:null}if(typeof e=="string"){const t=parseInt(e,10);return isNaN(t)?null:t>0?t:null}return null}_setIndentSize(e){const t=this._validateIndentSize(e);if(t!==null){if(typeof t=="number"){if(this._originalIndentSize===t)return;this._indentSize=t,this._originalIndentSize=t}this._warnOnError("setIndentSize",this._proxy.$trySetOptions(this._id,{indentSize:t}))}}_validateInsertSpaces(e){return e==="auto"?"auto":e==="false"?!1:!!e}_setInsertSpaces(e){const t=this._validateInsertSpaces(e);if(typeof t=="boolean"){if(this._insertSpaces===t)return;this._insertSpaces=t}this._warnOnError("setInsertSpaces",this._proxy.$trySetOptions(this._id,{insertSpaces:t}))}_setCursorStyle(e){this._cursorStyle!==e&&(this._cursorStyle=e,this._warnOnError("setCursorStyle",this._proxy.$trySetOptions(this._id,{cursorStyle:e})))}_setLineNumbers(e){this._lineNumbers!==e&&(this._lineNumbers=e,this._warnOnError("setLineNumbers",this._proxy.$trySetOptions(this._id,{lineNumbers:Is.from(e)})))}assign(e){const t={};let i=!1;if(typeof e.tabSize<"u"){const s=this._validateTabSize(e.tabSize);s==="auto"?(i=!0,t.tabSize=s):typeof s=="number"&&this._tabSize!==s&&(this._tabSize=s,i=!0,t.tabSize=s)}if(typeof e.indentSize<"u"){const s=this._validateIndentSize(e.indentSize);s==="tabSize"?(i=!0,t.indentSize=s):typeof s=="number"&&this._originalIndentSize!==s&&(this._indentSize=s,this._originalIndentSize=s,i=!0,t.indentSize=s)}if(typeof e.insertSpaces<"u"){const s=this._validateInsertSpaces(e.insertSpaces);s==="auto"?(i=!0,t.insertSpaces=s):this._insertSpaces!==s&&(this._insertSpaces=s,i=!0,t.insertSpaces=s)}typeof e.cursorStyle<"u"&&this._cursorStyle!==e.cursorStyle&&(this._cursorStyle=e.cursorStyle,i=!0,t.cursorStyle=e.cursorStyle),typeof e.lineNumbers<"u"&&this._lineNumbers!==e.lineNumbers&&(this._lineNumbers=e.lineNumbers,i=!0,t.lineNumbers=Is.from(e.lineNumbers)),i&&this._warnOnError("setOptions",this._proxy.$trySetOptions(this._id,t))}_warnOnError(e,t){t.catch(i=>{this._logService.warn(`ExtHostTextEditorOptions '${e}' failed:'`),this._logService.warn(i)})}}class ky{constructor(e,t,i,s,r,n,o,c){this.id=e,this._proxy=t,this._logService=i,this._disposed=!1,this._hasDecorationsForKey=new Set,this._selections=r,this._options=new Ty(this._proxy,this.id,n,i),this._visibleRanges=o,this._viewColumn=c;const d=this;this.value=Object.freeze({get document(){return s.value},set document(h){throw new Mt("document")},get selection(){return d._selections&&d._selections[0]},set selection(h){if(!(h instanceof mi))throw Ks("selection");d._selections=[h],d._trySetSelection()},get selections(){return d._selections},set selections(h){if(!Array.isArray(h)||h.some(f=>!(f instanceof mi)))throw Ks("selections");d._selections=h,d._trySetSelection()},get visibleRanges(){return d._visibleRanges},set visibleRanges(h){throw new Mt("visibleRanges")},get diffInformation(){return d._diffInformation},get options(){return d._options.value},set options(h){d._disposed||d._options.assign(h)},get viewColumn(){return d._viewColumn},set viewColumn(h){throw new Mt("viewColumn")},edit(h,f={undoStopBefore:!0,undoStopAfter:!0}){if(d._disposed)return Promise.reject(new Error("TextEditor#edit not possible on closed editors"));const m=new Py(s.value,f);return h(m),d._applyEdit(m)},insertSnippet(h,f,m={undoStopBefore:!0,undoStopAfter:!0}){if(d._disposed)return Promise.reject(new Error("TextEditor#insertSnippet not possible on closed editors"));let l;if(!f||Array.isArray(f)&&f.length===0)l=d._selections.map(p=>A.from(p));else if(f instanceof Fe){const{lineNumber:p,column:_}=te.from(f);l=[{startLineNumber:p,startColumn:_,endLineNumber:p,endColumn:_}]}else if(f instanceof ce)l=[A.from(f)];else{l=[];for(const p of f)if(p instanceof ce)l.push(A.from(p));else{const{lineNumber:_,column:x}=te.from(p);l.push({startLineNumber:_,startColumn:x,endLineNumber:_,endColumn:x})}}return m.keepWhitespace===void 0&&(m.keepWhitespace=!1),t.$tryInsertSnippet(e,s.value.version,h.value,l,m)},setDecorations(h,f){const m=f.length===0;m&&!d._hasDecorationsForKey.has(h.key)||(m?d._hasDecorationsForKey.delete(h.key):d._hasDecorationsForKey.add(h.key),d._runOnProxy(()=>{if(Jf(f))return t.$trySetDecorations(e,h.key,Xf(f));{const l=new Array(4*f.length);for(let p=0,_=f.length;p<_;p++){const x=f[p];l[4*p]=x.start.line+1,l[4*p+1]=x.start.character+1,l[4*p+2]=x.end.line+1,l[4*p+3]=x.end.character+1}return t.$trySetDecorationsFast(e,h.key,l)}}))},revealRange(h,f){d._runOnProxy(()=>t.$tryRevealRange(e,A.from(h),f||Ml.Default))},show(h){t.$tryShowEditor(e,we.from(h))},hide(){t.$tryHideEditor(e)},[Symbol.for("debug.description")](){return`TextEditor(${this.document.uri.toString()})`}})}dispose(){Me(!this._disposed),this._disposed=!0}_acceptOptions(e){Me(!this._disposed),this._options._accept(e)}_acceptVisibleRanges(e){Me(!this._disposed),this._visibleRanges=e}_acceptViewColumn(e){Me(!this._disposed),this._viewColumn=e}_acceptSelections(e){Me(!this._disposed),this._selections=e}_acceptDiffInformation(e){Me(!this._disposed),this._diffInformation=e}async _trySetSelection(){const e=this._selections.map(it.from);return await this._runOnProxy(()=>this._proxy.$trySetSelections(this.id,e)),this.value}_applyEdit(e){const t=e.finalize();if(t.edits.length===0&&!t.setEndOfLine)return Promise.resolve(!0);const i=t.edits.map(r=>r.range);i.sort((r,n)=>r.end.line===n.end.line?r.end.character===n.end.character?r.start.line===n.start.line?r.start.character-n.start.character:r.start.line-n.start.line:r.end.character-n.end.character:r.end.line-n.end.line);for(let r=0,n=i.length-1;r<n;r++){const o=i[r].end;if(i[r+1].start.isBefore(o))return Promise.reject(new Error("Overlapping ranges are not allowed!"))}const s=t.edits.map(r=>({range:A.from(r.range),text:r.text,forceMoveMarkers:r.forceMoveMarkers}));return this._proxy.$tryApplyEdits(this.id,t.documentVersionId,s,{setEndOfLine:typeof t.setEndOfLine=="number"?Hl.from(t.setEndOfLine):void 0,undoStopBefore:t.undoStopBefore,undoStopAfter:t.undoStopAfter})}_runOnProxy(e){return this._disposed?(this._logService.warn("TextEditor is closed/disposed"),Promise.resolve(void 0)):e().then(()=>this,t=>(t instanceof Error&&t.name==="DISPOSED"||this._logService.warn(t),null))}}class Iy{constructor(e){this.value=e,this._count=0}ref(){this._count++}unref(){return--this._count===0}}let bo=class{constructor(e,t){this._extHostRpc=e,this._logService=t,this._activeEditorId=null,this._editors=new Map,this._documents=new et,this._onDidAddDocuments=new D,this._onDidRemoveDocuments=new D,this._onDidChangeVisibleTextEditors=new D,this._onDidChangeActiveTextEditor=new D,this.onDidAddDocuments=this._onDidAddDocuments.event,this.onDidRemoveDocuments=this._onDidRemoveDocuments.event,this.onDidChangeVisibleTextEditors=this._onDidChangeVisibleTextEditors.event,this.onDidChangeActiveTextEditor=this._onDidChangeActiveTextEditor.event}$acceptDocumentsAndEditorsDelta(e){this.acceptDocumentsAndEditorsDelta(e)}acceptDocumentsAndEditorsDelta(e){const t=[],i=[],s=[];if(e.removedDocuments)for(const r of e.removedDocuments){const n=v.revive(r),o=this._documents.get(n);o?.unref()&&(this._documents.delete(n),t.push(o.value))}if(e.addedDocuments)for(const r of e.addedDocuments){const n=v.revive(r.uri);let o=this._documents.get(n);if(o&&n.scheme!==G.vscodeNotebookCell&&n.scheme!==G.vscodeInteractiveInput)throw new Error(`document '${n} already exists!'`);o||(o=new Iy(new Cy(this._extHostRpc.getProxy(k.MainThreadDocuments),n,r.lines,r.EOL,r.versionId,r.languageId,r.isDirty,r.encoding)),this._documents.set(n,o),i.push(o.value)),o.ref()}if(e.removedEditors)for(const r of e.removedEditors){const n=this._editors.get(r);this._editors.delete(r),n&&s.push(n)}if(e.addedEditors)for(const r of e.addedEditors){const n=v.revive(r.documentUri);Me(this._documents.has(n),`document '${n}' does not exist`),Me(!this._editors.has(r.id),`editor '${r.id}' already exists!`);const o=this._documents.get(n).value,c=new ky(r.id,this._extHostRpc.getProxy(k.MainThreadTextEditors),this._logService,new Bi(()=>o.document),r.selections.map(it.to),r.options,r.visibleRanges.map(d=>A.to(d)),typeof r.editorPosition=="number"?we.to(r.editorPosition):void 0);this._editors.set(r.id,c)}e.newActiveEditor!==void 0&&(Me(e.newActiveEditor===null||this._editors.has(e.newActiveEditor),`active editor '${e.newActiveEditor}' does not exist`),this._activeEditorId=e.newActiveEditor),Gs(t),Gs(s),e.removedDocuments&&this._onDidRemoveDocuments.fire(t),e.addedDocuments&&this._onDidAddDocuments.fire(i),(e.removedEditors||e.addedEditors)&&this._onDidChangeVisibleTextEditors.fire(this.allEditors().map(r=>r.value)),e.newActiveEditor!==void 0&&this._onDidChangeActiveTextEditor.fire(this.activeEditor())}getDocument(e){return this._documents.get(e)?.value}allDocuments(){return fi.map(this._documents.values(),e=>e.value)}getEditor(e){return this._editors.get(e)}activeEditor(e){if(!this._activeEditorId)return;const t=this._editors.get(this._activeEditorId);return e?t:t?.value}allEditors(){return[...this._editors.values()]}};bo=L([E(0,q),E(1,se)],bo);const xi=Y("IExtHostDocumentsAndEditors"),bi=Y("IExtHostTerminalService");class wd extends Z{constructor(e,t,i,s){super(),this._proxy=e,this._id=t,this._creationOptions=i,this._name=s,this._disposed=!1,this._state={isInteractedWith:!1,shell:void 0},this.isOpen=!1,this._onWillDispose=this._register(new D),this.onWillDispose=this._onWillDispose.event,this._creationOptions=Object.freeze(this._creationOptions),this._pidPromise=new Promise(n=>this._pidPromiseComplete=n);const r=this;this.value={get name(){return r._name||""},get processId(){return r._pidPromise},get creationOptions(){return r._creationOptions},get exitStatus(){return r._exitStatus},get state(){return r._state},get selection(){return r._selection},get shellIntegration(){return r.shellIntegration},sendText(n,o=!0){r._checkDisposed(),r._proxy.$sendText(r._id,n,o)},show(n){r._checkDisposed(),r._proxy.$show(r._id,n)},hide(){r._checkDisposed(),r._proxy.$hide(r._id)},dispose(){r._disposed||(r._disposed=!0,r._proxy.$dispose(r._id))},get dimensions(){if(!(r._cols===void 0||r._rows===void 0))return{columns:r._cols,rows:r._rows}}}}dispose(){this._onWillDispose.fire(),super.dispose()}async create(e,t){if(typeof this._id!="string")throw new Error("Terminal has already been created");await this._proxy.$createTerminal(this._id,{name:e.name,shellPath:e.shellPath??void 0,shellArgs:e.shellArgs??void 0,cwd:e.cwd??t?.cwd??void 0,env:e.env??void 0,icon:Xh(e.iconPath)??void 0,color:_n.isThemeColor(e.color)?e.color.id:void 0,initialText:e.message??void 0,strictEnv:e.strictEnv??void 0,hideFromUser:e.hideFromUser??void 0,forceShellIntegration:t?.forceShellIntegration??void 0,isFeatureTerminal:t?.isFeatureTerminal??void 0,isExtensionOwnedTerminal:!0,useShellEnvironment:t?.useShellEnvironment??void 0,location:t?.location||this._serializeParentTerminal(e.location,t?.resolvedExtHostIdentifier),isTransient:e.isTransient??void 0})}async createExtensionTerminal(e,t,i,s,r){if(typeof this._id!="string")throw new Error("Terminal has already been created");if(await this._proxy.$createTerminal(this._id,{name:this._name,isExtensionCustomPtyTerminal:!0,icon:s,color:_n.isThemeColor(r)?r.id:void 0,location:t?.location||this._serializeParentTerminal(e,i),isTransient:!0}),typeof this._id=="string")throw new Error("Terminal creation failed");return this._id}_serializeParentTerminal(e,t){return typeof e=="object"?"parentTerminal"in e&&e.parentTerminal&&t?{parentTerminal:t}:"viewColumn"in e?{viewColumn:we.from(e.viewColumn),preserveFocus:e.preserveFocus}:void 0:e}_checkDisposed(){if(this._disposed)throw new Error("Terminal has already been disposed")}set name(e){this._name=e}setExitStatus(e,t){this._exitStatus=Object.freeze({code:e,reason:t})}setDimensions(e,t){return e===this._cols&&t===this._rows||e===0||t===0?!1:(this._cols=e,this._rows=t,!0)}setInteractedWith(){return this._state.isInteractedWith?!1:(this._state={...this._state,isInteractedWith:!0},!0)}setShellType(e){return this._state.shell!==e?(this._state={...this._state,shell:e},!0):!1}setSelection(e){this._selection=e}_setProcessId(e){this._pidPromiseComplete?(this._pidPromiseComplete(e),this._pidPromiseComplete=void 0):this._pidPromise.then(t=>{t!==e&&(this._pidPromise=Promise.resolve(e))})}}class Zr{get onProcessReady(){return this._onProcessReady.event}constructor(e){this._pty=e,this.id=0,this.shouldPersist=!1,this._onProcessData=new D,this.onProcessData=this._onProcessData.event,this._onProcessReady=new D,this._onDidChangeProperty=new D,this.onDidChangeProperty=this._onDidChangeProperty.event,this._onProcessExit=new D,this.onProcessExit=this._onProcessExit.event}refreshProperty(e){throw new Error(`refreshProperty is not suppported in extension owned terminals. property: ${e}`)}updateProperty(e,t){throw new Error(`updateProperty is not suppported in extension owned terminals. property: ${e}, value: ${t}`)}async start(){}shutdown(){this._pty.close()}input(e){this._pty.handleInput?.(e)}resize(e,t){this._pty.setDimensions?.({columns:e,rows:t})}clearBuffer(){}async processBinary(e){}acknowledgeDataEvent(e){}async setUnicodeVersion(e){}getInitialCwd(){return Promise.resolve("")}getCwd(){return Promise.resolve("")}startSendingEvents(e){this._pty.onDidWrite(t=>this._onProcessData.fire(t)),this._pty.onDidClose?.((t=void 0)=>{this._onProcessExit.fire(t===void 0?void 0:t)}),this._pty.onDidOverrideDimensions?.(t=>{t&&this._onDidChangeProperty.fire({type:tr.OverrideDimensions,value:{cols:t.columns,rows:t.rows}})}),this._pty.onDidChangeName?.(t=>{this._onDidChangeProperty.fire({type:tr.Title,value:t})}),this._pty.open(e||void 0),e&&this._pty.setDimensions?.(e),this._onProcessReady.fire({pid:-1,cwd:"",windowsPty:void 0})}}let Ry=1,Eo=class extends Z{get activeTerminal(){return this._activeTerminal?.value}get terminals(){return this._terminals.map(e=>e.value)}constructor(e,t,i){super(),this._extHostCommands=t,this._terminals=[],this._terminalProcesses=new Map,this._terminalProcessDisposables={},this._extensionTerminalAwaitingStart={},this._getTerminalPromises={},this._environmentVariableCollections=new Map,this._lastQuickFixCommands=this._register(new Ht),this._linkProviders=new Set,this._completionProviders=new Map,this._profileProviders=new Map,this._quickFixProviders=new Map,this._terminalLinkCache=new Map,this._terminalLinkCancellationSource=new Map,this._onDidCloseTerminal=new D,this.onDidCloseTerminal=this._onDidCloseTerminal.event,this._onDidOpenTerminal=new D,this.onDidOpenTerminal=this._onDidOpenTerminal.event,this._onDidChangeActiveTerminal=new D,this.onDidChangeActiveTerminal=this._onDidChangeActiveTerminal.event,this._onDidChangeTerminalDimensions=new D,this.onDidChangeTerminalDimensions=this._onDidChangeTerminalDimensions.event,this._onDidChangeTerminalState=new D,this.onDidChangeTerminalState=this._onDidChangeTerminalState.event,this._onDidChangeShell=new D,this.onDidChangeShell=this._onDidChangeShell.event,this._onDidWriteTerminalData=new D({onWillAddFirstListener:()=>this._proxy.$startSendingDataEvents(),onDidRemoveLastListener:()=>this._proxy.$stopSendingDataEvents()}),this.onDidWriteTerminalData=this._onDidWriteTerminalData.event,this._onDidExecuteCommand=new D({onWillAddFirstListener:()=>this._proxy.$startSendingCommandEvents(),onDidRemoveLastListener:()=>this._proxy.$stopSendingCommandEvents()}),this.onDidExecuteTerminalCommand=this._onDidExecuteCommand.event,this._proxy=i.getProxy(k.MainThreadTerminalService),this._bufferer=new Yf(this._proxy.$sendProcessData),this._proxy.$registerProcessSupport(e),this._extHostCommands.registerArgumentProcessor({processArgument:s=>{const r=n=>{const o=n;return this.getTerminalById(o.instanceId)?.value};switch(s?.$mid){case Se.TerminalContext:return r(s);default:{if(Array.isArray(s))for(let n=0;n<s.length&&s[n].$mid===Se.TerminalContext;n++)s[n]=r(s[n]);return s}}}}),this._register({dispose:()=>{for(const[s,r]of this._terminalProcesses)r.shutdown(!0)}})}getDefaultShell(e){return(e?this._defaultAutomationProfile:this._defaultProfile)?.path||""}getDefaultShellArgs(e){return(e?this._defaultAutomationProfile:this._defaultProfile)?.args||[]}createExtensionTerminal(e,t){const i=new wd(this._proxy,Ct(),e,e.name),s=new Zr(e.pty);return i.createExtensionTerminal(e.location,t,this._serializeParentTerminal(e,t).resolvedExtHostIdentifier,Xh(e.iconPath),$y(e.color)).then(r=>{const n=this._setupExtHostProcessListeners(r,s);this._terminalProcessDisposables[r]=n}),this._terminals.push(i),i.value}_serializeParentTerminal(e,t){if(t=t||{},e.location&&typeof e.location=="object"&&"parentTerminal"in e.location){const i=e.location.parentTerminal;if(i){const s=this._terminals.find(r=>r.value===i);s&&(t.resolvedExtHostIdentifier=s._id)}}else e.location&&typeof e.location!="object"?t.location=e.location:t.location&&typeof t.location=="object"&&"splitActiveTerminal"in t.location&&(t.location={splitActiveTerminal:!0});return t}attachPtyToTerminal(e,t){if(!this.getTerminalById(e))throw new Error(`Cannot resolve terminal with id ${e} for virtual process`);const s=new Zr(t),r=this._setupExtHostProcessListeners(e,s);this._terminalProcessDisposables[e]=r}async $acceptActiveTerminalChanged(e){const t=this._activeTerminal;if(e===null){this._activeTerminal=void 0,t!==this._activeTerminal&&this._onDidChangeActiveTerminal.fire(this._activeTerminal);return}const i=this.getTerminalById(e);i&&(this._activeTerminal=i,t!==this._activeTerminal&&this._onDidChangeActiveTerminal.fire(this._activeTerminal.value))}async $acceptTerminalProcessData(e,t){const i=this.getTerminalById(e);i&&this._onDidWriteTerminalData.fire({terminal:i.value,data:t})}async $acceptTerminalDimensions(e,t,i){const s=this.getTerminalById(e);s&&s.setDimensions(t,i)&&this._onDidChangeTerminalDimensions.fire({terminal:s.value,dimensions:s.value.dimensions})}async $acceptDidExecuteCommand(e,t){const i=this.getTerminalById(e);i&&this._onDidExecuteCommand.fire({terminal:i.value,...t})}async $acceptTerminalMaximumDimensions(e,t,i){this._terminalProcesses.get(e)?.resize(t,i)}async $acceptTerminalTitleChange(e,t){const i=this.getTerminalById(e);i&&(i.name=t)}async $acceptTerminalClosed(e,t,i){const s=this._getTerminalObjectIndexById(this._terminals,e);if(s!==null){const r=this._terminals.splice(s,1)[0];r.setExitStatus(t,i),this._onDidCloseTerminal.fire(r.value)}}$acceptTerminalOpened(e,t,i,s){if(t){const o=this._getTerminalObjectIndexById(this._terminals,t);if(o!==null){this._terminals[o]._id=e,this._onDidOpenTerminal.fire(this.terminals[o]),this._terminals[o].isOpen=!0;return}}const r={name:s.name,shellPath:s.executable,shellArgs:s.args,cwd:typeof s.cwd=="string"?s.cwd:v.revive(s.cwd),env:s.env,hideFromUser:s.hideFromUser},n=new wd(this._proxy,e,r,i);this._terminals.push(n),this._onDidOpenTerminal.fire(n.value),n.isOpen=!0}async $acceptTerminalProcessId(e,t){this.getTerminalById(e)?._setProcessId(t)}async $startExtensionTerminal(e,t){const i=this.getTerminalById(e);if(!i)return{message:j(2593,"Could not find the terminal with id {0} on the extension host",e)};i.isOpen||await new Promise(r=>{const n=this.onDidOpenTerminal(async o=>{o===i.value&&(n.dispose(),r())})});const s=this._terminalProcesses.get(e);s?s.startSendingEvents(t):this._extensionTerminalAwaitingStart[e]={initialDimensions:t}}_setupExtHostProcessListeners(e,t){const i=new N;i.add(t.onProcessReady(r=>this._proxy.$sendProcessReady(e,r.pid,r.cwd,r.windowsPty))),i.add(t.onDidChangeProperty(r=>this._proxy.$sendProcessProperty(e,r))),this._bufferer.startBuffering(e,t.onProcessData),i.add(t.onProcessExit(r=>this._onProcessExit(e,r))),this._terminalProcesses.set(e,t);const s=this._extensionTerminalAwaitingStart[e];return s&&t instanceof Zr&&(t.startSendingEvents(s.initialDimensions),delete this._extensionTerminalAwaitingStart[e]),i}$acceptProcessAckDataEvent(e,t){this._terminalProcesses.get(e)?.acknowledgeDataEvent(t)}$acceptProcessInput(e,t){this._terminalProcesses.get(e)?.input(t)}$acceptTerminalInteraction(e){const t=this.getTerminalById(e);t?.setInteractedWith()&&this._onDidChangeTerminalState.fire(t.value)}$acceptTerminalSelection(e,t){this.getTerminalById(e)?.setSelection(t)}$acceptProcessResize(e,t,i){try{this._terminalProcesses.get(e)?.resize(t,i)}catch(s){if(s.code!=="EPIPE"&&s.code!=="ERR_IPC_CHANNEL_CLOSED")throw s}}$acceptProcessShutdown(e,t){this._terminalProcesses.get(e)?.shutdown(t)}$acceptProcessRequestInitialCwd(e){this._terminalProcesses.get(e)?.getInitialCwd().then(t=>this._proxy.$sendProcessProperty(e,{type:tr.InitialCwd,value:t}))}$acceptProcessRequestCwd(e){this._terminalProcesses.get(e)?.getCwd().then(t=>this._proxy.$sendProcessProperty(e,{type:tr.Cwd,value:t}))}$acceptProcessRequestLatency(e){return Promise.resolve(e)}registerProfileProvider(e,t,i){if(this._profileProviders.has(t))throw new Error(`Terminal profile provider "${t}" already registered`);return this._profileProviders.set(t,i),this._proxy.$registerProfileProvider(t,e.identifier.value),new W(()=>{this._profileProviders.delete(t),this._proxy.$unregisterProfileProvider(t)})}registerTerminalCompletionProvider(e,t,...i){if(this._completionProviders.has(t.id))throw new Error(`Terminal completion provider "${t.id}" already registered`);return this._completionProviders.set(t.id,t),this._proxy.$registerCompletionProvider(t.id,e.identifier.value,...i),new W(()=>{this._completionProviders.delete(t.id),this._proxy.$unregisterCompletionProvider(t.id)})}async $provideTerminalCompletions(e,t){const i=new he().token;if(i.isCancellationRequested||!this.activeTerminal)return;const s=this._completionProviders.get(e);if(!s)return;const r=await s.provideTerminalCompletions(this.activeTerminal,t,i);if(r!=null)return Zf.from(r)}$acceptTerminalShellType(e,t){const i=this.getTerminalById(e);i?.setShellType(t)&&this._onDidChangeTerminalState.fire(i.value)}registerTerminalQuickFixProvider(e,t,i){if(this._quickFixProviders.has(e))throw new Error(`Terminal quick fix provider "${e}" is already registered`);return this._quickFixProviders.set(e,i),this._proxy.$registerQuickFixProvider(e,t),new W(()=>{this._quickFixProviders.delete(e),this._proxy.$unregisterQuickFixProvider(e)})}async $provideTerminalQuickFixes(e,t){const i=new he().token;if(i.isCancellationRequested)return;const s=this._quickFixProviders.get(e);if(!s)return;const r=await s.provideTerminalQuickFixes(t,i);if(r===null||Array.isArray(r)&&r.length===0)return;const n=new N;if(this._lastQuickFixCommands.value=n,!Array.isArray(r))return r?Kc.from(r,this._extHostCommands.converter,n):void 0;const o=[];for(const c of r){const d=Kc.from(c,this._extHostCommands.converter,n);d&&o.push(d)}return o}async $createContributedProfileTerminal(e,t){const i=new he().token;let s=await this._profileProviders.get(e)?.provideTerminalProfile(i);if(!i.isCancellationRequested){if(s&&!("options"in s)&&(s={options:s}),!s||!("options"in s))throw new Error(`No terminal profile options provided for id "${e}"`);if("pty"in s.options){this.createExtensionTerminal(s.options,t);return}this.createTerminalFromOptions(s.options,t)}}registerLinkProvider(e){return this._linkProviders.add(e),this._linkProviders.size===1&&this._proxy.$startLinkProvider(),new W(()=>{this._linkProviders.delete(e),this._linkProviders.size===0&&this._proxy.$stopLinkProvider()})}async $provideLinks(e,t){const i=this.getTerminalById(e);if(!i)return[];this._terminalLinkCache.delete(e),this._terminalLinkCancellationSource.get(e)?.dispose(!0);const r=new he;this._terminalLinkCancellationSource.set(e,r);const n=[],o={terminal:i.value,line:t},c=[];for(const f of this._linkProviders)c.push(Ap.withAsyncBody(async m=>{r.token.onCancellationRequested(()=>m({provider:f,links:[]}));const l=await f.provideTerminalLinks(o,r.token)||[];r.token.isCancellationRequested||m({provider:f,links:l})}));const d=await Promise.all(c);if(r.token.isCancellationRequested)return[];const h=new Map;for(const f of d)f&&f.links.length>0&&n.push(...f.links.map(m=>{const l={id:Ry++,startIndex:m.startIndex,length:m.length,label:m.tooltip};return h.set(l.id,{provider:f.provider,link:m}),l}));return this._terminalLinkCache.set(e,h),n}$activateLink(e,t){const i=this._terminalLinkCache.get(e)?.get(t);i&&i.provider.handleTerminalLink(i.link)}_onProcessExit(e,t){this._bufferer.stopBuffering(e),this._terminalProcesses.delete(e),delete this._extensionTerminalAwaitingStart[e];const i=this._terminalProcessDisposables[e];i&&(i.dispose(),delete this._terminalProcessDisposables[e]),this._proxy.$sendProcessExit(e,t)}getTerminalById(e){return this._getTerminalObjectById(this._terminals,e)}getTerminalIdByApiObject(e){const t=this._terminals.findIndex(i=>i.value===e);return t>=0?t:null}_getTerminalObjectById(e,t){const i=this._getTerminalObjectIndexById(e,t);return i!==null?e[i]:null}_getTerminalObjectIndexById(e,t){const i=e.findIndex(s=>s._id===t);return i>=0?i:null}getEnvironmentVariableCollection(e){let t=this._environmentVariableCollections.get(e.identifier.value);return t||(t=this._register(new xd),this._setEnvironmentVariableCollection(e.identifier.value,t)),t.getScopedEnvironmentVariableCollection(void 0)}_syncEnvironmentVariableCollection(e,t){const i=eg(t.map),s=tg(t.descriptionMap);this._proxy.$setEnvironmentVariableCollection(e,t.persistent,i.length===0?void 0:i,s)}$initEnvironmentVariableCollections(e){e.forEach(t=>{const i=t[0],s=this._register(new xd(t[1]));this._setEnvironmentVariableCollection(i,s)})}$acceptDefaultProfile(e,t){const i=this._defaultProfile;this._defaultProfile=e,this._defaultAutomationProfile=t,i?.path!==e.path&&this._onDidChangeShell.fire(e.path)}_setEnvironmentVariableCollection(e,t){this._environmentVariableCollections.set(e,t),this._register(t.onDidChangeCollection(()=>{this._syncEnvironmentVariableCollection(e,t)}))}};Eo=L([E(1,jt),E(2,q)],Eo);class xd extends Z{get persistent(){return this._persistent}set persistent(e){this._persistent=e,this._onDidChangeCollection.fire()}get onDidChangeCollection(){return this._onDidChangeCollection&&this._onDidChangeCollection.event}constructor(e){super(),this.map=new Map,this.scopedCollections=new Map,this.descriptionMap=new Map,this._persistent=!0,this._onDidChangeCollection=new D,this.map=new Map(e)}getScopedEnvironmentVariableCollection(e){const t=this.getScopeKey(e);let i=this.scopedCollections.get(t);return i||(i=new Ay(this,e),this.scopedCollections.set(t,i),this._register(i.onDidChangeCollection(()=>this._onDidChangeCollection.fire()))),i}replace(e,t,i,s){this._setIfDiffers(e,{value:t,type:Rs.Replace,options:i??{applyAtProcessCreation:!0},scope:s})}append(e,t,i,s){this._setIfDiffers(e,{value:t,type:Rs.Append,options:i??{applyAtProcessCreation:!0},scope:s})}prepend(e,t,i,s){this._setIfDiffers(e,{value:t,type:Rs.Prepend,options:i??{applyAtProcessCreation:!0},scope:s})}_setIfDiffers(e,t){if(t.options&&t.options.applyAtProcessCreation===!1&&!t.options.applyAtShellIntegration)throw new Error("EnvironmentVariableMutatorOptions must apply at either process creation or shell integration");const i=this.getKey(e,t.scope),s=this.map.get(i),r=t.options?{applyAtProcessCreation:t.options.applyAtProcessCreation??!1,applyAtShellIntegration:t.options.applyAtShellIntegration??!1}:{applyAtProcessCreation:!0};if(!s||s.value!==t.value||s.type!==t.type||s.options?.applyAtProcessCreation!==r.applyAtProcessCreation||s.options?.applyAtShellIntegration!==r.applyAtShellIntegration||s.scope?.workspaceFolder?.index!==t.scope?.workspaceFolder?.index){const n=this.getKey(e,t.scope),o={variable:e,...t,options:r};this.map.set(n,o),this._onDidChangeCollection.fire()}}get(e,t){const i=this.getKey(e,t),s=this.map.get(i);return s?bd(s):void 0}getKey(e,t){const i=this.getScopeKey(t);return i.length?`${e}:::${i}`:e}getScopeKey(e){return this.getWorkspaceKey(e?.workspaceFolder)??""}getWorkspaceKey(e){return e?e.uri.toString():void 0}getVariableMap(e){const t=new Map;for(const[i,s]of this.map)this.getScopeKey(s.scope)===this.getScopeKey(e)&&t.set(s.variable,bd(s));return t}delete(e,t){const i=this.getKey(e,t);this.map.delete(i),this._onDidChangeCollection.fire()}clear(e){if(e?.workspaceFolder){for(const[t,i]of this.map)i.scope?.workspaceFolder?.index===e.workspaceFolder.index&&this.map.delete(t);this.clearDescription(e)}else this.map.clear(),this.descriptionMap.clear();this._onDidChangeCollection.fire()}setDescription(e,t){const i=this.getScopeKey(t),s=this.descriptionMap.get(i);if(!s||s.description!==e){let r;typeof e=="string"?r=e:r=e?.value.split(`

`)[0];const n={description:r,scope:t};this.descriptionMap.set(i,n),this._onDidChangeCollection.fire()}}getDescription(e){const t=this.getScopeKey(e);return this.descriptionMap.get(t)?.description}clearDescription(e){const t=this.getScopeKey(e);this.descriptionMap.delete(t)}}class Ay{get persistent(){return this.collection.persistent}set persistent(e){this.collection.persistent=e}get onDidChangeCollection(){return this._onDidChangeCollection&&this._onDidChangeCollection.event}constructor(e,t){this.collection=e,this.scope=t,this._onDidChangeCollection=new D}getScoped(e){return this.collection.getScopedEnvironmentVariableCollection(e)}replace(e,t,i){this.collection.replace(e,t,i,this.scope)}append(e,t,i){this.collection.append(e,t,i,this.scope)}prepend(e,t,i){this.collection.prepend(e,t,i,this.scope)}get(e){return this.collection.get(e,this.scope)}forEach(e,t){this.collection.getVariableMap(this.scope).forEach((i,s)=>e.call(t,s,i,this),this.scope)}[Symbol.iterator](){return this.collection.getVariableMap(this.scope).entries()}delete(e){this.collection.delete(e,this.scope),this._onDidChangeCollection.fire(void 0)}clear(){this.collection.clear(this.scope)}set description(e){this.collection.setDescription(e,this.scope)}get description(){return this.collection.getDescription(this.scope)}}let So=class extends Eo{constructor(e,t){super(!1,e,t)}createTerminal(e,t,i){throw new mn}createTerminalFromOptions(e,t){throw new mn}};So=L([E(0,jt),E(1,q)],So);function Xh(a){if(!(!a||typeof a=="string"))return"id"in a?{id:a.id,color:a.color}:a}function $y(a){return _n.isThemeColor(a)?a:void 0}function bd(a){const e={...a};return delete e.scope,e.options=e.options??void 0,delete e.variable,e}const ds=Y("IExtHostApiDeprecationService");let Co=class{constructor(e,t){this._extHostLogService=t,this._reportedUsages=new Set,this._telemetryShape=e.getProxy(k.MainThreadTelemetry)}report(e,t,i){const s=this.getUsageKey(e,t);this._reportedUsages.has(s)||(this._reportedUsages.add(s),t.isUnderDevelopment&&this._extHostLogService.warn(`[Deprecation Warning] '${e}' is deprecated. ${i}`),this._telemetryShape.$publicLog2("extHostDeprecatedApiUsage",{extensionId:t.identifier.value,apiId:e}))}getUsageKey(e,t){return`${e}-${t.identifier.value}`}};Co=L([E(0,q),E(1,se)],Co);var hr;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(hr||(hr={}));var ur;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(ur||(ur={}));var Do;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(Do||(Do={}));var Ji;(function(a){function e(s){if(s){const r=s;return r&&!!r.process}else return!1}a.is=e;function t(s){if(s==null)return;const r={process:s.process,args:s.args};return s.options&&(r.options=Do.from(s.options)),r}a.from=t;function i(s){if(s!=null)return new Aa(s.process,s.args,s.options)}a.to=i})(Ji||(Ji={}));var Po;(function(a){function e(i){if(i!=null)return i}a.from=e;function t(i){if(i!=null)return i}a.to=t})(Po||(Po={}));var Xi;(function(a){function e(s){if(s){const r=s;return r&&(!!r.commandLine||!!r.command)}else return!1}a.is=e;function t(s){if(s==null)return;const r={};return s.commandLine!==void 0?r.commandLine=s.commandLine:(r.command=s.command,r.args=s.args),s.options&&(r.options=Po.from(s.options)),r}a.from=t;function i(s){if(!(s==null||s.command===void 0&&s.commandLine===void 0))return s.commandLine?new ir(s.commandLine,s.options):new ir(s.command,s.args?s.args:[],s.options)}a.to=i})(Xi||(Xi={}));var tt;(function(a){function e(s){if(s){const r=s;return r&&r.customExecution==="customExecution"}else return!1}a.is=e;function t(s){return{customExecution:"customExecution"}}a.from=t;function i(s,r){return r.get(s)}a.to=i})(tt||(tt={}));var Ed;(function(a){function e(t,i){let s;return t.scope!==void 0&&typeof t.scope!="number"?s=t.scope.uri:t.scope!==void 0&&typeof t.scope=="number"&&(t.scope===sr.Workspace&&i&&i.workspaceFile?s=i.workspaceFile:s=ig),{id:t._id,workspaceFolder:s}}a.from=e})(Ed||(Ed={}));var To;(function(a){function e(t){if(t!=null)return{_id:t.id,isDefault:t.isDefault}}a.from=e})(To||(To={}));var vt;(function(a){function e(s,r){if(s==null)return[];const n=[];for(const o of s){const c=t(o,r);c&&n.push(c)}return n}a.fromMany=e;function t(s,r){if(s==null)return;let n;s.execution instanceof Aa?n=Ji.from(s.execution):s.execution instanceof ir?n=Xi.from(s.execution):s.execution&&s.execution instanceof Fl&&(n=tt.from(s.execution));const o=hr.from(s.definition);let c;return s.scope?typeof s.scope=="number"?c=s.scope:c=s.scope.uri:c=sr.Workspace,!o||!c?void 0:{_id:s._id,definition:o,name:s.name,source:{extensionId:r.identifier.value,label:s.source,scope:c},execution:n,isBackground:s.isBackground,group:To.from(s.group),presentationOptions:ur.from(s.presentationOptions),problemMatchers:Ge(s.problemMatchers),hasDefinedMatchers:s.hasDefinedMatchers,runOptions:s.runOptions?s.runOptions:{reevaluateOnRerun:!0},detail:s.detail}}a.from=t;async function i(s,r,n){if(s==null)return;let o;Ji.is(s.execution)?o=Ji.to(s.execution):Xi.is(s.execution)?o=Xi.to(s.execution):tt.is(s.execution)&&(o=tt.to(s._id,n));const c=hr.to(s.definition);let d;if(s.source&&(s.source.scope!==void 0?typeof s.source.scope=="number"?d=s.source.scope:d=await r.resolveWorkspaceFolder(v.revive(s.source.scope)):d=sr.Workspace),!c||!d)return;const h=new Ll(c,d,s.name,s.source.label,o,s.problemMatchers);return s.isBackground!==void 0&&(h.isBackground=s.isBackground),s.group!==void 0&&(h.group=Tn.from(s.group._id),h.group&&s.group.isDefault&&(h.group=new Tn(h.group.id,h.group.label),s.group.isDefault===!0&&(h.group.isDefault=s.group.isDefault))),s.presentationOptions&&(h.presentationOptions=ur.to(s.presentationOptions)),s._id&&(h._id=s._id),s.detail&&(h.detail=s.detail),h}a.to=i})(vt||(vt={}));var ko;(function(a){function e(i){return i}a.from=e;function t(i){if(i)return Object.assign(Object.create(null),i)}a.to=t})(ko||(ko={}));class en{#e;constructor(e,t,i){this._id=t,this._task=i,this.#e=e}get task(){return this._task}terminate(){this.#e.terminateTask(this)}fireDidStartProcess(e){}fireDidEndProcess(e){}}let Io=class{constructor(e,t,i,s,r,n,o,c){this._onDidExecuteTask=new D,this._onDidTerminateTask=new D,this._onDidTaskProcessStarted=new D,this._onDidTaskProcessEnded=new D,this._onDidStartTaskProblemMatchers=new D,this._onDidEndTaskProblemMatchers=new D,this._proxy=e.getProxy(k.MainThreadTask),this._workspaceProvider=i,this._editorService=s,this._configurationService=r,this._terminalService=n,this._handleCounter=0,this._handlers=new Map,this._taskExecutions=new Map,this._taskExecutionPromises=new Map,this._providedCustomExecutions2=new Map,this._notProvidedCustomExecutions=new Set,this._activeCustomExecutions2=new Map,this._logService=o,this._deprecationService=c,this._proxy.$registerSupportedExecutions(!0)}registerTaskProvider(e,t,i){if(!i)return new W(()=>{});const s=this.nextHandle();return this._handlers.set(s,{type:t,provider:i,extension:e}),this._proxy.$registerTaskProvider(s,t),new W(()=>{this._handlers.delete(s),this._proxy.$unregisterTaskProvider(s)})}registerTaskSystem(e,t){this._proxy.$registerTaskSystem(e,t)}fetchTasks(e){return this._proxy.$fetchTasks(ko.from(e)).then(async t=>{const i=[];for(const s of t){const r=await vt.to(s,this._workspaceProvider,this._providedCustomExecutions2);r&&i.push(r)}return i})}get taskExecutions(){const e=[];return this._taskExecutions.forEach(t=>e.push(t)),e}terminateTask(e){if(!(e instanceof en))throw new Error("No valid task execution provided");return this._proxy.$terminateTask(e._id)}get onDidStartTask(){return this._onDidExecuteTask.event}async $onDidStartTask(e,t,i){const s=this._providedCustomExecutions2.get(e.id);s&&(this._activeCustomExecutions2.set(e.id,s),this._terminalService.attachPtyToTerminal(t,await s.callback(i))),this._lastStartedTask=e.id,this._onDidExecuteTask.fire({execution:await this.getTaskExecution(e)})}get onDidEndTask(){return this._onDidTerminateTask.event}async $OnDidEndTask(e){if(!this._taskExecutionPromises.has(e.id))return;const t=await this.getTaskExecution(e);this._taskExecutionPromises.delete(e.id),this._taskExecutions.delete(e.id),this.customExecutionComplete(e),this._onDidTerminateTask.fire({execution:t})}get onDidStartTaskProcess(){return this._onDidTaskProcessStarted.event}async $onDidStartTaskProcess(e){const t=await this.getTaskExecution(e.id);this._onDidTaskProcessStarted.fire({execution:t,processId:e.processId})}get onDidEndTaskProcess(){return this._onDidTaskProcessEnded.event}async $onDidEndTaskProcess(e){const t=await this.getTaskExecution(e.id);this._onDidTaskProcessEnded.fire({execution:t,exitCode:e.exitCode})}get onDidStartTaskProblemMatchers(){return this._onDidStartTaskProblemMatchers.event}async $onDidStartTaskProblemMatchers(e){let t;try{t=await this.getTaskExecution(e.execution.id)}catch{return}this._onDidStartTaskProblemMatchers.fire({execution:t})}get onDidEndTaskProblemMatchers(){return this._onDidEndTaskProblemMatchers.event}async $onDidEndTaskProblemMatchers(e){let t;try{t=await this.getTaskExecution(e.execution.id)}catch{return}this._onDidEndTaskProblemMatchers.fire({execution:t,hasErrors:e.hasErrors})}$provideTasks(e,t){const i=this._handlers.get(e);if(!i)return Promise.reject(new Error("no handler found"));const s=[],r=xe(()=>i.provider.provideTasks(de.None)).then(n=>this.provideTasksInternal(t,s,i,n));return new Promise(n=>{r.then(o=>{Promise.all(s).then(()=>{n(o)})})})}async $resolveTask(e,t){const i=this._handlers.get(e);if(!i)return Promise.reject(new Error("no handler found"));if(t.definition.type!==i.type)throw new Error(`Unexpected: Task of type [${t.definition.type}] cannot be resolved by provider of type [${i.type}].`);const s=await vt.to(t,this._workspaceProvider,this._providedCustomExecutions2);if(!s)throw new Error("Unexpected: Task cannot be resolved.");const r=await i.provider.resolveTask(s,de.None);if(!r)return;this.checkDeprecation(r,i);const n=vt.from(r,i.extension);if(!n)throw new Error("Unexpected: Task cannot be resolved.");if(r.definition!==s.definition)throw new Error("Unexpected: The resolved task definition must be the same object as the original task definition. The task definition cannot be changed.");return tt.is(n.execution)&&await this.addCustomExecution(n,r,!0),await this.resolveTaskInternal(n)}nextHandle(){return this._handleCounter++}async addCustomExecution(e,t,i){const s=await this._proxy.$createTaskId(e);!i&&!this._providedCustomExecutions2.has(s)&&(this._notProvidedCustomExecutions.add(s),this._activeCustomExecutions2.set(s,t.execution)),this._providedCustomExecutions2.set(s,t.execution)}async getTaskExecution(e,t){if(typeof e=="string"){const r=this._taskExecutionPromises.get(e);if(!r)throw new Pc("Unexpected: The specified task is missing an execution");return r}const i=this._taskExecutionPromises.get(e.id);if(i)return i;let s;return t?s=Promise.resolve(new en(this,e.id,t)):s=vt.to(e.task,this._workspaceProvider,this._providedCustomExecutions2).then(r=>{if(!r)throw new Pc("Unexpected: Task does not exist.");return new en(this,e.id,r)}),this._taskExecutionPromises.set(e.id,s),s.then(r=>(this._taskExecutions.set(e.id,r),r))}checkDeprecation(e,t){e._deprecated&&this._deprecationService.report("Task.constructor",t.extension,"Use the Task constructor that takes a `scope` instead.")}customExecutionComplete(e){this._activeCustomExecutions2.get(e.id)&&this._activeCustomExecutions2.delete(e.id),this._notProvidedCustomExecutions.has(e.id)&&this._lastStartedTask!==e.id&&(this._providedCustomExecutions2.delete(e.id),this._notProvidedCustomExecutions.delete(e.id));const i=this._notProvidedCustomExecutions.values();let s=i.next();for(;!s.done;)!this._activeCustomExecutions2.has(s.value)&&this._lastStartedTask!==s.value&&(this._providedCustomExecutions2.delete(s.value),this._notProvidedCustomExecutions.delete(s.value)),s=i.next()}};Io=L([E(0,q),E(1,_e),E(2,rt),E(3,xi),E(4,nt),E(5,bi),E(6,se),E(7,ds)],Io);let Ro=class extends Io{constructor(e,t,i,s,r,n,o,c){super(e,t,i,s,r,n,o,c),this.registerTaskSystem(G.vscodeRemote,{scheme:G.vscodeRemote,authority:"",platform:$p(Mp.Web)})}async executeTask(e,t){if(!t.execution)throw new Error("Tasks to execute must include an execution");const i=vt.from(t,e);if(i===void 0)throw new Error("Task is not valid");if(tt.is(i.execution))await this.addCustomExecution(i,t,!1);else throw new mn;const s=await this.getTaskExecution(await this._proxy.$getTaskExecution(i),t);return this._proxy.$executeTask(i).catch(r=>{throw new Error(r)}),s}provideTasksInternal(e,t,i,s){const r=[];if(s)for(const n of s){if(this.checkDeprecation(n,i),!n.definition||!e[n.definition.type]){const c=n.source?n.source:"No task source";this._logService.warn(`The task [${c}, ${n.name}] uses an undefined task type. The task will be ignored in the future.`)}const o=vt.from(n,i.extension);o&&tt.is(o.execution)?(r.push(o),t.push(this.addCustomExecution(o,n,!0))):this._logService.warn("Only custom execution tasks supported.")}return{tasks:r,extension:i.extension}}async resolveTaskInternal(e){if(tt.is(e.execution))return e;this._logService.warn("Only custom execution tasks supported.")}async $resolveVariables(e,t){return{process:void 0,variables:Object.create(null)}}async $jsonTasksSupported(){return!1}async $findExecutable(e,t,i){}};Ro=L([E(0,q),E(1,_e),E(2,rt),E(3,xi),E(4,nt),E(5,bi),E(6,se),E(7,ds)],Ro);const Yh=Y("IExtHostTask"),ls=Y("IExtHostEditorTabs");class Sd{constructor(e,t,i){this._activeTabIdGetter=i,this._parentGroup=t,this.acceptDtoUpdate(e)}get apiObject(){if(!this._apiObject){const e=this,t={get isActive(){return e._dto.id===e._activeTabIdGetter()},get label(){return e._dto.label},get input(){return e._input},get isDirty(){return e._dto.isDirty},get isPinned(){return e._dto.isPinned},get isPreview(){return e._dto.isPreview},get group(){return e._parentGroup.apiObject}};this._apiObject=Object.freeze(t)}return this._apiObject}get tabId(){return this._dto.id}acceptDtoUpdate(e){this._dto=e,this._input=this._initInput()}_initInput(){switch(this._dto.input.kind){case Oe.TextInput:return new Fa(v.revive(this._dto.input.uri));case Oe.TextDiffInput:return new rr(v.revive(this._dto.input.original),v.revive(this._dto.input.modified));case Oe.TextMergeInput:return new Bl(v.revive(this._dto.input.base),v.revive(this._dto.input.input1),v.revive(this._dto.input.input2),v.revive(this._dto.input.result));case Oe.CustomEditorInput:return new Ha(v.revive(this._dto.input.uri),this._dto.input.viewType);case Oe.WebviewEditorInput:return new Vl(this._dto.input.viewType);case Oe.NotebookInput:return new Ma(v.revive(this._dto.input.uri),this._dto.input.notebookType);case Oe.NotebookDiffInput:return new $a(v.revive(this._dto.input.original),v.revive(this._dto.input.modified),this._dto.input.notebookType);case Oe.TerminalEditorInput:return new Wl;case Oe.InteractiveEditorInput:return new Ul(v.revive(this._dto.input.uri),v.revive(this._dto.input.inputBoxUri));case Oe.ChatEditorInput:return new Ol;case Oe.MultiDiffEditorInput:return new Nl(this._dto.input.diffEditors.map(e=>new rr(v.revive(e.original),v.revive(e.modified))));default:return}}}class My{constructor(e,t){this._tabs=[],this._activeTabId="",this._dto=e,this._activeGroupIdGetter=t;for(const i of e.tabs)i.isActive&&(this._activeTabId=i.id),this._tabs.push(new Sd(i,this,()=>this.activeTabId()))}get apiObject(){if(!this._apiObject){const e=this,t={get isActive(){return e._dto.groupId===e._activeGroupIdGetter()},get viewColumn(){return we.to(e._dto.viewColumn)},get activeTab(){return e._tabs.find(i=>i.tabId===e._activeTabId)?.apiObject},get tabs(){return Object.freeze(e._tabs.map(i=>i.apiObject))}};this._apiObject=Object.freeze(t)}return this._apiObject}get groupId(){return this._dto.groupId}get tabs(){return this._tabs}acceptGroupDtoUpdate(e){this._dto=e}acceptTabOperation(e){if(e.kind===Ft.TAB_OPEN){const i=new Sd(e.tabDto,this,()=>this.activeTabId());return this._tabs.splice(e.index,0,i),e.tabDto.isActive&&(this._activeTabId=i.tabId),i}else if(e.kind===Ft.TAB_CLOSE){const i=this._tabs.splice(e.index,1)[0];if(!i)throw new Error(`Tab close updated received for index ${e.index} which does not exist`);return i.tabId===this._activeTabId&&(this._activeTabId=""),i}else if(e.kind===Ft.TAB_MOVE){if(e.oldIndex===void 0)throw new Error("Invalid old index on move IPC");const i=this._tabs.splice(e.oldIndex,1)[0];if(!i)throw new Error(`Tab move updated received for index ${e.oldIndex} which does not exist`);return this._tabs.splice(e.index,0,i),i}const t=this._tabs.find(i=>i.tabId===e.tabDto.id);if(!t)throw new Error("INVALID tab");return e.tabDto.isActive?this._activeTabId=e.tabDto.id:this._activeTabId===e.tabDto.id&&!e.tabDto.isActive&&(this._activeTabId=""),t.acceptDtoUpdate(e.tabDto),t}activeTabId(){return this._activeTabId}}let Ao=class{constructor(e){this._onDidChangeTabs=new D,this._onDidChangeTabGroups=new D,this._extHostTabGroups=[],this._proxy=e.getProxy(k.MainThreadEditorTabs)}get tabGroups(){if(!this._apiObject){const e=this,t={onDidChangeTabGroups:e._onDidChangeTabGroups.event,onDidChangeTabs:e._onDidChangeTabs.event,get all(){return Object.freeze(e._extHostTabGroups.map(i=>i.apiObject))},get activeTabGroup(){const i=e._activeGroupId;return Qs(e._extHostTabGroups.find(r=>r.groupId===i)?.apiObject)},close:async(i,s)=>{const r=Array.isArray(i)?i:[i];return r.length?Hy(r[0])?this._closeGroups(r,s):this._closeTabs(r,s):!0}};this._apiObject=Object.freeze(t)}return this._apiObject}$acceptEditorTabModel(e){const t=new Set(this._extHostTabGroups.map(d=>d.groupId)),i=new Set(e.map(d=>d.groupId)),s=Hp(t,i),r=this._extHostTabGroups.filter(d=>s.removed.includes(d.groupId)).map(d=>d.apiObject),n=[],o=[];this._extHostTabGroups=e.map(d=>{const h=new My(d,()=>this._activeGroupId);return s.added.includes(h.groupId)?n.push(h.apiObject):o.push(h.apiObject),h});const c=Qs(e.find(d=>d.isActive===!0)?.groupId);c!==void 0&&this._activeGroupId!==c&&(this._activeGroupId=c),this._onDidChangeTabGroups.fire(Object.freeze({opened:n,closed:r,changed:o}))}$acceptTabGroupUpdate(e){const t=this._extHostTabGroups.find(i=>i.groupId===e.groupId);if(!t)throw new Error("Update Group IPC call received before group creation.");t.acceptGroupDtoUpdate(e),e.isActive&&(this._activeGroupId=e.groupId),this._onDidChangeTabGroups.fire(Object.freeze({changed:[t.apiObject],opened:[],closed:[]}))}$acceptTabOperation(e){const t=this._extHostTabGroups.find(s=>s.groupId===e.groupId);if(!t)throw new Error("Update Tabs IPC call received before group creation.");const i=t.acceptTabOperation(e);switch(e.kind){case Ft.TAB_OPEN:this._onDidChangeTabs.fire(Object.freeze({opened:[i.apiObject],closed:[],changed:[]}));return;case Ft.TAB_CLOSE:this._onDidChangeTabs.fire(Object.freeze({opened:[],closed:[i.apiObject],changed:[]}));return;case Ft.TAB_MOVE:case Ft.TAB_UPDATE:this._onDidChangeTabs.fire(Object.freeze({opened:[],closed:[],changed:[i.apiObject]}));return}}_findExtHostTabFromApi(e){for(const t of this._extHostTabGroups)for(const i of t.tabs)if(i.apiObject===e)return i}_findExtHostTabGroupFromApi(e){return this._extHostTabGroups.find(t=>t.apiObject===e)}async _closeTabs(e,t){const i=[];for(const s of e){const r=this._findExtHostTabFromApi(s);if(!r)throw new Error("Tab close: Invalid tab not found!");i.push(r.tabId)}return this._proxy.$closeTab(i,t)}async _closeGroups(e,t){const i=[];for(const s of e){const r=this._findExtHostTabGroupFromApi(s);if(!r)throw new Error("Group close: Invalid group not found!");i.push(r.groupId)}return this._proxy.$closeGroup(i,t)}};Ao=L([E(0,q)],Ao);function Hy(a){return a.tabs!==void 0}class Ei{static{this.NONE=new Ei(!1,-1,-1,-1)}constructor(e,t,i,s){this.startup=e,this.codeLoadingTime=t,this.activateCallTime=i,this.activateResolvedTime=s}}class tn{constructor(e){this._startup=e,this._codeLoadingStart=-1,this._codeLoadingStop=-1,this._activateCallStart=-1,this._activateCallStop=-1,this._activateResolveStart=-1,this._activateResolveStop=-1}_delta(e,t){return e===-1||t===-1?-1:t-e}build(){return new Ei(this._startup,this._delta(this._codeLoadingStart,this._codeLoadingStop),this._delta(this._activateCallStart,this._activateCallStop),this._delta(this._activateResolveStart,this._activateResolveStop))}codeLoadingStart(){this._codeLoadingStart=Date.now()}codeLoadingStop(){this._codeLoadingStop=Date.now()}activateCallStart(){this._activateCallStart=Date.now()}activateCallStop(){this._activateCallStop=Date.now()}activateResolveStart(){this._activateResolveStart=Date.now()}activateResolveStop(){this._activateResolveStop=Date.now()}}class Pr{constructor(e,t,i,s,r,n){this.activationFailed=e,this.activationFailedError=t,this.activationTimes=i,this.module=s,this.exports=r,this.disposable=n}}class Fy extends Pr{constructor(e){super(!1,null,e,{activate:void 0,deactivate:void 0},void 0,Z.None)}}class Ly extends Pr{constructor(){super(!1,null,Ei.NONE,{activate:void 0,deactivate:void 0},void 0,Z.None)}}class pr extends Pr{constructor(e){super(!0,e,Ei.NONE,{activate:void 0,deactivate:void 0},void 0,Z.None)}}let $o=class{constructor(e,t,i,s){this._logService=s,this._registry=e,this._globalRegistry=t,this._host=i,this._operations=new Vt,this._alreadyActivatedEvents=Object.create(null)}dispose(){for(const[e,t]of this._operations)t.dispose()}async waitForActivatingExtensions(){const e=[];for(const[t,i]of this._operations)e.push(i.wait());await Promise.all(e)}isActivated(e){const t=this._operations.get(e);return!!(t&&t.value)}getActivatedExtension(e){const t=this._operations.get(e);if(!t||!t.value)throw new Error(`Extension '${e.value}' is not known or not activated`);return t.value}async activateByEvent(e,t){if(this._alreadyActivatedEvents[e])return;const i=this._registry.getExtensionDescriptionsForActivationEvent(e);await this._activateExtensions(i.map(s=>({id:s.identifier,reason:{startup:t,extensionId:s.identifier,activationEvent:e}}))),this._alreadyActivatedEvents[e]=!0}activateById(e,t){const i=this._registry.getExtensionDescription(e);if(!i)throw new Error(`Extension '${e.value}' is not known`);return this._activateExtensions([{id:i.identifier,reason:t}])}async _activateExtensions(e){const t=e.filter(i=>!this.isActivated(i.id)).map(i=>this._handleActivationRequest(i));await Promise.all(t.map(i=>i.wait()))}_handleActivationRequest(e){if(this._operations.has(e.id))return this._operations.get(e.id);if(this._isHostExtension(e.id))return this._createAndSaveOperation(e,null,[],null);const t=this._registry.getExtensionDescription(e.id);if(!t){const r=new Error(`Cannot activate unknown extension '${e.id.value}'`),n=this._createAndSaveOperation(e,null,[],new pr(r));return this._host.onExtensionActivationError(e.id,r,new Tc(e.id.value)),n}const i=[],s=typeof t.extensionDependencies>"u"?[]:t.extensionDependencies;for(const r of s){if(this._isResolvedExtension(r))continue;const n=this._operations.get(r);if(n){i.push(n);continue}if(this._isHostExtension(r)){i.push(this._handleActivationRequest({id:this._globalRegistry.getExtensionDescription(r).identifier,reason:e.reason}));continue}const o=this._registry.getExtensionDescription(r);if(o){if(!o.main&&!o.browser)continue;i.push(this._handleActivationRequest({id:o.identifier,reason:e.reason}));continue}const c=t.displayName||t.identifier.value,d=new Error(`Cannot activate the '${c}' extension because it depends on unknown extension '${r}'`),h=this._createAndSaveOperation(e,t.displayName,[],new pr(d));return this._host.onExtensionActivationError(t.identifier,d,new Tc(r)),h}return this._createAndSaveOperation(e,t.displayName,i,null)}_createAndSaveOperation(e,t,i,s){const r=new Mo(e.id,t,e.reason,i,s,this._host,this._logService);return this._operations.set(e.id,r),r}_isHostExtension(e){return ji.isHostExtension(e,this._registry,this._globalRegistry)}_isResolvedExtension(e){const t=this._globalRegistry.getExtensionDescription(e);return t?!t.main&&!t.browser:!1}};$o=L([E(3,se)],$o);let Mo=class{get value(){return this._value}get friendlyName(){return this._displayName||this._id.value}constructor(e,t,i,s,r,n,o){this._id=e,this._displayName=t,this._reason=i,this._deps=s,this._value=r,this._host=n,this._logService=o,this._barrier=new mt,this._isDisposed=!1,this._initialize()}dispose(){this._isDisposed=!0}wait(){return this._barrier.wait()}async _initialize(){await this._waitForDepsThenActivate(),this._barrier.open()}async _waitForDepsThenActivate(){if(!this._value){for(;this._deps.length>0;){for(let e=0;e<this._deps.length;e++){const t=this._deps[e];if(t.value&&!t.value.activationFailed){this._deps.splice(e,1),e--;continue}if(t.value&&t.value.activationFailed){const i=new Error(`Cannot activate the '${this.friendlyName}' extension because its dependency '${t.friendlyName}' failed to activate`);i.detail=t.value.activationFailedError,this._value=new pr(i),this._host.onExtensionActivationError(this._id,i,null);return}}this._deps.length>0&&await Promise.race(this._deps.map(e=>e.wait()))}await this._activate()}}async _activate(){try{this._value=await this._host.actualActivateExtension(this._id,this._reason)}catch(e){const t=new Error;if(e&&e.name&&(t.name=e.name),e&&e.message?t.message=`Activating extension '${this._id.value}' failed: ${e.message}.`:t.message=`Activating extension '${this._id.value}' failed: ${e}.`,e&&e.stack&&(t.stack=e.stack),this._value=new pr(t),this._isDisposed&&Wt(e))return;this._host.onExtensionActivationError(this._id,t,null),this._logService.error(`Activating extension ${this._id.value} failed due to an error:`),this._logService.error(e)}}};Mo=L([E(6,se)],Mo);class Zh{constructor(e,t){this._logService=t,this._onDidChangeStorage=new D,this.onDidChangeStorage=this._onDidChangeStorage.event,this._proxy=e.getProxy(k.MainThreadStorage)}registerExtensionStorageKeysToSync(e,t){this._proxy.$registerExtensionStorageKeysToSync(e,t)}async initializeExtensionStorage(e,t,i){const s=await this._proxy.$initializeExtensionStorage(e,t);let r;return s&&(r=this.safeParseValue(e,t,s)),r||i}setValue(e,t,i){return this._proxy.$setValue(e,t,i)}$acceptValue(e,t,i){const s=this.safeParseValue(e,t,i);s&&this._onDidChangeStorage.fire({shared:e,key:t,value:s})}safeParseValue(e,t,i){try{return JSON.parse(i)}catch(s){this._logService.error(`[extHostStorage] unexpected error parsing storage contents (extensionId: ${t}, global: ${e}): ${s}`)}}}const Ga=Y("IExtHostStorage");class eu{constructor(e,t,i){this._deferredPromises=new Map,this._id=e,this._shared=t,this._storage=i,this._init=this._storage.initializeExtensionStorage(this._shared,this._id,Object.create(null)).then(s=>(this._value=s,this)),this._storageListener=this._storage.onDidChangeStorage(s=>{s.shared===this._shared&&s.key===this._id&&(this._value=s.value)}),this._scheduler=new Ea(()=>{const s=this._deferredPromises;this._deferredPromises=new Map,(async()=>{try{await this._storage.setValue(this._shared,this._id,this._value);for(const r of s.values())r.complete()}catch(r){for(const n of s.values())n.error(r)}})()},0)}keys(){return Object.entries(this._value??{}).filter(([,e])=>e!==void 0).map(([e])=>e)}get whenReady(){return this._init}get(e,t){let i=this._value[e];return typeof i>"u"&&(i=t),i}update(e,t){t!==null&&typeof t=="object"?this._value[e]=JSON.parse(JSON.stringify(t)):this._value[e]=t;const i=this._deferredPromises.get(e);if(i!==void 0)return i.p;const s=new Js;return this._deferredPromises.set(e,s),this._scheduler.isScheduled()||this._scheduler.schedule(),s.p}dispose(){this._storageListener.dispose()}}class Ny extends eu{setKeysForSync(e){this._storage.registerExtensionStorageKeysToSync({id:this._id,version:this._extension.version},e)}constructor(e,t){super(e.identifier.value,!0,t),this._extension=e}}const tu=Y("IExtensionStoragePaths");let Cd=class{constructor(e,t,i){this._logService=t,this._extHostFileSystem=i,this._workspace=e.workspace??void 0,this._environment=e.environment,this.whenReady=this._getOrCreateWorkspaceStoragePath().then(s=>this._value=s)}async _getWorkspaceStorageURI(e){return v.joinPath(this._environment.workspaceStorageHome,e)}async _getOrCreateWorkspaceStoragePath(){if(!this._workspace)return Promise.resolve(void 0);const e=this._workspace.id,t=await this._getWorkspaceStorageURI(e);try{return await this._extHostFileSystem.value.stat(t),this._logService.trace("[ExtHostStorage] storage dir already exists",t),t}catch{}try{return this._logService.trace("[ExtHostStorage] creating dir and metadata-file",t),await this._extHostFileSystem.value.createDirectory(t),await this._extHostFileSystem.value.writeFile(v.joinPath(t,"meta.json"),new TextEncoder().encode(JSON.stringify({id:this._workspace.id,configuration:v.revive(this._workspace.configuration)?.toString(),name:this._workspace.name},void 0,2))),t}catch(i){this._logService.error("[ExtHostStorage]",i);return}}workspaceValue(e){if(this._value)return v.joinPath(this._value,e.identifier.value)}globalValue(e){return v.joinPath(this._environment.globalStorageHome,e.identifier.value.toLowerCase())}onWillDeactivateAll(){}};Cd=L([E(0,_e),E(1,se),E(2,Cr)],Cd);const Oy="/.well-known",Uy=`${Oy}/oauth-authorization-server`;function Wy(a){return typeof a!="object"||a===null?!1:a.resource!==void 0}function Vy(a){return typeof a!="object"||a===null?!1:a.issuer!==void 0}function By(a){return typeof a!="object"||a===null?!1:a.client_id!==void 0}function Dd(a){if(typeof a!="object"||a===null)return!1;const e=a;return e.access_token!==void 0&&e.token_type!==void 0}function zy(a){return{issuer:a.toString(),authorization_endpoint:new URL("/authorize",a).toString(),token_endpoint:new URL("/token",a).toString(),registration_endpoint:new URL("/register",a).toString(),response_types_supported:["code","id_token","id_token token"]}}function jy(a){const e=new URL(a.issuer);return{...a,authorization_endpoint:a.authorization_endpoint??new URL("/authorize",e).toString(),token_endpoint:a.token_endpoint??new URL("/token",e).toString(),registration_endpoint:a.registration_endpoint??new URL("/register",e).toString()}}const Pd=33418;async function qy(a,e){const t=await fetch(a,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({client_name:e,client_uri:"https://code.visualstudio.com",grant_types:["authorization_code","refresh_token","urn:ietf:params:oauth:grant-type:device_code"],response_types:["code"],redirect_uris:["https://insiders.vscode.dev/redirect","https://vscode.dev/redirect","http://localhost/","http://127.0.0.1/",`http://localhost:${Pd}/`,`http://127.0.0.1:${Pd}/`],token_endpoint_auth_method:"none"})});if(!t.ok)throw new Error(`Registration failed: ${t.statusText}`);const i=await t.json();if(By(i))return i;throw new Error(`Invalid authorization dynamic client registration response: ${JSON.stringify(i)}`)}function Ky(a){const e=a.split(" "),t=e[0],i={};return e.length>1&&e.slice(1).join(" ").split(",").forEach(r=>{const[n,o]=r.split("=").map(c=>c.trim().replace(/"/g,""));i[n]=o}),{scheme:t,params:i}}function Td(a){const e=a.split(".");if(e.length!==3)throw new Error("Invalid JWT token format: token must have three parts separated by dots");const[t,i,s]=e;try{if(typeof JSON.parse(Xs(t).toString())!="object")throw new Error("Invalid JWT token format: header is not a JSON object");const n=JSON.parse(Xs(i).toString());if(typeof n!="object")throw new Error("Invalid JWT token format: payload is not a JSON object");return n}catch(r){throw r instanceof Error?new Error(`Failed to parse JWT token: ${r.message}`):new Error("Failed to parse JWT token")}}var Ho;let Fo=class{static{Ho=this}static{this.InitialState={focused:!0,active:!0}}getState(){const e=this._state;return{get focused(){return e.focused},get active(){return e.active}}}constructor(e,t){this._onDidChangeWindowState=new D,this.onDidChangeWindowState=this._onDidChangeWindowState.event,this._state=Ho.InitialState,e.handle&&(this._nativeHandle=Xs(e.handle).buffer),this._proxy=t.getProxy(k.MainThreadWindow),this._proxy.$getInitialState().then(({isFocused:i,isActive:s})=>{this.onDidChangeWindowProperty("focused",i),this.onDidChangeWindowProperty("active",s)})}get nativeHandle(){return this._nativeHandle}$onDidChangeActiveNativeWindowHandle(e){this._nativeHandle=e?Xs(e).buffer:void 0}$onDidChangeWindowFocus(e){this.onDidChangeWindowProperty("focused",e)}$onDidChangeWindowActive(e){this.onDidChangeWindowProperty("active",e)}onDidChangeWindowProperty(e,t){t!==this._state[e]&&(this._state={...this._state,[e]:t},this._onDidChangeWindowState.fire(this._state))}openUri(e,t){let i;if(typeof e=="string"){i=e;try{e=v.parse(e)}catch{return Promise.reject(`Invalid uri - '${e}'`)}}return vn(e.scheme)?Promise.reject("Invalid scheme - cannot be empty"):e.scheme===G.command?Promise.reject(`Invalid scheme '${e.scheme}'`):this._proxy.$openUri(e,i,t)}async asExternalUri(e,t){if(vn(e.scheme))return Promise.reject("Invalid scheme - cannot be empty");const i=await this._proxy.$asExternalUri(e,t);return v.from(i)}};Fo=Ho=L([E(0,_e),E(1,q)],Fo);const Tr=Y("IExtHostWindow");var Lo;let No=class{static{Lo=this}static{this.HandlePool=0}constructor(e){this.handles=new os,this.handlers=new Map,this._proxy=e.getProxy(k.MainThreadUrls)}registerUriHandler(e,t){const i=e.identifier;if(this.handles.has(i))throw new Error(`Protocol handler already registered for extension ${i}`);const s=Lo.HandlePool++;return this.handles.add(i),this.handlers.set(s,t),this._proxy.$registerUriHandler(s,i,e.displayName||e.name),V(()=>{this.handles.delete(i),this.handlers.delete(s),this._proxy.$unregisterUriHandler(s)})}$handleExternalUri(e,t){const i=this.handlers.get(e);if(!i)return Promise.resolve(void 0);try{i.handleUri(v.revive(t))}catch(s){Sa(s)}return Promise.resolve(void 0)}async createAppUri(e){return v.revive(await this._proxy.$createAppUri(e))}};No=Lo=L([E(0,q)],No);const kr=Y("IExtHostUrlsService"),Ir=Y("IExtHostProgress");let Oo=class{constructor(e){this._handles=0,this._mapHandleToCancellationSource=new Map,this._proxy=e.getProxy(k.MainThreadProgress)}async withProgress(e,t,i){const s=this._handles++,{title:r,location:n,cancellable:o}=t,c={label:e.displayName||e.name,id:e.identifier.value};return this._proxy.$startProgress(s,{location:Gc.from(n),title:r,source:c,cancellable:o},e.isUnderDevelopment?void 0:e.identifier.value).catch(yn),this._withProgress(s,i,!!o)}async withProgressFromSource(e,t,i){const s=this._handles++,{title:r,location:n,cancellable:o}=t;return this._proxy.$startProgress(s,{location:Gc.from(n),title:r,source:e,cancellable:o},void 0).catch(yn),this._withProgress(s,i,!!o)}_withProgress(e,t,i){let s;i&&(s=new he,this._mapHandleToCancellationSource.set(e,s));const r=o=>{this._proxy.$progressEnd(o),this._mapHandleToCancellationSource.delete(o),s?.dispose()};let n;try{n=t(new Uo(this._proxy,e),i&&s?s.token:de.None)}catch(o){throw r(e),o}return n.then(o=>r(e),o=>r(e)),n}$acceptProgressCanceled(e){const t=this._mapHandleToCancellationSource.get(e);t&&(t.cancel(),this._mapHandleToCancellationSource.delete(e))}};Oo=L([E(0,q)],Oo);function Gy(a,e){return a.message=e.message,typeof e.increment=="number"&&(typeof a.increment=="number"?a.increment+=e.increment:a.increment=e.increment),a}class Uo extends Ca{constructor(e,t){super(i=>this.throttledReport(i)),this._proxy=e,this._handle=t}throttledReport(e){this._proxy.$progressReport(this._handle,e)}}Uo.__decorator=L([Fp(100,(a,e)=>Gy(a,e),()=>Object.create(null))],Uo.prototype,"throttledReport",null);const iu=Y("IExtHostAuthentication");let kd=class{constructor(e,t,i,s,r,n){this._initData=t,this._extHostWindow=i,this._extHostUrls=s,this._extHostProgress=r,this._extHostLoggerService=n,this._dynamicAuthProviderCtor=Wo,this._authenticationProviders=new Map,this._onDidChangeSessions=new D,this._getSessionTaskSingler=new Qy,this._onDidDynamicAuthProviderTokensChange=new D,this._proxy=e.getProxy(k.MainThreadAuthentication)}getExtensionScopedSessionsEvent(e){const t=e.toLowerCase();return Ee.chain(this._onDidChangeSessions.event,i=>i.filter(s=>!s.extensionIdFilter||s.extensionIdFilter.includes(t)).map(s=>({provider:s.provider})))}async getSession(e,t,i,s={}){const r=me.toKey(e.identifier),n=[...i].sort().join(" "),c=Object.keys(s).sort().map(d=>`${d}:${!!s[d]}`).join(", ");return await this._getSessionTaskSingler.getOrCreate(`${r} ${t} ${n} ${c}`,async()=>{await this._proxy.$ensureProvider(t);const d=e.displayName||e.name;return this._proxy.$getSession(t,i,r,d,s)})}async getAccounts(e){return await this._proxy.$ensureProvider(e),await this._proxy.$getAccounts(e)}async removeSession(e,t){const i=this._authenticationProviders.get(e);return i?i.provider.removeSession(t):this._proxy.$removeSession(e,t)}registerAuthenticationProvider(e,t,i,s){if(this._authenticationProviders.get(e))throw new Error(`An authentication provider with id '${e}' is already registered.`);this._authenticationProviders.set(e,{label:t,provider:i,options:s??{supportsMultipleAccounts:!1}});const r=i.onDidChangeSessions(n=>this._proxy.$sendDidChangeSessions(e,n));return this._proxy.$registerAuthenticationProvider(e,t,s?.supportsMultipleAccounts??!1,s?.supportedAuthorizationServers),new W(()=>{r.dispose(),this._authenticationProviders.delete(e),this._proxy.$unregisterAuthenticationProvider(e)})}async $createSession(e,t,i){const s=this._authenticationProviders.get(e);if(s)return i.authorizationServer=v.revive(i.authorizationServer),await s.provider.createSession(t,i);throw new Error(`Unable to find authentication provider with handle: ${e}`)}async $removeSession(e,t){const i=this._authenticationProviders.get(e);if(i)return await i.provider.removeSession(t);throw new Error(`Unable to find authentication provider with handle: ${e}`)}async $getSessions(e,t,i){const s=this._authenticationProviders.get(e);if(s)return i.authorizationServer=v.revive(i.authorizationServer),await s.provider.getSessions(t,i);throw new Error(`Unable to find authentication provider with handle: ${e}`)}$onDidChangeAuthenticationSessions(e,t,i){return e.startsWith(zl)||this._onDidChangeSessions.fire({provider:{id:e,label:t},extensionIdFilter:i}),Promise.resolve()}$onDidUnregisterAuthenticationProvider(e){const t=this._authenticationProviders.get(e);return t?.disposable&&(t.disposable.dispose(),this._authenticationProviders.delete(e)),Promise.resolve()}async $registerDynamicAuthProvider(e,t,i,s,r){if(!s){if(!t.registration_endpoint)throw new Error("Server does not support dynamic registration");try{s=(await qy(t.registration_endpoint,this._initData.environment.appName)).client_id}catch(c){throw new Error(`Dynamic registration failed: ${c.message}`)}}const n=new this._dynamicAuthProviderCtor(this._extHostWindow,this._extHostUrls,this._initData,this._extHostProgress,this._extHostLoggerService,this._proxy,v.revive(e),t,i,s,this._onDidDynamicAuthProviderTokensChange,r||[]),o=n.onDidChangeSessions(c=>this._proxy.$sendDidChangeSessions(n.id,c));return this._authenticationProviders.set(n.id,{label:n.label,provider:n,disposable:W.from(n,o),options:{supportsMultipleAccounts:!1}}),await this._proxy.$registerDynamicAuthenticationProvider(n.id,n.label,n.authorizationServer,n.clientId),n.id}async $onDidChangeDynamicAuthProviderTokens(e,t,i){this._onDidDynamicAuthProviderTokensChange.fire({authProviderId:e,clientId:t,tokens:i})}};kd=L([E(0,q),E(1,_e),E(2,Tr),E(3,kr),E(4,Ir),E(5,St)],kd);class Qy{constructor(){this._inFlightPromises=new Map}getOrCreate(e,t){const i=this._inFlightPromises.get(e);if(i)return i;const s=t().finally(()=>this._inFlightPromises.delete(e));return this._inFlightPromises.set(e,s),s}}let Wo=class{constructor(e,t,i,s,r,n,o,c,d,h,f,m){this._extHostWindow=e,this._extHostUrls=t,this._initData=i,this._extHostProgress=s,this._proxy=n,this.authorizationServer=o,this._serverMetadata=c,this._resourceMetadata=d,this.clientId=h,this._onDidChangeSessions=new D,this.onDidChangeSessions=this._onDidChangeSessions.event;const l=o.toString(!0);this.id=d?.resource?l+" "+d?.resource:l,this.label=d?.resource_name??this.authorizationServer.authority,this._logger=r.createLogger(l,{name:this.label}),this._disposable=new N,this._disposable.add(this._onDidChangeSessions);const p=Ee.chain(f.event,_=>_.filter(x=>x.authProviderId===this.id&&x.clientId===h).map(x=>x.tokens));this._tokenStore=this._disposable.add(new Jy({onDidChange:p,set:_=>n.$setSessionsForDynamicAuthProvider(l,this.clientId,_)},m,this._logger)),this._disposable.add(this._tokenStore.onDidChangeSessions(_=>this._onDidChangeSessions.fire(_))),this._createFlows=[{label:j(2574,"URL Handler"),handler:(_,x,S)=>this._createWithUrlHandler(_,x,S)}]}async getSessions(e,t){if(this._logger.info(`Getting sessions for scopes: ${e?.join(" ")??"all"}`),!e)return this._tokenStore.sessions;const i=[...e].sort(),s=e.join(" ");let r=this._tokenStore.sessions.filter(n=>pi([...n.scopes].sort(),i));if(this._logger.info(`Found ${r.length} sessions for scopes: ${s}`),r.length){const n=[],o=[],c=new Map(this._tokenStore.tokens.map(d=>[d.access_token,d]));for(const d of r){const h=c.get(d.accessToken);if(h&&h.expires_in){const f=Date.now(),m=h.expires_in*1e3;if(f>h.created_at+m-5*60*1e3){if(this._logger.info(`Token for session ${d.id} is about to expire, refreshing...`),o.push(h),!h.refresh_token){this._logger.warn(`No refresh token available for scopes ${d.scopes.join(" ")}. Throwing away token.`);continue}try{const l=await this.exchangeRefreshTokenForToken(h.refresh_token);l.scope!==s&&(this._logger.warn(`Token scopes '${l.scope}' do not match requested scopes '${s}'. Overwriting token with what was requested...`),l.scope=s),this._logger.info(`Successfully created a new token for scopes ${d.scopes.join(" ")}.`),n.push(l)}catch(l){this._logger.error(`Failed to refresh token: ${l}`)}}}}return(n.length||o.length)&&(this._tokenStore.update({added:n,removed:o}),r=this._tokenStore.sessions.filter(d=>pi([...d.scopes].sort(),i))),this._logger.info(`Found ${r.length} sessions for scopes: ${s}`),r}return[]}async createSession(e,t){this._logger.info(`Creating session for scopes: ${e.join(" ")}`);let i;for(let r=0;r<this._createFlows.length;r++){const{handler:n}=this._createFlows[r];try{if(i=await this._extHostProgress.withProgressFromSource({label:this.label,id:this.id},{location:kn.Notification,title:j(2575,"Authenticating to '{0}'",this.label),cancellable:!0},(o,c)=>n(e,o,c)),i)break}catch(o){const c=this._createFlows[r+1]?.label;if(!c)break;const d=Wt(o)?j(2576,"Having trouble authenticating to '{0}'? Would you like to try a different way? ({1})",this.label,c):j(2577,"You have not yet finished authenticating to '{0}'. Would you like to try a different way? ({1})",this.label,c);if(!await this._proxy.$showContinueNotification(d))throw new gi;this._logger.error(`Failed to create token via flow '${c}': ${o}`)}}if(!i)throw new Error("Failed to create authentication token");i.scope!==e.join(" ")&&(this._logger.warn(`Token scopes '${i.scope}' do not match requested scopes '${e.join(" ")}'. Overwriting token with what was requested...`),i.scope=e.join(" ")),this._tokenStore.update({added:[{...i,created_at:Date.now()}],removed:[]});const s=this._tokenStore.sessions.find(r=>r.accessToken===i.access_token);return this._logger.info(`Created session for scopes: ${i.scope}`),s}async removeSession(e){this._logger.info(`Removing session with id: ${e}`);const t=this._tokenStore.sessions.find(s=>s.id===e);if(!t){this._logger.error(`Session with id ${e} not found`);return}const i=this._tokenStore.tokens.find(s=>s.access_token===t.accessToken);if(!i){this._logger.error(`Failed to retrieve token for removed session: ${t.id}`);return}this._tokenStore.update({added:[],removed:[i]}),this._logger.info(`Removed token for session: ${t.id} with scopes: ${t.scopes.join(" ")}`)}dispose(){this._disposable.dispose()}async _createWithUrlHandler(e,t,i){const s=this.generateRandomString(64),r=await this.generateCodeChallenge(s),n=this.generateRandomString(32),o=v.parse(`${this._initData.environment.appUriScheme}://dynamicauthprovider/${this.authorizationServer.authority}/authorize?nonce=${n}`);let c;try{c=await this._extHostUrls.createAppUri(o)}catch(x){throw new Error(`Failed to create external URI: ${x}`)}const d=new URL(this._serverMetadata.authorization_endpoint);d.searchParams.append("client_id",this.clientId),d.searchParams.append("response_type","code"),d.searchParams.append("state",c.toString()),d.searchParams.append("code_challenge",r),d.searchParams.append("code_challenge_method","S256");const h=e.join(" ");h&&d.searchParams.append("scope",h),this._resourceMetadata?.resource&&d.searchParams.append("resource",this._resourceMetadata.resource);const f="https://vscode.dev/redirect";d.searchParams.append("redirect_uri",f);const m=this.waitForAuthorizationCode(o);if(this._logger.info(`Opening authorization URL for scopes: ${h}`),this._logger.trace(`Authorization URL: ${d.toString()}`),!await this._extHostWindow.openUri(d.toString(),{}))throw new gi;t.report({message:j(2578,"Complete the authentication in the browser window that has opened.")});let p;try{p=(await Da(m,i)).code}catch(x){throw Wt(x)?(this._logger.info("Authorization code request was cancelled by the user."),x):(this._logger.error(`Failed to receive authorization code: ${x}`),new Error(`Failed to receive authorization code: ${x}`))}return this._logger.info(`Authorization code received for scopes: ${h}`),await this.exchangeCodeForToken(p,s,f)}generateRandomString(e){const t=new Uint8Array(e);return crypto.getRandomValues(t),Array.from(t).map(i=>i.toString(16).padStart(2,"0")).join("").substring(0,e)}async generateCodeChallenge(e){const i=new TextEncoder().encode(e),s=await crypto.subtle.digest("SHA-256",i);return Lp(be.wrap(new Uint8Array(s)),!1,!1).replace(/\+/g,"-").replace(/\//g,"_").replace(/=+$/,"")}async waitForAuthorizationCode(e){const t=await this._proxy.$waitForUriHandler(e),i=/[?&]code=([^&]+)/.exec(t.query||"");if(!i||i.length<2)throw new Error("Authentication failed: No authorization code received");return{code:i[1]}}async exchangeCodeForToken(e,t,i){if(!this._serverMetadata.token_endpoint)throw new Error("Token endpoint not available in server metadata");const s=new URLSearchParams;s.append("client_id",this.clientId),s.append("grant_type","authorization_code"),s.append("code",e),s.append("redirect_uri",i),s.append("code_verifier",t);const r=await fetch(this._serverMetadata.token_endpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:s.toString()});if(!r.ok){const o=await r.text();throw new Error(`Token exchange failed: ${r.status} ${r.statusText} - ${o}`)}const n=await r.json();if(Dd(n))return n;throw new Error(`Invalid authorization token response: ${JSON.stringify(n)}`)}async exchangeRefreshTokenForToken(e){if(!this._serverMetadata.token_endpoint)throw new Error("Token endpoint not available in server metadata");const t=new URLSearchParams;t.append("client_id",this.clientId),t.append("grant_type","refresh_token"),t.append("refresh_token",e);const i=await fetch(this._serverMetadata.token_endpoint,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",Accept:"application/json"},body:t.toString()});if(!i.ok){const r=await i.text();throw new Error(`Token exchange failed: ${i.status} ${i.statusText} - ${r}`)}const s=await i.json();if(Dd(s))return{...s,created_at:Date.now()};throw new Error(`Invalid authorization token response: ${JSON.stringify(s)}`)}};Wo=L([E(0,Tr),E(1,kr),E(2,_e),E(3,Ir),E(4,St)],Wo);class Jy{constructor(e,t,i){this._persistence=e,this._logger=i,this._onDidChangeSessions=new D,this.onDidChangeSessions=this._onDidChangeSessions.event,this._disposable=new N,this._tokensObservable=Np("tokens",t),this._sessionsObservable=Op({equalsFn:(s,r)=>pi(s,r,(n,o)=>n.accessToken===o.accessToken)},s=>this._tokensObservable.read(s).map(r=>this._getSessionFromToken(r))),this._disposable.add(this._registerChangeEventAutorun()),this._disposable.add(this._persistence.onDidChange(s=>this._tokensObservable.set(s,void 0)))}get tokens(){return this._tokensObservable.get()}get sessions(){return this._sessionsObservable.get()}dispose(){this._disposable.dispose()}update({added:e,removed:t}){this._logger.trace(`Updating tokens: added ${e.length}, removed ${t.length}`);const i=[...this._tokensObservable.get()];for(const s of t){const r=i.findIndex(n=>n.access_token===s.access_token);r!==-1&&i.splice(r,1)}for(const s of e){const r=i.findIndex(n=>n.access_token===s.access_token);r===-1?i.push(s):i[r]=s}(e.length||t.length)&&(this._tokensObservable.set(i,void 0),this._persistence.set(i)),this._logger.trace(`Tokens updated: ${i.length} tokens stored.`)}_registerChangeEventAutorun(){let e=[];return bl(t=>{this._logger.trace("Checking for session changes...");const i=this._sessionsObservable.read(t);if(e===i){this._logger.trace("No session changes detected.");return}if(!i||i.length===0){this._logger.trace("All sessions removed."),e.length>0&&(this._onDidChangeSessions.fire({added:[],removed:e,changed:[]}),e=[]);return}const s=[],r=[];for(const n of i)e.some(c=>c.accessToken===n.accessToken)||s.push(n);for(const n of e)i.some(c=>c.accessToken===n.accessToken)||r.push(n);(s.length>0||r.length>0)&&(this._logger.trace(`Sessions changed: added ${s.length}, removed ${r.length}`),this._onDidChangeSessions.fire({added:s,removed:r,changed:[]})),e=i})}_getSessionFromToken(e){let t;if(e.id_token)try{t=Td(e.id_token)}catch{}if(!t)try{t=Td(e.access_token)}catch{}const i=e.scope?e.scope.split(" "):t?.scope?t.scope.split(" "):[];return{id:Up(e.access_token,0).toString(),accessToken:e.access_token,account:{id:t?.sub||"unknown",label:t?.preferred_username||t?.name||t?.email||"MCP"},scopes:i,idToken:e.id_token}}}const Xy={label:j(5179,"Other Models"),order:Number.MAX_SAFE_INTEGER};var Ws;const Qa=Y("IExtHostLanguageModels");class Id{constructor(e,t){this.option=e,this.stream=new wn,this.stream=t??new wn}}class Yy{constructor(){this._responseStreams=new Map,this._defaultStream=new wn,this._isDone=!1;const e=this;this.apiObject={get stream(){return e._defaultStream.asyncIterable},get text(){return xr.map(e._defaultStream.asyncIterable,t=>{if(t instanceof qi)return t.value}).coalesce()}}}*_streams(){if(this._responseStreams.size>0)for(const[,e]of this._responseStreams)yield e.stream;else yield this._defaultStream}handleFragment(e){if(this._isDone)return;const t=new Map;for(const i of fi.wrap(e)){let s;i.part.type==="text"?s=new qi(i.part.value):i.part.type==="data"?s=new qi(""):s=new La(i.part.toolCallId,i.part.name,i.part.parameters);const r=t.get(i.index);r?r.push(s):t.set(i.index,[s])}for(const[i,s]of t){let r=this._responseStreams.get(i);r||(this._responseStreams.size===0?r=new Id(i,this._defaultStream):r=new Id(i),this._responseStreams.set(i,r)),r.stream.emitMany(s)}}reject(e){this._isDone=!0;for(const t of this._streams())t.reject(e)}resolve(){this._isDone=!0;for(const e of this._streams())e.resolve()}}let Vo=class{static{Ws=this}static{this._idPool=1}constructor(e,t,i){this._logService=t,this._extHostAuthentication=i,this._onDidChangeModelAccess=new D,this._onDidChangeProviders=new D,this.onDidChangeProviders=this._onDidChangeProviders.event,this._languageModels=new Map,this._allLanguageModelData=new Map,this._modelAccessList=new Vt,this._pendingRequest=new Map,this._ignoredFileProviders=new Map,this._languageAccessInformationExtensions=new Set,this._proxy=e.getProxy(k.MainThreadLanguageModels)}dispose(){this._onDidChangeModelAccess.dispose(),this._onDidChangeProviders.dispose()}registerLanguageModel(e,t,i,s){const r=Ws._idPool++;this._languageModels.set(r,{extension:e.identifier,provider:i,languageModelId:t});let n;s.auth&&(n={providerLabel:e.displayName||e.name,accountLabel:typeof s.auth=="object"?s.auth.label:void 0}),this._proxy.$registerLanguageModelProvider(r,`${me.toKey(e.identifier)}/${t}`,{extension:e.identifier,id:t,vendor:s.vendor??me.toKey(e.identifier),name:s.name??"",family:s.family??"",cost:s.cost,description:s.description,version:s.version,maxInputTokens:s.maxInputTokens,maxOutputTokens:s.maxOutputTokens,auth:n,targetExtensions:s.extensions,isDefault:s.isDefault,isUserSelectable:s.isUserSelectable,modelPickerCategory:s.category??Xy,capabilities:s.capabilities});const o=i.onDidReceiveLanguageModelResponse2?.(({extensionId:c,participant:d,tokenCount:h})=>{this._proxy.$whenLanguageModelChatRequestMade(t,new me(c),d,h)});return V(()=>{this._languageModels.delete(r),this._proxy.$unregisterProvider(r),o?.dispose()})}async $startChatRequest(e,t,i,s,r,n){const o=this._languageModels.get(e);if(!o)throw new Error("Provider not found");const c=[],d=()=>{c.length>0&&(this._proxy.$reportResponsePart(t,c),c.length=0)},h=new Ea(d,30),f=p=>{c.push(p)>30?(d(),h.cancel()):h.schedule()},m=new Ca(async p=>{if(n.isCancellationRequested){this._logService.warn(`[CHAT](${o.extension.value}) CANNOT send progress because the REQUEST IS CANCELLED`);return}let _;if(p.part instanceof La?_={type:"tool_use",name:p.part.name,parameters:p.part.input,toolCallId:p.part.callId}:p.part instanceof qi?_={type:"text",value:p.part.value}:p.part instanceof ql&&(_={type:"data",value:{mimeType:p.part.mimeType,data:be.wrap(p.part.data)}}),!_){this._logService.warn(`[CHAT](${o.extension.value}) UNKNOWN part ${JSON.stringify(p)}`);return}f({index:p.index,part:_})});let l;try{l=o.provider.provideLanguageModelResponse(s.value.map(jr.to),r,me.toKey(i),m,n)}catch(p){throw p}Promise.resolve(l).then(()=>{d(),this._proxy.$reportResponseDone(t,void 0)},p=>{d(),this._proxy.$reportResponseDone(t,Ys(p))})}$provideTokenLength(e,t,i){const s=this._languageModels.get(e);return s?Promise.resolve(s.provider.provideTokenCount(t,i)):Promise.resolve(0)}$acceptChatModelMetadata(e){if(e.added)for(const{identifier:t,metadata:i}of e.added)this._allLanguageModelData.set(t,{metadata:i,apiObjects:new Vt});if(e.removed)for(const t of e.removed){this._allLanguageModelData.delete(t);for(const[i,s]of this._pendingRequest)s.languageModelId===t&&(s.res.reject(new gi),this._pendingRequest.delete(i))}e.added?.forEach(t=>this._fakeAuthPopulate(t.metadata)),this._onDidChangeProviders.fire(void 0)}async getDefaultLanguageModel(e){const t=fi.find(this._allLanguageModelData.entries(),([,i])=>!!i.metadata.isDefault)?.[0];if(t)return this.getLanguageModelByIdentifier(e,t)}async getLanguageModelByIdentifier(e,t){const i=this._allLanguageModelData.get(t);if(!i)return;this._isUsingAuth(e.identifier,i.metadata)&&await this._fakeAuthPopulate(i.metadata);let s=i.apiObjects.get(e.identifier);if(!s){const r=this;s={id:i.metadata.id,vendor:i.metadata.vendor,family:i.metadata.family,version:i.metadata.version,name:i.metadata.name,capabilities:{supportsImageToText:i.metadata.capabilities?.vision??!1,supportsToolCalling:i.metadata.capabilities?.toolCalling??!1},maxInputTokens:i.metadata.maxInputTokens,countTokens(n,o){if(!r._allLanguageModelData.has(t))throw Ye.NotFound(t);return r._computeTokenLength(t,n,o??de.None)},sendRequest(n,o,c){if(!r._allLanguageModelData.has(t))throw Ye.NotFound(t);return r._sendChatRequest(e,t,n,o??{},c??de.None)}},i.apiObjects.set(e.identifier,s)}return s}async selectLanguageModels(e,t){const i=await this._proxy.$selectChatModels({...t,extension:e.identifier}),s=[];for(const r of i){const n=await this.getLanguageModelByIdentifier(e,r);n&&s.push(n)}return s}async _sendChatRequest(e,t,i,s,r){const n=this._convertMessages(e,i),o=e.identifier,c=this._allLanguageModelData.get(t)?.metadata;if(!c||!this._allLanguageModelData.has(t))throw Ye.NotFound(`Language model '${t}' is unknown.`);if(this._isUsingAuth(o,c)&&(!await this._getAuthAccess(e,{identifier:c.extension,displayName:c.auth.providerLabel},s.justification,!1)||!this._modelAccessList.get(o)?.has(c.extension)))throw Ye.NoPermissions(`Language model '${t}' cannot be used by '${o.value}'.`);const d=Math.random()*1e6|0,h=new Yy;this._pendingRequest.set(d,{languageModelId:t,res:h});try{await this._proxy.$tryStartChatRequest(o,t,d,new Qe(n),s,r)}catch(f){throw this._pendingRequest.delete(d),Ye.tryDeserialize(f)??f}return h.apiObject}_convertMessages(e,t){const i=[];for(const s of t)s.role===jl.System&&b(e,"languageModelSystem"),i.push(jr.from(s));return i}async $acceptResponsePart(e,t){const i=this._pendingRequest.get(e);i&&i.res.handleFragment(t)}async $acceptResponseDone(e,t){const i=this._pendingRequest.get(e);i&&(this._pendingRequest.delete(e),t?i.res.reject(Ye.tryDeserialize(t)??Wp(t)):i.res.resolve())}async _getAuthAccess(e,t,i,s){const r=zl+t.identifier.value;if(await this._extHostAuthentication.getSession(e,r,[],{silent:!0}))return this.$updateModelAccesslist([{from:e.identifier,to:t.identifier,enabled:!0}]),!0;if(s)return!1;try{const o=i?j(2584,"Justification: {1}",t.displayName,i):void 0;return await this._extHostAuthentication.getSession(e,r,[],{forceNewSession:{detail:o}}),this.$updateModelAccesslist([{from:e.identifier,to:t.identifier,enabled:!0}]),!0}catch{return!1}}_isUsingAuth(e,t){return!!t.auth&&!me.equals(t.extension,e)}async _fakeAuthPopulate(e){if(e.auth)for(const t of this._languageAccessInformationExtensions)try{await this._getAuthAccess(t,{identifier:e.extension,displayName:""},void 0,!0)}catch(i){this._logService.error("Fake Auth request failed"),this._logService.error(i)}}async _computeTokenLength(e,t,i){if(!this._allLanguageModelData.get(e))throw Ye.NotFound(`Language model '${e}' is unknown.`);const r=fi.find(this._languageModels.values(),n=>n.languageModelId===e);return r?r.provider.provideTokenCount(t,i):this._proxy.$countTokens(e,typeof t=="string"?t:jr.from(t),i)}$updateModelAccesslist(e){const t=new Array;for(const{from:i,to:s,enabled:r}of e){const n=this._modelAccessList.get(i)??new os;if(n.has(s)!==r){r?n.add(s):n.delete(s),this._modelAccessList.set(i,n);const c={from:i,to:s};t.push(c),this._onDidChangeModelAccess.fire(c)}}}createLanguageModelAccessInformation(e){this._languageAccessInformationExtensions.add(e);const t=this,i=Ee.signal(Ee.filter(this._onDidChangeModelAccess.event,r=>me.equals(r.from,e.identifier))),s=Ee.signal(this._onDidChangeProviders.event);return{get onDidChange(){return Ee.any(i,s)},canSendRequest(r){let n;e:for(const[c,d]of t._allLanguageModelData)for(const h of d.apiObjects.values())if(h===r){n=d.metadata;break e}if(!n)return;if(!t._isUsingAuth(e.identifier,n))return!0;const o=t._modelAccessList.get(e.identifier);if(o)return o.has(n.extension)}}}fileIsIgnored(e,t,i=de.None){return b(e,"chatParticipantAdditions"),this._proxy.$fileIsIgnored(t,i)}async $isFileIgnored(e,t,i){const s=this._ignoredFileProviders.get(e);if(!s)throw new Error("Unknown LanguageModelIgnoredFileProvider");return await s.provideFileIgnored(v.revive(t),i)??!1}registerIgnoredFileProvider(e,t){b(e,"chatParticipantPrivate");const i=Ws._idPool++;return this._proxy.$registerFileIgnoreProvider(i),this._ignoredFileProviders.set(i,t),V(()=>{this._proxy.$unregisterFileIgnoreProvider(i),this._ignoredFileProviders.delete(i)})}};Vo=Ws=L([E(0,q),E(1,se),E(2,iu)],Vo);class su{constructor(e){this._onDidChangePassword=new D,this.onDidChangePassword=this._onDidChangePassword.event,this._proxy=e.getProxy(k.MainThreadSecretState)}async $onDidChangePassword(e){this._onDidChangePassword.fire(e)}get(e,t){return this._proxy.$getPassword(e,t)}store(e,t,i){return this._proxy.$setPassword(e,t,i)}delete(e,t){return this._proxy.$deletePassword(e,t)}}const Ja=Y("IExtHostSecretState");class Zy{#e;constructor(e,t){this.disposables=new N,this._id=me.toKey(e.identifier),this.#e=t,this.onDidChange=Ee.map(Ee.filter(this.#e.onDidChangePassword,i=>i.extensionId===this._id),i=>({key:i.key}),this.disposables)}dispose(){this.disposables.dispose()}get(e){return this.#e.get(this._id,e)}store(e,t){return this.#e.store(this._id,e,t)}delete(e){return this.#e.delete(this._id,e)}}let Bo=class{constructor(e,t,i){this.logService=i,this.bundleCache=new Map,this._proxy=t.getProxy(k.MainThreadLocalization),this.currentLanguage=e.environment.appLanguage,this.isDefaultLanguage=this.currentLanguage===Vp}getMessage(e,t){const{message:i,args:s,comment:r}=t;if(this.isDefaultLanguage)return kc(i,s??{});let n=i;r&&r.length>0&&(n+=`/${Array.isArray(r)?r.join(""):r}`);const o=this.bundleCache.get(e)?.contents[n];return o||this.logService.warn(`Using default string since no string found in i18n bundle that has the key: ${n}`),kc(o??i,s??{})}getBundle(e){return this.bundleCache.get(e)?.contents}getBundleUri(e){return this.bundleCache.get(e)?.uri}async initializeLocalizedMessages(e){if(this.isDefaultLanguage||!e.l10n&&!e.isBuiltin||this.bundleCache.has(e.identifier.value))return;let t;const i=await this.getBundleLocation(e);if(!i){this.logService.error(`No bundle location found for extension ${e.identifier.value}`);return}try{const s=await this._proxy.$fetchBundleContents(i),r=JSON.parse(s);t=e.isBuiltin?r.contents?.bundle:r}catch(s){this.logService.error(`Failed to load translations for ${e.identifier.value} from ${i}: ${s.message}`);return}t&&this.bundleCache.set(e.identifier.value,{contents:t,uri:i})}async getBundleLocation(e){if(e.isBuiltin){const t=await this._proxy.$fetchBuiltInBundleUri(e.identifier.value,this.currentLanguage);return v.revive(t)}return e.l10n?v.joinPath(e.extensionLocation,e.l10n,`bundle.l10n.${this.currentLanguage}.json`):void 0}};Bo=L([E(0,_e),E(1,q),E(2,se)],Bo);const Xa=Y("IExtHostLocalizationService"),Ya=Y("IExtHostManagedSockets");let zo=class{constructor(e){this._remoteSocketIdCounter=0,this._factory=null,this._managedRemoteSockets=new Map,this._proxy=e.getProxy(k.MainThreadManagedSockets)}setFactory(e,t){for(const i of this._managedRemoteSockets.values())i.dispose();this._factory&&this._proxy.$unregisterSocketFactory(this._factory.socketFactoryId),this._factory=new ew(e,t),this._proxy.$registerSocketFactory(this._factory.socketFactoryId)}async $openRemoteSocket(e){if(!this._factory||this._factory.socketFactoryId!==e)throw new Error(`No socket factory with id ${e}`);const t=++this._remoteSocketIdCounter,i=await this._factory.makeConnection(),s=new N;return this._managedRemoteSockets.set(t,new tw(t,i,s)),s.add(V(()=>this._managedRemoteSockets.delete(t))),s.add(i.onDidEnd(()=>{this._proxy.$onDidManagedSocketEnd(t),s.dispose()})),s.add(i.onDidClose(r=>{this._proxy.$onDidManagedSocketClose(t,r?.stack??r?.message),s.dispose()})),s.add(i.onDidReceiveMessage(r=>this._proxy.$onDidManagedSocketHaveData(t,be.wrap(r)))),t}$remoteSocketWrite(e,t){this._managedRemoteSockets.get(e)?.actual.send(t.buffer)}$remoteSocketEnd(e){const t=this._managedRemoteSockets.get(e);t&&(t.actual.end(),t.dispose())}async $remoteSocketDrain(e){await this._managedRemoteSockets.get(e)?.actual.drain?.()}};zo=L([E(0,q)],zo);class ew{constructor(e,t){this.socketFactoryId=e,this.makeConnection=t}}class tw extends Z{constructor(e,t,i){super(),this.socketId=e,this.actual=t,this._register(i)}}var jo;const ru=Y("IHostUtils");let qo=jo=class extends Z{constructor(e,t,i,s,r,n,o,c,d,h,f,m,l){super(),this._extHostManagedSockets=m,this._extHostLanguageModels=l,this._onDidChangeRemoteConnectionData=this._register(new D),this.onDidChangeRemoteConnectionData=this._onDidChangeRemoteConnectionData.event,this._realPathCache=new Map,this._isTerminating=!1,this._hostUtils=t,this._extHostContext=i,this._initData=o,this._extHostWorkspace=s,this._extHostConfiguration=r,this._logService=n,this._extHostTunnelService=d,this._extHostTerminalService=h,this._extHostLocalizationService=f,this._mainThreadWorkspaceProxy=this._extHostContext.getProxy(k.MainThreadWorkspace),this._mainThreadTelemetryProxy=this._extHostContext.getProxy(k.MainThreadTelemetry),this._mainThreadExtensionsProxy=this._extHostContext.getProxy(k.MainThreadExtensionService),this._almostReadyToRunExtensions=new mt,this._readyToStartExtensionHost=new mt,this._readyToRunExtensions=new mt,this._eagerExtensionsActivated=new mt,this._activationEventsReader=new sw(this._initData.extensions.activationEvents),this._globalRegistry=new ji(this._activationEventsReader,this._initData.extensions.allExtensions);const p=new os(this._initData.extensions.myExtensions);this._myRegistry=new ji(this._activationEventsReader,nu(this._globalRegistry,p)),Pt&&(this._logService.info(`Creating extension host with the following global extensions: ${ei(this._globalRegistry)}`),this._logService.info(`Creating extension host with the following local extensions: ${ei(this._myRegistry)}`)),this._storage=new Zh(this._extHostContext,this._logService),this._secretState=new su(this._extHostContext),this._storagePath=c,this._instaService=this._store.add(e.createChild(new El([Ga,this._storage],[Ja,this._secretState]))),this._activator=this._register(new $o(this._myRegistry,this._globalRegistry,{onExtensionActivationError:(_,x,S)=>{this._mainThreadExtensionsProxy.$onExtensionActivationError(_,Ys(x),S)},actualActivateExtension:async(_,x)=>{if(ji.isHostExtension(_,this._myRegistry,this._globalRegistry))return await this._mainThreadExtensionsProxy.$activateExtension(_,x),new Ly;const S=this._myRegistry.getExtensionDescription(_);return this._activateExtension(S,x)}},this._logService)),this._extensionPathIndex=null,this._resolvers=Object.create(null),this._started=!1,this._remoteConnectionData=this._initData.remote.connectionData}getRemoteConnectionData(){return this._remoteConnectionData}async initialize(){try{await this._beforeAlmostReadyToRunExtensions(),this._almostReadyToRunExtensions.open(),await this._extHostWorkspace.waitForInitializeCall(),Ve("code/extHost/ready"),this._readyToStartExtensionHost.open(),this._initData.autoStart&&this._startExtensionHost()}catch(e){Sa(e)}}async _deactivateAll(){this._storagePath.onWillDeactivateAll();let e=[];try{e=this._myRegistry.getAllExtensionDescriptions().map(r=>r.identifier).filter(r=>this.isActivated(r)).map(r=>this._deactivate(r))}catch{}await Promise.all(e)}terminate(e,t=0){if(this._isTerminating)return;this._isTerminating=!0,this._logService.info(`Extension host terminating: ${e}`),this._logService.flush(),this._extHostTerminalService.dispose(),this._activator.dispose(),Zs&&xn(s=>{this._logService.error(s)}),this._extHostContext.dispose();const i=this._deactivateAll();Promise.race([Nt(5e3),i]).finally(()=>{this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} exiting with code ${t}`):this._logService.info(`Extension host exiting with code ${t}`),this._logService.flush(),this._logService.dispose(),this._hostUtils.exit(t)})}isActivated(e){return this._readyToRunExtensions.isOpen()?this._activator.isActivated(e):!1}async getExtension(e){const t=await this._mainThreadExtensionsProxy.$getExtension(e);return t&&{...t,identifier:new me(t.identifier.value),extensionLocation:v.revive(t.extensionLocation)}}_activateByEvent(e,t){return this._activator.activateByEvent(e,t)}_activateById(e,t){return this._activator.activateById(e,t)}activateByIdWithErrors(e,t){return this._activateById(e,t).then(()=>{const i=this._activator.getActivatedExtension(e);if(i.activationFailed)return Promise.reject(i.activationFailedError)})}getExtensionRegistry(){return this._readyToRunExtensions.wait().then(e=>this._myRegistry)}getExtensionExports(e){if(this._readyToRunExtensions.isOpen())return this._activator.getActivatedExtension(e).exports;try{return this._activator.getActivatedExtension(e).exports}catch{return null}}async _realPathExtensionUri(e){if(e.scheme===G.file&&this._hostUtils.fsRealpath){const t=e.fsPath;this._realPathCache.has(t)||this._realPathCache.set(t,this._hostUtils.fsRealpath(t));const i=await this._realPathCache.get(t);return v.file(i)}return e}async getExtensionPathIndex(){return this._extensionPathIndex||(this._extensionPathIndex=this._createExtensionPathIndex(this._myRegistry.getAllExtensionDescriptions()).then(e=>new iw(e))),this._extensionPathIndex}async _createExtensionPathIndex(e){const t=xa.forUris(i=>Kp.ignorePathCasing(i));return await Promise.all(e.map(async i=>{if(this._getEntryPoint(i)){const s=await this._realPathExtensionUri(i.extensionLocation);t.set(s,i)}})),t}_deactivate(e){let t=Promise.resolve(void 0);if(!this._readyToRunExtensions.isOpen()||!this._activator.isActivated(e))return t;const i=this._activator.getActivatedExtension(e);if(!i)return t;try{typeof i.module.deactivate=="function"&&(t=Promise.resolve(i.module.deactivate()).then(void 0,s=>(this._logService.error(s),Promise.resolve(void 0))))}catch(s){this._logService.error(`An error occurred when deactivating the extension '${e.value}':`),this._logService.error(s)}try{i.disposable.dispose()}catch(s){this._logService.error(`An error occurred when disposing the subscriptions for extension '${e.value}':`),this._logService.error(s)}return t}async _activateExtension(e,t){return this._initData.remote.isRemote?this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier):await this._mainThreadExtensionsProxy.$onWillActivateExtension(e.identifier),this._doActivateExtension(e,t).then(i=>{const s=i.activationTimes;return this._mainThreadExtensionsProxy.$onDidActivateExtension(e.identifier,s.codeLoadingTime,s.activateCallTime,s.activateResolvedTime,t),this._logExtensionActivationTimes(e,t,"success",s),i},i=>{throw this._logExtensionActivationTimes(e,t,"failure"),i})}_logExtensionActivationTimes(e,t,i,s){const r=Ad(e,t);this._mainThreadTelemetryProxy.$publicLog2("extensionActivationTimes",{...r,...s||{},outcome:i})}_doActivateExtension(e,t){const i=Ad(e,t);this._mainThreadTelemetryProxy.$publicLog2("activatePlugin",i);const s=this._getEntryPoint(e);if(!s)return Promise.resolve(new Fy(Ei.NONE));this._logService.info(`ExtensionService#_doActivateExtension ${e.identifier.value}, startup: ${t.startup}, activationEvent: '${t.activationEvent}'${e.identifier.value!==t.extensionId.value?`, root cause: ${t.extensionId.value}`:""}`),this._logService.flush();const r=this._isESM(e),n=new N,o=new tn(t.startup);return Promise.all([r?this._loadESMModule(e,er(e.extensionLocation,s),o):this._loadCommonJSModule(e,er(e.extensionLocation,s),o),this._loadExtensionContext(e,n)]).then(c=>(Ve(`code/extHost/willActivateExtension/${e.identifier.value}`),jo._callActivate(this._logService,e.identifier,c[0],c[1],n,o))).then(c=>(Ve(`code/extHost/didActivateExtension/${e.identifier.value}`),c))}_loadExtensionContext(e,t){const i=this._extHostLanguageModels.createLanguageModelAccessInformation(e),s=t.add(new Ny(e,this._storage)),r=t.add(new eu(e.identifier.value,!1,this._storage)),n=t.add(new Zy(e,this._secretState)),o=e.isUnderDevelopment?this._initData.environment.extensionTestsLocationURI?As.Test:As.Development:As.Production,c=this._initData.remote.isRemote?Ki.Workspace:Ki.UI;return this._logService.trace(`ExtensionService#loadExtensionContext ${e.identifier.value}`),Promise.all([s.whenReady,r.whenReady,this._storagePath.whenReady]).then(()=>{const d=this;let h,f;const m=ie(e,"ipc")?this._initData.messagePorts?.get(me.toKey(e.identifier)):void 0;return Object.freeze({globalState:s,workspaceState:r,secrets:n,subscriptions:[],get languageModelAccessInformation(){return i},get extensionUri(){return e.extensionLocation},get extensionPath(){return e.extensionLocation.fsPath},asAbsolutePath(l){return Ic(e.extensionLocation.fsPath,l)},get storagePath(){return d._storagePath.workspaceValue(e)?.fsPath},get globalStoragePath(){return d._storagePath.globalValue(e).fsPath},get logPath(){return Ic(d._initData.logsLocation.fsPath,e.identifier.value)},get logUri(){return v.joinPath(d._initData.logsLocation,e.identifier.value)},get storageUri(){return d._storagePath.workspaceValue(e)},get globalStorageUri(){return d._storagePath.globalValue(e)},get extensionMode(){return o},get extension(){return h===void 0&&(h=new Ui(d,e.identifier,e,c,!1)),h},get extensionRuntime(){return b(e,"extensionRuntime"),d.extensionRuntime},get environmentVariableCollection(){return d._extHostTerminalService.getEnvironmentVariableCollection(e)},get messagePassingProtocol(){if(!f){if(!m)return;const l=Ee.buffer(Ee.fromDOMEventEmitter(m,"message",p=>p.data));m.start(),f={onDidReceiveMessage:l,postMessage:m.postMessage.bind(m)}}return f}})})}static _callActivate(e,t,i,s,r,n){return i=i||{activate:void 0,deactivate:void 0},this._callActivateOptional(e,t,i,s,n).then(o=>new Pr(!1,null,n.build(),i,o,V(()=>{r.dispose(),Gs(s.subscriptions)})))}static _callActivateOptional(e,t,i,s,r){if(typeof i.activate=="function")try{r.activateCallStart(),e.trace(`ExtensionService#_callActivateOptional ${t.value}`);const n=typeof global=="object"?global:self,o=i.activate.apply(n,[s]);return r.activateCallStop(),r.activateResolveStart(),Promise.resolve(o).then(c=>(r.activateResolveStop(),c))}catch(n){return Promise.reject(n)}else return Promise.resolve(i)}_activateOneStartupFinished(e,t){this._activateById(e.identifier,{startup:!1,extensionId:e.identifier,activationEvent:t}).then(void 0,i=>{this._logService.error(i)})}_activateAllStartupFinishedDeferred(e,t=0){const s=Date.now();Bp(()=>{for(let r=t;r<e.length;r+=1){const n=e[r];for(const o of n.activationEvents??[])if(o==="onStartupFinished")if(Date.now()-s>50){this._activateAllStartupFinishedDeferred(e,r);break}else this._activateOneStartupFinished(n,o)}})}_activateAllStartupFinished(){this._mainThreadExtensionsProxy.$setPerformanceMarks(zp()),this._extHostConfiguration.getConfigProvider().then(e=>{const t=e.getConfiguration("extensions.experimental").get("deferredStartupFinishedActivation"),i=this._myRegistry.getAllExtensionDescriptions();if(t)this._activateAllStartupFinishedDeferred(i);else for(const s of i)if(s.activationEvents)for(const r of s.activationEvents)r==="onStartupFinished"&&this._activateOneStartupFinished(s,r)})}_handleEagerExtensions(){const e=this._activateByEvent("*",!0).then(void 0,n=>{this._logService.error(n)});this._register(this._extHostWorkspace.onDidChangeWorkspace(n=>this._handleWorkspaceContainsEagerExtensions(n.added)));const t=this._extHostWorkspace.workspace?this._extHostWorkspace.workspace.folders:[],i=this._handleWorkspaceContainsEagerExtensions(t),s=this._handleRemoteResolverEagerExtensions(),r=Promise.all([s,e,i]).then(()=>{});return Promise.race([r,Nt(1e4)]).then(()=>{this._activateAllStartupFinished()}),r}_handleWorkspaceContainsEagerExtensions(e){return e.length===0?Promise.resolve(void 0):Promise.all(this._myRegistry.getAllExtensionDescriptions().map(t=>this._handleWorkspaceContainsEagerExtension(e,t))).then(()=>{})}async _handleWorkspaceContainsEagerExtension(e,t){if(this.isActivated(t.identifier))return;const i=!this._initData.remote.isRemote&&!!this._initData.remote.authority,s={logService:this._logService,folders:e.map(n=>n.uri),forceUsingSearch:i||!this._hostUtils.fsExists,exists:n=>this._hostUtils.fsExists(n.fsPath),checkExists:(n,o,c)=>this._mainThreadWorkspaceProxy.$checkExists(n,o,c)},r=await sg(s,t);if(r)return this._activateById(t.identifier,{startup:!0,extensionId:t.identifier,activationEvent:r.activationEvent}).then(void 0,n=>this._logService.error(n))}async _handleRemoteResolverEagerExtensions(){if(this._initData.remote.authority)return this._activateByEvent(`onResolveRemoteAuthority:${this._initData.remote.authority}`,!1)}async $extensionTestsExecute(){await this._eagerExtensionsActivated.wait();try{return await this._doHandleExtensionTests()}catch(e){throw console.error(e),e}}async _doHandleExtensionTests(){const{extensionDevelopmentLocationURI:e,extensionTestsLocationURI:t}=this._initData.environment;if(!e||!t)throw new Error(j(2580,"Cannot load test runner."));const i=(await this.getExtensionPathIndex()).findSubstr(t),r=await(this._isESM(i,t.path)?this._loadESMModule(null,t,new tn(!1)):this._loadCommonJSModule(null,t,new tn(!1)));if(!r||typeof r.run!="function")throw new Error(j(2581,"Path {0} does not point to a valid extension test runner.",t.toString()));return new Promise((n,o)=>{const c=(f,m)=>{f?(Pt&&this._logService.error("Test runner called back with error",f),o(f)):(Pt&&(m?this._logService.info(`Test runner called back with ${m} failures.`):this._logService.info("Test runner called back with successful outcome.")),n(typeof m=="number"&&m>0?1:0))},d=Sl(t),h=r.run(d,c);h&&h.then&&h.then(()=>{Pt&&this._logService.info("Test runner finished successfully."),n(0)}).catch(f=>{Pt&&this._logService.error("Test runner finished with error",f),o(f instanceof Error&&f.stack?f.stack:String(f))})})}_startExtensionHost(){if(this._started)throw new Error("Extension host is already started!");return this._started=!0,this._readyToStartExtensionHost.wait().then(()=>this._readyToRunExtensions.open()).then(()=>Promise.race([this._activator.waitForActivatingExtensions(),Nt(1e3)])).then(()=>this._handleEagerExtensions()).then(()=>{this._eagerExtensionsActivated.open(),this._logService.info("Eager extensions activated")})}registerRemoteAuthorityResolver(e,t){return this._resolvers[e]=t,V(()=>{delete this._resolvers[e]})}async getRemoteExecServer(e){const{resolver:t}=await this._activateAndGetResolver(e);return t?.resolveExecServer?.(e,{resolveAttempt:0})}async _activateAndGetResolver(e){const t=e.indexOf("+");if(t===-1)throw new ti("Not an authority that can be resolved!",ms.InvalidAuthority);const i=e.substr(0,t);return await this._almostReadyToRunExtensions.wait(),await this._activateByEvent(`onResolveRemoteAuthority:${i}`,!1),{authorityPrefix:i,resolver:this._resolvers[i]}}async $resolveAuthority(e,t){const i=ui.create(!1),s=()=>`[resolveAuthority(${Qc(e)},${t})][${i.elapsed()}ms] `,r=C=>this._logService.info(`${s()}${C}`),n=C=>this._logService.warn(`${s()}${C}`),o=(C,T=void 0)=>this._logService.error(`${s()}${C}`,T),c=C=>{if(C instanceof ti)return{type:"error",error:{code:C._code,message:C._message,detail:C._detail}};throw C},d=async C=>{r(`activating resolver for ${C}...`);const{resolver:T,authorityPrefix:O}=await this._activateAndGetResolver(C);if(!T)throw o(`no resolver for ${O}`),new ti(`No remote extension installed to resolve ${O}.`,ms.NoResolverFound);return{resolver:T,authorityPrefix:O,remoteAuthority:C}},h=e.split(/@|%40/g).reverse();r(`activating remote resolvers ${h.join(" -> ")}`);let f;try{f=await Promise.all(h.map(d)).catch(async C=>{if(!(C instanceof ti)||C._code!==ms.InvalidAuthority)throw C;return n(`resolving nested authorities failed: ${C.message}`),[await d(e)]})}catch(C){return c(C)}const m=new jp;m.cancelAndSet(()=>r("waiting..."),1e3);let l,p;for(const[C,{authorityPrefix:T,resolver:O,remoteAuthority:I}]of f.entries())try{if(C===f.length-1)r("invoking final resolve()..."),Ve(`code/extHost/willResolveAuthority/${T}`),l=await O.resolve(I,{resolveAttempt:t,execServer:p}),Ve(`code/extHost/didResolveAuthorityOK/${T}`),r("setting tunnel factory..."),this._register(await this._extHostTunnelService.setTunnelFactory(O,$s.isManagedResolvedAuthority(l)?l:void 0));else{if(r(`invoking resolveExecServer() for ${I}`),Ve(`code/extHost/willResolveExecServer/${T}`),p=await O.resolveExecServer?.(I,{resolveAttempt:t,execServer:p}),!p)throw new ti(`Exec server was not available for ${I}`,ms.NoResolverFound);Ve(`code/extHost/didResolveExecServerOK/${T}`)}}catch(B){return Ve(`code/extHost/didResolveAuthorityError/${T}`),o("returned an error",B),m.dispose(),c(B)}m.dispose();const _={environmentTunnels:l.environmentTunnels,features:l.tunnelFeatures?{elevation:l.tunnelFeatures.elevation,privacyOptions:l.tunnelFeatures.privacyOptions,protocol:l.tunnelFeatures.protocol===void 0?!0:l.tunnelFeatures.protocol}:void 0},x={extensionHostEnv:l.extensionHostEnv,isTrusted:l.isTrusted,authenticationSession:l.authenticationSessionForInitializingExtensions?{id:l.authenticationSessionForInitializingExtensions.id,providerId:l.authenticationSessionForInitializingExtensions.providerId}:void 0};r(`returned ${$s.isManagedResolvedAuthority(l)?"managed authority":`${l.host}:${l.port}`}`);let S;if($s.isManagedResolvedAuthority(l)){const C=t;this._extHostManagedSockets.setFactory(C,l.makeConnection),S={authority:e,connectTo:new rg(C),connectionToken:l.connectionToken}}else S={authority:e,connectTo:new ng(l.host,l.port),connectionToken:l.connectionToken};return{type:"ok",value:{authority:S,options:x,tunnelInformation:_}}}async $getCanonicalURI(e,t){this._logService.info(`$getCanonicalURI invoked for authority (${Qc(e)})`);const{resolver:i}=await this._activateAndGetResolver(e);if(!i)return null;const s=v.revive(t);if(typeof i.getCanonicalURI>"u")return s;const r=await xe(()=>i.getCanonicalURI(s));return r||s}async $startExtensionHost(e){e.toAdd.forEach(n=>n.extensionLocation=v.revive(n.extensionLocation));const{globalRegistry:t,myExtensions:i}=Rd(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),s=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(s),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),Pt&&(this._logService.info(`$startExtensionHost: global extensions: ${ei(this._globalRegistry)}`),this._logService.info(`$startExtensionHost: local extensions: ${ei(this._myRegistry)}`)),this._startExtensionHost()}$activateByEvent(e,t){return t===qp.Immediate?this._almostReadyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1)):this._readyToRunExtensions.wait().then(i=>this._activateByEvent(e,!1))}async $activate(e,t){return await this._readyToRunExtensions.wait(),this._myRegistry.getExtensionDescription(e)?(await this._activateById(e,t),!0):!1}async $deltaExtensions(e){e.toAdd.forEach(n=>n.extensionLocation=v.revive(n.extensionLocation));const{globalRegistry:t,myExtensions:i}=Rd(this._activationEventsReader,this._globalRegistry,this._myRegistry,e),s=await this._createExtensionPathIndex(i);return(await this.getExtensionPathIndex()).setSearchTree(s),this._globalRegistry.set(t.getAllExtensionDescriptions()),this._myRegistry.set(i),Pt&&(this._logService.info(`$deltaExtensions: global extensions: ${ei(this._globalRegistry)}`),this._logService.info(`$deltaExtensions: local extensions: ${ei(this._myRegistry)}`)),Promise.resolve(void 0)}async $test_latency(e){return e}async $test_up(e){return e.byteLength}async $test_down(e){const t=be.alloc(e),i=Math.random()%256;for(let s=0;s<e;s++)t.writeUInt8(i,s);return t}async $updateRemoteConnectionData(e){this._remoteConnectionData=e,this._onDidChangeRemoteConnectionData.fire()}_isESM(e,t){return t??=e?this._getEntryPoint(e):t,t?.endsWith(".mjs")||e?.type==="module"&&!t?.endsWith(".cjs")}};qo=jo=L([E(0,Pa),E(1,ru),E(2,q),E(3,rt),E(4,nt),E(5,se),E(6,_e),E(7,tu),E(8,Na),E(9,bi),E(10,Xa),E(11,Ya),E(12,Qa)],qo);function Rd(a,e,t,i){a.addActivationEvents(i.addActivationEvents);const s=new ji(a,e.getAllExtensionDescriptions());s.deltaExtensions(i.toAdd,i.toRemove);const r=new os(t.getAllExtensionDescriptions().map(o=>o.identifier));for(const o of i.myToRemove)r.delete(o);for(const o of i.myToAdd)r.add(o);const n=nu(s,r);return{globalRegistry:s,myExtensions:n}}function Ad(a,e){return{id:a.identifier.value,name:a.name,extensionVersion:a.version,publisherDisplayName:a.publisher,activationEvents:a.activationEvents?a.activationEvents.join(","):null,isBuiltin:a.isBuiltin,reason:e.activationEvent,reasonId:e.extensionId.value}}function ei(a){return a.getAllExtensionDescriptions().map(e=>e.identifier.value).join(",")}const qt=Y("IExtHostExtensionService");class Ui{#e;#t;#i;constructor(e,t,i,s,r){this.#e=e,this.#t=t,this.#i=i.identifier,this.id=i.identifier.value,this.extensionUri=i.extensionLocation,this.extensionPath=bn(Sl(i.extensionLocation)),this.packageJSON=i,this.extensionKind=s,this.isFromDifferentExtensionHost=r}get isActive(){return this.#e.isActivated(this.#i)}get exports(){if(!(this.packageJSON.api==="none"||this.isFromDifferentExtensionHost))return this.#e.getExtensionExports(this.#i)}async activate(){if(this.isFromDifferentExtensionHost)throw new Error("Cannot activate foreign extension");return await this.#e.activateByIdWithErrors(this.#i,{startup:!1,extensionId:this.#t,activationEvent:"api"}),this.exports}}function nu(a,e){return a.getAllExtensionDescriptions().filter(t=>e.has(t.identifier))}class iw{constructor(e){this._searchTree=e}setSearchTree(e){this._searchTree=e}findSubstr(e){return this._searchTree.findSubstr(e)}forEach(e){return this._searchTree.forEach(e)}}class sw{constructor(e){this._map=new Vt,this.addActivationEvents(e)}readActivationEvents(e){return this._map.get(e.identifier)??[]}addActivationEvents(e){for(const t of Object.keys(e))this._map.set(t,e[t])}}var $d;(function(a){a.ViewletId="workbench.view.extension.test",a.ExplorerViewId="workbench.view.testing",a.OutputPeekContributionId="editor.contrib.testingOutputPeek",a.DecorationsContributionId="editor.contrib.testingDecorations",a.CoverageDecorationsContributionId="editor.contrib.coverageDecorations",a.CoverageViewId="workbench.view.testCoverage",a.ResultsPanelId="workbench.panel.testResults",a.ResultsViewId="workbench.panel.testResults.view",a.MessageLanguageId="vscodeInternalTestMessage"})($d||($d={}));var Md;(function(a){a.List="list",a.Tree="true"})(Md||(Md={}));var Hd;(function(a){a.ByLocation="location",a.ByStatus="status",a.ByDuration="duration"})(Hd||(Hd={}));$e.Errored+"",j(11310,"Errored"),$e.Failed+"",j(11311,"Failed"),$e.Passed+"",j(11312,"Passed"),$e.Queued+"",j(11313,"Queued"),$e.Running+"",j(11314,"Running"),$e.Skipped+"",j(11315,"Skipped"),$e.Unset+"",j(11316,"Not yet run");qr.Debug+"",j(11318,"Debug"),qr.Run+"",j(11319,"Run"),qr.Coverage+"",j(11320,"Coverage");var Ko;(function(a){a.CancelTestRefreshAction="testing.cancelTestRefresh",a.CancelTestRunAction="testing.cancelRun",a.ClearTestResultsAction="testing.clearTestResults",a.CollapseAllAction="testing.collapseAll",a.ConfigureTestProfilesAction="testing.configureProfile",a.ContinousRunUsingForTest="testing.continuousRunUsingForTest",a.CoverageAtCursor="testing.coverageAtCursor",a.CoverageByUri="testing.coverage.uri",a.CoverageClear="testing.coverage.close",a.CoverageCurrentFile="testing.coverageCurrentFile",a.CoverageFilterToTest="testing.coverageFilterToTest",a.CoverageFilterToTestInEditor="testing.coverageFilterToTestInEditor",a.CoverageLastRun="testing.coverageLastRun",a.CoverageSelectedAction="testing.coverageSelected",a.CoverageToggleToolbar="testing.coverageToggleToolbar",a.CoverageViewChangeSorting="testing.coverageViewChangeSorting",a.DebugAction="testing.debug",a.DebugAllAction="testing.debugAll",a.DebugAtCursor="testing.debugAtCursor",a.DebugByUri="testing.debug.uri",a.DebugCurrentFile="testing.debugCurrentFile",a.DebugFailedTests="testing.debugFailTests",a.DebugLastRun="testing.debugLastRun",a.DebugSelectedAction="testing.debugSelected",a.FilterAction="workbench.actions.treeView.testExplorer.filter",a.GetExplorerSelection="_testing.getExplorerSelection",a.GetSelectedProfiles="testing.getSelectedProfiles",a.GoToTest="testing.editFocusedTest",a.GoToRelatedTest="testing.goToRelatedTest",a.PeekRelatedTest="testing.peekRelatedTest",a.GoToRelatedCode="testing.goToRelatedCode",a.PeekRelatedCode="testing.peekRelatedCode",a.HideTestAction="testing.hideTest",a.OpenCoverage="testing.openCoverage",a.OpenOutputPeek="testing.openOutputPeek",a.RefreshTestsAction="testing.refreshTests",a.ReRunFailedTests="testing.reRunFailTests",a.ReRunLastRun="testing.reRunLastRun",a.RunAction="testing.run",a.RunAllAction="testing.runAll",a.RunAllWithCoverageAction="testing.coverageAll",a.RunAtCursor="testing.runAtCursor",a.RunByUri="testing.run.uri",a.RunCurrentFile="testing.runCurrentFile",a.RunSelectedAction="testing.runSelected",a.RunUsingProfileAction="testing.runUsing",a.RunWithCoverageAction="testing.coverage",a.SearchForTestExtension="testing.searchForTestExtension",a.SelectDefaultTestProfiles="testing.selectDefaultTestProfiles",a.ShowMostRecentOutputAction="testing.showMostRecentOutput",a.StartContinousRun="testing.startContinuousRun",a.StartContinousRunFromExtension="testing.startContinuousRunFromExtension",a.StopContinousRunFromExtension="testing.stopContinuousRunFromExtension",a.StopContinousRun="testing.stopContinuousRun",a.TestingSortByDurationAction="testing.sortByDuration",a.TestingSortByLocationAction="testing.sortByLocation",a.TestingSortByStatusAction="testing.sortByStatus",a.TestingViewAsListAction="testing.viewAsList",a.TestingViewAsTreeAction="testing.viewAsTree",a.ToggleContinousRunForTest="testing.toggleContinuousRunForTest",a.ToggleInlineTestOutput="testing.toggleInlineTestOutput",a.UnhideAllTestsAction="testing.unhideAllTests",a.UnhideTestAction="testing.unhideTest"})(Ko||(Ko={}));let rw=0;const Fd=new WeakMap,Rr=Y("IExtHostTesting");let Go=class extends Z{constructor(e,t,i,s){super(),this.logService=t,this.commands=i,this.editors=s,this.resultsChangedEmitter=this._register(new D),this.controllers=new Map,this.defaultProfilesChangedEmitter=this._register(new D),this.followupProviders=new Set,this.testFollowups=new Map,this.onResultsChanged=this.resultsChangedEmitter.event,this.results=[],this.proxy=e.getProxy(k.MainThreadTesting),this.observer=new lw(this.proxy),this.runTracker=new aw(this.proxy,t),i.registerArgumentProcessor({processArgument:r=>{switch(r?.$mid){case Se.TestItemContext:{const n=r,o=n.tests[n.tests.length-1].item.extId;return this.controllers.get(oe.root(o))?.collection.tree.get(o)?.actual??vd(r)}case Se.TestMessageMenuArgs:{const{test:n,message:o}=r,c=n.item.extId;return{test:this.controllers.get(oe.root(c))?.collection.tree.get(c)?.actual??vd({tests:[n]}),message:In.to(o)}}default:return r}}}),i.registerCommand(!1,"testing.getExplorerSelection",async()=>{const r=await i.executeCommand(Ko.GetExplorerSelection),n=o=>{const c=this.controllers.get(oe.root(o));if(c)return oe.isRoot(o)?c.controller:c.collection.tree.get(o)?.actual};return{include:r?.include.map(n).filter(Mi)||[],exclude:r?.exclude.map(n).filter(Mi)||[]}})}createTestController(e,t,i,s){if(this.controllers.has(t))throw new Error(`Attempt to insert a duplicate controller with ID "${t}"`);const r=new N,n=r.add(new xy(t,i,this.editors));n.root.label=i;const o=new Map,c=new Set,d=this.proxy,h=()=>{let l=0;s&&(l|=Kr.Refresh);const p=m.relatedCodeProvider;return p&&(p?.provideRelatedTests&&(l|=Kr.TestRelatedToCode),p?.provideRelatedCode&&(l|=Kr.CodeRelatedToTest)),l},f={items:n.root.children,get label(){return i},set label(l){i=l,n.root.label=l,d.$updateController(t,{label:i})},get refreshHandler(){return s},set refreshHandler(l){s=l,d.$updateController(t,{capabilities:h()})},get id(){return t},get relatedCodeProvider(){return m.relatedCodeProvider},set relatedCodeProvider(l){b(e,"testRelatedCode"),m.relatedCodeProvider=l,d.$updateController(t,{capabilities:h()})},createRunProfile:(l,p,_,x,S,C)=>{let T=Cl(l);for(;o.has(T);)T++;return new au(this.proxy,o,c,this.defaultProfilesChangedEmitter.event,t,T,l,p,_,x,S,C)},createTestItem(l,p,_){return new zt(t,l,p,_)},createTestRun:(l,p,_=!0)=>this.runTracker.createTestRun(e,t,n,l,p,_),invalidateTestResults:l=>{if(l===void 0)this.proxy.$markTestRetired(void 0);else{const p=l instanceof Array?l:[l];this.proxy.$markTestRetired(p.map(_=>oe.fromExtHostTestItem(_,t).toString()))}},set resolveHandler(l){n.resolveHandler=l},get resolveHandler(){return n.resolveHandler},dispose:()=>{r.dispose()}},m={controller:f,collection:n,profiles:o,extension:e,activeProfiles:c};return d.$registerTestController(t,i,h()),r.add(V(()=>d.$unregisterTestController(t))),this.controllers.set(t,m),r.add(V(()=>this.controllers.delete(t))),r.add(n.onDidGenerateDiff(l=>d.$publishDiff(t,l.map(Jc.serialize)))),f}createTestObserver(){return this.observer.checkout()}async runTests(e,t=de.None){const i=ou(e);if(!i)throw new Error("The request passed to `vscode.test.runTests` must include a profile");const s=this.controllers.get(i.controllerId);if(!s)throw new Error("Controller not found");await this.proxy.$runTests({preserveFocus:e.preserveFocus??!0,group:Oa.from(i.kind),targets:[{testIds:e.include?.map(r=>oe.fromExtHostTestItem(r,s.collection.root.id).toString())??[s.collection.root.id],profileId:i.profileId,controllerId:i.controllerId}],exclude:e.exclude?.map(r=>r.id)},t)}registerTestFollowupProvider(e){return this.followupProviders.add(e),{dispose:()=>{this.followupProviders.delete(e)}}}async $getTestsRelatedToCode(e,t,i){const s=this.editors.getDocument(v.revive(e));if(!s)return[];const r=te.to(t),n=[];return await Promise.all([...this.controllers.values()].map(async o=>{let c;try{c=await o.relatedCodeProvider?.provideRelatedTests?.(s.document,r,i)}catch(d){i.isCancellationRequested||this.logService.warn(`Error thrown while providing related tests for ${o.controller.label}`,d)}if(c){for(const d of c)n.push(oe.fromExtHostTestItem(d,o.controller.id).toString());o.collection.flushDiff()}})),n}async $getCodeRelatedToTest(e,t){const i=this.controllers.get(oe.root(e));if(!i)return[];const s=i.collection.tree.get(e);return s?(await i.relatedCodeProvider?.provideRelatedCode?.(s.actual,t))?.map(st.from)??[]:[]}$syncTests(){for(const{collection:e}of this.controllers.values())e.flushDiff();return Promise.resolve()}async $getCoverageDetails(e,t,i){return(await this.runTracker.getCoverageDetails(e,t,i))?.map(Rn.fromDetails)}async $disposeRun(e){this.runTracker.disposeTestRun(e)}$configureRunProfile(e,t){this.controllers.get(e)?.profiles.get(t)?.configureHandler?.()}$setDefaultRunProfiles(e){const t=new Map;for(const[i,s]of Object.entries(e)){const r=this.controllers.get(i);if(!r)continue;const n=new Map,o=s.filter(d=>!r.activeProfiles.has(d)),c=[...r.activeProfiles].filter(d=>!s.includes(d));for(const d of o)n.set(d,!0),r.activeProfiles.add(d);for(const d of c)n.set(d,!1),r.activeProfiles.delete(d);n.size&&t.set(i,n)}this.defaultProfilesChangedEmitter.fire(t)}async $refreshTests(e,t){await this.controllers.get(e)?.controller.refreshHandler?.(t)}$publishTestResults(e){this.results=Object.freeze(e.map(t=>{const i=og.to(t),s=t.tasks.findIndex(r=>r.hasCoverage);return s!==-1&&(i.getDetailedCoverage=(r,n=de.None)=>this.proxy.$getCoverageDetails(t.id,s,r,n).then(o=>o.map(Rn.to))),Fd.set(i,t.id),i}).concat(this.results).sort((t,i)=>i.completedAt-t.completedAt).slice(0,32)),this.resultsChangedEmitter.fire()}async $expandTest(e,t){const i=this.controllers.get(oe.fromString(e).controllerId)?.collection;i&&(await i.expand(e,t<0?1/0:t),i.flushDiff())}$acceptDiff(e){this.observer.applyDiff(e.map(t=>Jc.deserialize({asCanonicalUri:i=>i},t)))}async $runControllerTests(e,t){return Promise.all(e.map(i=>this.runControllerTestRequest(i,!1,t)))}async $startContinuousRun(e,t){const i=new he(t),s=await Promise.all(e.map(r=>this.runControllerTestRequest(r,!0,i.token)));return!t.isCancellationRequested&&!s.some(r=>r.error)&&await new Promise(r=>t.onCancellationRequested(r)),i.dispose(!0),s}async $provideTestFollowups(e,t){const i=this.results.find(n=>Fd.get(n)===e.resultId),s=i&&hw(oe.fromString(e.extId),i?.results);if(!s)return[];let r=[];return await Promise.all([...this.followupProviders].map(async n=>{try{const o=await n.provideFollowup(i,s,e.taskIndex,e.messageIndex,t);o&&(r=r.concat(o))}catch(o){this.logService.error("Error thrown while providing followup for test message",o)}})),t.isCancellationRequested?[]:r.map(n=>{const o=rw++;return this.testFollowups.set(o,n),{title:n.title,id:o}})}$disposeTestFollowups(e){for(const t of e)this.testFollowups.delete(t)}$executeTestFollowup(e){const t=this.testFollowups.get(e);return t?this.commands.executeCommand(t.command,...t.arguments||[]):Promise.resolve()}$cancelExtensionTestRun(e,t){e===void 0?this.runTracker.cancelAllRuns():this.runTracker.cancelRunById(e,t)}getMetadataForRun(e){for(const t of this.runTracker.trackers){const i=t.getTaskIdForRun(e);if(i)return{taskId:i,runId:t.id}}}async runControllerTestRequest(e,t,i){const s=this.controllers.get(e.controllerId);if(!s)return{};const{collection:r,profiles:n,extension:o}=s,c=n.get(e.profileId);if(!c)return{};const d=e.testIds.map(l=>r.tree.get(l)).filter(Mi),h=e.excludeExtIds.map(l=>s.collection.tree.get(l)).filter(Mi).filter(l=>d.some(p=>p.fullId.compare(l.fullId)===ag.IsChild));if(!d.length)return{};const f=new Kl(d.some(l=>l.actual instanceof ja)?void 0:d.map(l=>l.actual),h.map(l=>l.actual),c,t),m=cg(e)&&this.runTracker.prepareForMainThreadTestRun(o,f,rs.fromInternal(e,s.collection),c,i);try{return await c.runHandler(f,i),{}}catch(l){return{error:String(l)}}finally{m&&m.hasRunningTasks&&!i.isCancellationRequested&&await Ee.toPromise(m.onEnd)}}};Go=L([E(0,q),E(1,se),E(2,jt),E(3,xi)],Go);const nw=1e4;var pt;(function(a){a[a.Running=0]="Running",a[a.Cancelling=1]="Cancelling",a[a.Ended=2]="Ended"})(pt||(pt={}));class ow extends Z{get hasRunningTasks(){return this.running>0}get id(){return this.dto.id}constructor(e,t,i,s,r,n){super(),this.dto=e,this.proxy=t,this.logService=i,this.profile=s,this.extension=r,this.state=pt.Running,this.running=0,this.tasks=new Map,this.sharedTestIds=new Set,this.endEmitter=this._register(new D),this.publishedCoverage=new Map,this.onEnd=this.endEmitter.event,this.cts=this._register(new he(n));const o=this._register(new Ea(()=>this.forciblyEndTasks(),nw));this._register(this.cts.token.onCancellationRequested(()=>o.schedule()));const c=new D;this.onDidDispose=c.event,this._register(V(()=>{c.fire(),c.dispose()}))}getTaskIdForRun(e){for(const[t,{run:i}]of this.tasks)if(i===e)return t}cancel(e){e?this.tasks.get(e)?.cts.cancel():this.state===pt.Running?(this.cts.cancel(),this.state=pt.Cancelling):this.state===pt.Cancelling&&this.forciblyEndTasks()}async getCoverageDetails(e,t,i){const[,s]=oe.fromString(e).path,r=this.publishedCoverage.get(e);if(!r)return[];const{report:n,extIds:o}=r,c=this.tasks.get(s);if(!c)throw new Error("unreachable: run task was not found");let d;if(t&&n instanceof An){const f=o.indexOf(t);if(f===-1)return[];d=n.includesTests[f]}return await(d?this.profile?.loadDetailedCoverageForTest?.(c.run,n,d,i):this.profile?.loadDetailedCoverage?.(c.run,n,i))??[]}createRun(e){const t=this.dto.id,i=this.dto.controllerId,s=Ct(),r=h=>(f,...m)=>{if(o){this.logService.warn(`Setting the state of test "${f.id}" is a no-op after the run ends.`);return}this.ensureTestIsKnown(f),h(f,...m)},n=(h,f)=>{const m=f instanceof Array?f.map(In.from):[In.from(f)];if(h.uri&&h.range){const l={range:A.from(h.range),uri:h.uri};for(const p of m)p.location=p.location||l}this.proxy.$appendTestMessagesInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),m)};let o=!1;const c=this._register(new he(this.cts.token)),d={isPersisted:this.dto.isPersisted,token:c.token,name:e,onDidDispose:this.onDidDispose,addCoverage:h=>{if(o)return;const f=h instanceof An?h.includesTests:[];if(f.length)for(const p of f)this.ensureTestIsKnown(p);const m=h.uri.toString(),l=new oe([t,s,m]).toString();this.publishedCoverage.set(l,{report:h,extIds:f.map(p=>oe.fromExtHostTestItem(p,i).toString())}),this.proxy.$appendCoverage(t,s,Rn.fromFile(i,l,h))},enqueued:r(h=>{this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),$e.Queued)}),skipped:r(h=>{this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),$e.Skipped)}),started:r(h=>{this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),$e.Running)}),errored:r((h,f,m)=>{n(h,f),this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),$e.Errored,m)}),failed:r((h,f,m)=>{n(h,f),this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,i).toString(),$e.Failed,m)}),passed:r((h,f)=>{this.proxy.$updateTestStateInRun(t,s,oe.fromExtHostTestItem(h,this.dto.controllerId).toString(),$e.Passed,f)}),appendOutput:(h,f,m)=>{o||(m&&this.ensureTestIsKnown(m),this.proxy.$appendOutputToRun(t,s,be.fromString(h),f&&st.from(f),m&&oe.fromExtHostTestItem(m,i).toString()))},end:()=>{o||(o=!0,this.proxy.$finishedTestRunTask(t,s),--this.running||this.markEnded())}};return this.running++,this.tasks.set(s,{run:d,cts:c}),this.proxy.$startedTestRunTask(t,{id:s,ctrlId:this.dto.controllerId,name:e||this.extension.displayName||this.extension.identifier.value,running:!0}),d}forciblyEndTasks(){for(const{run:e}of this.tasks.values())e.end()}markEnded(){this.state!==pt.Ended&&(this.state=pt.Ended,this.endEmitter.fire())}ensureTestIsKnown(e){if(!(e instanceof zt))throw new lg(e.id);if(this.sharedTestIds.has(oe.fromExtHostTestItem(e,this.dto.controllerId).toString()))return;const t=[],i=this.dto.colllection.root;for(;;){const s=cs.from(e);if(t.unshift(s),this.sharedTestIds.has(s.extId)||(this.sharedTestIds.add(s.extId),e===i))break;e=e.parent||i}this.proxy.$addTestsToRun(this.dto.controllerId,this.dto.id,t)}dispose(){this.markEnded(),super.dispose()}}class aw{get trackers(){return this.tracked.values()}constructor(e,t){this.proxy=e,this.logService=t,this.tracked=new Map,this.trackedById=new Map}getCoverageDetails(e,t,i){const s=oe.root(e);return this.trackedById.get(s)?.getCoverageDetails(e,t,i)||[]}disposeTestRun(e){this.trackedById.get(e)?.dispose(),this.trackedById.delete(e);for(const[t,{id:i}]of this.tracked)i===e&&this.tracked.delete(t)}prepareForMainThreadTestRun(e,t,i,s,r){return this.getTracker(t,i,s,e,r)}cancelRunById(e,t){this.trackedById.get(e)?.cancel(t)}cancelAllRuns(){for(const e of this.tracked.values())e.cancel()}createTestRun(e,t,i,s,r,n){const o=this.tracked.get(s);if(o)return o.createRun(r);const c=rs.fromPublic(t,i,s,n),d=ou(s);this.proxy.$startedExtensionTestRun({controllerId:t,continuous:!!s.continuous,profile:d&&{group:Oa.from(d.kind),id:d.profileId},exclude:s.exclude?.map(f=>oe.fromExtHostTestItem(f,i.root.id).toString())??[],id:c.id,include:s.include?.map(f=>oe.fromExtHostTestItem(f,i.root.id).toString())??[i.root.id],preserveFocus:s.preserveFocus??!0,persist:n});const h=this.getTracker(s,c,s.profile,e);return Ee.once(h.onEnd)(()=>{this.proxy.$finishedExtensionTestRun(c.id)}),h.createRun(r)}getTracker(e,t,i,s,r){const n=new ow(t,this.proxy,this.logService,i,s,r);return this.tracked.set(e,n),this.trackedById.set(n.id,n),n}}const ou=a=>{if(a.profile){if(!(a.profile instanceof au))throw new Error("TestRunRequest.profile is not an instance created from TestController.createRunProfile");return a.profile}};class rs{static fromPublic(e,t,i,s){return new rs(e,Ct(),s,t)}static fromInternal(e,t){return new rs(e.controllerId,e.runId,!0,t)}constructor(e,t,i,s){this.controllerId=e,this.id=t,this.isPersisted=i,this.colllection=s}}class cw{get isEmpty(){return this.added.size===0&&this.removed.size===0&&this.updated.size===0}constructor(e){this.emitter=e,this.added=new Set,this.updated=new Set,this.removed=new Set,this.alreadyRemoved=new Set}add(e){this.added.add(e)}update(e){Object.assign(e.revived,cs.toPlain(e.item)),this.added.has(e)||this.updated.add(e)}remove(e){if(this.added.has(e)){this.added.delete(e);return}this.updated.delete(e);const t=oe.parentId(e.item.extId);if(t&&this.alreadyRemoved.has(t.toString())){this.alreadyRemoved.add(e.item.extId);return}this.removed.add(e)}getChangeEvent(){const{added:e,updated:t,removed:i}=this;return{get added(){return[...e].map(s=>s.revived)},get updated(){return[...t].map(s=>s.revived)},get removed(){return[...i].map(s=>s.revived)}}}complete(){this.isEmpty||this.emitter.fire(this.getChangeEvent())}}class dw extends dg{constructor(){super(...arguments),this.changeEmitter=new D,this.onDidChangeTests=this.changeEmitter.event}get rootTests(){return this.roots}getMirroredTestDataById(e){return this.items.get(e)}getMirroredTestDataByReference(e){return this.items.get(e.id)}createItem(e,t){return{...e,revived:cs.toPlain(e.item),depth:t?t.depth+1:0,children:new Set}}createChangeCollector(){return new cw(this.changeEmitter)}}class lw{constructor(e){this.proxy=e}checkout(){this.current||(this.current=this.createObserverData());const e=this.current;return e.observers++,{onDidChangeTest:e.tests.onDidChangeTests,get tests(){return[...e.tests.rootTests].map(t=>t.revived)},dispose:Gp(()=>{--e.observers===0&&(this.proxy.$unsubscribeFromDiffs(),this.current=void 0)})}}getMirroredTestDataByReference(e){return this.current?.tests.getMirroredTestDataByReference(e)}applyDiff(e){this.current?.tests.apply(e)}createObserverData(){const e=new dw({asCanonicalUri:t=>t});return this.proxy.$subscribeToDiffs(),{observers:0,tests:e}}}const ki=(a,e,t,i)=>{t?Object.assign(t,i):e.$updateTestRunConfig(a.controllerId,a.profileId,i)};class au extends $l{#e;#t;#i;#s;#n;get label(){return this._label}set label(e){e!==this._label&&(this._label=e,ki(this,this.#e,this.#s,{label:e}))}get supportsContinuousRun(){return this._supportsContinuousRun}set supportsContinuousRun(e){e!==this._supportsContinuousRun&&(this._supportsContinuousRun=e,ki(this,this.#e,this.#s,{supportsContinuousRun:e}))}get isDefault(){return this.#t.has(this.profileId)}set isDefault(e){e!==this.isDefault&&(e?this.#t.add(this.profileId):this.#t.delete(this.profileId),ki(this,this.#e,this.#s,{isDefault:e}))}get tag(){return this._tag}set tag(e){e?.id!==this._tag?.id&&(this._tag=e,ki(this,this.#e,this.#s,{tag:e?ts.namespace(this.controllerId,e.id):null}))}get configureHandler(){return this._configureHandler}set configureHandler(e){e!==this._configureHandler&&(this._configureHandler=e,ki(this,this.#e,this.#s,{hasConfigurationHandler:!!e}))}get onDidChangeDefault(){return Ee.chain(this.#i,e=>e.map(t=>t.get(this.controllerId)?.get(this.profileId)).filter(Mi))}constructor(e,t,i,s,r,n,o,c,d,h=!1,f=void 0,m=!1){super(r,n,c),this._label=o,this.runHandler=d,this._tag=f,this._supportsContinuousRun=m,this.#e=e,this.#n=t,this.#t=i,this.#i=s,t.set(n,this);const l=Oa.from(c);h&&i.add(n),this.#s={profileId:n,controllerId:r,tag:f?ts.namespace(this.controllerId,f.id):null,label:o,group:l,isDefault:h,hasConfigurationHandler:!1,supportsContinuousRun:m},queueMicrotask(()=>{this.#s&&(this.#e.$publishTestRunProfile(this.#s),this.#s=void 0)})}dispose(){this.#n?.delete(this.profileId)&&(this.#n=void 0,this.#e.$removeTestProfile(this.controllerId,this.profileId)),this.#s=void 0}}function hw(a,e){for(let t=0;t<a.path.length;t++){const i=e.find(s=>s.id===a.path[t]);if(!i)return;if(t===a.path.length-1)return i;e=i.children}}const Za=Y("IExtHostVariableResolverProvider");class uw extends cy{constructor(e,t,i,s,r,n,o){function c(){if(i){const d=i.activeEditor();if(d)return d.document.uri;const h=s.tabGroups.all.find(f=>f.isActive)?.activeTab;if(h!==void 0){if(h.input instanceof rr||h.input instanceof $a)return h.input.modified;if(h.input instanceof Fa||h.input instanceof Ma||h.input instanceof Ha)return h.input.uri}}}super({getFolderUri:d=>{const h=n.folders.filter(f=>f.name===d);if(h&&h.length>0)return h[0].uri},getWorkspaceFolderCount:()=>n.folders.length,getConfigurationValue:(d,h)=>r.getConfiguration(void 0,d).get(h),getAppRoot:()=>Qp(),getExecPath:()=>Rc.VSCODE_EXEC_PATH,getFilePath:()=>{const d=c();if(d)return bn(d.fsPath)},getWorkspaceFolderPathForFile:()=>{if(t){const d=c();if(d){const h=t.getWorkspaceFolder(d);if(h)return bn(h.uri.fsPath)}}},getSelectedText:()=>{if(i){const d=i.activeEditor();if(d&&!d.selection.isEmpty)return d.document.getText(d.selection)}},getLineNumber:()=>{if(i){const d=i.activeEditor();if(d)return String(d.selection.end.line+1)}},getColumnNumber:()=>{if(i){const d=i.activeEditor();if(d)return String(d.selection.end.character+1)}},getExtension:d=>e.getExtension(d)},void 0,o?Promise.resolve(o):void 0,Promise.resolve(Rc))}}let Qo=class extends Z{constructor(e,t,i,s,r){super(),this.extensionService=e,this.workspaceService=t,this.editorService=i,this.configurationService=s,this.editorTabs=r,this._resolver=new Bi(async()=>{const n=await this.configurationService.getConfigProvider(),c={folders:await this.workspaceService.getWorkspaceFolders2()||[]};return this._register(this.workspaceService.onDidChangeWorkspace(async d=>{c.folders=await this.workspaceService.getWorkspaceFolders2()||[]})),new uw(this.extensionService,this.workspaceService,this.editorService,this.editorTabs,n,c,this.homeDir())})}getResolver(){return this._resolver.value}homeDir(){}};Qo=L([E(0,qt),E(1,rt),E(2,xi),E(3,nt),E(4,ls)],Qo);const cu=Y("IExtHostDebugService");let Jo=class extends Z{get onDidStartDebugSession(){return this._onDidStartDebugSession.event}get onDidTerminateDebugSession(){return this._onDidTerminateDebugSession.event}get onDidChangeActiveDebugSession(){return this._onDidChangeActiveDebugSession.event}get activeDebugSession(){return this._activeDebugSession?.api}get onDidReceiveDebugSessionCustomEvent(){return this._onDidReceiveDebugSessionCustomEvent.event}get activeDebugConsole(){return this._activeDebugConsole.value}constructor(e,t,i,s,r,n,o,c){super(),this._workspaceService=t,this._extensionService=i,this._configurationService=s,this._editorTabs=r,this._variableResolver=n,this._commands=o,this._testing=c,this._debugSessions=new Map,this._debugVisualizationTreeItemIdsCounter=0,this._debugVisualizationProviders=new Map,this._debugVisualizationTrees=new Map,this._debugVisualizationTreeItemIds=new WeakMap,this._debugVisualizationElements=new Map,this._visualizers=new Map,this._visualizerIdCounter=0,this._configProviderHandleCounter=0,this._configProviders=[],this._adapterFactoryHandleCounter=0,this._adapterFactories=[],this._trackerFactoryHandleCounter=0,this._trackerFactories=[],this._debugAdapters=new Map,this._debugAdaptersTrackers=new Map,this._onDidStartDebugSession=this._register(new D),this._onDidTerminateDebugSession=this._register(new D),this._onDidChangeActiveDebugSession=this._register(new D),this._onDidReceiveDebugSessionCustomEvent=this._register(new D),this._debugServiceProxy=e.getProxy(k.MainThreadDebugService),this._onDidChangeBreakpoints=this._register(new D),this._onDidChangeActiveStackItem=this._register(new D),this._activeDebugConsole=new fw(this._debugServiceProxy),this._breakpoints=new Map,this._extensionService.getExtensionRegistry().then(d=>{this._register(d.onDidChange(h=>{this.registerAllDebugTypes(d)})),this.registerAllDebugTypes(d)}),this._telemetryProxy=e.getProxy(k.MainThreadTelemetry)}async $getVisualizerTreeItem(e,t){const i=this.hydrateVisualizationContext(t);if(!i)return;const s=await this._debugVisualizationTrees.get(e)?.getTreeItem?.(i);return s?this.convertVisualizerTreeItem(e,s):void 0}registerDebugVisualizationTree(e,t,i){const s=me.toKey(e.identifier),r=this.extensionVisKey(s,t);if(this._debugVisualizationProviders.has(r))throw new Error(`A debug visualization provider with id '${t}' is already registered`);return this._debugVisualizationTrees.set(r,i),this._debugServiceProxy.$registerDebugVisualizerTree(r,!!i.editItem),V(()=>{this._debugServiceProxy.$unregisterDebugVisualizerTree(r),this._debugVisualizationTrees.delete(t)})}async $getVisualizerTreeItemChildren(e,t){const i=this._debugVisualizationElements.get(t)?.item;return i?(await this._debugVisualizationTrees.get(e)?.getChildren?.(i))?.map(r=>this.convertVisualizerTreeItem(e,r))||[]:[]}async $editVisualizerTreeItem(e,t){const i=this._debugVisualizationElements.get(e);if(!i)return;const s=await this._debugVisualizationTrees.get(i.provider)?.editItem?.(i.item,t);return this.convertVisualizerTreeItem(i.provider,s||i.item)}$disposeVisualizedTree(e){const t=this._debugVisualizationElements.get(e);if(!t)return;const i=[t.children];for(const s of i)if(s)for(const r of s)i.push(this._debugVisualizationElements.get(r)?.children),this._debugVisualizationElements.delete(r)}convertVisualizerTreeItem(e,t){let i=this._debugVisualizationTreeItemIds.get(t);return i||(i=this._debugVisualizationTreeItemIdsCounter++,this._debugVisualizationTreeItemIds.set(t,i),this._debugVisualizationElements.set(i,{provider:e,item:t})),hg.from(t,i)}asDebugSourceUri(e,t){const i=e;if(typeof i.sourceReference=="number"&&i.sourceReference>0){let s=`debug:${encodeURIComponent(i.path||"")}`,r="?";return t&&(s+=`${r}session=${encodeURIComponent(t.id)}`,r="&"),s+=`${r}ref=${i.sourceReference}`,v.parse(s)}else{if(i.path)return v.file(i.path);throw new Error("cannot create uri from DAP 'source' object; properties 'path' and 'sourceReference' are both missing.")}}registerAllDebugTypes(e){const t=[];for(const i of e.getAllExtensionDescriptions())if(i.contributes){const s=i.contributes.debuggers;if(s&&s.length>0)for(const r of s)ug(r)&&t.push(r.type)}this._debugServiceProxy.$registerDebugTypes(t)}get activeStackItem(){return this._activeStackItem}get onDidChangeActiveStackItem(){return this._onDidChangeActiveStackItem.event}get onDidChangeBreakpoints(){return this._onDidChangeBreakpoints.event}get breakpoints(){const e=[];return this._breakpoints.forEach(t=>e.push(t)),e}async $resolveDebugVisualizer(e,t){const i=this._visualizers.get(e);if(!i)throw new Error(`No debug visualizer found with id '${e}'`);let{v:s,provider:r,extensionId:n}=i;if(s.visualization||(s=await r.resolveDebugVisualization?.(s,t)||s,i.v=s),!s.visualization)throw new Error(`No visualization returned from resolveDebugVisualization in '${r}'`);return this.serializeVisualization(n,s.visualization)}async $executeDebugVisualizerCommand(e){const t=this._visualizers.get(e);if(!t)throw new Error(`No debug visualizer found with id '${e}'`);const i=t.v.visualization;i&&"command"in i&&this._commands.executeCommand(i.command,...i.arguments||[])}hydrateVisualizationContext(e){const t=this._debugSessions.get(e.sessionId);return t&&{session:t.api,variable:e.variable,containerId:e.containerId,frameId:e.frameId,threadId:e.threadId}}async $provideDebugVisualizers(e,t,i,s){const r=this.hydrateVisualizationContext(i),n=this.extensionVisKey(e,t),o=this._debugVisualizationProviders.get(n);if(!r||!o)return[];const c=await o.provideDebugVisualization(r,s);return c?c.map(d=>{const h=++this._visualizerIdCounter;this._visualizers.set(h,{v:d,provider:o,extensionId:e});const f=d.iconPath?this.getIconPathOrClass(d.iconPath):void 0;return{id:h,name:d.name,iconClass:f?.iconClass,iconPath:f?.iconPath,visualization:this.serializeVisualization(e,d.visualization)}}):[]}$disposeDebugVisualizers(e){for(const t of e)this._visualizers.delete(t)}registerDebugVisualizationProvider(e,t,i){if(!e.contributes?.debugVisualizers?.some(n=>n.id===t))throw new Error(`Extensions may only call registerDebugVisualizationProvider() for renderers they contribute (got ${t})`);const s=me.toKey(e.identifier),r=this.extensionVisKey(s,t);if(this._debugVisualizationProviders.has(r))throw new Error(`A debug visualization provider with id '${t}' is already registered`);return this._debugVisualizationProviders.set(r,i),this._debugServiceProxy.$registerDebugVisualizer(s,t),V(()=>{this._debugServiceProxy.$unregisterDebugVisualizer(s,t),this._debugVisualizationProviders.delete(t)})}addBreakpoints(e){const t=e.filter(r=>{const n=r.id;return this._breakpoints.has(n)?!1:(this._breakpoints.set(n,r),!0)});this.fireBreakpointChanges(t,[],[]);const i=[],s=new Map;for(const r of t)if(r instanceof Fi){let n=s.get(r.location.uri.toString());n||(n={type:"sourceMulti",uri:r.location.uri,lines:[]},s.set(r.location.uri.toString(),n),i.push(n)),n.lines.push({id:r.id,enabled:r.enabled,condition:r.condition,hitCondition:r.hitCondition,logMessage:r.logMessage,line:r.location.range.start.line,character:r.location.range.start.character,mode:r.mode})}else r instanceof Li&&i.push({type:"function",id:r.id,enabled:r.enabled,hitCondition:r.hitCondition,logMessage:r.logMessage,condition:r.condition,functionName:r.functionName,mode:r.mode});return this._debugServiceProxy.$registerBreakpoints(i)}removeBreakpoints(e){const t=e.filter(n=>this._breakpoints.delete(n.id));this.fireBreakpointChanges([],t,[]);const i=t.filter(n=>n instanceof Fi).map(n=>n.id),s=t.filter(n=>n instanceof Li).map(n=>n.id),r=t.filter(n=>n instanceof Xc).map(n=>n.id);return this._debugServiceProxy.$unregisterBreakpoints(i,s,r)}startDebugging(e,t,i){const s=i.testRun&&this._testing.getMetadataForRun(i.testRun);return this._debugServiceProxy.$startDebugging(e?e.uri:void 0,t,{parentSessionID:i.parentSession?i.parentSession.id:void 0,lifecycleManagedByParent:i.lifecycleManagedByParent,repl:i.consoleMode===Gl.MergeWithParent?"mergeWithParent":"separate",noDebug:i.noDebug,compact:i.compact,suppressSaveBeforeStart:i.suppressSaveBeforeStart,testRun:s&&{runId:s.runId,taskId:s.taskId},suppressDebugStatusbar:i.suppressDebugStatusbar??i.debugUI?.simple,suppressDebugToolbar:i.suppressDebugToolbar??i.debugUI?.simple,suppressDebugView:i.suppressDebugView??i.debugUI?.simple})}stopDebugging(e){return this._debugServiceProxy.$stopDebugging(e?e.id:void 0)}registerDebugConfigurationProvider(e,t,i){if(!t)return new W(()=>{});const s=this._configProviderHandleCounter++;return this._configProviders.push({type:e,handle:s,provider:t}),this._debugServiceProxy.$registerDebugConfigurationProvider(e,i,!!t.provideDebugConfigurations,!!t.resolveDebugConfiguration,!!t.resolveDebugConfigurationWithSubstitutedVariables,s),new W(()=>{this._configProviders=this._configProviders.filter(r=>r.provider!==t),this._debugServiceProxy.$unregisterDebugConfigurationProvider(s)})}registerDebugAdapterDescriptorFactory(e,t,i){if(!i)return new W(()=>{});if(!this.definesDebugType(e,t))throw new Error(`a DebugAdapterDescriptorFactory can only be registered from the extension that defines the '${t}' debugger.`);if(this.getAdapterDescriptorFactoryByType(t))throw new Error("a DebugAdapterDescriptorFactory can only be registered once per a type.");const s=this._adapterFactoryHandleCounter++;return this._adapterFactories.push({type:t,handle:s,factory:i}),this._debugServiceProxy.$registerDebugAdapterDescriptorFactory(t,s),new W(()=>{this._adapterFactories=this._adapterFactories.filter(r=>r.factory!==i),this._debugServiceProxy.$unregisterDebugAdapterDescriptorFactory(s)})}registerDebugAdapterTrackerFactory(e,t){if(!t)return new W(()=>{});const i=this._trackerFactoryHandleCounter++;return this._trackerFactories.push({type:e,handle:i,factory:t}),new W(()=>{this._trackerFactories=this._trackerFactories.filter(s=>s.factory!==t)})}async $runInTerminal(e,t){return Promise.resolve(void 0)}async $substituteVariables(e,t){let i;const s=await this.getFolder(e);return s&&(i={uri:s.uri,name:s.name,index:s.index,toResource:()=>{throw new Error("Not implemented")}}),(await this._variableResolver.getResolver()).resolveAsync(i,t)}createDebugAdapter(e,t){if(e instanceof $n)return new mw(e.implementation)}createSignService(){}async $startDASession(e,t){const i=this,s=await this.getSession(t);return this.getAdapterDescriptor(this.getAdapterDescriptorFactoryByType(s.type),s).then(r=>{if(!r)throw new Error(`Couldn't find a debug adapter descriptor for debug type '${s.type}' (extension might have failed to activate)`);const n=this.createDebugAdapter(r,s);if(!n)throw new Error(`Couldn't create a debug adapter for type '${s.type}'.`);const o=n;return this._debugAdapters.set(e,o),this.getDebugAdapterTrackers(s).then(c=>(c&&this._debugAdaptersTrackers.set(e,c),o.onMessage(async d=>{if(d.type==="request"&&d.command==="handshake"){const h=d,f={type:"response",seq:0,command:h.command,request_seq:h.seq,success:!0};this._signService||(this._signService=this.createSignService());try{if(this._signService){const m=await this._signService.sign(h.arguments.value);f.body={signature:m},o.sendResponse(f)}else throw new Error("no signer")}catch(m){f.success=!1,f.message=m.message,o.sendResponse(f)}}else{c&&c.onDidSendMessage&&c.onDidSendMessage(d);try{d=pg(d,!0)}catch(h){const f=d.type+"_"+(d.command??d.event??"");throw this._telemetryProxy.$publicLog2("debugProtocolMessageError",{type:f,from:s.type}),h}i._debugServiceProxy.$acceptDAMessage(e,d)}}),o.onError(d=>{c&&c.onError&&c.onError(d),this._debugServiceProxy.$acceptDAError(e,d.name,d.message,d.stack)}),o.onExit(d=>{c&&c.onExit&&c.onExit(d??void 0,void 0),this._debugServiceProxy.$acceptDAExit(e,d??void 0,void 0)}),c&&c.onWillStartSession&&c.onWillStartSession(),o.startSession()))})}$sendDAMessage(e,t){t=fg(t,!1);const i=this._debugAdaptersTrackers.get(e);i&&i.onWillReceiveMessage&&i.onWillReceiveMessage(t),this._debugAdapters.get(e)?.sendMessage(t)}$stopDASession(e){const t=this._debugAdaptersTrackers.get(e);this._debugAdaptersTrackers.delete(e),t&&t.onWillStopSession&&t.onWillStopSession();const i=this._debugAdapters.get(e);return this._debugAdapters.delete(e),i?i.stopSession():Promise.resolve(void 0)}$acceptBreakpointsDelta(e){const t=[],i=[],s=[];if(e.added)for(const r of e.added){const n=r.id;if(n&&!this._breakpoints.has(n)){let o;if(r.type==="function")o=new Li(r.functionName,r.enabled,r.condition,r.hitCondition,r.logMessage,r.mode);else if(r.type==="data")o=new Xc(r.label,r.dataId,r.canPersist,r.enabled,r.hitCondition,r.condition,r.logMessage,r.mode);else{const c=v.revive(r.uri);o=new Fi(new _i(c,new Fe(r.line,r.character)),r.enabled,r.condition,r.hitCondition,r.logMessage,r.mode)}gg(o,n),this._breakpoints.set(n,o),t.push(o)}}if(e.removed)for(const r of e.removed){const n=this._breakpoints.get(r);n&&(this._breakpoints.delete(r),i.push(n))}if(e.changed){for(const r of e.changed)if(r.id){const n=this._breakpoints.get(r.id);if(n){if(n instanceof Li&&r.type==="function"){const o=n;o.enabled=r.enabled,o.condition=r.condition,o.hitCondition=r.hitCondition,o.logMessage=r.logMessage,o.functionName=r.functionName}else if(n instanceof Fi&&r.type==="source"){const o=n;o.enabled=r.enabled,o.condition=r.condition,o.hitCondition=r.hitCondition,o.logMessage=r.logMessage,o.location=new _i(v.revive(r.uri),new Fe(r.line,r.character))}s.push(n)}}}this.fireBreakpointChanges(t,i,s)}async $acceptStackFrameFocus(e){let t;if(e){const i=await this.getSession(e.sessionId);e.kind==="thread"?t=new Ql(i.api,e.threadId):t=new Jl(i.api,e.threadId,e.frameId)}this._activeStackItem=t,this._onDidChangeActiveStackItem.fire(this._activeStackItem)}$provideDebugConfigurations(e,t,i){return xe(async()=>{const s=this.getConfigProviderByHandle(e);if(!s)throw new Error("no DebugConfigurationProvider found");if(!s.provideDebugConfigurations)throw new Error("DebugConfigurationProvider has no method provideDebugConfigurations");const r=await this.getFolder(t);return s.provideDebugConfigurations(r,i)}).then(s=>{if(!s)throw new Error("nothing returned from DebugConfigurationProvider.provideDebugConfigurations");return s})}$resolveDebugConfiguration(e,t,i,s){return xe(async()=>{const r=this.getConfigProviderByHandle(e);if(!r)throw new Error("no DebugConfigurationProvider found");if(!r.resolveDebugConfiguration)throw new Error("DebugConfigurationProvider has no method resolveDebugConfiguration");const n=await this.getFolder(t);return r.resolveDebugConfiguration(n,i,s)})}$resolveDebugConfigurationWithSubstitutedVariables(e,t,i,s){return xe(async()=>{const r=this.getConfigProviderByHandle(e);if(!r)throw new Error("no DebugConfigurationProvider found");if(!r.resolveDebugConfigurationWithSubstitutedVariables)throw new Error("DebugConfigurationProvider has no method resolveDebugConfigurationWithSubstitutedVariables");const n=await this.getFolder(t);return r.resolveDebugConfigurationWithSubstitutedVariables(n,i,s)})}async $provideDebugAdapter(e,t){const i=this.getAdapterDescriptorFactoryByHandle(e);if(!i)return Promise.reject(new Error("no adapter descriptor factory found for handle"));const s=await this.getSession(t);return this.getAdapterDescriptor(i,s).then(r=>{if(!r)throw new Error(`Couldn't find a debug adapter descriptor for debug type '${s.type}'`);return this.convertToDto(r)})}async $acceptDebugSessionStarted(e){const t=await this.getSession(e);this._onDidStartDebugSession.fire(t.api)}async $acceptDebugSessionTerminated(e){const t=await this.getSession(e);t&&(this._onDidTerminateDebugSession.fire(t.api),this._debugSessions.delete(t.id))}async $acceptDebugSessionActiveChanged(e){this._activeDebugSession=e?await this.getSession(e):void 0,this._onDidChangeActiveDebugSession.fire(this._activeDebugSession?.api)}async $acceptDebugSessionNameChanged(e,t){(await this.getSession(e))?._acceptNameChanged(t)}async $acceptDebugSessionCustomEvent(e,t){const s={session:(await this.getSession(e)).api,event:t.event,body:t.body};this._onDidReceiveDebugSessionCustomEvent.fire(s)}convertToDto(e){if(e instanceof Xl)return this.convertExecutableToDto(e);if(e instanceof Mn)return this.convertServerToDto(e);if(e instanceof Yl)return this.convertPipeServerToDto(e);if(e instanceof $n)return this.convertImplementationToDto(e);throw new Error("convertToDto unexpected type")}convertExecutableToDto(e){return{type:"executable",command:e.command,args:e.args,options:e.options}}convertServerToDto(e){return{type:"server",port:e.port,host:e.host}}convertPipeServerToDto(e){return{type:"pipeServer",path:e.path}}convertImplementationToDto(e){return{type:"implementation"}}getAdapterDescriptorFactoryByType(e){const t=this._adapterFactories.filter(i=>i.type===e);if(t.length>0)return t[0].factory}getAdapterDescriptorFactoryByHandle(e){const t=this._adapterFactories.filter(i=>i.handle===e);if(t.length>0)return t[0].factory}getConfigProviderByHandle(e){const t=this._configProviders.filter(i=>i.handle===e);if(t.length>0)return t[0].provider}definesDebugType(e,t){if(e.contributes){const i=e.contributes.debuggers;if(i&&i.length>0){for(const s of i)if(s.label&&s.type&&s.type===t)return!0}}return!1}getDebugAdapterTrackers(e){const i=e.configuration.type,s=this._trackerFactories.filter(r=>r.type===i||r.type==="*").map(r=>xe(()=>r.factory.createDebugAdapterTracker(e.api)).then(n=>n,n=>null));return Promise.race([Promise.all(s).then(r=>{const n=Re(r);if(n.length>0)return new gw(n)}),new Promise(r=>setTimeout(()=>r(void 0),1e3))]).catch(r=>{})}async getAdapterDescriptor(e,t){const i=t.configuration.debugServer;if(typeof i=="number")return Promise.resolve(new Mn(i));if(e){const r=await this._extensionService.getExtensionRegistry();return xe(()=>e.createDebugAdapterDescriptor(t.api,this.daExecutableFromPackage(t,r))).then(n=>{if(n)return n})}const s=await this._extensionService.getExtensionRegistry();return Promise.resolve(this.daExecutableFromPackage(t,s))}daExecutableFromPackage(e,t){}fireBreakpointChanges(e,t,i){(e.length>0||t.length>0||i.length>0)&&this._onDidChangeBreakpoints.fire(Object.freeze({added:e,removed:t,changed:i}))}async getSession(e){if(e)if(typeof e=="string"){const t=this._debugSessions.get(e);if(t)return t}else{let t=this._debugSessions.get(e.id);if(!t){const i=await this.getFolder(e.folderUri),s=e.parent?this._debugSessions.get(e.parent):void 0;t=new pw(this._debugServiceProxy,e.id,e.type,e.name,i,e.configuration,s?.api),this._debugSessions.set(t.id,t),this._debugServiceProxy.$sessionCached(t.id)}return t}throw new Error("cannot find session")}getFolder(e){if(e){const t=v.revive(e);return this._workspaceService.resolveWorkspaceFolder(t)}return Promise.resolve(void 0)}extensionVisKey(e,t){return`${e}\0${t}`}serializeVisualization(e,t){if(t){if("title"in t&&"command"in t)return{type:Yc.Command};if("treeId"in t)return{type:Yc.Tree,id:`${e}\0${t.treeId}`};throw new Error("Unsupported debug visualization type")}}getIconPathOrClass(e){const t=this.getIconUris(e);let i,s;return"id"in t?s=as.asClassName(t):i=t,{iconPath:i,iconClass:s}}getIconUris(e){if(e instanceof Et)return{id:e.id};const t=typeof e=="object"&&"dark"in e?e.dark:e,i=typeof e=="object"&&"light"in e?e.light:e;return{dark:typeof t=="string"?v.file(t):t,light:typeof i=="string"?v.file(i):i}}};Jo=L([E(0,q),E(1,rt),E(2,qt),E(3,nt),E(4,ls),E(5,Za),E(6,jt),E(7,Rr)],Jo);class pw{constructor(e,t,i,s,r,n,o){this._debugServiceProxy=e,this._id=t,this._type=i,this._name=s,this._workspaceFolder=r,this._configuration=n,this._parentSession=o}get api(){const e=this;return this.apiSession??=Object.freeze({id:e._id,type:e._type,get name(){return e._name},set name(t){e._name=t,e._debugServiceProxy.$setDebugSessionName(e._id,t)},parentSession:e._parentSession,workspaceFolder:e._workspaceFolder,configuration:e._configuration,customRequest(t,i){return e._debugServiceProxy.$customDebugAdapterRequest(e._id,t,i)},getDebugProtocolBreakpoint(t){return e._debugServiceProxy.$getDebugProtocolBreakpoint(e._id,t.id)}})}get id(){return this._id}get type(){return this._type}_acceptNameChanged(e){this._name=e}get configuration(){return this._configuration}}class fw{constructor(e){this.value=Object.freeze({append(t){e.$appendDebugConsole(t)},appendLine(t){this.append(t+`
`)}})}}class gw{constructor(e){this.trackers=e}onWillStartSession(){this.trackers.forEach(e=>e.onWillStartSession?e.onWillStartSession():void 0)}onWillReceiveMessage(e){this.trackers.forEach(t=>t.onWillReceiveMessage?t.onWillReceiveMessage(e):void 0)}onDidSendMessage(e){this.trackers.forEach(t=>t.onDidSendMessage?t.onDidSendMessage(e):void 0)}onWillStopSession(){this.trackers.forEach(e=>e.onWillStopSession?e.onWillStopSession():void 0)}onError(e){this.trackers.forEach(t=>t.onError?t.onError(e):void 0)}onExit(e,t){this.trackers.forEach(i=>i.onExit?i.onExit(e,t):void 0)}}class mw extends mg{constructor(e){super(),this.implementation=e,e.onDidSendMessage(t=>{this.acceptMessage(t)})}startSession(){return Promise.resolve(void 0)}sendMessage(e){this.implementation.handleMessage(e)}stopSession(){return this.implementation.dispose(),Promise.resolve(void 0)}}let Xo=class extends Jo{constructor(e,t,i,s,r,n,o,c){super(e,t,i,s,r,n,o,c)}};Xo=L([E(0,q),E(1,rt),E(2,qt),E(3,nt),E(4,ls),E(5,Za),E(6,jt),E(7,Rr)],Xo);function _w(a){return"uri"in a&&"ranges"in a&&"preview"in a}function vw(a){return a.folderOptions.map(e=>({folder:e.folder,excludes:e.excludes.map(t=>typeof t=="string"?t:t.pattern),includes:e.includes,useGlobalIgnoreFiles:e.useIgnoreFiles.global,useIgnoreFiles:e.useIgnoreFiles.local,useParentIgnoreFiles:e.useIgnoreFiles.parent,followSymlinks:e.followSymlinks,maxResults:a.maxResults,session:a.session}))}class du{constructor(e){this.provider=e}provideFileSearchResults(e,t,i){return(async()=>{const r=vw(t);return Promise.all(r.map(n=>this.provider.provideFileSearchResults({pattern:e},n,i)))})().then(r=>Re(r).flat())}}function yw(a){return a.folderOptions.map(e=>({folder:e.folder,excludes:e.excludes.map(t=>typeof t=="string"?t:t.pattern),includes:e.includes,useGlobalIgnoreFiles:e.useIgnoreFiles.global,useIgnoreFiles:e.useIgnoreFiles.local,useParentIgnoreFiles:e.useIgnoreFiles.parent,followSymlinks:e.followSymlinks,maxResults:a.maxResults,previewOptions:ww(a.previewOptions),maxFileSize:a.maxFileSize,encoding:e.encoding,afterContext:a.surroundingContext,beforeContext:a.surroundingContext}))}function ww(a){return{matchLines:a?.matchLines??Hn.matchLines,charsPerLine:a?.charsPerLine??Hn.charsPerLine}}function xw(a){if(_w(a)){const e=Ge(a.ranges).map((t,i)=>{const r=Ge(a.preview.matches)[i];return{sourceRange:t,previewRange:r}});return new _t(a.uri,e,a.preview.text)}else return new ka(a.uri,a.text,a.lineNumber)}class bw{constructor(e){this.provider=e}provideTextSearchResults(e,t,i,s){const r=c=>{Ew(c)&&i.report(xw(c))};return(async()=>Re(await Promise.all(yw(t).map(c=>this.provider.provideTextSearchResults(e,c,{report:d=>r(d)},s)))).reduce((c,d)=>({limitHit:c.limitHit||d.limitHit}),{limitHit:!1}))().then(c=>({limitHit:c.limitHit,message:Re(Ge(c.message))}))}}function Ew(a){if(Sw(a)){if(Array.isArray(a.ranges)){if(!Array.isArray(a.preview.matches))return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same type."),!1;if(a.preview.matches.length!==a.ranges.length)return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same length."),!1}else if(Array.isArray(a.preview.matches))return console.warn("INVALID - A text search provider match's`ranges` and`matches` properties must have the same length."),!1}return!0}function Sw(a){return!!a.preview}class lu extends xa{constructor(e,t,i=()=>!1){const s=new Jp(i,()=>!1);super(s);const r=new et;e.forEach((n,o)=>{const c=n.folder.with({query:"",fragment:""});r.has(c)?r.get(c).push({fq:n,i:o}):r.set(c,[{fq:n,i:o}])}),r.forEach((n,o)=>{const c=new Map;for(const d of n){const h=t(d.fq,d.i);c.set(this.encodeKey(d.fq.folder),h)}super.set(o,c)})}findQueryFragmentAwareSubstr(e){const t=super.findSubstr(e.with({query:"",fragment:""}));if(!t)return;const i=this.encodeKey(e);return t.get(i)}forEachFolderQueryInfo(e){return this.forEach(t=>t.forEach(i=>e(i)))}encodeKey(e){let t="";return e.query&&(t+=e.query),e.fragment&&(t+="#"+e.fragment),t}}class Cw{constructor(e,t,i){this.config=e,this.provider=t,this.sessionLifecycle=i,this.isLimitHit=!1,this.resultCount=0,this.isCanceled=!1,this.filePattern=e.filePattern,this.includePattern=e.includePattern&&En(e.includePattern),this.maxResults=e.maxResults||void 0,this.exists=e.exists,this.activeCancellationTokens=new Set,this.globalExcludePattern=e.excludePattern&&En(e.excludePattern)}cancel(){this.isCanceled=!0,this.activeCancellationTokens.forEach(e=>e.cancel()),this.activeCancellationTokens=new Set}search(e){const t=this.config.folderQueries||[];return new Promise((i,s)=>{const r=n=>{this.resultCount++,e(n)};if(this.isCanceled)return i({limitHit:this.isLimitHit});this.config.extraFileResources&&this.config.extraFileResources.forEach(n=>{const o=n.toString(),c=Hi(o);this.globalExcludePattern&&this.globalExcludePattern(o,c)||this.matchFile(r,{base:n,basename:c})}),this.doSearch(t,r).then(n=>{i({limitHit:this.isLimitHit,stats:n||void 0})},n=>{s(new Error(br(n)))})})}async doSearch(e,t){const i=new he,s=e.map(h=>this.getSearchOptionsForFolder(h)),r=this.provider instanceof du?this.sessionLifecycle?.tokenSource.token:this.sessionLifecycle?.obj,n={folderOptions:s,maxResults:this.config.maxResults??Zl,session:r},o=h=>{const f=new th(this.config,h),m=!f.hasSiblingExcludeClauses();return{queryTester:f,noSiblingsClauses:m,folder:h.folder,tree:this.initDirectoryTree()}},c=new lu(e,o);let d;try{this.activeCancellationTokens.add(i),d=ui.create();const h=await this.provider.provideFileSearchResults(this.config.filePattern||"",n,i.token),f=d.elapsed(),m=ui.create();return this.isCanceled&&!this.isLimitHit||(h&&h.forEach(l=>{const p=c.findQueryFragmentAwareSubstr(l),_=Xp.relative(p.folder.path,l.path);if(p.noSiblingsClauses){const x=Hi(l.path);this.matchFile(t,{base:p.folder,relativePath:_,basename:x});return}this.addDirectoryEntries(p.tree,p.folder,_,t)}),this.isCanceled&&!this.isLimitHit)?null:(c.forEachFolderQueryInfo(l=>{this.matchDirectoryTree(l.tree,l.queryTester,t)}),{providerTime:f,postProcessTime:m.elapsed()})}finally{i.dispose(),this.activeCancellationTokens.delete(i)}}getSearchOptionsForFolder(e){const t=ci(this.config.includePattern,e.includePattern);let i=e.excludePattern?.map(r=>({folder:r.folder,patterns:ci(this.config.excludePattern,r.pattern)}));i?.length||(i=[{folder:void 0,patterns:ci(this.config.excludePattern,void 0)}]);const s=eh(i);return{folder:e.folder,excludes:s,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks}}initDirectoryTree(){const e={rootEntries:[],pathToEntries:Object.create(null)};return e.pathToEntries["."]=e.rootEntries,e}addDirectoryEntries({pathToEntries:e},t,i,s){if(i===this.filePattern){const n=Hi(this.filePattern);this.matchFile(s,{base:t,relativePath:this.filePattern,basename:n})}function r(n){const o=Hi(n),c=vl(n);let d=e[c];d||(d=e[c]=[],r(c)),d.push({base:t,relativePath:n,basename:o})}r(i)}matchDirectoryTree({rootEntries:e,pathToEntries:t},i,s){const r=this,n=this.filePattern;function o(c){const d=_g(()=>c.map(h=>h.basename));for(let h=0,f=c.length;h<f;h++){const m=c[h],{relativePath:l,basename:p}=m;if(i.matchesExcludesSync(l,p,n!==p?d:void 0))continue;const _=t[l];if(_)o(_);else{if(l===n)continue;r.matchFile(s,m)}if(r.isLimitHit)break}}o(e)}matchFile(e,t){(!this.includePattern||t.relativePath&&this.includePattern(t.relativePath,t.basename))&&((this.exists||this.maxResults&&this.resultCount>=this.maxResults)&&(this.isLimitHit=!0,this.cancel()),this.isLimitHit||e(t))}}class Dw{constructor(){this._obj=new Object,this.tokenSource=new he}get obj(){if(this._obj)return this._obj;throw new Error("Session object has been dereferenced.")}cancel(){this.tokenSource.cancel(),this._obj=void 0}}class ec{constructor(){this.sessions=new Map}static{this.BATCH_SIZE=512}fileSearch(e,t,i,s){const r=this.getSessionTokenSource(e.cacheKey),n=new Cw(e,t,r);let o=0;const c=d=>{o+=d.length,i(d.map(h=>this.rawMatchToSearchItem(h)))};return this.doSearch(n,ec.BATCH_SIZE,c,s).then(d=>({limitHit:d.limitHit,stats:d.stats?{fromCache:!1,type:"fileSearchProvider",resultCount:o,detailStats:d.stats}:void 0,messages:[]}))}clearCache(e){this.sessions.get(e)?.cancel(),this.sessions.delete(e)}getSessionTokenSource(e){if(e)return this.sessions.has(e)||this.sessions.set(e,new Dw),this.sessions.get(e)}rawMatchToSearchItem(e){return e.relativePath?{resource:er(e.base,e.relativePath)}:{resource:e.base}}doSearch(e,t,i,s){const r=s.onCancellationRequested(()=>{e.cancel()}),n=c=>{c&&(o.push(c),t>0&&o.length>=t&&(i(o),o=[]))};let o=[];return e.search(n).then(c=>(o.length&&i(o),r.dispose(),c),c=>(o.length&&i(o),r.dispose(),Promise.reject(c)))}}class Ld{constructor(e,t,i){this.queryProviderPair=e,this.fileUtils=t,this.processType=i,this.collector=null,this.isLimitHit=!1,this.resultCount=0}get query(){return this.queryProviderPair.query}search(e,t,i){const s=this.query.folderQueries||[],r=new he(t);return new Promise((n,o)=>{this.collector=new Tw(e);let c=!1;const d=(h,f)=>{if(!(h instanceof Fn)&&!c&&!this.isLimitHit){const m=this.resultSize(h);h instanceof _t&&typeof this.query.maxResults=="number"&&this.resultCount+m>this.query.maxResults&&(this.isLimitHit=!0,c=!0,r.cancel(),h=this.trimResultToSize(h,this.query.maxResults-this.resultCount));const l=this.resultSize(h);this.resultCount+=l;const p=h instanceof _t;(l>0||!p)&&this.collector.add(h,f)}};this.doSearch(s,d,r.token,i).then(h=>{r.dispose(),this.collector.flush(),n({limitHit:this.isLimitHit||h?.limitHit,messages:this.getMessagesFromResults(h),stats:{type:this.processType}})},h=>{r.dispose();const f=br(h);o(new Error(f))})})}getMessagesFromResults(e){return e?.message?Array.isArray(e.message)?e.message:[e.message]:[]}resultSize(e){return e instanceof _t?Array.isArray(e.ranges)?e.ranges.length:1:0}trimResultToSize(e,t){return new _t(e.uri,e.ranges.slice(0,t),e.previewText)}async doSearch(e,t,i,s){const r=new lu(e,(f,m)=>({queryTester:new th(this.query,f),folder:f.folder,folderIdx:m}),()=>!0),n=[],o={report:f=>{if(f instanceof Fn)s?.(f);else{if(f.uri===void 0)throw Error("Text search result URI is undefined. Please check provider implementation.");const m=r.findQueryFragmentAwareSubstr(f.uri),l=m.folder.scheme===G.file?vg(()=>this.fileUtils.readdir(wa(f.uri))):void 0,p=_l(m.folder,f.uri);if(p){const _=m.queryTester.includedInQuery(p,Hi(p),l);Yp(_)?n.push(_.then(x=>{x&&t(f,m.folderIdx)})):_&&t(f,m.folderIdx)}}}},d={folderOptions:e.map(f=>this.getSearchOptionsForFolder(f)),maxFileSize:this.query.maxFileSize,maxResults:this.query.maxResults??Zl,previewOptions:this.query.previewOptions??Hn,surroundingContext:this.query.surroundingContext??0};"usePCRE2"in this.query&&(d.usePCRE2=this.query.usePCRE2);let h;return this.queryProviderPair.query.type===ih.aiText?h=await this.queryProviderPair.provider.provideAITextSearchResults(this.queryProviderPair.query.contentPattern,d,o,i):h=await this.queryProviderPair.provider.provideTextSearchResults(Pw(this.queryProviderPair.query.contentPattern),d,o,i),n.length&&await Promise.all(n),h}getSearchOptionsForFolder(e){const t=ci(this.query.includePattern,e.includePattern);let i=e.excludePattern?.map(n=>({folder:n.folder,patterns:ci(this.query.excludePattern,n.pattern)}));(!i||i.length===0)&&(i=[{folder:void 0,patterns:ci(this.query.excludePattern,void 0)}]);const s=eh(i);return{folder:v.from(e.folder),excludes:s,includes:t,useIgnoreFiles:{local:!e.disregardIgnoreFiles,parent:!e.disregardParentIgnoreFiles,global:!e.disregardGlobalIgnoreFiles},followSymlinks:!e.ignoreSymlinks,encoding:(e.fileEncoding&&this.fileUtils.toCanonicalName(e.fileEncoding))??""}}}function Pw(a){return{isCaseSensitive:a.isCaseSensitive||!1,isRegExp:a.isRegExp||!1,isWordMatch:a.isWordMatch||!1,isMultiline:a.isMultiline||!1,pattern:a.pattern}}class Tw{constructor(e){this._onResult=e,this._currentFolderIdx=-1,this._currentFileMatch=null,this._batchedCollector=new fr(512,t=>this.sendItems(t))}add(e,t){this._currentFileMatch&&(this._currentFolderIdx!==t||!Zp(this._currentUri,e.uri))&&(this.pushToCollector(),this._currentFileMatch=null),this._currentFileMatch||(this._currentFolderIdx=t,this._currentFileMatch={resource:e.uri,results:[]}),this._currentFileMatch.results.push(kw(e))}pushToCollector(){const e=this._currentFileMatch&&this._currentFileMatch.results?this._currentFileMatch.results.length:0;this._batchedCollector.addItem(this._currentFileMatch,e)}flush(){this.pushToCollector(),this._batchedCollector.flush()}sendItems(e){this._onResult(e)}}function kw(a){return a instanceof _t?{previewText:a.previewText,rangeLocations:a.ranges.map(e=>({preview:{startLineNumber:e.previewRange.start.line,startColumn:e.previewRange.start.character,endLineNumber:e.previewRange.end.line,endColumn:e.previewRange.end.character},source:{startLineNumber:e.sourceRange.start.line,startColumn:e.sourceRange.start.character,endLineNumber:e.sourceRange.end.line,endColumn:e.sourceRange.end.character}}))}:{text:a.text,lineNumber:a.lineNumber}}class fr{static{this.TIMEOUT=4e3}static{this.START_BATCH_AFTER_COUNT=50}constructor(e,t){this.maxBatchSize=e,this.cb=t,this.totalNumberCompleted=0,this.batch=[],this.batchSize=0}addItem(e,t){e&&this.addItemToBatch(e,t)}addItems(e,t){e&&this.addItemsToBatch(e,t)}addItemToBatch(e,t){this.batch.push(e),this.batchSize+=t,this.onUpdate()}addItemsToBatch(e,t){this.batch=this.batch.concat(e),this.batchSize+=t,this.onUpdate()}onUpdate(){this.totalNumberCompleted<fr.START_BATCH_AFTER_COUNT?this.flush():this.batchSize>=this.maxBatchSize?this.flush():this.timeoutHandle||(this.timeoutHandle=setTimeout(()=>{this.flush()},fr.TIMEOUT))}flush(){this.batchSize&&(this.totalNumberCompleted+=this.batchSize,this.cb(this.batch),this.batch=[],this.batchSize=0,this.timeoutHandle&&(clearTimeout(this.timeoutHandle),this.timeoutHandle=void 0))}}const hu=Y("IExtHostSearch");let Yo=class{constructor(e,t,i){this.extHostRpc=e,this._uriTransformer=t,this._logService=i,this._proxy=this.extHostRpc.getProxy(k.MainThreadSearch),this._handlePool=0,this._textSearchProvider=new Map,this._textSearchUsedSchemes=new Set,this._aiTextSearchProvider=new Map,this._aiTextSearchUsedSchemes=new Set,this._fileSearchProvider=new Map,this._fileSearchUsedSchemes=new Set,this._fileSearchManager=new ec}_transformScheme(e){return this._uriTransformer.transformOutgoingScheme(e)}registerTextSearchProviderOld(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const i=this._handlePool++;return this._textSearchProvider.set(i,new bw(t)),this._proxy.$registerTextSearchProvider(i,this._transformScheme(e)),V(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerTextSearchProvider(e,t){if(this._textSearchUsedSchemes.has(e))throw new Error(`a text search provider for the scheme '${e}' is already registered`);this._textSearchUsedSchemes.add(e);const i=this._handlePool++;return this._textSearchProvider.set(i,t),this._proxy.$registerTextSearchProvider(i,this._transformScheme(e)),V(()=>{this._textSearchUsedSchemes.delete(e),this._textSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerAITextSearchProvider(e,t){if(this._aiTextSearchUsedSchemes.has(e))throw new Error(`an AI text search provider for the scheme '${e}'is already registered`);this._aiTextSearchUsedSchemes.add(e);const i=this._handlePool++;return this._aiTextSearchProvider.set(i,t),this._proxy.$registerAITextSearchProvider(i,this._transformScheme(e)),V(()=>{this._aiTextSearchUsedSchemes.delete(e),this._aiTextSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerFileSearchProviderOld(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const i=this._handlePool++;return this._fileSearchProvider.set(i,new du(t)),this._proxy.$registerFileSearchProvider(i,this._transformScheme(e)),V(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}registerFileSearchProvider(e,t){if(this._fileSearchUsedSchemes.has(e))throw new Error(`a file search provider for the scheme '${e}' is already registered`);this._fileSearchUsedSchemes.add(e);const i=this._handlePool++;return this._fileSearchProvider.set(i,t),this._proxy.$registerFileSearchProvider(i,this._transformScheme(e)),V(()=>{this._fileSearchUsedSchemes.delete(e),this._fileSearchProvider.delete(i),this._proxy.$unregisterProvider(i)})}$provideFileSearchResults(e,t,i,s){const r=sn(i),n=this._fileSearchProvider.get(e);if(n)return this._fileSearchManager.fileSearch(r,n,o=>{this._proxy.$handleFileMatch(e,t,o.map(c=>c.resource))},s);throw new Error("unknown provider: "+e)}async doInternalFileSearchWithCustomCallback(e,t,i){return{messages:[]}}$clearCache(e){return this._fileSearchManager.clearCache(e),Promise.resolve(void 0)}$provideTextSearchResults(e,t,i,s){const r=this._textSearchProvider.get(e);if(!r||!r.provideTextSearchResults)throw new Error(`Unknown Text Search Provider ${e}`);const n=sn(i);return this.createTextSearchManager(n,r).search(c=>this._proxy.$handleTextMatch(e,t,c),s)}$provideAITextSearchResults(e,t,i,s){const r=this._aiTextSearchProvider.get(e);if(!r||!r.provideAITextSearchResults)throw new Error(`Unknown AI Text Search Provider ${e}`);const n=sn(i);return this.createAITextSearchManager(n,r).search(c=>this._proxy.$handleTextMatch(e,t,c),s,c=>this._proxy.$handleKeywordResult(e,t,c))}$enableExtensionHostSearch(){}async $getAIName(e){const t=this._aiTextSearchProvider.get(e);if(!(!t||!t.provideAITextSearchResults))return t.name??"AI"}createTextSearchManager(e,t){return new Ld({query:e,provider:t},{readdir:i=>Promise.resolve([]),toCanonicalName:i=>i},"textSearchProvider")}createAITextSearchManager(e,t){return new Ld({query:e,provider:t},{readdir:i=>Promise.resolve([]),toCanonicalName:i=>i},"aiTextSearchProvider")}};Yo=L([E(0,q),E(1,Dr),E(2,se)],Yo);function sn(a){return{...a,folderQueries:a.folderQueries&&a.folderQueries.map(Iw),extraFileResources:a.extraFileResources&&a.extraFileResources.map(e=>v.revive(e))}}function Iw(a){return qe(a)}let gr=class extends ef{constructor(e,t){super(t.logLevel,t.logsLocation,t.loggers.map(i=>qe(i))),this._proxy=e.getProxy(k.MainThreadLogger)}$setLogLevel(e,t){t?this.setLogLevel(v.revive(t),e):this.setLogLevel(e)}setVisibility(e,t){super.setVisibility(e,t),this._proxy.$setVisibility(e,t)}doCreateLogger(e,t,i){return new Rw(this._proxy,e,t,i)}};gr=L([E(0,q),E(1,_e)],gr);class Rw extends gl{constructor(e,t,i,s){super(s?.logLevel==="always"),this.proxy=e,this.file=t,this.isLoggerCreated=!1,this.buffer=[],this.setLevel(i),this.proxy.$createLogger(t,s).then(()=>{this.doLog(this.buffer),this.isLoggerCreated=!0})}log(e,t){const i=[[e,t]];this.isLoggerCreated?this.doLog(i):this.buffer.push(...i)}doLog(e){this.proxy.$log(this.file,e)}flush(){this.proxy.$flush(this.file)}}const uu=Y("IExtHostTerminalShellIntegration");let Zo=class extends Z{constructor(e,t){super(),this._extHostTerminalService=t,this._activeShellIntegrations=new Map,this._onDidChangeTerminalShellIntegration=new D,this.onDidChangeTerminalShellIntegration=this._onDidChangeTerminalShellIntegration.event,this._onDidStartTerminalShellExecution=new D,this.onDidStartTerminalShellExecution=this._onDidStartTerminalShellExecution.event,this._onDidEndTerminalShellExecution=new D,this.onDidEndTerminalShellExecution=this._onDidEndTerminalShellExecution.event,this._proxy=e.getProxy(k.MainThreadTerminalShellIntegration),this._register(V(()=>{for(const[i,s]of this._activeShellIntegrations)s.dispose();this._activeShellIntegrations.clear()}))}$shellIntegrationChange(e){const t=this._extHostTerminalService.getTerminalById(e);if(!t)return;const i=t.value;let s=this._activeShellIntegrations.get(e);s||(s=new Aw(t.value,this._onDidStartTerminalShellExecution),this._activeShellIntegrations.set(e,s),s.store.add(t.onWillDispose(()=>this._activeShellIntegrations.get(e)?.dispose())),s.store.add(s.onDidRequestShellExecution(r=>this._proxy.$executeCommand(e,r))),s.store.add(s.onDidRequestEndExecution(r=>this._onDidEndTerminalShellExecution.fire(r))),s.store.add(s.onDidRequestChangeShellIntegration(r=>this._onDidChangeTerminalShellIntegration.fire(r))),t.shellIntegration=s.value),this._onDidChangeTerminalShellIntegration.fire({terminal:i,shellIntegration:s.value})}$shellExecutionStart(e,t,i,s,r){this._activeShellIntegrations.has(e)||this.$shellIntegrationChange(e);const n={value:t,confidence:i,isTrusted:s};this._activeShellIntegrations.get(e)?.startShellExecution(n,v.revive(r))}$shellExecutionEnd(e,t,i,s,r){const n={value:t,confidence:i,isTrusted:s};this._activeShellIntegrations.get(e)?.endShellExecution(n,r)}$shellExecutionData(e,t){this._activeShellIntegrations.get(e)?.emitData(t)}$shellEnvChange(e,t,i,s){this._activeShellIntegrations.get(e)?.setEnv(t,i,s)}$cwdChange(e,t){this._activeShellIntegrations.get(e)?.setCwd(v.revive(t))}$closeTerminal(e){this._activeShellIntegrations.get(e)?.dispose(),this._activeShellIntegrations.delete(e)}};Zo=L([E(0,q),E(1,bi)],Zo);class Aw extends Z{get currentExecution(){return this._currentExecution}constructor(e,t){super(),this._terminal=e,this._onDidStartTerminalShellExecution=t,this._pendingExecutions=[],this.store=this._register(new N),this._onDidRequestChangeShellIntegration=this._register(new D),this.onDidRequestChangeShellIntegration=this._onDidRequestChangeShellIntegration.event,this._onDidRequestShellExecution=this._register(new D),this.onDidRequestShellExecution=this._onDidRequestShellExecution.event,this._onDidRequestEndExecution=this._register(new D),this.onDidRequestEndExecution=this._onDidRequestEndExecution.event,this._onDidRequestNewExecution=this._register(new D),this.onDidRequestNewExecution=this._onDidRequestNewExecution.event;const i=this;this.value={get cwd(){return i._cwd},get env(){if(i._env)return Object.freeze({isTrusted:i._env.isTrusted,value:Object.freeze({...i._env.value})})},executeCommand(s,r){let n=s;if(r)for(const d of r)!d.match(/["'`]/)&&d.match(/\s/)?n+=` "${d}"`:n+=` ${d}`;i._onDidRequestShellExecution.fire(n);const o={value:n,confidence:Ln.High,isTrusted:!0};return i.requestNewShellExecution(o,i._cwd).value}}}requestNewShellExecution(e,t){const i=new Nd(e,t??this._cwd);return Vs(e.value).length>1&&(this._currentExecutionProperties={isMultiLine:!0,unresolvedCommandLines:Vs(e.value)}),this._pendingExecutions.push(i),this._onDidRequestNewExecution.fire(e.value),i}startShellExecution(e,t){if(this._pendingEndingExecution&&(this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._pendingEndingExecution.value,exitCode:void 0}),this._pendingEndingExecution=void 0),this._currentExecution){if(this._currentExecutionProperties?.isMultiLine&&this._currentExecutionProperties.unresolvedCommandLines){const s=Od(this._currentExecutionProperties.unresolvedCommandLines,e);if(s){this._currentExecutionProperties.unresolvedCommandLines=s.unresolvedCommandLines;return}}this._currentExecution.endExecution(void 0),this._currentExecution.flush(),this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._currentExecution.value,exitCode:void 0})}let i;if(e.confidence===Ln.High)for(const[s,r]of this._pendingExecutions.entries())if(r.value.commandLine.value===e.value){i=r,this._currentExecutionProperties={isMultiLine:!1,unresolvedCommandLines:void 0},i=r,this._pendingExecutions.splice(s,1);break}else{const n=Od(Vs(r.value.commandLine.value),e);if(n){this._currentExecutionProperties={isMultiLine:!0,unresolvedCommandLines:n.unresolvedCommandLines},i=r,this._pendingExecutions.splice(s,1);break}}else i=this._pendingExecutions.shift();i||(i=new Nd(e,t??this._cwd)),this._currentExecution=i,this._onDidStartTerminalShellExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:this._currentExecution.value})}emitData(e){this.currentExecution?.emitData(e)}endShellExecution(e,t){if(!(this._currentExecutionProperties?.isMultiLine&&this._currentExecutionProperties.unresolvedCommandLines&&this._currentExecutionProperties.unresolvedCommandLines.length>0)&&this._currentExecution){const i=this._currentExecutionProperties?.isMultiLine?this._currentExecution.value.commandLine:e;this._currentExecution.endExecution(i);const s=this._currentExecution;this._pendingEndingExecution=s,this._currentExecution=void 0,s.flush().then(()=>{this._pendingEndingExecution===s&&(this._onDidRequestEndExecution.fire({terminal:this._terminal,shellIntegration:this.value,execution:s.value,exitCode:t}),this._pendingEndingExecution=void 0)})}}setEnv(e,t,i){const s={};for(let r=0;r<e.length;r++)s[e[r]]=t[r];this._env={value:s,isTrusted:i},this._fireChangeEvent()}setCwd(e){let t=!1;v.isUri(this._cwd)?t=!v.isUri(e)||this._cwd.toString()!==e.toString():this._cwd!==e&&(t=!0),t&&(this._cwd=e,this._fireChangeEvent())}_fireChangeEvent(){this._onDidRequestChangeShellIntegration.fire({terminal:this._terminal,shellIntegration:this.value})}}class Nd{constructor(e,t){this._commandLine=e,this.cwd=t,this._isEnded=!1;const i=this;this.value={get commandLine(){return i._commandLine},get cwd(){return i.cwd},read(){return i._createDataStream()}}}_createDataStream(){if(!this._dataStream){if(this._isEnded)return xr.EMPTY;this._dataStream=new $w}return this._dataStream.createIterable()}emitData(e){this._isEnded||this._dataStream?.emitData(e)}endExecution(e){e&&(this._commandLine=e),this._dataStream?.endExecution(),this._isEnded=!0}async flush(){this._dataStream&&(await this._dataStream.flush(),this._dataStream.dispose(),this._dataStream=void 0)}}class $w extends Z{constructor(){super(...arguments),this._iterables=[],this._emitters=[]}createIterable(){this._barrier||(this._barrier=new mt);const e=this._barrier,t=new xr(async i=>{this._emitters.push(i),await e.wait()});return this._iterables.push(t),t}emitData(e){for(const t of this._emitters)t.emitOne(e)}endExecution(){this._barrier?.open()}async flush(){await Promise.all(this._iterables.map(e=>e.toPromise()))}}function Vs(a){return a.split(`
`).map(e=>e.trim()).filter(e=>e.length>0)}function Od(a,e){if(a.length===0)return!1;const t=[...a],i=Vs(e.value);if(t&&t.length>0){for(;t.length>0&&t[0]===i[0];)t.shift(),i.shift();if(i.length===0)return{unresolvedCommandLines:t}}return!1}var ft;(function(a){a[a.CR=13]="CR",a[a.LF=10]="LF",a[a.COLON=58]="COLON",a[a.SPACE=32]="SPACE"})(ft||(ft={}));class rn{constructor(e){this.dataBuffer="",this.eventTypeBuffer="",this.buffer=[],this.endedOnCR=!1,this.onEventHandler=e,this.decoder=new TextDecoder("utf-8")}getLastEventId(){return this.lastEventIdBuffer}getReconnectionTime(){return this.reconnectionTime}feed(e){if(e.length===0)return;let t=0;for(this.endedOnCR&&e[0]===ft.LF&&t++,this.endedOnCR=!1;t<e.length;){const i=e.indexOf(ft.CR,t),s=e.indexOf(ft.LF,t),r=i===-1?s:s===-1?i:Math.min(i,s);if(r===-1)break;let n="";for(const o of this.buffer)n+=this.decoder.decode(o,{stream:!0});n+=this.decoder.decode(e.subarray(t,r)),this.processLine(n),this.buffer.length=0,t=r+(e[r]===ft.CR&&e[r+1]===ft.LF?2:1)}t<e.length?this.buffer.push(e.subarray(t)):this.endedOnCR=e[e.length-1]===ft.CR}processLine(e){if(!e.length){this.dispatchEvent();return}if(e.startsWith(":"))return;let t,i;const s=e.indexOf(":");s===-1?(t=e,i=""):(t=e.substring(0,s),i=e.substring(s+1),i.startsWith(" ")&&(i=i.substring(1))),this.processField(t,i)}processField(e,t){switch(e){case"event":this.eventTypeBuffer=t;break;case"data":this.dataBuffer+=t,this.dataBuffer+=`
`;break;case"id":t.includes("\0")?this.currentEventId=void 0:this.currentEventId=this.lastEventIdBuffer=t;break;case"retry":/^\d+$/.test(t)&&(this.reconnectionTime=parseInt(t,10));break}}dispatchEvent(){if(this.dataBuffer===""){this.dataBuffer="",this.eventTypeBuffer="";return}this.dataBuffer.endsWith(`
`)&&(this.dataBuffer=this.dataBuffer.substring(0,this.dataBuffer.length-1));const e={type:this.eventTypeBuffer||"message",data:this.dataBuffer};this.currentEventId!==void 0&&(e.id=this.currentEventId),this.reconnectionTime!==void 0&&(e.retry=this.reconnectionTime),this.onEventHandler(e),this.reset()}reset(){this.dataBuffer="",this.eventTypeBuffer="",this.currentEventId=void 0}}const ea=Y("IExtHostMpcService");let ta=class extends Z{constructor(e,t){super(),this._extHostInitData=t,this._initialProviderPromises=new Set,this._sseEventSources=this._register(new Sn),this._unresolvedMcpServers=new Map,this._proxy=e.getProxy(k.MainThreadMcp)}$startMcp(e,t){this._startMcp(e,yg.fromSerialized(t))}_startMcp(e,t){if(t.type===wg.HTTP){this._sseEventSources.set(e,new Mw(e,t,this._proxy));return}throw new Error("not implemented")}$stopMcp(e){this._sseEventSources.has(e)&&(this._sseEventSources.deleteAndDispose(e),this._proxy.$onDidChangeState(e,{state:It.Kind.Stopped}))}$sendMessage(e,t){this._sseEventSources.get(e)?.send(t)}async $waitForInitialCollectionProviders(){await Promise.all(this._initialProviderPromises)}async $resolveMcpLaunch(e,t){const i=this._unresolvedMcpServers.get(e);if(!i)return;const s=i.servers.find(n=>n.label===t);if(!s)return;if(!i.provider.resolveMcpServerDefinition)return Gr.from(s);const r=await i.provider.resolveMcpServerDefinition(s,de.None);return r?Gr.from(r):void 0}registerMcpConfigurationProvider(e,t,i){const s=new N,r=e.contributes?.mcpServerDefinitionProviders?.find(d=>d.id===t);if(!r)throw new Error(`MCP configuration providers must be registered in the contributes.mcpServerDefinitionProviders array within your package.json, but "${t}" was not`);const n={id:xg(e.identifier,t),isTrustedByDefault:!0,label:r?.label??e.displayName??e.name,scope:tf.WORKSPACE,canResolveLaunch:typeof i.resolveMcpServerDefinition=="function",extensionId:e.identifier.value,configTarget:this._extHostInitData.remote.isRemote?At.USER_REMOTE:At.USER},o=async()=>{const d=await i.provideMcpServerDefinitions(de.None);this._unresolvedMcpServers.set(n.id,{servers:d??[],provider:i});const h=[];for(const f of d??[]){let m=me.toKey(e.identifier)+"/"+f.label;if(h.some(l=>l.id===m)){let l=2;for(;h.some(p=>p.id===m+l);)l++;m=m+l}h.push({id:m,label:f.label,cacheNonce:f.version,launch:Gr.from(f)})}this._proxy.$upsertMcpCollection(n,h)};s.add(V(()=>{this._unresolvedMcpServers.delete(n.id),this._proxy.$deleteMcpCollection(n.id)})),i.onDidChangeMcpServerDefinitions&&s.add(i.onDidChangeMcpServerDefinitions(o)),i.onDidChangeServerDefinitions&&s.add(i.onDidChangeServerDefinitions(o)),i.onDidChange&&s.add(i.onDidChange(o));const c=new Promise(d=>{setTimeout(()=>o().finally(()=>{this._initialProviderPromises.delete(c),d()}),0)});return this._initialProviderPromises.add(c),s}};ta=L([E(0,q),E(1,_e)],ta);var Ae;(function(a){a[a.Unknown=0]="Unknown",a[a.Http=1]="Http",a[a.SSE=2]="SSE"})(Ae||(Ae={}));class Mw extends Z{constructor(e,t,i){super(),this._id=e,this._launch=t,this._proxy=i,this._requestSequencer=new sf,this._postEndpoint=new Js,this._mode={value:Ae.Unknown},this._cts=new he,this._abortCtrl=new AbortController,this._register(V(()=>{this._abortCtrl.abort(),this._cts.dispose(!0)})),this._proxy.$onDidChangeState(this._id,{state:It.Kind.Running})}async send(e){try{await this._requestSequencer.queue(()=>this._mode.value===Ae.SSE?this._sendLegacySSE(this._mode.endpoint,e):this._sendStreamableHttp(e,this._mode.value===Ae.Http?this._mode.sessionId:void 0))}catch(t){const i=`Error sending message to ${this._launch.uri}: ${String(t)}`;this._proxy.$onDidChangeState(this._id,{state:It.Kind.Error,message:i})}}async _sendStreamableHttp(e,t){const i=new TextEncoder().encode(e),s={...Object.fromEntries(this._launch.headers),"Content-Type":"application/json","Content-Length":String(i.length),Accept:"text/event-stream, application/json"};t&&(s["Mcp-Session-Id"]=t),await this._addAuthHeader(s);const r=await this._fetchWithAuthRetry(this._launch.uri.toString(!0),{method:"POST",signal:this._abortCtrl.signal,headers:s,body:i},s),n=this._mode.value===Ae.Unknown,o=r.headers.get("Mcp-Session-Id");if(o&&(this._mode={value:Ae.Http,sessionId:o}),this._mode.value===Ae.Unknown&&r.status>=400&&r.status<500&&r.status!==401&&r.status!==403){this._log(We.Info,`${r.status} status sending message to ${this._launch.uri}, will attempt to fall back to legacy SSE`),this._sseFallbackWithMessage(e);return}if(r.status>=300){const c=this._mode.value===Ae.Http&&!!this._mode.sessionId&&(r.status===400||r.status===404);this._proxy.$onDidChangeState(this._id,{state:It.Kind.Error,message:`${r.status} status sending message to ${this._launch.uri}: ${await this._getErrText(r)}`+c?"; will retry with new session ID":"",shouldRetry:c});return}this._mode.value===Ae.Unknown&&(this._mode={value:Ae.Http,sessionId:void 0}),n&&this._attachStreamableBackchannel(),this._handleSuccessfulStreamableHttp(r,e)}async _sseFallbackWithMessage(e){const t=await this._attachSSE();t&&(this._mode={value:Ae.SSE,endpoint:t},await this._sendLegacySSE(t,e))}async _populateAuthMetadata(e){let t;if(e.headers.has("WWW-Authenticate")){const d=e.headers.get("WWW-Authenticate"),{scheme:h,params:f}=Ky(d);h==="Bearer"&&f.resource_metadata&&(t=f.resource_metadata)}let i,s,r;if(t){const d=await this._getResourceMetadata(t);i=d.authorization_servers?.[0],s=d.scopes_supported,r=d}const n=new URL(e.url).origin;let o={};i||(i=n,o={...Object.fromEntries(this._launch.headers)});try{const d=await this._getAuthorizationServerMetadata(i,o),h=jy(d);this._authMetadata={authorizationServer:v.parse(i),serverMetadata:h,resourceMetadata:r};return}catch(d){this._log(We.Warning,`Error populating auth metadata: ${String(d)}`)}const c=zy(new URL(n));c.scopes_supported=s??c.scopes_supported??[],this._authMetadata={authorizationServer:v.parse(i),serverMetadata:c,resourceMetadata:r}}async _getResourceMetadata(e){const t=new URL(e),i=new URL(this._launch.uri.toString(!0));let s={};t.origin===i.origin&&(s={...Object.fromEntries(this._launch.headers)});const r=await fetch(e,{method:"GET",signal:this._abortCtrl.signal,headers:{...s,Accept:"application/json","MCP-Protocol-Version":Qr.LATEST_PROTOCOL_VERSION}});if(r.status!==200)throw new Error(`Failed to fetch resource metadata: ${r.status} ${await this._getErrText(r)}`);const n=await r.json();if(Wy(n))return n;throw new Error(`Invalid resource metadata: ${JSON.stringify(n)}`)}async _getAuthorizationServerMetadata(e,t){const i=new URL(e),s=i.pathname==="/"?"":i.pathname,r=new URL(Uy,e).toString()+s;let n=await fetch(r,{method:"GET",signal:this._abortCtrl.signal,headers:{...t,Accept:"application/json","MCP-Protocol-Version":Qr.LATEST_PROTOCOL_VERSION}});if(n.status!==200&&(n=await fetch(v.joinPath(v.parse(e),".well-known","openid-configuration").toString(!0),{method:"GET",signal:this._abortCtrl.signal,headers:{...t,Accept:"application/json","MCP-Protocol-Version":Qr.LATEST_PROTOCOL_VERSION}}),n.status!==200))throw new Error(`Failed to fetch authorization server metadata: ${n.status} ${await this._getErrText(n)}`);const o=await n.json();if(Vy(o))return o;throw new Error(`Invalid authorization server metadata: ${JSON.stringify(o)}`)}async _handleSuccessfulStreamableHttp(e,t){if(e.status!==202)switch(e.headers.get("Content-Type")?.toLowerCase()){case"text/event-stream":{const i=new rn(s=>{if(s.type==="message")this._proxy.$onDidReceiveMessage(this._id,s.data);else if(s.type==="endpoint")throw this._log(We.Warning,`Received SSE endpoint from a POST to ${this._launch.uri}, will fall back to legacy SSE`),this._sseFallbackWithMessage(t),new gi});try{await this._doSSE(i,e)}catch(s){this._log(We.Warning,`Error reading SSE stream: ${String(s)}`)}break}case"application/json":this._proxy.$onDidReceiveMessage(this._id,await e.text());break;default:{const i=await e.text();Hw(i)?this._proxy.$onDidReceiveMessage(this._id,i):this._log(We.Warning,`Unexpected ${e.status} response for request: ${i}`)}}}async _attachStreamableBackchannel(){let e;for(let t=0;!this._store.isDisposed;t++){await Nt(Math.min(t*1e3,3e4),this._cts.token);let i;try{const r={...Object.fromEntries(this._launch.headers),Accept:"text/event-stream"};await this._addAuthHeader(r),this._mode.value===Ae.Http&&this._mode.sessionId!==void 0&&(r["Mcp-Session-Id"]=this._mode.sessionId),e&&(r["Last-Event-ID"]=e),i=await this._fetchWithAuthRetry(this._launch.uri.toString(!0),{method:"GET",signal:this._abortCtrl.signal,headers:r},r)}catch{this._log(We.Info,`Error connecting to ${this._launch.uri} for async notifications, will retry`);continue}if(i.status>=400){this._log(We.Debug,`${i.status} status connecting to ${this._launch.uri} for async notifications; they will be disabled: ${await this._getErrText(i)}`);return}t=0;const s=new rn(r=>{r.type==="message"&&this._proxy.$onDidReceiveMessage(this._id,r.data),r.id&&(e=r.id)});try{await this._doSSE(s,i)}catch(r){this._log(We.Info,`Error reading from async stream, we will reconnect: ${r}`)}}}async _attachSSE(){const e=new Js,t={...Object.fromEntries(this._launch.headers),Accept:"text/event-stream"};await this._addAuthHeader(t);let i;try{if(i=await this._fetchWithAuthRetry(this._launch.uri.toString(!0),{method:"GET",signal:this._abortCtrl.signal,headers:t},t),i.status>=300){this._proxy.$onDidChangeState(this._id,{state:It.Kind.Error,message:`${i.status} status connecting to ${this._launch.uri} as SSE: ${await this._getErrText(i)}`});return}}catch(r){this._proxy.$onDidChangeState(this._id,{state:It.Kind.Error,message:`Error connecting to ${this._launch.uri} as SSE: ${r}`});return}const s=new rn(r=>{r.type==="message"?this._proxy.$onDidReceiveMessage(this._id,r.data):r.type==="endpoint"&&e.complete(new URL(r.data,this._launch.uri.toString(!0)).toString())});return this._register(V(()=>e.cancel())),this._doSSE(s,i).catch(r=>{this._proxy.$onDidChangeState(this._id,{state:It.Kind.Error,message:`Error reading SSE stream: ${String(r)}`})}),e.p}async _sendLegacySSE(e,t){const i=new TextEncoder().encode(t),s={...Object.fromEntries(this._launch.headers),"Content-Type":"application/json","Content-Length":String(i.length)};await this._addAuthHeader(s);const r=await fetch(e,{method:"POST",signal:this._abortCtrl.signal,headers:s,body:i});r.status>=300&&this._log(We.Warning,`${r.status} status sending message to ${this._postEndpoint}: ${await this._getErrText(r)}`)}async _doSSE(e,t){if(!t.body)return;const i=t.body.getReader();let s;do{try{s=await Da(i.read(),this._cts.token)}catch(r){if(i.cancel(),this._store.isDisposed)return;throw r}s.value&&e.feed(s.value)}while(!s.done)}async _addAuthHeader(e){if(this._authMetadata)try{const t=await this._proxy.$getTokenFromServerMetadata(this._id,this._authMetadata.authorizationServer,this._authMetadata.serverMetadata,this._authMetadata.resourceMetadata);t&&(e.Authorization=`Bearer ${t}`)}catch(t){this._log(We.Warning,`Error getting token from server metadata: ${String(t)}`)}return e}_log(e,t){this._store.isDisposed||this._proxy.$onDidPublishLog(this._id,e,t)}async _getErrText(e){try{return await e.text()}catch{return e.statusText}}async _fetchWithAuthRetry(e,t,i){const s=()=>fetch(e,t);let r=await s();return r.status===401&&(this._authMetadata||(await this._populateAuthMetadata(r),await this._addAuthHeader(i),i.Authorization&&(t.headers=i,r=await s()))),r}}function Hw(a){try{return JSON.parse(a),!0}catch{return!1}}re(Xa,Bo,ne.Delayed);re(St,gr,ne.Delayed);re(ds,Co,ne.Delayed);re(jt,wo,ne.Eager);re(Ir,Oo,ne.Eager);re(Qa,Vo,ne.Eager);re(nt,yo,ne.Eager);re(Cr,go,ne.Eager);re(Rr,Go,ne.Eager);re(cu,Xo,ne.Eager);re(Gh,vo,ne.Eager);re(xi,bo,ne.Eager);re(Ya,zo,ne.Eager);re(wi,dy,ne.Eager);re(qh,mo,ne.Delayed);re(hu,Yo,ne.Eager);re(Ga,Zh,ne.Eager);re(Yh,Ro,ne.Eager);re(bi,So,ne.Eager);re(uu,Zo,ne.Eager);re(Na,bg,ne.Eager);re(Tr,Fo,ne.Eager);re(kr,No,ne.Eager);re(rt,_o,ne.Eager);re(Ja,su,ne.Eager);re(ls,Ao,ne.Eager);re(Za,Qo,ne.Eager);re(ea,ta,ne.Eager);let ia=class extends rf{constructor(e,t,i){const s=i.remote.isRemote?"remoteexthost":e?"workerexthost":"exthost",r=i.remote.isRemote?j(2585,"Extension Host (Remote)"):e?j(2586,"Extension Host (Worker)"):j(2587,"Extension Host");super(t.createLogger(s,{name:r}))}};ia=L([E(1,St),E(2,_e)],ia);class Ud{static async installEarlyHandler(e){Error.stackTraceLimit=100;const t=e.get(se),s=e.get(q).getProxy(k.MainThreadErrors);xn(r=>{t.error(r);const n=Ys(r);s.$onUnexpectedError(n)})}static async installFullHandler(e){const t=e.get(se),i=e.get(q),s=e.get(qt),r=e.get(qa),n=e.get(ds),o=i.getProxy(k.MainThreadExtensionService),c=i.getProxy(k.MainThreadErrors),d=await s.getExtensionRegistry(),h=await s.getExtensionPathIndex(),f=new WeakMap;function m(_,x){if(f.has(_))return f.get(_).stack;let S="",C,T;for(const I of x)S+=`
	at ${I.toString()}`,T=I.getFileName(),!C&&T&&(C=h.findSubstr(v.file(T)));const O=`${_.name||"Error"}: ${_.message||""}${S}`;return f.set(_,{extensionIdentifier:C?.identifier,stack:O}),O}const l=Symbol("prepareStackTrace wrapped");let p=m;Object.defineProperty(Error,"prepareStackTrace",{configurable:!1,get(){return p},set(_){if(_===m||!_||_[l]){p=_||m;return}p=function(x,S){return m(x,S),_.call(Error,x,S)},Object.assign(p,{[l]:!0})}}),xn(_=>{$c.is(_)||t.error(_);const x=Ys(_);let S;if(_ instanceof Dl?S=_.extension:S=f.get(_)?.extensionIdentifier,!!S)if($c.is(_)){const C=d.getExtensionDescription(S);C&&n.report(_.name,C,`${_.message}
 FROM: ${_.stack}`)}else{o.$onExtensionRuntimeError(S,x);const C=r.onExtensionError(S,_);t.trace("forwarded error to extension?",C,S)}}),af.addListener(_=>{c.$onUnexpectedError(_)})}}class pu{constructor(e,t,i,s,r){this._hostUtils=i,this._rpcProtocol=new Eg(e,null,s),t=pu._transform(t,this._rpcProtocol);const n=new El(...nf());n.set(_e,{_serviceBrand:void 0,...t,messagePorts:r}),n.set(q,new Sg(this._rpcProtocol)),n.set(Dr,new hy(s)),n.set(ru,i),n.set(se,new Ac(ia,[!0],!0)),n.set(St,new Ac(gr,[],!0));const o=new of(n,!0);Zs&&o.invokeFunction(Ud.installEarlyHandler),this._logService=o.invokeFunction(c=>c.get(se)),Ve("code/extHost/didCreateServices"),this._hostUtils.pid?this._logService.info(`Extension host with pid ${this._hostUtils.pid} started`):this._logService.info("Extension host started"),this._logService.trace("initData",t),this._extensionService=o.invokeFunction(c=>c.get(qt)),this._extensionService.initialize(),Zs&&o.invokeFunction(Ud.installFullHandler)}async asBrowserUri(e){const t=this._rpcProtocol.getProxy(k.MainThreadExtensionService);return v.revive(await t.$asBrowserUri(e))}async getAllStaticBrowserUris(){return(await this._rpcProtocol.getProxy(k.MainThreadExtensionService).$getAllStaticBrowserUris()).map(([t,i])=>[v.revive(t),v.revive(i)])}terminate(e){this._extensionService.terminate(e)}getExtHostExtensionService(){return this._extensionService}static _transform(e,t){e.extensions.allExtensions.forEach(s=>{s.extensionLocation=v.revive(t.transformIncomingURIs(s.extensionLocation))}),e.environment.appRoot=v.revive(t.transformIncomingURIs(e.environment.appRoot));const i=e.environment.extensionDevelopmentLocationURI;return i&&(e.environment.extensionDevelopmentLocationURI=i.map(s=>v.revive(t.transformIncomingURIs(s)))),e.environment.extensionTestsLocationURI=v.revive(t.transformIncomingURIs(e.environment.extensionTestsLocationURI)),e.environment.globalStorageHome=v.revive(t.transformIncomingURIs(e.environment.globalStorageHome)),e.environment.workspaceStorageHome=v.revive(t.transformIncomingURIs(e.environment.workspaceStorageHome)),e.nlsBaseUrl=v.revive(t.transformIncomingURIs(e.nlsBaseUrl)),e.logsLocation=v.revive(t.transformIncomingURIs(e.logsLocation)),e.workspace=t.transformIncomingURIs(e.workspace),e}}class Fw{constructor(e){this._relatedInformationProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiRelatedInformation)}async $provideAiRelatedInformation(e,t,i){if(this._relatedInformationProviders.size===0)throw new Error("No related information providers registered");const s=this._relatedInformationProviders.get(e);if(!s)throw new Error("related information provider not found");return await s.provideRelatedInformation(t,i)??[]}getRelatedInformation(e,t,i){return this._proxy.$getAiRelatedInformation(t,i)}registerRelatedInformationProvider(e,t,i){const s=this._nextHandle;return this._nextHandle++,this._relatedInformationProviders.set(s,i),this._proxy.$registerAiRelatedInformationProvider(s,t),new W(()=>{this._proxy.$unregisterAiRelatedInformationProvider(s),this._relatedInformationProviders.delete(s)})}}const Lw=[new H("vscode.executeDocumentHighlights","_executeDocumentHighlights","Execute document highlight provider.",[P.Uri,P.Position],new M("A promise that resolves to an array of DocumentHighlight-instances.",Ue(sh.to))),new H("vscode.executeDocumentSymbolProvider","_executeDocumentSymbolProvider","Execute document symbol provider.",[P.Uri],new M("A promise that resolves to an array of SymbolInformation and DocumentSymbol instances.",(a,e)=>{if(Ta(a))return;class t extends hh{constructor(){super(...arguments),this.containerName=""}static to(s){const r=new t(s.name,uh.to(s.kind),s.containerName||"",new _i(e[0],A.to(s.range)));return r.detail=s.detail,r.range=r.location.range,r.selectionRange=A.to(s.selectionRange),r.children=s.children?s.children.map(t.to):[],r}}return a.map(t.to)})),new H("vscode.executeFormatDocumentProvider","_executeFormatDocumentProvider","Execute document format provider.",[P.Uri,new P("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(Ke.to))),new H("vscode.executeFormatRangeProvider","_executeFormatRangeProvider","Execute range format provider.",[P.Uri,P.Range,new P("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(Ke.to))),new H("vscode.executeFormatOnTypeProvider","_executeFormatOnTypeProvider","Execute format on type provider.",[P.Uri,P.Position,new P("ch","Trigger character",a=>typeof a=="string",a=>a),new P("options","Formatting options",a=>!0,a=>a)],new M("A promise that resolves to an array of TextEdits.",Ue(Ke.to))),new H("vscode.executeDefinitionProvider","_executeDefinitionProvider","Execute all definition providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.experimental.executeDefinitionProvider_recursive","_executeDefinitionProvider_recursive","Execute all definition providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.executeTypeDefinitionProvider","_executeTypeDefinitionProvider","Execute all type definition providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.experimental.executeTypeDefinitionProvider_recursive","_executeTypeDefinitionProvider_recursive","Execute all type definition providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.executeDeclarationProvider","_executeDeclarationProvider","Execute all declaration providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.experimental.executeDeclarationProvider_recursive","_executeDeclarationProvider_recursive","Execute all declaration providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.executeImplementationProvider","_executeImplementationProvider","Execute all implementation providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.experimental.executeImplementationProvider_recursive","_executeImplementationProvider_recursive","Execute all implementation providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location or LocationLink instances.",lt)),new H("vscode.executeReferenceProvider","_executeReferenceProvider","Execute all reference providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location-instances.",Ue(st.to))),new H("vscode.experimental.executeReferenceProvider","_executeReferenceProvider_recursive","Execute all reference providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Location-instances.",Ue(st.to))),new H("vscode.executeHoverProvider","_executeHoverProvider","Execute all hover providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Hover-instances.",Ue(Nn.to))),new H("vscode.experimental.executeHoverProvider_recursive","_executeHoverProvider_recursive","Execute all hover providers.",[P.Uri,P.Position],new M("A promise that resolves to an array of Hover-instances.",Ue(Nn.to))),new H("vscode.executeSelectionRangeProvider","_executeSelectionRangeProvider","Execute selection range provider.",[P.Uri,new P("position","A position in a text document",a=>Array.isArray(a)&&a.every(e=>Fe.isPosition(e)),a=>a.map(te.from))],new M("A promise that resolves to an array of ranges.",a=>a.map(e=>{let t;for(const i of e.reverse())t=new rh(A.to(i),t);return t}))),new H("vscode.executeWorkspaceSymbolProvider","_executeWorkspaceSymbolProvider","Execute all workspace symbol providers.",[P.String.with("query","Search string")],new M("A promise that resolves to an array of SymbolInformation-instances.",a=>a.map(On.to))),new H("vscode.prepareCallHierarchy","_executePrepareCallHierarchy","Prepare call hierarchy at a position inside a document",[P.Uri,P.Position],new M("A promise that resolves to an array of CallHierarchyItem-instances",a=>a.map(Ra.to))),new H("vscode.provideIncomingCalls","_executeProvideIncomingCalls","Compute incoming calls for an item",[P.CallHierarchyItem],new M("A promise that resolves to an array of CallHierarchyIncomingCall-instances",a=>a.map(Cg.to))),new H("vscode.provideOutgoingCalls","_executeProvideOutgoingCalls","Compute outgoing calls for an item",[P.CallHierarchyItem],new M("A promise that resolves to an array of CallHierarchyOutgoingCall-instances",a=>a.map(Dg.to))),new H("vscode.prepareRename","_executePrepareRename","Execute the prepareRename of rename provider.",[P.Uri,P.Position],new M("A promise that resolves to a range and placeholder text.",a=>{if(a)return{range:A.to(a.range),placeholder:a.text}})),new H("vscode.executeDocumentRenameProvider","_executeDocumentRenameProvider","Execute rename provider.",[P.Uri,P.Position,P.String.with("newName","The new symbol name")],new M("A promise that resolves to a WorkspaceEdit.",a=>{if(a){if(a.rejectReason)throw new Error(a.rejectReason);return Le.to(a)}})),new H("vscode.executeLinkProvider","_executeLinkProvider","Execute document link provider.",[P.Uri,P.Number.with("linkResolveCount","Number of links that should be resolved, only when links are unresolved.").optional()],new M("A promise that resolves to an array of DocumentLink-instances.",a=>a.map(Gi.to))),new H("vscode.provideDocumentSemanticTokensLegend","_provideDocumentSemanticTokensLegend","Provide semantic tokens legend for a document",[P.Uri],new M("A promise that resolves to SemanticTokensLegend.",a=>{if(a)return new Un(a.tokenTypes,a.tokenModifiers)})),new H("vscode.provideDocumentSemanticTokens","_provideDocumentSemanticTokens","Provide semantic tokens for a document",[P.Uri],new M("A promise that resolves to SemanticTokens.",a=>{if(!a)return;const e=Zc(a);if(e.type==="full")return new nr(e.data,void 0)})),new H("vscode.provideDocumentRangeSemanticTokensLegend","_provideDocumentRangeSemanticTokensLegend","Provide semantic tokens legend for a document range",[P.Uri,P.Range.optional()],new M("A promise that resolves to SemanticTokensLegend.",a=>{if(a)return new Un(a.tokenTypes,a.tokenModifiers)})),new H("vscode.provideDocumentRangeSemanticTokens","_provideDocumentRangeSemanticTokens","Provide semantic tokens for a document range",[P.Uri,P.Range],new M("A promise that resolves to SemanticTokens.",a=>{if(!a)return;const e=Zc(a);if(e.type==="full")return new nr(e.data,void 0)})),new H("vscode.executeCompletionItemProvider","_executeCompletionItemProvider","Execute completion item provider.",[P.Uri,P.Position,P.String.with("triggerCharacter","Trigger completion when the user types the character, like `,` or `(`").optional(),P.Number.with("itemResolveCount","Number of completions to resolve (too large numbers slow down completions)").optional()],new M("A promise that resolves to a CompletionList-instance.",(a,e,t)=>{if(!a)return new or([]);const i=a.suggestions.map(s=>Pg.to(s,t));return new or(i,a.incomplete)})),new H("vscode.executeSignatureHelpProvider","_executeSignatureHelpProvider","Execute signature help provider.",[P.Uri,P.Position,P.String.with("triggerCharacter","Trigger signature help when the user types the character, like `,` or `(`").optional()],new M("A promise that resolves to SignatureHelp.",a=>{if(a)return Wn.to(a)})),new H("vscode.executeCodeLensProvider","_executeCodeLensProvider","Execute code lens provider.",[P.Uri,P.Number.with("itemResolveCount","Number of lenses that should be resolved and returned. Will only return resolved lenses, will impact performance)").optional()],new M("A promise that resolves to an array of CodeLens-instances.",(a,e,t)=>Ue(i=>new ph(A.to(i.range),i.command&&t.fromInternal(i.command)))(a))),new H("vscode.executeCodeActionProvider","_executeCodeActionProvider","Execute code action provider.",[P.Uri,new P("rangeOrSelection","Range in a text document. Some refactoring provider requires Selection object.",a=>ce.isRange(a),a=>mi.isSelection(a)?it.from(a):A.from(a)),P.String.with("kind","Code action kind to return code actions for").optional(),P.Number.with("itemResolveCount","Number of code actions to resolve (too large numbers slow down code actions)").optional()],new M("A promise that resolves to an array of Command-instances.",(a,e,t)=>Ue(i=>{if(i._isSynthetic){if(!i.command)throw new Error("Synthetic code actions must have a command");return t.fromInternal(i.command)}else{const s=new Ua(i.title,i.kind?new Wa(i.kind):void 0);return i.edit&&(s.edit=Le.to(i.edit)),i.command&&(s.command=t.fromInternal(i.command)),s.isPreferred=i.isPreferred,s}})(a))),new H("vscode.executeDocumentColorProvider","_executeDocumentColorProvider","Execute document color provider.",[P.Uri],new M("A promise that resolves to an array of ColorInformation objects.",a=>a?a.map(e=>new nh(A.to(e.range),ar.to(e.color))):[])),new H("vscode.executeColorPresentationProvider","_executeColorPresentationProvider","Execute color presentation provider.",[new P("color","The color to show and insert",a=>a instanceof oh,ar.from),new P("context","Context object with uri and range",a=>!0,a=>({uri:a.uri,range:A.from(a.range)}))],new M("A promise that resolves to an array of ColorPresentation objects.",a=>a?a.map(ah.to):[])),new H("vscode.executeInlayHintProvider","_executeInlayHintProvider","Execute inlay hints provider",[P.Uri,P.Range],new M("A promise that resolves to an array of Inlay objects",(a,e,t)=>a.map(Tg.to.bind(void 0,t)))),new H("vscode.executeFoldingRangeProvider","_executeFoldingRangeProvider","Execute folding range provider",[P.Uri],new M("A promise that resolves to an array of FoldingRange objects",(a,e)=>{if(a)return a.map(ch.to)})),new H("vscode.resolveNotebookContentProviders","_resolveNotebookContentProvider","Resolve Notebook Content Providers",[],new M("A promise that resolves to an array of NotebookContentProvider static info objects.",Ue(a=>({viewType:a.viewType,displayName:a.displayName,options:{transientOutputs:a.options.transientOutputs,transientCellMetadata:a.options.transientCellMetadata,transientDocumentMetadata:a.options.transientDocumentMetadata},filenamePattern:a.filenamePattern.map(e=>fh.to(e))})))),new H("vscode.executeInlineValueProvider","_executeInlineValueProvider","Execute inline value provider",[P.Uri,P.Range,new P("context","An InlineValueContext",a=>a&&typeof a.frameId=="number"&&a.stoppedLocation instanceof ce,a=>dh.from(a))],new M("A promise that resolves to an array of InlineValue objects",a=>a.map(lh.to))),new H("vscode.open","_workbench.open","Opens the provided resource in the editor. Can be a text or binary file, or an http(s) URL. If you need more control over the options for opening a text file, use vscode.window.showTextDocument instead.",[new P("uriOrString","Uri-instance or string (only http/https)",a=>v.isUri(a)||typeof a=="string"&&cf(a,G.http,G.https),a=>a),new P("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="number"||typeof a=="object",a=>a&&(typeof a=="number"?[we.from(a),void 0]:[we.from(a.viewColumn),Jr.from(a)])).optional(),P.String.with("label","").optional()],M.Void),new H("vscode.openWith","_workbench.openWith","Opens the provided resource with a specific editor.",[P.Uri.with("resource","Resource to open"),P.String.with("viewId","Custom editor view id. This should be the viewType string for custom editors or the notebookType string for notebooks. Use 'default' to use VS Code's default text editor"),new P("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="number"||typeof a=="object",a=>a&&(typeof a=="number"?[we.from(a),void 0]:[we.from(a.viewColumn),Jr.from(a)])).optional()],M.Void),new H("vscode.diff","_workbench.diff","Opens the provided resources in the diff editor to compare their contents.",[P.Uri.with("left","Left-hand side resource of the diff editor"),P.Uri.with("right","Right-hand side resource of the diff editor"),P.String.with("title","Human readable title for the diff editor").optional(),new P("columnOrOptions","Either the column in which to open or editor options, see vscode.TextDocumentShowOptions",a=>a===void 0||typeof a=="object",a=>a&&[we.from(a.viewColumn),Jr.from(a)]).optional()],M.Void),new H("vscode.changes","_workbench.changes","Opens a list of resources in the changes editor to compare their contents.",[P.String.with("title","Human readable title for the changes editor"),new P("resourceList","List of resources to compare",a=>{for(const e of a){if(e.length!==3)return!1;const[t,i,s]=e;if(!v.isUri(t)||!v.isUri(i)&&i!==void 0&&i!==null||!v.isUri(s)&&s!==void 0&&s!==null)return!1}return!0},a=>a)],M.Void),new H("vscode.prepareTypeHierarchy","_executePrepareTypeHierarchy","Prepare type hierarchy at a position inside a document",[P.Uri,P.Position],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(zi.to))),new H("vscode.provideSupertypes","_executeProvideSupertypes","Compute supertypes for an item",[P.TypeHierarchyItem],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(zi.to))),new H("vscode.provideSubtypes","_executeProvideSubtypes","Compute subtypes for an item",[P.TypeHierarchyItem],new M("A promise that resolves to an array of TypeHierarchyItem-instances",a=>a.map(zi.to))),new H("vscode.revealTestInExplorer","_revealTestInExplorer","Reveals a test instance in the explorer",[P.TestItem],M.Void),new H("vscode.startContinuousTestRun","testing.startContinuousRunFromExtension","Starts running the given tests with continuous run mode.",[P.TestProfile,P.Arr(P.TestItem)],M.Void),new H("vscode.stopContinuousTestRun","testing.stopContinuousRunFromExtension","Stops running the given tests with continuous run mode.",[P.Arr(P.TestItem)],M.Void),new H("vscode.experimental.editSession.continue","_workbench.editSessions.actions.continueEditSession","Continue the current edit session in a different workspace",[P.Uri.with("workspaceUri","The target workspace to continue the current edit session in")],M.Void),new H("setContext","_setContext","Set a custom context key value that can be used in when clauses.",[P.String.with("name","The context key name"),new P("value","The context key value",()=>!0,a=>a)],M.Void),new H("vscode.editorChat.start","inlineChat.start","Invoke a new editor chat session",[new P("Run arguments","",a=>!0,a=>{if(a)return{initialRange:a.initialRange?A.from(a.initialRange):void 0,initialSelection:mi.isSelection(a.initialSelection)?it.from(a.initialSelection):void 0,message:a.message,attachments:a.attachments,autoSend:a.autoSend,position:a.position?te.from(a.position):void 0}})],M.Void)];class Nw{static register(e){Lw.forEach(e.registerApiCommand,e),this._registerValidateWhenClausesCommand(e)}static _registerValidateWhenClausesCommand(e){e.registerCommand(!1,"_validateWhenClauses",lf)}}function Ue(a){return e=>{if(Array.isArray(e))return e.map(a)}}function lt(a){if(!Array.isArray(a))return;const e=[];for(const t of a)df(t)?e.push(Vn.to(t)):e.push(st.to(t));return e}let sa=class{constructor(e,t){this._proxy=e.getProxy(k.MainThreadBulkEdits),this._versionInformationProvider={getTextDocumentVersion:i=>t.getDocument(i)?.version,getNotebookDocumentVersion:()=>{}}}applyWorkspaceEdit(e,t,i){const s=new Qe(Le.from(e,this._versionInformationProvider));return this._proxy.$tryApplyWorkspaceEdit(s,void 0,i?.isRefactoring??!1)}};sa=L([E(0,q)],sa);class Ow{constructor(e,t,i,s,r){this._extension=e,this._request=t,this._proxy=i,this._commandsConverter=s,this._sessionDisposables=r,this._stopWatch=ui.create(!1),this._isClosed=!1}close(){this._isClosed=!0}get timings(){return{firstProgress:this._firstProgress,totalElapsed:this._stopWatch.elapsed()}}get apiObject(){if(!this._apiObject){let i=function(c){if(e._isClosed){const d=new Error("Response stream has been closed");throw Error.captureStackTrace(d,c),d}},n=function(c,d){if(s.push(d!==void 0?[c,d]:c)===1&&queueMicrotask(()=>{e._proxy.$handleProgressChunk(e._request.requestId,s).finally(()=>{r.forEach(f=>f()),r.length=0}),s.length=0}),d!==void 0)return new Promise(f=>{r.push(f)})};const e=this;this._stopWatch.reset();let t=0;const s=[],r=[],o=(c,d)=>{if(typeof this._firstProgress>"u"&&(c.kind==="markdownContent"||c.kind==="markdownVuln"||c.kind==="prepareToolInvocation")&&(this._firstProgress=this._stopWatch.elapsed()),d){const h=t++,f=n(c,h),m={report:l=>{f.then(()=>{vi.isMarkdownString(l.value)?n(cd.from(l),h):n(Yr.from(l),h)})}};Promise.all([f,d(m)]).then(([l,p])=>{n(jg.from(p),h)})}else n(c)};this._apiObject=Object.freeze({markdown(c){i(this.markdown);const d=new Sh(c),h=zg.from(d);return o(h),this},markdownWithVulnerabilities(c,d){i(this.markdown),d&&b(e._extension,"chatParticipantAdditions");const h=new Kn(c,d),f=Bg.from(h);return o(f),this},codeblockUri(c,d){i(this.codeblockUri),b(e._extension,"chatParticipantAdditions");const h=new Eh(c,d),f=Vg.from(h);return o(f),this},filetree(c,d){i(this.filetree);const h=new bh(c,d),f=Wg.from(h);return o(f),this},anchor(c,d){const h=new Xn(c,d);return this.push(h)},button(c){i(this.anchor);const d=new xh(c),h=Ug.from(d,e._commandsConverter,e._sessionDisposables);return o(h),this},progress(c,d){i(this.progress);const h=new Ms(c,d),f=d?rd.from(h):nd.from(h);return o(f,d),this},warning(c){i(this.progress),b(e._extension,"chatParticipantAdditions");const d=new Gn(c),h=cd.from(d);return o(h),this},reference(c,d){return this.reference2(c,d)},reference2(c,d,h){if(i(this.reference),typeof c=="object"&&"variableName"in c&&b(e._extension,"chatParticipantAdditions"),typeof c=="object"&&"variableName"in c&&!c.value){const f=e._request.variables.variables.find(m=>m.name===c.variableName);if(f){let m;if(f.references?.length)m=f.references.map(l=>({kind:"reference",reference:{variableName:c.variableName,value:l.reference}}));else{const l=new Qi(c,d,h);m=[Yr.from(l)]}return m.forEach(l=>o(l)),this}}else{const f=new Qi(c,d,h),m=Yr.from(f);o(m)}return this},codeCitation(c,d,h){i(this.codeCitation),b(e._extension,"chatParticipantAdditions");const f=new Jn(c,d,h),m=Og.from(f);o(m)},textEdit(c,d){i(this.textEdit),b(e._extension,"chatParticipantAdditions");const h=new jn(c,d);h.isDone=d===!0?!0:void 0;const f=Ng.from(h);return o(f),this},notebookEdit(c,d){i(this.notebookEdit),b(e._extension,"chatParticipantAdditions");const h=new qn(c,d),f=Lg.from(h);return o(f),this},confirmation(c,d,h,f){i(this.confirmation),b(e._extension,"chatParticipantAdditions");const m=new Qn(c,d,h,f),l=Fg.from(m);return o(l),this},prepareToolInvocation(c){i(this.prepareToolInvocation),b(e._extension,"chatParticipantAdditions");const d=new Yn(c),h=ad.from(d);return o(h),this},push(c){if(i(this.push),(c instanceof jn||c instanceof qn||c instanceof Kn||c instanceof Gn||c instanceof Qn||c instanceof Jn||c instanceof yh||c instanceof wh||c instanceof Ms)&&b(e._extension,"chatParticipantAdditions"),c instanceof Qi)this.reference2(c.value,c.iconPath,c.options);else if(c instanceof Ms){const d=c.task?rd.from(c):nd.from(c);o(d,c.task)}else if(c instanceof Xn){const d=od.from(c);if(c.resolve){b(e._extension,"chatParticipantAdditions"),d.resolveId=Ct();const h=new he;c.resolve(h.token).then(()=>{const f=od.from(c);e._proxy.$handleAnchorResolve(e._request.requestId,d.resolveId,f)}).then(()=>h.dispose(),()=>h.dispose()),e._sessionDisposables.add(V(()=>h.dispose(!0)))}o(d)}else if(c instanceof Yn){b(e._extension,"chatParticipantAdditions");const d=ad.from(c);return o(d),this}else{const d=mh.from(c,e._commandsConverter,e._sessionDisposables);o(d)}return this}})}return this._apiObject}}class ni extends Z{static{this._idPool=0}static{this._participantDetectionProviderIdPool=0}static{this._relatedFilesProviderIdPool=0}constructor(e,t,i,s,r,n,o){super(),this._logService=t,this._commands=i,this._documents=s,this._languageModels=r,this._diagnostics=n,this._tools=o,this._agents=new Map,this._participantDetectionProviders=new Map,this._relatedFilesProviders=new Map,this._sessionDisposables=this._register(new Sn),this._completionDisposables=this._register(new Sn),this._inFlightRequests=new Set,this._onDidDisposeChatSession=this._register(new D),this.onDidDisposeChatSession=this._onDidDisposeChatSession.event,this._proxy=e.getProxy(k.MainThreadChatAgents2),i.registerArgumentProcessor({processArgument:c=>kg(c)?null:c})}transferActiveChat(e){this._proxy.$transferActiveChatSession(e)}createChatAgent(e,t,i){const s=ni._idPool++,r=new Wd(e,t,this._proxy,s,i);return this._agents.set(s,r),this._proxy.$registerAgent(s,e.identifier,t,{},void 0),r.apiAgent}createDynamicChatAgent(e,t,i,s){const r=ni._idPool++,n=new Wd(e,t,this._proxy,r,s);return this._agents.set(r,n),this._proxy.$registerAgent(r,e.identifier,t,{isSticky:!0},i),n.apiAgent}registerChatParticipantDetectionProvider(e,t){const i=ni._participantDetectionProviderIdPool++;return this._participantDetectionProviders.set(i,new Uw(e,t)),this._proxy.$registerChatParticipantDetectionProvider(i),V(()=>{this._participantDetectionProviders.delete(i),this._proxy.$unregisterChatParticipantDetectionProvider(i)})}registerRelatedFilesProvider(e,t,i){const s=ni._relatedFilesProviderIdPool++;return this._relatedFilesProviders.set(s,new Ww(e,t)),this._proxy.$registerRelatedFilesProvider(s,i),V(()=>{this._relatedFilesProviders.delete(s),this._proxy.$unregisterRelatedFilesProvider(s)})}async $provideRelatedFiles(e,t,i){const s=this._relatedFilesProviders.get(e);if(!s)return Promise.resolve([]);const r=Ig.to(t);return await s.provider.provideRelatedFiles(r,i)??void 0}async $detectChatParticipant(e,t,i,s,r){const n=this._participantDetectionProviders.get(e);if(!n)return;const{request:o,location:c,history:d}=await this._createRequest(t,i,n.extension),h=await this.getModelForRequest(o,n.extension),f=ed.to(o,c,h,this.getDiagnosticsWhenEnabled(n.extension),this.getToolsForRequest(n.extension,o),n.extension,this._logService);return n.provider.provideParticipantDetection(f,{history:d},{participants:s.participants,location:Rg.to(s.location)},r)}async _createRequest(e,t,i){const s=qe(e),r=await this.prepareHistoryTurns(i,s.agentId,t);let n;if(s.locationData?.type===td.Editor){const o=this._documents.getDocument(s.locationData.document);n=new gh(o,it.to(s.locationData.selection),A.to(s.locationData.wholeRange))}else if(s.locationData?.type===td.Notebook){const o=this._documents.getDocument(s.locationData.sessionInputUri);n=new vh(o)}return{request:s,location:n,history:r}}async getModelForRequest(e,t){let i;if(e.userSelectedModelId&&(i=await this._languageModels.getLanguageModelByIdentifier(t,e.userSelectedModelId)),!i&&(i=await this._languageModels.getDefaultLanguageModel(t),!i))throw new Error("Language model unavailable");return i}async $setRequestPaused(e,t,i){const s=this._agents.get(e);if(!s)return;const r=fi.find(this._inFlightRequests,n=>n.requestId===t);r&&s.setChatRequestPauseState({request:r.extRequest,isPaused:i})}async $invokeAgent(e,t,i,s){const r=this._agents.get(e);if(!r)throw new Error(`[CHAT](${e}) CANNOT invoke agent because the agent is not registered`);let n,o;try{const{request:c,location:d,history:h}=await this._createRequest(t,i,r.extension);let f=this._sessionDisposables.get(c.sessionId);f||(f=new N,this._sessionDisposables.set(c.sessionId,f)),n=new Ow(r.extension,c,this._proxy,this._commands.converter,f);const m=await this.getModelForRequest(c,r.extension),l=ed.to(c,d,m,this.getDiagnosticsWhenEnabled(r.extension),this.getToolsForRequest(r.extension,c),r.extension,this._logService);o={requestId:t.requestId,extRequest:l},this._inFlightRequests.add(o);const p=r.invoke(l,{history:h},n.apiObject,s);return await Vw(1e3,Promise.resolve(p).then(_=>{if(_?.metadata)try{JSON.stringify(_.metadata)}catch(S){const C=`result.metadata MUST be JSON.stringify-able. Got error: ${S.message}`;return this._logService.error(`[${r.extension.identifier.value}] [@${r.id}] ${C}`,r.extension),{errorDetails:{message:C},timings:n?.timings,nextQuestion:_.nextQuestion}}let x;return _?.errorDetails&&(x={..._.errorDetails,responseIsIncomplete:!0}),(x?.responseIsRedacted||x?.isQuotaExceeded||x?.confirmationButtons)&&b(r.extension,"chatParticipantPrivate"),{errorDetails:x,timings:n?.timings,metadata:_?.metadata,nextQuestion:_?.nextQuestion}}),s)}catch(c){this._logService.error(c,r.extension),c instanceof Ye&&c.cause&&(c=c.cause);const d=c instanceof Error&&c.name==="ChatQuotaExceeded";return{errorDetails:{message:br(c),responseIsIncomplete:!0,isQuotaExceeded:d}}}finally{o&&this._inFlightRequests.delete(o),n?.close()}}getDiagnosticsWhenEnabled(e){return ie(e,"chatReferenceDiagnostic")?this._diagnostics.getDiagnostics():[]}getToolsForRequest(e,t){if(!t.userSelectedTools)return new Map;const i=new Map;for(const s of this._tools.getTools(e))typeof t.userSelectedTools[s.name]=="boolean"&&i.set(s.name,t.userSelectedTools[s.name]);return i}async prepareHistoryTurns(e,t,i){const s=[];for(const r of i.history){const n=Xr.to(r.result),o=t===r.request.agentId?n:{...n,metadata:void 0},c=[],d=[];for(const l of r.request.variables.variables)if(l.kind==="tool")d.push(id.to(l));else if(l.kind==="toolset")d.push(...l.value.map(id.to));else{const p=Ag.to(l,this.getDiagnosticsWhenEnabled(e),this._logService);p&&c.push(p)}const h=ie(e,"chatParticipantPrivate")?r.request.editedFileEvents:void 0,f=new Bn(r.request.message,r.request.command,c,r.request.agentId,d,h);s.push(f);const m=Re(r.response.map(l=>mh.toContent(l,this._commands.converter)));s.push(new _h(m,o,r.request.agentId,r.request.command))}return s}$releaseSession(e){this._sessionDisposables.deleteAndDispose(e),this._onDidDisposeChatSession.fire(e)}async $provideFollowups(e,t,i,s,r){const n=this._agents.get(t);if(!n)return Promise.resolve([]);const o=qe(e),c=await this.prepareHistoryTurns(n.extension,n.id,s),d=Xr.to(i);return(await n.provideFollowups(d,{history:c},r)).filter(h=>{const f=!h.participant||fi.some(this._agents.values(),m=>m.id===h.participant&&me.equals(m.extension.identifier,n.extension.identifier));return f||this._logService.warn(`[@${n.id}] ChatFollowup refers to an unknown participant: ${h.participant}`),f}).map(h=>$g.from(h,o))}$acceptFeedback(e,t,i){const s=this._agents.get(e);if(!s)return;const r=Xr.to(t);let n;switch(i.direction){case sd.Down:n=zn.Unhelpful;break;case sd.Up:n=zn.Helpful;break}const o={result:r,kind:n,unhelpfulReason:ie(s.extension,"chatParticipantAdditions")?i.reason:void 0};s.acceptFeedback(Object.freeze(o))}$acceptAction(e,t,i){const s=this._agents.get(e);if(!s||i.action.kind==="vote")return;const r=Mg.to(t,i,this._commands.converter);r&&s.acceptAction(Object.freeze(r))}async $invokeCompletionProvider(e,t,i){const s=this._agents.get(e);if(!s)return[];let r=this._completionDisposables.get(e);return r?r.clear():(r=new N,this._completionDisposables.set(e,r)),(await s.invokeCompletionProvider(t,i)).map(o=>Hg.from(o,this._commands.converter,r))}async $provideChatTitle(e,t,i){const s=this._agents.get(e);if(!s)return;const r=await this.prepareHistoryTurns(s.extension,s.id,{history:t});return await s.provideTitle({history:r},i)}}class Uw{constructor(e,t){this.extension=e,this.provider=t}}class Ww{constructor(e,t){this.extension=e,this.provider=t}}class Wd{constructor(e,t,i,s,r){this.extension=e,this.id=t,this._proxy=i,this._handle=s,this._requestHandler=r,this._onDidReceiveFeedback=new D,this._onDidPerformAction=new D,this._pauseStateEmitter=new D}acceptFeedback(e){this._onDidReceiveFeedback.fire(e)}acceptAction(e){this._onDidPerformAction.fire(e)}setChatRequestPauseState(e){this._pauseStateEmitter.fire(e)}async invokeCompletionProvider(e,t){return this._agentVariableProvider?await this._agentVariableProvider.provider.provideCompletionItems(e,t)??[]:[]}async provideFollowups(e,t,i){if(!this._followupProvider)return[];const s=await this._followupProvider.provideFollowups(e,t,i);return s?s.filter(r=>!(r&&"commandId"in r)).filter(r=>!(r&&"message"in r)):[]}async provideTitle(e,t){if(this._titleProvider)return await this._titleProvider.provideChatTitle(e,t)??void 0}get apiAgent(){let e=!1,t=!1;const i=()=>{e||t||(t=!0,queueMicrotask(()=>{this._proxy.$updateAgent(this._handle,{icon:this._iconPath?this._iconPath instanceof v?this._iconPath:"light"in this._iconPath?this._iconPath.light:void 0:void 0,iconDark:this._iconPath&&"dark"in this._iconPath?this._iconPath.dark:void 0,themeIcon:this._iconPath instanceof Et?this._iconPath:void 0,hasFollowups:this._followupProvider!==void 0,helpTextPrefix:!this._helpTextPrefix||typeof this._helpTextPrefix=="string"?this._helpTextPrefix:ae.from(this._helpTextPrefix),helpTextVariablesPrefix:!this._helpTextVariablesPrefix||typeof this._helpTextVariablesPrefix=="string"?this._helpTextVariablesPrefix:ae.from(this._helpTextVariablesPrefix),helpTextPostfix:!this._helpTextPostfix||typeof this._helpTextPostfix=="string"?this._helpTextPostfix:ae.from(this._helpTextPostfix),supportIssueReporting:this._supportIssueReporting,requester:this._requester,additionalWelcomeMessage:!this._additionalWelcomeMessage||typeof this._additionalWelcomeMessage=="string"?this._additionalWelcomeMessage:ae.from(this._additionalWelcomeMessage)}),t=!1}))},s=this;return{get id(){return s.id},get iconPath(){return s._iconPath},set iconPath(r){s._iconPath=r,i()},get requestHandler(){return s._requestHandler},set requestHandler(r){Pl(typeof r=="function","Invalid request handler"),s._requestHandler=r},get followupProvider(){return s._followupProvider},set followupProvider(r){s._followupProvider=r,i()},get helpTextPrefix(){return b(s.extension,"defaultChatParticipant"),s._helpTextPrefix},set helpTextPrefix(r){b(s.extension,"defaultChatParticipant"),s._helpTextPrefix=r,i()},get helpTextVariablesPrefix(){return b(s.extension,"defaultChatParticipant"),s._helpTextVariablesPrefix},set helpTextVariablesPrefix(r){b(s.extension,"defaultChatParticipant"),s._helpTextVariablesPrefix=r,i()},get helpTextPostfix(){return b(s.extension,"defaultChatParticipant"),s._helpTextPostfix},set helpTextPostfix(r){b(s.extension,"defaultChatParticipant"),s._helpTextPostfix=r,i()},get supportIssueReporting(){return b(s.extension,"chatParticipantPrivate"),s._supportIssueReporting},set supportIssueReporting(r){b(s.extension,"chatParticipantPrivate"),s._supportIssueReporting=r,i()},get onDidReceiveFeedback(){return s._onDidReceiveFeedback.event},set participantVariableProvider(r){if(b(s.extension,"chatParticipantAdditions"),s._agentVariableProvider=r,r){if(!r.triggerCharacters.length)throw new Error("triggerCharacters are required");s._proxy.$registerAgentCompletionsProvider(s._handle,s.id,r.triggerCharacters)}else s._proxy.$unregisterAgentCompletionsProvider(s._handle,s.id)},get participantVariableProvider(){return b(s.extension,"chatParticipantAdditions"),s._agentVariableProvider},set additionalWelcomeMessage(r){b(s.extension,"defaultChatParticipant"),s._additionalWelcomeMessage=r,i()},get additionalWelcomeMessage(){return b(s.extension,"defaultChatParticipant"),s._additionalWelcomeMessage},set titleProvider(r){b(s.extension,"defaultChatParticipant"),s._titleProvider=r,i()},get titleProvider(){return b(s.extension,"defaultChatParticipant"),s._titleProvider},get onDidChangePauseState(){return b(s.extension,"chatParticipantAdditions"),s._pauseStateEmitter.event},onDidPerformAction:ie(this.extension,"chatParticipantAdditions")?this._onDidPerformAction.event:void 0,set requester(r){s._requester=r,i()},get requester(){return s._requester},dispose(){e=!0,s._followupProvider=void 0,s._onDidReceiveFeedback.dispose(),s._proxy.$unregisterAgent(s._handle)}}}invoke(e,t,i,s){return this._requestHandler(e,t,i,s)}}function Vw(a,e,t){return new Promise((i,s)=>{const r=t.onCancellationRequested(async()=>{r.dispose(),await Nt(a),i(void 0)});e.then(i,s).finally(()=>r.dispose())})}class Bw{constructor(e){this._items=new Map,this._proxy=e.getProxy(k.MainThreadChatStatus)}createChatStatusItem(e,t){const i=zw(e.identifier,t);if(this._items.has(i))throw new Error(`Chat status item '${t}' already exists`);const s={id:i,title:"",description:"",detail:""};let r=!1,n=!1;const o=()=>{if(r)throw new Error("Chat status item is disposed");n&&this._proxy.$setEntry(t,s)},c=Object.freeze({id:t,get title(){return s.title},set title(d){s.title=d,o()},get description(){return s.description},set description(d){s.description=d,o()},get detail(){return s.detail},set detail(d){s.detail=d,o()},show:()=>{n=!0,o()},hide:()=>{n=!1,this._proxy.$disposeEntry(t)},dispose:()=>{r=!0,this._proxy.$disposeEntry(t),this._items.delete(i)}});return this._items.set(i,c),c}}function zw(a,e){return`${me.toKey(a)}.${e}`}class jw{constructor(e){const t=e.getProxy(k.MainThreadClipboard);this.value=Object.freeze({readText(){return t.$readText()},writeText(i){return t.$writeText(i)}})}}const fu="vscode-cdn.net",qw=`vscode-resource.${fu}`,ra=`'self' https://*.${fu}`;function Yi(a,e){return a.scheme===G.http||a.scheme===G.https?a:(e&&e.authority&&e.isRemote&&a.scheme===G.file&&(a=v.from({scheme:G.vscodeRemote,authority:e.authority,path:a.path})),v.from({scheme:G.https,authority:`${a.scheme}+${Kw(a.authority)}.${qw}`,path:a.path,fragment:a.fragment,query:a.query}))}function Kw(a){return a.replace(/./g,e=>{const t=e.charCodeAt(0);return t>=ut.a&&t<=ut.z||t>=ut.A&&t<=ut.Z||t>=ut.Digit0&&t<=ut.Digit9?e:"-"+t.toString(16).padStart(4,"0")})}function jb(a){return a.replace(/-([0-9a-f]{4})/g,(e,t)=>String.fromCharCode(parseInt(t,16)))}class Gw{constructor(e,t,i){this._proxy=e,this._editors=t,this._remoteInfo=i,this._handlePool=0,this._disposables=new N,this._insets=new Map,this._disposables.add(t.onDidChangeVisibleTextEditors(()=>{const s=t.getVisibleTextEditors();for(const r of this._insets.values())s.indexOf(r.editor)<0&&r.inset.dispose()}))}dispose(){this._insets.forEach(e=>e.inset.dispose()),this._disposables.dispose()}createWebviewEditorInset(e,t,i,s,r){let n;for(const l of this._editors.getVisibleTextEditors(!0))if(l.value===e){n=l;break}if(!n)throw new Error("not a visible editor");const o=this,c=this._handlePool++,d=new D,h=new D,f=new class{constructor(){this._html="",this._options=Object.create(null)}asWebviewUri(l){return Yi(l,o._remoteInfo)}get cspSource(){return ra}set options(l){this._options=l,o._proxy.$setOptions(c,l)}get options(){return this._options}set html(l){this._html=l,o._proxy.$setHtml(c,l)}get html(){return this._html}get onDidReceiveMessage(){return d.event}postMessage(l){return o._proxy.$postMessage(c,l)}},m=new class{constructor(){this.editor=e,this.line=t,this.height=i,this.webview=f,this.onDidDispose=h.event}dispose(){o._insets.has(c)&&(o._insets.delete(c),o._proxy.$disposeEditorInset(c),h.fire(),h.dispose(),d.dispose())}};return this._proxy.$createEditorInset(c,n.id,n.value.document.uri,t+1,i,s||{},r.identifier,r.extensionLocation),this._insets.set(c,{editor:e,inset:m,onDidReceiveMessage:d}),m}$onDidDispose(e){const t=this._insets.get(e);t&&t.inset.dispose()}$onDidReceiveMessage(e,t){this._insets.get(e)?.onDidReceiveMessage.fire(t)}}class tc{static{this._providerHandlePool=0}constructor(e){this.providers=new Map,this._proxy=e.getProxy(k.MainThreadCodeMapper)}async $mapCode(e,t,i){const s=this.providers.get(e);if(!s)throw new Error(`Received request to map code for unknown provider handle ${e}`);const r={textEdit:(c,d)=>{d=Ge(d),this._proxy.$handleProgress(t.requestId,{uri:c,edits:d.map(Ke.from)})},notebookEdit:(c,d)=>{d=Ge(d),this._proxy.$handleProgress(t.requestId,{uri:c,edits:d.map(qg.from)})}},n={location:t.location,chatRequestId:t.chatRequestId,chatRequestModel:t.chatRequestModel,chatSessionId:t.chatSessionId,codeBlocks:t.codeBlocks.map(c=>({code:c.code,resource:v.revive(c.resource),markdownBeforeBlock:c.markdownBeforeBlock}))};return await s.provideMappedEdits(n,r,i)??null}registerMappedEditsProvider(e,t){const i=tc._providerHandlePool++;return this._proxy.$registerCodeMapperProvider(i,e.displayName??e.name),this.providers.set(i,t),{dispose:()=>this._proxy.$unregisterCodeMapperProvider(i)}}}function Qw(a,e,t){const i=a.getProxy(k.MainThreadComments);class s{static{this.handlePool=0}constructor(){this._commentControllers=new Map,this._commentControllersByExtension=new Vt,e.registerArgumentProcessor({processArgument:p=>{if(p&&p.$mid===Se.CommentController){const _=this._commentControllers.get(p.handle);return _?_.value:p}else if(p&&p.$mid===Se.CommentThread){const _=p,x=this._commentControllers.get(_.commentControlHandle);if(!x)return _;const S=x.getCommentThread(_.commentThreadHandle);return S?S.value:_}else if(p&&(p.$mid===Se.CommentThreadReply||p.$mid===Se.CommentThreadInstance)){const _=this._commentControllers.get(p.thread.commentControlHandle);if(!_)return p;const x=_.getCommentThread(p.thread.commentThreadHandle);return x?p.$mid===Se.CommentThreadInstance?x.value:{thread:x.value,text:p.text}:p}else if(p&&p.$mid===Se.CommentNode){const _=this._commentControllers.get(p.thread.commentControlHandle);if(!_)return p;const x=_.getCommentThread(p.thread.commentThreadHandle);if(!x)return p;const S=p.commentUniqueId,C=x.getCommentByUniqueId(S);return C||p}else if(p&&p.$mid===Se.CommentThreadNode){const _=this._commentControllers.get(p.thread.commentControlHandle);if(!_)return p;const x=_.getCommentThread(p.thread.commentThreadHandle);if(!x)return p;const S=p.text,C=p.commentUniqueId,T=x.getCommentByUniqueId(C);return T?(typeof T.body=="string"?T.body=S:T.body=new vi(S),T):p}return p}})}createCommentController(p,_,x){const S=s.handlePool++,C=new n(p,S,_,x);this._commentControllers.set(C.handle,C);const T=this._commentControllersByExtension.get(p.identifier)||[];return T.push(C),this._commentControllersByExtension.set(p.identifier,T),C.value}async $createCommentThreadTemplate(p,_,x,S){const C=this._commentControllers.get(p);C&&C.$createCommentThreadTemplate(_,x,S)}async $setActiveComment(p,_){const x=this._commentControllers.get(p);x&&x.$setActiveComment(_??void 0)}async $updateCommentThreadTemplate(p,_,x){const S=this._commentControllers.get(p);S&&S.$updateCommentThreadTemplate(_,x)}$deleteCommentThread(p,_){this._commentControllers.get(p)?.$deleteCommentThread(_)}async $updateCommentThread(p,_,x){this._commentControllers.get(p)?.$updateCommentThread(_,x)}async $provideCommentingRanges(p,_,x){const S=this._commentControllers.get(p);if(!S||!S.commentingRangeProvider)return Promise.resolve(void 0);const C=await t.ensureDocumentData(v.revive(_));return xe(async()=>{const T=await S.commentingRangeProvider?.provideCommentingRanges(C.document,x);let O;return Array.isArray(T)?O={ranges:T,fileComments:!1}:T?O={ranges:T.ranges||[],fileComments:T.enableFileComments||!1}:O=T??void 0,O}).then(T=>{let O;return T&&(O={ranges:T.ranges.map(I=>A.from(I)),fileComments:T.fileComments}),O})}$toggleReaction(p,_,x,S,C){const T=this._commentControllers.get(p);return!T||!T.reactionHandler?Promise.resolve(void 0):xe(()=>{const O=T.getCommentThread(_);if(O){const I=O.getCommentByUniqueId(S.uniqueIdInThread);if(T!==void 0&&I&&T.reactionHandler)return T.reactionHandler(I,d(C))}return Promise.resolve(void 0)})}}class r{static{this._handlePool=0}set threadId(p){this._id=p}get threadId(){return this._id}get id(){return this._id}get resource(){return this._uri}get uri(){return this._uri}set range(p){(p===void 0!=(this._range===void 0)||!p||!this._range||!p.isEqual(this._range))&&(this._range=p,this.modifications.range=p,this._onDidUpdateCommentThread.fire())}get range(){return this._range}set canReply(p){this._canReply!==p&&(this._canReply=p,this.modifications.canReply=p,this._onDidUpdateCommentThread.fire())}get canReply(){return this._canReply}get label(){return this._label}set label(p){this._label=p,this.modifications.label=p,this._onDidUpdateCommentThread.fire()}get contextValue(){return this._contextValue}set contextValue(p){this._contextValue=p,this.modifications.contextValue=p,this._onDidUpdateCommentThread.fire()}get comments(){return this._comments}set comments(p){this._comments=p,this.modifications.comments=p,this._onDidUpdateCommentThread.fire()}get collapsibleState(){return this._collapseState}set collapsibleState(p){this._collapseState!==p&&(this._collapseState=p,this.modifications.collapsibleState=p,this._onDidUpdateCommentThread.fire())}get state(){return this._state}set state(p){this._state=p,typeof p=="object"?(b(this.extensionDescription,"commentThreadApplicability"),this.modifications.state=p.resolved,this.modifications.applicability=p.applicability):this.modifications.state=p,this._onDidUpdateCommentThread.fire()}get isDisposed(){return this._isDiposed}constructor(p,_,x,S,C,T,O,I,B){this._commentControllerHandle=_,this._id=x,this._uri=S,this._range=C,this._comments=T,this.extensionDescription=O,this._isTemplate=I,this.handle=r._handlePool++,this.commentHandle=0,this.modifications=Object.create(null),this._onDidUpdateCommentThread=new D,this.onDidUpdateCommentThread=this._onDidUpdateCommentThread.event,this._canReply=!0,this._commentsMap=new Map,this._acceptInputDisposables=new Ht,this._acceptInputDisposables.value=new N,this._id===void 0&&(this._id=`${p}.${this.handle}`),i.$createCommentThread(_,this.handle,this._id,this._uri,A.from(this._range),this._comments.map(K=>o(this,K,this._commentsMap,this.extensionDescription)),O.identifier,this._isTemplate,B),this._localDisposables=[],this._isDiposed=!1,this._localDisposables.push(this.onDidUpdateCommentThread(()=>{this.eventuallyUpdateCommentThread()})),this._localDisposables.push({dispose:()=>{i.$deleteCommentThread(_,this.handle)}});const Q=this;this.value={get uri(){return Q.uri},get range(){return Q.range},set range(K){Q.range=K},get comments(){return Q.comments},set comments(K){Q.comments=K},get collapsibleState(){return Q.collapsibleState},set collapsibleState(K){Q.collapsibleState=K},get canReply(){return Q.canReply},set canReply(K){Q.canReply=K},get contextValue(){return Q.contextValue},set contextValue(K){Q.contextValue=K},get label(){return Q.label},set label(K){Q.label=K},get state(){return Q.state},set state(K){Q.state=K},reveal:(K,ze)=>Q.reveal(K,ze),hide:()=>Q.hide(),dispose:()=>{Q.dispose()}}}updateIsTemplate(){this._isTemplate&&(this._isTemplate=!1,this.modifications.isTemplate=!1)}eventuallyUpdateCommentThread(){if(this._isDiposed)return;this.updateIsTemplate(),this._acceptInputDisposables.value||(this._acceptInputDisposables.value=new N);const p=x=>Object.prototype.hasOwnProperty.call(this.modifications,x),_={};p("range")&&(_.range=A.from(this._range)),p("label")&&(_.label=this.label),p("contextValue")&&(_.contextValue=this.contextValue??null),p("comments")&&(_.comments=this._comments.map(x=>o(this,x,this._commentsMap,this.extensionDescription))),p("collapsibleState")&&(_.collapseState=h(this._collapseState)),p("canReply")&&(_.canReply=this.canReply),p("state")&&(_.state=f(this._state)),p("applicability")&&(_.applicability=m(this._state)),p("isTemplate")&&(_.isTemplate=this._isTemplate),this.modifications={},i.$updateCommentThread(this._commentControllerHandle,this.handle,this._id,this._uri,_)}getCommentByUniqueId(p){for(const _ of this._commentsMap){const x=_[0],S=_[1];if(p===S)return x}}async reveal(p,_){b(this.extensionDescription,"commentReveal");let x;p&&p.body!==void 0?x=p:_=_??p;let S=x?this._commentsMap.get(x):void 0;S??=this._commentsMap.get(this._comments[0]);let C=!0,T=!1;return _?.focus===eo.Reply?(T=!0,C=!1):_?.focus===eo.Comment&&(C=!1),i.$revealCommentThread(this._commentControllerHandle,this.handle,S,{preserveFocus:C,focusReply:T})}async hide(){return i.$hideCommentThread(this._commentControllerHandle,this.handle)}dispose(){this._isDiposed=!0,this._acceptInputDisposables.dispose(),this._localDisposables.forEach(p=>p.dispose())}}class n{get id(){return this._id}get label(){return this._label}get handle(){return this._handle}get commentingRangeProvider(){return this._commentingRangeProvider}set commentingRangeProvider(p){this._commentingRangeProvider=p,p?.resourceHints&&b(this._extension,"commentingRangeHint"),i.$updateCommentingRanges(this.handle,p?.resourceHints)}get reactionHandler(){return this._reactionHandler}set reactionHandler(p){this._reactionHandler=p,i.$updateCommentControllerFeatures(this.handle,{reactionHandler:!!p})}get options(){return this._options}set options(p){this._options=p,i.$updateCommentControllerFeatures(this.handle,{options:this._options})}get activeComment(){return b(this._extension,"activeComment"),this._activeComment}get activeCommentThread(){return b(this._extension,"activeComment"),this._activeThread?.value}constructor(p,_,x,S){this._extension=p,this._handle=_,this._id=x,this._label=S,this._threads=new Map,i.$registerCommentController(this.handle,x,S,this._extension.identifier.value);const C=this;this.value=Object.freeze({id:C.id,label:C.label,get options(){return C.options},set options(T){C.options=T},get commentingRangeProvider(){return C.commentingRangeProvider},set commentingRangeProvider(T){C.commentingRangeProvider=T},get reactionHandler(){return C.reactionHandler},set reactionHandler(T){C.reactionHandler=T},get activeCommentThread(){return C.activeCommentThread},createCommentThread(T,O,I){return C.createCommentThread(T,O,I).value},dispose:()=>{C.dispose()}}),this._localDisposables=[],this._localDisposables.push({dispose:()=>{i.$unregisterCommentController(this.handle)}})}createCommentThread(p,_,x){const S=new r(this.id,this.handle,void 0,p,_,x,this._extension,!1);return this._threads.set(S.handle,S),S}$setActiveComment(p){if(!p){this._activeComment=void 0,this._activeThread=void 0;return}const _=this._threads.get(p.commentThreadHandle);_&&(this._activeComment=p.uniqueIdInThread?_.getCommentByUniqueId(p.uniqueIdInThread):void 0,this._activeThread=_)}$createCommentThreadTemplate(p,_,x){const S=new r(this.id,this.handle,void 0,v.revive(p),A.to(_),[],this._extension,!0,x);return S.collapsibleState=gs.Expanded,this._threads.set(S.handle,S),S}$updateCommentThreadTemplate(p,_){const x=this._threads.get(p);x&&(x.range=A.to(_))}$updateCommentThread(p,_){const x=this._threads.get(p);if(!x)return;(C=>Object.prototype.hasOwnProperty.call(_,C))("collapseState")&&(x.collapsibleState=h(_.collapseState))}$deleteCommentThread(p){this._threads.get(p)?.dispose(),this._threads.delete(p)}getCommentThread(p){return this._threads.get(p)}dispose(){this._threads.forEach(p=>{p.dispose()}),this._localDisposables.forEach(p=>p.dispose())}}function o(l,p,_,x){let S=_.get(p);return S||(S=++l.commentHandle,_.set(p,S)),p.state!==void 0&&b(x,"commentsDraftState"),p.reactions?.some(C=>C.reactors!==void 0)&&b(x,"commentReactor"),{mode:p.mode,contextValue:p.contextValue,uniqueIdInThread:S,body:typeof p.body=="string"?p.body:ae.from(p.body),userName:p.author.name,userIconPath:p.author.iconPath,label:p.label,commentReactions:p.reactions?p.reactions.map(C=>c(C)):void 0,state:p.state,timestamp:p.timestamp?.toJSON()}}function c(l){return{label:l.label,iconPath:l.iconPath?Kg(l.iconPath):void 0,count:l.count,hasReacted:l.authorHasReacted,reactors:l.reactors&&l.reactors.length>0&&typeof l.reactors[0]!="string"?l.reactors.map(p=>p.name):l.reactors}}function d(l){return{label:l.label||"",count:l.count||0,iconPath:l.iconPath?v.revive(l.iconPath):"",authorHasReacted:l.hasReacted||!1,reactors:l.reactors?.map(p=>({name:p}))}}function h(l){if(l!==void 0)switch(l){case Zn.Expanded:return gs.Expanded;case Zn.Collapsed:return gs.Collapsed}return gs.Collapsed}function f(l){let p;if(typeof l=="object"?p=l.resolved:p=l,p!==void 0)switch(p){case to.Unresolved:return Ur.Unresolved;case to.Resolved:return Ur.Resolved}return Ur.Unresolved}function m(l){let p;if(typeof l=="object"&&(p=l.applicability),p!==void 0)switch(p){case io.Current:return Wr.Current;case io.Outdated:return Wr.Outdated}return Wr.Current}return new s}class Jw{#e;#t;#i;#s;#n;#r;#a;#o;#c;#d;#l;#u;constructor(e,t,i,s,r,n,o){this.#a="",this.#c=!1,this.#d=!1,this._onMessageEmitter=new D,this.onDidReceiveMessage=this._onMessageEmitter.event,this.#h=new D,this._onDidDispose=this.#h.event,this.#e=e,this.#t=t,this.#o=i,this.#s=s,this.#n=r,this.#r=n,this.#l=yi(n),this.#u=Xw(n),this.#i=o}#h;dispose(){this.#c=!0,this.#h.fire(),this.#h.dispose(),this._onMessageEmitter.dispose()}asWebviewUri(e){return this.#d=!0,Yi(e,this.#s)}get cspSource(){const e=this.#r.extensionLocation;if(e.scheme===G.https||e.scheme===G.http){let t=e.toString();return t.endsWith("/")||(t+="/"),t+" "+ra}return ra}get html(){return this.assertNotDisposed(),this.#a}set html(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#u&&!this.#d&&/(["'])vscode-resource:([^\s'"]+?)(["'])/i.test(e)&&(this.#d=!0,this.#i.report("Webview vscode-resource: uris",this.#r,"Please migrate to use the 'webview.asWebviewUri' api instead: https://aka.ms/vscode-webview-use-aswebviewuri")),this.#t.$setHtml(this.#e,this.rewriteOldResourceUrlsIfNeeded(e)))}get options(){return this.assertNotDisposed(),this.#o}set options(e){this.assertNotDisposed(),Tl(this.#o,e)||this.#t.$setOptions(this.#e,gu(this.#r,this.#n,e)),this.#o=e}async postMessage(e){if(this.#c)return!1;const t=Qg(e,{serializeBuffersForPostMessage:this.#l});return this.#t.$postMessage(this.#e,t.message,...t.buffers)}assertNotDisposed(){if(this.#c)throw new Error("Webview is disposed")}rewriteOldResourceUrlsIfNeeded(e){if(!this.#u)return e;const t=this.#r.extensionLocation?.scheme===G.vscodeRemote,i=this.#r.extensionLocation.scheme===G.vscodeRemote?this.#r.extensionLocation.authority:void 0;return e.replace(/(["'])(?:vscode-resource):(\/\/([^\s\/'"]+?)(?=\/))?([^\s'"]+?)(["'])/gi,(s,r,n,o,c,d)=>{const h=v.from({scheme:o||"file",path:decodeURIComponent(c)}),f=Yi(h,{isRemote:t,authority:i}).toString();return`${r}${f}${d}`}).replace(/(["'])(?:vscode-webview-resource):(\/\/[^\s\/'"]+\/([^\s\/'"]+?)(?=\/))?([^\s'"]+?)(["'])/gi,(s,r,n,o,c,d)=>{const h=v.from({scheme:o||"file",path:decodeURIComponent(c)}),f=Yi(h,{isRemote:t,authority:i}).toString();return`${r}${f}${d}`})}}function yi(a){try{const e=Ch(Dh(a.engines.vscode));return!!e&&e.majorBase>=1&&e.minorBase>=57}catch{return!1}}function Xw(a){try{const e=Ch(Dh(a.engines.vscode));return e?e.majorBase<1||e.majorBase===1&&e.minorBase<60:!1}catch{return!1}}class Yw extends Z{constructor(e,t,i,s,r){super(),this.remoteInfo=t,this.workspace=i,this._logService=s,this._deprecationService=r,this._webviews=new Map,this._webviewProxy=e.getProxy(k.MainThreadWebviews)}dispose(){super.dispose();for(const e of this._webviews.values())e.dispose();this._webviews.clear()}$onMessage(e,t,i){const s=this.getWebview(e);if(s){const{message:r}=Gg(t,i.value);s._onMessageEmitter.fire(r)}}$onMissingCsp(e,t){this._logService.warn(`${t} created a webview without a content security policy: https://aka.ms/vscode-webview-missing-csp`)}createNewWebview(e,t,i){const s=new Jw(e,this._webviewProxy,Zw(t),this.remoteInfo,this.workspace,i,this._deprecationService);this._webviews.set(e,s);const r=s._onDidDispose(()=>{r.dispose(),this.deleteWebview(e)});return s}deleteWebview(e){this._webviews.delete(e)}getWebview(e){return this._webviews.get(e)}}function mr(a){return{id:a.identifier,location:a.extensionLocation}}function gu(a,e,t){return{enableCommandUris:t.enableCommandUris,enableScripts:t.enableScripts,enableForms:t.enableForms,portMapping:t.portMapping,localResourceRoots:t.localResourceRoots||ex(a,e)}}function Zw(a){return{enableCommandUris:a.enableCommandUris,enableScripts:a.enableScripts,enableForms:a.enableForms,portMapping:a.portMapping,localResourceRoots:a.localResourceRoots?.map(e=>v.from(e))}}function ex(a,e){return[...(e?.getWorkspaceFolders()||[]).map(t=>t.uri),a.extensionLocation]}class He{static{this.enableDebugLogging=!1}constructor(e){this.id=e,this._data=new Map,this._idPool=1}add(e){const t=this._idPool++;return this._data.set(t,e),this.logDebugInfo(),t}get(e,t){return this._data.has(e)?this._data.get(e)[t]:void 0}delete(e){this._data.delete(e),this.logDebugInfo()}logDebugInfo(){He.enableDebugLogging&&console.log(`${this.id} cache size - ${this._data.size}`)}}class tx{constructor(e,t){this.document=e,this._storagePath=t,this._backupCounter=1,this._edits=new He("custom documents")}addEdit(e){return this._edits.add([e])}async undo(e,t){await this.getEdit(e).undo(),t||this.disposeBackup()}async redo(e,t){await this.getEdit(e).redo(),t||this.disposeBackup()}disposeEdits(e){for(const t of e)this._edits.delete(t)}getNewBackupUri(){if(!this._storagePath)throw new Error("Backup requires a valid storage path");const e=ax(this.document.uri)+this._backupCounter++;return er(this._storagePath,e)}updateBackup(e){this._backup?.delete(),this._backup=e}disposeBackup(){this._backup?.delete(),this._backup=void 0}getEdit(e){const t=this._edits.get(e,0);if(!t)throw new Error("No edit found");return t}}class ix{constructor(){this._documents=new Map}get(e,t){return this._documents.get(this.key(e,t))}add(e,t,i){const s=this.key(e,t.uri);if(this._documents.has(s))throw new Error(`Document already exists for viewType:${e} resource:${t.uri}`);const r=new tx(t,i);return this._documents.set(s,r),r}delete(e,t){const i=this.key(e,t.uri);this._documents.delete(i)}key(e,t){return`${e}@@@${t}`}}var yt;(function(a){a[a.Text=0]="Text",a[a.Custom=1]="Custom"})(yt||(yt={}));class sx{constructor(){this._providers=new Map}addTextProvider(e,t,i){return this.add(e,{type:yt.Text,extension:t,provider:i})}addCustomProvider(e,t,i){return this.add(e,{type:yt.Custom,extension:t,provider:i})}get(e){return this._providers.get(e)}add(e,t){if(this._providers.has(e))throw new Error(`Provider for viewType:${e} already registered`);return this._providers.set(e,t),new W(()=>this._providers.delete(e))}}class rx{constructor(e,t,i,s,r){this._extHostDocuments=t,this._extensionStoragePaths=i,this._extHostWebview=s,this._extHostWebviewPanels=r,this._editorProviders=new sx,this._documents=new ix,this._proxy=e.getProxy(k.MainThreadCustomEditors)}registerCustomEditorProvider(e,t,i,s){const r=new N;return nx(i)?(r.add(this._editorProviders.addTextProvider(t,e,i)),this._proxy.$registerTextEditorProvider(mr(e),t,s.webviewOptions||{},{supportsMove:!!i.moveCustomTextEditor},yi(e))):(r.add(this._editorProviders.addCustomProvider(t,e,i)),ws(i)&&r.add(i.onDidChangeCustomDocument(n=>{const o=this.getCustomDocumentEntry(t,n.document.uri);if(ox(n)){const c=o.addEdit(n);this._proxy.$onDidEdit(n.document.uri,t,c,n.label)}else this._proxy.$onContentChange(n.document.uri,t)})),this._proxy.$registerCustomEditorProvider(mr(e),t,s.webviewOptions||{},!!s.supportsMultipleEditorsPerDocument,yi(e))),W.from(r,new W(()=>{this._proxy.$unregisterEditorProvider(t)}))}async $createCustomDocument(e,t,i,s,r){const n=this._editorProviders.get(t);if(!n)throw new Error(`No provider found for '${t}'`);if(n.type!==yt.Custom)throw new Error(`Invalid provide type for '${t}'`);const o=v.revive(e),c=await n.provider.openCustomDocument(o,{backupId:i,untitledDocumentData:s?.buffer},r);let d;return ws(n.provider)&&this._extensionStoragePaths&&(d=this._extensionStoragePaths.workspaceValue(n.extension)??this._extensionStoragePaths.globalValue(n.extension)),this._documents.add(t,c,d),{editable:ws(n.provider)}}async $disposeCustomDocument(e,t){const i=this._editorProviders.get(t);if(!i)throw new Error(`No provider found for '${t}'`);if(i.type!==yt.Custom)throw new Error(`Invalid provider type for '${t}'`);const s=v.revive(e),{document:r}=this.getCustomDocumentEntry(t,s);this._documents.delete(t,r),r.dispose()}async $resolveCustomEditor(e,t,i,s,r,n){const o=this._editorProviders.get(i);if(!o)throw new Error(`No provider found for '${i}'`);const c=we.to(r),d=this._extHostWebview.createNewWebview(t,s.contentOptions,o.extension),h=this._extHostWebviewPanels.createNewWebviewPanel(t,i,s.title,c,s.options,d,s.active),f=v.revive(e);switch(o.type){case yt.Custom:{const{document:m}=this.getCustomDocumentEntry(i,f);return o.provider.resolveCustomEditor(m,h,n)}case yt.Text:{const m=this._extHostDocuments.getDocument(f);return o.provider.resolveCustomTextEditor(m,h,n)}default:throw new Error("Unknown webview provider type")}}$disposeEdits(e,t,i){this.getCustomDocumentEntry(t,e).disposeEdits(i)}async $onMoveCustomEditor(e,t,i){const s=this._editorProviders.get(i);if(!s)throw new Error(`No provider found for '${i}'`);if(!s.provider.moveCustomTextEditor)throw new Error(`Provider does not implement move '${i}'`);const r=this._extHostWebviewPanels.getWebviewPanel(e);if(!r)throw new Error("No webview found");const n=v.revive(t),o=this._extHostDocuments.getDocument(n);await s.provider.moveCustomTextEditor(o,r,de.None)}async $undo(e,t,i,s){return this.getCustomDocumentEntry(t,e).undo(i,s)}async $redo(e,t,i,s){return this.getCustomDocumentEntry(t,e).redo(i,s)}async $revert(e,t,i){const s=this.getCustomDocumentEntry(t,e);await this.getCustomEditorProvider(t).revertCustomDocument(s.document,i),s.disposeBackup()}async $onSave(e,t,i){const s=this.getCustomDocumentEntry(t,e);await this.getCustomEditorProvider(t).saveCustomDocument(s.document,i),s.disposeBackup()}async $onSaveAs(e,t,i,s){const r=this.getCustomDocumentEntry(t,e);return this.getCustomEditorProvider(t).saveCustomDocumentAs(r.document,v.revive(i),s)}async $backup(e,t,i){const s=this.getCustomDocumentEntry(t,e),n=await this.getCustomEditorProvider(t).backupCustomDocument(s.document,{destination:s.getNewBackupUri()},i);return s.updateBackup(n),n.id}getCustomDocumentEntry(e,t){const i=this._documents.get(e,v.revive(t));if(!i)throw new Error("No custom document found");return i}getCustomEditorProvider(e){const i=this._editorProviders.get(e)?.provider;if(!i||!ws(i))throw new Error("Custom document is not editable");return i}}function ws(a){return!!a.onDidChangeCustomDocument}function nx(a){return typeof a.resolveCustomTextEditor=="function"}function ox(a){return typeof a.undo=="function"&&typeof a.redo=="function"}function ax(a){const e=a.scheme===G.file||a.scheme===G.untitled?a.fsPath:a.toString();return Cl(e)+""}var Rt;class _r{#e;#t;#i;constructor(e,t,i,s,r,n,o,c){this._name=e,this._owner=t,this._maxDiagnosticsTotal=i,this._maxDiagnosticsPerFile=s,this._modelVersionIdProvider=r,this._isDisposed=!1,this._maxDiagnosticsTotal=Math.max(s,i),this.#i=new et(d=>n.getComparisonKey(d)),this.#e=o,this.#t=c}dispose(){this._isDisposed||(this.#t.fire([...this.#i.keys()]),this.#e?.$clear(this._owner),this.#i.clear(),this._isDisposed=!0)}get name(){return this._checkDisposed(),this._name}set(e,t){if(!e){this.clear();return}this._checkDisposed();let i=[];if(v.isUri(e)){if(!t){this.delete(e);return}this.#i.set(e,t.slice()),i=[e]}else if(Array.isArray(e)){i=[];let n;e=[...e].sort(_r._compareIndexedTuplesByUri);for(const o of e){const[c,d]=o;if((!n||c.toString()!==n.toString())&&(n&&this.#i.get(n).length===0&&this.#i.delete(n),n=c,i.push(c),this.#i.set(c,[])),d)this.#i.get(c)?.push(...d);else{const h=this.#i.get(c);h&&(h.length=0)}}}if(this.#t.fire(i),!this.#e)return;const s=[];let r=0;for(const n of i){let o=[];const c=this.#i.get(n);if(c)if(c.length>this._maxDiagnosticsPerFile){o=[];const d=[Ni.Error,Ni.Warning,Ni.Information,Ni.Hint];e:for(let h=0;h<4;h++)for(const f of c)if(f.severity===d[h]&&o.push({...cr.from(f),modelVersionId:this._modelVersionIdProvider(n)})===this._maxDiagnosticsPerFile)break e;o.push({severity:uf.Info,message:j(2579,"Not showing {0} further errors and warnings.",c.length-this._maxDiagnosticsPerFile),startLineNumber:o[o.length-1].startLineNumber,startColumn:o[o.length-1].startColumn,endLineNumber:o[o.length-1].endLineNumber,endColumn:o[o.length-1].endColumn})}else o=c.map(d=>({...cr.from(d),modelVersionId:this._modelVersionIdProvider(n)}));if(s.push([n,o]),r+=o.length,r>this._maxDiagnosticsTotal)break}this.#e.$changeMany(this._owner,s)}delete(e){this._checkDisposed(),this.#t.fire([e]),this.#i.delete(e),this.#e?.$changeMany(this._owner,[[e,void 0]])}clear(){this._checkDisposed(),this.#t.fire([...this.#i.keys()]),this.#i.clear(),this.#e?.$clear(this._owner)}forEach(e,t){this._checkDisposed();for(const[i,s]of this)e.call(t,i,s,this)}*[Symbol.iterator](){this._checkDisposed();for(const e of this.#i.keys())yield[e,this.get(e)]}get(e){this._checkDisposed();const t=this.#i.get(e);return Array.isArray(t)?Object.freeze(t.slice(0)):[]}has(e){return this._checkDisposed(),Array.isArray(this.#i.get(e))}_checkDisposed(){if(this._isDisposed)throw new Error("illegal state - object is disposed")}static _compareIndexedTuplesByUri(e,t){return e[0].toString()<t[0].toString()?-1:e[0].toString()>t[0].toString()?1:0}}let na=class{static{Rt=this}static{this._idPool=0}static{this._maxDiagnosticsPerFile=1e3}static{this._maxDiagnosticsTotal=1.1*this._maxDiagnosticsPerFile}static _mapper(e){const t=new et;for(const i of e)t.set(i,i);return{uris:Object.freeze(Array.from(t.values()))}}constructor(e,t,i,s){this._logService=t,this._fileSystemInfoService=i,this._extHostDocumentsAndEditors=s,this._collections=new Map,this._onDidChangeDiagnostics=new hf({merge:r=>r.flat(),delay:50}),this.onDidChangeDiagnostics=Ee.map(this._onDidChangeDiagnostics.event,Rt._mapper),this._proxy=e.getProxy(k.MainThreadDiagnostics)}createDiagnosticCollection(e,t){const{_collections:i,_proxy:s,_onDidChangeDiagnostics:r,_logService:n,_fileSystemInfoService:o,_extHostDocumentsAndEditors:c}=this,d=new class{$changeMany(m,l){s.$changeMany(m,l),n.trace("[DiagnosticCollection] change many (extension, owner, uris)",e.value,m,l.length===0?"CLEARING":l)}$clear(m){s.$clear(m),n.trace("[DiagnosticCollection] remove all (extension, owner)",e.value,m)}dispose(){s.dispose()}};let h;if(!t)t="_generated_diagnostic_collection_name_#"+Rt._idPool++,h=t;else if(!i.has(t))h=t;else{this._logService.warn(`DiagnosticCollection with name '${t}' does already exist.`);do h=t+Rt._idPool++;while(i.has(h))}return new class extends _r{constructor(){super(t,h,Rt._maxDiagnosticsTotal,Rt._maxDiagnosticsPerFile,m=>c.getDocument(m)?.version,o.extUri,d,r),i.set(h,this)}dispose(){super.dispose(),i.delete(h)}}}getDiagnostics(e){if(e)return this._getDiagnostics(e);{const t=new Map,i=[];for(const s of this._collections.values())s.forEach((r,n)=>{let o=t.get(r.toString());typeof o>"u"&&(o=i.length,t.set(r.toString(),o),i.push([r,[]])),i[o][1]=i[o][1].concat(...n)});return i}}_getDiagnostics(e){let t=[];for(const i of this._collections.values())i.has(e)&&(t=t.concat(i.get(e)));return t}$acceptMarkersChange(e){if(!this._mirrorCollection){const t="_generated_mirror",i=new _r(t,t,Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER,s=>{},this._fileSystemInfoService.extUri,void 0,this._onDidChangeDiagnostics);this._collections.set(t,i),this._mirrorCollection=i}for(const[t,i]of e)this._mirrorCollection.set(v.revive(t),i.map(cr.to))}};na=Rt=L([E(1,se),E(2,wi)],na);class cx{constructor(e){this._proxy=e.getProxy(k.MainThreadDialogs)}showOpenDialog(e){return this._proxy.$showOpenDialog(e).then(t=>t?t.map(i=>v.revive(i)):void 0)}showSaveDialog(e){return this._proxy.$showSaveDialog(e).then(t=>t?v.revive(t):void 0)}}class ic{static{this._handlePool=0}constructor(e,t,i){this._documentsAndEditors=t,this._logService=i,this._documentContentProviders=new Map,this._proxy=e.getProxy(k.MainThreadDocumentContentProviders)}registerTextDocumentContentProvider(e,t){if(Object.keys(G).indexOf(e)>=0)throw new Error(`scheme '${e}' already registered`);const i=ic._handlePool++;this._documentContentProviders.set(i,t),this._proxy.$registerTextContentProvider(i,e);let s;if(typeof t.onDidChange=="function"){let r;s=t.onDidChange(async n=>{if(n.scheme!==e){this._logService.warn(`Provider for scheme '${e}' is firing event for schema '${n.scheme}' which will be IGNORED`);return}if(!this._documentsAndEditors.getDocument(n))return;r&&await r;const o=this.$provideTextDocumentContent(i,n).then(async c=>{if(!c&&typeof c!="string")return;const d=this._documentsAndEditors.getDocument(n);if(!d)return;const h=pf(c);if(!d.equalLines(h))return this._proxy.$onVirtualDocumentChange(n,c)}).catch(Sa).finally(()=>{r===o&&(r=void 0)});r=o})}return new W(()=>{this._documentContentProviders.delete(i)&&this._proxy.$unregisterTextContentProvider(i),s&&(s.dispose(),s=void 0)})}$provideTextDocumentContent(e,t){const i=this._documentContentProviders.get(e);return i?Promise.resolve(i.provideTextDocumentContent(v.revive(t),de.None)):Promise.reject(new Error(`unsupported uri-scheme: ${t.scheme}`))}}class dx{constructor(e,t,i,s={timeout:1500,errors:3}){this._logService=e,this._documents=t,this._mainThreadBulkEdits=i,this._thresholds=s,this._callbacks=new ff,this._badListeners=new WeakMap}dispose(){this._callbacks.clear()}getOnWillSaveTextDocumentEvent(e){return(t,i,s)=>{const n={dispose:this._callbacks.push([t,i,e])};return Array.isArray(s)&&s.push(n),n}}async $participateInSave(e,t){const i=v.revive(e);let s=!1;const r=setTimeout(()=>s=!0,this._thresholds.timeout),n=[];try{for(const o of[...this._callbacks]){if(s)break;const c=this._documents.getDocument(i),d=await this._deliverEventAsyncAndBlameBadListeners(o,{document:c,reason:Ph.to(t)});n.push(d)}}finally{clearTimeout(r)}return n}_deliverEventAsyncAndBlameBadListeners([e,t,i],s){const r=this._badListeners.get(e);return typeof r=="number"&&r>this._thresholds.errors?Promise.resolve(!1):this._deliverEventAsync(i,e,t,s).then(()=>!0,n=>{if(this._logService.error(`onWillSaveTextDocument-listener from extension '${i.identifier.value}' threw ERROR`),this._logService.error(n),!(n instanceof Error)||n.message!=="concurrent_edits"){const o=this._badListeners.get(e);this._badListeners.set(e,o?o+1:1),typeof o=="number"&&o>this._thresholds.errors&&this._logService.info(`onWillSaveTextDocument-listener from extension '${i.identifier.value}' will now be IGNORED because of timeouts and/or errors`)}return!1})}_deliverEventAsync(e,t,i,s){const r=[],n=Date.now(),{document:o,reason:c}=s,{version:d}=o,h=Object.freeze({document:o,reason:c,waitUntil(f){if(Object.isFrozen(r))throw gf("waitUntil can not be called async");r.push(Promise.resolve(f))}});try{t.apply(i,[h])}catch(f){return Promise.reject(f)}return new Promise((f,m)=>{const l=setTimeout(()=>m(new Error("timeout")),this._thresholds.timeout);return Promise.all(r).then(p=>{this._logService.debug(`onWillSaveTextDocument-listener from extension '${e.identifier.value}' finished after ${Date.now()-n}ms`),clearTimeout(l),f(p)}).catch(p=>{clearTimeout(l),m(p)})}).then(f=>{const m={edits:[]};for(const l of f)if(Array.isArray(l)&&l.every(p=>p instanceof Th))for(const{newText:p,newEol:_,range:x}of l)m.edits.push({resource:o.uri,versionId:void 0,textEdit:{range:x&&A.from(x),text:p,eol:_&&Hl.from(_)}});if(m.edits.length!==0)return d===o.version?this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new Qe(m)):Promise.reject(new Error("concurrent_edits"))})}}class lx{constructor(e,t){this._onDidAddDocument=new D,this._onDidRemoveDocument=new D,this._onDidChangeDocument=new D,this._onDidSaveDocument=new D,this.onDidAddDocument=this._onDidAddDocument.event,this.onDidRemoveDocument=this._onDidRemoveDocument.event,this.onDidChangeDocument=this._onDidChangeDocument.event,this.onDidSaveDocument=this._onDidSaveDocument.event,this._toDispose=new N,this._documentLoader=new Map,this._proxy=e.getProxy(k.MainThreadDocuments),this._documentsAndEditors=t,this._documentsAndEditors.onDidRemoveDocuments(i=>{for(const s of i)this._onDidRemoveDocument.fire(s.document)},void 0,this._toDispose),this._documentsAndEditors.onDidAddDocuments(i=>{for(const s of i)this._onDidAddDocument.fire(s.document)},void 0,this._toDispose)}dispose(){this._toDispose.dispose()}getAllDocumentData(){return[...this._documentsAndEditors.allDocuments()]}getDocumentData(e){if(!e)return;const t=this._documentsAndEditors.getDocument(e);if(t)return t}getDocument(e){const t=this.getDocumentData(e);if(!t?.document)throw new Error(`Unable to retrieve document from URI '${e}'`);return t.document}ensureDocumentData(e,t){const i=this._documentsAndEditors.getDocument(e);if(i&&(!t?.encoding||i.document.encoding===t.encoding))return Promise.resolve(i);let s=this._documentLoader.get(e.toString());return s?t?.encoding&&(s=s.then(r=>r.document.encoding!==t.encoding?this.ensureDocumentData(e,t):r)):(s=this._proxy.$tryOpenDocument(e,t).then(r=>{this._documentLoader.delete(e.toString());const n=v.revive(r);return Qs(this._documentsAndEditors.getDocument(n))},r=>(this._documentLoader.delete(e.toString()),Promise.reject(r))),this._documentLoader.set(e.toString(),s)),s}createDocumentData(e){return this._proxy.$tryCreateDocument(e).then(t=>v.revive(t))}$acceptModelLanguageChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");this._onDidRemoveDocument.fire(s.document),s._acceptLanguageId(t),this._onDidAddDocument.fire(s.document)}$acceptModelSaved(e){const t=v.revive(e),i=this._documentsAndEditors.getDocument(t);if(!i)throw new Error("unknown document");this.$acceptDirtyStateChanged(e,!1),this._onDidSaveDocument.fire(i.document)}$acceptDirtyStateChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");s._acceptIsDirty(t),this._onDidChangeDocument.fire({document:s.document,contentChanges:[],reason:void 0})}$acceptEncodingChanged(e,t){const i=v.revive(e),s=this._documentsAndEditors.getDocument(i);if(!s)throw new Error("unknown document");s._acceptEncoding(t),this._onDidChangeDocument.fire({document:s.document,contentChanges:[],reason:void 0})}$acceptModelChanged(e,t,i){const s=v.revive(e),r=this._documentsAndEditors.getDocument(s);if(!r)throw new Error("unknown document");r._acceptIsDirty(i),r.onEvents(t);let n;t.isUndoing?n=so.Undo:t.isRedoing&&(n=so.Redo),this._onDidChangeDocument.fire(mf({document:r.document,contentChanges:t.changes.map(o=>({range:A.to(o.range),rangeOffset:o.rangeOffset,rangeLength:o.rangeLength,text:o.text})),reason:n}))}setWordDefinitionFor(e,t){Ey(e,t)}}class hx{constructor(e){this._provider=new Map,this._onDidChange=new D,this.onDidChange=this._onDidChange.event,this._allKnownModels=new Set,this._handlePool=0,this._proxy=e.getProxy(k.MainThreadEmbeddings)}registerEmbeddingsProvider(e,t,i){if(this._allKnownModels.has(t))throw new Error("An embeddings provider for this model is already registered");const s=this._handlePool++;return this._proxy.$registerEmbeddingProvider(s,t),this._provider.set(s,{id:t,provider:i}),V(()=>{this._allKnownModels.delete(t),this._proxy.$unregisterEmbeddingProvider(s),this._provider.delete(s)})}async computeEmbeddings(e,t,i){i??=de.None;let s=!1;typeof t=="string"&&(t=[t],s=!0);const r=await this._proxy.$computeEmbeddings(e,t,i);if(r.length!==t.length)throw new Error;if(s){if(r.length!==1)throw new Error;return r[0]}return r}async $provideEmbeddings(e,t,i){const s=this._provider.get(e);if(!s)return[];const r=await s.provider.provideEmbeddings(t,i);return r||[]}get embeddingsModels(){return Array.from(this._allKnownModels)}$acceptEmbeddingModels(e){this._allKnownModels=new Set(e),this._onDidChange.fire()}}class ux{constructor(e){this._AiEmbeddingVectorProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiEmbeddingVector)}async $provideAiEmbeddingVector(e,t,i){if(this._AiEmbeddingVectorProviders.size===0)throw new Error("No embedding vector providers registered");const s=this._AiEmbeddingVectorProviders.get(e);if(!s)throw new Error("Embedding vector provider not found");const r=await s.provideEmbeddingVector(t,i);if(!r)throw new Error("Embedding vector provider returned undefined");return r}registerEmbeddingVectorProvider(e,t,i){const s=this._nextHandle;return this._nextHandle++,this._AiEmbeddingVectorProviders.set(s,i),this._proxy.$registerAiEmbeddingVectorProvider(t,s),new W(()=>{this._proxy.$unregisterAiEmbeddingVectorProvider(s),this._AiEmbeddingVectorProviders.delete(s)})}}class px{constructor(){this._schemes=[]}add(e){this._stateMachine=void 0,this._schemes.push(e)}delete(e){const t=this._schemes.indexOf(e);t>=0&&(this._schemes.splice(t,1),this._stateMachine=void 0)}_initStateMachine(){if(!this._stateMachine){const e=this._schemes.sort(),t=[];let i,s,r=at.LastKnownState,n=at.LastKnownState;for(const o of e){let c=i?_f(i,o):0;for(c===0?s=at.Start:s=n;c<o.length;c++)c+1===o.length?(r=n,n=at.BeforeColon):n+=1,t.push([s,o.toUpperCase().charCodeAt(c),n]),t.push([s,o.toLowerCase().charCodeAt(c),n]),s=n;i=o,n=r}t.push([at.BeforeColon,ut.Colon,at.AfterColon]),t.push([at.AfterColon,ut.Slash,at.End]),this._stateMachine=new vf(t)}}provideDocumentLinks(e){this._initStateMachine();const t=[],i=yf.computeLinks({getLineContent(s){return e.lineAt(s-1).text},getLineCount(){return e.lineCount}},this._stateMachine);for(const s of i){const r=Gi.to(s);r.target&&t.push(r)}return t}}class vr{constructor(e,t){this._extHostLanguageFeatures=t,this._linkProvider=new px,this._fsProvider=new Map,this._registeredSchemes=new Set,this._watches=new Map,this._handlePool=0,this._proxy=e.getProxy(k.MainThreadFileSystem)}dispose(){this._linkProviderRegistration?.dispose()}registerFileSystemProvider(e,t,i,s={}){if(vr._validateFileSystemProvider(i),this._registeredSchemes.has(t))throw new Error(`a provider for the scheme '${t}' is already registered`);this._linkProviderRegistration||(this._linkProviderRegistration=this._extHostLanguageFeatures.registerDocumentLinkProvider(e,"*",this._linkProvider));const r=this._handlePool++;this._linkProvider.add(t),this._registeredSchemes.add(t),this._fsProvider.set(r,i);let n=gt.FileReadWrite;s.isCaseSensitive&&(n+=gt.PathCaseSensitive),s.isReadonly&&(n+=gt.Readonly),typeof i.copy=="function"&&(n+=gt.FileFolderCopy),typeof i.open=="function"&&typeof i.close=="function"&&typeof i.read=="function"&&typeof i.write=="function"&&(b(e,"fsChunks"),n+=gt.FileOpenReadWriteClose);let o;s.isReadonly&&kl(s.isReadonly)&&s.isReadonly.value!==""&&(o={value:s.isReadonly.value,isTrusted:s.isReadonly.isTrusted,supportThemeIcons:s.isReadonly.supportThemeIcons,supportHtml:s.isReadonly.supportHtml,baseUri:s.isReadonly.baseUri,uris:s.isReadonly.uris}),this._proxy.$registerFileSystemProvider(r,t,n,o).catch(d=>{console.error(`FAILED to register filesystem provider of ${e.identifier.value}-extension for the scheme ${t}`),console.error(d)});const c=i.onDidChangeFile(d=>{const h=[];for(const f of d){const{uri:m,type:l}=f;if(m.scheme!==t)continue;let p;switch(l){case Hs.Changed:p=Vr.UPDATED;break;case Hs.Created:p=Vr.ADDED;break;case Hs.Deleted:p=Vr.DELETED;break;default:throw new Error("Unknown FileChangeType")}h.push({resource:m,type:p})}this._proxy.$onFileSystemChange(r,h)});return V(()=>{c.dispose(),this._linkProvider.delete(t),this._registeredSchemes.delete(t),this._fsProvider.delete(r),this._proxy.$unregisterProvider(r)})}static _validateFileSystemProvider(e){if(!e)throw new Error("MISSING provider");if(typeof e.watch!="function")throw new Error("Provider does NOT implement watch");if(typeof e.stat!="function")throw new Error("Provider does NOT implement stat");if(typeof e.readDirectory!="function")throw new Error("Provider does NOT implement readDirectory");if(typeof e.createDirectory!="function")throw new Error("Provider does NOT implement createDirectory");if(typeof e.readFile!="function")throw new Error("Provider does NOT implement readFile");if(typeof e.writeFile!="function")throw new Error("Provider does NOT implement writeFile");if(typeof e.delete!="function")throw new Error("Provider does NOT implement delete");if(typeof e.rename!="function")throw new Error("Provider does NOT implement rename")}static _asIStat(e){const{type:t,ctime:i,mtime:s,size:r,permissions:n}=e;return{type:t,ctime:i,mtime:s,size:r,permissions:n}}$stat(e,t){return Promise.resolve(this._getFsProvider(e).stat(v.revive(t))).then(i=>vr._asIStat(i))}$readdir(e,t){return Promise.resolve(this._getFsProvider(e).readDirectory(v.revive(t)))}$readFile(e,t){return Promise.resolve(this._getFsProvider(e).readFile(v.revive(t))).then(i=>be.wrap(i))}$writeFile(e,t,i,s){return Promise.resolve(this._getFsProvider(e).writeFile(v.revive(t),i.buffer,s))}$delete(e,t,i){return Promise.resolve(this._getFsProvider(e).delete(v.revive(t),i))}$rename(e,t,i,s){return Promise.resolve(this._getFsProvider(e).rename(v.revive(t),v.revive(i),s))}$copy(e,t,i,s){const r=this._getFsProvider(e);if(!r.copy)throw new Error('FileSystemProvider does not implement "copy"');return Promise.resolve(r.copy(v.revive(t),v.revive(i),s))}$mkdir(e,t){return Promise.resolve(this._getFsProvider(e).createDirectory(v.revive(t)))}$watch(e,t,i,s){const r=this._getFsProvider(e).watch(v.revive(i),s);this._watches.set(t,r)}$unwatch(e,t){const i=this._watches.get(t);i&&(i.dispose(),this._watches.delete(t))}$open(e,t,i){const s=this._getFsProvider(e);if(!s.open)throw new Error('FileSystemProvider does not implement "open"');return Promise.resolve(s.open(v.revive(t),i))}$close(e,t){const i=this._getFsProvider(e);if(!i.close)throw new Error('FileSystemProvider does not implement "close"');return Promise.resolve(i.close(t))}$read(e,t,i,s){const r=this._getFsProvider(e);if(!r.read)throw new Error('FileSystemProvider does not implement "read"');const n=be.alloc(s);return Promise.resolve(r.read(t,i,n.buffer,0,s)).then(o=>n.slice(0,o))}$write(e,t,i,s){const r=this._getFsProvider(e);if(!r.write)throw new Error('FileSystemProvider does not implement "write"');return Promise.resolve(r.write(t,i,s.buffer,0,s.byteLength))}_getFsProvider(e){const t=this._fsProvider.get(e);if(!t){const i=new Error;throw i.name="ENOPRO",i.message="no provider",i}return t}}class mu extends Z{static{this.MAX_RESTARTS=5}constructor(e,t,i,s){super(),this.onFileChanges=e,this.onLogMessage=t,this.verboseLogging=i,this.options=s,this.watcherDisposables=this._register(new Ht),this.requests=void 0,this.restartCounter=0}init(){const e=new N;this.watcherDisposables.value=e,this.watcher=this.createWatcher(e),this.watcher.setVerboseLogging(this.verboseLogging),e.add(this.watcher.onDidChangeFile(t=>this.onFileChanges(t))),e.add(this.watcher.onDidLogMessage(t=>this.onLogMessage(t))),e.add(this.watcher.onDidError(t=>this.onError(t.error,t.request)))}onError(e,t){this.canRestart(e,t)?this.restartCounter<mu.MAX_RESTARTS&&this.requests?(this.error(`restarting watcher after unexpected error: ${e}`),this.restart(this.requests)):this.error(`gave up attempting to restart watcher after unexpected error: ${e}`):this.error(e)}canRestart(e,t){return!(!this.options.restartOnError||t||e.indexOf("No space left on device")!==-1||e.indexOf("EMFILE")!==-1)}restart(e){this.restartCounter++,this.init(),this.watch(e)}async watch(e){this.requests=e,await this.watcher?.watch(e)}async setVerboseLogging(e){this.verboseLogging=e,await this.watcher?.setVerboseLogging(e)}error(e){this.onLogMessage({type:"error",message:`[File Watcher (${this.options.type})] ${e}`})}trace(e){this.onLogMessage({type:"trace",message:`[File Watcher (${this.options.type})] ${e}`})}dispose(){return this.watcher=void 0,super.dispose()}}function fx(a,e){return typeof e=="string"&&!e.startsWith(Cn)&&!wf(e)?{base:a,pattern:e}:e}class gx{get ignoreCreateEvents(){return!!(this._config&1)}get ignoreChangeEvents(){return!!(this._config&2)}get ignoreDeleteEvents(){return!!(this._config&4)}constructor(e,t,i,s,r,n,o){this.session=Math.random(),this._onDidCreate=new D,this._onDidChange=new D,this._onDidDelete=new D,this._config=0,o.ignoreCreateEvents&&(this._config+=1),o.ignoreChangeEvents&&(this._config+=2),o.ignoreDeleteEvents&&(this._config+=4);const c=En(n),d=typeof n=="string",h=r(f=>{if(!(typeof f.session=="number"&&f.session!==this.session)){if(!o.ignoreCreateEvents)for(const m of f.created){const l=v.revive(m);c(l.fsPath)&&(!d||i.getWorkspaceFolder(l))&&this._onDidCreate.fire(l)}if(!o.ignoreChangeEvents)for(const m of f.changed){const l=v.revive(m);c(l.fsPath)&&(!d||i.getWorkspaceFolder(l))&&this._onDidChange.fire(l)}if(!o.ignoreDeleteEvents)for(const m of f.deleted){const l=v.revive(m);c(l.fsPath)&&(!d||i.getWorkspaceFolder(l))&&this._onDidDelete.fire(l)}}});this._disposable=W.from(this.ensureWatching(e,i,t,s,n,o,!1),this._onDidCreate,this._onDidChange,this._onDidDelete,h)}ensureWatching(e,t,i,s,r,n,o){const c=W.from();if(typeof r=="string"||n.ignoreChangeEvents&&n.ignoreCreateEvents&&n.ignoreDeleteEvents)return c;const d=e.getProxy(k.MainThreadFileSystemEventService);let h=!1;(r.pattern.includes(Cn)||r.pattern.includes(xf))&&(h=!0);const f=[];let m,l;if(o)(n.ignoreChangeEvents||n.ignoreCreateEvents||n.ignoreDeleteEvents)&&(l=Jt.UPDATED|Jt.ADDED|Jt.DELETED,n.ignoreChangeEvents&&(l&=~Jt.UPDATED),n.ignoreCreateEvents&&(l&=~Jt.ADDED),n.ignoreDeleteEvents&&(l&=~Jt.DELETED));else if(h&&f.length===0){const p=t.getWorkspaceFolder(v.revive(r.baseUri)),_=i.getConfiguration("files",p).get("watcherExclude");if(_)for(const x in _)x&&_[x]===!0&&f.push(x)}else if(!h){const p=t.getWorkspaceFolder(v.revive(r.baseUri));if(p){const _=i.getConfiguration("files",p).get("watcherExclude");if(_){for(const x in _)if(x&&_[x]===!0){const S=`${bf(x,"/")}/${Cn}`;m||(m=[]),m.push(fx(p.uri.fsPath,S))}}if(!m||m.length===0)return c}}return d.$watch(s.identifier.value,this.session,r.baseUri,{recursive:h,excludes:f,includes:m,filter:l},!!o),W.from({dispose:()=>d.$unwatch(this.session)})}dispose(){this._disposable.dispose()}get onDidCreate(){return this._onDidCreate.event}get onDidChange(){return this._onDidChange.event}get onDidDelete(){return this._onDidDelete.event}}class mx{get created(){return this._created.value}get changed(){return this._changed.value}get deleted(){return this._deleted.value}constructor(e){this._events=e,this._created=new Bi(()=>this._events.created.map(v.revive)),this._changed=new Bi(()=>this._events.changed.map(v.revive)),this._deleted=new Bi(()=>this._events.deleted.map(v.revive)),this.session=this._events.session}}class _x{constructor(e,t,i){this._mainContext=e,this._logService=t,this._extHostDocumentsAndEditors=i,this._onFileSystemEvent=new D,this._onDidRenameFile=new D,this._onDidCreateFile=new D,this._onDidDeleteFile=new D,this._onWillRenameFile=new Vi,this._onWillCreateFile=new Vi,this._onWillDeleteFile=new Vi,this.onDidRenameFile=this._onDidRenameFile.event,this.onDidCreateFile=this._onDidCreateFile.event,this.onDidDeleteFile=this._onDidDeleteFile.event}createFileSystemWatcher(e,t,i,s,r){return new gx(this._mainContext,t,e,i,this._onFileSystemEvent.event,Ps.from(s),r)}$onFileEvent(e){this._onFileSystemEvent.fire(new mx(e))}$onDidRunFileOperation(e,t){switch(e){case ct.MOVE:this._onDidRenameFile.fire(Object.freeze({files:t.map(i=>({oldUri:v.revive(i.source),newUri:v.revive(i.target)}))}));break;case ct.DELETE:this._onDidDeleteFile.fire(Object.freeze({files:t.map(i=>v.revive(i.target))}));break;case ct.CREATE:case ct.COPY:this._onDidCreateFile.fire(Object.freeze({files:t.map(i=>v.revive(i.target))}));break}}getOnWillRenameFileEvent(e){return this._createWillExecuteEvent(e,this._onWillRenameFile)}getOnWillCreateFileEvent(e){return this._createWillExecuteEvent(e,this._onWillCreateFile)}getOnWillDeleteFileEvent(e){return this._createWillExecuteEvent(e,this._onWillDeleteFile)}_createWillExecuteEvent(e,t){return(i,s,r)=>{const n=function(c){i.call(s,c)};return n.extension=e,t.event(n,void 0,r)}}async $onWillRunFileOperation(e,t,i,s){switch(e){case ct.MOVE:return await this._fireWillEvent(this._onWillRenameFile,{files:t.map(r=>({oldUri:v.revive(r.source),newUri:v.revive(r.target)}))},i,s);case ct.DELETE:return await this._fireWillEvent(this._onWillDeleteFile,{files:t.map(r=>v.revive(r.target))},i,s);case ct.CREATE:case ct.COPY:return await this._fireWillEvent(this._onWillCreateFile,{files:t.map(r=>v.revive(r.target))},i,s)}}async _fireWillEvent(e,t,i,s){const r=new Set,n=[];if(await e.fireAsync(t,s,async(c,d)=>{const h=Date.now(),f=await Promise.resolve(c);f instanceof Va&&(n.push([d.extension,f]),r.add(d.extension.displayName??d.extension.identifier.value)),Date.now()-h>i&&this._logService.warn("SLOW file-participant",d.extension.identifier)}),s.isCancellationRequested||n.length===0)return;const o={edits:[]};for(const[,c]of n){const{edits:d}=Le.from(c,{getTextDocumentVersion:h=>this._extHostDocumentsAndEditors.getDocument(h)?.version,getNotebookDocumentVersion:()=>{}});o.edits=o.edits.concat(d)}return{edit:o,extensionNames:Array.from(r)}}}class vx{constructor(e,t,i,s,r){this._extHostNotebooks=t,this._textDocumentsAndEditors=i,this._commands=s;const n=new H("interactive.open","_interactive.open","Open interactive window and return notebook editor and input URI",[new P("showOptions","Show Options",o=>!0,o=>o),new P("resource","Interactive resource Uri",o=>!0,o=>o),new P("controllerId","Notebook controller Id",o=>!0,o=>o),new P("title","Interactive editor title",o=>!0,o=>o)],new M("Notebook and input URI",o=>{if(r.debug("[ExtHostInteractive] open iw with notebook editor id",o.notebookEditorId),o.notebookEditorId!==void 0){const c=this._extHostNotebooks.getEditorById(o.notebookEditorId);return r.debug("[ExtHostInteractive] notebook editor found",c.id),{notebookUri:v.revive(o.notebookUri),inputUri:v.revive(o.inputUri),notebookEditor:c.apiEditor}}return r.debug("[ExtHostInteractive] notebook editor not found, uris for the interactive document",o.notebookUri,o.inputUri),{notebookUri:v.revive(o.notebookUri),inputUri:v.revive(o.inputUri)}}));this._commands.registerApiCommand(n)}$willAddInteractiveDocument(e,t,i,s){this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({addedDocuments:[{EOL:t,lines:[""],languageId:i,uri:e,isDirty:!1,versionId:1,encoding:"utf8"}]})}$willRemoveInteractiveDocument(e,t){this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({removedDocuments:[e]})}}class yx{constructor(e){this._handlePool=0,this._proxy=e.getProxy(k.MainThreadLabelService)}$registerResourceLabelFormatter(e){const t=this._handlePool++;return this._proxy.$registerResourceLabelFormatter(t,e),V(()=>{this._proxy.$unregisterResourceLabelFormatter(t)})}}class yr{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentSymbols(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentSymbols(i,t);if(!Ta(s))return s[0]instanceof Ih?s.map(Jg.from):yr._asDocumentSymbolTree(s)}static _asDocumentSymbolTree(e){e=e.slice(0).sort((s,r)=>{let n=s.location.range.start.compareTo(r.location.range.start);return n===0&&(n=r.location.range.end.compareTo(s.location.range.end)),n});const t=[],i=[];for(const s of e){const r={name:s.name||"!!MISSING: name!!",kind:uh.from(s.kind),tags:s.tags?.map(Xg.from)||[],detail:"",containerName:s.containerName,range:A.from(s.location.range),selectionRange:A.from(s.location.range),children:[]};for(;;){if(i.length===0){i.push(r),t.push(r);break}const n=i[i.length-1];if(Ut.containsRange(n.range,r.range)&&!Ut.equalsRange(n.range,r.range)){n.children?.push(r),i.push(r);break}i.pop()}}return t}}class xs{constructor(e,t,i,s,r,n){this._documents=e,this._commands=t,this._provider=i,this._extension=s,this._extTelemetry=r,this._logService=n,this._cache=new He("CodeLens"),this._disposables=new Map}async provideCodeLenses(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideCodeLenses(i,t);if(!s||t.isCancellationRequested)return;const r=this._cache.add(s),n=new N;this._disposables.set(r,n);const o={cacheId:r,lenses:[]};for(let c=0;c<s.length;c++){if(!ce.isRange(s[c].range)){console.warn("INVALID code lens, range is not defined",this._extension.identifier.value);continue}o.lenses.push({cacheId:[r,c],range:A.from(s[c].range),command:this._commands.toInternal(s[c].command,n)})}return o}async resolveCodeLens(e,t){const i=e.cacheId&&this._cache.get(...e.cacheId);if(!i)return;let s;if(typeof this._provider.resolveCodeLens!="function"||i.isResolved?s=i:s=await this._provider.resolveCodeLens(i,t),s||(s=i),t.isCancellationRequested)return;const r=e.cacheId&&this._disposables.get(e.cacheId[0]);if(r){if(!s.command){const n=new Error("INVALID code lens resolved, lacks command: "+this._extension.identifier.value);this._extTelemetry.onExtensionError(this._extension.identifier,n),this._logService.error(n);return}return e.command=this._commands.toInternal(s.command,r),e}}releaseCodeLenses(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}}function Ar(a){return Array.isArray(a)?a.map(Vn.from):a?[Vn.from(a)]:[]}class Vd{constructor(e,t){this._documents=e,this._provider=t}async provideDefinition(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideDefinition(s,r,i);return Ar(n)}}class Bd{constructor(e,t){this._documents=e,this._provider=t}async provideDeclaration(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideDeclaration(s,r,i);return Ar(n)}}class zd{constructor(e,t){this._documents=e,this._provider=t}async provideImplementation(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideImplementation(s,r,i);return Ar(n)}}class jd{constructor(e,t){this._documents=e,this._provider=t}async provideTypeDefinition(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideTypeDefinition(s,r,i);return Ar(n)}}class Zi{static{this.HOVER_MAP_MAX_SIZE=10}constructor(e,t){this._documents=e,this._provider=t,this._hoverCounter=0,this._hoverMap=new Map}async provideHover(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t);let o;if(i&&i.verbosityRequest){const f=i.verbosityRequest.previousHover.id,m=this._hoverMap.get(f);if(!m)throw new Error(`Hover with id ${f} not found`);const l={verbosityDelta:i.verbosityRequest.verbosityDelta,previousHover:m};o=await this._provider.provideHover(r,n,s,l)}else o=await this._provider.provideHover(r,n,s);if(!o||Ta(o.contents))return;o.range||(o.range=r.getWordRangeAtPosition(n)),o.range||(o.range=new ce(n,n));const c=Nn.from(o),d=this._hoverCounter;if(this._hoverMap.size===Zi.HOVER_MAP_MAX_SIZE){const f=Math.min(...this._hoverMap.keys());this._hoverMap.delete(f)}return this._hoverMap.set(d,o),this._hoverCounter+=1,{...c,id:d}}releaseHover(e){this._hoverMap.delete(e)}}class qd{constructor(e,t){this._documents=e,this._provider=t}async provideEvaluatableExpression(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideEvaluatableExpression(s,r,i);if(n)return Yg.from(n)}}class Kd{constructor(e,t){this._documents=e,this._provider=t}async provideInlineValues(e,t,i,s){const r=this._documents.getDocument(e),n=await this._provider.provideInlineValues(r,A.to(t),dh.to(i),s);if(Array.isArray(n))return n.map(o=>lh.from(o))}}class Gd{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentHighlights(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideDocumentHighlights(s,r,i);if(Array.isArray(n))return n.map(sh.from)}}class Qd{constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideMultiDocumentHighlights(e,t,i,s){const r=this._documents.getDocument(e),n=i.map(d=>{try{return this._documents.getDocument(d)}catch(h){this._logService.error("Error: Unable to retrieve document from URI: "+d+". Error message: "+h);return}}).filter(d=>d!==void 0),o=te.to(t),c=await this._provider.provideMultiDocumentHighlights(r,o,n,s);if(Array.isArray(c))return c.map(Zg.from)}}class Jd{constructor(e,t){this._documents=e,this._provider=t}async provideLinkedEditingRanges(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.provideLinkedEditingRanges(s,r,i);if(n&&Array.isArray(n.ranges))return{ranges:Re(n.ranges.map(A.from)),wordPattern:n.wordPattern}}}class Xd{constructor(e,t){this._documents=e,this._provider=t}async provideReferences(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t),o=await this._provider.provideReferences(r,n,i,s);if(Array.isArray(o))return o.map(st.from)}}class wt{static{this._maxCodeActionsPerFile=1e3}constructor(e,t,i,s,r,n,o){this._documents=e,this._commands=t,this._diagnostics=i,this._provider=s,this._logService=r,this._extension=n,this._apiDeprecation=o,this._cache=new He("CodeAction"),this._disposables=new Map}async provideCodeActions(e,t,i,s){const r=this._documents.getDocument(e),n=Ef.isISelection(t)?it.to(t):A.to(t),o=[];for(const l of this._diagnostics.getDiagnostics(e))if(n.intersection(l.range)&&o.push(l)>wt._maxCodeActionsPerFile)break;const c={diagnostics:o,only:i.only?new Wa(i.only):void 0,triggerKind:em.to(i.trigger)},d=await this._provider.provideCodeActions(r,n,c,s);if(!Er(d)||s.isCancellationRequested)return;const h=this._cache.add(d),f=new N;this._disposables.set(h,f);const m=[];for(let l=0;l<d.length;l++){const p=d[l];if(p)if(wt._isCommand(p)&&!(p instanceof Ua))this._apiDeprecation.report("CodeActionProvider.provideCodeActions - return commands",this._extension,"Return 'CodeAction' instances instead."),m.push({_isSynthetic:!0,title:p.title,command:this._commands.toInternal(p,f)});else{const _=p;c.only&&(_.kind?c.only.contains(_.kind)||this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${c.only.value}' requested but returned code action is of kind '${_.kind.value}'. Code action will be dropped. Please check 'CodeActionContext.only' to only return requested code actions.`):this._logService.warn(`${this._extension.identifier.value} - Code actions of kind '${c.only.value}' requested but returned code action does not have a 'kind'. Code action will be dropped. Please set 'CodeAction.kind'.`));const x=_.ranges??[];m.push({cacheId:[h,l],title:_.title,command:_.command&&this._commands.toInternal(_.command,f),diagnostics:_.diagnostics&&_.diagnostics.map(cr.from),edit:_.edit&&Le.from(_.edit,void 0),kind:_.kind&&_.kind.value,isPreferred:_.isPreferred,isAI:ie(this._extension,"codeActionAI")?_.isAI:!1,ranges:ie(this._extension,"codeActionRanges")?Re(x.map(A.from)):void 0,disabled:_.disabled?.reason})}}return{cacheId:h,actions:m}}async resolveCodeAction(e,t){const[i,s]=e,r=this._cache.get(i,s);if(!r||wt._isCommand(r))return{};if(!this._provider.resolveCodeAction)return{};const n=await this._provider.resolveCodeAction(r,t)??r;let o;n.edit&&(o=Le.from(n.edit,void 0));let c;if(n.command){const d=this._disposables.get(i);d&&(c=this._commands.toInternal(n.command,d))}return{edit:o,command:c}}releaseCodeActions(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}static _isCommand(e){return typeof e.command=="string"&&typeof e.title=="string"}}class Ii{constructor(e,t,i,s,r){this._proxy=e,this._documents=t,this._provider=i,this._handle=s,this._extension=r,this._editsCache=new He("DocumentPasteEdit.edits")}async prepareDocumentPaste(e,t,i,s){if(!this._provider.prepareDocumentPaste)return;this._cachedPrepare=void 0;const r=this._documents.getDocument(e),n=t.map(f=>A.to(f)),o=dr.toDataTransfer(i,()=>{throw new Sf});if(await this._provider.prepareDocumentPaste(r,n,o,s),s.isCancellationRequested)return;const c=Array.from(o).filter(([,f])=>!(f instanceof dm)),d=new Map,h=await Promise.all(Array.from(c,async([f,m])=>{const l=Ct();return d.set(l,m),[f,await dd.from(f,m,l)]}));return this._cachedPrepare=d,{items:h}}async providePasteEdits(e,t,i,s,r,n){if(!this._provider.provideDocumentPasteEdits)return[];const o=this._documents.getDocument(t),c=i.map(l=>A.to(l)),d=s.items.map(([l,p])=>{const _=this._cachedPrepare?.get(p.id);return _?[l,_]:[l,dd.to(l,p,async x=>(await this._proxy.$resolvePasteFileData(this._handle,e,x)).buffer)]}),h=new Ba(d),f=await this._provider.provideDocumentPasteEdits(o,c,h,{only:r.only?new $h(r.only):void 0,triggerKind:r.triggerKind},n);if(!f||n.isCancellationRequested)return[];const m=this._editsCache.add(f);return f.map((l,p)=>({_cacheId:[m,p],title:l.title??j(2582,"Paste using '{0}' extension",this._extension.displayName||this._extension.name),kind:l.kind,yieldTo:l.yieldTo?.map(_=>_.value),insertText:typeof l.insertText=="string"?l.insertText:{snippet:l.insertText.value},additionalEdit:l.additionalEdit?Le.from(l.additionalEdit,void 0):void 0}))}async resolvePasteEdit(e,t){const[i,s]=e,r=this._editsCache.get(i,s);if(!r||!this._provider.resolveDocumentPasteEdit)return{};const n=await this._provider.resolveDocumentPasteEdit(r,t)??r;return{insertText:n.insertText,additionalEdit:n.additionalEdit?Le.from(n.additionalEdit,void 0):void 0}}releasePasteEdits(e){this._editsCache.delete(e)}}class Yd{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentFormattingEdits(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideDocumentFormattingEdits(s,t,i);if(Array.isArray(r))return r.map(Ke.from)}}class nn{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentRangeFormattingEdits(e,t,i,s){const r=this._documents.getDocument(e),n=A.to(t),o=await this._provider.provideDocumentRangeFormattingEdits(r,n,i,s);if(Array.isArray(o))return o.map(Ke.from)}async provideDocumentRangesFormattingEdits(e,t,i,s){Pl(typeof this._provider.provideDocumentRangesFormattingEdits=="function","INVALID invocation of `provideDocumentRangesFormattingEdits`");const r=this._documents.getDocument(e),n=t.map(A.to),o=await this._provider.provideDocumentRangesFormattingEdits(r,n,i,s);if(Array.isArray(o))return o.map(Ke.from)}}class Zd{constructor(e,t){this._documents=e,this._provider=t,this.autoFormatTriggerCharacters=[]}async provideOnTypeFormattingEdits(e,t,i,s,r){const n=this._documents.getDocument(e),o=te.to(t),c=await this._provider.provideOnTypeFormattingEdits(n,o,i,s,r);if(Array.isArray(c))return c.map(Ke.from)}}class bs{constructor(e,t){this._provider=e,this._logService=t,this._cache=new He("WorkspaceSymbols")}async provideWorkspaceSymbols(e,t){const i=await this._provider.provideWorkspaceSymbols(e,t);if(!Er(i))return{symbols:[]};const s=this._cache.add(i),r={cacheId:s,symbols:[]};for(let n=0;n<i.length;n++){const o=i[n];if(!o||!o.name){this._logService.warn("INVALID SymbolInformation",o);continue}r.symbols.push({...On.from(o),cacheId:[s,n]})}return r}async resolveWorkspaceSymbol(e,t){if(typeof this._provider.resolveWorkspaceSymbol!="function"||!e.cacheId)return e;const i=this._cache.get(...e.cacheId);if(i){const s=await this._provider.resolveWorkspaceSymbol(i,t);return s&&qs(e,On.from(s),!0)}}releaseWorkspaceSymbols(e){this._cache.delete(e)}}class Lt{static supportsResolving(e){return typeof e.prepareRename=="function"}constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideRenameEdits(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t);try{const o=await this._provider.provideRenameEdits(r,n,i,s);return o?Le.from(o):void 0}catch(o){const c=Lt._asMessage(o);return c?{rejectReason:c,edits:void 0}:Promise.reject(o)}}async resolveRenameLocation(e,t,i){if(typeof this._provider.prepareRename!="function")return Promise.resolve(void 0);const s=this._documents.getDocument(e),r=te.to(t);try{const n=await this._provider.prepareRename(s,r,i);let o,c;if(ce.isRange(n)?(o=n,c=s.getText(n)):gn(n)&&(o=n.range,c=n.placeholder),!o||!c)return;if(o.start.line>r.line||o.end.line<r.line){this._logService.warn("INVALID rename location: position line must be within range start/end lines");return}return{range:A.from(o),text:c}}catch(n){const o=Lt._asMessage(n);return o?{rejectReason:o,range:void 0,text:void 0}:Promise.reject(n)}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class li{static{this.languageTriggerKindToVSCodeTriggerKind={[Mc.Invoke]:ro.Invoke,[Mc.Automatic]:ro.Automatic}}constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async supportsAutomaticNewSymbolNamesTriggerKind(){return this._provider.supportsAutomaticTriggerKind}async provideNewSymbolNames(e,t,i,s){const r=this._documents.getDocument(e),n=A.to(t);try{const o=li.languageTriggerKindToVSCodeTriggerKind[i],c=await this._provider.provideNewSymbolNames(r,n,o,s);return c?c.map(d=>typeof d=="string"?{newSymbolName:d}:{newSymbolName:d.newSymbolName,tags:d.tags}):void 0}catch(o){this._logService.error(li._asMessage(o)??JSON.stringify(o,null,"	"));return}}static _asMessage(e){return typeof e=="string"?e:e instanceof Error&&typeof e.message=="string"?e.message:void 0}}class on{constructor(e,t){this.resultId=e,this.tokens=t}}class Ie{constructor(e,t){this._documents=e,this._provider=t,this._nextResultId=1,this._previousResults=new Map}async provideDocumentSemanticTokens(e,t,i){const s=this._documents.getDocument(e),r=t!==0?this._previousResults.get(t):null;let n=typeof r?.resultId=="string"&&typeof this._provider.provideDocumentSemanticTokensEdits=="function"?await this._provider.provideDocumentSemanticTokensEdits(s,r.resultId,i):await this._provider.provideDocumentSemanticTokens(s,i);return r&&this._previousResults.delete(t),n?(n=Ie._fixProvidedSemanticTokens(n),this._send(Ie._convertToEdits(r,n),n)):null}async releaseDocumentSemanticColoring(e){this._previousResults.delete(e)}static _fixProvidedSemanticTokens(e){return Ie._isSemanticTokens(e)?Ie._isCorrectSemanticTokens(e)?e:new nr(new Uint32Array(e.data),e.resultId):Ie._isSemanticTokensEdits(e)?Ie._isCorrectSemanticTokensEdits(e)?e:new Fs(e.edits.map(t=>new Rh(t.start,t.deleteCount,t.data?new Uint32Array(t.data):t.data)),e.resultId):e}static _isSemanticTokens(e){return e&&!!e.data}static _isCorrectSemanticTokens(e){return e.data instanceof Uint32Array}static _isSemanticTokensEdits(e){return e&&Array.isArray(e.edits)}static _isCorrectSemanticTokensEdits(e){for(const t of e.edits)if(!(t.data instanceof Uint32Array))return!1;return!0}static _convertToEdits(e,t){if(!Ie._isSemanticTokens(t)||!e||!e.tokens)return t;const i=e.tokens,s=i.length,r=t.data,n=r.length;let o=0;const c=Math.min(s,n);for(;o<c&&i[o]===r[o];)o++;if(o===s&&o===n)return new Fs([],t.resultId);let d=0;const h=c-o;for(;d<h&&i[s-d-1]===r[n-d-1];)d++;return new Fs([{start:o,deleteCount:s-o-d,data:r.subarray(o,n-d)}],t.resultId)}_send(e,t){if(Ie._isSemanticTokens(e)){const i=this._nextResultId++;return this._previousResults.set(i,new on(e.resultId,e.data)),no({id:i,type:"full",data:e.data})}if(Ie._isSemanticTokensEdits(e)){const i=this._nextResultId++;return Ie._isSemanticTokens(t)?this._previousResults.set(i,new on(t.resultId,t.data)):this._previousResults.set(i,new on(e.resultId)),no({id:i,type:"delta",deltas:(e.edits||[]).map(s=>({start:s.start,deleteCount:s.deleteCount,data:s.data}))})}return null}}class el{constructor(e,t){this._documents=e,this._provider=t}async provideDocumentRangeSemanticTokens(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideDocumentRangeSemanticTokens(s,A.to(t),i);return r?this._send(r):null}_send(e){return no({id:0,type:"full",data:e.data})}}class $t{static supportsResolving(e){return typeof e.resolveCompletionItem=="function"}constructor(e,t,i,s,r){this._documents=e,this._commands=t,this._provider=i,this._apiDeprecation=s,this._extension=r,this._cache=new He("CompletionItem"),this._disposables=new Map}async provideCompletionItems(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t),o=r.getWordRangeAtPosition(n)||new ce(n,n),c=o.with({end:n}),d=new ui,h=await this._provider.provideCompletionItems(r,n,s,tm.to(i));if(!h||s.isCancellationRequested)return;const f=Array.isArray(h)?new or(h):h,m=$t.supportsResolving(this._provider)?this._cache.add(f.items):this._cache.add([]),l=new N;this._disposables.set(m,l);const p=[],_={x:m,[_s.completions]:p,[_s.defaultRanges]:{replace:A.from(o),insert:A.from(c)},[_s.isIncomplete]:f.isIncomplete||void 0,[_s.duration]:d.elapsed()};for(let x=0;x<f.items.length;x++){const S=f.items[x],C=this._convertCompletionItem(S,[m,x],c,o);p.push(C)}return _}async resolveCompletionItem(e,t){if(typeof this._provider.resolveCompletionItem!="function")return;const i=this._cache.get(...e);if(!i)return;const s=this._convertCompletionItem(i,e),r=await this._provider.resolveCompletionItem(i,t);if(!r)return;const n=this._convertCompletionItem(r,e);return(s[U.insertText]!==n[U.insertText]||s[U.insertTextRules]!==n[U.insertTextRules])&&this._apiDeprecation.report("CompletionItem.insertText",this._extension,"extension MAY NOT change 'insertText' of a CompletionItem during resolve"),(s[U.commandIdent]!==n[U.commandIdent]||s[U.commandId]!==n[U.commandId]||!Tl(s[U.commandArguments],n[U.commandArguments]))&&this._apiDeprecation.report("CompletionItem.command",this._extension,"extension MAY NOT change 'command' of a CompletionItem during resolve"),{...s,[U.documentation]:n[U.documentation],[U.detail]:n[U.detail],[U.additionalTextEdits]:n[U.additionalTextEdits],[U.insertText]:n[U.insertText],[U.insertTextRules]:n[U.insertTextRules],[U.commandIdent]:n[U.commandIdent],[U.commandId]:n[U.commandId],[U.commandArguments]:n[U.commandArguments]}}releaseCompletionItems(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_convertCompletionItem(e,t,i,s){const r=this._disposables.get(t[0]);if(!r)throw Error("DisposableStore is missing...");const n=this._commands.toInternal(e.command,r),o={x:t,[U.label]:e.label,[U.kind]:e.kind!==void 0?sm.from(e.kind):void 0,[U.kindModifier]:e.tags&&e.tags.map(im.from),[U.detail]:e.detail,[U.documentation]:typeof e.documentation>"u"?void 0:ae.fromStrict(e.documentation),[U.sortText]:e.sortText!==e.label?e.sortText:void 0,[U.filterText]:e.filterText!==e.label?e.filterText:void 0,[U.preselect]:e.preselect||void 0,[U.insertTextRules]:e.keepWhitespace?Br.KeepWhitespace:Br.None,[U.commitCharacters]:e.commitCharacters?.join(""),[U.additionalTextEdits]:e.additionalTextEdits&&e.additionalTextEdits.map(Ke.from),[U.commandIdent]:n?.$ident,[U.commandId]:n?.id,[U.commandArguments]:n?.$ident?void 0:n?.arguments};e.textEdit?(this._apiDeprecation.report("CompletionItem.textEdit",this._extension,"Use 'CompletionItem.insertText' and 'CompletionItem.range' instead."),o[U.insertText]=e.textEdit.newText):typeof e.insertText=="string"?o[U.insertText]=e.insertText:e.insertText instanceof Ah&&(o[U.insertText]=e.insertText.value,o[U.insertTextRules]|=Br.InsertAsSnippet);let c;return e.textEdit?c=e.textEdit.range:e.range&&(c=e.range),ce.isRange(c)?o[U.range]=A.from(c):c&&(!i?.isEqual(c.inserting)||!s?.isEqual(c.replacing))&&(o[U.range]={insert:A.from(c.inserting),replace:A.from(c.replacing)}),o}}class ht{constructor(e,t,i,s){this._extension=e,this._documents=t,this._provider=i,this._commands=s,this._references=new _u,this.languageTriggerKindToVSCodeTriggerKind={[Hc.Automatic]:oo.Automatic,[Hc.Explicit]:oo.Invoke},this._isAdditionsProposedApiEnabled=ie(this._extension,"inlineCompletionsAdditions")}get supportsHandleEvents(){return ie(this._extension,"inlineCompletionsAdditions")&&(typeof this._provider.handleDidShowCompletionItem=="function"||typeof this._provider.handleDidPartiallyAcceptCompletionItem=="function"||typeof this._provider.handleDidRejectCompletionItem=="function"||typeof this._provider.handleEndOfLifetime=="function")}async provideInlineCompletions(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t),o=await this._provider.provideInlineCompletionItems(r,n,{selectedCompletionInfo:i.selectedSuggestionInfo?{range:A.to(i.selectedSuggestionInfo.range),text:i.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[i.triggerKind],requestUuid:i.requestUuid},s);if(!o||s.isCancellationRequested)return;const c=Array.isArray(o)?o:o.items,d=this._isAdditionsProposedApiEnabled?Array.isArray(o)?[]:o.commands||[]:[],h=this._isAdditionsProposedApiEnabled&&!Array.isArray(o)?o.enableForwardStability:void 0;let f;return{pid:this._references.createReferenceId({dispose(){f?.dispose()},items:c}),items:c.map((l,p)=>{let _;l.command&&(f||(f=new N),_=this._commands.toInternal(l.command,f));let x;l.action&&(f||(f=new N),x=this._commands.toInternal(l.action,f));const S=l.insertText;return{insertText:typeof S=="string"?S:{snippet:S.value},filterText:l.filterText,range:l.range?A.from(l.range):void 0,showRange:this._isAdditionsProposedApiEnabled&&l.showRange?A.from(l.showRange):void 0,command:_,action:x,idx:p,completeBracketPairs:this._isAdditionsProposedApiEnabled?l.completeBracketPairs:!1,isInlineEdit:this._isAdditionsProposedApiEnabled?l.isInlineEdit:!1,showInlineEditMenu:this._isAdditionsProposedApiEnabled?l.showInlineEditMenu:!1,displayLocation:l.displayLocation&&this._isAdditionsProposedApiEnabled?{range:A.from(l.displayLocation.range),label:l.displayLocation.label}:void 0,warning:l.warning&&this._isAdditionsProposedApiEnabled?{message:ae.from(l.warning.message),icon:l.warning.icon?rm.fromThemeIcon(l.warning.icon):void 0}:void 0}}),commands:d.map(l=>(f||(f=new N),this._commands.toInternal(l,f))),suppressSuggestions:!1,enableForwardStability:h}}async provideInlineEditsForRange(e,t,i,s){if(!this._provider.provideInlineEditsForRange)return;b(this._extension,"inlineCompletionsAdditions");const r=this._documents.getDocument(e),n=A.to(t),o=await this._provider.provideInlineEditsForRange(r,n,{selectedCompletionInfo:i.selectedSuggestionInfo?{range:A.to(i.selectedSuggestionInfo.range),text:i.selectedSuggestionInfo.text}:void 0,triggerKind:this.languageTriggerKindToVSCodeTriggerKind[i.triggerKind],userPrompt:i.userPrompt,requestUuid:i.requestUuid},s);if(!o||s.isCancellationRequested)return;const c=Array.isArray(o)?o:o.items,d=this._isAdditionsProposedApiEnabled?Array.isArray(o)?[]:o.commands||[]:[],h=this._isAdditionsProposedApiEnabled&&!Array.isArray(o)?o.enableForwardStability:void 0;let f;return{pid:this._references.createReferenceId({dispose(){f?.dispose()},items:c}),items:c.map((l,p)=>{let _;l.command&&(f||(f=new N),_=this._commands.toInternal(l.command,f));let x;l.action&&(f||(f=new N),x=this._commands.toInternal(l.action,f));const S=l.insertText;return{insertText:typeof S=="string"?S:{snippet:S.value},filterText:l.filterText,range:l.range?A.from(l.range):void 0,command:_,action:x,idx:p,completeBracketPairs:this._isAdditionsProposedApiEnabled?l.completeBracketPairs:!1}}),commands:d.map(l=>(f||(f=new N),this._commands.toInternal(l,f))),suppressSuggestions:!1,enableForwardStability:h}}disposeCompletions(e){this._references.disposeReferenceId(e)?.dispose()}handleDidShowCompletionItem(e,t,i){const s=this._references.get(e)?.items[t];s&&this._provider.handleDidShowCompletionItem&&this._isAdditionsProposedApiEnabled&&this._provider.handleDidShowCompletionItem(s,i)}handlePartialAccept(e,t,i,s){const r=this._references.get(e)?.items[t];r&&this._provider.handleDidPartiallyAcceptCompletionItem&&this._isAdditionsProposedApiEnabled&&(this._provider.handleDidPartiallyAcceptCompletionItem(r,i),this._provider.handleDidPartiallyAcceptCompletionItem(r,nm.to(s)))}handleEndOfLifetime(e,t,i){const s=this._references.get(e)?.items[t];if(s&&this._provider.handleEndOfLifetime&&this._isAdditionsProposedApiEnabled){const r=om.to(i,n=>this._references.get(n.pid)?.items[n.idx]);this._provider.handleEndOfLifetime(s,r)}}handleRejection(e,t){const i=this._references.get(e)?.items[t];i&&this._provider.handleDidRejectCompletionItem&&this._isAdditionsProposedApiEnabled&&this._provider.handleDidRejectCompletionItem(i)}}class an{async provideInlineEdits(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideInlineEdit(s,{triggerKind:this.languageTriggerKindToVSCodeTriggerKind[t.triggerKind],requestUuid:t.requestUuid},i);if(!r||i.isCancellationRequested)return;let n;const o=this._references.createReferenceId({dispose(){n?.dispose()},item:r});let c;r.accepted&&(n||(n=new N),c=this._commands.toInternal(r.accepted,n));let d;r.rejected&&(n||(n=new N),d=this._commands.toInternal(r.rejected,n));let h;r.shown&&(n||(n=new N),h=this._commands.toInternal(r.shown,n));let f;return r.action&&(n||(n=new N),f=this._commands.toInternal(r.action,n)),n||(n=new N),{pid:o,text:r.text,range:A.from(r.range),showRange:A.from(r.showRange),accepted:c,rejected:d,shown:h,action:f,commands:r.commands?.map(l=>this._commands.toInternal(l,n))}}disposeEdit(e){this._references.disposeReferenceId(e)?.dispose()}constructor(e,t,i,s){this._documents=t,this._provider=i,this._commands=s,this._references=new _u,this.languageTriggerKindToVSCodeTriggerKind={[Fc.Automatic]:ao.Automatic,[Fc.Invoke]:ao.Invoke}}}class _u{constructor(){this._references=new Map,this._idPool=1}createReferenceId(e){const t=this._idPool++;return this._references.set(t,e),t}disposeReferenceId(e){const t=this._references.get(e);return this._references.delete(e),t}get(e){return this._references.get(e)}}class cn{constructor(e,t){this._documents=e,this._provider=t,this._cache=new He("SignatureHelp")}async provideSignatureHelp(e,t,i,s){const r=this._documents.getDocument(e),n=te.to(t),o=this.reviveContext(i),c=await this._provider.provideSignatureHelp(r,n,s,o);if(c){const d=this._cache.add([c]);return{...Wn.from(c),id:d}}}reviveContext(e){let t;if(e.activeSignatureHelp){const i=Wn.to(e.activeSignatureHelp),s=this._cache.get(e.activeSignatureHelp.id,0);s?(t=s,t.activeSignature=i.activeSignature,t.activeParameter=i.activeParameter):t=i}return{...e,activeSignatureHelp:t}}releaseSignatureHelp(e){this._cache.delete(e)}}class Es{constructor(e,t,i,s,r){this._documents=e,this._commands=t,this._provider=i,this._logService=s,this._extension=r,this._cache=new He("InlayHints"),this._disposables=new Map}async provideInlayHints(e,t,i){const s=this._documents.getDocument(e),r=A.to(t),n=await this._provider.provideInlayHints(s,r,i);if(!Array.isArray(n)||n.length===0){this._logService.trace(`[InlayHints] NO inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`);return}if(i.isCancellationRequested)return;const o=this._cache.add(n);this._disposables.set(o,new N);const c={hints:[],cacheId:o};for(let d=0;d<n.length;d++)this._isValidInlayHint(n[d],r)&&c.hints.push(this._convertInlayHint(n[d],[o,d]));return this._logService.trace(`[InlayHints] ${c.hints.length} inlay hints from '${this._extension.identifier.value}' for range ${JSON.stringify(t)}`),c}async resolveInlayHint(e,t){if(typeof this._provider.resolveInlayHint!="function")return;const i=this._cache.get(...e);if(!i)return;const s=await this._provider.resolveInlayHint(i,t);if(s&&this._isValidInlayHint(s))return this._convertInlayHint(s,e)}releaseHints(e){this._disposables.get(e)?.dispose(),this._disposables.delete(e),this._cache.delete(e)}_isValidInlayHint(e,t){return e.label.length===0||Array.isArray(e.label)&&e.label.every(i=>i.value.length===0)?(console.log("INVALID inlay hint, empty label",e),!1):!(t&&!t.contains(e.position))}_convertInlayHint(e,t){const i=this._disposables.get(t[0]);if(!i)throw Error("DisposableStore is missing...");const s={label:"",cacheId:t,tooltip:ae.fromStrict(e.tooltip),position:te.from(e.position),textEdits:e.textEdits&&e.textEdits.map(Ke.from),kind:e.kind&&am.from(e.kind),paddingLeft:e.paddingLeft,paddingRight:e.paddingRight};if(typeof e.label=="string")s.label=e.label;else{const r=[];s.label=r;for(const n of e.label){if(!n.value){console.warn("INVALID inlay hint, empty label part",this._extension.identifier.value);continue}const o={label:n.value,tooltip:ae.fromStrict(n.tooltip)};_i.isLocation(n.location)&&(o.location=st.from(n.location)),n.command&&(o.command=this._commands.toInternal(n.command,i)),r.push(o)}}return s}}class xt{constructor(e,t){this._documents=e,this._provider=t,this._cache=new He("DocumentLink")}async provideLinks(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentLinks(i,t);if(!(!Array.isArray(s)||s.length===0)&&!t.isCancellationRequested){if(typeof this._provider.resolveDocumentLink!="function")return{links:s.filter(xt._validateLink).map(Gi.from)};{const r=this._cache.add(s),n={links:[],cacheId:r};for(let o=0;o<s.length;o++){if(!xt._validateLink(s[o]))continue;const c=Gi.from(s[o]);c.cacheId=[r,o],n.links.push(c)}return n}}}static _validateLink(e){return e.target&&e.target.path.length>5e4?(console.warn("DROPPING link because it is too long"),!1):!0}async resolveLink(e,t){if(typeof this._provider.resolveDocumentLink!="function")return;const i=this._cache.get(...e);if(!i)return;const s=await this._provider.resolveDocumentLink(i,t);if(!(!s||!xt._validateLink(s)))return Gi.from(s)}releaseLinks(e){this._cache.delete(e)}}class dn{constructor(e,t){this._documents=e,this._provider=t}async provideColors(e,t){const i=this._documents.getDocument(e),s=await this._provider.provideDocumentColors(i,t);return Array.isArray(s)?s.map(n=>({color:ar.from(n.color),range:A.from(n.range)})):[]}async provideColorPresentations(e,t,i){const s=this._documents.getDocument(e),r=A.to(t.range),n=ar.to(t.color),o=await this._provider.provideColorPresentations(n,{document:s,range:r},i);if(Array.isArray(o))return o.map(ah.from)}}class tl{constructor(e,t){this._documents=e,this._provider=t}async provideFoldingRanges(e,t,i){const s=this._documents.getDocument(e),r=await this._provider.provideFoldingRanges(s,t,i);if(Array.isArray(r))return r.map(ch.from)}}class il{constructor(e,t,i){this._documents=e,this._provider=t,this._logService=i}async provideSelectionRanges(e,t,i){const s=this._documents.getDocument(e),r=t.map(te.to),n=await this._provider.provideSelectionRanges(s,r,i);if(!Er(n))return[];if(n.length!==r.length)return this._logService.warn("BAD selection ranges, provider must return ranges for each position"),[];const o=[];for(let c=0;c<r.length;c++){const d=[];o.push(d);let h=r[c],f=n[c];for(;;){if(!f.range.contains(h))throw new Error("INVALID selection range, must contain the previous range");if(d.push(cm.from(f)),!f.parent)break;h=f.range,f=f.parent}}return o}}class Ri{constructor(e,t){this._documents=e,this._provider=t,this._idPool=new ba(""),this._cache=new Map}async prepareSession(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.prepareCallHierarchy(s,r,i);if(!n)return;const o=this._idPool.nextId();return this._cache.set(o,new Map),Array.isArray(n)?n.map(c=>this._cacheAndConvertItem(o,c)):[this._cacheAndConvertItem(o,n)]}async provideCallsTo(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing call hierarchy item");const r=await this._provider.provideCallHierarchyIncomingCalls(s,i);if(r)return r.map(n=>({from:this._cacheAndConvertItem(e,n.from),fromRanges:n.fromRanges.map(o=>A.from(o))}))}async provideCallsFrom(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing call hierarchy item");const r=await this._provider.provideCallHierarchyOutgoingCalls(s,i);if(r)return r.map(n=>({to:this._cacheAndConvertItem(e,n.to),fromRanges:n.fromRanges.map(o=>A.from(o))}))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const i=this._cache.get(e),s=Ra.from(t,e,i.size.toString(36));return i.set(s._itemId,t),s}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class Ai{constructor(e,t){this._documents=e,this._provider=t,this._idPool=new ba(""),this._cache=new Map}async prepareSession(e,t,i){const s=this._documents.getDocument(e),r=te.to(t),n=await this._provider.prepareTypeHierarchy(s,r,i);if(!n)return;const o=this._idPool.nextId();return this._cache.set(o,new Map),Array.isArray(n)?n.map(c=>this._cacheAndConvertItem(o,c)):[this._cacheAndConvertItem(o,n)]}async provideSupertypes(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing type hierarchy item");const r=await this._provider.provideTypeHierarchySupertypes(s,i);if(r)return r.map(n=>this._cacheAndConvertItem(e,n))}async provideSubtypes(e,t,i){const s=this._itemFromCache(e,t);if(!s)throw new Error("missing type hierarchy item");const r=await this._provider.provideTypeHierarchySubtypes(s,i);if(r)return r.map(n=>this._cacheAndConvertItem(e,n))}releaseSession(e){this._cache.delete(e)}_cacheAndConvertItem(e,t){const i=this._cache.get(e),s=zi.from(t,e,i.size.toString(36));return i.set(s._itemId,t),s}_itemFromCache(e,t){return this._cache.get(e)?.get(t)}}class Ss{constructor(e,t,i,s,r){this._proxy=e,this._documents=t,this._provider=i,this._handle=s,this._extension=r,this._cache=new He("DocumentDropEdit")}async provideDocumentOnDropEdits(e,t,i,s,r){const n=this._documents.getDocument(t),o=te.to(i),c=dr.toDataTransfer(s,async m=>(await this._proxy.$resolveDocumentOnDropFileData(this._handle,e,m)).buffer),d=await this._provider.provideDocumentDropEdits(n,o,c,r);if(!d)return;const h=Ge(d),f=this._cache.add(h);return h.map((m,l)=>({_cacheId:[f,l],title:m.title??j(2583,"Drop using '{0}' extension",this._extension.displayName||this._extension.name),kind:m.kind?.value,yieldTo:m.yieldTo?.map(p=>p.value),insertText:typeof m.insertText=="string"?m.insertText:{snippet:m.insertText.value},additionalEdit:m.additionalEdit?Le.from(m.additionalEdit,void 0):void 0}))}async resolveDropEdit(e,t){const[i,s]=e,r=this._cache.get(i,s);if(!r||!this._provider.resolveDocumentDropEdit)return{};const n=await this._provider.resolveDocumentDropEdit(r,t)??r;return{additionalEdit:n.additionalEdit?Le.from(n.additionalEdit,void 0):void 0}}releaseDropEdits(e){this._cache.delete(e)}}class $i{constructor(e,t){this.adapter=e,this.extension=t}}class fe{static{this._handlePool=0}constructor(e,t,i,s,r,n,o,c){this._uriTransformer=t,this._documents=i,this._commands=s,this._diagnostics=r,this._logService=n,this._apiDeprecation=o,this._extensionTelemetry=c,this._adapter=new Map,this._proxy=e.getProxy(k.MainThreadLanguageFeatures)}_transformDocumentSelector(e,t){return Sr.from(e,this._uriTransformer,t)}_createDisposable(e){return new W(()=>{this._adapter.delete(e),this._proxy.$unregister(e)})}_nextHandle(){return fe._handlePool++}async _withAdapter(e,t,i,s,r,n=!1){const o=this._adapter.get(e);if(!o||!(o.adapter instanceof t))return s;const c=Date.now();n||this._logService.trace(`[${o.extension.identifier.value}] INVOKE provider '${i.toString().replace(/[\r\n]/g,"")}'`);const d=i(o.adapter,o.extension);return Promise.resolve(d).catch(h=>{Wt(h)||(this._logService.error(`[${o.extension.identifier.value}] provider FAILED`),this._logService.error(h),this._extensionTelemetry.onExtensionError(o.extension.identifier,h))}).finally(()=>{n||this._logService.trace(`[${o.extension.identifier.value}] provider DONE after ${Date.now()-c}ms`)}),de.isCancellationToken(r)?Da(d,r):d}_addNewAdapter(e,t){const i=this._nextHandle();return this._adapter.set(i,new $i(e,t)),i}static _extLabel(e){return e.displayName||e.name}static _extId(e){return e.identifier.value}registerDocumentSymbolProvider(e,t,i,s){const r=this._addNewAdapter(new yr(this._documents,i),e),n=s&&s.label||fe._extLabel(e);return this._proxy.$registerDocumentSymbolProvider(r,this._transformDocumentSelector(t,e),n),this._createDisposable(r)}$provideDocumentSymbols(e,t,i){return this._withAdapter(e,yr,s=>s.provideDocumentSymbols(v.revive(t),i),void 0,i)}registerCodeLensProvider(e,t,i){const s=this._nextHandle(),r=typeof i.onDidChangeCodeLenses=="function"?this._nextHandle():void 0;this._adapter.set(s,new $i(new xs(this._documents,this._commands.converter,i,e,this._extensionTelemetry,this._logService),e)),this._proxy.$registerCodeLensSupport(s,this._transformDocumentSelector(t,e),r);let n=this._createDisposable(s);if(r!==void 0){const o=i.onDidChangeCodeLenses(c=>this._proxy.$emitCodeLensEvent(r));n=W.from(n,o)}return n}$provideCodeLenses(e,t,i){return this._withAdapter(e,xs,s=>s.provideCodeLenses(v.revive(t),i),void 0,i,t.scheme==="output")}$resolveCodeLens(e,t,i){return this._withAdapter(e,xs,s=>s.resolveCodeLens(t,i),void 0,void 0,!0)}$releaseCodeLenses(e,t){this._withAdapter(e,xs,i=>Promise.resolve(i.releaseCodeLenses(t)),void 0,void 0,!0)}registerDefinitionProvider(e,t,i){const s=this._addNewAdapter(new Vd(this._documents,i),e);return this._proxy.$registerDefinitionSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDefinition(e,t,i,s){return this._withAdapter(e,Vd,r=>r.provideDefinition(v.revive(t),i,s),[],s)}registerDeclarationProvider(e,t,i){const s=this._addNewAdapter(new Bd(this._documents,i),e);return this._proxy.$registerDeclarationSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDeclaration(e,t,i,s){return this._withAdapter(e,Bd,r=>r.provideDeclaration(v.revive(t),i,s),[],s)}registerImplementationProvider(e,t,i){const s=this._addNewAdapter(new zd(this._documents,i),e);return this._proxy.$registerImplementationSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideImplementation(e,t,i,s){return this._withAdapter(e,zd,r=>r.provideImplementation(v.revive(t),i,s),[],s)}registerTypeDefinitionProvider(e,t,i){const s=this._addNewAdapter(new jd(this._documents,i),e);return this._proxy.$registerTypeDefinitionSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideTypeDefinition(e,t,i,s){return this._withAdapter(e,jd,r=>r.provideTypeDefinition(v.revive(t),i,s),[],s)}registerHoverProvider(e,t,i,s){const r=this._addNewAdapter(new Zi(this._documents,i),e);return this._proxy.$registerHoverProvider(r,this._transformDocumentSelector(t,e)),this._createDisposable(r)}$provideHover(e,t,i,s,r){return this._withAdapter(e,Zi,n=>n.provideHover(v.revive(t),i,s,r),void 0,r)}$releaseHover(e,t){this._withAdapter(e,Zi,i=>Promise.resolve(i.releaseHover(t)),void 0,void 0)}registerEvaluatableExpressionProvider(e,t,i,s){const r=this._addNewAdapter(new qd(this._documents,i),e);return this._proxy.$registerEvaluatableExpressionProvider(r,this._transformDocumentSelector(t,e)),this._createDisposable(r)}$provideEvaluatableExpression(e,t,i,s){return this._withAdapter(e,qd,r=>r.provideEvaluatableExpression(v.revive(t),i,s),void 0,s)}registerInlineValuesProvider(e,t,i,s){const r=typeof i.onDidChangeInlineValues=="function"?this._nextHandle():void 0,n=this._addNewAdapter(new Kd(this._documents,i),e);this._proxy.$registerInlineValuesProvider(n,this._transformDocumentSelector(t,e),r);let o=this._createDisposable(n);if(r!==void 0){const c=i.onDidChangeInlineValues(d=>this._proxy.$emitInlineValuesEvent(r));o=W.from(o,c)}return o}$provideInlineValues(e,t,i,s,r){return this._withAdapter(e,Kd,n=>n.provideInlineValues(v.revive(t),i,s,r),void 0,r)}registerDocumentHighlightProvider(e,t,i){const s=this._addNewAdapter(new Gd(this._documents,i),e);return this._proxy.$registerDocumentHighlightProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}registerMultiDocumentHighlightProvider(e,t,i){const s=this._addNewAdapter(new Qd(this._documents,i,this._logService),e);return this._proxy.$registerMultiDocumentHighlightProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDocumentHighlights(e,t,i,s){return this._withAdapter(e,Gd,r=>r.provideDocumentHighlights(v.revive(t),i,s),void 0,s)}$provideMultiDocumentHighlights(e,t,i,s,r){return this._withAdapter(e,Qd,n=>n.provideMultiDocumentHighlights(v.revive(t),i,s.map(o=>v.revive(o)),r),void 0,r)}registerLinkedEditingRangeProvider(e,t,i){const s=this._addNewAdapter(new Jd(this._documents,i),e);return this._proxy.$registerLinkedEditingRangeProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideLinkedEditingRanges(e,t,i,s){return this._withAdapter(e,Jd,async r=>{const n=await r.provideLinkedEditingRanges(v.revive(t),i,s);if(n)return{ranges:n.ranges,wordPattern:n.wordPattern?fe._serializeRegExp(n.wordPattern):void 0}},void 0,s)}registerReferenceProvider(e,t,i){const s=this._addNewAdapter(new Xd(this._documents,i),e);return this._proxy.$registerReferenceSupport(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideReferences(e,t,i,s,r){return this._withAdapter(e,Xd,n=>n.provideReferences(v.revive(t),i,s,r),void 0,r)}registerCodeActionProvider(e,t,i,s){const r=new N,n=this._addNewAdapter(new wt(this._documents,this._commands.converter,this._diagnostics,i,this._logService,e,this._apiDeprecation),e);return this._proxy.$registerCodeActionSupport(n,this._transformDocumentSelector(t,e),{providedKinds:s?.providedCodeActionKinds?.map(o=>o.value),documentation:s?.documentation?.map(o=>({kind:o.kind.value,command:this._commands.converter.toInternal(o.command,r)}))},fe._extLabel(e),fe._extId(e),!!i.resolveCodeAction),r.add(this._createDisposable(n)),r}$provideCodeActions(e,t,i,s,r){return this._withAdapter(e,wt,n=>n.provideCodeActions(v.revive(t),i,s,r),void 0,r)}$resolveCodeAction(e,t,i){return this._withAdapter(e,wt,s=>s.resolveCodeAction(t,i),{},void 0)}$releaseCodeActions(e,t){this._withAdapter(e,wt,i=>Promise.resolve(i.releaseCodeActions(t)),void 0,void 0)}registerDocumentFormattingEditProvider(e,t,i){const s=this._addNewAdapter(new Yd(this._documents,i),e);return this._proxy.$registerDocumentFormattingSupport(s,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name),this._createDisposable(s)}$provideDocumentFormattingEdits(e,t,i,s){return this._withAdapter(e,Yd,r=>r.provideDocumentFormattingEdits(v.revive(t),i,s),void 0,s)}registerDocumentRangeFormattingEditProvider(e,t,i){const s=typeof i.provideDocumentRangesFormattingEdits=="function",r=this._addNewAdapter(new nn(this._documents,i),e);return this._proxy.$registerRangeFormattingSupport(r,this._transformDocumentSelector(t,e),e.identifier,e.displayName||e.name,s),this._createDisposable(r)}$provideDocumentRangeFormattingEdits(e,t,i,s,r){return this._withAdapter(e,nn,n=>n.provideDocumentRangeFormattingEdits(v.revive(t),i,s,r),void 0,r)}$provideDocumentRangesFormattingEdits(e,t,i,s,r){return this._withAdapter(e,nn,n=>n.provideDocumentRangesFormattingEdits(v.revive(t),i,s,r),void 0,r)}registerOnTypeFormattingEditProvider(e,t,i,s){const r=this._addNewAdapter(new Zd(this._documents,i),e);return this._proxy.$registerOnTypeFormattingSupport(r,this._transformDocumentSelector(t,e),s,e.identifier),this._createDisposable(r)}$provideOnTypeFormattingEdits(e,t,i,s,r,n){return this._withAdapter(e,Zd,o=>o.provideOnTypeFormattingEdits(v.revive(t),i,s,r,n),void 0,n)}registerWorkspaceSymbolProvider(e,t){const i=this._addNewAdapter(new bs(t,this._logService),e);return this._proxy.$registerNavigateTypeSupport(i,typeof t.resolveWorkspaceSymbol=="function"),this._createDisposable(i)}$provideWorkspaceSymbols(e,t,i){return this._withAdapter(e,bs,s=>s.provideWorkspaceSymbols(t,i),{symbols:[]},i)}$resolveWorkspaceSymbol(e,t,i){return this._withAdapter(e,bs,s=>s.resolveWorkspaceSymbol(t,i),void 0,void 0)}$releaseWorkspaceSymbols(e,t){this._withAdapter(e,bs,i=>i.releaseWorkspaceSymbols(t),void 0,void 0)}registerRenameProvider(e,t,i){const s=this._addNewAdapter(new Lt(this._documents,i,this._logService),e);return this._proxy.$registerRenameSupport(s,this._transformDocumentSelector(t,e),Lt.supportsResolving(i)),this._createDisposable(s)}$provideRenameEdits(e,t,i,s,r){return this._withAdapter(e,Lt,n=>n.provideRenameEdits(v.revive(t),i,s,r),void 0,r)}$resolveRenameLocation(e,t,i,s){return this._withAdapter(e,Lt,r=>r.resolveRenameLocation(v.revive(t),i,s),void 0,s)}registerNewSymbolNamesProvider(e,t,i){const s=this._addNewAdapter(new li(this._documents,i,this._logService),e);return this._proxy.$registerNewSymbolNamesProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$supportsAutomaticNewSymbolNamesTriggerKind(e){return this._withAdapter(e,li,t=>t.supportsAutomaticNewSymbolNamesTriggerKind(),!1,void 0)}$provideNewSymbolNames(e,t,i,s,r){return this._withAdapter(e,li,n=>n.provideNewSymbolNames(v.revive(t),i,s,r),void 0,r)}registerDocumentSemanticTokensProvider(e,t,i,s){const r=this._addNewAdapter(new Ie(this._documents,i),e),n=typeof i.onDidChangeSemanticTokens=="function"?this._nextHandle():void 0;this._proxy.$registerDocumentSemanticTokensProvider(r,this._transformDocumentSelector(t,e),s,n);let o=this._createDisposable(r);if(n){const c=i.onDidChangeSemanticTokens(d=>this._proxy.$emitDocumentSemanticTokensEvent(n));o=W.from(o,c)}return o}$provideDocumentSemanticTokens(e,t,i,s){return this._withAdapter(e,Ie,r=>r.provideDocumentSemanticTokens(v.revive(t),i,s),null,s)}$releaseDocumentSemanticTokens(e,t){this._withAdapter(e,Ie,i=>i.releaseDocumentSemanticColoring(t),void 0,void 0)}registerDocumentRangeSemanticTokensProvider(e,t,i,s){const r=this._addNewAdapter(new el(this._documents,i),e);return this._proxy.$registerDocumentRangeSemanticTokensProvider(r,this._transformDocumentSelector(t,e),s),this._createDisposable(r)}$provideDocumentRangeSemanticTokens(e,t,i,s){return this._withAdapter(e,el,r=>r.provideDocumentRangeSemanticTokens(v.revive(t),i,s),null,s)}registerCompletionItemProvider(e,t,i,s){const r=this._addNewAdapter(new $t(this._documents,this._commands.converter,i,this._apiDeprecation,e),e);return this._proxy.$registerCompletionsProvider(r,this._transformDocumentSelector(t,e),s,$t.supportsResolving(i),e.identifier),this._createDisposable(r)}$provideCompletionItems(e,t,i,s,r){return this._withAdapter(e,$t,n=>n.provideCompletionItems(v.revive(t),i,s,r),void 0,r)}$resolveCompletionItem(e,t,i){return this._withAdapter(e,$t,s=>s.resolveCompletionItem(t,i),void 0,i)}$releaseCompletionItems(e,t){this._withAdapter(e,$t,i=>i.releaseCompletionItems(t),void 0,void 0)}registerInlineCompletionsProvider(e,t,i,s){const r=typeof i.onDidChange=="function"&&ie(e,"inlineCompletionsAdditions")?this._nextHandle():void 0,n=new ht(e,this._documents,i,this._commands.converter),o=this._addNewAdapter(n,e);let c=this._createDisposable(o);if(r!==void 0){const d=i.onDidChange(h=>this._proxy.$emitInlineCompletionsChange(r));c=W.from(c,d)}return this._proxy.$registerInlineCompletionsSupport(o,this._transformDocumentSelector(t,e),n.supportsHandleEvents,me.toKey(e.identifier.value),s?.yieldTo?.map(d=>me.toKey(d))||[],s?.displayName,s?.debounceDelayMs,r),c}$provideInlineCompletions(e,t,i,s,r){return this._withAdapter(e,ht,n=>n.provideInlineCompletions(v.revive(t),i,s,r),void 0,r)}$provideInlineEditsForRange(e,t,i,s,r){return this._withAdapter(e,ht,n=>n.provideInlineEditsForRange(v.revive(t),i,s,r),void 0,r)}$handleInlineCompletionDidShow(e,t,i,s){this._withAdapter(e,ht,async r=>{r.handleDidShowCompletionItem(t,i,s)},void 0,void 0)}$handleInlineCompletionPartialAccept(e,t,i,s,r){this._withAdapter(e,ht,async n=>{n.handlePartialAccept(t,i,s,r)},void 0,void 0)}$handleInlineCompletionEndOfLifetime(e,t,i,s){this._withAdapter(e,ht,async r=>{r.handleEndOfLifetime(t,i,s)},void 0,void 0)}$handleInlineCompletionRejection(e,t,i){this._withAdapter(e,ht,async s=>{s.handleRejection(t,i)},void 0,void 0)}$freeInlineCompletionsList(e,t){this._withAdapter(e,ht,async i=>{i.disposeCompletions(t)},void 0,void 0)}registerInlineEditProvider(e,t,i){const s=new an(e,this._documents,i,this._commands.converter),r=this._addNewAdapter(s,e);return this._proxy.$registerInlineEditProvider(r,this._transformDocumentSelector(t,e),e.identifier,i.displayName||e.name),this._createDisposable(r)}$provideInlineEdit(e,t,i,s){return this._withAdapter(e,an,r=>r.provideInlineEdits(v.revive(t),i,s),void 0,s)}$freeInlineEdit(e,t){this._withAdapter(e,an,async i=>{i.disposeEdit(t)},void 0,void 0)}registerSignatureHelpProvider(e,t,i,s){const r=Array.isArray(s)?{triggerCharacters:s,retriggerCharacters:[]}:s,n=this._addNewAdapter(new cn(this._documents,i),e);return this._proxy.$registerSignatureHelpProvider(n,this._transformDocumentSelector(t,e),r),this._createDisposable(n)}$provideSignatureHelp(e,t,i,s,r){return this._withAdapter(e,cn,n=>n.provideSignatureHelp(v.revive(t),i,s,r),void 0,r)}$releaseSignatureHelp(e,t){this._withAdapter(e,cn,i=>i.releaseSignatureHelp(t),void 0,void 0)}registerInlayHintsProvider(e,t,i){const s=typeof i.onDidChangeInlayHints=="function"?this._nextHandle():void 0,r=this._addNewAdapter(new Es(this._documents,this._commands.converter,i,this._logService,e),e);this._proxy.$registerInlayHintsProvider(r,this._transformDocumentSelector(t,e),typeof i.resolveInlayHint=="function",s,fe._extLabel(e));let n=this._createDisposable(r);if(s!==void 0){const o=i.onDidChangeInlayHints(c=>this._proxy.$emitInlayHintsEvent(s));n=W.from(n,o)}return n}$provideInlayHints(e,t,i,s){return this._withAdapter(e,Es,r=>r.provideInlayHints(v.revive(t),i,s),void 0,s)}$resolveInlayHint(e,t,i){return this._withAdapter(e,Es,s=>s.resolveInlayHint(t,i),void 0,i)}$releaseInlayHints(e,t){this._withAdapter(e,Es,i=>i.releaseHints(t),void 0,void 0)}registerDocumentLinkProvider(e,t,i){const s=this._addNewAdapter(new xt(this._documents,i),e);return this._proxy.$registerDocumentLinkProvider(s,this._transformDocumentSelector(t,e),typeof i.resolveDocumentLink=="function"),this._createDisposable(s)}$provideDocumentLinks(e,t,i){return this._withAdapter(e,xt,s=>s.provideLinks(v.revive(t),i),void 0,i,t.scheme==="output")}$resolveDocumentLink(e,t,i){return this._withAdapter(e,xt,s=>s.resolveLink(t,i),void 0,void 0,!0)}$releaseDocumentLinks(e,t){this._withAdapter(e,xt,i=>i.releaseLinks(t),void 0,void 0,!0)}registerColorProvider(e,t,i){const s=this._addNewAdapter(new dn(this._documents,i),e);return this._proxy.$registerDocumentColorProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideDocumentColors(e,t,i){return this._withAdapter(e,dn,s=>s.provideColors(v.revive(t),i),[],i)}$provideColorPresentations(e,t,i,s){return this._withAdapter(e,dn,r=>r.provideColorPresentations(v.revive(t),i,s),void 0,s)}registerFoldingRangeProvider(e,t,i){const s=this._nextHandle(),r=typeof i.onDidChangeFoldingRanges=="function"?this._nextHandle():void 0;this._adapter.set(s,new $i(new tl(this._documents,i),e)),this._proxy.$registerFoldingRangeProvider(s,this._transformDocumentSelector(t,e),e.identifier,r);let n=this._createDisposable(s);if(r!==void 0){const o=i.onDidChangeFoldingRanges(()=>this._proxy.$emitFoldingRangeEvent(r));n=W.from(n,o)}return n}$provideFoldingRanges(e,t,i,s){return this._withAdapter(e,tl,r=>r.provideFoldingRanges(v.revive(t),i,s),void 0,s)}registerSelectionRangeProvider(e,t,i){const s=this._addNewAdapter(new il(this._documents,i,this._logService),e);return this._proxy.$registerSelectionRangeProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$provideSelectionRanges(e,t,i,s){return this._withAdapter(e,il,r=>r.provideSelectionRanges(v.revive(t),i,s),[],s)}registerCallHierarchyProvider(e,t,i){const s=this._addNewAdapter(new Ri(this._documents,i),e);return this._proxy.$registerCallHierarchyProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$prepareCallHierarchy(e,t,i,s){return this._withAdapter(e,Ri,r=>Promise.resolve(r.prepareSession(v.revive(t),i,s)),void 0,s)}$provideCallHierarchyIncomingCalls(e,t,i,s){return this._withAdapter(e,Ri,r=>r.provideCallsTo(t,i,s),void 0,s)}$provideCallHierarchyOutgoingCalls(e,t,i,s){return this._withAdapter(e,Ri,r=>r.provideCallsFrom(t,i,s),void 0,s)}$releaseCallHierarchy(e,t){this._withAdapter(e,Ri,i=>Promise.resolve(i.releaseSession(t)),void 0,void 0)}registerTypeHierarchyProvider(e,t,i){const s=this._addNewAdapter(new Ai(this._documents,i),e);return this._proxy.$registerTypeHierarchyProvider(s,this._transformDocumentSelector(t,e)),this._createDisposable(s)}$prepareTypeHierarchy(e,t,i,s){return this._withAdapter(e,Ai,r=>Promise.resolve(r.prepareSession(v.revive(t),i,s)),void 0,s)}$provideTypeHierarchySupertypes(e,t,i,s){return this._withAdapter(e,Ai,r=>r.provideSupertypes(t,i,s),void 0,s)}$provideTypeHierarchySubtypes(e,t,i,s){return this._withAdapter(e,Ai,r=>r.provideSubtypes(t,i,s),void 0,s)}$releaseTypeHierarchy(e,t){this._withAdapter(e,Ai,i=>Promise.resolve(i.releaseSession(t)),void 0,void 0)}registerDocumentOnDropEditProvider(e,t,i,s){const r=this._nextHandle();return this._adapter.set(r,new $i(new Ss(this._proxy,this._documents,i,r,e),e)),this._proxy.$registerDocumentOnDropEditProvider(r,this._transformDocumentSelector(t,e),s?{supportsResolve:!!i.resolveDocumentDropEdit,dropMimeTypes:s.dropMimeTypes,providedDropKinds:s.providedDropEditKinds?.map(n=>n.value)}:void 0),this._createDisposable(r)}$provideDocumentOnDropEdits(e,t,i,s,r,n){return this._withAdapter(e,Ss,o=>Promise.resolve(o.provideDocumentOnDropEdits(t,v.revive(i),s,r,n)),void 0,void 0)}$resolveDropEdit(e,t,i){return this._withAdapter(e,Ss,s=>s.resolveDropEdit(t,i),{},void 0)}$releaseDocumentOnDropEdits(e,t){this._withAdapter(e,Ss,i=>Promise.resolve(i.releaseDropEdits(t)),void 0,void 0)}registerDocumentPasteEditProvider(e,t,i,s){const r=this._nextHandle();return this._adapter.set(r,new $i(new Ii(this._proxy,this._documents,i,r,e),e)),this._proxy.$registerPasteEditProvider(r,this._transformDocumentSelector(t,e),{supportsCopy:!!i.prepareDocumentPaste,supportsPaste:!!i.provideDocumentPasteEdits,supportsResolve:!!i.resolveDocumentPasteEdit,providedPasteEditKinds:s.providedPasteEditKinds?.map(n=>n.value),copyMimeTypes:s.copyMimeTypes,pasteMimeTypes:s.pasteMimeTypes}),this._createDisposable(r)}$prepareDocumentPaste(e,t,i,s,r){return this._withAdapter(e,Ii,n=>n.prepareDocumentPaste(v.revive(t),i,s,r),void 0,r)}$providePasteEdits(e,t,i,s,r,n,o){return this._withAdapter(e,Ii,c=>c.providePasteEdits(t,v.revive(i),s,r,n,o),void 0,o)}$resolvePasteEdit(e,t,i){return this._withAdapter(e,Ii,s=>s.resolvePasteEdit(t,i),{},void 0)}$releasePasteEdits(e,t){this._withAdapter(e,Ii,i=>Promise.resolve(i.releasePasteEdits(t)),void 0,void 0)}static _serializeRegExp(e){return{pattern:e.source,flags:e.flags}}static _serializeIndentationRule(e){return{decreaseIndentPattern:fe._serializeRegExp(e.decreaseIndentPattern),increaseIndentPattern:fe._serializeRegExp(e.increaseIndentPattern),indentNextLinePattern:e.indentNextLinePattern?fe._serializeRegExp(e.indentNextLinePattern):void 0,unIndentedLinePattern:e.unIndentedLinePattern?fe._serializeRegExp(e.unIndentedLinePattern):void 0}}static _serializeOnEnterRule(e){return{beforeText:fe._serializeRegExp(e.beforeText),afterText:e.afterText?fe._serializeRegExp(e.afterText):void 0,previousLineText:e.previousLineText?fe._serializeRegExp(e.previousLineText):void 0,action:e.action}}static _serializeOnEnterRules(e){return e.map(fe._serializeOnEnterRule)}static _serializeAutoClosingPair(e){return{open:e.open,close:e.close,notIn:e.notIn?e.notIn.map(t=>kh.toString(t)):void 0}}static _serializeAutoClosingPairs(e){return e.map(fe._serializeAutoClosingPair)}setLanguageConfiguration(e,t,i){const{wordPattern:s}=i;if(s&&xl(s))throw new Error(`Invalid language configuration: wordPattern '${s}' is not allowed to match the empty string.`);s?this._documents.setWordDefinitionFor(t,s):this._documents.setWordDefinitionFor(t,void 0),i.__electricCharacterSupport&&this._apiDeprecation.report("LanguageConfiguration.__electricCharacterSupport",e,"Do not use."),i.__characterPairSupport&&this._apiDeprecation.report("LanguageConfiguration.__characterPairSupport",e,"Do not use.");const r=this._nextHandle(),n={comments:i.comments,brackets:i.brackets,wordPattern:i.wordPattern?fe._serializeRegExp(i.wordPattern):void 0,indentationRules:i.indentationRules?fe._serializeIndentationRule(i.indentationRules):void 0,onEnterRules:i.onEnterRules?fe._serializeOnEnterRules(i.onEnterRules):void 0,__electricCharacterSupport:i.__electricCharacterSupport,__characterPairSupport:i.__characterPairSupport,autoClosingPairs:i.autoClosingPairs?fe._serializeAutoClosingPairs(i.autoClosingPairs):void 0};return this._proxy.$setLanguageConfiguration(r,t,n),this._createDisposable(r)}$setWordDefinitions(e){for(const t of e)this._documents.setWordDefinitionFor(t.languageId,new RegExp(t.regexSource,t.regexFlags))}}const sl="vscode_editFile",oa="vscode_editFile_internal",rl={id:oa,displayName:"",modelDescription:"",source:Mh.Internal};let aa=class{constructor(e,t,i){this.chatService=e,this.codeMapperService=t,this.notebookService=i}async invoke(e,t,i,s){if(!e.context)throw new Error("toolInvocationToken is required for this tool");const r=e.parameters,n=v.revive(r.uri),o=pm.parse(n)?.notebook||n,c=this.chatService.getSession(e.context?.sessionId),d=c.getRequests().at(-1);c.acceptResponseProgress(d,{kind:"markdownContent",content:new Lc("\n````\n")}),c.acceptResponseProgress(d,{kind:"codeblockUri",uri:o,isEdit:!0}),c.acceptResponseProgress(d,{kind:"markdownContent",content:new Lc("\n````\n")}),this.notebookService.hasSupportedNotebooks(o)&&this.notebookService.getNotebookTextModel(o)?c.acceptResponseProgress(d,{kind:"notebookEdit",edits:[],uri:o}):c.acceptResponseProgress(d,{kind:"textEdit",edits:[],uri:o});const h=c.editingSession;if(!h)throw new Error("This tool must be called from within an editing session");const f=await this.codeMapperService.mapCode({codeBlocks:[{code:r.code,resource:o,markdownBeforeBlock:r.explanation}],location:"tool",chatRequestId:e.chatRequestId,chatRequestModel:e.modelId,chatSessionId:e.context.sessionId},{textEdit:(l,p)=>{c.acceptResponseProgress(d,{kind:"textEdit",uri:l,edits:p})},notebookEdit(l,p){c.acceptResponseProgress(d,{kind:"notebookEdit",uri:l,edits:p})}},s);if(this.notebookService.hasSupportedNotebooks(o)&&this.notebookService.getNotebookTextModel(o)?c.acceptResponseProgress(d,{kind:"notebookEdit",uri:o,edits:[],done:!0}):c.acceptResponseProgress(d,{kind:"textEdit",uri:o,edits:[],done:!0}),f?.errorMessage)throw new Error(f.errorMessage);let m;return await new Promise(l=>{let p=!1;m=bl(_=>{const S=h.entries.read(_)?.find(C=>C.modifiedURI.toString()===o.toString());S&&(S.isCurrentlyBeingModifiedBy.read(_)?p=!0:p&&l(!0))})}).finally(()=>{m.dispose()}),{content:[{kind:"text",value:"The file was edited successfully"}]}}async prepareToolInvocation(e,t){return{presentation:"hidden"}}};aa=L([E(0,lm),E(1,hm),E(2,um)],aa);let nl=class extends Z{static{this.ID="chat.builtinTools"}constructor(e,t){super();const i=t.createInstance(aa);this._register(e.registerToolData(rl)),this._register(e.registerToolImplementation(rl.id,i))}};nl=L([E(0,fm),E(1,Pa)],nl);const wx="vscode_fetchWebPage_internal",xx="vscode_searchExtensions_internal";as.fromId(Cf.extensions.id),j(6932,"Search Extensions"),j(6933,"This is a tool for browsing Visual Studio Code Extensions Marketplace. It allows the model to search for extensions and retrieve detailed information about them. The model should use this tool whenever it needs to discover extensions or resolve information about known ones. To use the tool, the model has to provide the category of the extensions, relevant search keywords, or known extension IDs. Note that search results may include false positives, so reviewing and filtering is recommended."),j(6934,"Search for extensions in the Visual Studio Code Extensions Marketplace"),Mh.Internal;let ol=class{constructor(e){this.extensionWorkbenchService=e}async invoke(e,t,i,s){const r=e.parameters;if(!r.keywords?.length&&!r.category&&!r.ids?.length)return{content:[{kind:"text",value:j(6935,"Please provide a category or keywords or ids to search for.")}]};const n=new Map,o=h=>{for(const f of h)f.deprecationInfo||f.isMalicious||n.set(f.identifier.id.toLowerCase(),{id:f.identifier.id,name:f.displayName,description:f.description,installed:f.state===mm.Installed,installCount:f.installCount??0,rating:f.rating??0,categories:f.categories??[],tags:f.gallery?.tags??[]})},c=async h=>{const f=await this.extensionWorkbenchService.queryGallery({text:h,pageSize:10,sortBy:Df.InstallCount},s);f.firstPage.length&&o(f.firstPage)};if(r.ids?.length){const h=await this.extensionWorkbenchService.getExtensions(r.ids.map(f=>({id:f})),s);o(h)}if(r.keywords?.length)for(const h of r.keywords??[])if(h==="featured")await c("featured");else{let f=r.category?`category:"${r.category}"`:"";f=h?`${f} ${h}`.trim():f,await c(f)}else await c(`category:"${r.category}"`);const d=Array.from(n.values());return{content:[{kind:"text",value:`Here are the list of extensions:
${JSON.stringify(d)}
. Important: Use the following format to display extensions to the user because there is a renderer available to parse these extensions in this format and display them with all details. So, do not describe about the extensions to the user.
\`\`\`vscode-extensions
extensionId1,extensionId2
\`\`\`
.`}],toolResultDetails:{input:JSON.stringify(r),output:[{isText:!0,value:JSON.stringify(d.map(h=>h.id))}]}}}};ol=L([E(0,gm)],ol);class al{constructor(e){this._data=e}update(e){this._data=e}get data(){return this._data}get apiObject(){if(!this._apiObject){const e=this;this._apiObject=Object.freeze({get name(){return e._data.id},get description(){return e._data.modelDescription},get inputSchema(){return e._data.inputSchema},get tags(){return e._data.tags??[]}})}return this._apiObject}}class bx{constructor(e,t){this._languageModels=t,this._registeredTools=new Map,this._tokenCountFuncs=new Map,this._allTools=new Map,this._proxy=e.getProxy(k.MainThreadLanguageModelTools),this._proxy.$getTools().then(i=>{for(const s of i)this._allTools.set(s.id,new al(qe(s)))})}async $countTokensForInvocation(e,t,i){const s=this._tokenCountFuncs.get(e);if(!s)throw new Error(`Tool invocation call ${e} not found`);return await s(t,i)}async invokeTool(e,t,i,s){const r=Ct();i.tokenizationOptions&&this._tokenCountFuncs.set(r,i.tokenizationOptions.countTokens);try{if(i.toolInvocationToken&&!_m(i.toolInvocationToken))throw new Error("Invalid tool invocation token");if((t===oa||t===sl)&&!ie(e,"chatParticipantPrivate"))throw new Error(`Invalid tool: ${t}`);const n=await this._proxy.$invokeTool({toolId:t,callId:r,parameters:i.input,tokenBudget:i.tokenizationOptions?.tokenBudget,context:i.toolInvocationToken,chatRequestId:ie(e,"chatParticipantPrivate")?i.chatRequestId:void 0,chatInteractionId:ie(e,"chatParticipantPrivate")?i.chatInteractionId:void 0},s),o=n instanceof Qe?n.value:n;return ld.to(qe(o))}finally{this._tokenCountFuncs.delete(r)}}$onDidChangeTools(e){const t=new Set(this._registeredTools.keys());for(const i of e){t.delete(i.id);const s=this._allTools.get(i.id);s?s.update(i):this._allTools.set(i.id,new al(qe(i)))}for(const i of t)this._allTools.delete(i)}getTools(e){return Array.from(this._allTools.values()).map(t=>t.apiObject).filter(t=>{switch(t.name){case oa:case sl:case wx:case xx:return ie(e,"chatParticipantPrivate");default:return!0}})}async $invokeTool(e,t){const i=this._registeredTools.get(e.toolId);if(!i)throw new Error(`Unknown tool ${e.toolId}`);const s={input:e.parameters,toolInvocationToken:e.context};ie(i.extension,"chatParticipantPrivate")&&(s.chatRequestId=e.chatRequestId,s.chatInteractionId=e.chatInteractionId,s.chatSessionId=e.context?.sessionId,e.toolSpecificData?.kind==="terminal"&&(s.terminalCommand=e.toolSpecificData.command)),ie(i.extension,"chatParticipantAdditions")&&e.modelId&&(s.model=await this.getModel(e.modelId,i.extension)),e.tokenBudget!==void 0&&(s.tokenizationOptions={tokenBudget:e.tokenBudget,countTokens:this._tokenCountFuncs.get(e.callId)||((o,c=de.None)=>this._proxy.$countTokensForInvocation(e.callId,o,c))});let r;ie(i.extension,"toolProgress")&&(r={report:o=>{this._proxy.$acceptToolProgress(e.callId,{message:ae.fromStrict(o.message),increment:o.increment,total:100})}});const n=await Pf(Promise.resolve(i.tool.invoke(s,t,r)),t);if(!n)throw new gi;return ld.from(n,i.extension)}async getModel(e,t){let i;if(e&&(i=await this._languageModels.getLanguageModelByIdentifier(t,e)),!i&&(i=await this._languageModels.getDefaultLanguageModel(t),!i))throw new Error("Language model unavailable");return i}async $prepareToolInvocation(e,t,i){const s=this._registeredTools.get(e);if(!s)throw new Error(`Unknown tool ${e}`);const r={input:t};if(ie(s.extension,"chatParticipantPrivate")&&s.tool.prepareInvocation2){const n=await s.tool.prepareInvocation2(r,i);return n?{confirmationMessages:n.confirmationMessages?{title:typeof n.confirmationMessages.title=="string"?n.confirmationMessages.title:ae.from(n.confirmationMessages.title),message:typeof n.confirmationMessages.message=="string"?n.confirmationMessages.message:ae.from(n.confirmationMessages.message)}:void 0,toolSpecificData:{kind:"terminal",language:n.language,command:n.command},presentation:n.presentation}:void 0}else if(s.tool.prepareInvocation){const n=await s.tool.prepareInvocation(r,i);return n?((n.pastTenseMessage||n.presentation)&&b(s.extension,"chatParticipantPrivate"),{confirmationMessages:n.confirmationMessages?{title:typeof n.confirmationMessages.title=="string"?n.confirmationMessages.title:ae.from(n.confirmationMessages.title),message:typeof n.confirmationMessages.message=="string"?n.confirmationMessages.message:ae.from(n.confirmationMessages.message)}:void 0,invocationMessage:ae.fromStrict(n.invocationMessage),pastTenseMessage:ae.fromStrict(n.pastTenseMessage),presentation:n.presentation}):void 0}}registerTool(e,t,i){return this._registeredTools.set(t,{extension:e,tool:i}),this._proxy.$registerTool(t),V(()=>{this._registeredTools.delete(t),this._proxy.$unregisterTool(t)})}}class Ex{constructor(e,t,i,s){this._documents=t,this._commands=i,this._uriTransformer=s,this._languageIds=[],this._handlePool=0,this._ids=new Set,this._proxy=e.getProxy(k.MainThreadLanguages)}$acceptLanguageIds(e){this._languageIds=e}async getLanguages(){return this._languageIds.slice(0)}async changeLanguage(e,t){await this._proxy.$changeLanguage(e,t);const i=this._documents.getDocumentData(e);if(!i)throw new Error(`document '${e.toString()}' NOT found`);return i.document}async tokenAtPosition(e,t){const i=e.version,s=te.from(t),r=await this._proxy.$tokensAtPosition(e.uri,s),n={type:Hh.Other,range:e.getWordRangeAtPosition(t)??new ce(t.line,t.character,t.line,t.character)};if(!r)return n;const o={range:A.to(r.range),type:vm.to(r.type)};return!o.range.contains(t)||i!==e.version?n:o}createLanguageStatusItem(e,t,i){const s=this._handlePool++,r=this._proxy,n=this._ids,o=`${e.identifier.value}/${t}`;if(n.has(o))throw new Error(`LanguageStatusItem with id '${t}' ALREADY exists`);n.add(o);const c={selector:i,id:t,name:e.displayName??e.name,severity:Ls.Information,command:void 0,text:"",detail:"",busy:!1};let d;const h=new N,f=()=>{if(d?.dispose(),!n.has(o)){console.warn(`LanguageStatusItem (${t}) from ${e.identifier.value} has been disposed and CANNOT be updated anymore`);return}d=Tf(()=>{h.clear(),this._proxy.$setLanguageStatus(s,{id:o,name:c.name??e.displayName??e.name,source:e.displayName??e.name,selector:Sr.from(c.selector,this._uriTransformer),label:c.text,detail:c.detail??"",severity:c.severity===Ls.Error?Te.Error:c.severity===Ls.Warning?Te.Warning:Te.Info,command:c.command&&this._commands.toInternal(c.command,h),accessibilityInfo:c.accessibilityInformation,busy:c.busy})},0)},m={dispose(){h.dispose(),d?.dispose(),r.$removeLanguageStatus(s),n.delete(o)},get id(){return c.id},get name(){return c.name},set name(l){c.name=l,f()},get selector(){return c.selector},set selector(l){c.selector=l,f()},get text(){return c.text},set text(l){c.text=l,f()},set text2(l){b(e,"languageStatusText"),c.text=l,f()},get text2(){return b(e,"languageStatusText"),c.text},get detail(){return c.detail},set detail(l){c.detail=l,f()},get severity(){return c.severity},set severity(l){c.severity=l,f()},get accessibilityInformation(){return c.accessibilityInformation},set accessibilityInformation(l){c.accessibilityInformation=l,f()},get command(){return c.command},set command(l){c.command=l,f()},get busy(){return c.busy},set busy(l){c.busy=l,f()}};return f(),m}}function Sx(a){return a&&a.title}let ca=class{constructor(e,t){this._logService=t,this._proxy=e.getProxy(k.MainThreadMessageService)}showMessage(e,t,i,s,r){const n={source:{identifier:e.identifier,label:e.displayName||e.name}};let o;typeof s=="string"||Sx(s)?o=[s,...r]:(n.modal=s?.modal,n.useCustom=s?.useCustom,n.detail=s?.detail,o=r),n.useCustom&&b(e,"resolvers");const c=[];let d=!1;for(let h=0;h<o.length;h++){const f=o[h];if(typeof f=="string")c.push({title:f,handle:h,isCloseAffordance:!1});else if(typeof f=="object"){const{title:m,isCloseAffordance:l}=f;c.push({title:m,isCloseAffordance:!!l,handle:h}),l&&(d?this._logService.warn(`[${e.identifier}] Only one message item can have 'isCloseAffordance':`,f):d=!0)}else this._logService.warn(`[${e.identifier}] Invalid message item:`,f)}return this._proxy.$showMessage(t,i,n,c).then(h=>{if(typeof h=="number")return o[h]})}};ca=L([E(1,se)],ca);class ln{constructor(e,t,i,s){this.start=e,this.deletedCount=t,this.deletedItems=i,this.items=s}asApiEvent(){return{range:new ai(this.start,this.start+this.deletedCount),addedCells:this.items.map(e=>e.apiCell),removedCells:this.deletedItems}}}class da{static asModelAddData(e){return{EOL:e.eol,lines:e.source,languageId:e.language,uri:e.uri,isDirty:!1,versionId:1,encoding:"utf8"}}constructor(e,t,i){this.notebook=e,this._extHostDocument=t,this._cellData=i,this.handle=i.handle,this.uri=v.revive(i.uri),this.cellKind=i.cellKind,this._outputs=i.outputs.map(lr.to),this._internalMetadata=i.internalMetadata??{},this._metadata=Object.freeze(i.metadata??{}),this._previousResult=Object.freeze(hd.to(i.internalMetadata??{}))}get internalMetadata(){return this._internalMetadata}get apiCell(){if(!this._apiCell){const e=this,t=this._extHostDocument.getDocument(this.uri);if(!t)throw new Error(`MISSING extHostDocument for notebook cell: ${this.uri}`);const i={get index(){return e.notebook.getCellIndex(e)},notebook:e.notebook.apiNotebook,kind:ym.to(this._cellData.cellKind),document:t.document,get mime(){return e._mime},set mime(s){e._mime=s},get outputs(){return e._outputs.slice(0)},get metadata(){return e._metadata},get executionSummary(){return e._previousResult}};this._apiCell=Object.freeze(i)}return this._apiCell}setOutputs(e){this._outputs=e.map(lr.to)}setOutputItems(e,t,i){const s=i.map(Fh.to),r=this._outputs.find(n=>n.id===e);if(r&&(t||(r.items.length=0),r.items.push(...s),r.items.length>1&&r.items.every(n=>wm(n.mime)))){const n=new Map,o=[];r.items.forEach(c=>{let d;n.has(c.mime)?d=n.get(c.mime):(d=[],n.set(c.mime,d),o.push(c.mime)),d.push(c.data)}),r.items.length=0,o.forEach(c=>{const d=xm(n.get(c));r.items.push({mime:c,data:d.data.buffer})})}}setMetadata(e){this._metadata=Object.freeze(e)}setInternalMetadata(e){this._internalMetadata=e,this._previousResult=Object.freeze(hd.to(e))}setMime(e){}}class sc{static{this._handlePool=0}constructor(e,t,i,s,r){this._proxy=e,this._textDocumentsAndEditors=t,this._textDocuments=i,this.uri=s,this.handle=sc._handlePool++,this._cells=[],this._versionId=0,this._isDirty=!1,this._disposed=!1,this._notebookType=r.viewType,this._metadata=Object.freeze(r.metadata??Object.create(null)),this._spliceNotebookCells([[0,0,r.cells]],!0,void 0),this._versionId=r.versionId}dispose(){this._disposed=!0}get versionId(){return this._versionId}get apiNotebook(){if(!this._notebook){const e=this,t={get uri(){return e.uri},get version(){return e._versionId},get notebookType(){return e._notebookType},get isDirty(){return e._isDirty},get isUntitled(){return e.uri.scheme===G.untitled},get isClosed(){return e._disposed},get metadata(){return e._metadata},get cellCount(){return e._cells.length},cellAt(i){return i=e._validateIndex(i),e._cells[i].apiCell},getCells(i){return(i?e._getCells(i):e._cells).map(r=>r.apiCell)},save(){return e._save()},[Symbol.for("debug.description")](){return`NotebookDocument(${this.uri.toString()})`}};this._notebook=Object.freeze(t)}return this._notebook}acceptDocumentPropertiesChanged(e){e.metadata&&(this._metadata=Object.freeze({...this._metadata,...e.metadata}))}acceptDirty(e){this._isDirty=e}acceptModelChanged(e,t,i){this._versionId=e.versionId,this._isDirty=t,this.acceptDocumentPropertiesChanged({metadata:i});const s={notebook:this.apiNotebook,metadata:i,cellChanges:[],contentChanges:[]},r=[];for(const o of e.rawEvents)o.kind===Je.ModelChange?this._spliceNotebookCells(o.changes,!1,s.contentChanges):o.kind===Je.Move?this._moveCells(o.index,o.length,o.newIdx,s.contentChanges):o.kind===Je.Output?(this._setCellOutputs(o.index,o.outputs),r.push({cell:this._cells[o.index].apiCell,outputs:this._cells[o.index].apiCell.outputs})):o.kind===Je.OutputItem?(this._setCellOutputItems(o.index,o.outputId,o.append,o.outputItems),r.push({cell:this._cells[o.index].apiCell,outputs:this._cells[o.index].apiCell.outputs})):o.kind===Je.ChangeCellLanguage?(this._changeCellLanguage(o.index,o.language),r.push({cell:this._cells[o.index].apiCell,document:this._cells[o.index].apiCell.document})):o.kind===Je.ChangeCellContent?r.push({cell:this._cells[o.index].apiCell,document:this._cells[o.index].apiCell.document}):o.kind===Je.ChangeCellMime?this._changeCellMime(o.index,o.mime):o.kind===Je.ChangeCellMetadata?(this._changeCellMetadata(o.index,o.metadata),r.push({cell:this._cells[o.index].apiCell,metadata:this._cells[o.index].apiCell.metadata})):o.kind===Je.ChangeCellInternalMetadata&&(this._changeCellInternalMetadata(o.index,o.internalMetadata),r.push({cell:this._cells[o.index].apiCell,executionSummary:this._cells[o.index].apiCell.executionSummary}));const n=new Map;for(let o=0;o<r.length;o++){const c=r[o],d=n.get(c.cell);if(d===void 0){const h=s.cellChanges.push({document:void 0,executionSummary:void 0,metadata:void 0,outputs:void 0,...c});n.set(c.cell,h-1)}else s.cellChanges[d]={...s.cellChanges[d],...c}}return s}_validateIndex(e){return e=e|0,e<0?0:e>=this._cells.length?this._cells.length-1:e}_validateRange(e){let t=e.start|0,i=e.end|0;return t<0&&(t=0),i>this._cells.length&&(i=this._cells.length),e.with({start:t,end:i})}_getCells(e){e=this._validateRange(e);const t=[];for(let i=e.start;i<e.end;i++)t.push(this._cells[i]);return t}async _save(){return this._disposed?Promise.reject(new Error("Notebook has been closed")):this._proxy.$trySaveNotebook(this.uri)}_spliceNotebookCells(e,t,i){if(this._disposed)return;const s=[],r=[],n=[];if(e.reverse().forEach(o=>{const d=o[2].map(m=>{const l=new da(this,this._textDocumentsAndEditors,m);return t||r.push(da.asModelAddData(m)),l}),h=new ln(o[0],o[1],[],d),f=this._cells.splice(o[0],o[1],...d);for(const m of f)n.push(m.uri),h.deletedItems.push(m.apiCell);s.push(h)}),this._textDocumentsAndEditors.acceptDocumentsAndEditorsDelta({addedDocuments:r,removedDocuments:n}),i)for(const o of s)i.push(o.asApiEvent())}_moveCells(e,t,i,s){const r=this._cells.splice(e,t);this._cells.splice(i,0,...r);const n=[new ln(e,t,r.map(o=>o.apiCell),[]),new ln(i,0,[],r)];for(const o of n)s.push(o.asApiEvent())}_setCellOutputs(e,t){this._cells[e].setOutputs(t)}_setCellOutputItems(e,t,i,s){this._cells[e].setOutputItems(t,i,s)}_changeCellLanguage(e,t){const i=this._cells[e];i.apiCell.document.languageId!==t&&this._textDocuments.$acceptModelLanguageChanged(i.uri,t)}_changeCellMime(e,t){const i=this._cells[e];i.apiCell.mime=t}_changeCellMetadata(e,t){this._cells[e].setMetadata(t)}_changeCellInternalMetadata(e,t){this._cells[e].setInternalMetadata(t)}getCellFromApiCell(e){return this._cells.find(t=>t.apiCell===e)}getCellFromIndex(e){return this._cells[e]}getCell(e){return this._cells.find(t=>t.handle===e)}getCellIndex(e){return this._cells.indexOf(e)}}class ns{static{this.apiEditorsToExtHost=new WeakMap}constructor(e,t,i,s,r,n,o){this.id=e,this._proxy=t,this.notebookData=i,this._visibleRanges=s,this._selections=r,this._viewColumn=n,this.viewType=o,this._visible=!1}get apiEditor(){if(!this._editor){const e=this;this._editor={get notebook(){return e.notebookData.apiNotebook},get selection(){return e._selections[0]},set selection(t){this.selections=[t]},get selections(){return e._selections},set selections(t){if(!Array.isArray(t)||!t.every(ai.isNotebookRange))throw Ks("selections");e._selections=t.length===0?[new ai(0,0)]:t,e._trySetSelections(e._selections)},get visibleRanges(){return e._visibleRanges},revealRange(t,i){e._proxy.$tryRevealRange(e.id,bt.from(t),i??Lh.Default)},get viewColumn(){return e._viewColumn},get replOptions(){if(e.viewType==="repl")return{appendIndex:this.notebook.cellCount-1}},[Symbol.for("debug.description")](){return`NotebookEditor(${this.notebook.uri.toString()})`}},ns.apiEditorsToExtHost.set(this._editor,this)}return this._editor}get visible(){return this._visible}_acceptVisibility(e){this._visible=e}_acceptVisibleRanges(e){this._visibleRanges=e}_acceptSelections(e){this._selections=e.length===0?[new ai(0,0)]:e}_trySetSelections(e){this._proxy.$trySetSelections(this.id,e.map(bt.from))}_acceptViewColumn(e){this._viewColumn=e}}class Cx extends Z{constructor(e,t,i){super(),this._source=e,this._inputTextBuffer=t,this._outputs=i,this._outputTextBuffers=void 0}_getFullModelRange(e){const t=e.getLineCount();return new Ut(1,1,t,this._getLineMaxColumn(e,t))}_getLineMaxColumn(e,t){if(t<1||t>e.getLineCount())throw new Error("Illegal value for lineNumber");return e.getLineLength(t)+1}get inputTextBuffer(){if(!this._inputTextBuffer){const e=new Nc;e.acceptChunk(this._source);const t=e.finish(!0),{textBuffer:i,disposable:s}=t.create(Oc.LF);this._inputTextBuffer=i,this._register(s)}return this._inputTextBuffer}get outputTextBuffers(){return this._outputTextBuffers||(this._outputTextBuffers=this._outputs.map(e=>{const t=new Nc;t.acceptChunk(e);const i=t.finish(!0),{textBuffer:s,disposable:r}=i.create(Oc.LF);return this._register(r),s})),this._outputTextBuffers}findInInputs(e){const i=new Uc(e,!1,!1,null).parseSearchRequest();if(!i)return[];const s=this._getFullModelRange(this.inputTextBuffer);return this.inputTextBuffer.findMatchesLineByLine(s,i,!0,5e3)}findInOutputs(e){const i=new Uc(e,!1,!1,null).parseSearchRequest();return i?this.outputTextBuffers.map(s=>{const r=s.findMatchesLineByLine(this._getFullModelRange(s),i,!0,5e3);if(r.length!==0)return{textBuffer:s,matches:r}}).filter(s=>!!s):[]}}function cl(a,e){let t=-1;const i=[];let s=[];return a.forEach(n=>{n.range.startLineNumber!==t&&s.length>0&&(i.push([...s]),s=[]),s.push(n),t=n.range.endLineNumber}),s.length>0&&i.push([...s]),i.map(n=>{const o=[],c=n[0].range.startLineNumber,d=n[n.length-1].range.endLineNumber;for(let h=c;h<=d;h++)o.push(e.getLineContent(h));return new bm(o.join(`
`)+`
`,n.map(h=>new Ut(h.range.startLineNumber-1,h.range.startColumn-1,h.range.endLineNumber-1,h.range.endColumn-1)))})}class oi{static{this._notebookStatusBarItemProviderHandlePool=0}get activeNotebookEditor(){return this._activeNotebookEditor?.apiEditor}get visibleNotebookEditors(){return this._visibleNotebookEditors.map(e=>e.apiEditor)}constructor(e,t,i,s,r,n,o){this._textDocumentsAndEditors=i,this._textDocuments=s,this._extHostFileSystem=r,this._extHostSearch=n,this._logService=o,this._notebookStatusBarItemProviders=new Map,this._documents=new et,this._editors=new Map,this._onDidChangeActiveNotebookEditor=new D,this.onDidChangeActiveNotebookEditor=this._onDidChangeActiveNotebookEditor.event,this._visibleNotebookEditors=[],this._onDidOpenNotebookDocument=new D,this.onDidOpenNotebookDocument=this._onDidOpenNotebookDocument.event,this._onDidCloseNotebookDocument=new D,this.onDidCloseNotebookDocument=this._onDidCloseNotebookDocument.event,this._onDidChangeVisibleNotebookEditors=new D,this.onDidChangeVisibleNotebookEditors=this._onDidChangeVisibleNotebookEditors.event,this._statusBarCache=new He("NotebookCellStatusBarCache"),this._handlePool=0,this._notebookSerializer=new Map,this._notebookProxy=e.getProxy(k.MainThreadNotebook),this._notebookDocumentsProxy=e.getProxy(k.MainThreadNotebookDocuments),this._notebookEditorsProxy=e.getProxy(k.MainThreadNotebookEditors),this._commandsConverter=t.converter,t.registerArgumentProcessor({processArgument:c=>{if(c&&c.$mid===Se.NotebookCellActionContext){const d=c.notebookEditor?.notebookUri,h=c.cell.handle,m=this._documents.get(d)?.getCell(h);if(m)return m.apiCell}if(c&&c.$mid===Se.NotebookActionContext){const d=c.uri,h=this._documents.get(d);if(h)return h.apiNotebook}return c}}),oi._registerApiCommands(t)}getEditorById(e){const t=this._editors.get(e);if(!t)throw new Error(`unknown text editor: ${e}. known editors: ${[...this._editors.keys()]} `);return t}getIdByEditor(e){for(const[t,i]of this._editors)if(i.apiEditor===e)return t}get notebookDocuments(){return[...this._documents.values()]}getNotebookDocument(e,t){const i=this._documents.get(e);if(!i&&!t)throw new Error(`NO notebook document for '${e}'`);return i}static _convertNotebookRegistrationData(e,t){if(!t)return;const i=t.filenamePattern.map(s=>fh.from(s)).filter(s=>s!==void 0);if(t.filenamePattern&&!i){console.warn(`Notebook content provider view options file name pattern is invalid ${t.filenamePattern}`);return}return{extension:e.identifier,providerDisplayName:e.displayName||e.name,displayName:t.displayName,filenamePattern:i,priority:t.exclusive?Em.exclusive:void 0}}registerNotebookCellStatusBarItemProvider(e,t,i){const s=oi._notebookStatusBarItemProviderHandlePool++,r=typeof i.onDidChangeCellStatusBarItems=="function"?oi._notebookStatusBarItemProviderHandlePool++:void 0;this._notebookStatusBarItemProviders.set(s,i),this._notebookProxy.$registerNotebookCellStatusBarItemProvider(s,r,t);let n;return r!==void 0&&(n=i.onDidChangeCellStatusBarItems(o=>this._notebookProxy.$emitCellStatusBarEvent(r))),new W(()=>{this._notebookStatusBarItemProviders.delete(s),this._notebookProxy.$unregisterNotebookCellStatusBarItemProvider(s,r),n?.dispose()})}async createNotebookDocument(e){const t=await this._notebookDocumentsProxy.$tryCreateNotebook({viewType:e.viewType,content:e.content&&Xt.from(e.content)});return v.revive(t)}async openNotebookDocument(e){const t=this._documents.get(e);if(t)return t.apiNotebook;const i=await this._notebookDocumentsProxy.$tryOpenNotebook(e),s=this._documents.get(v.revive(i));return Qs(s?.apiNotebook)}async showNotebookDocument(e,t){let i;typeof t=="object"?i={position:we.from(t.viewColumn),preserveFocus:t.preserveFocus,selections:t.selections&&t.selections.map(bt.from),pinned:typeof t.preview=="boolean"?!t.preview:void 0,label:typeof t.asRepl=="string"?t.asRepl:typeof t.asRepl=="object"?t.asRepl.label:void 0}:i={preserveFocus:!1,pinned:!0};const s=t?.asRepl?"repl":e.notebookType,r=await this._notebookEditorsProxy.$tryShowNotebookDocument(e.uri,s,i),n=r&&this._editors.get(r)?.apiEditor;if(n)return n;throw r?new Error(`Could NOT open editor for "${e.uri.toString()}" because another editor opened in the meantime.`):new Error(`Could NOT open editor for "${e.uri.toString()}".`)}async $provideNotebookCellStatusBarItems(e,t,i,s){const r=this._notebookStatusBarItemProviders.get(e),n=v.revive(t),o=this._documents.get(n);if(!o||!r)return;const c=o.getCellFromIndex(i);if(!c)return;const d=await r.provideCellStatusBarItems(c.apiCell,s);if(!d)return;const h=new N,f=this._statusBarCache.add([h]),l=(Array.isArray(d)?d:[d]).map(p=>Sm.from(p,this._commandsConverter,h));return{cacheId:f,items:l}}$releaseNotebookCellStatusBarItems(e){this._statusBarCache.delete(e)}registerNotebookSerializer(e,t,i,s,r){if(vn(t))throw new Error("viewType cannot be empty or just whitespace");const n=this._handlePool++;return this._notebookSerializer.set(n,{viewType:t,serializer:i,options:s}),this._notebookProxy.$registerNotebookSerializer(n,{id:e.identifier,location:e.extensionLocation},t,Cm.from(s),oi._convertNotebookRegistrationData(e,r)),V(()=>{this._notebookProxy.$unregisterNotebookSerializer(n)})}async $dataToNotebook(e,t,i){const s=this._notebookSerializer.get(e);if(!s)throw new Error("NO serializer found");const r=await s.serializer.deserializeNotebook(t.buffer,i);return new Qe(Xt.from(r))}async $notebookToData(e,t,i){const s=this._notebookSerializer.get(e);if(!s)throw new Error("NO serializer found");const r=await s.serializer.serializeNotebook(Xt.to(t.value),i);return be.wrap(r)}async $saveNotebook(e,t,i,s,r){const n=v.revive(t),o=this._notebookSerializer.get(e);if(this.trace(`enter saveNotebook(versionId: ${i}, ${n.toString()})`),!o)throw new Error("NO serializer found");const c=this._documents.get(n);if(!c)throw new Error("Document NOT found");if(c.versionId!==i)throw new Error("Document version mismatch");if(!this._extHostFileSystem.value.isWritableFileSystem(n.scheme))throw new Wc(j(2588,"Unable to modify read-only file '{0}'",this._resourceForError(n)),Vc.FILE_PERMISSION_DENIED);const d={metadata:Bc(c.apiNotebook.metadata,p=>!(o.options?.transientDocumentMetadata??{})[p]),cells:[]};for(const p of c.apiNotebook.getCells()){const _=new Nh(p.kind,p.document.getText(),p.document.languageId,p.mime,o.options?.transientOutputs?[]:[...p.outputs],p.metadata,p.executionSummary);_.metadata=Bc(p.metadata,x=>!(o.options?.transientCellMetadata??{})[x]),d.cells.push(_)}if(await this._validateWriteFile(n,s),r.isCancellationRequested)throw new Error("canceled");const h=await o.serializer.serializeNotebook(d,r);if(r.isCancellationRequested)throw new Error("canceled");this.trace(`serialized versionId: ${i} ${n.toString()}`),await this._extHostFileSystem.value.writeFile(n,h),this.trace(`Finished write versionId: ${i} ${n.toString()}`);const f=this._extHostFileSystem.getFileSystemProviderExtUri(n.scheme),m=await this._extHostFileSystem.value.stat(n),l={name:f.basename(n),isFile:(m.type&Wi.File)!==0,isDirectory:(m.type&Wi.Directory)!==0,isSymbolicLink:(m.type&Wi.SymbolicLink)!==0,mtime:m.mtime,ctime:m.ctime,size:m.size,readonly:!!((m.permissions??0)&zs.Readonly)||!this._extHostFileSystem.value.isWritableFileSystem(n.scheme),locked:!!((m.permissions??0)&zs.Locked),etag:zc({mtime:m.mtime,size:m.size}),children:void 0};return this.trace(`exit saveNotebook(versionId: ${i}, ${n.toString()})`),l}async $searchInNotebooks(e,t,i,s,r){const n=this._notebookSerializer.get(e)?.serializer;if(!n)return{limitHit:!1,results:[]};const o=new kf;await(async(m,l,p)=>{await Promise.all(m.map(async _=>await Promise.all(_.filenamePatterns.map(x=>{const S={_reason:p._reason,folderQueries:p.folderQueries,includePattern:p.includePattern,excludePattern:p.excludePattern,maxResults:p.maxResults,type:ih.File,filePattern:x};return this._extHostSearch.doInternalFileSearchWithCustomCallback(S,l,C=>{C.forEach(T=>{o.has(T)||s.some(I=>_.isFromSettings&&!I.isFromSettings?!1:I.filenamePatterns.some(B=>Dm(B,T)))||o.add(T)})}).catch(C=>{if(C.code==="ENOENT")return console.warn("Could not find notebook search results, ignoring notebook results."),{limitHit:!1,messages:[]};throw C})}))))})(i,r,t);const d=new et;let h=!1;const f=Array.from(o).map(async m=>{const l=[];try{if(r.isCancellationRequested)return;if(t.maxResults&&[...d.values()].reduce((S,C)=>S+C.cellResults.length,0)>t.maxResults){h=!0;return}const p=[],_=this._documents.get(m);if(_)_.apiNotebook.getCells().forEach(C=>p.push({input:C.document.getText(),outputs:C.outputs.flatMap(T=>T.items.map(O=>O.data.toString()))}));else{const S=await this._extHostFileSystem.value.readFile(m),C=be.fromString(S.toString()),T=await n.deserializeNotebook(C.buffer,r);if(r.isCancellationRequested)return;Xt.from(T).cells.forEach(I=>p.push({input:I.source,outputs:I.outputs.flatMap(B=>B.items.map(Q=>Q.valueBytes.toString()))}))}if(r.isCancellationRequested)return;p.forEach((S,C)=>{const T=t.contentPattern.pattern,O=new Cx(S.input,void 0,S.outputs),I=O.findInInputs(T),B=O.findInOutputs(T),Q=B.flatMap(K=>cl(K.matches,K.textBuffer)).map((K,ze)=>(K.webviewIndex=ze,K));if(I.length>0||B.length>0){const K={index:C,contentResults:cl(I,O.inputTextBuffer),webviewResults:Q};l.push(K)}});const x={resource:m,cellResults:l};d.set(m,x);return}catch{return}});return await Promise.all(f),{limitHit:h,results:[...d.values()]}}async _validateWriteFile(e,t){const i=await this._extHostFileSystem.value.stat(e);if(typeof t?.mtime=="number"&&typeof t.etag=="string"&&t.etag!==If&&typeof i.mtime=="number"&&typeof i.size=="number"&&t.mtime<i.mtime&&t.etag!==zc({mtime:t.mtime,size:i.size}))throw new Wc(j(2589,"File Modified Since"),Vc.FILE_MODIFIED_SINCE,t)}_resourceForError(e){return e.scheme===G.file?e.fsPath:e.toString()}_createExtHostEditor(e,t,i){if(this._editors.has(t))throw new Error(`editor with id ALREADY EXSIST: ${t}`);const s=new ns(t,this._notebookEditorsProxy,e,i.visibleRanges.map(bt.to),i.selections.map(bt.to),typeof i.viewColumn=="number"?we.to(i.viewColumn):void 0,i.viewType);this._editors.set(t,s)}$acceptDocumentAndEditorsDelta(e){if(e.value.removedDocuments)for(const t of e.value.removedDocuments){const i=v.revive(t),s=this._documents.get(i);s&&(s.dispose(),this._documents.delete(i),this._textDocumentsAndEditors.$acceptDocumentsAndEditorsDelta({removedDocuments:s.apiNotebook.getCells().map(r=>r.document.uri)}),this._onDidCloseNotebookDocument.fire(s.apiNotebook));for(const r of this._editors.values())r.notebookData.uri.toString()===i.toString()&&this._editors.delete(r.id)}if(e.value.addedDocuments){const t=[];for(const i of e.value.addedDocuments){const s=v.revive(i.uri);if(this._documents.has(s))throw new Error(`adding EXISTING notebook ${s} `);const r=new sc(this._notebookDocumentsProxy,this._textDocumentsAndEditors,this._textDocuments,s,i);t.push(...i.cells.map(n=>da.asModelAddData(n))),this._documents.get(s)?.dispose(),this._documents.set(s,r),this._textDocumentsAndEditors.$acceptDocumentsAndEditorsDelta({addedDocuments:t}),this._onDidOpenNotebookDocument.fire(r.apiNotebook)}}if(e.value.addedEditors)for(const t of e.value.addedEditors){if(this._editors.has(t.id))return;const i=v.revive(t.documentUri),s=this._documents.get(i);s&&this._createExtHostEditor(s,t.id,t)}if(e.value.removedEditors)for(const t of e.value.removedEditors){const i=this._editors.get(t);i&&(this._editors.delete(t),this._activeNotebookEditor?.id===i.id&&(this._activeNotebookEditor=void 0))}if(e.value.visibleEditors){this._visibleNotebookEditors=e.value.visibleEditors.map(i=>this._editors.get(i)).filter(i=>!!i);const t=new Set;this._visibleNotebookEditors.forEach(i=>t.add(i.id));for(const i of this._editors.values()){const s=t.has(i.id);i._acceptVisibility(s)}this._visibleNotebookEditors=[...this._editors.values()].map(i=>i).filter(i=>i.visible),this._onDidChangeVisibleNotebookEditors.fire(this.visibleNotebookEditors)}e.value.newActiveEditor===null?this._activeNotebookEditor=void 0:e.value.newActiveEditor&&(this._editors.get(e.value.newActiveEditor)||console.error(`FAILED to find active notebook editor ${e.value.newActiveEditor}`),this._activeNotebookEditor=this._editors.get(e.value.newActiveEditor)),e.value.newActiveEditor!==void 0&&this._onDidChangeActiveNotebookEditor.fire(this._activeNotebookEditor?.apiEditor)}static _registerApiCommands(e){const t=P.String.with("notebookType","A notebook type"),i=new H("vscode.executeDataToNotebook","_executeDataToNotebook","Invoke notebook serializer",[t,new P("data","Bytes to convert to data",r=>r instanceof Uint8Array,r=>be.wrap(r))],new M("Notebook Data",r=>Xt.to(r.value))),s=new H("vscode.executeNotebookToData","_executeNotebookToData","Invoke notebook serializer",[t,new P("NotebookData","Notebook data to convert to bytes",r=>!0,r=>new Qe(Xt.from(r)))],new M("Bytes",r=>r.buffer));e.registerApiCommand(i),e.registerApiCommand(s)}trace(e){this._logService.trace(`[Extension Host Notebook] ${e}`)}}class Dx{constructor(e,t,i,s={timeout:1500,errors:3}){this._logService=e,this._notebooksAndEditors=t,this._mainThreadBulkEdits=i,this._thresholds=s,this._onWillSaveNotebookDocumentEvent=new Vi}dispose(){}getOnWillSaveNotebookDocumentEvent(e){return(t,i,s)=>{const r=function(o){t.call(i,o)};return r.extension=e,this._onWillSaveNotebookDocumentEvent.event(r,void 0,s)}}async $participateInSave(e,t,i){const s=v.revive(e),r=this._notebooksAndEditors.getNotebookDocument(s);if(!r)throw new Error("Unable to resolve notebook document");const n=[];if(await this._onWillSaveNotebookDocumentEvent.fireAsync({notebook:r.apiNotebook,reason:Ph.to(t)},i,async(c,d)=>{const h=Date.now(),f=await await Promise.resolve(c);Date.now()-h>this._thresholds.timeout&&this._logService.warn("onWillSaveNotebookDocument-listener from extension",d.extension.identifier),!i.isCancellationRequested&&f&&(f instanceof Va?n.push(f):this._logService.warn("onWillSaveNotebookDocument-listener from extension",d.extension.identifier,"ignored due to invalid data"))}),i.isCancellationRequested)return!1;if(n.length===0)return!0;const o={edits:[]};for(const c of n){const{edits:d}=Le.from(c);o.edits=o.edits.concat(d)}return this._mainThreadBulkEdits.$tryApplyWorkspaceEdit(new Qe(o))}}class Px{constructor(e){this._notebooksAndEditors=e,this._onDidSaveNotebookDocument=new D,this.onDidSaveNotebookDocument=this._onDidSaveNotebookDocument.event,this._onDidChangeNotebookDocument=new D,this.onDidChangeNotebookDocument=this._onDidChangeNotebookDocument.event}$acceptModelChanged(e,t,i,s){const n=this._notebooksAndEditors.getNotebookDocument(v.revive(e)).acceptModelChanged(t.value,i,s);this._onDidChangeNotebookDocument.fire(n)}$acceptDirtyStateChanged(e,t){this._notebooksAndEditors.getNotebookDocument(v.revive(e)).acceptDirty(t)}$acceptModelSaved(e){const t=this._notebooksAndEditors.getNotebookDocument(v.revive(e));this._onDidSaveNotebookDocument.fire(t.apiNotebook)}}let la=class{constructor(e,t){this._logService=e,this._notebooksAndEditors=t,this._onDidChangeNotebookEditorSelection=new D,this._onDidChangeNotebookEditorVisibleRanges=new D,this.onDidChangeNotebookEditorSelection=this._onDidChangeNotebookEditorSelection.event,this.onDidChangeNotebookEditorVisibleRanges=this._onDidChangeNotebookEditorVisibleRanges.event}$acceptEditorPropertiesChanged(e,t){this._logService.debug("ExtHostNotebook#$acceptEditorPropertiesChanged",e,t);const i=this._notebooksAndEditors.getEditorById(e);t.visibleRanges&&i._acceptVisibleRanges(t.visibleRanges.ranges.map(bt.to)),t.selections&&i._acceptSelections(t.selections.selections.map(bt.to)),t.visibleRanges&&this._onDidChangeNotebookEditorVisibleRanges.fire({notebookEditor:i.apiEditor,visibleRanges:i.apiEditor.visibleRanges}),t.selections&&this._onDidChangeNotebookEditorSelection.fire(Object.freeze({notebookEditor:i.apiEditor,selections:i.apiEditor.selections}))}$acceptEditorViewColumns(e){for(const t in e)this._notebooksAndEditors.getEditorById(t)._acceptViewColumn(we.to(e[t]))}};la=L([E(0,se)],la);const Tx=100;var dl;(function(a){a[a.Disconnected=1]="Disconnected",a[a.Connected=2]="Connected",a[a.Initializing=3]="Initializing"})(dl||(dl={}));let ha=class{constructor(e,t,i,s,r){this._initData=t,this._extHostNotebook=i,this._commands=s,this._logService=r,this._activeExecutions=new et,this._activeNotebookExecutions=new et,this._kernelDetectionTask=new Map,this._kernelDetectionTaskHandlePool=0,this._kernelSourceActionProviders=new Map,this._kernelSourceActionProviderHandlePool=0,this._kernelData=new Map,this._handlePool=0,this.id=0,this.variableStore={},this._proxy=e.getProxy(k.MainThreadNotebookKernels);const n=new H("notebook.selectKernel","_notebook.selectKernel","Trigger kernel picker for specified notebook editor widget",[new P("options","Select kernel options",c=>!0,c=>{if(c&&"notebookEditor"in c&&"id"in c){const d=this._extHostNotebook.getIdByEditor(c.notebookEditor);return{id:c.id,extension:c.extension,notebookEditorId:d}}else if(c&&"notebookEditor"in c){const d=this._extHostNotebook.getIdByEditor(c.notebookEditor);if(d===void 0)throw new Error(`Cannot invoke 'notebook.selectKernel' for unrecognized notebook editor ${c.notebookEditor.notebook.uri.toString()}`);return"skipIfAlreadySelected"in c?{notebookEditorId:d,skipIfAlreadySelected:c.skipIfAlreadySelected}:{notebookEditorId:d}}return c})],M.Void),o=new H("vscode.executeNotebookVariableProvider","_executeNotebookVariableProvider","Execute notebook variable provider",[P.Uri],new M("A promise that resolves to an array of variables",(c,d)=>c.map(h=>({variable:{name:h.name,value:h.value,expression:h.expression,type:h.type,language:h.language},hasNamedChildren:h.hasNamedChildren,indexedChildrenCount:h.indexedChildrenCount}))));this._commands.registerApiCommand(n),this._commands.registerApiCommand(o)}createNotebookController(e,t,i,s,r,n){for(const I of this._kernelData.values())if(I.controller.id===t&&me.equals(e.identifier,I.extensionId))throw new Error(`notebook controller with id '${t}' ALREADY exist`);const o=this._handlePool++,c=this;this._logService.trace(`NotebookController[${o}], CREATED by ${e.identifier.value}, ${t}`);const d=()=>console.warn(`NO execute handler from notebook controller '${l.id}' of extension: '${e.identifier}'`);let h=!1;const f=new D,m=new D,l={id:Cs(e.identifier,t),notebookType:i,extensionId:e.identifier,extensionLocation:e.extensionLocation,label:s||e.identifier.value,preloads:n?n.map(ud.from):[]};let p=r??d,_,x;this._proxy.$addKernel(o,l).catch(I=>{console.log(I),h=!0});let S=0;const C=()=>{if(h)return;const I=++S;Promise.resolve().then(()=>{I===S&&this._proxy.$updateKernel(o,l)})},T=new et,O={get id(){return t},get notebookType(){return l.notebookType},onDidChangeSelectedNotebooks:f.event,get label(){return l.label},set label(I){l.label=I??e.displayName??e.name,C()},get detail(){return l.detail??""},set detail(I){l.detail=I,C()},get description(){return l.description??""},set description(I){l.description=I,C()},get supportedLanguages(){return l.supportedLanguages},set supportedLanguages(I){l.supportedLanguages=I,C()},get supportsExecutionOrder(){return l.supportsExecutionOrder??!1},set supportsExecutionOrder(I){l.supportsExecutionOrder=I,C()},get rendererScripts(){return l.preloads?l.preloads.map(ud.to):[]},get executeHandler(){return p},set executeHandler(I){p=I??d},get interruptHandler(){return _},set interruptHandler(I){_=I,l.supportsInterrupt=!!I,C()},set variableProvider(I){b(e,"notebookVariableProvider"),x=I,l.hasVariableProvider=!!I,I?.onDidChangeVariables(B=>c._proxy.$variablesUpdated(B.uri)),C()},get variableProvider(){return x},createNotebookCellExecution(I){if(h)throw new Error("notebook controller is DISPOSED");if(!T.has(I.notebook.uri))throw c._logService.trace(`NotebookController[${o}] NOT associated to notebook, associated to THESE notebooks:`,Array.from(T.keys()).map(B=>B.toString())),new Error(`notebook controller is NOT associated to notebook: ${I.notebook.uri.toString()}`);return c._createNotebookCellExecution(I,Cs(e.identifier,this.id))},createNotebookExecution(I){if(b(e,"notebookExecution"),h)throw new Error("notebook controller is DISPOSED");if(!T.has(I.uri))throw c._logService.trace(`NotebookController[${o}] NOT associated to notebook, associated to THESE notebooks:`,Array.from(T.keys()).map(B=>B.toString())),new Error(`notebook controller is NOT associated to notebook: ${I.uri.toString()}`);return c._createNotebookExecution(I,Cs(e.identifier,this.id))},dispose:()=>{h||(this._logService.trace(`NotebookController[${o}], DISPOSED`),h=!0,this._kernelData.delete(o),f.dispose(),m.dispose(),this._proxy.$removeKernel(o))},updateNotebookAffinity(I,B){B===Oh.Hidden&&b(e,"notebookControllerAffinityHidden"),c._proxy.$updateNotebookPriority(o,I.uri,B)},onDidReceiveMessage:m.event,postMessage(I,B){return b(e,"notebookMessaging"),c._proxy.$postMessage(o,B&&c._extHostNotebook.getIdByEditor(B),I)},asWebviewUri(I){return b(e,"notebookMessaging"),Yi(I,c._initData.remote)}};return this._kernelData.set(o,{extensionId:e.identifier,controller:O,onDidReceiveMessage:m,onDidChangeSelection:f,associatedNotebooks:T}),O}getIdByController(e){for(const[t,i]of this._kernelData)if(i.controller===e)return Cs(i.extensionId,e.id);return null}createNotebookControllerDetectionTask(e,t){const i=this._kernelDetectionTaskHandlePool++,s=this;this._logService.trace(`NotebookControllerDetectionTask[${i}], CREATED by ${e.identifier.value}`),this._proxy.$addKernelDetectionTask(i,t);const r={dispose:()=>{this._kernelDetectionTask.delete(i),s._proxy.$removeKernelDetectionTask(i)}};return this._kernelDetectionTask.set(i,r),r}registerKernelSourceActionProvider(e,t,i){const s=this._kernelSourceActionProviderHandlePool++,r=typeof i.onDidChangeNotebookKernelSourceActions=="function"?s:void 0,n=this;this._kernelSourceActionProviders.set(s,i),this._logService.trace(`NotebookKernelSourceActionProvider[${s}], CREATED by ${e.identifier.value}`),this._proxy.$addKernelSourceActionProvider(s,s,t);let o;return r!==void 0&&(o=i.onDidChangeNotebookKernelSourceActions(c=>this._proxy.$emitNotebookKernelSourceActionsChangeEvent(r))),{dispose:()=>{this._kernelSourceActionProviders.delete(s),n._proxy.$removeKernelSourceActionProvider(s,s),o?.dispose()}}}async $provideKernelSourceActions(e,t){const i=this._kernelSourceActionProviders.get(e);if(i){const s=new N;return(await i.provideNotebookKernelSourceActions(t)??[]).map(n=>Pm.from(n,this._commands.converter,s))}return[]}$acceptNotebookAssociation(e,t,i){const s=this._kernelData.get(e);if(s){const r=this._extHostNotebook.getNotebookDocument(v.revive(t));i?s.associatedNotebooks.set(r.uri,!0):s.associatedNotebooks.delete(r.uri),this._logService.trace(`NotebookController[${e}] ASSOCIATE notebook`,r.uri.toString(),i),s.onDidChangeSelection.fire({selected:i,notebook:r.apiNotebook})}}async $executeCells(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getNotebookDocument(v.revive(t)),n=[];for(const o of i){const c=r.getCell(o);c&&n.push(c.apiCell)}try{this._logService.trace(`NotebookController[${e}] EXECUTE cells`,r.uri.toString(),n.length),await s.controller.executeHandler.call(s.controller,n,r.apiNotebook,s.controller)}catch(o){this._logService.error(`NotebookController[${e}] execute cells FAILED`,o),console.error(o)}}async $cancelCells(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getNotebookDocument(v.revive(t));if(s.controller.interruptHandler)await s.controller.interruptHandler.call(s.controller,r.apiNotebook);else for(const n of i){const o=r.getCell(n);o&&this._activeExecutions.get(o.uri)?.cancel()}if(s.controller.interruptHandler){const n=this._activeNotebookExecutions.get(r.uri);this._activeNotebookExecutions.delete(r.uri),i.length&&Array.isArray(n)&&n.length&&n.forEach(o=>o.dispose())}}async $provideVariables(e,t,i,s,r,n,o){const c=this._kernelData.get(e);if(!c)return;const d=this._extHostNotebook.getNotebookDocument(v.revive(i)),h=c.controller.variableProvider;if(!h)return;let f;if(s!==void 0){if(f=this.variableStore[s],!f)return}else this.variableStore={};const m=r==="named"?lo.Named:lo.Indexed,l=h.provideVariables(d.apiNotebook,f,m,n,o);let p=0;for await(const _ of l){if(o.isCancellationRequested)return;const x={id:this.id++,name:_.variable.name,value:_.variable.value,type:_.variable.type,interfaces:_.variable.interfaces,language:_.variable.language,expression:_.variable.expression,hasNamedChildren:_.hasNamedChildren,indexedChildrenCount:_.indexedChildrenCount,extensionId:c.extensionId.value};if(this.variableStore[x.id]=_.variable,this._proxy.$receiveVariable(t,x),p++>=Tx)return}}$acceptKernelMessageFromRenderer(e,t,i){const s=this._kernelData.get(e);if(!s)return;const r=this._extHostNotebook.getEditorById(t);s.onDidReceiveMessage.fire(Object.freeze({editor:r.apiEditor,message:i}))}_createNotebookCellExecution(e,t){if(e.index<0)throw new Error("CANNOT execute cell that has been REMOVED from notebook");const s=this._extHostNotebook.getNotebookDocument(e.notebook.uri).getCellFromApiCell(e);if(!s)throw new Error("invalid cell");if(this._activeExecutions.has(s.uri))throw new Error(`duplicate execution for ${s.uri}`);const r=new rc(t,s,this._proxy);this._activeExecutions.set(s.uri,r);const n=r.onDidChangeState(()=>{r.state===Be.Resolved&&(r.dispose(),n.dispose(),this._activeExecutions.delete(s.uri))});return r.asApiObject()}_createNotebookExecution(e,t){const i=this._extHostNotebook.getNotebookDocument(e.uri),s=e.getCells().find(o=>{const c=i.getCellFromApiCell(o);return c&&this._activeExecutions.has(c.uri)});if(s)throw new Error(`duplicate cell execution for ${s.document.uri}`);if(this._activeNotebookExecutions.has(i.uri))throw new Error(`duplicate notebook execution for ${i.uri}`);const r=new nc(t,i,this._proxy),n=r.onDidChangeState(()=>{r.state===Ze.Resolved&&(r.dispose(),n.dispose(),this._activeNotebookExecutions.delete(i.uri))});return this._activeNotebookExecutions.set(i.uri,[r,n]),r.asApiObject()}};ha=L([E(4,se)],ha);var Be;(function(a){a[a.Init=0]="Init",a[a.Started=1]="Started",a[a.Resolved=2]="Resolved"})(Be||(Be={}));class rc extends Z{static{this.HANDLE=0}get state(){return this._state}constructor(e,t,i){super(),this._cell=t,this._proxy=i,this._handle=rc.HANDLE++,this._onDidChangeState=new D,this.onDidChangeState=this._onDidChangeState.event,this._state=Be.Init,this._tokenSource=this._register(new he),this._collector=new Ix(10,s=>this.update(s)),this._executionOrder=t.internalMetadata.executionOrder,this._proxy.$createExecution(this._handle,e,this._cell.notebook.uri,this._cell.handle)}cancel(){this._tokenSource.cancel()}async updateSoon(e){await this._collector.addItem(e)}async update(e){const t=Array.isArray(e)?e:[e];return this._proxy.$updateExecution(this._handle,new Qe(t))}verifyStateForOutput(){if(this._state===Be.Init)throw new Error("Must call start before modifying cell output");if(this._state===Be.Resolved)throw new Error("Cannot modify cell output after calling resolve")}cellIndexToHandle(e){let t=this._cell;if(e&&(t=this._cell.notebook.getCellFromApiCell(e)),!t)throw new Error("INVALID cell");return t.handle}validateAndConvertOutputs(e){return e.map(t=>{const i=co.ensureUniqueMimeTypes(t.items,!0);return i===t.items?lr.from(t):lr.from({items:i,id:t.id,metadata:t.metadata})})}async updateOutputs(e,t,i){const s=this.cellIndexToHandle(t),r=this.validateAndConvertOutputs(Ge(e));return this.updateSoon({editType:vs.Output,cellHandle:s,append:i,outputs:r})}async updateOutputItems(e,t,i){return e=co.ensureUniqueMimeTypes(Ge(e),!0),this.updateSoon({editType:vs.OutputItems,items:e.map(Fh.from),outputId:t.id,append:i})}asApiObject(){const e=this;return Object.freeze({get token(){return e._tokenSource.token},get cell(){return e._cell.apiCell},get executionOrder(){return e._executionOrder},set executionOrder(i){e._executionOrder=i,e.update([{editType:vs.ExecutionState,executionOrder:e._executionOrder}])},start(i){if(e._state===Be.Resolved||e._state===Be.Started)throw new Error("Cannot call start again");e._state=Be.Started,e._onDidChangeState.fire(),e.update({editType:vs.ExecutionState,runStartTime:i})},end(i,s,r){if(e._state===Be.Resolved)throw new Error("Cannot call resolve twice");e._state=Be.Resolved,e._onDidChangeState.fire(),e._collector.flush();const n=kx(r);e._proxy.$completeExecution(e._handle,new Qe({runEndTime:s,lastRunSuccess:i,error:n}))},clearOutput(i){return e.verifyStateForOutput(),e.updateOutputs([],i,!1)},appendOutput(i,s){return e.verifyStateForOutput(),e.updateOutputs(i,s,!0)},replaceOutput(i,s){return e.verifyStateForOutput(),e.updateOutputs(i,s,!1)},appendOutputItems(i,s){return e.verifyStateForOutput(),e.updateOutputItems(i,s,!0)},replaceOutputItems(i,s){return e.verifyStateForOutput(),e.updateOutputItems(i,s,!1)}})}}function kx(a){const e=s=>s?{startLineNumber:s.start.line,startColumn:s.start.character,endLineNumber:s.end.line,endColumn:s.end.character}:void 0,t=s=>({uri:s.uri,position:s.position,label:s.label});return a?{name:a.name,message:a.message,stack:a.stack instanceof Array?a.stack.map(s=>t(s)):a.stack,location:e(a.location),uri:a.uri}:void 0}var Ze;(function(a){a[a.Init=0]="Init",a[a.Started=1]="Started",a[a.Resolved=2]="Resolved"})(Ze||(Ze={}));class nc extends Z{static{this.HANDLE=0}get state(){return this._state}constructor(e,t,i){super(),this._notebook=t,this._proxy=i,this._handle=nc.HANDLE++,this._onDidChangeState=new D,this.onDidChangeState=this._onDidChangeState.event,this._state=Ze.Init,this._tokenSource=this._register(new he),this._proxy.$createNotebookExecution(this._handle,e,this._notebook.uri)}cancel(){this._tokenSource.cancel()}asApiObject(){return Object.freeze({start:()=>{if(this._state===Ze.Resolved||this._state===Ze.Started)throw new Error("Cannot call start again");this._state=Ze.Started,this._onDidChangeState.fire(),this._proxy.$beginNotebookExecution(this._handle)},end:()=>{if(this._state===Ze.Resolved)throw new Error("Cannot call resolve twice");this._state=Ze.Resolved,this._onDidChangeState.fire(),this._proxy.$completeNotebookExecution(this._handle)}})}}class Ix{constructor(e,t){this.delay=e,this.callback=t,this.batch=[],this.startedTimer=Date.now()}addItem(e){return this.batch.push(e),this.currentDeferred||(this.currentDeferred=new Js,this.startedTimer=Date.now(),Nt(this.delay).then(()=>this.flush())),Date.now()-this.startedTimer>this.delay?this.flush():this.currentDeferred.p}flush(){if(this.batch.length===0||!this.currentDeferred)return Promise.resolve();const e=this.currentDeferred;this.currentDeferred=void 0;const t=this.batch;return this.batch=[],this.callback(t).finally(()=>e.complete())}}function Cs(a,e){return`${a.value}/${e}`}class Rx{constructor(e,t){this._extHostNotebook=t,this._rendererMessageEmitters=new Map,this.proxy=e.getProxy(k.MainThreadNotebookRenderers)}$postRendererMessage(e,t,i){const s=this._extHostNotebook.getEditorById(e);this._rendererMessageEmitters.get(t)?.fire({editor:s.apiEditor,message:i})}createRendererMessaging(e,t){if(!e.contributes?.notebookRenderer?.some(s=>s.id===t))throw new Error(`Extensions may only call createRendererMessaging() for renderers they contribute (got ${t})`);return{onDidReceiveMessage:(s,r,n)=>this.getOrCreateEmitterFor(t).event(s,r,n),postMessage:(s,r)=>{ns.apiEditorsToExtHost.has(s)&&([s,r]=[r,s]);const n=r&&ns.apiEditorsToExtHost.get(r);return this.proxy.$postMessage(n?.id,t,s)}}}getOrCreateEmitterFor(e){let t=this._rendererMessageEmitters.get(e);return t||(t=new D({onDidRemoveLastListener:()=>{t?.dispose(),this._rendererMessageEmitters.delete(e)}}),this._rendererMessageEmitters.set(e,t),t)}}class Ax{constructor(e){this.handlers=new Map,this.proxy=e.getProxy(k.MainThreadProfileContentHandlers)}registerProfileContentHandler(e,t,i){if(b(e,"profileContentHandlers"),this.handlers.has(t))throw new Error(`Handler with id '${t}' already registered`);return this.handlers.set(t,i),this.proxy.$registerProfileContentHandler(t,i.name,i.description,e.identifier.value),V(()=>{this.handlers.delete(t),this.proxy.$unregisterProfileContentHandler(t)})}async $saveProfile(e,t,i,s){const r=this.handlers.get(e);if(!r)throw new Error(`Unknown handler with id: ${e}`);return r.saveProfile(t,i,s)}async $readProfile(e,t,i){const s=this.handlers.get(e);if(!s)throw new Error(`Unknown handler with id: ${e}`);return s.readProfile(hi(t)?t:v.revive(t),i)}}class oc{static{this.handlePool=0}constructor(e,t){this.uriTransformer=t,this.providers=new Map,this.proxy=e.getProxy(k.MainThreadQuickDiff)}$provideOriginalResource(e,t,i){const s=v.revive(t),r=this.providers.get(e);return r?xe(()=>r.provideOriginalResource(s,i)).then(n=>n||null):Promise.resolve(null)}registerQuickDiffProvider(e,t,i,s,r,n){const o=oc.handlePool++;this.providers.set(o,i);const c=me.toKey(e.identifier);return this.proxy.$registerQuickDiffProvider(o,Sr.from(t,this.uriTransformer),`${c}.${s}`,r,n),{dispose:()=>{this.proxy.$unregisterQuickDiffProvider(o),this.providers.delete(o)}}}}function $x(a,e,t){const i=a.getProxy(k.MainThreadQuickOpen);class s{constructor(l,p){this._sessions=new Map,this._instances=0,this._workspace=l,this._commands=p}showQuickPick(l,p,_,x=de.None){this._onDidSelectItem=void 0;const S=Promise.resolve(p),C=++this._instances,T=i.$show(C,{title:_?.title,placeHolder:_?.placeHolder,matchOnDescription:_?.matchOnDescription,matchOnDetail:_?.matchOnDetail,ignoreFocusLost:_?.ignoreFocusOut,canPickMany:_?.canPickMany},x),O={},I=T.then(()=>O);return Promise.race([I,S]).then(B=>{if(B===O)return;const Q=ie(l,"quickPickItemTooltip");return S.then(K=>{const ze=[];for(let le=0;le<K.length;le++){const J=K[le];if(typeof J=="string")ze.push({label:J,handle:le});else if(J.kind===uo.Separator)ze.push({type:"separator",label:J.label});else{J.tooltip&&!Q&&console.warn(`Extension '${l.identifier.value}' uses a tooltip which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${l.identifier.value}`);const ue=J.iconPath?d(J.iconPath):void 0;ze.push({label:J.label,iconPath:ue?.iconPath,iconClass:ue?.iconClass,description:J.description,detail:J.detail,picked:J.picked,alwaysShow:J.alwaysShow,tooltip:Q?ae.fromStrict(J.tooltip):void 0,handle:le})}}return _&&typeof _.onDidSelectItem=="function"&&(this._onDidSelectItem=le=>{_.onDidSelectItem(K[le])}),i.$setItems(C,ze),T.then(le=>{if(typeof le=="number")return K[le];if(Array.isArray(le))return le.map(J=>K[J])})})}).then(void 0,B=>{if(!Wt(B))return i.$setError(C,B),Promise.reject(B)})}$onItemSelected(l){this._onDidSelectItem?.(l)}showInput(l,p=de.None){return this._validateInput=l?.validateInput,i.$input(l,typeof this._validateInput=="function",p).then(void 0,_=>{if(!Wt(_))return Promise.reject(_)})}async $validateInput(l){if(!this._validateInput)return;const p=await this._validateInput(l);if(!p||typeof p=="string")return p;let _;switch(p.severity){case Ns.Info:_=Te.Info;break;case Ns.Warning:_=Te.Warning;break;case Ns.Error:_=Te.Error;break;default:_=p.message?Te.Error:Te.Ignore;break}return{content:p.message,severity:_}}async showWorkspaceFolderPick(l,p=de.None){const _=await this._commands.executeCommand("_workbench.pickWorkspaceFolder",[l]);if(!_)return;const x=await this._workspace.getWorkspaceFolders2();if(x)return x.find(S=>S.uri.toString()===_.uri.toString())}createQuickPick(l){const p=new h(l,()=>this._sessions.delete(p._id));return this._sessions.set(p._id,p),p}createInputBox(l){const p=new f(l,()=>this._sessions.delete(p._id));return this._sessions.set(p._id,p),p}$onDidChangeValue(l,p){this._sessions.get(l)?._fireDidChangeValue(p)}$onDidAccept(l){this._sessions.get(l)?._fireDidAccept()}$onDidChangeActive(l,p){const _=this._sessions.get(l);_ instanceof h&&_._fireDidChangeActive(p)}$onDidChangeSelection(l,p){const _=this._sessions.get(l);_ instanceof h&&_._fireDidChangeSelection(p)}$onDidTriggerButton(l,p){this._sessions.get(l)?._fireDidTriggerButton(p)}$onDidTriggerItemButton(l,p,_){const x=this._sessions.get(l);x instanceof h&&x._fireDidTriggerItemButton(p,_)}$onDidHide(l){this._sessions.get(l)?._fireDidHide()}}class r{static{this._nextId=1}constructor(l,p){this._extension=l,this._onDidDispose=p,this._id=h._nextId++,this._visible=!1,this._expectingHide=!1,this._enabled=!0,this._busy=!1,this._ignoreFocusOut=!0,this._value="",this._valueSelection=void 0,this._buttons=[],this._handlesToButtons=new Map,this._onDidAcceptEmitter=new D,this._onDidChangeValueEmitter=new D,this._onDidTriggerButtonEmitter=new D,this._onDidHideEmitter=new D,this._pendingUpdate={id:this._id},this._disposed=!1,this._disposables=[this._onDidTriggerButtonEmitter,this._onDidHideEmitter,this._onDidAcceptEmitter,this._onDidChangeValueEmitter],this.onDidChangeValue=this._onDidChangeValueEmitter.event,this.onDidAccept=this._onDidAcceptEmitter.event,this.onDidTriggerButton=this._onDidTriggerButtonEmitter.event,this.onDidHide=this._onDidHideEmitter.event}get title(){return this._title}set title(l){this._title=l,this.update({title:l})}get step(){return this._steps}set step(l){this._steps=l,this.update({step:l})}get totalSteps(){return this._totalSteps}set totalSteps(l){this._totalSteps=l,this.update({totalSteps:l})}get enabled(){return this._enabled}set enabled(l){this._enabled=l,this.update({enabled:l})}get busy(){return this._busy}set busy(l){this._busy=l,this.update({busy:l})}get ignoreFocusOut(){return this._ignoreFocusOut}set ignoreFocusOut(l){this._ignoreFocusOut=l,this.update({ignoreFocusOut:l})}get value(){return this._value}set value(l){this._value=l,this.update({value:l})}get valueSelection(){return this._valueSelection}set valueSelection(l){this._valueSelection=l,this.update({valueSelection:l})}get placeholder(){return this._placeholder}set placeholder(l){this._placeholder=l,this.update({placeholder:l})}get buttons(){return this._buttons}set buttons(l){const p=ie(this._extension,"quickInputButtonLocation");!p&&l.some(_=>_.location)&&console.warn(`Extension '${this._extension.identifier.value}' uses a button location which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${this._extension.identifier.value}`),this._buttons=l.slice(),this._handlesToButtons.clear(),l.forEach((_,x)=>{const S=_===ho.Back?-1:x;this._handlesToButtons.set(S,_)}),this.update({buttons:l.map((_,x)=>({...d(_.iconPath),tooltip:_.tooltip,handle:_===ho.Back?-1:x,location:p?_.location:void 0}))})}show(){this._visible=!0,this._expectingHide=!0,this.update({visible:!0})}hide(){this._visible=!1,this.update({visible:!1})}_fireDidAccept(){this._onDidAcceptEmitter.fire()}_fireDidChangeValue(l){this._value=l,this._onDidChangeValueEmitter.fire(l)}_fireDidTriggerButton(l){const p=this._handlesToButtons.get(l);p&&this._onDidTriggerButtonEmitter.fire(p)}_fireDidHide(){this._expectingHide&&(this._expectingHide=this._visible,this._onDidHideEmitter.fire())}dispose(){this._disposed||(this._disposed=!0,this._fireDidHide(),this._disposables=Gs(this._disposables),this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=void 0),this._onDidDispose(),i.$dispose(this._id))}update(l){if(!this._disposed){for(const p of Object.keys(l)){const _=l[p];this._pendingUpdate[p]=_===void 0?null:_}"visible"in this._pendingUpdate?(this._updateTimeout&&(clearTimeout(this._updateTimeout),this._updateTimeout=void 0),this.dispatchUpdate()):this._visible&&!this._updateTimeout&&(this._updateTimeout=setTimeout(()=>{this._updateTimeout=void 0,this.dispatchUpdate()},0))}}dispatchUpdate(){i.$createOrUpdate(this._pendingUpdate),this._pendingUpdate={id:this._id}}}function n(m){if(m instanceof Et)return{id:m.id};const l=c(m),p=o(m);return{dark:typeof l=="string"?v.file(l):l,light:typeof p=="string"?v.file(p):p}}function o(m){return typeof m=="object"&&"light"in m?m.light:m}function c(m){return typeof m=="object"&&"dark"in m?m.dark:m}function d(m){const l=n(m);let p,_;return"id"in l?_=as.asClassName(l):p=l,{iconPath:p,iconClass:_}}class h extends r{constructor(l,p){super(l,p),this._items=[],this._handlesToItems=new Map,this._itemsToHandles=new Map,this._canSelectMany=!1,this._matchOnDescription=!0,this._matchOnDetail=!0,this._sortByLabel=!0,this._keepScrollPosition=!1,this._activeItems=[],this._onDidChangeActiveEmitter=new D,this._selectedItems=[],this._onDidChangeSelectionEmitter=new D,this._onDidTriggerItemButtonEmitter=new D,this.onDidChangeActive=this._onDidChangeActiveEmitter.event,this.onDidChangeSelection=this._onDidChangeSelectionEmitter.event,this.onDidTriggerItemButton=this._onDidTriggerItemButtonEmitter.event,this._disposables.push(this._onDidChangeActiveEmitter,this._onDidChangeSelectionEmitter,this._onDidTriggerItemButtonEmitter),this.update({type:"quickPick"})}get items(){return this._items}set items(l){this._items=l.slice(),this._handlesToItems.clear(),this._itemsToHandles.clear(),l.forEach((x,S)=>{this._handlesToItems.set(S,x),this._itemsToHandles.set(x,S)});const p=ie(this._extension,"quickPickItemTooltip"),_=[];for(let x=0;x<l.length;x++){const S=l[x];if(S.kind===uo.Separator)_.push({type:"separator",label:S.label});else{S.tooltip&&!p&&console.warn(`Extension '${this._extension.identifier.value}' uses a tooltip which is proposed API that is only available when running out of dev or with the following command line switch: --enable-proposed-api ${this._extension.identifier.value}`);const C=S.iconPath?d(S.iconPath):void 0;_.push({handle:x,label:S.label,iconPath:C?.iconPath,iconClass:C?.iconClass,description:S.description,detail:S.detail,picked:S.picked,alwaysShow:S.alwaysShow,tooltip:p?ae.fromStrict(S.tooltip):void 0,buttons:S.buttons?.map((T,O)=>({...d(T.iconPath),tooltip:T.tooltip,handle:O}))})}}this.update({items:_})}get canSelectMany(){return this._canSelectMany}set canSelectMany(l){this._canSelectMany=l,this.update({canSelectMany:l})}get matchOnDescription(){return this._matchOnDescription}set matchOnDescription(l){this._matchOnDescription=l,this.update({matchOnDescription:l})}get matchOnDetail(){return this._matchOnDetail}set matchOnDetail(l){this._matchOnDetail=l,this.update({matchOnDetail:l})}get sortByLabel(){return this._sortByLabel}set sortByLabel(l){this._sortByLabel=l,this.update({sortByLabel:l})}get keepScrollPosition(){return this._keepScrollPosition}set keepScrollPosition(l){this._keepScrollPosition=l,this.update({keepScrollPosition:l})}get activeItems(){return this._activeItems}set activeItems(l){this._activeItems=l.filter(p=>this._itemsToHandles.has(p)),this.update({activeItems:this._activeItems.map(p=>this._itemsToHandles.get(p))})}get selectedItems(){return this._selectedItems}set selectedItems(l){this._selectedItems=l.filter(p=>this._itemsToHandles.has(p)),this.update({selectedItems:this._selectedItems.map(p=>this._itemsToHandles.get(p))})}_fireDidChangeActive(l){const p=Re(l.map(_=>this._handlesToItems.get(_)));this._activeItems=p,this._onDidChangeActiveEmitter.fire(p)}_fireDidChangeSelection(l){const p=Re(l.map(_=>this._handlesToItems.get(_)));this._selectedItems=p,this._onDidChangeSelectionEmitter.fire(p)}_fireDidTriggerItemButton(l,p){const _=this._handlesToItems.get(l);if(!_||!_.buttons||!_.buttons.length)return;const x=_.buttons[p];x&&this._onDidTriggerItemButtonEmitter.fire({button:x,item:_})}}class f extends r{constructor(l,p){super(l,p),this._password=!1,this.update({type:"inputBox"})}get password(){return this._password}set password(l){this._password=l,this.update({password:l})}get prompt(){return this._prompt}set prompt(l){this._prompt=l,this.update({prompt:l})}get validationMessage(){return this._validationMessage}set validationMessage(l){this._validationMessage=l,l?typeof l=="string"?this.update({validationMessage:l,severity:Te.Error}):this.update({validationMessage:l.message,severity:l.severity??Te.Error}):this.update({validationMessage:void 0,severity:Te.Ignore})}}return new s(e,t)}var ua;function ll(a){return a instanceof v}function Mx(a,e){return a.scheme===G.file&&e.scheme===G.file&&$f?a.toString()===e.toString():a.toString().toLowerCase()===e.toString().toLowerCase()}function hn(a){if(a)return typeof a.iconPath=="string"?v.file(a.iconPath):v.isUri(a.iconPath)||as.isThemeIcon(a.iconPath)?a.iconPath:void 0}function Ot(a){if(a){if(v.isUri(a))return a;if(as.isThemeIcon(a))return a;{const e=a;return{light:e.light,dark:e.dark}}}else return}function Hx(a){const e=Ot(a.authorIcon),t=a.references?.map(i=>({...i,icon:Ot(i.icon)}));return{...a,authorIcon:e,references:t}}function un(a){return a?{...a,icon:Ot(a.icon)}:void 0}function pn(a,e){if(!a.iconPath&&!e.iconPath)return 0;if(a.iconPath){if(!e.iconPath)return 1}else return-1;const t=typeof a.iconPath=="string"?a.iconPath:v.isUri(a.iconPath)?a.iconPath.fsPath:a.iconPath.id,i=typeof e.iconPath=="string"?e.iconPath:v.isUri(e.iconPath)?e.iconPath.fsPath:e.iconPath.id;return Ds(t,i)}function Fx(a,e){let t=0;if(a.strikeThrough!==e.strikeThrough)return a.strikeThrough?1:-1;if(a.faded!==e.faded)return a.faded?1:-1;if(a.tooltip!==e.tooltip)return(a.tooltip||"").localeCompare(e.tooltip||"");if(t=pn(a,e),t!==0)return t;if(a.light&&e.light)t=pn(a.light,e.light);else{if(a.light)return 1;if(e.light)return-1}if(t!==0)return t;if(a.dark&&e.dark)t=pn(a.dark,e.dark);else{if(a.dark)return 1;if(e.dark)return-1}return t}function Lx(a,e){if(a.command!==e.command)return a.command<e.command?-1:1;if(a.title!==e.title)return a.title<e.title?-1:1;if(a.tooltip!==e.tooltip){if(a.tooltip!==void 0&&e.tooltip!==void 0)return a.tooltip<e.tooltip?-1:1;if(a.tooltip!==void 0)return 1;if(e.tooltip!==void 0)return-1}if(a.arguments===e.arguments)return 0;if(a.arguments)if(e.arguments){if(a.arguments.length!==e.arguments.length)return a.arguments.length-e.arguments.length}else return 1;else return-1;for(let t=0;t<a.arguments.length;t++){const i=a.arguments[t],s=e.arguments[t];if(i!==s&&!(ll(i)&&ll(s)&&Mx(i,s)))return i<s?-1:1}return 0}function hl(a,e){let t=Ds(a.resourceUri.fsPath,e.resourceUri.fsPath,!0);if(t!==0)return t;if(a.command&&e.command)t=Lx(a.command,e.command);else{if(a.command)return 1;if(e.command)return-1}if(t!==0)return t;if(a.decorations&&e.decorations)t=Fx(a.decorations,e.decorations);else{if(a.decorations)return 1;if(e.decorations)return-1}if(t!==0)return t;if(a.multiFileDiffEditorModifiedUri&&e.multiFileDiffEditorModifiedUri)t=Ds(a.multiFileDiffEditorModifiedUri.fsPath,e.multiFileDiffEditorModifiedUri.fsPath,!0);else{if(a.multiFileDiffEditorModifiedUri)return 1;if(e.multiFileDiffEditorModifiedUri)return-1}if(t!==0)return t;if(a.multiDiffEditorOriginalUri&&e.multiDiffEditorOriginalUri)t=Ds(a.multiDiffEditorOriginalUri.fsPath,e.multiDiffEditorOriginalUri.fsPath,!0);else{if(a.multiDiffEditorOriginalUri)return 1;if(e.multiDiffEditorOriginalUri)return-1}return t}function Nx(a,e){for(let t=0;t<a.length;t++)if(a[t]!==e[t])return!1;return!0}function Ox(a,e){return a.command===e.command&&a.title===e.title&&a.tooltip===e.tooltip&&(a.arguments&&e.arguments?Nx(a.arguments,e.arguments):a.arguments===e.arguments)}function Ux(a,e){return pi(a,e,Ox)}class Wx{#e;#t;get value(){return this._value}set value(e){e=e??"",this.#e.$setInputBoxValue(this._sourceControlHandle,e),this.updateValue(e)}get onDidChange(){return this._onDidChange.event}get placeholder(){return this._placeholder}set placeholder(e){this.#e.$setInputBoxPlaceholder(this._sourceControlHandle,e),this._placeholder=e}get validateInput(){return b(this._extension,"scmValidation"),this._validateInput}set validateInput(e){if(b(this._extension,"scmValidation"),e&&typeof e!="function")throw new Error(`[${this._extension.identifier.value}]: Invalid SCM input box validation function`);this._validateInput=e,this.#e.$setValidationProviderIsEnabled(this._sourceControlHandle,!!e)}get enabled(){return this._enabled}set enabled(e){e=!!e,this._enabled!==e&&(this._enabled=e,this.#e.$setInputBoxEnablement(this._sourceControlHandle,e))}get visible(){return this._visible}set visible(e){e=!!e,this._visible!==e&&(this._visible=e,this.#e.$setInputBoxVisibility(this._sourceControlHandle,e))}get document(){return b(this._extension,"scmTextDocument"),this.#t.getDocument(this._documentUri)}constructor(e,t,i,s,r){this._extension=e,this._sourceControlHandle=s,this._documentUri=r,this._value="",this._onDidChange=new D,this._placeholder="",this._enabled=!0,this._visible=!0,this.#t=t,this.#e=i}showValidationMessage(e,t){b(this._extension,"scmValidation"),this.#e.$showValidationMessage(this._sourceControlHandle,e,t)}$onInputBoxValueChange(e){this.updateValue(e)}updateValue(e){this._value=e,this._onDidChange.fire(e)}}class ac{static{this._handlePool=0}get disposed(){return this._disposed}get id(){return this._id}get label(){return this._label}set label(e){this._label=e,this._proxy.$updateGroupLabel(this._sourceControlHandle,this.handle,e)}get contextValue(){return this._contextValue}set contextValue(e){this._contextValue=e,this._proxy.$updateGroup(this._sourceControlHandle,this.handle,this.features)}get hideWhenEmpty(){return this._hideWhenEmpty}set hideWhenEmpty(e){this._hideWhenEmpty=e,this._proxy.$updateGroup(this._sourceControlHandle,this.handle,this.features)}get features(){return{contextValue:this.contextValue,hideWhenEmpty:this.hideWhenEmpty}}get resourceStates(){return[...this._resourceStates]}set resourceStates(e){this._resourceStates=[...e],this._onDidUpdateResourceStates.fire()}constructor(e,t,i,s,r,n,o){this._proxy=e,this._commands=t,this._sourceControlHandle=i,this._id=s,this._label=r,this.multiDiffEditorEnableViewChanges=n,this._extension=o,this._resourceHandlePool=0,this._resourceStates=[],this._resourceStatesMap=new Map,this._resourceStatesCommandsMap=new Map,this._resourceStatesDisposablesMap=new Map,this._onDidUpdateResourceStates=new D,this.onDidUpdateResourceStates=this._onDidUpdateResourceStates.event,this._disposed=!1,this._onDidDispose=new D,this.onDidDispose=this._onDidDispose.event,this._handlesSnapshot=[],this._resourceSnapshot=[],this._contextValue=void 0,this._hideWhenEmpty=void 0,this.handle=ac._handlePool++}getResourceState(e){return this._resourceStatesMap.get(e)}$executeResourceCommand(e,t){const i=this._resourceStatesCommandsMap.get(e);return i?xe(()=>this._commands.executeCommand(i.command,...i.arguments||[],t)):Promise.resolve(void 0)}_takeResourceStateSnapshot(){const e=[...this._resourceStates].sort(hl),i=Rf(this._resourceSnapshot,e,hl).map(n=>{const o=n.toInsert.map(c=>{const d=this._resourceHandlePool++;this._resourceStatesMap.set(d,c);const h=c.resourceUri;let f;if(c.command)if(c.command.command==="vscode.open"||c.command.command==="vscode.diff"||c.command.command==="vscode.changes"){const K=new N;f=this._commands.converter.toInternal(c.command,K),this._resourceStatesDisposablesMap.set(d,K)}else this._resourceStatesCommandsMap.set(d,c.command);const m=ie(this._extension,"scmMultiDiffEditor"),l=m?c.multiDiffEditorOriginalUri:void 0,p=m?c.multiFileDiffEditorModifiedUri:void 0,_=hn(c.decorations),x=c.decorations&&hn(c.decorations.light)||_,S=c.decorations&&hn(c.decorations.dark)||_,C=[x,S],T=c.decorations&&c.decorations.tooltip||"",O=c.decorations&&!!c.decorations.strikeThrough,I=c.decorations&&!!c.decorations.faded,B=c.contextValue||"";return{rawResource:[d,h,C,T,O,I,B,f,l,p],handle:d}});return{start:n.start,deleteCount:n.deleteCount,toInsert:o}}),s=i.map(({start:n,deleteCount:o,toInsert:c})=>[n,o,c.map(d=>d.rawResource)]),r=i.reverse();for(const{start:n,deleteCount:o,toInsert:c}of r){const d=c.map(f=>f.handle),h=this._handlesSnapshot.splice(n,o,...d);for(const f of h)this._resourceStatesMap.delete(f),this._resourceStatesCommandsMap.delete(f),this._resourceStatesDisposablesMap.get(f)?.dispose(),this._resourceStatesDisposablesMap.delete(f)}return this._resourceSnapshot=e,s}dispose(){this._disposed=!0,this._onDidDispose.fire()}}class Bt{static{this._handlePool=0}#e;get id(){return this._id}get label(){return this._label}get rootUri(){return this._rootUri}get inputBox(){return this._inputBox}get count(){return this._count}set count(e){this._count!==e&&(this._count=e,this.#e.$updateSourceControl(this.handle,{count:e}))}get quickDiffProvider(){return this._quickDiffProvider}set quickDiffProvider(e){this._quickDiffProvider=e;let t;ie(this._extension,"quickDiffProvider")&&(t=e?.label),this.#e.$updateSourceControl(this.handle,{hasQuickDiffProvider:!!e,quickDiffLabel:t})}get secondaryQuickDiffProvider(){return b(this._extension,"quickDiffProvider"),this._secondaryQuickDiffProvider}set secondaryQuickDiffProvider(e){b(this._extension,"quickDiffProvider"),this._secondaryQuickDiffProvider=e;const t=e?.label;this.#e.$updateSourceControl(this.handle,{hasSecondaryQuickDiffProvider:!!e,secondaryQuickDiffLabel:t})}get historyProvider(){return b(this._extension,"scmHistoryProvider"),this._historyProvider}set historyProvider(e){b(this._extension,"scmHistoryProvider"),this._historyProvider=e,this._historyProviderDisposable.value=new N,this.#e.$updateSourceControl(this.handle,{hasHistoryProvider:!!e}),e&&(this._historyProviderDisposable.value.add(e.onDidChangeCurrentHistoryItemRefs(()=>{const t=un(e?.currentHistoryItemRef),i=un(e?.currentHistoryItemRemoteRef),s=un(e?.currentHistoryItemBaseRef);this.#e.$onDidChangeHistoryProviderCurrentHistoryItemRefs(this.handle,t,i,s)})),this._historyProviderDisposable.value.add(e.onDidChangeHistoryItemRefs(t=>{if(t.added.length===0&&t.modified.length===0&&t.removed.length===0)return;const i=t.added.map(n=>({...n,icon:Ot(n.icon)})),s=t.modified.map(n=>({...n,icon:Ot(n.icon)})),r=t.removed.map(n=>({...n,icon:Ot(n.icon)}));this.#e.$onDidChangeHistoryProviderHistoryItemRefs(this.handle,{added:i,modified:s,removed:r,silent:t.silent})})))}get commitTemplate(){return this._commitTemplate}set commitTemplate(e){e!==this._commitTemplate&&(this._commitTemplate=e,this.#e.$updateSourceControl(this.handle,{commitTemplate:e}))}get acceptInputCommand(){return this._acceptInputCommand}set acceptInputCommand(e){this._acceptInputDisposables.value=new N,this._acceptInputCommand=e;const t=this._commands.converter.toInternal(e,this._acceptInputDisposables.value);this.#e.$updateSourceControl(this.handle,{acceptInputCommand:t})}get actionButton(){return b(this._extension,"scmActionButton"),this._actionButton}set actionButton(e){if(b(this._extension,"scmActionButton"),Af(this._actionButton,e))return;this._actionButton=e,this._actionButtonDisposables.value=new N;const t=e!==void 0?{command:{...this._commands.converter.toInternal(e.command,this._actionButtonDisposables.value),shortTitle:e.command.shortTitle},secondaryCommands:e.secondaryCommands?.map(i=>i.map(s=>this._commands.converter.toInternal(s,this._actionButtonDisposables.value))),enabled:e.enabled}:void 0;this.#e.$updateSourceControl(this.handle,{actionButton:t??null})}get statusBarCommands(){return this._statusBarCommands}set statusBarCommands(e){if(this._statusBarCommands&&e&&Ux(this._statusBarCommands,e))return;this._statusBarDisposables.value=new N,this._statusBarCommands=e;const t=(e||[]).map(i=>this._commands.converter.toInternal(i,this._statusBarDisposables.value));this.#e.$updateSourceControl(this.handle,{statusBarCommands:t})}get selected(){return this._selected}constructor(e,t,i,s,r,n,o){this._extension=e,this._commands=s,this._id=r,this._label=n,this._rootUri=o,this._groups=new Map,this._count=void 0,this._quickDiffProvider=void 0,this._secondaryQuickDiffProvider=void 0,this._historyProviderDisposable=new Ht,this._commitTemplate=void 0,this._acceptInputDisposables=new Ht,this._acceptInputCommand=void 0,this._actionButtonDisposables=new Ht,this._statusBarDisposables=new Ht,this._statusBarCommands=void 0,this._selected=!1,this._onDidChangeSelection=new D,this.onDidChangeSelection=this._onDidChangeSelection.event,this.handle=Bt._handlePool++,this.createdResourceGroups=new Map,this.updatedResourceGroups=new Set,this.#e=i;const c=v.from({scheme:G.vscodeSourceControl,path:`${r}/scm${this.handle}/input`,query:o?`rootUri=${encodeURIComponent(o.toString())}`:void 0});this._inputBox=new Wx(e,t,this.#e,this.handle,c),this.#e.$registerSourceControl(this.handle,r,n,o,c)}createResourceGroup(e,t,i){const s=ie(this._extension,"scmMultiDiffEditor")&&i?.multiDiffEditorEnableViewChanges===!0,r=new ac(this.#e,this._commands,this.handle,e,t,s,this._extension),n=Ee.once(r.onDidDispose)(()=>this.createdResourceGroups.delete(r));return this.createdResourceGroups.set(r,n),this.eventuallyAddResourceGroups(),r}eventuallyAddResourceGroups(){const e=[],t=[];for(const[i,s]of this.createdResourceGroups){s.dispose();const r=i.onDidUpdateResourceStates(()=>{this.updatedResourceGroups.add(i),this.eventuallyUpdateResourceStates()});Ee.once(i.onDidDispose)(()=>{this.updatedResourceGroups.delete(i),r.dispose(),this._groups.delete(i.handle),this.#e.$unregisterGroup(this.handle,i.handle)}),e.push([i.handle,i.id,i.label,i.features,i.multiDiffEditorEnableViewChanges]);const n=i._takeResourceStateSnapshot();n.length>0&&t.push([i.handle,n]),this._groups.set(i.handle,i)}this.#e.$registerGroups(this.handle,e,t),this.createdResourceGroups.clear()}eventuallyUpdateResourceStates(){const e=[];this.updatedResourceGroups.forEach(t=>{const i=t._takeResourceStateSnapshot();i.length!==0&&e.push([t.handle,i])}),e.length>0&&this.#e.$spliceResourceStates(this.handle,e),this.updatedResourceGroups.clear()}getResourceGroup(e){return this._groups.get(e)}setSelectionState(e){this._selected=e,this._onDidChangeSelection.fire(e)}dispose(){this._acceptInputDisposables.dispose(),this._actionButtonDisposables.dispose(),this._statusBarDisposables.dispose(),this._groups.forEach(e=>e.dispose()),this.#e.$unregisterSourceControl(this.handle)}}Bt.__decorator=L([Il(100)],Bt.prototype,"eventuallyAddResourceGroups",null);Bt.__decorator=L([Il(100)],Bt.prototype,"eventuallyUpdateResourceStates",null);let pa=class{static{ua=this}static{this._handlePool=0}get onDidChangeActiveProvider(){return this._onDidChangeActiveProvider.event}constructor(e,t,i,s){this._commands=t,this._extHostDocuments=i,this.logService=s,this._sourceControls=new Map,this._sourceControlsByExtension=new Vt,this._onDidChangeActiveProvider=new D,this._proxy=e.getProxy(k.MainThreadSCM),this._telemetry=e.getProxy(k.MainThreadTelemetry),t.registerArgumentProcessor({processArgument:r=>{if(r&&r.$mid===Se.ScmResource){const n=this._sourceControls.get(r.sourceControlHandle);if(!n)return r;const o=n.getResourceGroup(r.groupHandle);return o?o.getResourceState(r.handle):r}else if(r&&r.$mid===Se.ScmResourceGroup){const n=this._sourceControls.get(r.sourceControlHandle);return n?n.getResourceGroup(r.groupHandle):r}else if(r&&r.$mid===Se.ScmProvider){const n=this._sourceControls.get(r.handle);return n||r}return r}})}createSourceControl(e,t,i,s){this.logService.trace("ExtHostSCM#createSourceControl",e.identifier.value,t,i,s),this._telemetry.$publicLog2("api/scm/createSourceControl",{extensionId:e.identifier.value});const r=ua._handlePool++,n=new Bt(e,this._extHostDocuments,this._proxy,this._commands,t,i,s);this._sourceControls.set(r,n);const o=this._sourceControlsByExtension.get(e.identifier)||[];return o.push(n),this._sourceControlsByExtension.set(e.identifier,o),n}getLastInputBox(e){this.logService.trace("ExtHostSCM#getLastInputBox",e.identifier.value);const t=this._sourceControlsByExtension.get(e.identifier),i=t&&t[t.length-1];return i&&i.inputBox}$provideOriginalResource(e,t,i){const s=v.revive(t);this.logService.trace("ExtHostSCM#$provideOriginalResource",e,s.toString());const r=this._sourceControls.get(e);return!r||!r.quickDiffProvider||!r.quickDiffProvider.provideOriginalResource?Promise.resolve(null):xe(()=>r.quickDiffProvider.provideOriginalResource(s,i)).then(n=>n||null)}$provideSecondaryOriginalResource(e,t,i){const s=v.revive(t);this.logService.trace("ExtHostSCM#$provideSecondaryOriginalResource",e,s.toString());const r=this._sourceControls.get(e);return!r||!r.secondaryQuickDiffProvider||!r.secondaryQuickDiffProvider.provideOriginalResource?Promise.resolve(null):xe(()=>r.secondaryQuickDiffProvider.provideOriginalResource(s,i)).then(n=>n||null)}$onInputBoxValueChange(e,t){this.logService.trace("ExtHostSCM#$onInputBoxValueChange",e);const i=this._sourceControls.get(e);return i&&i.inputBox.$onInputBoxValueChange(t),Promise.resolve(void 0)}$executeResourceCommand(e,t,i,s){this.logService.trace("ExtHostSCM#$executeResourceCommand",e,t,i);const r=this._sourceControls.get(e);if(!r)return Promise.resolve(void 0);const n=r.getResourceGroup(t);return n?n.$executeResourceCommand(i,s):Promise.resolve(void 0)}$validateInput(e,t,i){this.logService.trace("ExtHostSCM#$validateInput",e);const s=this._sourceControls.get(e);return!s||!s.inputBox.validateInput?Promise.resolve(void 0):xe(()=>s.inputBox.validateInput(t,i)).then(r=>{if(!r)return Promise.resolve(void 0);const n=ae.fromStrict(r.message);return n?Promise.resolve([n,r.type]):Promise.resolve(void 0)})}$setSelectedSourceControl(e){return this.logService.trace("ExtHostSCM#$setSelectedSourceControl",e),e!==void 0&&this._sourceControls.get(e)?.setSelectionState(!0),this._selectedSourceControlHandle!==void 0&&this._sourceControls.get(this._selectedSourceControlHandle)?.setSelectionState(!1),this._selectedSourceControlHandle=e,Promise.resolve(void 0)}async $resolveHistoryItemChatContext(e,t,i){try{return await this._sourceControls.get(e)?.historyProvider?.resolveHistoryItemChatContext(t,i)??void 0}catch(s){this.logService.error("ExtHostSCM#$resolveHistoryItemChatContext",s);return}}async $resolveHistoryItemRefsCommonAncestor(e,t,i){try{return await this._sourceControls.get(e)?.historyProvider?.resolveHistoryItemRefsCommonAncestor(t,i)??void 0}catch(s){this.logService.error("ExtHostSCM#$resolveHistoryItemRefsCommonAncestor",s);return}}async $provideHistoryItemRefs(e,t,i){try{return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItemRefs(t,i))?.map(n=>({...n,icon:Ot(n.icon)}))??void 0}catch(s){this.logService.error("ExtHostSCM#$provideHistoryItemRefs",s);return}}async $provideHistoryItems(e,t,i){try{return(await this._sourceControls.get(e)?.historyProvider?.provideHistoryItems(t,i))?.map(n=>Hx(n))??void 0}catch(s){this.logService.error("ExtHostSCM#$provideHistoryItems",s);return}}async $provideHistoryItemChanges(e,t,i,s){try{return await this._sourceControls.get(e)?.historyProvider?.provideHistoryItemChanges(t,i,s)??void 0}catch(r){this.logService.error("ExtHostSCM#$provideHistoryItemChanges",r);return}}};pa=ua=L([E(3,se)],pa);class cc{static{this.handlePool=0}constructor(e,t){this.uriTransformer=t,this.providers=new Map,this.proxy=e.getProxy(k.MainThreadShare)}async $provideShare(e,t,i){return await this.providers.get(e)?.provideShare({selection:A.to(t.selection),resourceUri:v.revive(t.resourceUri)},i)??void 0}registerShareProvider(e,t){const i=cc.handlePool++;return this.providers.set(i,t),this.proxy.$registerShareProvider(i,Sr.from(e,this.uriTransformer),t.id,t.label,t.priority),{dispose:()=>{this.proxy.$unregisterShareProvider(i),this.providers.delete(i)}}}}class dc{static{this.ID_POOL=1}constructor(e){this.providers=new Map,this.sessions=new Map,this.synthesizers=new Map,this.proxy=e.getProxy(k.MainThreadSpeech)}async $createSpeechToTextSession(e,t,i){const s=this.providers.get(e);if(!s)return;const r=new N,n=new he;this.sessions.set(t,n);const o=await s.provideSpeechToTextSession(n.token,i?{language:i}:void 0);o&&(r.add(o.onDidChange(c=>{n.token.isCancellationRequested||this.proxy.$emitSpeechToTextEvent(t,c)})),r.add(n.token.onCancellationRequested(()=>r.dispose())))}async $cancelSpeechToTextSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e)}async $createTextToSpeechSession(e,t,i){const s=this.providers.get(e);if(!s)return;const r=new N,n=new he;this.sessions.set(t,n);const o=await s.provideTextToSpeechSession(n.token,i?{language:i}:void 0);o&&(this.synthesizers.set(t,o),r.add(o.onDidChange(c=>{n.token.isCancellationRequested||this.proxy.$emitTextToSpeechEvent(t,c)})),r.add(n.token.onCancellationRequested(()=>r.dispose())))}async $synthesizeSpeech(e,t){this.synthesizers.get(e)?.synthesize(t)}async $cancelTextToSpeechSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e),this.synthesizers.delete(e)}async $createKeywordRecognitionSession(e,t){const i=this.providers.get(e);if(!i)return;const s=new N,r=new he;this.sessions.set(t,r);const n=await i.provideKeywordRecognitionSession(r.token);n&&(s.add(n.onDidChange(o=>{r.token.isCancellationRequested||this.proxy.$emitKeywordRecognitionEvent(t,o)})),s.add(r.token.onCancellationRequested(()=>s.dispose())))}async $cancelKeywordRecognitionSession(e){this.sessions.get(e)?.dispose(!0),this.sessions.delete(e)}registerProvider(e,t,i){const s=dc.ID_POOL++;return this.providers.set(s,i),this.proxy.$registerProvider(s,t,{extension:e,displayName:e.value}),V(()=>{this.proxy.$unregisterProvider(s),this.providers.delete(s)})}}class es{static{this.ID_GEN=0}static{this.ALLOWED_BACKGROUND_COLORS=new Map([["statusBarItem.errorBackground",new po("statusBarItem.errorForeground")],["statusBarItem.warningBackground",new po("statusBarItem.warningForeground")]])}#e;#t;constructor(e,t,i,s,r,n=ri.Left,o,c){if(this._onDispose=c,this._disposed=!1,this._text="",this._staleCommandRegistrations=new N,this.#e=e,this.#t=t,r&&s){this._entryId=Tm(s.identifier,r);const d=i.get(this._entryId);d&&(n=d.alignLeft?ri.Left:ri.Right,o=d.priority,this._visible=!0,this.name=d.name,this.text=d.text,this.tooltip=d.tooltip,this.command=d.command,this.accessibilityInformation=d.accessibilityInformation)}else this._entryId=String(es.ID_GEN++);this._extension=s,this._id=r,this._alignment=n,this._priority=this.validatePriority(o)}validatePriority(e){if(Mf(e))return e===Number.POSITIVE_INFINITY?Number.MAX_VALUE:e===Number.NEGATIVE_INFINITY?-Number.MAX_VALUE:e}get id(){return this._id??this._extension.identifier.value}get entryId(){return this._entryId}get alignment(){return this._alignment}get priority(){return this._priority}get text(){return this._text}get name(){return this._name}get tooltip(){return this._tooltip}get tooltip2(){return this._extension&&b(this._extension,"statusBarItemTooltip"),this._tooltip2}get color(){return this._color}get backgroundColor(){return this._backgroundColor}get command(){return this._command?.fromApi}get accessibilityInformation(){return this._accessibilityInformation}set text(e){this._text=e,this.update()}set name(e){this._name=e,this.update()}set tooltip(e){this._tooltip=e,this.update()}set tooltip2(e){this._extension&&b(this._extension,"statusBarItemTooltip"),this._tooltip2=e,this.update()}set color(e){this._color=e,this.update()}set backgroundColor(e){e&&!es.ALLOWED_BACKGROUND_COLORS.has(e.id)&&(e=void 0),this._backgroundColor=e,this.update()}set command(e){this._command?.fromApi!==e&&(this._latestCommandRegistration&&this._staleCommandRegistrations.add(this._latestCommandRegistration),this._latestCommandRegistration=new N,typeof e=="string"?this._command={fromApi:e,internal:this.#t.toInternal({title:"",command:e},this._latestCommandRegistration)}:e?this._command={fromApi:e,internal:this.#t.toInternal(e,this._latestCommandRegistration)}:this._command=void 0,this.update())}set accessibilityInformation(e){this._accessibilityInformation=e,this.update()}show(){this._visible=!0,this.update()}hide(){clearTimeout(this._timeoutHandle),this._visible=!1,this.#e.$disposeEntry(this._entryId)}update(){this._disposed||!this._visible||(clearTimeout(this._timeoutHandle),this._timeoutHandle=setTimeout(()=>{this._timeoutHandle=void 0;let e;this._extension?this._id?e=`${this._extension.identifier.value}.${this._id}`:e=this._extension.identifier.value:e=this._id;let t;this._name?t=this._name:t=j(2590,"{0} (Extension)",this._extension.displayName||this._extension.name);let i=this._color;this._backgroundColor&&(i=es.ALLOWED_BACKGROUND_COLORS.get(this._backgroundColor.id));let s,r;typeof this._tooltip2=="function"?(s=ae.fromStrict(this._tooltip),r=!0):(s=ae.fromStrict(this._tooltip2??this._tooltip),r=!1),this.#e.$setEntry(this._entryId,e,this._extension?.identifier.value,t,this._text,s,r,this._command?.internal,i,this._backgroundColor,this._alignment===ri.Left,this._priority,this._accessibilityInformation),this._staleCommandRegistrations.clear()},0))}dispose(){this.hide(),this._onDispose?.(),this._disposed=!0}}class Vx{constructor(e){this._messages=[],this._item=e.createStatusBarEntry(void 0,"status.extensionMessage",ri.Left,Number.MIN_VALUE),this._item.name=j(2591,"Extension Status")}dispose(){this._messages.length=0,this._item.dispose()}setMessage(e){const t={message:e};return this._messages.unshift(t),this._update(),new W(()=>{const i=this._messages.indexOf(t);i>=0&&(this._messages.splice(i,1),this._update())})}_update(){this._messages.length>0?(this._item.text=this._messages[0].message,this._item.show()):this._item.hide()}}class Bx{constructor(e,t){this._entries=new Map,this._existingItems=new Map,this._proxy=e.getProxy(k.MainThreadStatusBar),this._commands=t,this._statusMessage=new Vx(this)}$acceptStaticEntries(e){for(const t of e)this._existingItems.set(t.entryId,t)}async $provideTooltip(e,t){const i=this._entries.get(e);if(!i)return;const s=typeof i.tooltip2=="function"?await i.tooltip2(t):i.tooltip2;return t.isCancellationRequested?void 0:ae.fromStrict(s)}createStatusBarEntry(e,t,i,s){const r=new es(this._proxy,this._commands,this._existingItems,e,t,i,s,()=>this._entries.delete(r.entryId));return this._entries.set(r.entryId,r),r}setStatusBarMessage(e,t){const i=this._statusMessage.setMessage(e);let s;return typeof t=="number"?s=setTimeout(()=>i.dispose(),t):typeof t<"u"&&t.then(()=>i.dispose(),()=>i.dispose()),new W(()=>{i.dispose(),clearTimeout(s)})}}class zx extends Z{constructor(e,t){super(),this._extHostDocumentsAndEditors=t,this._onDidChangeTextEditorSelection=new D,this._onDidChangeTextEditorOptions=new D,this._onDidChangeTextEditorVisibleRanges=new D,this._onDidChangeTextEditorViewColumn=new D,this._onDidChangeTextEditorDiffInformation=new D,this._onDidChangeActiveTextEditor=new D,this._onDidChangeVisibleTextEditors=new D,this.onDidChangeTextEditorSelection=this._onDidChangeTextEditorSelection.event,this.onDidChangeTextEditorOptions=this._onDidChangeTextEditorOptions.event,this.onDidChangeTextEditorVisibleRanges=this._onDidChangeTextEditorVisibleRanges.event,this.onDidChangeTextEditorViewColumn=this._onDidChangeTextEditorViewColumn.event,this.onDidChangeTextEditorDiffInformation=this._onDidChangeTextEditorDiffInformation.event,this.onDidChangeActiveTextEditor=this._onDidChangeActiveTextEditor.event,this.onDidChangeVisibleTextEditors=this._onDidChangeVisibleTextEditors.event,this._proxy=e.getProxy(k.MainThreadTextEditors),this._register(this._extHostDocumentsAndEditors.onDidChangeVisibleTextEditors(i=>this._onDidChangeVisibleTextEditors.fire(i))),this._register(this._extHostDocumentsAndEditors.onDidChangeActiveTextEditor(i=>this._onDidChangeActiveTextEditor.fire(i)))}getActiveTextEditor(){return this._extHostDocumentsAndEditors.activeEditor()}getVisibleTextEditors(e){const t=this._extHostDocumentsAndEditors.allEditors();return e?t:t.map(i=>i.value)}async showTextDocument(e,t,i){let s;typeof t=="number"?s={position:we.from(t),preserveFocus:i}:typeof t=="object"?s={position:we.from(t.viewColumn),preserveFocus:t.preserveFocus,selection:typeof t.selection=="object"?A.from(t.selection):void 0,pinned:typeof t.preview=="boolean"?!t.preview:void 0}:s={preserveFocus:!1};const r=await this._proxy.$tryShowTextDocument(e.uri,s),n=r&&this._extHostDocumentsAndEditors.getEditor(r);if(n)return n.value;throw r?new Error(`Could NOT open editor for "${e.uri.toString()}" because another editor opened in the meantime.`):new Error(`Could NOT open editor for "${e.uri.toString()}".`)}createTextEditorDecorationType(e,t){return new Ka(this._proxy,e,t).value}$acceptEditorPropertiesChanged(e,t){const i=this._extHostDocumentsAndEditors.getEditor(e);if(!i)throw new Error("unknown text editor");if(t.options&&i._acceptOptions(t.options),t.selections){const s=t.selections.selections.map(it.to);i._acceptSelections(s)}if(t.visibleRanges){const s=Re(t.visibleRanges.map(A.to));i._acceptVisibleRanges(s)}if(t.options&&this._onDidChangeTextEditorOptions.fire({textEditor:i.value,options:{...t.options,lineNumbers:Is.to(t.options.lineNumbers)}}),t.selections){const s=Uh.fromValue(t.selections.source),r=t.selections.selections.map(it.to);this._onDidChangeTextEditorSelection.fire({textEditor:i.value,selections:r,kind:s})}if(t.visibleRanges){const s=Re(t.visibleRanges.map(A.to));this._onDidChangeTextEditorVisibleRanges.fire({textEditor:i.value,visibleRanges:s})}}$acceptEditorPositionData(e){for(const t in e){const i=this._extHostDocumentsAndEditors.getEditor(t);if(!i)throw new Error("Unknown text editor");const s=we.to(e[t]);i.value.viewColumn!==s&&(i._acceptViewColumn(s),this._onDidChangeTextEditorViewColumn.fire({textEditor:i.value,viewColumn:s}))}}$acceptEditorDiffInformation(e,t){const i=this._extHostDocumentsAndEditors.getEditor(e);if(!i)throw new Error("unknown text editor");if(!t){i._acceptDiffInformation(void 0),this._onDidChangeTextEditorDiffInformation.fire({textEditor:i.value,diffInformation:void 0});return}const s=this,r=t.map(n=>{const o=v.revive(n.original),c=v.revive(n.modified),d=n.changes.map(h=>{const[f,m,l,p]=h;let _;return f===m?_=Os.Addition:l===p?_=Os.Deletion:_=Os.Modification,{original:{startLineNumber:f,endLineNumberExclusive:m},modified:{startLineNumber:l,endLineNumberExclusive:p},kind:_}});return Object.freeze({documentVersion:n.documentVersion,original:o,modified:c,changes:d,get isStale(){return s._extHostDocumentsAndEditors.getDocument(c)?.version!==n.documentVersion}})});i._acceptDiffInformation(r),this._onDidChangeTextEditorDiffInformation.fire({textEditor:i.value,diffInformation:r})}getDiffInformation(e){return Promise.resolve(this._proxy.$getDiffInformation(e))}}let fa=class{constructor(e){this._actual=new pd(ii.Dark),this._onDidChangeActiveColorTheme=new D}get activeColorTheme(){return this._actual}$onColorThemeChange(e){let t;switch(e){case"light":t=ii.Light;break;case"hcDark":t=ii.HighContrast;break;case"hcLight":t=ii.HighContrastLight;break;default:t=ii.Dark}this._actual=new pd(t),this._onDidChangeActiveColorTheme.fire(this._actual)}get onDidChangeActiveColorTheme(){return this._onDidChangeActiveColorTheme.event}};fa=L([E(0,q)],fa);class jx{constructor(e,t){this._providers=new Map,this._itemsBySourceAndUriMap=new Map,this._proxy=e.getProxy(k.MainThreadTimeline),t.registerArgumentProcessor({processArgument:(i,s)=>{if(i&&i.$mid===Se.TimelineActionContext)if(this._providers.get(i.source)&&s&&ie(s,"timeline")){const r=i.uri===void 0?void 0:v.revive(i.uri);return this._itemsBySourceAndUriMap.get(i.source)?.get(ul(r))?.get(i.handle)}else return;return i}})}async $getTimeline(e,t,i,s){return this._providers.get(e)?.provider.provideTimeline(v.revive(t),i,s)}registerTimelineProvider(e,t,i,s){const r=new N,n=this.convertTimelineItem(t.id,s,r).bind(this);let o;t.onDidChange&&(o=t.onDidChange(d=>this._proxy.$emitTimelineChangeEvent({uri:void 0,reset:!0,...d,id:t.id}),this));const c=this._itemsBySourceAndUriMap;return this.registerTimelineProviderCore({...t,scheme:e,onDidChange:void 0,async provideTimeline(d,h,f){h?.resetCache&&(r.clear(),c.get(t.id)?.clear());const m=await t.provideTimeline(d,h,f);if(m==null)return;const l=n(d,h);return{...m,source:t.id,items:m.items.map(l)}},dispose(){for(const d of c.values())d.get(t.id)?.clear();o?.dispose(),r.dispose()}},i)}convertTimelineItem(e,t,i){return(s,r)=>{let n;if(r?.cacheResults){let o=this._itemsBySourceAndUriMap.get(e);o===void 0&&(o=new Map,this._itemsBySourceAndUriMap.set(e,o));const c=ul(s);n=o.get(c),n===void 0&&(n=new Map,o.set(c,n))}return o=>{const{iconPath:c,...d}=o,h=`${e}|${o.id??o.timestamp}`;n?.set(h,o);let f,m,l;o.iconPath&&(c instanceof Et?l={id:c.id,color:c.color}:v.isUri(c)?(f=c,m=c):{light:f,dark:m}=c);let p;return vi.isMarkdownString(d.tooltip)?p=ae.from(d.tooltip):hi(d.tooltip)?p=d.tooltip:vi.isMarkdownString(d.detail)?(console.warn("Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip"),p=ae.from(d.detail)):hi(d.detail)&&(console.warn("Using deprecated TimelineItem.detail, migrate to TimelineItem.tooltip"),p=d.detail),{...d,id:d.id??void 0,handle:h,source:e,command:o.command?t.toInternal(o.command,i):void 0,icon:f,iconDark:m,themeIcon:l,tooltip:p,accessibilityInformation:o.accessibilityInformation}}}}registerTimelineProviderCore(e,t){if(this._providers.get(e.id))throw new Error(`Timeline Provider ${e.id} already exists.`);return this._proxy.$registerTimelineProvider({id:e.id,label:e.label,scheme:e.scheme}),this._providers.set(e.id,{provider:e,extension:t}),V(()=>{for(const s of this._itemsBySourceAndUriMap.values())s.get(e.id)?.clear();this._providers.delete(e.id),this._proxy.$unregisterTimelineProvider(e.id),e.dispose()})}}function ul(a){return a?.toString()}function pl(a,e){if(hi(a))return{label:a};if(a&&typeof a=="object"&&typeof a.label=="string"){let t;return Array.isArray(a.highlights)&&(t=a.highlights.filter(i=>i.length===2&&typeof i[0]=="number"&&typeof i[1]=="number"),t=t.length?t:void 0),{label:a.label,highlights:t}}}class qx extends Z{constructor(e,t,i){super(),this._proxy=e,this.commands=t,this.logService=i,this.treeViews=new Map,this.treeDragAndDropService=new Hf;function s(r){return r&&r.$treeViewId&&(r.$treeItemHandle||r.$selectedTreeItems||r.$focusedTreeItem)}t.registerArgumentProcessor({processArgument:r=>s(r)?this.convertArgument(r):Array.isArray(r)&&r.length>0?r.map(n=>s(n)?this.convertArgument(n):n):r})}registerTreeDataProvider(e,t,i){const s=this.createTreeView(e,{treeDataProvider:t},i);return{dispose:()=>s.dispose()}}createTreeView(e,t,i){if(!t||!t.treeDataProvider)throw new Error("Options with treeDataProvider is mandatory");const s=t.dragAndDropController?.dropMimeTypes??[],r=t.dragAndDropController?.dragMimeTypes??[],n=!!t.dragAndDropController?.handleDrag,o=!!t.dragAndDropController?.handleDrop,c=this.createExtHostTreeView(e,t,i),d={showCollapseAll:!!t.showCollapseAll,canSelectMany:!!t.canSelectMany,dropMimeTypes:s,dragMimeTypes:r,hasHandleDrag:n,hasHandleDrop:o,manuallyManageCheckboxes:!!t.manageCheckboxStateManually},h=this._proxy.$registerTreeViewDataProvider(e,d),f={get onDidCollapseElement(){return c.onDidCollapseElement},get onDidExpandElement(){return c.onDidExpandElement},get selection(){return c.selectedElements},get onDidChangeSelection(){return c.onDidChangeSelection},get activeItem(){return b(i,"treeViewActiveItem"),c.focusedElement},get onDidChangeActiveItem(){return b(i,"treeViewActiveItem"),c.onDidChangeActiveItem},get visible(){return c.visible},get onDidChangeVisibility(){return c.onDidChangeVisibility},get onDidChangeCheckboxState(){return c.onDidChangeCheckboxState},get message(){return c.message},set message(m){kl(m)&&b(i,"treeViewMarkdownMessage"),c.message=m},get title(){return c.title},set title(m){c.title=m},get description(){return c.description},set description(m){c.description=m},get badge(){return c.badge},set badge(m){m!==void 0&&km.isViewBadge(m)?c.badge={value:Math.floor(Math.abs(m.value)),tooltip:m.tooltip}:m===void 0&&(c.badge=void 0)},reveal:(m,l)=>c.reveal(m,l),dispose:async()=>{await h,this.treeViews.delete(e),c.dispose()}};return this._register(f),f}async $getChildren(e,t){const i=this.treeViews.get(e);if(!i)return Promise.reject(new Xe(e));if(!t){const r=await i.getChildren();return r?[[0,...r]]:void 0}const s=[];for(let r=0;r<t.length;r++){const n=t[r],o=await i.getChildren(n);o&&s.push([r,...o])}return s}async $handleDrop(e,t,i,s,r,n,o,c){const d=this.treeViews.get(e);if(!d)return Promise.reject(new Xe(e));const h=dr.toDataTransfer(i,async f=>(await this._proxy.$resolveDropFileData(e,t,f)).buffer);return o===e&&c&&await this.addAdditionalTransferItems(h,d,c,r,n),d.onDrop(h,s,r)}async addAdditionalTransferItems(e,t,i,s,r){const n=this.treeDragAndDropService.removeDragOperationTransfer(r);if(n)(await n)?.forEach((o,c)=>{o&&e.set(c,o)});else if(r&&t.handleDrag){const o=t.handleDrag(i,e,s);this.treeDragAndDropService.addDragOperationTransfer(r,o),await o}return e}async $handleDrag(e,t,i,s){const r=this.treeViews.get(e);if(!r)return Promise.reject(new Xe(e));const n=await this.addAdditionalTransferItems(new Ba,r,t,s,i);if(!(!n||s.isCancellationRequested))return dr.from(n)}async $hasResolve(e){const t=this.treeViews.get(e);if(!t)throw new Xe(e);return t.hasResolve}$resolve(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Xe(e);return s.resolveTreeItem(t,i)}$setExpanded(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Xe(e);s.setExpanded(t,i)}$setSelectionAndFocus(e,t,i){const s=this.treeViews.get(e);if(!s)throw new Xe(e);s.setSelectionAndFocus(t,i)}$setVisible(e,t){const i=this.treeViews.get(e);if(!i){if(!t)return;throw new Xe(e)}i.setVisible(t)}$changeCheckboxState(e,t){const i=this.treeViews.get(e);if(!i)throw new Xe(e);i.setCheckboxState(t)}createExtHostTreeView(e,t,i){const s=this._register(new wr(e,t,this._proxy,this.commands.converter,this.logService,i));return this.treeViews.set(e,s),s}convertArgument(e){const t=this.treeViews.get(e.$treeViewId),i=e;return t&&i.$treeItemHandle?t.getExtensionElement(i.$treeItemHandle):t&&e.$focusedTreeItem?t.focusedElement:null}}class wr extends Z{static{this.LABEL_HANDLE_PREFIX="0"}static{this.ID_HANDLE_PREFIX="1"}get visible(){return this._visible}get selectedElements(){return this._selectedHandles.map(e=>this.getExtensionElement(e)).filter(e=>!Ti(e))}get focusedElement(){return this._focusedHandle?this.getExtensionElement(this._focusedHandle):void 0}constructor(e,t,i,s,r,n){if(super(),this.viewId=e,this.proxy=i,this.commands=s,this.logService=r,this.extension=n,this.roots=void 0,this.elements=new Map,this.nodes=new Map,this._visible=!1,this._selectedHandles=[],this._focusedHandle=void 0,this._onDidExpandElement=this._register(new D),this.onDidExpandElement=this._onDidExpandElement.event,this._onDidCollapseElement=this._register(new D),this.onDidCollapseElement=this._onDidCollapseElement.event,this._onDidChangeSelection=this._register(new D),this.onDidChangeSelection=this._onDidChangeSelection.event,this._onDidChangeActiveItem=this._register(new D),this.onDidChangeActiveItem=this._onDidChangeActiveItem.event,this._onDidChangeVisibility=this._register(new D),this.onDidChangeVisibility=this._onDidChangeVisibility.event,this._onDidChangeCheckboxState=this._register(new D),this.onDidChangeCheckboxState=this._onDidChangeCheckboxState.event,this._onDidChangeData=this._register(new D),this.refreshPromise=Promise.resolve(),this.refreshQueue=Promise.resolve(),this._message="",this._title="",this._refreshCancellationSource=new he,n.contributes&&n.contributes.views)for(const h in n.contributes.views)for(const f of n.contributes.views[h])f.id===e&&(this._title=f.name);this.dataProvider=t.treeDataProvider,this.dndController=t.dragAndDropController,this.dataProvider.onDidChangeTreeData&&this._register(this.dataProvider.onDidChangeTreeData(h=>{Array.isArray(h)&&h.length===0||this._onDidChangeData.fire({message:!1,element:h})}));let o,c;const d=Ee.debounce(this._onDidChangeData.event,(h,f)=>(h||(h={message:!1,elements:[]}),f.element!==!1&&(o||(o=new Promise(m=>c=m),this.refreshPromise=this.refreshPromise.then(()=>o)),Array.isArray(f.element)?h.elements.push(...f.element):h.elements.push(f.element)),f.message&&(h.message=!0),h),200,!0);this._register(d(({message:h,elements:f})=>{f.length&&(this.refreshQueue=this.refreshQueue.then(()=>{const m=c;return o=null,this.refresh(f).then(()=>m())})),h&&this.proxy.$setMessage(this.viewId,ae.fromStrict(this._message)??"")}))}async getChildren(e){const t=e?this.getExtensionElement(e):void 0;if(e&&!t)return this.logService.error(`No tree item with id '${e}' found.`),Promise.resolve([]);let i=this.getChildrenNodes(e);return i||(i=await this.fetchChildrenNodes(t)),i?i.map(s=>s.item):void 0}getExtensionElement(e){return this.elements.get(e)}reveal(e,t){t=t||{select:!0,focus:!1};const i=Ti(t.select)?!0:t.select,s=Ti(t.focus)?!1:t.focus,r=Ti(t.expand)?!1:t.expand;return typeof this.dataProvider.getParent!="function"?Promise.reject(new Error("Required registered TreeDataProvider to implement 'getParent' method to access 'reveal' method")):e?this.refreshPromise.then(()=>this.resolveUnknownParentChain(e)).then(n=>this.resolveTreeNode(e,n[n.length-1]).then(o=>this.proxy.$reveal(this.viewId,{item:o.item,parentChain:n.map(c=>c.item)},{select:i,focus:s,expand:r})),n=>this.logService.error(n)):this.proxy.$reveal(this.viewId,void 0,{select:i,focus:s,expand:r})}get message(){return this._message}set message(e){this._message=e,this._onDidChangeData.fire({message:!0,element:!1})}get title(){return this._title}set title(e){this._title=e,this.proxy.$setTitle(this.viewId,e,this._description)}get description(){return this._description}set description(e){this._description=e,this.proxy.$setTitle(this.viewId,this._title,e)}get badge(){return this._badge}set badge(e){this._badge?.value===e?.value&&this._badge?.tooltip===e?.tooltip||(this._badge=Wh.from(e),this.proxy.$setBadge(this.viewId,e))}setExpanded(e,t){const i=this.getExtensionElement(e);i&&(t?this._onDidExpandElement.fire(Object.freeze({element:i})):this._onDidCollapseElement.fire(Object.freeze({element:i})))}setSelectionAndFocus(e,t){const i=!pi(this._selectedHandles,e);this._selectedHandles=e;const s=this._focusedHandle!==t;this._focusedHandle=t,i&&this._onDidChangeSelection.fire(Object.freeze({selection:this.selectedElements})),s&&this._onDidChangeActiveItem.fire(Object.freeze({activeItem:this.focusedElement}))}setVisible(e){e!==this._visible&&(this._visible=e,this._onDidChangeVisibility.fire(Object.freeze({visible:this._visible})))}async setCheckboxState(e){const t=(await Promise.all(e.map(async i=>{const s=this.getExtensionElement(i.treeItemHandle);return s?{extensionItem:s,treeItem:await this.dataProvider.getTreeItem(s),newState:i.newState?si.Checked:si.Unchecked}:Promise.resolve(void 0)}))).filter(i=>i!==void 0);t.forEach(i=>{i.treeItem.checkboxState=i.newState?si.Checked:si.Unchecked}),this._onDidChangeCheckboxState.fire({items:t.map(i=>[i.extensionItem,i.newState])})}async handleDrag(e,t,i){const s=[];for(const r of e){const n=this.getExtensionElement(r);n&&s.push(n)}if(!(!this.dndController?.handleDrag||s.length===0))return await this.dndController.handleDrag(s,t,i),t}get hasHandleDrag(){return!!this.dndController?.handleDrag}async onDrop(e,t,i){const s=t?this.getExtensionElement(t):void 0;if(!(!s&&t||!this.dndController?.handleDrop))return xe(()=>this.dndController?.handleDrop?this.dndController.handleDrop(s,e,i):void 0)}get hasResolve(){return!!this.dataProvider.resolveTreeItem}async resolveTreeItem(e,t){if(!this.dataProvider.resolveTreeItem)return;const i=this.elements.get(e);if(i){const s=this.nodes.get(i);if(s){const r=await this.dataProvider.resolveTreeItem(s.extensionItem,i,t)??s.extensionItem;return this.validateTreeItem(r),s.item.tooltip=this.getTooltip(r.tooltip),s.item.command=this.getCommand(s.disposableStore,r.command),s.item}}}resolveUnknownParentChain(e){return this.resolveParent(e).then(t=>t?this.resolveUnknownParentChain(t).then(i=>this.resolveTreeNode(t,i[i.length-1]).then(s=>(i.push(s),i))):Promise.resolve([]))}resolveParent(e){const t=this.nodes.get(e);return t?Promise.resolve(t.parent?this.elements.get(t.parent.item.handle):void 0):xe(()=>this.dataProvider.getParent(e))}resolveTreeNode(e,t){const i=this.nodes.get(e);return i?Promise.resolve(i):xe(()=>this.dataProvider.getTreeItem(e)).then(s=>this.createHandle(e,s,t,!0)).then(s=>this.getChildren(t?t.item.handle:void 0).then(()=>{const r=this.getExtensionElement(s);if(r){const n=this.nodes.get(r);if(n)return Promise.resolve(n)}throw new Error(`Cannot resolve tree item for element ${s} from extension ${this.extension.identifier.value}`)}))}getChildrenNodes(e){if(e){let t;if(typeof e=="string"){const i=this.getExtensionElement(e);t=i?this.nodes.get(i):void 0}else t=e;return t&&t.children||void 0}return this.roots}async fetchChildrenNodes(e){this.clearChildren(e);const t=new he(this._refreshCancellationSource.token);try{const i=e?this.nodes.get(e):void 0,s=await this.dataProvider.getChildren(e);if(t.token.isCancellationRequested)return;const r=Re(s||[]),n=await Promise.all(Re(r).map(c=>this.dataProvider.getTreeItem(c)));if(t.token.isCancellationRequested)return;const o=n.map((c,d)=>c?this.createAndRegisterTreeNode(r[d],c,i):null);return Re(o)}finally{t.dispose()}}refresh(e){if(e.some(i=>!i))return this._refreshCancellationSource.dispose(!0),this._refreshCancellationSource=new he,this.clearAll(),this.proxy.$refresh(this.viewId);{const i=this.getHandlesToRefresh(e);if(i.length)return this.refreshHandles(i)}return Promise.resolve(void 0)}getHandlesToRefresh(e){const t=new Set,i=e.map(r=>this.nodes.get(r));for(const r of i)if(r&&!t.has(r.item.handle)){let n=r;for(;n&&n.parent&&i.findIndex(o=>n&&n.parent&&o&&o.item.handle===n.parent.item.handle)===-1;){const o=this.elements.get(n.parent.item.handle);n=o?this.nodes.get(o):void 0}n&&!n.parent&&t.add(r.item.handle)}const s=[];return t.forEach(r=>{const n=this.elements.get(r);if(n){const o=this.nodes.get(n);o&&(!o.parent||!t.has(o.parent.item.handle))&&s.push(r)}}),s}refreshHandles(e){const t={};return Promise.all(e.map(i=>this.refreshNode(i).then(s=>{s&&(t[i]=s.item)}))).then(()=>Object.keys(t).length?this.proxy.$refresh(this.viewId,t):void 0)}refreshNode(e){const t=this.getExtensionElement(e);if(t){const i=this.nodes.get(t);if(i)return this.clearChildren(t),xe(()=>this.dataProvider.getTreeItem(t)).then(s=>{if(s){const r=this.createTreeNode(t,s,i.parent);return this.updateNodeCache(t,r,i,i.parent),i.dispose(),r}return null})}return Promise.resolve(null)}createAndRegisterTreeNode(e,t,i){const s=this.createTreeNode(e,t,i);if(t.id&&this.elements.has(s.item.handle))throw new Error(j(2594,"Element with id {0} is already registered",t.id));return this.addNodeToCache(e,s),this.addNodeToParentCache(s,i),s}getTooltip(e){return vi.isMarkdownString(e)?ae.from(e):e}getCommand(e,t){return t?{...this.commands.toInternal(t,e),originalId:t.command}:void 0}getCheckbox(e){if(e.checkboxState===void 0)return;let t,i,s;return typeof e.checkboxState=="number"?t=e.checkboxState:(t=e.checkboxState.state,i=e.checkboxState.tooltip,s=e.checkboxState.accessibilityInformation),{isChecked:t===si.Checked,tooltip:i,accessibilityInformation:s}}validateTreeItem(e){if(!Vh.isTreeItem(e,this.extension))throw new Error(`Extension ${this.extension.identifier.value} has provided an invalid tree item.`)}createTreeNode(e,t,i){this.validateTreeItem(t);const s=this._register(new N),r=this.createHandle(e,t,i),n=this.getLightIconPath(t);return{item:{handle:r,parentHandle:i?i.item.handle:void 0,label:pl(t.label),description:t.description,resourceUri:t.resourceUri,tooltip:this.getTooltip(t.tooltip),command:this.getCommand(s,t.command),contextValue:t.contextValue,icon:n,iconDark:this.getDarkIconPath(t)||n,themeIcon:this.getThemeIcon(t),collapsibleState:Ti(t.collapsibleState)?Bh.None:t.collapsibleState,accessibilityInformation:t.accessibilityInformation,checkbox:this.getCheckbox(t)},extensionItem:t,parent:i,children:void 0,disposableStore:s,dispose(){s.dispose()}}}getThemeIcon(e){return e.iconPath instanceof Et?e.iconPath:void 0}createHandle(e,{id:t,label:i,resourceUri:s},r,n){if(t)return`${wr.ID_HANDLE_PREFIX}/${t}`;const o=pl(i),c=r?r.item.handle:wr.LABEL_HANDLE_PREFIX;let d=o?o.label:s?ml(s):"";d=d.indexOf("/")!==-1?d.replace("/","//"):d;const h=this.nodes.has(e)?this.nodes.get(e).item.handle:void 0,f=this.getChildrenNodes(r)||[];let m,l=0;do{if(m=`${c}/${l}:${d}`,n||!this.elements.has(m)||h===m)break;l++}while(l<=f.length);return m}getLightIconPath(e){if(e.iconPath&&!(e.iconPath instanceof Et))return typeof e.iconPath=="string"||v.isUri(e.iconPath)?this.getIconPath(e.iconPath):this.getIconPath(e.iconPath.light)}getDarkIconPath(e){if(e.iconPath&&!(e.iconPath instanceof Et)&&e.iconPath.dark)return this.getIconPath(e.iconPath.dark)}getIconPath(e){return v.isUri(e)?e:v.file(e)}addNodeToCache(e,t){this.elements.set(t.item.handle,e),this.nodes.set(e,t)}updateNodeCache(e,t,i,s){this.elements.delete(t.item.handle),this.nodes.delete(e),t.item.handle!==i.item.handle&&this.elements.delete(i.item.handle),this.addNodeToCache(e,t);const r=this.getChildrenNodes(s)||[],n=r.filter(o=>o.item.handle===i.item.handle)[0];n&&r.splice(r.indexOf(n),1,t)}addNodeToParentCache(e,t){t?(t.children||(t.children=[]),t.children.push(e)):(this.roots||(this.roots=[]),this.roots.push(e))}clearChildren(e){if(e){const t=this.nodes.get(e);if(t){if(t.children)for(const i of t.children){const s=this.elements.get(i.item.handle);s&&this.clear(s)}t.children=void 0}}else this.clearAll()}clear(e){const t=this.nodes.get(e);if(t){if(t.children)for(const i of t.children){const s=this.elements.get(i.item.handle);s&&this.clear(s)}this.nodes.delete(e),this.elements.delete(t.item.handle),t.dispose()}}clearAll(){this.roots=void 0,this.elements.clear(),this.nodes.forEach(e=>e.dispose()),this.nodes.clear()}dispose(){super.dispose(),this._refreshCancellationSource.dispose(),this.clearAll(),this.proxy.$disposeTree(this.viewId)}}class lc{static{this.supportedSchemes=new Set([G.http,G.https])}constructor(e){this._openers=new Map,this._proxy=e.getProxy(k.MainThreadUriOpeners)}registerExternalUriOpener(e,t,i,s){if(this._openers.has(t))throw new Error(`Opener with id '${t}' already registered`);const r=s.schemes.find(n=>!lc.supportedSchemes.has(n));if(r)throw new Error(`Scheme '${r}' is not supported. Only http and https are currently supported.`);return this._openers.set(t,i),this._proxy.$registerUriOpener(t,s.schemes,e,s.label),V(()=>{this._openers.delete(t),this._proxy.$unregisterUriOpener(t)})}async $canOpenUri(e,t,i){const s=this._openers.get(e);if(!s)throw new Error(`Unknown opener with id: ${e}`);const r=v.revive(t);return s.canOpenExternalUri(r,i)}async $openUri(e,t,i){const s=this._openers.get(e);if(!s)throw new Error(`Unknown opener id: '${e}'`);return s.openExternalUri(v.revive(t.resolvedUri),{sourceUri:v.revive(t.sourceUri)},i)}}class Kx extends Z{#e;#t;#i;#s;#n;#r;#a;#o;#c;#d;#l;#u;#h;constructor(e,t,i,s){super(),this.#o=void 0,this.#c=!0,this.#l=!1,this.#u=this._register(new D),this.onDidDispose=this.#u.event,this.#h=this._register(new D),this.onDidChangeViewState=this.#h.event,this.#e=e,this.#t=t,this.#s=i,this.#i=s.viewType,this.#n=s.panelOptions,this.#o=s.viewColumn,this.#r=s.title,this.#d=s.active}dispose(){this.#l||(this.#l=!0,this.#u.fire(),this.#t.$disposeWebview(this.#e),this.#s.dispose(),super.dispose())}get webview(){return this.assertNotDisposed(),this.#s}get viewType(){return this.assertNotDisposed(),this.#i}get title(){return this.assertNotDisposed(),this.#r}set title(e){this.assertNotDisposed(),this.#r!==e&&(this.#r=e,this.#t.$setTitle(this.#e,e))}get iconPath(){return this.assertNotDisposed(),this.#a}set iconPath(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#t.$setIconPath(this.#e,v.isUri(e)?{light:e,dark:e}:e))}get options(){return this.#n}get viewColumn(){if(this.assertNotDisposed(),!(typeof this.#o=="number"&&this.#o<0))return this.#o}get active(){return this.assertNotDisposed(),this.#d}get visible(){return this.assertNotDisposed(),this.#c}_updateViewState(e){this.#l||(this.active!==e.active||this.visible!==e.visible||this.viewColumn!==e.viewColumn)&&(this.#d=e.active,this.#c=e.visible,this.#o=e.viewColumn,this.#h.fire({webviewPanel:this}))}reveal(e,t){this.assertNotDisposed(),this.#t.$reveal(this.#e,{viewColumn:typeof e>"u"?void 0:we.from(e),preserveFocus:!!t})}assertNotDisposed(){if(this.#l)throw new Error("Webview is disposed")}}class hc extends Z{static newHandle(){return Ct()}constructor(e,t,i){super(),this.webviews=t,this.workspace=i,this._webviewPanels=new Map,this._serializers=new Map,this._proxy=e.getProxy(k.MainThreadWebviewPanels)}dispose(){super.dispose(),this._webviewPanels.forEach(e=>e.dispose()),this._webviewPanels.clear()}createWebviewPanel(e,t,i,s,r={}){const n=typeof s=="object"?s.viewColumn:s,o={viewColumn:we.from(n),preserveFocus:typeof s=="object"&&!!s.preserveFocus},c=yi(e),d=hc.newHandle();this._proxy.$createWebviewPanel(mr(e),d,t,{title:i,panelOptions:Gx(r),webviewOptions:gu(e,this.workspace,r),serializeBuffersForPostMessage:c},o);const h=this.webviews.createNewWebview(d,r,e);return this.createNewWebviewPanel(d,t,i,n,r,h,!0)}$onDidChangeWebviewPanelViewStates(e){const t=Object.keys(e);t.sort((i,s)=>{const r=e[i],n=e[s];return r.active?1:n.active?-1:+r.visible-+n.visible});for(const i of t){const s=this.getWebviewPanel(i);if(!s)continue;const r=e[i];s._updateViewState({active:r.active,visible:r.visible,viewColumn:we.to(r.position)})}}async $onDidDisposeWebviewPanel(e){this.getWebviewPanel(e)?.dispose(),this._webviewPanels.delete(e),this.webviews.deleteWebview(e)}registerWebviewPanelSerializer(e,t,i){if(this._serializers.has(t))throw new Error(`Serializer for '${t}' already registered`);return this._serializers.set(t,{serializer:i,extension:e}),this._proxy.$registerSerializer(t,{serializeBuffersForPostMessage:yi(e)}),new W(()=>{this._serializers.delete(t),this._proxy.$unregisterSerializer(t)})}async $deserializeWebviewPanel(e,t,i,s){const r=this._serializers.get(t);if(!r)throw new Error(`No serializer found for '${t}'`);const{serializer:n,extension:o}=r,c=this.webviews.createNewWebview(e,i.webviewOptions,o),d=this.createNewWebviewPanel(e,t,i.title,s,i.panelOptions,c,i.active);await n.deserializeWebviewPanel(d,i.state)}createNewWebviewPanel(e,t,i,s,r,n,o){const c=new Kx(e,this._proxy,n,{viewType:t,title:i,viewColumn:s,panelOptions:r,active:o});return this._webviewPanels.set(e,c),c}getWebviewPanel(e){return this._webviewPanels.get(e)}}function Gx(a){return{enableFindWidget:a.enableFindWidget,retainContextWhenHidden:a.retainContextWhenHidden}}class Qx extends Z{#e;#t;#i;#s;#n;#r;#a;#o;#c;constructor(e,t,i,s,r,n){super(),this.#n=!1,this.#d=this._register(new D),this.onDidChangeVisibility=this.#d.event,this.#l=this._register(new D),this.onDidDispose=this.#l.event,this.#i=i,this.#a=s,this.#e=e,this.#t=t,this.#s=r,this.#r=n}dispose(){this.#n||(this.#n=!0,this.#l.fire(),this.#s.dispose(),super.dispose())}#d;#l;get title(){return this.assertNotDisposed(),this.#a}set title(e){this.assertNotDisposed(),this.#a!==e&&(this.#a=e,this.#t.$setWebviewViewTitle(this.#e,e))}get description(){return this.assertNotDisposed(),this.#o}set description(e){this.assertNotDisposed(),this.#o!==e&&(this.#o=e,this.#t.$setWebviewViewDescription(this.#e,e))}get visible(){return this.#r}get webview(){return this.#s}get viewType(){return this.#i}_setVisible(e){e===this.#r||this.#n||(this.#r=e,this.#d.fire())}get badge(){return this.assertNotDisposed(),this.#c}set badge(e){this.assertNotDisposed(),!(e?.value===this.#c?.value&&e?.tooltip===this.#c?.tooltip)&&(this.#c=Wh.from(e),this.#t.$setWebviewViewBadge(this.#e,e))}show(e){this.assertNotDisposed(),this.#t.$show(this.#e,!!e)}assertNotDisposed(){if(this.#n)throw new Error("Webview is disposed")}}class Jx{constructor(e,t){this._extHostWebview=t,this._viewProviders=new Map,this._webviewViews=new Map,this._proxy=e.getProxy(k.MainThreadWebviewViews)}registerWebviewViewProvider(e,t,i,s){if(this._viewProviders.has(t))throw new Error(`View provider for '${t}' already registered`);return this._viewProviders.set(t,{provider:i,extension:e}),this._proxy.$registerWebviewViewProvider(mr(e),t,{retainContextWhenHidden:s?.retainContextWhenHidden,serializeBuffersForPostMessage:yi(e)}),new W(()=>{this._viewProviders.delete(t),this._proxy.$unregisterWebviewViewProvider(t)})}async $resolveWebviewView(e,t,i,s,r){const n=this._viewProviders.get(t);if(!n)throw new Error(`No view provider found for '${t}'`);const{provider:o,extension:c}=n,d=this._extHostWebview.createNewWebview(e,{},c),h=new Qx(e,this._proxy,t,i,d,!0);this._webviewViews.set(e,h),await o.resolveWebviewView(h,{state:s},r)}async $onDidChangeWebviewViewVisibility(e,t){this.getWebviewView(e)._setVisible(t)}async $disposeWebviewView(e){const t=this.getWebviewView(e);this._webviewViews.delete(e),t.dispose(),this._extHostWebview.deleteWebview(e)}getWebviewView(e){const t=this._webviewViews.get(e);if(!t)throw new Error("No webview found");return t}}class Xx{constructor(e){this._settingsSearchProviders=new Map,this._nextHandle=0,this._proxy=e.getProxy(k.MainThreadAiSettingsSearch)}async $startSearch(e,t,i,s){if(this._settingsSearchProviders.size===0)throw new Error("No related information providers registered");const r=this._settingsSearchProviders.get(e);if(!r)throw new Error("Settings search provider not found");const n=new Ca(o=>{this._proxy.$handleSearchResult(e,Im.fromSettingsSearchResult(o))});return r.provideSettingsSearchResults(t,i,n,s)}registerSettingsSearchProvider(e,t){const i=this._nextHandle;return this._nextHandle++,this._settingsSearchProviders.set(i,t),this._proxy.$registerAiSettingsSearchProvider(i),new W(()=>{this._proxy.$unregisterAiSettingsSearchProvider(i),this._settingsSearchProviders.delete(i)})}}function Yx(a){const e=a.get(_e),t=a.get(wi),i=a.get(Cr),s=a.get(qt),r=a.get(rt),n=a.get(qa),o=a.get(nt),c=a.get(Dr),d=a.get(q),h=a.get(Ga),f=a.get(tu),m=a.get(St),l=a.get(se),p=a.get(Na),_=a.get(ds),x=a.get(Tr),S=a.get(kr),C=a.get(Ja),T=a.get(ls),O=a.get(Ya),I=a.get(Ir),B=a.get(iu),Q=a.get(Qa),K=a.get(ea);d.set(R.ExtHostFileSystemInfo,t),d.set(R.ExtHostLogLevelServiceShape,m),d.set(R.ExtHostWorkspace,r),d.set(R.ExtHostConfiguration,o),d.set(R.ExtHostExtensionService,s),d.set(R.ExtHostStorage,h),d.set(R.ExtHostTunnelService,p),d.set(R.ExtHostWindow,x),d.set(R.ExtHostUrls,S),d.set(R.ExtHostSecretState,C),d.set(R.ExtHostTelemetry,n),d.set(R.ExtHostEditorTabs,T),d.set(R.ExtHostManagedSockets,O),d.set(R.ExtHostProgress,I),d.set(R.ExtHostAuthentication,B),d.set(R.ExtHostChatProvider,Q);const ze=d.set(R.ExtHostDecorations,a.get(Gh)),le=d.set(R.ExtHostDocumentsAndEditors,a.get(xi)),J=d.set(R.ExtHostCommands,a.get(jt)),ue=d.set(R.ExtHostTerminalService,a.get(bi)),$r=d.set(R.ExtHostTerminalShellIntegration,a.get(uu)),pe=d.set(R.ExtHostDebugService,a.get(cu)),Kt=d.set(R.ExtHostSearch,a.get(hu)),Ne=d.set(R.ExtHostTask,a.get(Yh)),vu=d.set(R.ExtHostOutputService,a.get(qh)),hs=d.set(R.ExtHostLocalization,a.get(Xa)),Ce=d.set(R.ExtHostDocuments,new lx(d,le)),yu=d.set(R.ExtHostDocumentContentProviders,new ic(d,le,l)),wu=d.set(R.ExtHostDocumentSaveParticipant,new dx(l,Ce,d.getProxy(k.MainThreadBulkEdits))),ge=d.set(R.ExtHostNotebook,new oi(d,J,le,Ce,i,Kt,l)),uc=d.set(R.ExtHostNotebookDocuments,new Px(ge)),pc=d.set(R.ExtHostNotebookEditors,new la(l,ge)),Mr=d.set(R.ExtHostNotebookKernels,new ha(d,e,ge,J,l)),xu=d.set(R.ExtHostNotebookRenderers,new Rx(d,ge)),bu=d.set(R.ExtHostNotebookDocumentSaveParticipant,new Dx(l,ge,d.getProxy(k.MainThreadBulkEdits))),ke=d.set(R.ExtHostEditors,new zx(d,le)),fc=d.set(R.ExtHostTreeViews,new qx(d.getProxy(k.MainThreadTreeViews),J,l)),Eu=d.set(R.ExtHostEditorInsets,new Gw(d.getProxy(k.MainThreadEditorInsets),ke,e.remote)),Si=d.set(R.ExtHostDiagnostics,new na(d,l,t,le)),us=d.set(R.ExtHostLanguages,new Ex(d,Ce,J.converter,c)),z=d.set(R.ExtHostLanguageFeatures,new fe(d,c,Ce,J,Si,l,_,n)),Su=d.set(R.ExtHostCodeMapper,new tc(d)),Cu=d.set(R.ExtHostFileSystem,new vr(d,z)),Dt=d.set(R.ExtHostFileSystemEventService,new _x(d,l,le)),Ci=d.set(R.ExtHostQuickOpen,$x(d,r,J)),gc=d.set(R.ExtHostSCM,new pa(d,J,Ce,l)),Du=d.set(R.ExtHostQuickDiff,new oc(d,c)),Pu=d.set(R.ExtHostShare,new cc(d,c)),Tu=d.set(R.ExtHostComments,Qw(d,J,Ce)),ku=d.set(R.ExtHostLabelService,new yx(d)),mc=d.set(R.ExtHostTheming,new fa(d)),Iu=d.set(R.ExtHostTimeline,new jx(d,J)),Hr=d.set(R.ExtHostWebviews,new Yw(d,e.remote,r,l,_)),Fr=d.set(R.ExtHostWebviewPanels,new hc(d,Hr,r)),Ru=d.set(R.ExtHostCustomEditors,new rx(d,Ce,f,Hr,Fr)),Au=d.set(R.ExtHostWebviewViews,new Jx(d,Hr)),Gt=d.set(R.ExtHostTesting,a.get(Rr)),$u=d.set(R.ExtHostUriOpeners,new lc(d)),Mu=d.set(R.ExtHostProfileContentHandlers,new Ax(d));d.set(R.ExtHostInteractive,new vx(d,ge,le,J,l));const ps=d.set(R.ExtHostLanguageModelTools,new bx(d,Q)),Qt=d.set(R.ExtHostChatAgents2,new ni(d,l,J,Ce,Q,Si,ps)),_c=d.set(R.ExtHostAiRelatedInformation,new Fw(d)),Hu=d.set(R.ExtHostAiEmbeddingVector,new ux(d)),Fu=d.set(R.ExtHostAiSettingsSearch,new Xx(d)),vc=d.set(R.ExtHostStatusBar,new Bx(d,J.converter)),Lu=d.set(R.ExtHostSpeech,new dc(d)),Di=d.set(R.ExtHostEmbeddings,new hx(d));d.set(R.ExtHostMcp,a.get(ea));const Nu=Object.values(R);d.assertRegistered(Nu);const Ou=new sa(d,le),Uu=new jw(d),Lr=new ca(d,l),yc=new cx(d),Wu=new Bw(d);return Nw.register(J),function(w,ot,Nr){function $(u){return(g,y,F)=>{const ee=u(ve=>{try{g.call(y,ve)}catch(op){yn(new Dl(w.identifier,op,"FAILED to handle event"))}});return F?.push(ee),ee}}const X=function(){let u=!w.isUnderDevelopment;function g(){u||(l.info(`Extension '${w.identifier.value}' uses a document selector without scheme. Learn more about this: https://go.microsoft.com/fwlink/?linkid=872305`),u=!0)}return function y(F){if(Array.isArray(F))F.forEach(y);else if(typeof F=="string")g();else{const ee=F;typeof ee.scheme>"u"&&g(),typeof ee.exclusive=="boolean"&&b(w,"documentFiltersExclusive")}return F}}(),Vu={getSession(u,g,y){return(typeof y?.forceNewSession=="object"&&y.forceNewSession.learnMore||typeof y?.createIfNone=="object"&&y.createIfNone.learnMore)&&b(w,"authLearnMore"),y?.authorizationServer&&b(w,"authIssuers"),B.getSession(w,u,g,y)},getAccounts(u){return B.getAccounts(u)},async hasSession(u,g){return b(w,"authSession"),!!await B.getSession(w,u,g,{silent:!0})},get onDidChangeSessions(){return $(B.getExtensionScopedSessionsEvent(w.identifier.value))},registerAuthenticationProvider(u,g,y,F){return F?.supportedAuthorizationServers&&b(w,"authIssuers"),B.registerAuthenticationProvider(u,g,y,F)}},Bu={registerCommand(u,g,y){return J.registerCommand(!0,u,g,y,void 0,w)},registerTextEditorCommand(u,g,y){return J.registerCommand(!0,u,(...F)=>{const ee=ke.getActiveTextEditor();if(!ee){l.warn("Cannot execute "+u+" because there is no active text editor.");return}return ee.edit(ve=>{g.apply(y,[ee,ve,...F])}).then(ve=>{ve||l.warn("Edits from command "+u+" were not applied.")},ve=>{l.warn("An error occurred while running command "+u,ve)})},void 0,void 0,w)},registerDiffInformationCommand:(u,g,y)=>(b(w,"diffCommand"),J.registerCommand(!0,u,async(...F)=>{const ee=le.activeEditor(!0);if(!ee){l.warn("Cannot execute "+u+" because there is no active text editor.");return}const ve=await ke.getDiffInformation(ee.id);g.apply(y,[ve,...F])},void 0,void 0,w)),executeCommand(u,...g){return J.executeCommand(u,...g)},getCommands(u=!1){return J.getCommands(u)}},zu={get machineId(){return e.telemetryInfo.machineId},get sessionId(){return e.telemetryInfo.sessionId},get language(){return e.environment.appLanguage},get appName(){return e.environment.appName},get appRoot(){return e.environment.appRoot?.fsPath??""},get appHost(){return e.environment.appHost},get uriScheme(){return e.environment.appUriScheme},get clipboard(){return Uu.value},get shell(){return ue.getDefaultShell(!1)},get onDidChangeShell(){return $(ue.onDidChangeShell)},get isTelemetryEnabled(){return n.getTelemetryConfiguration()},get onDidChangeTelemetryEnabled(){return $(n.onDidChangeTelemetryEnabled)},get telemetryConfiguration(){return b(w,"telemetry"),n.getTelemetryDetails()},get onDidChangeTelemetryConfiguration(){return b(w,"telemetry"),$(n.onDidChangeTelemetryConfiguration)},get isNewAppInstall(){return Jh(e.telemetryInfo.firstSessionDate)},createTelemetryLogger(u,g){return Qh.validateSender(u),n.instantiateLogger(w,u,g)},openExternal(u,g){return x.openUri(u,{allowTunneling:!!e.remote.authority,allowContributedOpeners:g?.allowContributedOpeners})},async asExternalUri(u){if(u.scheme===e.environment.appUriScheme)return S.createAppUri(u);try{return await x.asExternalUri(u,{allowTunneling:!!e.remote.authority})}catch(g){if(jc(u,G.http)||jc(u,G.https))return u;throw g}},get remoteName(){return yl(e.remote.authority)},get remoteAuthority(){return b(w,"resolvers"),e.remote.authority},get uiKind(){return e.uiKind},get logLevel(){return l.getLevel()},get onDidChangeLogLevel(){return $(l.onDidChangeLogLevel)},get appQuality(){return b(w,"resolvers"),e.quality},get appCommit(){return b(w,"resolvers"),e.commit}},ju={createTestController(u,g,y){return Gt.createTestController(w,u,g,y)},createTestObserver(){return b(w,"testObserver"),Gt.createTestObserver()},runTests(u){return b(w,"testObserver"),Gt.runTests(u)},registerTestFollowupProvider(u){return b(w,"testObserver"),Gt.registerTestFollowupProvider(u)},get onDidChangeTestResults(){return b(w,"testObserver"),$(Gt.onResultsChanged)},get testResults(){return b(w,"testObserver"),Gt.results}},fs=e.remote.isRemote?Ki.Workspace:Ki.UI,qu={getExtension(u,g){ie(w,"extensionsAny")||(g=!1);const y=ot.mine.getExtensionDescription(u);if(y)return new Ui(s,w.identifier,y,fs,!1);if(g){const F=ot.all.getExtensionDescription(u);if(F)return new Ui(s,w.identifier,F,fs,!0)}},get all(){const u=[];for(const g of ot.mine.getAllExtensionDescriptions())u.push(new Ui(s,w.identifier,g,fs,!1));return u},get allAcrossExtensionHosts(){b(w,"extensionsAny");const u=new os(ot.mine.getAllExtensionDescriptions().map(y=>y.identifier)),g=[];for(const y of ot.all.getAllExtensionDescriptions()){const F=!u.has(y.identifier);g.push(new Ui(s,w.identifier,y,fs,F))}return g},get onDidChange(){return ie(w,"extensionsAny")?$(Ee.any(ot.mine.onDidChange,ot.all.onDidChange)):$(ot.mine.onDidChange)}},Ku={createDiagnosticCollection(u){return Si.createDiagnosticCollection(w.identifier,u)},get onDidChangeDiagnostics(){return $(Si.onDidChangeDiagnostics)},getDiagnostics:u=>Si.getDiagnostics(u),getLanguages(){return us.getLanguages()},setTextDocumentLanguage(u,g){return us.changeLanguage(u.uri,g)},match(u,g){const y=ey.from(u);let F;return ty(y)&&(F=ge.notebookDocuments.find(ee=>ee.apiNotebook.getCells().find(ve=>ve.document===g))?.apiNotebook),iy(y,g.uri,g.languageId,!0,F?.uri,F?.notebookType)},registerCodeActionsProvider(u,g,y){return z.registerCodeActionProvider(w,X(u),g,y)},registerDocumentPasteEditProvider(u,g,y){return z.registerDocumentPasteEditProvider(w,X(u),g,y)},registerCodeLensProvider(u,g){return z.registerCodeLensProvider(w,X(u),g)},registerDefinitionProvider(u,g){return z.registerDefinitionProvider(w,X(u),g)},registerDeclarationProvider(u,g){return z.registerDeclarationProvider(w,X(u),g)},registerImplementationProvider(u,g){return z.registerImplementationProvider(w,X(u),g)},registerTypeDefinitionProvider(u,g){return z.registerTypeDefinitionProvider(w,X(u),g)},registerHoverProvider(u,g){return z.registerHoverProvider(w,X(u),g,w.identifier)},registerEvaluatableExpressionProvider(u,g){return z.registerEvaluatableExpressionProvider(w,X(u),g,w.identifier)},registerInlineValuesProvider(u,g){return z.registerInlineValuesProvider(w,X(u),g,w.identifier)},registerDocumentHighlightProvider(u,g){return z.registerDocumentHighlightProvider(w,X(u),g)},registerMultiDocumentHighlightProvider(u,g){return z.registerMultiDocumentHighlightProvider(w,X(u),g)},registerLinkedEditingRangeProvider(u,g){return z.registerLinkedEditingRangeProvider(w,X(u),g)},registerReferenceProvider(u,g){return z.registerReferenceProvider(w,X(u),g)},registerRenameProvider(u,g){return z.registerRenameProvider(w,X(u),g)},registerNewSymbolNamesProvider(u,g){return b(w,"newSymbolNamesProvider"),z.registerNewSymbolNamesProvider(w,X(u),g)},registerDocumentSymbolProvider(u,g,y){return z.registerDocumentSymbolProvider(w,X(u),g,y)},registerWorkspaceSymbolProvider(u){return z.registerWorkspaceSymbolProvider(w,u)},registerDocumentFormattingEditProvider(u,g){return z.registerDocumentFormattingEditProvider(w,X(u),g)},registerDocumentRangeFormattingEditProvider(u,g){return z.registerDocumentRangeFormattingEditProvider(w,X(u),g)},registerOnTypeFormattingEditProvider(u,g,y,...F){return z.registerOnTypeFormattingEditProvider(w,X(u),g,[y].concat(F))},registerDocumentSemanticTokensProvider(u,g,y){return z.registerDocumentSemanticTokensProvider(w,X(u),g,y)},registerDocumentRangeSemanticTokensProvider(u,g,y){return z.registerDocumentRangeSemanticTokensProvider(w,X(u),g,y)},registerSignatureHelpProvider(u,g,y,...F){return typeof y=="object"?z.registerSignatureHelpProvider(w,X(u),g,y):z.registerSignatureHelpProvider(w,X(u),g,typeof y>"u"?[]:[y,...F])},registerCompletionItemProvider(u,g,...y){return z.registerCompletionItemProvider(w,X(u),g,y)},registerInlineCompletionItemProvider(u,g,y){return g.handleDidShowCompletionItem&&b(w,"inlineCompletionsAdditions"),g.handleDidPartiallyAcceptCompletionItem&&b(w,"inlineCompletionsAdditions"),y&&b(w,"inlineCompletionsAdditions"),z.registerInlineCompletionsProvider(w,X(u),g,y)},registerInlineEditProvider(u,g){return b(w,"inlineEdit"),z.registerInlineEditProvider(w,X(u),g)},registerDocumentLinkProvider(u,g){return z.registerDocumentLinkProvider(w,X(u),g)},registerColorProvider(u,g){return z.registerColorProvider(w,X(u),g)},registerFoldingRangeProvider(u,g){return z.registerFoldingRangeProvider(w,X(u),g)},registerSelectionRangeProvider(u,g){return z.registerSelectionRangeProvider(w,u,g)},registerCallHierarchyProvider(u,g){return z.registerCallHierarchyProvider(w,u,g)},registerTypeHierarchyProvider(u,g){return z.registerTypeHierarchyProvider(w,u,g)},setLanguageConfiguration:(u,g)=>z.setLanguageConfiguration(w,u,g),getTokenInformationAtPosition(u,g){return b(w,"tokenInformation"),us.tokenAtPosition(u,g)},registerInlayHintsProvider(u,g){return z.registerInlayHintsProvider(w,u,g)},createLanguageStatusItem(u,g){return us.createLanguageStatusItem(w,u,g)},registerDocumentDropEditProvider(u,g,y){return z.registerDocumentOnDropEditProvider(w,u,g,y)}},Gu={get activeTextEditor(){return ke.getActiveTextEditor()},get visibleTextEditors(){return ke.getVisibleTextEditors()},get activeTerminal(){return ue.activeTerminal},get terminals(){return ue.terminals},async showTextDocument(u,g,y){v.isUri(u)&&u.scheme===G.vscodeRemote&&!u.authority&&_.report("workspace.showTextDocument",w,"A URI of 'vscode-remote' scheme requires an authority.");const F=await(v.isUri(u)?Promise.resolve(wc.openTextDocument(u)):Promise.resolve(u));return ke.showTextDocument(F,g,y)},createTextEditorDecorationType(u){return ke.createTextEditorDecorationType(w,u)},onDidChangeActiveTextEditor(u,g,y){return $(ke.onDidChangeActiveTextEditor)(u,g,y)},onDidChangeVisibleTextEditors(u,g,y){return $(ke.onDidChangeVisibleTextEditors)(u,g,y)},onDidChangeTextEditorSelection(u,g,y){return $(ke.onDidChangeTextEditorSelection)(u,g,y)},onDidChangeTextEditorOptions(u,g,y){return $(ke.onDidChangeTextEditorOptions)(u,g,y)},onDidChangeTextEditorVisibleRanges(u,g,y){return $(ke.onDidChangeTextEditorVisibleRanges)(u,g,y)},onDidChangeTextEditorViewColumn(u,g,y){return $(ke.onDidChangeTextEditorViewColumn)(u,g,y)},onDidChangeTextEditorDiffInformation(u,g,y){return b(w,"textEditorDiffInformation"),$(ke.onDidChangeTextEditorDiffInformation)(u,g,y)},onDidCloseTerminal(u,g,y){return $(ue.onDidCloseTerminal)(u,g,y)},onDidOpenTerminal(u,g,y){return $(ue.onDidOpenTerminal)(u,g,y)},onDidChangeActiveTerminal(u,g,y){return $(ue.onDidChangeActiveTerminal)(u,g,y)},onDidChangeTerminalDimensions(u,g,y){return b(w,"terminalDimensions"),$(ue.onDidChangeTerminalDimensions)(u,g,y)},onDidChangeTerminalState(u,g,y){return $(ue.onDidChangeTerminalState)(u,g,y)},onDidWriteTerminalData(u,g,y){return b(w,"terminalDataWriteEvent"),$(ue.onDidWriteTerminalData)(u,g,y)},onDidExecuteTerminalCommand(u,g,y){return b(w,"terminalExecuteCommandEvent"),$(ue.onDidExecuteTerminalCommand)(u,g,y)},onDidChangeTerminalShellIntegration(u,g,y){return $($r.onDidChangeTerminalShellIntegration)(u,g,y)},onDidStartTerminalShellExecution(u,g,y){return $($r.onDidStartTerminalShellExecution)(u,g,y)},onDidEndTerminalShellExecution(u,g,y){return $($r.onDidEndTerminalShellExecution)(u,g,y)},get state(){return x.getState()},onDidChangeWindowState(u,g,y){return $(x.onDidChangeWindowState)(u,g,y)},showInformationMessage(u,...g){return Lr.showMessage(w,Te.Info,u,g[0],g.slice(1))},showWarningMessage(u,...g){return Lr.showMessage(w,Te.Warning,u,g[0],g.slice(1))},showErrorMessage(u,...g){return Lr.showMessage(w,Te.Error,u,g[0],g.slice(1))},showQuickPick(u,g,y){return Ci.showQuickPick(w,u,g,y)},showWorkspaceFolderPick(u){return Ci.showWorkspaceFolderPick(u)},showInputBox(u,g){return Ci.showInput(u,g)},showOpenDialog(u){return yc.showOpenDialog(u)},showSaveDialog(u){return yc.showSaveDialog(u)},createStatusBarItem(u,g,y){let F,ee,ve;return typeof u=="string"?(F=u,ee=g,ve=y):(ee=u,ve=g),vc.createStatusBarEntry(w,F,ee,ve)},setStatusBarMessage(u,g){return vc.setStatusBarMessage(u,g)},withScmProgress(u){return _.report("window.withScmProgress",w,"Use 'withProgress' instead."),I.withProgress(w,{location:kn.SourceControl},(g,y)=>u({report(F){}}))},withProgress(u,g){return I.withProgress(w,u,g)},createOutputChannel(u,g){return vu.createOutputChannel(u,g,w)},createWebviewPanel(u,g,y,F){return Fr.createWebviewPanel(w,u,g,y,F)},createWebviewTextEditorInset(u,g,y,F){return b(w,"editorInsets"),Eu.createWebviewEditorInset(u,g,y,F,w)},createTerminal(u,g,y){return typeof u=="object"?"pty"in u?ue.createExtensionTerminal(u):ue.createTerminalFromOptions(u):ue.createTerminal(u,g,y)},registerTerminalLinkProvider(u){return ue.registerLinkProvider(u)},registerTerminalProfileProvider(u,g){return ue.registerProfileProvider(w,u,g)},registerTerminalCompletionProvider(u,...g){return b(w,"terminalCompletionProvider"),ue.registerTerminalCompletionProvider(w,u,...g)},registerTerminalQuickFixProvider(u,g){return b(w,"terminalQuickFixProvider"),ue.registerTerminalQuickFixProvider(u,w.identifier.value,g)},registerTreeDataProvider(u,g){return fc.registerTreeDataProvider(u,g,w)},createTreeView(u,g){return fc.createTreeView(u,g,w)},registerWebviewPanelSerializer:(u,g)=>Fr.registerWebviewPanelSerializer(w,u,g),registerCustomEditorProvider:(u,g,y={})=>Ru.registerCustomEditorProvider(w,u,g,y),registerFileDecorationProvider(u){return ze.registerFileDecorationProvider(u,w)},registerUriHandler(u){return S.registerUriHandler(w,u)},createQuickPick(){return Ci.createQuickPick(w)},createInputBox(){return Ci.createInputBox(w)},get activeColorTheme(){return mc.activeColorTheme},onDidChangeActiveColorTheme(u,g,y){return $(mc.onDidChangeActiveColorTheme)(u,g,y)},registerWebviewViewProvider(u,g,y){return Au.registerWebviewViewProvider(w,u,g,y?.webviewOptions)},get activeNotebookEditor(){return ge.activeNotebookEditor},onDidChangeActiveNotebookEditor(u,g,y){return $(ge.onDidChangeActiveNotebookEditor)(u,g,y)},get visibleNotebookEditors(){return ge.visibleNotebookEditors},get onDidChangeVisibleNotebookEditors(){return $(ge.onDidChangeVisibleNotebookEditors)},onDidChangeNotebookEditorSelection(u,g,y){return $(pc.onDidChangeNotebookEditorSelection)(u,g,y)},onDidChangeNotebookEditorVisibleRanges(u,g,y){return $(pc.onDidChangeNotebookEditorVisibleRanges)(u,g,y)},showNotebookDocument(u,g){return ge.showNotebookDocument(u,g)},registerExternalUriOpener(u,g,y){return b(w,"externalUriOpener"),$u.registerExternalUriOpener(w.identifier,u,g,y)},registerProfileContentHandler(u,g){return b(w,"profileContentHandlers"),Mu.registerProfileContentHandler(w,u,g)},registerQuickDiffProvider(u,g,y,F,ee){return b(w,"quickDiffProvider"),Du.registerQuickDiffProvider(w,X(u),g,y,F,ee)},get tabGroups(){return T.tabGroups},registerShareProvider(u,g){return b(w,"shareProvider"),Pu.registerShareProvider(X(u),g)},get nativeHandle(){return b(w,"nativeWindowHandle"),x.nativeHandle},createChatStatusItem:u=>(b(w,"chatStatusItem"),Wu.createChatStatusItem(w,u))},wc={get rootPath(){return _.report("workspace.rootPath",w,"Please use 'workspace.workspaceFolders' instead. More details: https://aka.ms/vscode-eliminating-rootpath"),r.getPath()},set rootPath(u){throw new Mt("rootPath")},getWorkspaceFolder(u){return r.getWorkspaceFolder(u)},get workspaceFolders(){return r.getWorkspaceFolders()},get name(){return r.name},set name(u){throw new Mt("name")},get workspaceFile(){return r.workspaceFile},set workspaceFile(u){throw new Mt("workspaceFile")},updateWorkspaceFolders:(u,g,...y)=>r.updateWorkspaceFolders(w,u,g||0,...y),onDidChangeWorkspaceFolders:function(u,g,y){return $(r.onDidChangeWorkspace)(u,g,y)},asRelativePath:(u,g)=>r.getRelativePath(u,g),findFiles:(u,g,y,F)=>r.findFiles(u,g,y,w.identifier,F),findFiles2:(u,g,y)=>(b(w,"findFiles2"),r.findFiles2(u,g,w.identifier,y)),findTextInFiles:(u,g,y,F)=>{b(w,"findTextInFiles");let ee,ve;return typeof g=="object"?(ee=g,ve=y):(ee={},ve=g,F=y),r.findTextInFiles(u,ee||{},ve,w.identifier,F)},findTextInFiles2:(u,g,y)=>(b(w,"findTextInFiles2"),b(w,"textSearchProvider2"),r.findTextInFiles2(u,g,w.identifier,y)),save:u=>r.save(u),saveAs:u=>r.saveAs(u),saveAll:u=>r.saveAll(u),applyEdit(u,g){return Ou.applyWorkspaceEdit(u,w,g)},createFileSystemWatcher:(u,g,y,F)=>{const ee={ignoreCreateEvents:!!g,ignoreChangeEvents:!!y,ignoreDeleteEvents:!!F};return Dt.createFileSystemWatcher(r,Nr,w,u,ee)},get textDocuments(){return Ce.getAllDocumentData().map(u=>u.document)},set textDocuments(u){throw new Mt("textDocuments")},openTextDocument(u,g){let y;if(g=g??u,typeof u=="string")y=Promise.resolve(v.file(u));else if(v.isUri(u))y=Promise.resolve(u);else if(!g||typeof g=="object")y=Ce.createDocumentData(g);else throw new Error("illegal argument - uriOrFileNameOrOptions");return y.then(F=>(l.trace(`openTextDocument from ${w.identifier}`),F.scheme===G.vscodeRemote&&!F.authority&&_.report("workspace.openTextDocument",w,"A URI of 'vscode-remote' scheme requires an authority."),Ce.ensureDocumentData(F,g).then(ee=>ee.document)))},onDidOpenTextDocument:(u,g,y)=>$(Ce.onDidAddDocument)(u,g,y),onDidCloseTextDocument:(u,g,y)=>$(Ce.onDidRemoveDocument)(u,g,y),onDidChangeTextDocument:(u,g,y)=>$(Ce.onDidChangeDocument)(u,g,y),onDidSaveTextDocument:(u,g,y)=>$(Ce.onDidSaveDocument)(u,g,y),onWillSaveTextDocument:(u,g,y)=>$(wu.getOnWillSaveTextDocumentEvent(w))(u,g,y),get notebookDocuments(){return ge.notebookDocuments.map(u=>u.apiNotebook)},async openNotebookDocument(u,g){let y;if(v.isUri(u))y=u,await ge.openNotebookDocument(u);else if(typeof u=="string")y=v.revive(await ge.createNotebookDocument({viewType:u,content:g}));else throw new Error("Invalid arguments");return ge.getNotebookDocument(y).apiNotebook},onDidSaveNotebookDocument(u,g,y){return $(uc.onDidSaveNotebookDocument)(u,g,y)},onDidChangeNotebookDocument(u,g,y){return $(uc.onDidChangeNotebookDocument)(u,g,y)},onWillSaveNotebookDocument(u,g,y){return $(bu.getOnWillSaveNotebookDocumentEvent(w))(u,g,y)},get onDidOpenNotebookDocument(){return $(ge.onDidOpenNotebookDocument)},get onDidCloseNotebookDocument(){return $(ge.onDidCloseNotebookDocument)},registerNotebookSerializer(u,g,y,F){return ge.registerNotebookSerializer(w,u,g,y,ie(w,"notebookLiveShare")?F:void 0)},onDidChangeConfiguration:(u,g,y)=>$(Nr.onDidChangeConfiguration)(u,g,y),getConfiguration(u,g){return g=arguments.length===1?void 0:g,Nr.getConfiguration(u,g,w)},registerTextDocumentContentProvider(u,g){return yu.registerTextDocumentContentProvider(u,g)},registerTaskProvider:(u,g)=>(_.report("window.registerTaskProvider",w,"Use the corresponding function on the 'tasks' namespace instead"),Ne.registerTaskProvider(w,u,g)),registerFileSystemProvider(u,g,y){return Nf(Cu.registerFileSystemProvider(w,u,g,y),i.addFileSystemProvider(u,g,y))},get fs(){return i.value},registerFileSearchProvider:(u,g)=>(b(w,"fileSearchProvider"),Kt.registerFileSearchProviderOld(u,g)),registerTextSearchProvider:(u,g)=>(b(w,"textSearchProvider"),Kt.registerTextSearchProviderOld(u,g)),registerAITextSearchProvider:(u,g)=>(b(w,"aiTextSearchProvider"),b(w,"textSearchProvider2"),Kt.registerAITextSearchProvider(u,g)),registerFileSearchProvider2:(u,g)=>(b(w,"fileSearchProvider2"),Kt.registerFileSearchProvider(u,g)),registerTextSearchProvider2:(u,g)=>(b(w,"textSearchProvider2"),Kt.registerTextSearchProvider(u,g)),registerRemoteAuthorityResolver:(u,g)=>(b(w,"resolvers"),s.registerRemoteAuthorityResolver(u,g)),registerResourceLabelFormatter:u=>(b(w,"resolvers"),ku.$registerResourceLabelFormatter(u)),getRemoteExecServer:u=>(b(w,"resolvers"),s.getRemoteExecServer(u)),onDidCreateFiles:(u,g,y)=>$(Dt.onDidCreateFile)(u,g,y),onDidDeleteFiles:(u,g,y)=>$(Dt.onDidDeleteFile)(u,g,y),onDidRenameFiles:(u,g,y)=>$(Dt.onDidRenameFile)(u,g,y),onWillCreateFiles:(u,g,y)=>$(Dt.getOnWillCreateFileEvent(w))(u,g,y),onWillDeleteFiles:(u,g,y)=>$(Dt.getOnWillDeleteFileEvent(w))(u,g,y),onWillRenameFiles:(u,g,y)=>$(Dt.getOnWillRenameFileEvent(w))(u,g,y),openTunnel:u=>(b(w,"tunnels"),p.openTunnel(w,u).then(g=>{if(!g)throw new Error("cannot open tunnel");return g})),get tunnels(){return b(w,"tunnels"),p.getTunnels()},onDidChangeTunnels:(u,g,y)=>(b(w,"tunnels"),$(p.onDidChangeTunnels)(u,g,y)),registerPortAttributesProvider:(u,g)=>(b(w,"portsAttributes"),p.registerPortsAttributesProvider(u,g)),registerTunnelProvider:(u,g)=>(b(w,"tunnelFactory"),p.registerTunnelProvider(u,g)),registerTimelineProvider:(u,g)=>(b(w,"timeline"),Iu.registerTimelineProvider(u,g,w.identifier,J.converter)),get isTrusted(){return r.trusted},requestWorkspaceTrust:u=>(b(w,"workspaceTrust"),r.requestWorkspaceTrust(u)),onDidGrantWorkspaceTrust:(u,g,y)=>$(r.onDidGrantWorkspaceTrust)(u,g,y),registerEditSessionIdentityProvider:(u,g)=>(b(w,"editSessionIdentityProvider"),r.registerEditSessionIdentityProvider(u,g)),onWillCreateEditSessionIdentity:(u,g,y)=>(b(w,"editSessionIdentityProvider"),$(r.getOnWillCreateEditSessionIdentityEvent(w))(u,g,y)),registerCanonicalUriProvider:(u,g)=>(b(w,"canonicalUriProvider"),r.registerCanonicalUriProvider(u,g)),getCanonicalUri:(u,g,y)=>(b(w,"canonicalUriProvider"),r.provideCanonicalUri(u,g,y)),decode(u,g){return r.decode(u,g)},encode(u,g){return r.encode(u,g)}},Qu={get inputBox(){return _.report("scm.inputBox",w,"Use 'SourceControl.inputBox' instead"),gc.getLastInputBox(w)},createSourceControl(u,g,y){return gc.createSourceControl(w,u,g,y)}},Ju={createCommentController(u,g){return Tu.createCommentController(w,u,g)}},Xu={get activeDebugSession(){return pe.activeDebugSession},get activeDebugConsole(){return pe.activeDebugConsole},get breakpoints(){return pe.breakpoints},get activeStackItem(){return pe.activeStackItem},registerDebugVisualizationProvider(u,g){return b(w,"debugVisualization"),pe.registerDebugVisualizationProvider(w,u,g)},registerDebugVisualizationTreeProvider(u,g){return b(w,"debugVisualization"),pe.registerDebugVisualizationTree(w,u,g)},onDidStartDebugSession(u,g,y){return $(pe.onDidStartDebugSession)(u,g,y)},onDidTerminateDebugSession(u,g,y){return $(pe.onDidTerminateDebugSession)(u,g,y)},onDidChangeActiveDebugSession(u,g,y){return $(pe.onDidChangeActiveDebugSession)(u,g,y)},onDidReceiveDebugSessionCustomEvent(u,g,y){return $(pe.onDidReceiveDebugSessionCustomEvent)(u,g,y)},onDidChangeBreakpoints(u,g,y){return $(pe.onDidChangeBreakpoints)(u,g,y)},onDidChangeActiveStackItem(u,g,y){return $(pe.onDidChangeActiveStackItem)(u,g,y)},registerDebugConfigurationProvider(u,g,y){return pe.registerDebugConfigurationProvider(u,g,y||gd.Initial)},registerDebugAdapterDescriptorFactory(u,g){return pe.registerDebugAdapterDescriptorFactory(w,u,g)},registerDebugAdapterTrackerFactory(u,g){return pe.registerDebugAdapterTrackerFactory(u,g)},startDebugging(u,g,y){return!y||typeof y=="object"&&"configuration"in y?pe.startDebugging(u,g,{parentSession:y}):pe.startDebugging(u,g,y||{})},stopDebugging(u){return pe.stopDebugging(u)},addBreakpoints(u){return pe.addBreakpoints(u)},removeBreakpoints(u){return pe.removeBreakpoints(u)},asDebugSourceUri(u,g){return pe.asDebugSourceUri(u,g)}},Yu={registerTaskProvider:(u,g)=>Ne.registerTaskProvider(w,u,g),fetchTasks:u=>Ne.fetchTasks(u),executeTask:u=>Ne.executeTask(w,u),get taskExecutions(){return Ne.taskExecutions},onDidStartTask:(u,g,y)=>$(Ne.onDidStartTask)(u,g,y),onDidEndTask:(u,g,y)=>$(Ne.onDidEndTask)(u,g,y),onDidStartTaskProcess:(u,g,y)=>$(Ne.onDidStartTaskProcess)(u,g,y),onDidEndTaskProcess:(u,g,y)=>$(Ne.onDidEndTaskProcess)(u,g,y),onDidStartTaskProblemMatchers:(u,g,y)=>(b(w,"taskProblemMatcherStatus"),$(Ne.onDidStartTaskProblemMatchers)(u,g,y)),onDidEndTaskProblemMatchers:(u,g,y)=>(b(w,"taskProblemMatcherStatus"),$(Ne.onDidEndTaskProblemMatchers)(u,g,y))},Zu={createNotebookController(u,g,y,F,ee){return Mr.createNotebookController(w,u,g,y,F,ie(w,"notebookMessaging")?ee:void 0)},registerNotebookCellStatusBarItemProvider:(u,g)=>ge.registerNotebookCellStatusBarItemProvider(w,u,g),createRendererMessaging(u){return xu.createRendererMessaging(w,u)},createNotebookControllerDetectionTask(u){return b(w,"notebookKernelSource"),Mr.createNotebookControllerDetectionTask(w,u)},registerKernelSourceActionProvider(u,g){return b(w,"notebookKernelSource"),Mr.registerKernelSourceActionProvider(w,u,g)}},ep={t(...u){if(typeof u[0]=="string"){const g=u.shift(),y=!u||typeof u[0]!="object"?u:u[0];return hs.getMessage(w.identifier.value,{message:g,args:y})}return hs.getMessage(w.identifier.value,u[0])},get bundle(){return hs.getBundle(w.identifier.value)},get uri(){return hs.getBundleUri(w.identifier.value)}},tp={transferActiveChat(u){return b(w,"interactive"),Qt.transferActiveChat(u)}},ip={getRelatedInformation(u,g){return b(w,"aiRelatedInformation"),_c.getRelatedInformation(w,u,g)},registerRelatedInformationProvider(u,g){return b(w,"aiRelatedInformation"),_c.registerRelatedInformationProvider(w,u,g)},registerEmbeddingVectorProvider(u,g){return b(w,"aiRelatedInformation"),Hu.registerEmbeddingVectorProvider(w,u,g)},registerSettingsSearchProvider(u){return b(w,"aiSettingsSearch"),Fu.registerSettingsSearchProvider(w,u)}},sp={registerMappedEditsProvider(u,g){return b(w,"mappedEditsProvider"),{dispose(){}}},registerMappedEditsProvider2(u){return b(w,"mappedEditsProvider"),Su.registerMappedEditsProvider(w,u)},createChatParticipant(u,g){return Qt.createChatAgent(w,u,g)},createDynamicChatParticipant(u,g,y){return b(w,"chatParticipantPrivate"),Qt.createDynamicChatAgent(w,u,g,y)},registerChatParticipantDetectionProvider(u){return b(w,"chatParticipantPrivate"),Qt.registerChatParticipantDetectionProvider(w,u)},registerRelatedFilesProvider(u,g){return b(w,"chatEditing"),Qt.registerRelatedFilesProvider(w,u,g)},onDidDisposeChatSession:(u,g,y)=>(b(w,"chatParticipantPrivate"),$(Qt.onDidDisposeChatSession)(u,g,y))},rp={selectChatModels:u=>Q.selectLanguageModels(w,u??{}),onDidChangeChatModels:(u,g,y)=>Q.onDidChangeProviders(u,g,y),registerChatModelProvider:(u,g,y)=>(b(w,"chatProvider"),Q.registerLanguageModel(w,u,g,y)),get embeddingModels(){return b(w,"embeddings"),Di.embeddingsModels},onDidChangeEmbeddingModels:(u,g,y)=>(b(w,"embeddings"),Di.onDidChange(u,g,y)),registerEmbeddingsProvider(u,g){return b(w,"embeddings"),Di.registerEmbeddingsProvider(w,u,g)},async computeEmbeddings(u,g,y){return b(w,"embeddings"),Di.computeEmbeddings(u,g,y)},registerTool(u,g){return ps.registerTool(w,u,g)},invokeTool(u,g,y){return ps.invokeTool(w,u,g,y)},get tools(){return ps.getTools(w)},fileIsIgnored(u,g){return Q.fileIsIgnored(w,u,g)},registerIgnoredFileProvider(u){return Q.registerIgnoredFileProvider(w,u)},registerMcpServerDefinitionProvider(u,g){return K.registerMcpConfigurationProvider(w,u,g)}},np={registerSpeechProvider(u,g){return b(w,"speech"),Lu.registerProvider(w.identifier,u,g)}};return{version:e.version,ai:ip,authentication:Vu,commands:Bu,comments:Ju,chat:sp,debug:Xu,env:zu,extensions:qu,interactive:tp,l10n:ep,languages:Ku,lm:rp,notebooks:Zu,scm:Qu,speech:np,tasks:Yu,tests:ju,window:Gu,workspace:wc,Breakpoint:Zv,TerminalOutputAnchor:Yv,ChatResultFeedbackKind:zn,ChatVariableLevel:Xv,ChatCompletionItem:Jv,ChatReferenceDiagnostic:Qv,CallHierarchyIncomingCall:Gv,CallHierarchyItem:Rl,CallHierarchyOutgoingCall:Kv,CancellationError:gi,CancellationTokenSource:he,CandidatePortSource:qv,CodeAction:Ua,CodeActionKind:Wa,CodeActionTriggerKind:jv,CodeLens:ph,Color:oh,ColorInformation:nh,ColorPresentation:zv,ColorThemeKind:ii,CommentMode:Bv,CommentState:Vv,CommentThreadCollapsibleState:Zn,CommentThreadState:to,CommentThreadApplicability:io,CommentThreadFocus:eo,CompletionItem:Wv,CompletionItemKind:Uv,CompletionItemTag:Ov,CompletionList:or,CompletionTriggerKind:Nv,ConfigurationTarget:Ts,CustomExecution:Fl,DebugAdapterExecutable:Xl,DebugAdapterInlineImplementation:$n,DebugAdapterNamedPipeServer:Yl,DebugAdapterServer:Mn,DebugConfigurationProviderTriggerKind:gd,DebugConsoleMode:Gl,DebugVisualization:Lv,DecorationRangeBehavior:Fv,Diagnostic:Hv,DiagnosticRelatedInformation:Mv,DiagnosticSeverity:Ni,DiagnosticTag:$v,Disposable:W,DocumentHighlight:Av,DocumentHighlightKind:Rv,MultiDocumentHighlight:Iv,DocumentLink:kv,DocumentSymbol:Ih,EndOfLine:is,EnvironmentVariableMutatorType:Rs,EvaluatableExpression:Tv,InlineValueText:Pv,InlineValueVariableLookup:Dv,InlineValueEvaluatableExpression:Cv,InlineCompletionTriggerKind:oo,EventEmitter:D,ExtensionKind:Ki,ExtensionMode:As,ExternalUriOpenerPriority:Sv,FileChangeType:Hs,FileDecoration:Dn,FileDecoration2:Dn,FileSystemError:ye,FileType:Wi,FilePermission:zs,FoldingRange:Ev,FoldingRangeKind:bv,FunctionBreakpoint:Li,InlineCompletionItem:xv,InlineCompletionList:wv,Hover:yv,VerboseHover:vv,HoverVerbosityAction:_v,IndentAction:sy,Location:_i,MarkdownString:vi,OverviewRulerLane:Lf,ParameterInformation:mv,PortAutoForwardAction:gv,Position:Fe,ProcessExecution:Aa,ProgressLocation:kn,QuickInputButtonLocation:fv,QuickInputButtons:ho,Range:ce,RelativePattern:pv,Selection:mi,SelectionRange:rh,SemanticTokens:nr,SemanticTokensBuilder:uv,SemanticTokensEdit:Rh,SemanticTokensEdits:Fs,SemanticTokensLegend:Un,ShellExecution:ir,ShellQuoting:hv,SignatureHelp:lv,SignatureHelpTriggerKind:dv,SignatureInformation:cv,SnippetString:Ah,SourceBreakpoint:Fi,StandardTokenType:Hh,StatusBarAlignment:ri,SymbolInformation:hh,SymbolKind:av,SymbolTag:ov,Task:Ll,TaskEventKind:nv,TaskGroup:Tn,TaskPanelKind:rv,TaskRevealKind:sv,TaskScope:sr,TerminalLink:iv,TerminalQuickFixTerminalCommand:tv,TerminalQuickFixOpener:ev,TerminalLocation:Z_,TerminalProfile:Y_,TerminalExitReason:X_,TerminalShellExecutionCommandLineConfidence:Ln,TerminalCompletionItem:J_,TerminalCompletionItemKind:Q_,TerminalCompletionList:G_,TerminalShellType:K_,TextDocumentSaveReason:q_,TextEdit:Th,SnippetTextEdit:j_,TextEditorCursorStyle:Ff,TextEditorChangeKind:Os,TextEditorLineNumbersStyle:z_,TextEditorRevealType:Ml,TextEditorSelectionChangeKind:Uh,SyntaxTokenType:kh,TextDocumentChangeReason:so,ThemeColor:po,ThemeIcon:Et,TreeItem:Vh,TreeItemCheckboxState:si,TreeItemCollapsibleState:Bh,TypeHierarchyItem:Al,UIKind:Pn,Uri:v,ViewColumn:B_,WorkspaceEdit:Va,DocumentPasteTriggerKind:V_,DocumentDropEdit:W_,DocumentDropOrPasteEditKind:$h,DocumentPasteEdit:U_,InlayHint:O_,InlayHintLabelPart:N_,InlayHintKind:L_,RemoteAuthorityResolverError:ti,ResolvedAuthority:F_,ManagedResolvedAuthority:$s,SourceControlInputBoxValidationType:H_,ExtensionRuntime:zh,TimelineItem:M_,NotebookRange:ai,NotebookCellKind:$_,NotebookCellExecutionState:A_,NotebookCellData:Nh,NotebookData:R_,NotebookRendererScript:I_,NotebookCellStatusBarAlignment:k_,NotebookEditorRevealType:Lh,NotebookCellOutput:co,NotebookCellOutputItem:T_,CellErrorStackFrame:P_,NotebookCellStatusBarItem:D_,NotebookControllerAffinity:C_,NotebookControllerAffinity2:Oh,NotebookEdit:S_,NotebookKernelSourceAction:E_,NotebookVariablesRequestKind:lo,PortAttributes:b_,LinkedEditingRanges:x_,TestResultState:w_,TestRunRequest:Kl,TestMessage:y_,TestMessageStackFrame:v_,TestTag:__,TestRunProfileKind:m_,TextSearchCompleteMessageType:fd,DataTransfer:Ba,DataTransferItem:g_,TestCoverageCount:f_,FileCoverage:An,StatementCoverage:p_,BranchCoverage:u_,DeclarationCoverage:h_,WorkspaceTrustState:l_,LanguageStatusSeverity:Ls,QuickPickItemKind:uo,InputBoxValidationSeverity:Ns,TabInputText:Fa,TabInputTextDiff:rr,TabInputTextMerge:Bl,TabInputCustom:Ha,TabInputNotebook:Ma,TabInputNotebookDiff:$a,TabInputWebview:Vl,TabInputTerminal:Wl,TabInputInteractiveWindow:Ul,TabInputChat:Ol,TabInputTextMultiDiff:Nl,TelemetryTrustedValue:wl,LogLevel:We,EditSessionIdentityMatch:fo,InteractiveSessionVoteDirection:d_,ChatCopyKind:c_,ChatEditingSessionActionOutcome:a_,InteractiveEditorResponseFeedbackKind:o_,DebugStackFrame:Jl,DebugThread:Ql,RelatedInformationType:n_,SpeechToTextStatus:r_,TextToSpeechStatus:s_,PartialAcceptTriggerKind:i_,InlineCompletionEndOfLifeReasonKind:t_,KeywordRecognitionStatus:e_,ChatImageMimeType:Zm,ChatResponseMarkdownPart:Sh,ChatResponseFileTreePart:bh,ChatResponseAnchorPart:Xn,ChatResponseProgressPart:Ym,ChatResponseProgressPart2:Ms,ChatResponseReferencePart:Qi,ChatResponseReferencePart2:Qi,ChatResponseCodeCitationPart:Jn,ChatResponseCodeblockUriPart:Eh,ChatResponseWarningPart:Gn,ChatResponseTextEditPart:jn,ChatResponseNotebookEditPart:qn,ChatResponseMarkdownWithVulnerabilitiesPart:Kn,ChatResponseCommandButtonPart:xh,ChatResponseConfirmationPart:Qn,ChatResponseMovePart:yh,ChatResponseExtensionsPart:wh,ChatPrepareToolInvocationPart:Yn,ChatResponseReferencePartStatusKind:Xm,ChatRequestTurn:Bn,ChatRequestTurn2:Bn,ChatResponseTurn:_h,ChatLocation:Jm,ChatRequestEditorData:gh,ChatRequestNotebookData:vh,ChatReferenceBinaryData:Qm,ChatRequestEditedFileEventKind:Gm,LanguageModelChatMessageRole:jl,LanguageModelChatMessage:Km,LanguageModelChatMessage2:qm,LanguageModelToolResultPart:jm,LanguageModelToolResultPart2:zm,LanguageModelTextPart:qi,LanguageModelToolCallPart:La,LanguageModelError:Ye,LanguageModelToolResult:Bm,LanguageModelToolResult2:Vm,LanguageModelDataPart:ql,ExtendedLanguageModelToolResult:Wm,PreparedTerminalToolInvocation:Um,LanguageModelChatToolMode:Om,LanguageModelPromptTsxPart:Nm,NewSymbolName:Lm,NewSymbolNameTag:Fm,NewSymbolNameTriggerKind:ro,InlineEdit:Hm,InlineEditTriggerKind:ao,ExcludeSettingOptions:kt,TextSearchContext2:ka,TextSearchMatch2:_t,AISearchKeyword:Fn,TextSearchCompleteMessageTypeNew:fd,ChatErrorLevel:Mm,McpHttpServerDefinition:$m,McpStdioServerDefinition:Am,SettingsSearchResultKind:Rm}}}var Bs;let ga=class{constructor(e,t,i,s,r,n,o){this._apiFactory=e,this._extensionRegistry=t,this._instaService=i,this._extHostConfiguration=s,this._extHostExtensionService=r,this._initData=n,this._logService=o,this._factories=new Map,this._alternatives=[]}async install(){this._installInterceptor(),Ve("code/extHost/willWaitForConfig");const e=await this._extHostConfiguration.getConfigProvider();Ve("code/extHost/didWaitForConfig");const t=await this._extHostExtensionService.getExtensionPathIndex();this.register(new Zx(this._apiFactory,t,this._extensionRegistry,e,this._logService)),this.register(this._instaService.createInstance(ma)),this._initData.remote.isRemote&&this.register(this._instaService.createInstance(_a,t,this._initData.environment.appUriScheme))}register(e){if("nodeModuleName"in e)if(Array.isArray(e.nodeModuleName))for(const t of e.nodeModuleName)this._factories.set(t,e);else this._factories.set(e.nodeModuleName,e);typeof e.alternativeModuleName=="function"&&this._alternatives.push(t=>e.alternativeModuleName(t))}};ga=L([E(2,Pa),E(3,nt),E(4,qt),E(5,_e),E(6,se)],ga);let ma=class{static{Bs=this}static{this.aliased=new Map([["vscode-ripgrep","@vscode/ripgrep"],["vscode-windows-registry","@vscode/windows-registry"]])}constructor(e){if(e.environment.appRoot&&Bs.aliased.size){const t=Of(this.forceForwardSlashes(e.environment.appRoot.fsPath)),i="[a-z0-9_.-]",s=`@${i}+\\/${i}+|${i}+`,r="node_modules|node_modules\\.asar(?:\\.unpacked)?";this.re=new RegExp(`^(${t}/${r}\\/)(${s})(.*)$`,"i")}}alternativeModuleName(e){if(!this.re)return;const t=this.re.exec(this.forceForwardSlashes(e));if(!t)return;const[,i,s,r]=t,n=Bs.aliased.get(s);if(n!==void 0)return console.warn(`${s} as been renamed to ${n}, please update your imports`),i+n+r}forceForwardSlashes(e){return e.replace(/\\/g,"/")}};ma=Bs=L([E(0,_e)],ma);class Zx{constructor(e,t,i,s,r){this._apiFactory=e,this._extensionPaths=t,this._extensionRegistry=i,this._configProvider=s,this._logService=r,this.nodeModuleName="vscode",this._extApiImpl=new Vt}load(e,t){const i=this._extensionPaths.findSubstr(t);if(i){let s=this._extApiImpl.get(i.identifier);return s||(s=this._apiFactory(i,this._extensionRegistry,this._configProvider),this._extApiImpl.set(i.identifier,s)),s}if(!this._defaultApiImpl){let s="";this._extensionPaths.forEach((r,n)=>s+=`	${n} -> ${r.identifier.value}
`),this._logService.warn(`Could not identify extension for 'vscode' require call from ${t}. These are the extension path mappings: 
${s}`),this._defaultApiImpl=this._apiFactory(Uf,this._extensionRegistry,this._configProvider)}return this._defaultApiImpl}}let _a=class{constructor(e,t,i){this._extensionPaths=e,this._appUriScheme=t,this.nodeModuleName=["open","opn"],this._mainThreadTelemetry=i.getProxy(k.MainThreadTelemetry);const s=i.getProxy(k.MainThreadWindow);this._impl=(r,n)=>{const o=v.parse(r);return n?this.callOriginal(r,n):o.scheme==="http"||o.scheme==="https"?s.$openUri(o,r,{allowTunneling:!0}):o.scheme==="mailto"||o.scheme===this._appUriScheme?s.$openUri(o,r,{}):this.callOriginal(r,n)}}load(e,t,i){const s=this._extensionPaths.findSubstr(t);return s&&(this._extensionId=s.identifier.value,this.sendShimmingTelemetry()),this._original=i(e),this._impl}callOriginal(e,t){return this.sendNoForwardTelemetry(),this._original(e,t)}sendShimmingTelemetry(){this._extensionId&&this._mainThreadTelemetry.$publicLog2("shimming.open",{extension:this._extensionId})}sendNoForwardTelemetry(){this._extensionId&&this._mainThreadTelemetry.$publicLog2("shimming.open.call.noForward",{extension:this._extensionId})}};_a=L([E(2,q)],_a);let va=class{constructor(e,t){this._mainThreadConsole=e.getProxy(k.MainThreadConsole),this._includeStack=t.consoleForward.includeStack,this._logNative=t.consoleForward.logNative,this._wrapConsoleMethod("info","log"),this._wrapConsoleMethod("log","log"),this._wrapConsoleMethod("warn","warn"),this._wrapConsoleMethod("debug","debug"),this._wrapConsoleMethod("error","error")}_wrapConsoleMethod(e,t){const i=this,s=console[e];Object.defineProperty(console,e,{set:()=>{},get:()=>function(){i._handleConsoleCall(e,t,s,arguments)}})}_handleConsoleCall(e,t,i,s){this._mainThreadConsole.$logExtensionHostMessage({type:"__$console",severity:t,arguments:tb(s,this._includeStack)}),this._logNative&&this._nativeConsoleLogMessage(e,i,s)}};va=L([E(0,q),E(1,_e)],va);const eb=1e5;function tb(a,e){const t=[];if(a.length)for(let i=0;i<a.length;i++){let s=a[i];if(typeof s>"u")s="undefined";else if(s instanceof Error){const r=s;r.stack?s=r.stack:s=r.toString()}t.push(s)}if(e){const i=new Error().stack;i&&t.push({__$stack:i.split(`
`).slice(3).join(`
`)})}try{const i=Wf(t);return i.length>eb?"Output omitted for a large object that exceeds the limits":i}catch(i){return`Output omitted for an object that cannot be inspected ('${i.toString()}')`}}let ya=class extends va{constructor(e,t){super(e,t)}_nativeConsoleLogMessage(e,t,i){t.apply(console,i)}};ya=L([E(0,q),E(1,_e)],ya);class ib extends ga{_installInterceptor(){}getModule(e,t){for(const i of this._alternatives){const s=i(e);if(s){e=s;break}}if(this._factories.has(e))return this._factories.get(e).load(e,t,()=>{throw new Error("CANNOT LOAD MODULE from here.")})}}class oE extends qo{constructor(){super(...arguments),this.extensionRuntime=zh.Webworker}async _beforeAlmostReadyToRunExtensions(){Zs&&this._instaService.createInstance(ya),this._apiFactory=this._instaService.invokeFunction(Yx),this._fakeModules=this._instaService.createInstance(ib,this._apiFactory,{mine:this._myRegistry,all:this._globalRegistry}),await this._fakeModules.install(),performance.mark("code/extHost/didInitAPI"),await this._waitForDebuggerAttachment()}_getEntryPoint(e){return e.browser}async _loadCommonJSModule(e,t,i){t=t.with({path:sb(t.path,".js")});const s=e?.identifier.value;s&&performance.mark(`code/extHost/willFetchExtensionCode/${s}`);const r=v.revive(await this._mainThreadExtensionsProxy.$asBrowserUri(t)),n=await fetch(r.toString(!0));if(s&&performance.mark(`code/extHost/didFetchExtensionCode/${s}`),n.status!==200)throw new Error(n.statusText);const o=await n.text(),c=`${t.toString(!0)}#vscode-extension`,d=`${o}
//# sourceURL=${c}`;let h;try{h=new Function("module","exports","require",d)}catch(p){throw console.error(s?`Loading code for extension ${s} failed: ${p.message}`:`Loading code failed: ${p.message}`),console.error(`${t.toString(!0)}${typeof p.line=="number"?` line ${p.line}`:""}${typeof p.column=="number"?` column ${p.column}`:""}`),console.error(p),p}e&&await this._extHostLocalizationService.initializeLocalizedMessages(e);const f={},m={exports:f},l=p=>{const _=this._fakeModules.getModule(p,t);if(_===void 0)throw new Error(`Cannot load module '${p}'`);return _};try{return i.codeLoadingStart(),s&&performance.mark(`code/extHost/willLoadExtensionCode/${s}`),h(m,f,l),m.exports!==f?m.exports:f}finally{s&&performance.mark(`code/extHost/didLoadExtensionCode/${s}`),i.codeLoadingStop()}}_loadESMModule(e,t,i){throw new Error("ESM modules are not supported in the web worker extension host")}async $setRemoteEnvironment(e){}async _waitForDebuggerAttachment(e=5e3){if(!this._initData.environment.isExtensionDevelopmentDebug)return;const t=Date.now()+e;for(;Date.now()<t&&!("__jsDebugIsReady"in globalThis);)await Nt(10)}}function sb(a,e){return Vf(a)?a:a+e}export{kd as E,iu as I,qt as a,Cd as b,tu as c,oE as d,pu as e,yd as f,qa as g,fo as h,jb as i,ra as j,qw as w};
